/*! For license information please see 3d-tiles-context.js.LICENSE.txt */
(()=>{var e={61:e=>{e.exports=function e(t,n,i){function r(a,o){if(!n[a]){if(!t[a]){if(s)return s(a,!0);var l=new Error("Cannot find module '"+a+"'");throw l.code="MODULE_NOT_FOUND",l}var c=n[a]={exports:{}};t[a][0].call(c.exports,(function(e){return r(t[a][1][e]||e)}),c,c.exports,e,t,n,i)}return n[a].exports}for(var s=void 0,a=0;a<i.length;a++)r(i[a]);return r}({1:[function(e,t,n){var i,r,s,a,o,l={}.hasOwnProperty;i=e("./PriorityQueue/AbstractPriorityQueue"),r=e("./PriorityQueue/ArrayStrategy"),a=e("./PriorityQueue/BinaryHeapStrategy"),s=e("./PriorityQueue/BHeapStrategy"),(o=function(e){function t(e){e||(e={}),e.strategy||(e.strategy=a),e.comparator||(e.comparator=function(e,t){return(e||0)-(t||0)}),t.__super__.constructor.call(this,e)}return function(e,t){for(var n in t)l.call(t,n)&&(e[n]=t[n]);function i(){this.constructor=e}i.prototype=t.prototype,e.prototype=new i,e.__super__=t.prototype}(t,e),t}(i)).ArrayStrategy=r,o.BinaryHeapStrategy=a,o.BHeapStrategy=s,t.exports=o},{"./PriorityQueue/AbstractPriorityQueue":2,"./PriorityQueue/ArrayStrategy":3,"./PriorityQueue/BHeapStrategy":4,"./PriorityQueue/BinaryHeapStrategy":5}],2:[function(e,t,n){t.exports=function(){function e(e){var t;if(null==(null!=e?e.strategy:void 0))throw"Must pass options.strategy, a strategy";if(null==(null!=e?e.comparator:void 0))throw"Must pass options.comparator, a comparator";this.priv=new e.strategy(e),this.length=(null!=e&&null!=(t=e.initialValues)?t.length:void 0)||0}return e.prototype.queue=function(e){this.length++,this.priv.queue(e)},e.prototype.dequeue=function(e){if(!this.length)throw"Empty queue";return this.length--,this.priv.dequeue()},e.prototype.peek=function(e){if(!this.length)throw"Empty queue";return this.priv.peek()},e.prototype.clear=function(){return this.length=0,this.priv.clear()},e}()},{}],3:[function(e,t,n){var i;i=function(e,t,n){var i,r,s;for(r=0,i=e.length;r<i;)n(e[s=r+i>>>1],t)>=0?r=s+1:i=s;return r},t.exports=function(){function e(e){var t;this.options=e,this.comparator=this.options.comparator,this.data=(null!=(t=this.options.initialValues)?t.slice(0):void 0)||[],this.data.sort(this.comparator).reverse()}return e.prototype.queue=function(e){var t;t=i(this.data,e,this.comparator),this.data.splice(t,0,e)},e.prototype.dequeue=function(){return this.data.pop()},e.prototype.peek=function(){return this.data[this.data.length-1]},e.prototype.clear=function(){this.data.length=0},e}()},{}],4:[function(e,t,n){t.exports=function(){function e(e){var t,n,i,r,s,a,o,l;for(this.comparator=(null!=e?e.comparator:void 0)||function(e,t){return e-t},this.pageSize=(null!=e?e.pageSize:void 0)||512,this.length=0,o=0;1<<o<this.pageSize;)o+=1;if(1<<o!==this.pageSize)throw"pageSize must be a power of two";for(this._shift=o,this._emptyMemoryPageTemplate=t=[],n=0,s=this.pageSize;0<=s?n<s:n>s;0<=s?++n:--n)t.push(null);if(this._memory=[],this._mask=this.pageSize-1,e.initialValues)for(i=0,r=(a=e.initialValues).length;i<r;i++)l=a[i],this.queue(l)}return e.prototype.queue=function(e){this.length+=1,this._write(this.length,e),this._bubbleUp(this.length,e)},e.prototype.dequeue=function(){var e,t;return e=this._read(1),t=this._read(this.length),this.length-=1,this.length>0&&(this._write(1,t),this._bubbleDown(1,t)),e},e.prototype.peek=function(){return this._read(1)},e.prototype.clear=function(){this.length=0,this._memory.length=0},e.prototype._write=function(e,t){var n;for(n=e>>this._shift;n>=this._memory.length;)this._memory.push(this._emptyMemoryPageTemplate.slice(0));return this._memory[n][e&this._mask]=t},e.prototype._read=function(e){return this._memory[e>>this._shift][e&this._mask]},e.prototype._bubbleUp=function(e,t){var n,i,r,s;for(n=this.comparator;e>1&&(i=e&this._mask,e<this.pageSize||i>3?r=e&~this._mask|i>>1:i<2?(r=e-this.pageSize>>this._shift,r+=r&~(this._mask>>1),r|=this.pageSize>>1):r=e-2,!(n(s=this._read(r),t)<0));)this._write(r,t),this._write(e,s),e=r},e.prototype._bubbleDown=function(e,t){var n,i,r,s,a;for(a=this.comparator;e<this.length;)if(e>this._mask&&!(e&this._mask-1)?n=i=e+2:e&this.pageSize>>1?(n=(e&~this._mask)>>1,i=1+(n=1+(n|=e&this._mask>>1)<<this._shift)):i=(n=e+(e&this._mask))+1,n!==i&&i<=this.length)if(r=this._read(n),s=this._read(i),a(r,t)<0&&a(r,s)<=0)this._write(n,t),this._write(e,r),e=n;else{if(!(a(s,t)<0))break;this._write(i,t),this._write(e,s),e=i}else{if(!(n<=this.length))break;if(!(a(r=this._read(n),t)<0))break;this._write(n,t),this._write(e,r),e=n}},e}()},{}],5:[function(e,t,n){t.exports=function(){function e(e){var t;this.comparator=(null!=e?e.comparator:void 0)||function(e,t){return e-t},this.length=0,this.data=(null!=(t=e.initialValues)?t.slice(0):void 0)||[],this._heapify()}return e.prototype._heapify=function(){var e,t,n;if(this.data.length>0)for(e=t=1,n=this.data.length;1<=n?t<n:t>n;e=1<=n?++t:--t)this._bubbleUp(e)},e.prototype.queue=function(e){this.data.push(e),this._bubbleUp(this.data.length-1)},e.prototype.dequeue=function(){var e,t;return t=this.data[0],e=this.data.pop(),this.data.length>0&&(this.data[0]=e,this._bubbleDown(0)),t},e.prototype.peek=function(){return this.data[0]},e.prototype.clear=function(){this.length=0,this.data.length=0},e.prototype._bubbleUp=function(e){for(var t,n;e>0&&(t=e-1>>>1,this.comparator(this.data[e],this.data[t])<0);)n=this.data[t],this.data[t]=this.data[e],this.data[e]=n,e=t},e.prototype._bubbleDown=function(e){var t,n,i,r,s;for(t=this.data.length-1;r=1+(n=1+(e<<1)),i=e,n<=t&&this.comparator(this.data[n],this.data[i])<0&&(i=n),r<=t&&this.comparator(this.data[r],this.data[i])<0&&(i=r),i!==e;)s=this.data[i],this.data[i]=this.data[e],this.data[e]=s,e=i},e}()},{}]},{},[1])(1)},329:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.hierarchyItemLength=t.infoLength=void 0,t.infoLength=160,t.hierarchyItemLength=32},380:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.decompressFile=t.decompressChunk=t.PointData=void 0;const i=n(6977),r=n(8916);let s;async function a(e){return e||(s||(s=(0,i.createLazPerf)()),s)}async function o(e,{pointCount:t,pointDataRecordFormat:n,pointDataRecordLength:i},r){const s=await a(r),o=new Uint8Array(t*i),l=s._malloc(e.byteLength),c=s._malloc(i),h=new s.ChunkDecoder;try{s.HEAPU8.set(new Uint8Array(e.buffer,e.byteOffset,e.byteLength),l),h.open(n,i,l);for(let e=0;e<t;++e)h.getPoint(c),o.set(new Uint8Array(s.HEAPU8.buffer,c,i),e*i)}finally{s._free(l),s._free(c),h.delete()}return o}async function l(e,t){const n=await a(t),i=r.Header.parse(e),{pointCount:s,pointDataRecordLength:o}=i,l=new Uint8Array(s*o),c=n._malloc(e.byteLength),h=n._malloc(o),u=new n.LASZip;try{n.HEAPU8.set(new Uint8Array(e.buffer,e.byteOffset,e.byteLength),c),u.open(c,e.byteLength);for(let e=0;e<s;++e)u.getPoint(h),l.set(new Uint8Array(n.HEAPU8.buffer,h,o),e*o)}finally{u.delete()}return l}t.PointData={createLazPerf:i.createLazPerf,decompressChunk:o,decompressFile:l},t.decompressChunk=o,t.decompressFile=l},447:function(e,t,n){"use strict";var i=this&&this.__createBinding||(Object.create?function(e,t,n,i){void 0===i&&(i=n),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,i){void 0===i&&(i=n),e[i]=t[n]}),r=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||i(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),t.Transfer=t.DefaultSerializer=t.expose=t.registerSerializer=void 0;var s=n(9278);Object.defineProperty(t,"registerSerializer",{enumerable:!0,get:function(){return s.registerSerializer}}),r(n(4457),t);var a=n(1854);Object.defineProperty(t,"expose",{enumerable:!0,get:function(){return a.expose}});var o=n(5914);Object.defineProperty(t,"DefaultSerializer",{enumerable:!0,get:function(){return o.DefaultSerializer}});var l=n(6712);Object.defineProperty(t,"Transfer",{enumerable:!0,get:function(){return l.Transfer}})},539:()=>{},549:function(e,t,n){"use strict";var i=this&&this.__createBinding||(Object.create?function(e,t,n,i){void 0===i&&(i=n);var r=Object.getOwnPropertyDescriptor(t,n);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,i,r)}:function(e,t,n,i){void 0===i&&(i=n),e[i]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&i(t,e,n);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.Vlr=t.View=t.PointData=t.Header=t.Extractor=t.ExtraBytes=t.Dimensions=t.Constants=void 0,t.Constants=s(n(8300));var a=n(1652);Object.defineProperty(t,"Dimensions",{enumerable:!0,get:function(){return a.Dimensions}});var o=n(4553);Object.defineProperty(t,"ExtraBytes",{enumerable:!0,get:function(){return o.ExtraBytes}});var l=n(1677);Object.defineProperty(t,"Extractor",{enumerable:!0,get:function(){return l.Extractor}});var c=n(8916);Object.defineProperty(t,"Header",{enumerable:!0,get:function(){return c.Header}});var h=n(380);Object.defineProperty(t,"PointData",{enumerable:!0,get:function(){return h.PointData}});var u=n(8148);Object.defineProperty(t,"View",{enumerable:!0,get:function(){return u.View}});var d=n(2101);Object.defineProperty(t,"Vlr",{enumerable:!0,get:function(){return d.Vlr}})},736:(e,t,n)=>{e.exports=function(e){function t(e){let n,r,s,a=null;function o(...e){if(!o.enabled)return;const i=o,r=Number(new Date),s=r-(n||r);i.diff=s,i.prev=n,i.curr=r,n=r,e[0]=t.coerce(e[0]),"string"!=typeof e[0]&&e.unshift("%O");let a=0;e[0]=e[0].replace(/%([a-zA-Z%])/g,((n,r)=>{if("%%"===n)return"%";a++;const s=t.formatters[r];if("function"==typeof s){const t=e[a];n=s.call(i,t),e.splice(a,1),a--}return n})),t.formatArgs.call(i,e),(i.log||t.log).apply(i,e)}return o.namespace=e,o.useColors=t.useColors(),o.color=t.selectColor(e),o.extend=i,o.destroy=t.destroy,Object.defineProperty(o,"enabled",{enumerable:!0,configurable:!1,get:()=>null!==a?a:(r!==t.namespaces&&(r=t.namespaces,s=t.enabled(e)),s),set:e=>{a=e}}),"function"==typeof t.init&&t.init(o),o}function i(e,n){const i=t(this.namespace+(void 0===n?":":n)+e);return i.log=this.log,i}function r(e,t){let n=0,i=0,r=-1,s=0;for(;n<e.length;)if(i<t.length&&(t[i]===e[n]||"*"===t[i]))"*"===t[i]?(r=i,s=n,i++):(n++,i++);else{if(-1===r)return!1;i=r+1,s++,n=s}for(;i<t.length&&"*"===t[i];)i++;return i===t.length}return t.debug=t,t.default=t,t.coerce=function(e){return e instanceof Error?e.stack||e.message:e},t.disable=function(){const e=[...t.names,...t.skips.map((e=>"-"+e))].join(",");return t.enable(""),e},t.enable=function(e){t.save(e),t.namespaces=e,t.names=[],t.skips=[];const n=("string"==typeof e?e:"").trim().replace(" ",",").split(",").filter(Boolean);for(const e of n)"-"===e[0]?t.skips.push(e.slice(1)):t.names.push(e)},t.enabled=function(e){for(const n of t.skips)if(r(e,n))return!1;for(const n of t.names)if(r(e,n))return!0;return!1},t.humanize=n(6585),t.destroy=function(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")},Object.keys(e).forEach((n=>{t[n]=e[n]})),t.names=[],t.skips=[],t.formatters={},t.selectColor=function(e){let n=0;for(let t=0;t<e.length;t++)n=(n<<5)-n+e.charCodeAt(t),n|=0;return t.colors[Math.abs(n)%t.colors.length]},t.enable(t.load()),t}},876:function(e,t,n){"use strict";var i=this&&this.__createBinding||(Object.create?function(e,t,n,i){void 0===i&&(i=n);var r=Object.getOwnPropertyDescriptor(t,n);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,i,r)}:function(e,t,n,i){void 0===i&&(i=n),e[i]=t[n]}),r=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||i(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),t.Step=t.Scale=t.Key=t.Getter=t.Dimension=t.Bounds=t.Binary=void 0,r(n(6882),t);var s=n(3359);Object.defineProperty(t,"Binary",{enumerable:!0,get:function(){return s.Binary}});var a=n(9459);Object.defineProperty(t,"Bounds",{enumerable:!0,get:function(){return a.Bounds}});var o=n(4324);Object.defineProperty(t,"Dimension",{enumerable:!0,get:function(){return o.Dimension}});var l=n(7201);Object.defineProperty(t,"Getter",{enumerable:!0,get:function(){return l.Getter}});var c=n(4623);Object.defineProperty(t,"Key",{enumerable:!0,get:function(){return c.Key}});var h=n(6838);Object.defineProperty(t,"Scale",{enumerable:!0,get:function(){return h.Scale}});var u=n(5192);Object.defineProperty(t,"Step",{enumerable:!0,get:function(){return u.Step}})},1029:(e,t)=>{"use strict";let n;function i(e){return(""+e).replace(/^((?:https?|file|ftp|chrome-extension|moz-extension):\/\/.+)?\/[^/]+(?:\?.*)?$/,"$1")+"/"}Object.defineProperty(t,"__esModule",{value:!0}),t.getBundleURL=t.getBaseURL=void 0,t.getBundleURL=function(){return n||(n=function(){try{throw new Error}catch(e){const t=(""+e.stack).match(/(https?|file|ftp|chrome-extension|moz-extension):\/\/[^)\n]+/g);if(t)return i(t[0])}return"/"}()),n},t.getBaseURL=i},1592:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isWorkerRuntime=t.getWorkerImplementation=t.defaultPoolSize=void 0;const i=n(1029);t.defaultPoolSize="undefined"!=typeof navigator&&navigator.hardwareConcurrency?navigator.hardwareConcurrency:4;const r=e=>/^[a-zA-Z][a-zA-Z\d+\-.]*:/.test(e);function s(e){const t=new Blob([e],{type:"application/javascript"});return URL.createObjectURL(t)}let a;t.getWorkerImplementation=function(){return a||(a=function(){if("undefined"==typeof Worker)return class{constructor(){throw Error("No web worker implementation available. You might have tried to spawn a worker within a worker in a browser that doesn't support workers in workers.")}};class e extends Worker{constructor(e,t){var n,a;"string"==typeof e&&t&&t._baseURL?e=new URL(e,t._baseURL):"string"==typeof e&&!r(e)&&i.getBundleURL().match(/^file:\/\//i)&&(e=new URL(e,i.getBundleURL().replace(/\/[^\/]+$/,"/")),(null===(n=null==t?void 0:t.CORSWorkaround)||void 0===n||n)&&(e=s(`importScripts(${JSON.stringify(e)});`))),"string"==typeof e&&r(e)&&(null===(a=null==t?void 0:t.CORSWorkaround)||void 0===a||a)&&(e=s(`importScripts(${JSON.stringify(e)});`)),super(e,t)}}class t extends e{constructor(e,t){super(window.URL.createObjectURL(e),t)}static fromText(e,n){const i=new window.Blob([e],{type:"text/javascript"});return new t(i,n)}}return{blob:t,default:e}}()),a},t.isWorkerRuntime=function(){const e="undefined"!=typeof self&&"undefined"!=typeof Window&&self instanceof Window;return!("undefined"==typeof self||!self.postMessage||e)}},1652:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Dimensions=void 0;const i=n(876),r=n(4553);t.Dimensions={create:function(e,t=[]){return Object.keys(e).reduce(((e,n)=>{const i=a[n];if(i)return{...e,[n]:i};const s=t.find((e=>e.name===n)),o=s&&r.ExtraBytes.getDimension(s);if(o)return{...e,[n]:o};throw new Error(`Failed to look up LAS type: ${n}`)}),{})}};const{Type:s}=i.Dimension,a={X:s.float64,Y:s.float64,Z:s.float64,Intensity:s.uint16,ReturnNumber:s.uint8,NumberOfReturns:s.uint8,ScanDirectionFlag:s.boolean,EdgeOfFlightLine:s.boolean,Classification:s.uint8,Synthetic:s.boolean,KeyPoint:s.boolean,Withheld:s.boolean,Overlap:s.boolean,ScanAngle:s.float32,UserData:s.uint8,PointSourceId:s.uint16,GpsTime:s.float64,Red:s.uint16,Green:s.uint16,Blue:s.uint16,ScannerChannel:s.uint8,Infrared:s.uint16}},1677:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Extractor=void 0;const i=n(876);function r(e){const{scale:t,offset:n}=e,r=o(e);function s(e,t){return e.getUint8(r(t)+14)}function a(e,t){return e.getUint8(r(t)+15)}function l(e,t){return 31&a(e,t)}return{X:(e,s)=>i.Scale.unapply(e.getInt32(r(s),!0),t[0],n[0]),Y:(e,s)=>i.Scale.unapply(e.getInt32(r(s)+4,!0),t[1],n[1]),Z:(e,s)=>i.Scale.unapply(e.getInt32(r(s)+8,!0),t[2],n[2]),Intensity:(e,t)=>e.getUint16(r(t)+12,!0),ReturnNumber:(e,t)=>7&s(e,t),NumberOfReturns:(e,t)=>(56&s(e,t))>>3,ScanDirectionFlag:(e,t)=>(64&s(e,t))>>6,EdgeOfFlightLine:(e,t)=>(128&s(e,t))>>7,Classification:(e,t)=>{const n=l(e,t);return 12===n?0:n},Synthetic:(e,t)=>(32&a(e,t))>>5,KeyPoint:(e,t)=>(64&a(e,t))>>6,Withheld:(e,t)=>(128&a(e,t))>>7,Overlap:(e,t)=>12===l(e,t)?1:0,ScanAngle:(e,t)=>e.getInt8(r(t)+16),UserData:(e,t)=>e.getUint8(r(t)+17),PointSourceId:(e,t)=>e.getUint16(r(t)+18,!0)}}function s(e){const{scale:t,offset:n}=e,r=o(e);function s(e,t){return e.getUint8(r(t)+15)}return{X:(e,s)=>i.Scale.unapply(e.getInt32(r(s),!0),t[0],n[0]),Y:(e,s)=>i.Scale.unapply(e.getInt32(r(s)+4,!0),t[1],n[1]),Z:(e,s)=>i.Scale.unapply(e.getInt32(r(s)+8,!0),t[2],n[2]),Intensity:(e,t)=>e.getUint16(r(t)+12,!0),ReturnNumber:(e,t)=>15&e.getUint16(r(t)+14,!0),NumberOfReturns:(e,t)=>(240&e.getUint16(r(t)+14,!0))>>4,Synthetic:(e,t)=>1&s(e,t),KeyPoint:(e,t)=>(2&s(e,t))>>1,Withheld:(e,t)=>(4&s(e,t))>>2,Overlap:(e,t)=>(8&s(e,t))>>3,ScannerChannel:(e,t)=>(48&s(e,t))>>4,ScanDirectionFlag:(e,t)=>(64&s(e,t))>>6,EdgeOfFlightLine:(e,t)=>(128&s(e,t))>>7,Classification:(e,t)=>e.getUint8(r(t)+16),UserData:(e,t)=>e.getUint8(r(t)+17),ScanAngle:(e,t)=>.006*e.getInt16(r(t)+18,!0),PointSourceId:(e,t)=>e.getUint16(r(t)+20,!0),GpsTime:(e,t)=>e.getFloat64(r(t)+22,!0)}}function a(e){const t=o(e);return{...s(e),Red:(e,n)=>e.getUint16(t(n)+30,!0),Green:(e,n)=>e.getUint16(t(n)+32,!0),Blue:(e,n)=>e.getUint16(t(n)+34,!0)}}function o(e){const{pointDataRecordLength:t}=e;return function(e){return e*t}}t.Extractor={create:function(e,t=[]){const n=function(e,t){let n=function(e){switch(e){case 0:return 20;case 1:return 28;case 2:return 26;case 3:return 34;case 6:return 30;case 7:return 36;case 8:return 38;default:throw new Error(`Unsupported point data record format: ${e}`)}}(e.pointDataRecordFormat);return t.reduce(((t,r)=>{const s=n;n+=r.length;const a=function(e,t,{type:n,length:r}){const s=o(e);switch(n){case"signed":switch(r){case 1:return(e,n)=>e.getInt8(s(n)+t);case 2:return(e,n)=>e.getInt16(s(n)+t,!0);case 4:return(e,n)=>e.getInt32(s(n)+t,!0);case 8:return(e,n)=>(0,i.parseBigInt)(e.getBigInt64(s(n)+t,!0))}case"unsigned":switch(r){case 1:return(e,n)=>e.getUint8(s(n)+t);case 2:return(e,n)=>e.getUint16(s(n)+t,!0);case 4:return(e,n)=>e.getUint32(s(n)+t,!0);case 8:return(e,n)=>(0,i.parseBigInt)((0,i.getBigUint64)(e,s(n)+t,!0))}case"float":switch(r){case 4:return(e,n)=>e.getFloat32(s(n)+t,!0);case 8:return(e,n)=>e.getFloat64(s(n)+t,!0)}}}(e,s,r);if(!a)return t;return{...t,[r.name]:(e,t)=>i.Scale.unapply(a(e,t),r.scale,r.offset)}}),{})}(e,t);return{...(()=>{const{pointDataRecordFormat:t}=e;switch(t){case 0:return r(e);case 1:return function(e){const t=o(e);return{...r(e),GpsTime:(e,n)=>e.getFloat64(t(n)+20,!0)}}(e);case 2:return function(e){const t=o(e);return{...r(e),Red:(e,n)=>e.getUint16(t(n)+20,!0),Green:(e,n)=>e.getUint16(t(n)+22,!0),Blue:(e,n)=>e.getUint16(t(n)+24,!0)}}(e);case 3:return function(e){const t=o(e);return{...r(e),GpsTime:(e,n)=>e.getFloat64(t(n)+20,!0),Red:(e,n)=>e.getUint16(t(n)+28,!0),Green:(e,n)=>e.getUint16(t(n)+30,!0),Blue:(e,n)=>e.getUint16(t(n)+32,!0)}}(e);case 6:return s(e);case 7:return a(e);case 8:return function(e){const t=o(e);return{...a(e),Infrared:(e,n)=>e.getUint16(t(n)+36,!0)}}(e);default:throw new Error(`Unsupported point data record format: ${t}`)}})(),...n}}}},1854:function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function a(e){try{l(i.next(e))}catch(e){s(e)}}function o(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,o)}l((i=i.apply(e,t||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.expose=t.isWorkerRuntime=t.Transfer=t.registerSerializer=void 0;const s=r(n(5409)),a=n(9278),o=n(6712),l=n(2781),c=r(n(4304));var h=n(9278);Object.defineProperty(t,"registerSerializer",{enumerable:!0,get:function(){return h.registerSerializer}});var u=n(6712);Object.defineProperty(t,"Transfer",{enumerable:!0,get:function(){return u.Transfer}}),t.isWorkerRuntime=c.default.isWorkerRuntime;let d=!1;const p=new Map,f=e=>e&&e.type===l.MasterMessageType.run,m=e=>s.default(e)||function(e){return e&&"object"==typeof e&&"function"==typeof e.subscribe}(e);function g(e){return o.isTransferDescriptor(e)?{payload:e.send,transferables:e.transferables}:{payload:e,transferables:void 0}}function A(e,t){const{payload:n,transferables:i}=g(t),r={type:l.WorkerMessageType.error,uid:e,error:a.serialize(n)};c.default.postMessageToMaster(r,i)}function y(e,t,n){const{payload:i,transferables:r}=g(n),s={type:l.WorkerMessageType.result,uid:e,complete:!!t||void 0,payload:i};c.default.postMessageToMaster(s,r)}function v(e){try{const t={type:l.WorkerMessageType.uncaughtError,error:a.serialize(e)};c.default.postMessageToMaster(t)}catch(t){console.error("Not reporting uncaught error back to master thread as it occured while reporting an uncaught error already.\nLatest error:",t,"\nOriginal error:",e)}}function _(e,t,n){return i(this,void 0,void 0,(function*(){let i;try{i=t(...n)}catch(t){return A(e,t)}const r=m(i)?"observable":"promise";if(function(e,t){const n={type:l.WorkerMessageType.running,uid:e,resultType:t};c.default.postMessageToMaster(n)}(e,r),m(i)){const t=i.subscribe((t=>y(e,!1,a.serialize(t))),(t=>{A(e,a.serialize(t)),p.delete(e)}),(()=>{y(e,!0),p.delete(e)}));p.set(e,t)}else try{const t=yield i;y(e,!0,a.serialize(t))}catch(t){A(e,a.serialize(t))}}))}t.expose=function(e){if(!c.default.isWorkerRuntime())throw Error("expose() called in the master thread.");if(d)throw Error("expose() called more than once. This is not possible. Pass an object to expose() if you want to expose multiple functions.");if(d=!0,"function"==typeof e)c.default.subscribeToMasterMessages((t=>{f(t)&&!t.method&&_(t.uid,e,t.args.map(a.deserialize))})),function(){const e={type:l.WorkerMessageType.init,exposed:{type:"function"}};c.default.postMessageToMaster(e)}();else{if("object"!=typeof e||!e)throw Error(`Invalid argument passed to expose(). Expected a function or an object, got: ${e}`);c.default.subscribeToMasterMessages((t=>{f(t)&&t.method&&_(t.uid,e[t.method],t.args.map(a.deserialize))})),function(e){const t={type:l.WorkerMessageType.init,exposed:{type:"module",methods:e}};c.default.postMessageToMaster(t)}(Object.keys(e).filter((t=>"function"==typeof e[t])))}c.default.subscribeToMasterMessages((e=>{if((t=e)&&t.type===l.MasterMessageType.cancel){const t=e.uid,n=p.get(t);n&&(n.unsubscribe(),p.delete(t))}var t}))},"undefined"!=typeof self&&"function"==typeof self.addEventListener&&c.default.isWorkerRuntime()&&(self.addEventListener("error",(e=>{setTimeout((()=>v(e.error||e)),250)})),self.addEventListener("unhandledrejection",(e=>{const t=e.reason;t&&"string"==typeof t.message&&setTimeout((()=>v(t)),250)}))),"undefined"!=typeof process&&"function"==typeof process.on&&c.default.isWorkerRuntime()&&(process.on("uncaughtException",(e=>{setTimeout((()=>v(e)),250)})),process.on("unhandledRejection",(e=>{e&&"string"==typeof e.message&&setTimeout((()=>v(e)),250)})))},1898:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ObservablePromise=void 0;const i=n(4527),r=()=>{},s=e=>e,a=e=>Promise.resolve().then(e);function o(e){throw e}class l extends i.Observable{constructor(e){super((t=>{const n=this,i=Object.assign(Object.assign({},t),{complete(){t.complete(),n.onCompletion()},error(e){t.error(e),n.onError(e)},next(e){t.next(e),n.onNext(e)}});try{return this.initHasRun=!0,e(i)}catch(e){i.error(e)}})),this.initHasRun=!1,this.fulfillmentCallbacks=[],this.rejectionCallbacks=[],this.firstValueSet=!1,this.state="pending"}onNext(e){this.firstValueSet||(this.firstValue=e,this.firstValueSet=!0)}onError(e){this.state="rejected",this.rejection=e;for(const t of this.rejectionCallbacks)a((()=>t(e)))}onCompletion(){this.state="fulfilled";for(const e of this.fulfillmentCallbacks)a((()=>e(this.firstValue)))}then(e,t){const n=e||s,i=t||o;let r=!1;return new Promise(((e,t)=>{const s=n=>{if(!r){r=!0;try{e(i(n))}catch(e){t(e)}}};return this.initHasRun||this.subscribe({error:s}),"fulfilled"===this.state?e(n(this.firstValue)):"rejected"===this.state?(r=!0,e(i(this.rejection))):(this.fulfillmentCallbacks.push((t=>{try{e(n(t))}catch(e){s(e)}})),void this.rejectionCallbacks.push(s))}))}catch(e){return this.then(void 0,e)}finally(e){const t=e||r;return this.then((e=>(t(),e)),(()=>t()))}static from(e){return function(e){return e&&"function"==typeof e.then}(e)?new l((t=>{e.then((e=>{t.next(e),t.complete()}),(e=>{t.error(e)}))})):super.from(e)}}t.ObservablePromise=l},2101:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Vlr=void 0;const i=n(876),r=n(8300);function s(e,t,n){return e.find((e=>e.userId===t&&e.recordId===n))}function a(e,t){return(t?l:o)(e)}function o(e){const t=i.Binary.toDataView(e);if(t.byteLength!==r.vlrHeaderLength)throw new Error(`Invalid VLR header length (must be ${r.vlrHeaderLength}): ${t.byteLength}`);return{userId:i.Binary.toCString(e.slice(2,18)),recordId:t.getUint16(18,!0),contentLength:t.getUint16(20,!0),description:i.Binary.toCString(e.slice(22,54)),isExtended:!1}}function l(e){const t=i.Binary.toDataView(e);if(t.byteLength!==r.evlrHeaderLength)throw new Error(`Invalid EVLR header length (must be ${r.evlrHeaderLength}): ${t.byteLength}`);return{userId:i.Binary.toCString(e.slice(2,18)),recordId:t.getUint16(18,!0),contentLength:(0,i.parseBigInt)((0,i.getBigUint64)(t,20,!0)),description:i.Binary.toCString(e.slice(28,60)),isExtended:!0}}async function c({get:e,startOffset:t,count:n,isExtended:i}){const s=[];let o=t;const l=i?r.evlrHeaderLength:r.vlrHeaderLength;for(let t=0;t<n;++t){const t=l?await e(o,o+l):new Uint8Array,{userId:n,recordId:r,contentLength:c,description:h}=a(t,i);s.push({userId:n,recordId:r,contentOffset:o+l,contentLength:c,description:h,isExtended:i}),o+=l+c}return s}t.Vlr={walk:async function(e,t){const n=i.Getter.create(e);return[...await c({get:n,startOffset:t.headerLength,count:t.vlrCount,isExtended:!1}),...await c({get:n,startOffset:t.evlrOffset,count:t.evlrCount,isExtended:!0})]},parse:a,find:s,at:function(e,t,n){const i=s(e,t,n);if(!i)throw new Error(`VLR not found: ${t}/${n}`);return i},fetch:function(e,{contentOffset:t,contentLength:n}){return 0===n?new Uint8Array:i.Getter.create(e)(t,t+n)}}},2734:function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function a(e){try{l(i.next(e))}catch(e){s(e)}}function o(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,o)}l((i=i.apply(e,t||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Pool=t.Thread=t.PoolEventType=void 0;const s=r(n(7833)),a=n(4527),o=n(7709),l=n(1592),c=n(2882);Object.defineProperty(t,"PoolEventType",{enumerable:!0,get:function(){return c.PoolEventType}});const h=n(2996);Object.defineProperty(t,"Thread",{enumerable:!0,get:function(){return h.Thread}});let u=1;class d{constructor(e,t){this.eventSubject=new a.Subject,this.initErrors=[],this.isClosing=!1,this.nextTaskID=1,this.taskQueue=[];const n="number"==typeof t?{size:t}:t||{},{size:i=l.defaultPoolSize}=n;var r;this.debug=s.default(`threads:pool:${r=n.name||String(u++),r.replace(/\W/g," ").trim().replace(/\s+/g,"-")}`),this.options=n,this.workers=function(e,t){return function(e){const t=[];for(let n=0;n<e;n++)t.push(n);return t}(t).map((()=>({init:e(),runningTasks:[]})))}(e,i),this.eventObservable=a.multicast(a.Observable.from(this.eventSubject)),Promise.all(this.workers.map((e=>e.init))).then((()=>this.eventSubject.next({type:c.PoolEventType.initialized,size:this.workers.length})),(e=>{this.debug("Error while initializing pool worker:",e),this.eventSubject.error(e),this.initErrors.push(e)}))}findIdlingWorker(){const{concurrency:e=1}=this.options;return this.workers.find((t=>t.runningTasks.length<e))}runPoolTask(e,t){return i(this,void 0,void 0,(function*(){const n=this.workers.indexOf(e)+1;this.debug(`Running task #${t.id} on worker #${n}...`),this.eventSubject.next({type:c.PoolEventType.taskStart,taskID:t.id,workerID:n});try{const i=yield t.run(yield e.init);this.debug(`Task #${t.id} completed successfully`),this.eventSubject.next({type:c.PoolEventType.taskCompleted,returnValue:i,taskID:t.id,workerID:n})}catch(e){this.debug(`Task #${t.id} failed`),this.eventSubject.next({type:c.PoolEventType.taskFailed,taskID:t.id,error:e,workerID:n})}}))}run(e,t){return i(this,void 0,void 0,(function*(){const n=(()=>i(this,void 0,void 0,(function*(){yield new Promise((e=>setTimeout(e,0)));try{yield this.runPoolTask(e,t)}finally{e.runningTasks=e.runningTasks.filter((e=>e!==n)),this.isClosing||this.scheduleWork()}})))();e.runningTasks.push(n)}))}scheduleWork(){this.debug("Attempt de-queueing a task in order to run it...");const e=this.findIdlingWorker();if(!e)return;const t=this.taskQueue.shift();if(!t)return this.debug("Task queue is empty"),void this.eventSubject.next({type:c.PoolEventType.taskQueueDrained});this.run(e,t)}taskCompletion(e){return new Promise(((t,n)=>{const i=this.events().subscribe((r=>{r.type===c.PoolEventType.taskCompleted&&r.taskID===e?(i.unsubscribe(),t(r.returnValue)):r.type===c.PoolEventType.taskFailed&&r.taskID===e?(i.unsubscribe(),n(r.error)):r.type===c.PoolEventType.terminated&&(i.unsubscribe(),n(Error("Pool has been terminated before task was run.")))}))}))}settled(e=!1){return i(this,void 0,void 0,(function*(){const t=()=>{return e=this.workers,t=e=>e.runningTasks,e.reduce(((e,n)=>[...e,...t(n)]),[]);var e,t},n=[],i=this.eventObservable.subscribe((e=>{e.type===c.PoolEventType.taskFailed&&n.push(e.error)}));return this.initErrors.length>0?Promise.reject(this.initErrors[0]):e&&0===this.taskQueue.length?(yield o.allSettled(t()),n):(yield new Promise(((e,t)=>{const n=this.eventObservable.subscribe({next(t){t.type===c.PoolEventType.taskQueueDrained&&(n.unsubscribe(),e(void 0))},error:t})})),yield o.allSettled(t()),i.unsubscribe(),n)}))}completed(e=!1){return i(this,void 0,void 0,(function*(){const t=this.settled(e),n=new Promise(((e,n)=>{const i=this.eventObservable.subscribe({next(r){r.type===c.PoolEventType.taskQueueDrained?(i.unsubscribe(),e(t)):r.type===c.PoolEventType.taskFailed&&(i.unsubscribe(),n(r.error))},error:n})})),i=yield Promise.race([t,n]);if(i.length>0)throw i[0]}))}events(){return this.eventObservable}queue(e){const{maxQueuedJobs:t=1/0}=this.options;if(this.isClosing)throw Error("Cannot schedule pool tasks after terminate() has been called.");if(this.initErrors.length>0)throw this.initErrors[0];const n=this.nextTaskID++,i=this.taskCompletion(n);i.catch((e=>{this.debug(`Task #${n} errored:`,e)}));const r={id:n,run:e,cancel:()=>{-1!==this.taskQueue.indexOf(r)&&(this.taskQueue=this.taskQueue.filter((e=>e!==r)),this.eventSubject.next({type:c.PoolEventType.taskCanceled,taskID:r.id}))},then:i.then.bind(i)};if(this.taskQueue.length>=t)throw Error("Maximum number of pool tasks queued. Refusing to queue another one.\nThis usually happens for one of two reasons: We are either at peak workload right now or some tasks just won't finish, thus blocking the pool.");return this.debug(`Queueing task #${r.id}...`),this.taskQueue.push(r),this.eventSubject.next({type:c.PoolEventType.taskQueued,taskID:r.id}),this.scheduleWork(),r}terminate(e){return i(this,void 0,void 0,(function*(){this.isClosing=!0,e||(yield this.completed(!0)),this.eventSubject.next({type:c.PoolEventType.terminated,remainingQueue:[...this.taskQueue]}),this.eventSubject.complete(),yield Promise.all(this.workers.map((e=>i(this,void 0,void 0,(function*(){return h.Thread.terminate(yield e.init)})))))}))}}function p(e,t){return new d(e,t)}d.EventType=c.PoolEventType,p.EventType=c.PoolEventType,t.Pool=p},2781:(e,t)=>{"use strict";var n,i;Object.defineProperty(t,"__esModule",{value:!0}),t.WorkerMessageType=t.MasterMessageType=void 0,(i=t.MasterMessageType||(t.MasterMessageType={})).cancel="cancel",i.run="run",(n=t.WorkerMessageType||(t.WorkerMessageType={})).error="error",n.init="init",n.result="result",n.running="running",n.uncaughtError="uncaughtError"},2882:(e,t)=>{"use strict";var n;Object.defineProperty(t,"__esModule",{value:!0}),t.PoolEventType=void 0,(n=t.PoolEventType||(t.PoolEventType={})).initialized="initialized",n.taskCanceled="taskCanceled",n.taskCompleted="taskCompleted",n.taskFailed="taskFailed",n.taskQueued="taskQueued",n.taskQueueDrained="taskQueueDrained",n.taskStart="taskStart",n.terminated="terminated"},2931:(e,t,n)=>{"use strict";var i;Object.defineProperty(t,"__esModule",{value:!0}),t.WorkerEventType=void 0,n(3682),(i=t.WorkerEventType||(t.WorkerEventType={})).internalError="internalError",i.message="message",i.termination="termination"},2996:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Thread=void 0;const i=n(3682);function r(e){throw Error(e)}t.Thread={errors:e=>e[i.$errors]||r("Error observable not found. Make sure to pass a thread instance as returned by the spawn() promise."),events:e=>e[i.$events]||r("Events observable not found. Make sure to pass a thread instance as returned by the spawn() promise."),terminate:e=>e[i.$terminate]()}},3359:(e,t)=>{"use strict";function n(e){return new DataView(e.buffer,e.byteOffset,e.length)}function i(e){const t=n(e);let i="";for(let e=0;e<t.byteLength;++e){const n=t.getInt8(e);if(0===n)return i;i+=String.fromCharCode(n)}return i}Object.defineProperty(t,"__esModule",{value:!0}),t.toCString=t.toDataView=t.Binary=void 0,t.Binary={toDataView:n,toCString:i},t.toDataView=n,t.toCString=i},3682:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.$worker=t.$transferable=t.$terminate=t.$events=t.$errors=void 0,t.$errors=Symbol("thread.errors"),t.$events=Symbol("thread.events"),t.$terminate=Symbol("thread.terminate"),t.$transferable=Symbol("thread.transferable"),t.$worker=Symbol("thread.worker")},4238:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createPromiseWithResolver=void 0;const n=()=>{};t.createPromiseWithResolver=function(){let e,t=!1,i=n;return[new Promise((n=>{t?n(e):i=n})),n=>{t=!0,e=n,i(e)}]}},4304:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default={isWorkerRuntime:function(){const e="undefined"!=typeof self&&"undefined"!=typeof Window&&self instanceof Window;return!("undefined"==typeof self||!self.postMessage||e)},postMessageToMaster:function(e,t){self.postMessage(e,t)},subscribeToMasterMessages:function(e){const t=t=>{e(t.data)};return self.addEventListener("message",t),()=>{self.removeEventListener("message",t)}}}},4305:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Hierarchy=void 0,t.Hierarchy={parse:function(e){return Object.entries(e).reduce(((e,[t,n])=>(-1===n?e.pages[t]={}:n&&(e.nodes[t]={pointCount:n}),e)),{nodes:{},pages:{}})}}},4324:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Dimension=void 0,t.Dimension={Type:{int8:{type:"signed",size:1},int16:{type:"signed",size:2},int32:{type:"signed",size:4},int64:{type:"signed",size:8},uint8:{type:"unsigned",size:1},uint16:{type:"unsigned",size:2},uint32:{type:"unsigned",size:4},uint64:{type:"unsigned",size:8},float32:{type:"float",size:4},float64:{type:"float",size:8},float:{type:"float",size:4},double:{type:"float",size:8},bool:{type:"unsigned",size:1},boolean:{type:"unsigned",size:1}},ctype:function({type:e,size:t}){switch(e){case"signed":switch(t){case 1:return"int8";case 2:return"int16";case 4:return"int32";case 8:return"int64"}case"unsigned":switch(t){case 1:return"uint8";case 2:return"uint16";case 4:return"uint32";case 8:return"uint64"}case"float":switch(t){case 4:return"float";case 8:return"double"}}throw new Error(`Invalid dimension type/size: ${e}/${t}`)}}},4457:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Worker=t.BlobWorker=t.isWorkerRuntime=t.Thread=t.spawn=t.Pool=void 0;const i=n(1592);Object.defineProperty(t,"isWorkerRuntime",{enumerable:!0,get:function(){return i.isWorkerRuntime}});var r=n(2734);Object.defineProperty(t,"Pool",{enumerable:!0,get:function(){return r.Pool}});var s=n(4949);Object.defineProperty(t,"spawn",{enumerable:!0,get:function(){return s.spawn}});var a=n(2996);Object.defineProperty(t,"Thread",{enumerable:!0,get:function(){return a.Thread}}),t.BlobWorker=i.getWorkerImplementation().blob,t.Worker=i.getWorkerImplementation().default},4527:(e,t,n)=>{"use strict";n.r(t),n.d(t,{Observable:()=>x,Subject:()=>T,filter:()=>b,flatMap:()=>w,interval:()=>M,map:()=>S,merge:()=>C,multicast:()=>I,scan:()=>R,unsubscribe:()=>E});class i{constructor(e){this._baseObserver=e,this._pendingPromises=new Set}complete(){Promise.all(this._pendingPromises).then((()=>this._baseObserver.complete())).catch((e=>this._baseObserver.error(e)))}error(e){this._baseObserver.error(e)}schedule(e){const t=Promise.all(this._pendingPromises),n=[],i=e=>n.push(e),r=Promise.resolve().then((()=>{return s=this,a=void 0,l=function*(){yield t,yield e(i),this._pendingPromises.delete(r);for(const e of n)this._baseObserver.next(e)},new((o=void 0)||(o=Promise))((function(e,t){function n(e){try{r(l.next(e))}catch(e){t(e)}}function i(e){try{r(l.throw(e))}catch(e){t(e)}}function r(t){var r;t.done?e(t.value):(r=t.value,r instanceof o?r:new o((function(e){e(r)}))).then(n,i)}r((l=l.apply(s,a||[])).next())}));var s,a,o,l})).catch((e=>{this._pendingPromises.delete(r),this._baseObserver.error(e)}));this._pendingPromises.add(r)}}const r=()=>"function"==typeof Symbol,s=e=>r()&&Boolean(Symbol[e]),a=e=>s(e)?Symbol[e]:"@@"+e;s("asyncIterator")||(Symbol.asyncIterator=Symbol.asyncIterator||Symbol.for("Symbol.asyncIterator"));const o=a("iterator"),l=a("observable"),c=a("species");function h(e,t){const n=e[t];if(null!=n){if("function"!=typeof n)throw new TypeError(n+" is not a function");return n}}function u(e){let t=e.constructor;return void 0!==t&&(t=t[c],null===t&&(t=void 0)),void 0!==t?t:_}function d(e){d.log?d.log(e):setTimeout((()=>{throw e}),0)}function p(e){Promise.resolve().then((()=>{try{e()}catch(e){d(e)}}))}function f(e){const t=e._cleanup;if(void 0!==t&&(e._cleanup=void 0,t))try{if("function"==typeof t)t();else{const e=h(t,"unsubscribe");e&&e.call(t)}}catch(e){d(e)}}function m(e){e._observer=void 0,e._queue=void 0,e._state="closed"}function g(e,t,n){e._state="running";const i=e._observer;try{const r=i?h(i,t):void 0;switch(t){case"next":r&&r.call(i,n);break;case"error":if(m(e),!r)throw n;r.call(i,n);break;case"complete":m(e),r&&r.call(i)}}catch(e){d(e)}"closed"===e._state?f(e):"running"===e._state&&(e._state="ready")}function A(e,t,n){if("closed"!==e._state)return"buffering"===e._state?(e._queue=e._queue||[],void e._queue.push({type:t,value:n})):"ready"!==e._state?(e._state="buffering",e._queue=[{type:t,value:n}],void p((()=>function(e){const t=e._queue;if(t){e._queue=void 0,e._state="ready";for(const n of t)if(g(e,n.type,n.value),"closed"===e._state)break}}(e)))):void g(e,t,n)}class y{constructor(e,t){this._cleanup=void 0,this._observer=e,this._queue=void 0,this._state="initializing";const n=new v(this);try{this._cleanup=t.call(void 0,n)}catch(e){n.error(e)}"initializing"===this._state&&(this._state="ready")}get closed(){return"closed"===this._state}unsubscribe(){"closed"!==this._state&&(m(this),f(this))}}class v{constructor(e){this._subscription=e}get closed(){return"closed"===this._subscription._state}next(e){A(this._subscription,"next",e)}error(e){A(this._subscription,"error",e)}complete(){A(this._subscription,"complete")}}class _{constructor(e){if(!(this instanceof _))throw new TypeError("Observable cannot be called as a function");if("function"!=typeof e)throw new TypeError("Observable initializer must be a function");this._subscriber=e}subscribe(e,t,n){return"object"==typeof e&&null!==e||(e={next:e,error:t,complete:n}),new y(e,this._subscriber)}pipe(e,...t){let n=this;for(const i of[e,...t])n=i(n);return n}tap(e,t,n){const i="object"!=typeof e||null===e?{next:e,error:t,complete:n}:e;return new _((e=>this.subscribe({next(t){i.next&&i.next(t),e.next(t)},error(t){i.error&&i.error(t),e.error(t)},complete(){i.complete&&i.complete(),e.complete()},start(e){i.start&&i.start(e)}})))}forEach(e){return new Promise(((t,n)=>{if("function"!=typeof e)return void n(new TypeError(e+" is not a function"));function i(){r.unsubscribe(),t(void 0)}const r=this.subscribe({next(t){try{e(t,i)}catch(e){n(e),r.unsubscribe()}},error(e){n(e)},complete(){t(void 0)}})}))}map(e){if("function"!=typeof e)throw new TypeError(e+" is not a function");return new(u(this))((t=>this.subscribe({next(n){let i=n;try{i=e(n)}catch(e){return t.error(e)}t.next(i)},error(e){t.error(e)},complete(){t.complete()}})))}filter(e){if("function"!=typeof e)throw new TypeError(e+" is not a function");return new(u(this))((t=>this.subscribe({next(n){try{if(!e(n))return}catch(e){return t.error(e)}t.next(n)},error(e){t.error(e)},complete(){t.complete()}})))}reduce(e,t){if("function"!=typeof e)throw new TypeError(e+" is not a function");const n=u(this),i=arguments.length>1;let r=!1,s=t;return new n((t=>this.subscribe({next(n){const a=!r;if(r=!0,!a||i)try{s=e(s,n)}catch(e){return t.error(e)}else s=n},error(e){t.error(e)},complete(){if(!r&&!i)return t.error(new TypeError("Cannot reduce an empty sequence"));t.next(s),t.complete()}})))}concat(...e){const t=u(this);return new t((n=>{let i,r=0;return function s(a){i=a.subscribe({next(e){n.next(e)},error(e){n.error(e)},complete(){r===e.length?(i=void 0,n.complete()):s(t.from(e[r++]))}})}(this),()=>{i&&(i.unsubscribe(),i=void 0)}}))}flatMap(e){if("function"!=typeof e)throw new TypeError(e+" is not a function");const t=u(this);return new t((n=>{const i=[],r=this.subscribe({next(r){let a;if(e)try{a=e(r)}catch(e){return n.error(e)}else a=r;const o=t.from(a).subscribe({next(e){n.next(e)},error(e){n.error(e)},complete(){const e=i.indexOf(o);e>=0&&i.splice(e,1),s()}});i.push(o)},error(e){n.error(e)},complete(){s()}});function s(){r.closed&&0===i.length&&n.complete()}return()=>{i.forEach((e=>e.unsubscribe())),r.unsubscribe()}}))}[(Symbol.observable,l)](){return this}static from(e){const t="function"==typeof this?this:_;if(null==e)throw new TypeError(e+" is not an object");const n=h(e,l);if(n){const i=n.call(e);if(Object(i)!==i)throw new TypeError(i+" is not an object");return function(e){return e instanceof _}(i)&&i.constructor===t?i:new t((e=>i.subscribe(e)))}if(s("iterator")){const n=h(e,o);if(n)return new t((t=>{p((()=>{if(!t.closed){for(const i of n.call(e))if(t.next(i),t.closed)return;t.complete()}}))}))}if(Array.isArray(e))return new t((t=>{p((()=>{if(!t.closed){for(const n of e)if(t.next(n),t.closed)return;t.complete()}}))}));throw new TypeError(e+" is not observable")}static of(...e){return new("function"==typeof this?this:_)((t=>{p((()=>{if(!t.closed){for(const n of e)if(t.next(n),t.closed)return;t.complete()}}))}))}static get[c](){return this}}r()&&Object.defineProperty(_,Symbol("extensions"),{value:{symbol:l,hostReportError:d},configurable:!0});const x=_,E=function(e){"function"==typeof e?e():e&&"function"==typeof e.unsubscribe&&e.unsubscribe()};const b=function(e){return t=>new x((n=>{const r=new i(n),s=t.subscribe({complete(){r.complete()},error(e){r.error(e)},next(t){r.schedule((n=>{return i=this,r=void 0,a=function*(){(yield e(t))&&n(t)},new((s=void 0)||(s=Promise))((function(e,t){function n(e){try{l(a.next(e))}catch(e){t(e)}}function o(e){try{l(a.throw(e))}catch(e){t(e)}}function l(t){var i;t.done?e(t.value):(i=t.value,i instanceof s?i:new s((function(e){e(i)}))).then(n,o)}l((a=a.apply(i,r||[])).next())}));var i,r,s,a}))}});return()=>E(s)}))};const w=function(e){return t=>new x((n=>{const r=new i(n),a=t.subscribe({complete(){r.complete()},error(e){r.error(e)},next(t){r.schedule((n=>{return i=this,r=void 0,o=function*(){var i,r;const a=yield e(t);if((c=a)&&s("iterator")&&c[Symbol.iterator]||function(e){return e&&s("asyncIterator")&&e[Symbol.asyncIterator]}(a))try{for(var o,l=function(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,n=e[Symbol.asyncIterator];return n?n.call(e):(e="function"==typeof __values?__values(e):e[Symbol.iterator](),t={},i("next"),i("throw"),i("return"),t[Symbol.asyncIterator]=function(){return this},t);function i(n){t[n]=e[n]&&function(t){return new Promise((function(i,r){!function(e,t,n,i){Promise.resolve(i).then((function(t){e({value:t,done:n})}),t)}(i,r,(t=e[n](t)).done,t.value)}))}}}(a);!(o=yield l.next()).done;){const e=o.value;n(e)}}catch(e){i={error:e}}finally{try{o&&!o.done&&(r=l.return)&&(yield r.call(l))}finally{if(i)throw i.error}}else a.map((e=>n(e)));var c},new((a=void 0)||(a=Promise))((function(e,t){function n(e){try{l(o.next(e))}catch(e){t(e)}}function s(e){try{l(o.throw(e))}catch(e){t(e)}}function l(t){var i;t.done?e(t.value):(i=t.value,i instanceof a?i:new a((function(e){e(i)}))).then(n,s)}l((o=o.apply(i,r||[])).next())}));var i,r,a,o}))}});return()=>E(a)}))};function M(e){return new _((t=>{let n=0;const i=setInterval((()=>{t.next(n++)}),e);return()=>clearInterval(i)}))}const S=function(e){return t=>new x((n=>{const r=new i(n),s=t.subscribe({complete(){r.complete()},error(e){r.error(e)},next(t){r.schedule((n=>{return i=this,r=void 0,a=function*(){const i=yield e(t);n(i)},new((s=void 0)||(s=Promise))((function(e,t){function n(e){try{l(a.next(e))}catch(e){t(e)}}function o(e){try{l(a.throw(e))}catch(e){t(e)}}function l(t){var i;t.done?e(t.value):(i=t.value,i instanceof s?i:new s((function(e){e(i)}))).then(n,o)}l((a=a.apply(i,r||[])).next())}));var i,r,s,a}))}});return()=>E(s)}))},C=function(...e){return 0===e.length?_.from([]):new _((t=>{let n=0;const i=e.map((i=>i.subscribe({error(e){t.error(e),r()},next(e){t.next(e)},complete(){++n===e.length&&(t.complete(),r())}}))),r=()=>{i.forEach((e=>E(e)))};return r}))},T=class extends x{constructor(){super((e=>(this._observers.add(e),()=>this._observers.delete(e)))),this._observers=new Set}next(e){for(const t of this._observers)t.next(e)}error(e){for(const t of this._observers)t.error(e)}complete(){for(const e of this._observers)e.complete()}},I=function(e){const t=new T;let n,i=0;return new x((r=>{n||(n=e.subscribe(t));const s=t.subscribe(r);return i++,()=>{i--,s.unsubscribe(),0===i&&(E(n),n=void 0)}}))};const R=function(e,t){return n=>new x((r=>{let s,a=0;const o=new i(r),l=n.subscribe({complete(){o.complete()},error(e){o.error(e)},next(n){o.schedule((i=>{return r=this,o=void 0,c=function*(){const r=0===a?void 0===t?n:t:s;s=yield e(r,n,a++),i(s)},new((l=void 0)||(l=Promise))((function(e,t){function n(e){try{s(c.next(e))}catch(e){t(e)}}function i(e){try{s(c.throw(e))}catch(e){t(e)}}function s(t){var r;t.done?e(t.value):(r=t.value,r instanceof l?r:new l((function(e){e(r)}))).then(n,i)}s((c=c.apply(r,o||[])).next())}));var r,o,l,c}))}});return()=>E(l)}))}},4553:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ExtraBytes=void 0;const i=n(876);t.ExtraBytes={getDimension:function({type:e,length:t}){switch(e){case"signed":case"unsigned":switch(t){case 1:case 2:case 4:case 8:return{type:e,size:t}}case"float":switch(t){case 4:case 8:return{type:e,size:t}}}},parse:function(e){if(e.byteLength%r!=0)throw new Error(`Invalid extra bytes VLR length: ${e.byteLength}`);const t=[];for(let n=0;n<e.byteLength;n+=r)t.push(s(e.slice(n,n+r)));return t},parseOne:s};const r=192;function s(e){if(e.byteLength!==r)throw new Error(`Invalid extra bytes entry length: ${e.byteLength}`);const t=i.Binary.toDataView(e),n=i.Binary.toCString(e.slice(4,36)),s=i.Binary.toCString(e.slice(60,192)),a=t.getUint8(2),o=t.getUint8(3);if(a>=11)throw new Error(`Invalid extra bytes "type" value: ${a}`);if(0===a)return{name:n,description:s,length:o};const l=(c=o,{hasNodata:Boolean(1&c),hasMin:Boolean(c>>1&1),hasMax:Boolean(c>>2&1),hasScale:Boolean(c>>3&1),hasOffset:Boolean(c>>4&1)});var c;const h=function(e){switch(e){case 1:return i.Dimension.Type.uint8;case 2:return i.Dimension.Type.int8;case 3:return i.Dimension.Type.uint16;case 4:return i.Dimension.Type.int16;case 5:return i.Dimension.Type.uint32;case 6:return i.Dimension.Type.int32;case 7:return i.Dimension.Type.uint64;case 8:return i.Dimension.Type.int64;case 9:return i.Dimension.Type.float32;case 10:return i.Dimension.Type.float64}}(a);if(!h)throw new Error(`Failed to extract dimension type: ${a}`);const{type:u,size:d}=h;function p(e){switch(u){case"signed":return(0,i.parseBigInt)(t.getBigInt64(e,!0));case"unsigned":return(0,i.parseBigInt)((0,i.getBigUint64)(t,e,!0));case"float":return t.getFloat64(e,!0)}}const f={name:n,description:s,type:u,length:d};return l.hasNodata&&(f.nodata=p(40)),l.hasMin&&(f.min=p(64)),l.hasMax&&(f.max=p(88)),l.hasScale&&(f.scale=t.getFloat64(112)),l.hasOffset&&(f.offset=t.getFloat64(136)),f}},4623:(e,t)=>{"use strict";function n(e){if("string"!=typeof e)return e;const[t,n,i,r,...s]=e.split("-").map((e=>parseInt(e,10))),a=[t,n,i,r];if(0!==s.length||a.some((e=>"number"!=typeof e||Number.isNaN(e))))throw new Error(`Invalid key: ${e}`);return a}Object.defineProperty(t,"__esModule",{value:!0}),t.Key=void 0,t.Key={create:function(e,t=0,i=0,r=0){return"number"!=typeof e?n(e):[e,t,i,r]},parse:n,toString:function(e){return"string"==typeof e?e:e.join("-")},step:function(e,[n,i,r]){const[s,a,o,l]=t.Key.create(e);return[s+1,2*a+n,2*o+i,2*l+r]},up:function(e,n=1){const[i,r,s,a]=t.Key.create(e);return[i-n,r>>n,s>>n,a>>n]},compare:function(e,t){for(let n=0;n<e.length;++n){if(e[n]<t[n])return-1;if(e[n]>t[n])return 1}return 0},depth:function(e){return e[0]}}},4945:(e,t,n)=>{var i="undefined"!=typeof globalThis&&globalThis||"undefined"!=typeof self&&self||void 0!==n.g&&n.g,r=function(){function e(){this.fetch=!1,this.DOMException=i.DOMException}return e.prototype=i,new e}();!function(e){!function(t){var i=void 0!==e&&e||"undefined"!=typeof self&&self||void 0!==n.g&&n.g||{},r="URLSearchParams"in i,s="Symbol"in i&&"iterator"in Symbol,a="FileReader"in i&&"Blob"in i&&function(){try{return new Blob,!0}catch(e){return!1}}(),o="FormData"in i,l="ArrayBuffer"in i;if(l)var c=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"],h=ArrayBuffer.isView||function(e){return e&&c.indexOf(Object.prototype.toString.call(e))>-1};function u(e){if("string"!=typeof e&&(e=String(e)),/[^a-z0-9\-#$%&'*+.^_`|~!]/i.test(e)||""===e)throw new TypeError('Invalid character in header field name: "'+e+'"');return e.toLowerCase()}function d(e){return"string"!=typeof e&&(e=String(e)),e}function p(e){var t={next:function(){var t=e.shift();return{done:void 0===t,value:t}}};return s&&(t[Symbol.iterator]=function(){return t}),t}function f(e){this.map={},e instanceof f?e.forEach((function(e,t){this.append(t,e)}),this):Array.isArray(e)?e.forEach((function(e){if(2!=e.length)throw new TypeError("Headers constructor: expected name/value pair to be length 2, found"+e.length);this.append(e[0],e[1])}),this):e&&Object.getOwnPropertyNames(e).forEach((function(t){this.append(t,e[t])}),this)}function m(e){if(!e._noBody)return e.bodyUsed?Promise.reject(new TypeError("Already read")):void(e.bodyUsed=!0)}function g(e){return new Promise((function(t,n){e.onload=function(){t(e.result)},e.onerror=function(){n(e.error)}}))}function A(e){var t=new FileReader,n=g(t);return t.readAsArrayBuffer(e),n}function y(e){if(e.slice)return e.slice(0);var t=new Uint8Array(e.byteLength);return t.set(new Uint8Array(e)),t.buffer}function v(){return this.bodyUsed=!1,this._initBody=function(e){var t;this.bodyUsed=this.bodyUsed,this._bodyInit=e,e?"string"==typeof e?this._bodyText=e:a&&Blob.prototype.isPrototypeOf(e)?this._bodyBlob=e:o&&FormData.prototype.isPrototypeOf(e)?this._bodyFormData=e:r&&URLSearchParams.prototype.isPrototypeOf(e)?this._bodyText=e.toString():l&&a&&(t=e)&&DataView.prototype.isPrototypeOf(t)?(this._bodyArrayBuffer=y(e.buffer),this._bodyInit=new Blob([this._bodyArrayBuffer])):l&&(ArrayBuffer.prototype.isPrototypeOf(e)||h(e))?this._bodyArrayBuffer=y(e):this._bodyText=e=Object.prototype.toString.call(e):(this._noBody=!0,this._bodyText=""),this.headers.get("content-type")||("string"==typeof e?this.headers.set("content-type","text/plain;charset=UTF-8"):this._bodyBlob&&this._bodyBlob.type?this.headers.set("content-type",this._bodyBlob.type):r&&URLSearchParams.prototype.isPrototypeOf(e)&&this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"))},a&&(this.blob=function(){var e=m(this);if(e)return e;if(this._bodyBlob)return Promise.resolve(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(new Blob([this._bodyArrayBuffer]));if(this._bodyFormData)throw new Error("could not read FormData body as blob");return Promise.resolve(new Blob([this._bodyText]))}),this.arrayBuffer=function(){if(this._bodyArrayBuffer)return m(this)||(ArrayBuffer.isView(this._bodyArrayBuffer)?Promise.resolve(this._bodyArrayBuffer.buffer.slice(this._bodyArrayBuffer.byteOffset,this._bodyArrayBuffer.byteOffset+this._bodyArrayBuffer.byteLength)):Promise.resolve(this._bodyArrayBuffer));if(a)return this.blob().then(A);throw new Error("could not read as ArrayBuffer")},this.text=function(){var e,t,n,i,r,s=m(this);if(s)return s;if(this._bodyBlob)return e=this._bodyBlob,n=g(t=new FileReader),r=(i=/charset=([A-Za-z0-9_-]+)/.exec(e.type))?i[1]:"utf-8",t.readAsText(e,r),n;if(this._bodyArrayBuffer)return Promise.resolve(function(e){for(var t=new Uint8Array(e),n=new Array(t.length),i=0;i<t.length;i++)n[i]=String.fromCharCode(t[i]);return n.join("")}(this._bodyArrayBuffer));if(this._bodyFormData)throw new Error("could not read FormData body as text");return Promise.resolve(this._bodyText)},o&&(this.formData=function(){return this.text().then(E)}),this.json=function(){return this.text().then(JSON.parse)},this}f.prototype.append=function(e,t){e=u(e),t=d(t);var n=this.map[e];this.map[e]=n?n+", "+t:t},f.prototype.delete=function(e){delete this.map[u(e)]},f.prototype.get=function(e){return e=u(e),this.has(e)?this.map[e]:null},f.prototype.has=function(e){return this.map.hasOwnProperty(u(e))},f.prototype.set=function(e,t){this.map[u(e)]=d(t)},f.prototype.forEach=function(e,t){for(var n in this.map)this.map.hasOwnProperty(n)&&e.call(t,this.map[n],n,this)},f.prototype.keys=function(){var e=[];return this.forEach((function(t,n){e.push(n)})),p(e)},f.prototype.values=function(){var e=[];return this.forEach((function(t){e.push(t)})),p(e)},f.prototype.entries=function(){var e=[];return this.forEach((function(t,n){e.push([n,t])})),p(e)},s&&(f.prototype[Symbol.iterator]=f.prototype.entries);var _=["CONNECT","DELETE","GET","HEAD","OPTIONS","PATCH","POST","PUT","TRACE"];function x(e,t){if(!(this instanceof x))throw new TypeError('Please use the "new" operator, this DOM object constructor cannot be called as a function.');var n,r,s=(t=t||{}).body;if(e instanceof x){if(e.bodyUsed)throw new TypeError("Already read");this.url=e.url,this.credentials=e.credentials,t.headers||(this.headers=new f(e.headers)),this.method=e.method,this.mode=e.mode,this.signal=e.signal,s||null==e._bodyInit||(s=e._bodyInit,e.bodyUsed=!0)}else this.url=String(e);if(this.credentials=t.credentials||this.credentials||"same-origin",!t.headers&&this.headers||(this.headers=new f(t.headers)),this.method=(r=(n=t.method||this.method||"GET").toUpperCase(),_.indexOf(r)>-1?r:n),this.mode=t.mode||this.mode||null,this.signal=t.signal||this.signal||function(){if("AbortController"in i)return(new AbortController).signal}(),this.referrer=null,("GET"===this.method||"HEAD"===this.method)&&s)throw new TypeError("Body not allowed for GET or HEAD requests");if(this._initBody(s),!("GET"!==this.method&&"HEAD"!==this.method||"no-store"!==t.cache&&"no-cache"!==t.cache)){var a=/([?&])_=[^&]*/;a.test(this.url)?this.url=this.url.replace(a,"$1_="+(new Date).getTime()):this.url+=(/\?/.test(this.url)?"&":"?")+"_="+(new Date).getTime()}}function E(e){var t=new FormData;return e.trim().split("&").forEach((function(e){if(e){var n=e.split("="),i=n.shift().replace(/\+/g," "),r=n.join("=").replace(/\+/g," ");t.append(decodeURIComponent(i),decodeURIComponent(r))}})),t}function b(e,t){if(!(this instanceof b))throw new TypeError('Please use the "new" operator, this DOM object constructor cannot be called as a function.');if(t||(t={}),this.type="default",this.status=void 0===t.status?200:t.status,this.status<200||this.status>599)throw new RangeError("Failed to construct 'Response': The status provided (0) is outside the range [200, 599].");this.ok=this.status>=200&&this.status<300,this.statusText=void 0===t.statusText?"":""+t.statusText,this.headers=new f(t.headers),this.url=t.url||"",this._initBody(e)}x.prototype.clone=function(){return new x(this,{body:this._bodyInit})},v.call(x.prototype),v.call(b.prototype),b.prototype.clone=function(){return new b(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new f(this.headers),url:this.url})},b.error=function(){var e=new b(null,{status:200,statusText:""});return e.ok=!1,e.status=0,e.type="error",e};var w=[301,302,303,307,308];b.redirect=function(e,t){if(-1===w.indexOf(t))throw new RangeError("Invalid status code");return new b(null,{status:t,headers:{location:e}})},t.DOMException=i.DOMException;try{new t.DOMException}catch(e){t.DOMException=function(e,t){this.message=e,this.name=t;var n=Error(e);this.stack=n.stack},t.DOMException.prototype=Object.create(Error.prototype),t.DOMException.prototype.constructor=t.DOMException}function M(e,n){return new Promise((function(r,s){var o=new x(e,n);if(o.signal&&o.signal.aborted)return s(new t.DOMException("Aborted","AbortError"));var c=new XMLHttpRequest;function h(){c.abort()}if(c.onload=function(){var e,t,n={statusText:c.statusText,headers:(e=c.getAllResponseHeaders()||"",t=new f,e.replace(/\r?\n[\t ]+/g," ").split("\r").map((function(e){return 0===e.indexOf("\n")?e.substr(1,e.length):e})).forEach((function(e){var n=e.split(":"),i=n.shift().trim();if(i){var r=n.join(":").trim();try{t.append(i,r)}catch(e){console.warn("Response "+e.message)}}})),t)};0===o.url.indexOf("file://")&&(c.status<200||c.status>599)?n.status=200:n.status=c.status,n.url="responseURL"in c?c.responseURL:n.headers.get("X-Request-URL");var i="response"in c?c.response:c.responseText;setTimeout((function(){r(new b(i,n))}),0)},c.onerror=function(){setTimeout((function(){s(new TypeError("Network request failed"))}),0)},c.ontimeout=function(){setTimeout((function(){s(new TypeError("Network request timed out"))}),0)},c.onabort=function(){setTimeout((function(){s(new t.DOMException("Aborted","AbortError"))}),0)},c.open(o.method,function(e){try{return""===e&&i.location.href?i.location.href:e}catch(t){return e}}(o.url),!0),"include"===o.credentials?c.withCredentials=!0:"omit"===o.credentials&&(c.withCredentials=!1),"responseType"in c&&(a?c.responseType="blob":l&&(c.responseType="arraybuffer")),n&&"object"==typeof n.headers&&!(n.headers instanceof f||i.Headers&&n.headers instanceof i.Headers)){var p=[];Object.getOwnPropertyNames(n.headers).forEach((function(e){p.push(u(e)),c.setRequestHeader(e,d(n.headers[e]))})),o.headers.forEach((function(e,t){-1===p.indexOf(t)&&c.setRequestHeader(t,e)}))}else o.headers.forEach((function(e,t){c.setRequestHeader(t,e)}));o.signal&&(o.signal.addEventListener("abort",h),c.onreadystatechange=function(){4===c.readyState&&o.signal.removeEventListener("abort",h)}),c.send(void 0===o._bodyInit?null:o._bodyInit)}))}M.polyfill=!0,i.fetch||(i.fetch=M,i.Headers=f,i.Request=x,i.Response=b),t.Headers=f,t.Request=x,t.Response=b,t.fetch=M,Object.defineProperty(t,"__esModule",{value:!0})}({})}(r),r.fetch.ponyfill=!0,delete r.fetch.polyfill;var s=i.fetch?i:r;(t=s.fetch).default=s.fetch,t.fetch=s.fetch,t.Headers=s.Headers,t.Request=s.Request,t.Response=s.Response,e.exports=t},4949:function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,s){function a(e){try{l(i.next(e))}catch(e){s(e)}}function o(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,o)}l((i=i.apply(e,t||[])).next())}))},r=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.spawn=void 0;const s=r(n(7833)),a=n(4527),o=n(9278),l=n(4238),c=n(3682),h=n(2931),u=n(8215),d=s.default("threads:master:messages"),p=s.default("threads:master:spawn"),f=s.default("threads:master:thread-utils"),m="undefined"!=typeof process&&process.env.THREADS_WORKER_INIT_TIMEOUT?Number.parseInt(process.env.THREADS_WORKER_INIT_TIMEOUT,10):1e4;function g(e,t,n,i){const r=n.filter((e=>e.type===h.WorkerEventType.internalError)).map((e=>e.error));return Object.assign(e,{[c.$errors]:r,[c.$events]:n,[c.$terminate]:i,[c.$worker]:t})}t.spawn=function(e,t){return i(this,void 0,void 0,(function*(){p("Initializing new thread");const n=t&&t.timeout?t.timeout:m,r=yield function(e,t,n){return i(this,void 0,void 0,(function*(){let i;const r=new Promise(((e,r)=>{i=setTimeout((()=>r(Error(n))),t)})),s=yield Promise.race([e,r]);return clearTimeout(i),s}))}(function(e){return new Promise(((t,n)=>{const i=r=>{var s;d("Message from worker before finishing initialization:",r.data),(s=r.data)&&"init"===s.type?(e.removeEventListener("message",i),t(r.data)):(e=>e&&"uncaughtError"===e.type)(r.data)&&(e.removeEventListener("message",i),n(o.deserialize(r.data.error)))};e.addEventListener("message",i)}))}(e),n,`Timeout: Did not receive an init message from worker after ${n}ms. Make sure the worker calls expose().`),s=r.exposed,{termination:c,terminate:A}=function(e){const[t,n]=l.createPromiseWithResolver();return{terminate:()=>i(this,void 0,void 0,(function*(){f("Terminating worker"),yield e.terminate(),n()})),termination:t}}(e),y=function(e,t){return new a.Observable((n=>{const i=e=>{const t={type:h.WorkerEventType.message,data:e.data};n.next(t)},r=e=>{f("Unhandled promise rejection event in thread:",e);const t={type:h.WorkerEventType.internalError,error:Error(e.reason)};n.next(t)};e.addEventListener("message",i),e.addEventListener("unhandledrejection",r),t.then((()=>{const t={type:h.WorkerEventType.termination};e.removeEventListener("message",i),e.removeEventListener("unhandledrejection",r),n.next(t),n.complete()}))}))}(e,c);if("function"===s.type)return g(u.createProxyFunction(e),e,y,A);if("module"===s.type)return g(u.createProxyModule(e,s.methods),e,y,A);{const e=s.type;throw Error(`Worker init message states unexpected type of expose(): ${e}`)}}))}},5192:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Step=void 0,t.Step={fromIndex:function(e){if(e<0||e>=8)throw new Error(`Invalid step index: ${e}`);return[1&e?1:0,e>>1&1?1:0,e>>2&1?1:0]},list:function(){return[[0,0,0],[0,0,1],[0,1,0],[0,1,1],[1,0,0],[1,0,1],[1,1,0],[1,1,1]]}}},5234:function(e,t,n){"use strict";var i=this&&this.__createBinding||(Object.create?function(e,t,n,i){void 0===i&&(i=n);var r=Object.getOwnPropertyDescriptor(t,n);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,i,r)}:function(e,t,n,i){void 0===i&&(i=n),e[i]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&i(t,e,n);return r(t,e),t},a=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||i(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),t.Las=t.Ept=void 0,t.Ept=s(n(8962)),a(n(6564),t),t.Las=s(n(549)),a(n(876),t)},5409:e=>{"use strict";e.exports=e=>!!e&&("symbol"==typeof Symbol.observable&&"function"==typeof e[Symbol.observable]?e===e[Symbol.observable]():"function"==typeof e["@@observable"]&&e===e["@@observable"]())},5690:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Info=void 0;const i=n(876),r=n(329);t.Info={parse:function(e){const t=i.Binary.toDataView(e);if(t.byteLength!==r.infoLength)throw new Error(`Invalid COPC info VLR length (should be ${r.infoLength}): ${t.byteLength}`);const n=[t.getFloat64(0,!0),t.getFloat64(8,!0),t.getFloat64(16,!0)],s=t.getFloat64(24,!0);return{cube:[n[0]-s,n[1]-s,n[2]-s,n[0]+s,n[1]+s,n[2]+s],spacing:t.getFloat64(32,!0),rootHierarchyPage:{pageOffset:(0,i.parseBigInt)((0,i.getBigUint64)(t,40,!0)),pageLength:(0,i.parseBigInt)((0,i.getBigUint64)(t,48,!0))},gpsTimeRange:[t.getFloat64(56,!0),t.getFloat64(64,!0)]}}}},5914:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DefaultSerializer=t.extendSerializer=void 0,t.extendSerializer=function(e,t){const n=e.deserialize.bind(e),i=e.serialize.bind(e);return{deserialize:e=>t.deserialize(e,n),serialize:e=>t.serialize(e,i)}};const n=e=>Object.assign(Error(e.message),{name:e.name,stack:e.stack}),i=e=>({__error_marker:"$$error",message:e.message,name:e.name,stack:e.stack});t.DefaultSerializer={deserialize(e){return(t=e)&&"object"==typeof t&&"__error_marker"in t&&"$$error"===t.__error_marker?n(e):e;var t},serialize:e=>e instanceof Error?i(e):e}},6564:function(e,t,n){"use strict";var i=this&&this.__createBinding||(Object.create?function(e,t,n,i){void 0===i&&(i=n);var r=Object.getOwnPropertyDescriptor(t,n);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,i,r)}:function(e,t,n,i){void 0===i&&(i=n),e[i]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&i(t,e,n);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.Info=t.Hierarchy=t.Copc=t.Constants=void 0,t.Constants=s(n(329));var a=n(6601);Object.defineProperty(t,"Copc",{enumerable:!0,get:function(){return a.Copc}});var o=n(8363);Object.defineProperty(t,"Hierarchy",{enumerable:!0,get:function(){return o.Hierarchy}});var l=n(5690);Object.defineProperty(t,"Info",{enumerable:!0,get:function(){return l.Info}})},6585:e=>{var t=1e3,n=60*t,i=60*n,r=24*i,s=7*r;function a(e,t,n,i){var r=t>=1.5*n;return Math.round(e/n)+" "+i+(r?"s":"")}e.exports=function(e,o){o=o||{};var l,c,h=typeof e;if("string"===h&&e.length>0)return function(e){if(!((e=String(e)).length>100)){var a=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(e);if(a){var o=parseFloat(a[1]);switch((a[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return 315576e5*o;case"weeks":case"week":case"w":return o*s;case"days":case"day":case"d":return o*r;case"hours":case"hour":case"hrs":case"hr":case"h":return o*i;case"minutes":case"minute":case"mins":case"min":case"m":return o*n;case"seconds":case"second":case"secs":case"sec":case"s":return o*t;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return o;default:return}}}}(e);if("number"===h&&isFinite(e))return o.long?(l=e,(c=Math.abs(l))>=r?a(l,c,r,"day"):c>=i?a(l,c,i,"hour"):c>=n?a(l,c,n,"minute"):c>=t?a(l,c,t,"second"):l+" ms"):function(e){var s=Math.abs(e);return s>=r?Math.round(e/r)+"d":s>=i?Math.round(e/i)+"h":s>=n?Math.round(e/n)+"m":s>=t?Math.round(e/t)+"s":e+"ms"}(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))}},6601:function(e,t,n){"use strict";var i=this&&this.__createBinding||(Object.create?function(e,t,n,i){void 0===i&&(i=n);var r=Object.getOwnPropertyDescriptor(t,n);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,i,r)}:function(e,t,n,i){void 0===i&&(i=n),e[i]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&i(t,e,n);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.Copc=void 0;const a=s(n(549)),o=n(876),l=n(8363),c=n(5690);async function h(e,{pointDataRecordFormat:t,pointDataRecordLength:n},i,r){const s=await async function(e,{pointDataOffset:t,pointDataLength:n}){return o.Getter.create(e)(t,t+n)}(e,i),{pointCount:l}=i;return a.PointData.decompressChunk(s,{pointCount:l,pointDataRecordFormat:t,pointDataRecordLength:n},r)}t.Copc={create:async function(e){const t=o.Getter.create(e),n=t(0,65536);async function i(e,i){return i>=65536?t(e,i):(await n).slice(e,i)}const r=a.Header.parse(await i(0,a.Constants.minHeaderLength)),s=await a.Vlr.walk(i,r),l=a.Vlr.find(s,"copc",1);if(!l)throw new Error("COPC info VLR is required");const h=c.Info.parse(await a.Vlr.fetch(i,l));let u;const d=a.Vlr.find(s,"LASF_Projection",2112);d&&d.contentLength&&(u=o.Binary.toCString(await a.Vlr.fetch(i,d)),""===u&&(u=void 0));let p=[];const f=a.Vlr.find(s,"LASF_Spec",4);return f&&(p=a.ExtraBytes.parse(await a.Vlr.fetch(i,f))),{header:r,vlrs:s,info:h,wkt:u,eb:p}},loadHierarchyPage:async function(e,t){const n=o.Getter.create(e);return l.Hierarchy.load(n,t)},loadPointDataBuffer:h,loadPointDataView:async function(e,t,n,{lazPerf:i,include:r}={}){const s=await h(e,t.header,n,i);return a.View.create(s,t.header,t.eb,r)}}},6712:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Transfer=t.isTransferDescriptor=void 0;const i=n(3682);t.isTransferDescriptor=function(e){return e&&"object"==typeof e&&e[i.$transferable]},t.Transfer=function(e,t){if(!t){if(!(n=e)||"object"!=typeof n)throw Error();t=[e]}var n;return{[i.$transferable]:!0,send:e,transferables:t}}},6838:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Scale=void 0,t.Scale={apply:(e,t=1,n=0)=>(e-n)/t,unapply:(e,t=1,n=0)=>e*t+n}},6882:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getBigUint64=t.parseBigInt=void 0,t.parseBigInt=function(e){if(e>BigInt(Number.MAX_SAFE_INTEGER)||e<BigInt(-Number.MAX_SAFE_INTEGER))throw new Error(`Cannot convert bigint to number: ${e}`);return Number(e)},t.getBigUint64=function(e,t,n){if(e.getBigUint64)return e.getBigUint64(t,n);const[i,r]=n?[4,0]:[0,4],s=BigInt(e.getUint32(t+i,n)),a=BigInt(e.getUint32(t+r,n));return(s<<BigInt(32))+a}},6977:function(e,t,n){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.LazPerf=t.create=t.createLazPerf=void 0;const r=i(n(7316));t.createLazPerf=r.default,t.create=r.default,t.LazPerf={create:r.default}},7201:function(e,t,n){"use strict";var i=this&&this.__createBinding||(Object.create?function(e,t,n,i){void 0===i&&(i=n);var r=Object.getOwnPropertyDescriptor(t,n);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,i,r)}:function(e,t,n,i){void 0===i&&(i=n),e[i]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&i(t,e,n);return r(t,e),t},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.Getter=void 0;const o=a(n(4945));function l(e){return async function(t,n){if(t<0||n<0||t>n)throw new Error("Invalid range");const i=await(0,o.default)(e,{headers:{Range:`bytes=${t}-${n-1}`}}),r=await i.arrayBuffer();return new Uint8Array(r)}}function c(e){return async function(t,i){const r=await Promise.resolve().then((()=>s(n(539))));return async function(t=0,n=1/0){if(t<0||n<0||t>n)throw new Error("Invalid range");return await r.promises.access(e),async function(e){return await new Promise(((t,n)=>{const i=[];e.on("data",(e=>i.push(e))),e.on("error",n),e.on("end",(()=>t(Buffer.concat(i))))}))}(r.createReadStream(e,{start:t,end:n-1,autoClose:!0}))}(t,i)}}t.Getter={create:function(e){return"function"==typeof e?e:e.startsWith("http://")||e.startsWith("https://")?l(e):c(e)},http:l,file:c}},7316:e=>{var t,n=(t="undefined"!=typeof document&&document.currentScript?document.currentScript.src:void 0,function(e){var n,i,r=void 0!==(e=e||{})?e:{};r.ready=new Promise((function(e,t){n=e,i=t})),["_main","___getTypeName","__embind_initialize_bindings","_fflush","onRuntimeInitialized"].forEach((e=>{Object.getOwnPropertyDescriptor(r.ready,e)||Object.defineProperty(r.ready,e,{get:()=>j("You are getting "+e+" on the Promise object, instead of the instance. Use .then() to get called back with the instance, see the MODULARIZE docs in src/settings.js"),set:()=>j("You are setting "+e+" on the Promise object, instead of the instance. Use .then() to get called back with the instance, see the MODULARIZE docs in src/settings.js")})}));var s=Object.assign({},r),a=[],o="./this.program";if(r.ENVIRONMENT)throw new Error("Module.ENVIRONMENT has been deprecated. To force the environment, use the ENVIRONMENT compile-time option (for example, -sENVIRONMENT=web or -sENVIRONMENT=node)");var l="";if("undefined"!=typeof document&&document.currentScript&&(l=document.currentScript.src),t&&(l=t),l=0!==l.indexOf("blob:")?l.substr(0,l.replace(/[?#].*/,"").lastIndexOf("/")+1):"","object"!=typeof window&&"function"!=typeof importScripts)throw new Error("not compiled for this environment (did you build to HTML and try to run it not on the web, or set ENVIRONMENT to something - like node - and run it someplace else - like on the web?)");var c,h,u,d=r.print||console.log.bind(console),p=r.printErr||console.warn.bind(console);function f(e,t){Object.getOwnPropertyDescriptor(r,e)||Object.defineProperty(r,e,{configurable:!0,get:function(){j("Module."+e+" has been replaced with plain "+t+" (the initial value can be provided on Module, but after startup the value is only looked for on a local variable of that name)")}})}function m(e){return"FS_createPath"===e||"FS_createDataFile"===e||"FS_createPreloadedFile"===e||"FS_unlink"===e||"addRunDependency"===e||"FS_createLazyFile"===e||"FS_createDevice"===e||"removeRunDependency"===e}Object.assign(r,s),s=null,c="fetchSettings",Object.getOwnPropertyDescriptor(r,c)&&j("`Module."+c+"` was supplied but `"+c+"` not included in INCOMING_MODULE_JS_API"),r.arguments&&(a=r.arguments),f("arguments","arguments_"),r.thisProgram&&(o=r.thisProgram),f("thisProgram","thisProgram"),r.quit&&r.quit,f("quit","quit_"),A(void 0===r.memoryInitializerPrefixURL,"Module.memoryInitializerPrefixURL option was removed, use Module.locateFile instead"),A(void 0===r.pthreadMainPrefixURL,"Module.pthreadMainPrefixURL option was removed, use Module.locateFile instead"),A(void 0===r.cdInitializerPrefixURL,"Module.cdInitializerPrefixURL option was removed, use Module.locateFile instead"),A(void 0===r.filePackagePrefixURL,"Module.filePackagePrefixURL option was removed, use Module.locateFile instead"),A(void 0===r.read,"Module.read option was removed (modify read_ in JS)"),A(void 0===r.readAsync,"Module.readAsync option was removed (modify readAsync in JS)"),A(void 0===r.readBinary,"Module.readBinary option was removed (modify readBinary in JS)"),A(void 0===r.setWindowTitle,"Module.setWindowTitle option was removed (modify setWindowTitle in JS)"),A(void 0===r.TOTAL_MEMORY,"Module.TOTAL_MEMORY has been renamed Module.INITIAL_MEMORY"),f("read","read_"),f("readAsync","readAsync"),f("readBinary","readBinary"),f("setWindowTitle","setWindowTitle"),A(!0,"worker environment detected but not enabled at build time.  Add 'worker' to `-sENVIRONMENT` to enable."),A(!0,"node environment detected but not enabled at build time.  Add 'node' to `-sENVIRONMENT` to enable."),A(!0,"shell environment detected but not enabled at build time.  Add 'shell' to `-sENVIRONMENT` to enable."),r.wasmBinary&&(h=r.wasmBinary),f("wasmBinary","wasmBinary"),r.noExitRuntime,f("noExitRuntime","noExitRuntime"),"object"!=typeof WebAssembly&&j("no native wasm support detected");var g=!1;function A(e,t){e||j("Assertion failed"+(t?": "+t:""))}var y,v,_,x,E,b,w,M,S,C="undefined"!=typeof TextDecoder?new TextDecoder("utf8"):void 0;function T(e,t,n){for(var i=t+n,r=t;e[r]&&!(r>=i);)++r;if(r-t>16&&e.buffer&&C)return C.decode(e.subarray(t,r));for(var s="";t<r;){var a=e[t++];if(128&a){var o=63&e[t++];if(192!=(224&a)){var l=63&e[t++];if(224==(240&a)?a=(15&a)<<12|o<<6|l:(240!=(248&a)&&Z("Invalid UTF-8 leading byte 0x"+a.toString(16)+" encountered when deserializing a UTF-8 string in wasm memory to a JS string!"),a=(7&a)<<18|o<<12|l<<6|63&e[t++]),a<65536)s+=String.fromCharCode(a);else{var c=a-65536;s+=String.fromCharCode(55296|c>>10,56320|1023&c)}}else s+=String.fromCharCode((31&a)<<6|o)}else s+=String.fromCharCode(a)}return s}function I(e,t){return e?T(_,e,t):""}function R(e,t,n,i){if(!(i>0))return 0;for(var r=n,s=n+i-1,a=0;a<e.length;++a){var o=e.charCodeAt(a);if(o>=55296&&o<=57343&&(o=65536+((1023&o)<<10)|1023&e.charCodeAt(++a)),o<=127){if(n>=s)break;t[n++]=o}else if(o<=2047){if(n+1>=s)break;t[n++]=192|o>>6,t[n++]=128|63&o}else if(o<=65535){if(n+2>=s)break;t[n++]=224|o>>12,t[n++]=128|o>>6&63,t[n++]=128|63&o}else{if(n+3>=s)break;o>1114111&&Z("Invalid Unicode code point 0x"+o.toString(16)+" encountered when serializing a JS string to a UTF-8 string in wasm memory! (Valid unicode code points should be in range 0-0x10FFFF)."),t[n++]=240|o>>18,t[n++]=128|o>>12&63,t[n++]=128|o>>6&63,t[n++]=128|63&o}}return t[n]=0,n-r}function B(e){for(var t=0,n=0;n<e.length;++n){var i=e.charCodeAt(n);i<=127?t++:i<=2047?t+=2:i>=55296&&i<=57343?(t+=4,++n):t+=3}return t}function L(e){y=e,r.HEAP8=v=new Int8Array(e),r.HEAP16=x=new Int16Array(e),r.HEAP32=b=new Int32Array(e),r.HEAPU8=_=new Uint8Array(e),r.HEAPU16=E=new Uint16Array(e),r.HEAPU32=w=new Uint32Array(e),r.HEAPF32=M=new Float32Array(e),r.HEAPF64=S=new Float64Array(e)}var P=65536;r.TOTAL_STACK&&A(P===r.TOTAL_STACK,"the stack size can no longer be determined at runtime");var D,N=r.INITIAL_MEMORY||262144;function U(){if(!g){var e=xt(),t=w[e>>2],n=w[e+4>>2];34821223==t&&2310721022==n||j("Stack overflow! Stack cookie has been overwritten at 0x"+e.toString(16)+", expected hex dwords 0x89BACDFE and 0x2135467, but received 0x"+n.toString(16)+" 0x"+t.toString(16)),1668509029!==w[0]&&j("Runtime error: The application has corrupted its heap memory area (address zero)!")}}f("INITIAL_MEMORY","INITIAL_MEMORY"),A(N>=P,"INITIAL_MEMORY should be larger than TOTAL_STACK, was "+N+"! (TOTAL_STACK="+P+")"),A("undefined"!=typeof Int32Array&&"undefined"!=typeof Float64Array&&null!=Int32Array.prototype.subarray&&null!=Int32Array.prototype.set,"JS engine does not provide full typed array support"),A(!r.wasmMemory,"Use of `wasmMemory` detected.  Use -sIMPORTED_MEMORY to define wasmMemory externally"),A(262144==N,"Detected runtime INITIAL_MEMORY setting.  Use -sIMPORTED_MEMORY to define wasmMemory dynamically"),function(){var e=new Int16Array(1),t=new Int8Array(e.buffer);if(e[0]=25459,115!==t[0]||99!==t[1])throw"Runtime error: expected the system to be little-endian! (Run with -sSUPPORT_BIG_ENDIAN to bypass)"}();var O=[],F=[],k=[],Q=!1;A(Math.imul,"This browser does not support Math.imul(), build with LEGACY_VM_SUPPORT or POLYFILL_OLD_MATH_FUNCTIONS to add in a polyfill"),A(Math.fround,"This browser does not support Math.fround(), build with LEGACY_VM_SUPPORT or POLYFILL_OLD_MATH_FUNCTIONS to add in a polyfill"),A(Math.clz32,"This browser does not support Math.clz32(), build with LEGACY_VM_SUPPORT or POLYFILL_OLD_MATH_FUNCTIONS to add in a polyfill"),A(Math.trunc,"This browser does not support Math.trunc(), build with LEGACY_VM_SUPPORT or POLYFILL_OLD_MATH_FUNCTIONS to add in a polyfill");var z=0,G=null,H=null,V={};function j(e){r.onAbort&&r.onAbort(e),p(e="Aborted("+e+")"),g=!0;var t=new WebAssembly.RuntimeError(e);throw i(t),t}var q,W,Y={error:function(){j("Filesystem support (FS) was not included. The problem is that you are using files from JS, but files were not used from C/C++, so filesystem support was not auto-included. You can force-include filesystem support with -sFORCE_FILESYSTEM")},init:function(){Y.error()},createDataFile:function(){Y.error()},createPreloadedFile:function(){Y.error()},createLazyFile:function(){Y.error()},open:function(){Y.error()},mkdev:function(){Y.error()},registerDevice:function(){Y.error()},analyzePath:function(){Y.error()},loadFilesFromDB:function(){Y.error()},ErrnoError:function(){Y.error()}};function X(e){return e.startsWith("data:application/octet-stream;base64,")}function K(e,t){return function(){var n=e,i=t;return t||(i=r.asm),A(Q,"native function `"+n+"` called before runtime initialization"),i[e]||A(i[e],"exported native function `"+n+"` not found"),i[e].apply(null,arguments)}}function J(e){try{if(e==q&&h)return new Uint8Array(h);throw"both async and sync fetching of the wasm failed"}catch(e){j(e)}}function $(e){for(;e.length>0;)e.shift()(r)}function Z(e){Z.shown||(Z.shown={}),Z.shown[e]||(Z.shown[e]=1,p(e))}function ee(e){this.excPtr=e,this.ptr=e-24,this.set_type=function(e){w[this.ptr+4>>2]=e},this.get_type=function(){return w[this.ptr+4>>2]},this.set_destructor=function(e){w[this.ptr+8>>2]=e},this.get_destructor=function(){return w[this.ptr+8>>2]},this.set_refcount=function(e){b[this.ptr>>2]=e},this.set_caught=function(e){e=e?1:0,v[this.ptr+12|0]=e},this.get_caught=function(){return 0!=v[this.ptr+12|0]},this.set_rethrown=function(e){e=e?1:0,v[this.ptr+13|0]=e},this.get_rethrown=function(){return 0!=v[this.ptr+13|0]},this.init=function(e,t){this.set_adjusted_ptr(0),this.set_type(e),this.set_destructor(t),this.set_refcount(0),this.set_caught(!1),this.set_rethrown(!1)},this.add_ref=function(){var e=b[this.ptr>>2];b[this.ptr>>2]=e+1},this.release_ref=function(){var e=b[this.ptr>>2];return b[this.ptr>>2]=e-1,A(e>0),1===e},this.set_adjusted_ptr=function(e){w[this.ptr+16>>2]=e},this.get_adjusted_ptr=function(){return w[this.ptr+16>>2]},this.get_exception_ptr=function(){if(Et(this.get_type()))return w[this.excPtr>>2];var e=this.get_adjusted_ptr();return 0!==e?e:this.excPtr}}function te(e){switch(e){case 1:return 0;case 2:return 1;case 4:return 2;case 8:return 3;default:throw new TypeError("Unknown type size: "+e)}}r.FS_createDataFile=Y.createDataFile,r.FS_createPreloadedFile=Y.createPreloadedFile,X(q="laz-perf.wasm")||(W=q,q=r.locateFile?r.locateFile(W,l):l+W);var ne=void 0;function ie(e){for(var t="",n=e;_[n];)t+=ne[_[n++]];return t}var re={},se={},ae={};function oe(e){if(void 0===e)return"_unknown";var t=(e=e.replace(/[^a-zA-Z0-9_]/g,"$")).charCodeAt(0);return t>=48&&t<=57?"_"+e:e}function le(e,t){return e=oe(e),new Function("body","return function "+e+'() {\n    "use strict";    return body.apply(this, arguments);\n};\n')(t)}function ce(e,t){var n=le(t,(function(e){this.name=t,this.message=e;var n=new Error(e).stack;void 0!==n&&(this.stack=this.toString()+"\n"+n.replace(/^Error(:[^\n]*)?\n/,""))}));return n.prototype=Object.create(e.prototype),n.prototype.constructor=n,n.prototype.toString=function(){return void 0===this.message?this.name:this.name+": "+this.message},n}var he=void 0;function ue(e){throw new he(e)}var de=void 0;function pe(e){throw new de(e)}function fe(e,t,n){function i(t){var i=n(t);i.length!==e.length&&pe("Mismatched type converter count");for(var r=0;r<e.length;++r)me(e[r],i[r])}e.forEach((function(e){ae[e]=t}));var r=new Array(t.length),s=[],a=0;t.forEach(((e,t)=>{se.hasOwnProperty(e)?r[t]=se[e]:(s.push(e),re.hasOwnProperty(e)||(re[e]=[]),re[e].push((()=>{r[t]=se[e],++a===s.length&&i(r)})))})),0===s.length&&i(r)}function me(e,t,n={}){if(!("argPackAdvance"in t))throw new TypeError("registerType registeredInstance requires argPackAdvance");var i=t.name;if(e||ue('type "'+i+'" must have a positive integer typeid pointer'),se.hasOwnProperty(e)){if(n.ignoreDuplicateRegistrations)return;ue("Cannot register type '"+i+"' twice")}if(se[e]=t,delete ae[e],re.hasOwnProperty(e)){var r=re[e];delete re[e],r.forEach((e=>e()))}}function ge(e){ue(e.$$.ptrType.registeredClass.name+" instance already deleted")}var Ae=!1;function ye(e){}function ve(e){e.count.value-=1,0===e.count.value&&function(e){e.smartPtr?e.smartPtrType.rawDestructor(e.smartPtr):e.ptrType.registeredClass.rawDestructor(e.ptr)}(e)}function _e(e,t,n){if(t===n)return e;if(void 0===n.baseClass)return null;var i=_e(e,t,n.baseClass);return null===i?null:n.downcast(i)}var xe={};var Ee=[];function be(){for(;Ee.length;){var e=Ee.pop();e.$$.deleteScheduled=!1,e.delete()}}var we=void 0;var Me={};function Se(e,t){return t.ptrType&&t.ptr||pe("makeClassHandle requires ptr and ptrType"),!!t.smartPtrType!=!!t.smartPtr&&pe("Both smartPtrType and smartPtr must be specified"),t.count={value:1},Te(Object.create(e,{$$:{value:t}}))}function Ce(e){var t=this.getPointee(e);if(!t)return this.destructor(e),null;var n=function(e,t){return t=function(e,t){for(void 0===t&&ue("ptr should not be undefined");e.baseClass;)t=e.upcast(t),e=e.baseClass;return t}(e,t),Me[t]}(this.registeredClass,t);if(void 0!==n){if(0===n.$$.count.value)return n.$$.ptr=t,n.$$.smartPtr=e,n.clone();var i=n.clone();return this.destructor(e),i}function r(){return this.isSmartPointer?Se(this.registeredClass.instancePrototype,{ptrType:this.pointeeType,ptr:t,smartPtrType:this,smartPtr:e}):Se(this.registeredClass.instancePrototype,{ptrType:this,ptr:e})}var s,a=this.registeredClass.getActualType(t),o=xe[a];if(!o)return r.call(this);s=this.isConst?o.constPointerType:o.pointerType;var l=_e(t,this.registeredClass,s.registeredClass);return null===l?r.call(this):this.isSmartPointer?Se(s.registeredClass.instancePrototype,{ptrType:s,ptr:l,smartPtrType:this,smartPtr:e}):Se(s.registeredClass.instancePrototype,{ptrType:s,ptr:l})}function Te(e){return"undefined"==typeof FinalizationRegistry?(Te=e=>e,e):(Ae=new FinalizationRegistry((e=>{console.warn(e.leakWarning.stack.replace(/^Error: /,"")),ve(e.$$)})),Te=e=>{var t=e.$$;if(t.smartPtr){var n={$$:t},i=t.ptrType.registeredClass;n.leakWarning=new Error("Embind found a leaked C++ instance "+i.name+" <0x"+t.ptr.toString(16)+">.\nWe'll free it automatically in this case, but this functionality is not reliable across various environments.\nMake sure to invoke .delete() manually once you're done with the instance instead.\nOriginally allocated"),"captureStackTrace"in Error&&Error.captureStackTrace(n.leakWarning,Ce),Ae.register(e,n,e)}return e},ye=e=>Ae.unregister(e),Te(e))}function Ie(){}function Re(e,t,n){if(void 0===e[t].overloadTable){var i=e[t];e[t]=function(){return e[t].overloadTable.hasOwnProperty(arguments.length)||ue("Function '"+n+"' called with an invalid number of arguments ("+arguments.length+") - expects one of ("+e[t].overloadTable+")!"),e[t].overloadTable[arguments.length].apply(this,arguments)},e[t].overloadTable=[],e[t].overloadTable[i.argCount]=i}}function Be(e,t,n,i,r,s,a,o){this.name=e,this.constructor=t,this.instancePrototype=n,this.rawDestructor=i,this.baseClass=r,this.getActualType=s,this.upcast=a,this.downcast=o,this.pureVirtualFunctions=[]}function Le(e,t,n){for(;t!==n;)t.upcast||ue("Expected null or instance of "+n.name+", got an instance of "+t.name),e=t.upcast(e),t=t.baseClass;return e}function Pe(e,t){if(null===t)return this.isReference&&ue("null is not a valid "+this.name),0;t.$$||ue('Cannot pass "'+Ke(t)+'" as a '+this.name),t.$$.ptr||ue("Cannot pass deleted object as a pointer of type "+this.name);var n=t.$$.ptrType.registeredClass;return Le(t.$$.ptr,n,this.registeredClass)}function De(e,t){var n;if(null===t)return this.isReference&&ue("null is not a valid "+this.name),this.isSmartPointer?(n=this.rawConstructor(),null!==e&&e.push(this.rawDestructor,n),n):0;t.$$||ue('Cannot pass "'+Ke(t)+'" as a '+this.name),t.$$.ptr||ue("Cannot pass deleted object as a pointer of type "+this.name),!this.isConst&&t.$$.ptrType.isConst&&ue("Cannot convert argument of type "+(t.$$.smartPtrType?t.$$.smartPtrType.name:t.$$.ptrType.name)+" to parameter type "+this.name);var i=t.$$.ptrType.registeredClass;if(n=Le(t.$$.ptr,i,this.registeredClass),this.isSmartPointer)switch(void 0===t.$$.smartPtr&&ue("Passing raw pointer to smart pointer is illegal"),this.sharingPolicy){case 0:t.$$.smartPtrType===this?n=t.$$.smartPtr:ue("Cannot convert argument of type "+(t.$$.smartPtrType?t.$$.smartPtrType.name:t.$$.ptrType.name)+" to parameter type "+this.name);break;case 1:n=t.$$.smartPtr;break;case 2:if(t.$$.smartPtrType===this)n=t.$$.smartPtr;else{var r=t.clone();n=this.rawShare(n,Xe.toHandle((function(){r.delete()}))),null!==e&&e.push(this.rawDestructor,n)}break;default:ue("Unsupporting sharing policy")}return n}function Ne(e,t){if(null===t)return this.isReference&&ue("null is not a valid "+this.name),0;t.$$||ue('Cannot pass "'+Ke(t)+'" as a '+this.name),t.$$.ptr||ue("Cannot pass deleted object as a pointer of type "+this.name),t.$$.ptrType.isConst&&ue("Cannot convert argument of type "+t.$$.ptrType.name+" to parameter type "+this.name);var n=t.$$.ptrType.registeredClass;return Le(t.$$.ptr,n,this.registeredClass)}function Ue(e){return this.fromWireType(b[e>>2])}function Oe(e,t,n,i,r,s,a,o,l,c,h){this.name=e,this.registeredClass=t,this.isReference=n,this.isConst=i,this.isSmartPointer=r,this.pointeeType=s,this.sharingPolicy=a,this.rawGetPointee=o,this.rawConstructor=l,this.rawShare=c,this.rawDestructor=h,r||void 0!==t.baseClass?this.toWireType=De:i?(this.toWireType=Pe,this.destructorFunction=null):(this.toWireType=Ne,this.destructorFunction=null)}var Fe=[];function ke(e){var t=Fe[e];return t||(e>=Fe.length&&(Fe.length=e+1),Fe[e]=t=D.get(e)),A(D.get(e)==t,"JavaScript-side Wasm function table mirror is out of date!"),t}function Qe(e,t){var n=(e=ie(e)).includes("j")?function(e,t){A(e.includes("j")||e.includes("p"),"getDynCaller should only be called with i64 sigs");var n=[];return function(){return n.length=0,Object.assign(n,arguments),function(e,t,n){return e.includes("j")?function(e,t,n){A("dynCall_"+e in r,"bad function pointer type - no table for sig '"+e+"'"),n&&n.length?A(n.length===e.substring(1).replace(/j/g,"--").length):A(1==e.length);var i=r["dynCall_"+e];return n&&n.length?i.apply(null,[t].concat(n)):i.call(null,t)}(e,t,n):(A(ke(t),"missing table entry in dynCall: "+t),ke(t).apply(null,n))}(e,t,n)}}(e,t):ke(t);return"function"!=typeof n&&ue("unknown function pointer with signature "+e+": "+t),n}var ze=void 0;function Ge(e){var t=vt(e),n=ie(t);return yt(t),n}function He(e,t){var n=[],i={};throw t.forEach((function e(t){i[t]||se[t]||(ae[t]?ae[t].forEach(e):(n.push(t),i[t]=!0))})),new ze(e+": "+n.map(Ge).join([", "]))}function Ve(e,t){for(var n=[],i=0;i<e;i++)n.push(w[t+4*i>>2]);return n}function je(e){for(;e.length;){var t=e.pop();e.pop()(t)}}function qe(e,t,n,i,r){var s=t.length;s<2&&ue("argTypes array size mismatch! Must at least get return value and 'this' types!");for(var a=null!==t[1]&&null!==n,o=!1,l=1;l<t.length;++l)if(null!==t[l]&&void 0===t[l].destructorFunction){o=!0;break}var c="void"!==t[0].name,h="",u="";for(l=0;l<s-2;++l)h+=(0!==l?", ":"")+"arg"+l,u+=(0!==l?", ":"")+"arg"+l+"Wired";var d="return function "+oe(e)+"("+h+") {\nif (arguments.length !== "+(s-2)+") {\nthrowBindingError('function "+e+" called with ' + arguments.length + ' arguments, expected "+(s-2)+" args!');\n}\n";o&&(d+="var destructors = [];\n");var p=o?"destructors":"null",f=["throwBindingError","invoker","fn","runDestructors","retType","classParam"],m=[ue,i,r,je,t[0],t[1]];for(a&&(d+="var thisWired = classParam.toWireType("+p+", this);\n"),l=0;l<s-2;++l)d+="var arg"+l+"Wired = argType"+l+".toWireType("+p+", arg"+l+"); // "+t[l+2].name+"\n",f.push("argType"+l),m.push(t[l+2]);if(a&&(u="thisWired"+(u.length>0?", ":"")+u),d+=(c?"var rv = ":"")+"invoker(fn"+(u.length>0?", ":"")+u+");\n",o)d+="runDestructors(destructors);\n";else for(l=a?1:2;l<t.length;++l){var g=1===l?"thisWired":"arg"+(l-2)+"Wired";null!==t[l].destructorFunction&&(d+=g+"_dtor("+g+"); // "+t[l].name+"\n",f.push(g+"_dtor"),m.push(t[l].destructorFunction))}return c&&(d+="var ret = retType.fromWireType(rv);\nreturn ret;\n"),d+="}\n",f.push(d),function(e,t){if(!(e instanceof Function))throw new TypeError("new_ called with constructor type "+typeof e+" which is not a function");var n=le(e.name||"unknownFunctionName",(function(){}));n.prototype=e.prototype;var i=new n,r=e.apply(i,t);return r instanceof Object?r:i}(Function,f).apply(null,m)}var We=[],Ye=[{},{value:void 0},{value:null},{value:!0},{value:!1}];var Xe={toValue:e=>(e||ue("Cannot use deleted val. handle = "+e),Ye[e].value),toHandle:e=>{switch(e){case void 0:return 1;case null:return 2;case!0:return 3;case!1:return 4;default:var t=We.length?We.pop():Ye.length;return Ye[t]={refcount:1,value:e},t}}};function Ke(e){if(null===e)return"null";var t=typeof e;return"object"===t||"array"===t||"function"===t?e.toString():""+e}function Je(e,t){switch(t){case 2:return function(e){return this.fromWireType(M[e>>2])};case 3:return function(e){return this.fromWireType(S[e>>3])};default:throw new TypeError("Unknown float type: "+e)}}function $e(e,t,n){switch(t){case 0:return n?function(e){return v[e]}:function(e){return _[e]};case 1:return n?function(e){return x[e>>1]}:function(e){return E[e>>1]};case 2:return n?function(e){return b[e>>2]}:function(e){return w[e>>2]};default:throw new TypeError("Unknown integer type: "+e)}}var Ze="undefined"!=typeof TextDecoder?new TextDecoder("utf-16le"):void 0;function et(e,t){A(e%2==0,"Pointer passed to UTF16ToString must be aligned to two bytes!");for(var n=e,i=n>>1,r=i+t/2;!(i>=r)&&E[i];)++i;if((n=i<<1)-e>32&&Ze)return Ze.decode(_.subarray(e,n));for(var s="",a=0;!(a>=t/2);++a){var o=x[e+2*a>>1];if(0==o)break;s+=String.fromCharCode(o)}return s}function tt(e,t,n){if(A(t%2==0,"Pointer passed to stringToUTF16 must be aligned to two bytes!"),A("number"==typeof n,"stringToUTF16(str, outPtr, maxBytesToWrite) is missing the third parameter that specifies the length of the output buffer!"),void 0===n&&(n=2147483647),n<2)return 0;for(var i=t,r=(n-=2)<2*e.length?n/2:e.length,s=0;s<r;++s){var a=e.charCodeAt(s);x[t>>1]=a,t+=2}return x[t>>1]=0,t-i}function nt(e){return 2*e.length}function it(e,t){A(e%4==0,"Pointer passed to UTF32ToString must be aligned to four bytes!");for(var n=0,i="";!(n>=t/4);){var r=b[e+4*n>>2];if(0==r)break;if(++n,r>=65536){var s=r-65536;i+=String.fromCharCode(55296|s>>10,56320|1023&s)}else i+=String.fromCharCode(r)}return i}function rt(e,t,n){if(A(t%4==0,"Pointer passed to stringToUTF32 must be aligned to four bytes!"),A("number"==typeof n,"stringToUTF32(str, outPtr, maxBytesToWrite) is missing the third parameter that specifies the length of the output buffer!"),void 0===n&&(n=2147483647),n<4)return 0;for(var i=t,r=i+n-4,s=0;s<e.length;++s){var a=e.charCodeAt(s);if(a>=55296&&a<=57343&&(a=65536+((1023&a)<<10)|1023&e.charCodeAt(++s)),b[t>>2]=a,(t+=4)+4>r)break}return b[t>>2]=0,t-i}function st(e){for(var t=0,n=0;n<e.length;++n){var i=e.charCodeAt(n);i>=55296&&i<=57343&&++n,t+=4}return t}function at(e){try{return u.grow(e-y.byteLength+65535>>>16),L(u.buffer),1}catch(t){p("emscripten_realloc_buffer: Attempted to grow heap from "+y.byteLength+" bytes to "+e+" bytes, but got error: "+t)}}var ot={};function lt(){if(!lt.strings){var e={USER:"web_user",LOGNAME:"web_user",PATH:"/",PWD:"/",HOME:"/home/web_user",LANG:("object"==typeof navigator&&navigator.languages&&navigator.languages[0]||"C").replace("-","_")+".UTF-8",_:o||"./this.program"};for(var t in ot)void 0===ot[t]?delete e[t]:e[t]=ot[t];var n=[];for(var t in e)n.push(t+"="+e[t]);lt.strings=n}return lt.strings}var ct=[null,[],[]];function ht(e,t){var n=ct[e];A(n),0===t||10===t?((1===e?d:p)(T(n,0)),n.length=0):n.push(t)}function ut(e){return e%4==0&&(e%100!=0||e%400==0)}var dt=[31,29,31,30,31,30,31,31,30,31,30,31],pt=[31,28,31,30,31,30,31,31,30,31,30,31];function ft(e,t,n,i){var r=b[i+40>>2],s={tm_sec:b[i>>2],tm_min:b[i+4>>2],tm_hour:b[i+8>>2],tm_mday:b[i+12>>2],tm_mon:b[i+16>>2],tm_year:b[i+20>>2],tm_wday:b[i+24>>2],tm_yday:b[i+28>>2],tm_isdst:b[i+32>>2],tm_gmtoff:b[i+36>>2],tm_zone:r?I(r):""},a=I(n),o={"%c":"%a %b %d %H:%M:%S %Y","%D":"%m/%d/%y","%F":"%Y-%m-%d","%h":"%b","%r":"%I:%M:%S %p","%R":"%H:%M","%T":"%H:%M:%S","%x":"%m/%d/%y","%X":"%H:%M:%S","%Ec":"%c","%EC":"%C","%Ex":"%m/%d/%y","%EX":"%H:%M:%S","%Ey":"%y","%EY":"%Y","%Od":"%d","%Oe":"%e","%OH":"%H","%OI":"%I","%Om":"%m","%OM":"%M","%OS":"%S","%Ou":"%u","%OU":"%U","%OV":"%V","%Ow":"%w","%OW":"%W","%Oy":"%y"};for(var l in o)a=a.replace(new RegExp(l,"g"),o[l]);var c=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],h=["January","February","March","April","May","June","July","August","September","October","November","December"];function u(e,t,n){for(var i="number"==typeof e?e.toString():e||"";i.length<t;)i=n[0]+i;return i}function d(e,t){return u(e,t,"0")}function p(e,t){function n(e){return e<0?-1:e>0?1:0}var i;return 0===(i=n(e.getFullYear()-t.getFullYear()))&&0===(i=n(e.getMonth()-t.getMonth()))&&(i=n(e.getDate()-t.getDate())),i}function f(e){switch(e.getDay()){case 0:return new Date(e.getFullYear()-1,11,29);case 1:return e;case 2:return new Date(e.getFullYear(),0,3);case 3:return new Date(e.getFullYear(),0,2);case 4:return new Date(e.getFullYear(),0,1);case 5:return new Date(e.getFullYear()-1,11,31);case 6:return new Date(e.getFullYear()-1,11,30)}}function m(e){var t=function(e,t){for(var n=new Date(e.getTime());t>0;){var i=ut(n.getFullYear()),r=n.getMonth(),s=(i?dt:pt)[r];if(!(t>s-n.getDate()))return n.setDate(n.getDate()+t),n;t-=s-n.getDate()+1,n.setDate(1),r<11?n.setMonth(r+1):(n.setMonth(0),n.setFullYear(n.getFullYear()+1))}return n}(new Date(e.tm_year+1900,0,1),e.tm_yday),n=new Date(t.getFullYear(),0,4),i=new Date(t.getFullYear()+1,0,4),r=f(n),s=f(i);return p(r,t)<=0?p(s,t)<=0?t.getFullYear()+1:t.getFullYear():t.getFullYear()-1}var g={"%a":function(e){return c[e.tm_wday].substring(0,3)},"%A":function(e){return c[e.tm_wday]},"%b":function(e){return h[e.tm_mon].substring(0,3)},"%B":function(e){return h[e.tm_mon]},"%C":function(e){return d((e.tm_year+1900)/100|0,2)},"%d":function(e){return d(e.tm_mday,2)},"%e":function(e){return u(e.tm_mday,2," ")},"%g":function(e){return m(e).toString().substring(2)},"%G":function(e){return m(e)},"%H":function(e){return d(e.tm_hour,2)},"%I":function(e){var t=e.tm_hour;return 0==t?t=12:t>12&&(t-=12),d(t,2)},"%j":function(e){return d(e.tm_mday+function(e,t){for(var n=0,i=0;i<=t;n+=e[i++]);return n}(ut(e.tm_year+1900)?dt:pt,e.tm_mon-1),3)},"%m":function(e){return d(e.tm_mon+1,2)},"%M":function(e){return d(e.tm_min,2)},"%n":function(){return"\n"},"%p":function(e){return e.tm_hour>=0&&e.tm_hour<12?"AM":"PM"},"%S":function(e){return d(e.tm_sec,2)},"%t":function(){return"\t"},"%u":function(e){return e.tm_wday||7},"%U":function(e){var t=e.tm_yday+7-e.tm_wday;return d(Math.floor(t/7),2)},"%V":function(e){var t=Math.floor((e.tm_yday+7-(e.tm_wday+6)%7)/7);if((e.tm_wday+371-e.tm_yday-2)%7<=2&&t++,t){if(53==t){var n=(e.tm_wday+371-e.tm_yday)%7;4==n||3==n&&ut(e.tm_year)||(t=1)}}else{t=52;var i=(e.tm_wday+7-e.tm_yday-1)%7;(4==i||5==i&&ut(e.tm_year%400-1))&&t++}return d(t,2)},"%w":function(e){return e.tm_wday},"%W":function(e){var t=e.tm_yday+7-(e.tm_wday+6)%7;return d(Math.floor(t/7),2)},"%y":function(e){return(e.tm_year+1900).toString().substring(2)},"%Y":function(e){return e.tm_year+1900},"%z":function(e){var t=e.tm_gmtoff,n=t>=0;return t=(t=Math.abs(t)/60)/60*100+t%60,(n?"+":"-")+String("0000"+t).slice(-4)},"%Z":function(e){return e.tm_zone},"%%":function(){return"%"}};for(var l in a=a.replace(/%%/g,"\0\0"),g)a.includes(l)&&(a=a.replace(new RegExp(l,"g"),g[l](s)));var y,_,x,E=(_=B(y=a=a.replace(/\0\0/g,"%"))+1,R(y,x=new Array(_),0,x.length),x);return E.length>t?0:(function(e,t){A(e.length>=0,"writeArrayToMemory array must have a length (should be an array or typed array)"),v.set(e,t)}(E,e),E.length-1)}!function(){for(var e=new Array(256),t=0;t<256;++t)e[t]=String.fromCharCode(t);ne=e}(),he=r.BindingError=ce(Error,"BindingError"),de=r.InternalError=ce(Error,"InternalError"),Ie.prototype.isAliasOf=function(e){if(!(this instanceof Ie))return!1;if(!(e instanceof Ie))return!1;for(var t=this.$$.ptrType.registeredClass,n=this.$$.ptr,i=e.$$.ptrType.registeredClass,r=e.$$.ptr;t.baseClass;)n=t.upcast(n),t=t.baseClass;for(;i.baseClass;)r=i.upcast(r),i=i.baseClass;return t===i&&n===r},Ie.prototype.clone=function(){if(this.$$.ptr||ge(this),this.$$.preservePointerOnDelete)return this.$$.count.value+=1,this;var e,t=Te(Object.create(Object.getPrototypeOf(this),{$$:{value:(e=this.$$,{count:e.count,deleteScheduled:e.deleteScheduled,preservePointerOnDelete:e.preservePointerOnDelete,ptr:e.ptr,ptrType:e.ptrType,smartPtr:e.smartPtr,smartPtrType:e.smartPtrType})}}));return t.$$.count.value+=1,t.$$.deleteScheduled=!1,t},Ie.prototype.delete=function(){this.$$.ptr||ge(this),this.$$.deleteScheduled&&!this.$$.preservePointerOnDelete&&ue("Object already scheduled for deletion"),ye(this),ve(this.$$),this.$$.preservePointerOnDelete||(this.$$.smartPtr=void 0,this.$$.ptr=void 0)},Ie.prototype.isDeleted=function(){return!this.$$.ptr},Ie.prototype.deleteLater=function(){return this.$$.ptr||ge(this),this.$$.deleteScheduled&&!this.$$.preservePointerOnDelete&&ue("Object already scheduled for deletion"),Ee.push(this),1===Ee.length&&we&&we(be),this.$$.deleteScheduled=!0,this},r.getInheritedInstanceCount=function(){return Object.keys(Me).length},r.getLiveInheritedInstances=function(){var e=[];for(var t in Me)Me.hasOwnProperty(t)&&e.push(Me[t]);return e},r.flushPendingDeletes=be,r.setDelayFunction=function(e){we=e,Ee.length&&we&&we(be)},Oe.prototype.getPointee=function(e){return this.rawGetPointee&&(e=this.rawGetPointee(e)),e},Oe.prototype.destructor=function(e){this.rawDestructor&&this.rawDestructor(e)},Oe.prototype.argPackAdvance=8,Oe.prototype.readValueFromPointer=Ue,Oe.prototype.deleteObject=function(e){null!==e&&e.delete()},Oe.prototype.fromWireType=Ce,ze=r.UnboundTypeError=ce(Error,"UnboundTypeError"),r.count_emval_handles=function(){for(var e=0,t=5;t<Ye.length;++t)void 0!==Ye[t]&&++e;return e},r.get_first_emval=function(){for(var e=5;e<Ye.length;++e)if(void 0!==Ye[e])return Ye[e];return null};var mt,gt={__cxa_allocate_exception:function(e){return At(e+24)+24},__cxa_throw:function(e,t,n){throw new ee(e).init(t,n),e+" - Exception catching is disabled, this exception cannot be caught. Compile with -sNO_DISABLE_EXCEPTION_CATCHING or -sEXCEPTION_CATCHING_ALLOWED=[..] to catch."},_embind_register_bigint:function(e,t,n,i,r){},_embind_register_bool:function(e,t,n,i,r){var s=te(n);me(e,{name:t=ie(t),fromWireType:function(e){return!!e},toWireType:function(e,t){return t?i:r},argPackAdvance:8,readValueFromPointer:function(e){var i;if(1===n)i=v;else if(2===n)i=x;else{if(4!==n)throw new TypeError("Unknown boolean type size: "+t);i=b}return this.fromWireType(i[e>>s])},destructorFunction:null})},_embind_register_class:function(e,t,n,i,s,a,o,l,c,h,u,d,p){u=ie(u),a=Qe(s,a),l&&(l=Qe(o,l)),h&&(h=Qe(c,h)),p=Qe(d,p);var f=oe(u);!function(e,t,n){r.hasOwnProperty(e)?(ue("Cannot register public name '"+e+"' twice"),Re(r,e,e),r.hasOwnProperty(n)&&ue("Cannot register multiple overloads of a function with the same number of arguments ("+n+")!"),r[e].overloadTable[void 0]=t):r[e]=t}(f,(function(){He("Cannot construct "+u+" due to unbound types",[i])})),fe([e,t,n],i?[i]:[],(function(t){var n,s;t=t[0],s=i?(n=t.registeredClass).instancePrototype:Ie.prototype;var o=le(f,(function(){if(Object.getPrototypeOf(this)!==c)throw new he("Use 'new' to construct "+u);if(void 0===d.constructor_body)throw new he(u+" has no accessible constructor");var e=d.constructor_body[arguments.length];if(void 0===e)throw new he("Tried to invoke ctor of "+u+" with invalid number of parameters ("+arguments.length+") - expected ("+Object.keys(d.constructor_body).toString()+") parameters instead!");return e.apply(this,arguments)})),c=Object.create(s,{constructor:{value:o}});o.prototype=c;var d=new Be(u,o,c,p,n,a,l,h),m=new Oe(u,d,!0,!1,!1),g=new Oe(u+"*",d,!1,!1,!1),A=new Oe(u+" const*",d,!1,!0,!1);return xe[e]={pointerType:g,constPointerType:A},function(e,t,n){r.hasOwnProperty(e)||pe("Replacing nonexistant public symbol"),r[e].overloadTable,r[e]=t,r[e].argCount=n}(f,o),[m,g,A]}))},_embind_register_class_constructor:function(e,t,n,i,r,s){A(t>0);var a=Ve(t,n);r=Qe(i,r),fe([],[e],(function(e){var n="constructor "+(e=e[0]).name;if(void 0===e.registeredClass.constructor_body&&(e.registeredClass.constructor_body=[]),void 0!==e.registeredClass.constructor_body[t-1])throw new he("Cannot register multiple constructors with identical number of parameters ("+(t-1)+") for class '"+e.name+"'! Overload resolution is currently only performed using the parameter count, not actual type info!");return e.registeredClass.constructor_body[t-1]=()=>{He("Cannot construct "+e.name+" due to unbound types",a)},fe([],a,(function(i){return i.splice(1,0,null),e.registeredClass.constructor_body[t-1]=qe(n,i,null,r,s),[]})),[]}))},_embind_register_class_function:function(e,t,n,i,r,s,a,o){var l=Ve(n,i);t=ie(t),s=Qe(r,s),fe([],[e],(function(e){var i=(e=e[0]).name+"."+t;function r(){He("Cannot call "+i+" due to unbound types",l)}t.startsWith("@@")&&(t=Symbol[t.substring(2)]),o&&e.registeredClass.pureVirtualFunctions.push(t);var c=e.registeredClass.instancePrototype,h=c[t];return void 0===h||void 0===h.overloadTable&&h.className!==e.name&&h.argCount===n-2?(r.argCount=n-2,r.className=e.name,c[t]=r):(Re(c,t,i),c[t].overloadTable[n-2]=r),fe([],l,(function(r){var o=qe(i,r,e,s,a);return void 0===c[t].overloadTable?(o.argCount=n-2,c[t]=o):c[t].overloadTable[n-2]=o,[]})),[]}))},_embind_register_emval:function(e,t){me(e,{name:t=ie(t),fromWireType:function(e){var t=Xe.toValue(e);return function(e){e>4&&0==--Ye[e].refcount&&(Ye[e]=void 0,We.push(e))}(e),t},toWireType:function(e,t){return Xe.toHandle(t)},argPackAdvance:8,readValueFromPointer:Ue,destructorFunction:null})},_embind_register_float:function(e,t,n){var i=te(n);me(e,{name:t=ie(t),fromWireType:function(e){return e},toWireType:function(e,t){if("number"!=typeof t&&"boolean"!=typeof t)throw new TypeError('Cannot convert "'+Ke(t)+'" to '+this.name);return t},argPackAdvance:8,readValueFromPointer:Je(t,i),destructorFunction:null})},_embind_register_integer:function(e,t,n,i,r){t=ie(t),-1===r&&(r=4294967295);var s=te(n),a=e=>e;if(0===i){var o=32-8*n;a=e=>e<<o>>>o}var l=t.includes("unsigned"),c=(e,n)=>{if("number"!=typeof e&&"boolean"!=typeof e)throw new TypeError('Cannot convert "'+Ke(e)+'" to '+n);if(e<i||e>r)throw new TypeError('Passing a number "'+Ke(e)+'" from JS side to C/C++ side to an argument of type "'+t+'", which is outside the valid range ['+i+", "+r+"]!")};me(e,{name:t,fromWireType:a,toWireType:l?function(e,t){return c(t,this.name),t>>>0}:function(e,t){return c(t,this.name),t},argPackAdvance:8,readValueFromPointer:$e(t,s,0!==i),destructorFunction:null})},_embind_register_memory_view:function(e,t,n){var i=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array][t];function r(e){var t=w,n=t[e>>=2],r=t[e+1];return new i(y,r,n)}me(e,{name:n=ie(n),fromWireType:r,argPackAdvance:8,readValueFromPointer:r},{ignoreDuplicateRegistrations:!0})},_embind_register_std_string:function(e,t){var n="std::string"===(t=ie(t));me(e,{name:t,fromWireType:function(e){var t,i=w[e>>2],r=e+4;if(n)for(var s=r,a=0;a<=i;++a){var o=r+a;if(a==i||0==_[o]){var l=I(s,o-s);void 0===t?t=l:(t+=String.fromCharCode(0),t+=l),s=o+1}}else{var c=new Array(i);for(a=0;a<i;++a)c[a]=String.fromCharCode(_[r+a]);t=c.join("")}return yt(e),t},toWireType:function(e,t){var i;t instanceof ArrayBuffer&&(t=new Uint8Array(t));var r="string"==typeof t;r||t instanceof Uint8Array||t instanceof Uint8ClampedArray||t instanceof Int8Array||ue("Cannot pass non-string to std::string"),i=n&&r?B(t):t.length;var s,a,o,l=At(4+i+1),c=l+4;if(w[l>>2]=i,n&&r)s=t,a=c,A("number"==typeof(o=i+1),"stringToUTF8(str, outPtr, maxBytesToWrite) is missing the third parameter that specifies the length of the output buffer!"),R(s,_,a,o);else if(r)for(var h=0;h<i;++h){var u=t.charCodeAt(h);u>255&&(yt(c),ue("String has UTF-16 code units that do not fit in 8 bits")),_[c+h]=u}else for(h=0;h<i;++h)_[c+h]=t[h];return null!==e&&e.push(yt,l),l},argPackAdvance:8,readValueFromPointer:Ue,destructorFunction:function(e){yt(e)}})},_embind_register_std_wstring:function(e,t,n){var i,r,s,a,o;n=ie(n),2===t?(i=et,r=tt,a=nt,s=()=>E,o=1):4===t&&(i=it,r=rt,a=st,s=()=>w,o=2),me(e,{name:n,fromWireType:function(e){for(var n,r=w[e>>2],a=s(),l=e+4,c=0;c<=r;++c){var h=e+4+c*t;if(c==r||0==a[h>>o]){var u=i(l,h-l);void 0===n?n=u:(n+=String.fromCharCode(0),n+=u),l=h+t}}return yt(e),n},toWireType:function(e,i){"string"!=typeof i&&ue("Cannot pass non-string to C++ string type "+n);var s=a(i),l=At(4+s+t);return w[l>>2]=s>>o,r(i,l+4,s+t),null!==e&&e.push(yt,l),l},argPackAdvance:8,readValueFromPointer:Ue,destructorFunction:function(e){yt(e)}})},_embind_register_void:function(e,t){me(e,{isVoid:!0,name:t=ie(t),argPackAdvance:0,fromWireType:function(){},toWireType:function(e,t){}})},abort:function(){j("native code called abort()")},emscripten_memcpy_big:function(e,t,n){_.copyWithin(e,t,t+n)},emscripten_resize_heap:function(e){var t=_.length;A((e>>>=0)>t);var n,i=2147483648;if(e>i)return p("Cannot enlarge memory, asked to go up to "+e+" bytes, but the limit is "+i+" bytes!"),!1;for(var r=1;r<=4;r*=2){var s=t*(1+.2/r);s=Math.min(s,e+100663296);var a=Math.min(i,(n=Math.max(e,s))+(65536-n%65536)%65536);if(at(a))return!0}return p("Failed to grow the heap from "+t+" bytes to "+a+" bytes, not enough memory!"),!1},environ_get:function(e,t){var n=0;return lt().forEach((function(i,r){var s=t+n;w[e+4*r>>2]=s,function(e,t){for(var n=0;n<e.length;++n)A(e.charCodeAt(n)===(255&e.charCodeAt(n))),v[0|t++]=e.charCodeAt(n);v[0|t]=0}(i,s),n+=i.length+1})),0},environ_sizes_get:function(e,t){var n=lt();w[e>>2]=n.length;var i=0;return n.forEach((function(e){i+=e.length+1})),w[t>>2]=i,0},fd_close:function(e){j("fd_close called without SYSCALLS_REQUIRE_FILESYSTEM")},fd_seek:function(e,t,n,i,r){return 70},fd_write:function(e,t,n,i){for(var r=0,s=0;s<n;s++){var a=w[t>>2],o=w[t+4>>2];t+=8;for(var l=0;l<o;l++)ht(e,_[a+l]);r+=o}return w[i>>2]=r,0},strftime_l:function(e,t,n,i){return ft(e,t,n,i)}},At=(function(){var e,t={env:gt,wasi_snapshot_preview1:gt};function n(e,t){var n,i=e.exports;r.asm=i,A(u=r.asm.memory,"memory not found in wasm exports"),L(u.buffer),A(D=r.asm.__indirect_function_table,"table not found in wasm exports"),n=r.asm.__wasm_call_ctors,F.unshift(n),function(e){if(z--,r.monitorRunDependencies&&r.monitorRunDependencies(z),e?(A(V[e]),delete V[e]):p("warning: run dependency removed without ID"),0==z&&(null!==G&&(clearInterval(G),G=null),H)){var t=H;H=null,t()}}("wasm-instantiate")}e="wasm-instantiate",z++,r.monitorRunDependencies&&r.monitorRunDependencies(z),e?(A(!V[e]),V[e]=1,null===G&&"undefined"!=typeof setInterval&&(G=setInterval((function(){if(g)return clearInterval(G),void(G=null);var e=!1;for(var t in V)e||(e=!0,p("still waiting on run dependencies:")),p("dependency: "+t);e&&p("(end of list)")}),1e4))):p("warning: run dependency added without ID");var s=r;function a(e){A(r===s,"the Module object should not be replaced during async compilation - perhaps the order of HTML elements is wrong?"),s=null,n(e.instance)}function o(e){return(h||"function"!=typeof fetch?Promise.resolve().then((function(){return J(q)})):fetch(q,{credentials:"same-origin"}).then((function(e){if(!e.ok)throw"failed to load wasm binary file at '"+q+"'";return e.arrayBuffer()})).catch((function(){return J(q)}))).then((function(e){return WebAssembly.instantiate(e,t)})).then((function(e){return e})).then(e,(function(e){p("failed to asynchronously prepare wasm: "+e),q.startsWith("file://")&&p("warning: Loading from a file URI ("+q+") is not supported in most browsers. See https://emscripten.org/docs/getting_started/FAQ.html#how-do-i-run-a-local-webserver-for-testing-why-does-my-program-stall-in-downloading-or-preparing"),j(e)}))}if(r.instantiateWasm)try{return r.instantiateWasm(t,n)}catch(e){return p("Module.instantiateWasm callback failed with error: "+e),!1}(h||"function"!=typeof WebAssembly.instantiateStreaming||X(q)||"function"!=typeof fetch?o(a):fetch(q,{credentials:"same-origin"}).then((function(e){return WebAssembly.instantiateStreaming(e,t).then(a,(function(e){return p("wasm streaming compile failed: "+e),p("falling back to ArrayBuffer instantiation"),o(a)}))}))).catch(i)}(),r.___wasm_call_ctors=K("__wasm_call_ctors"),r._malloc=K("malloc")),yt=r._free=K("free"),vt=r.___getTypeName=K("__getTypeName"),_t=(r.__embind_initialize_bindings=K("_embind_initialize_bindings"),r.___errno_location=K("__errno_location"),r._fflush=K("fflush"),r._emscripten_stack_init=function(){return(_t=r._emscripten_stack_init=r.asm.emscripten_stack_init).apply(null,arguments)}),xt=(r._emscripten_stack_get_free=function(){return(r._emscripten_stack_get_free=r.asm.emscripten_stack_get_free).apply(null,arguments)},r._emscripten_stack_get_base=function(){return(r._emscripten_stack_get_base=r.asm.emscripten_stack_get_base).apply(null,arguments)},r._emscripten_stack_get_end=function(){return(xt=r._emscripten_stack_get_end=r.asm.emscripten_stack_get_end).apply(null,arguments)}),Et=(r.stackSave=K("stackSave"),r.stackRestore=K("stackRestore"),r.stackAlloc=K("stackAlloc"),r.___cxa_is_pointer_type=K("__cxa_is_pointer_type"));function bt(e){function t(){mt||(mt=!0,r.calledRun=!0,g||(A(!Q),Q=!0,U(),$(F),n(r),r.onRuntimeInitialized&&r.onRuntimeInitialized(),A(!r._main,'compiled without a main, but one is present. if you added it from JS, use Module["onRuntimeInitialized"]'),function(){if(U(),r.postRun)for("function"==typeof r.postRun&&(r.postRun=[r.postRun]);r.postRun.length;)e=r.postRun.shift(),k.unshift(e);var e;$(k)}()))}var i;e=e||a,z>0||(_t(),A(!(3&(i=xt()))),w[i>>2]=34821223,w[i+4>>2]=2310721022,w[0]=1668509029,function(){if(r.preRun)for("function"==typeof r.preRun&&(r.preRun=[r.preRun]);r.preRun.length;)e=r.preRun.shift(),O.unshift(e);var e;$(O)}(),z>0||(r.setStatus?(r.setStatus("Running..."),setTimeout((function(){setTimeout((function(){r.setStatus("")}),1),t()}),1)):t(),U()))}if(r.dynCall_viijii=K("dynCall_viijii"),r.dynCall_ji=K("dynCall_ji"),r.dynCall_jiji=K("dynCall_jiji"),r.dynCall_iiiiij=K("dynCall_iiiiij"),r.dynCall_iiiiijj=K("dynCall_iiiiijj"),r.dynCall_iiiiiijj=K("dynCall_iiiiiijj"),["run","UTF8ArrayToString","UTF8ToString","stringToUTF8Array","stringToUTF8","lengthBytesUTF8","addOnPreRun","addOnInit","addOnPreMain","addOnExit","addOnPostRun","addRunDependency","removeRunDependency","FS_createFolder","FS_createPath","FS_createDataFile","FS_createPreloadedFile","FS_createLazyFile","FS_createLink","FS_createDevice","FS_unlink","getLEB","getFunctionTables","alignFunctionTables","registerFunctions","prettyPrint","getCompilerSetting","print","printErr","callMain","abort","keepRuntimeAlive","wasmMemory","stackAlloc","stackSave","stackRestore","getTempRet0","setTempRet0","writeStackCookie","checkStackCookie","ptrToString","zeroMemory","stringToNewUTF8","exitJS","getHeapMax","emscripten_realloc_buffer","ENV","ERRNO_CODES","ERRNO_MESSAGES","setErrNo","inetPton4","inetNtop4","inetPton6","inetNtop6","readSockaddr","writeSockaddr","DNS","getHostByName","Protocols","Sockets","getRandomDevice","warnOnce","traverseStack","UNWIND_CACHE","convertPCtoSourceLocation","readAsmConstArgsArray","readAsmConstArgs","mainThreadEM_ASM","jstoi_q","jstoi_s","getExecutableName","listenOnce","autoResumeAudioContext","dynCallLegacy","getDynCaller","dynCall","handleException","runtimeKeepalivePush","runtimeKeepalivePop","callUserCallback","maybeExit","safeSetTimeout","asmjsMangle","asyncLoad","alignMemory","mmapAlloc","writeI53ToI64","writeI53ToI64Clamped","writeI53ToI64Signaling","writeI53ToU64Clamped","writeI53ToU64Signaling","readI53FromI64","readI53FromU64","convertI32PairToI53","convertI32PairToI53Checked","convertU32PairToI53","getCFunc","ccall","cwrap","uleb128Encode","sigToWasmTypes","convertJsFunctionToWasm","freeTableIndexes","functionsInTableMap","getEmptyTableSlot","updateTableMap","addFunction","removeFunction","reallyNegative","unSign","strLen","reSign","formatString","setValue","getValue","PATH","PATH_FS","intArrayFromString","intArrayToString","AsciiToString","stringToAscii","UTF16Decoder","UTF16ToString","stringToUTF16","lengthBytesUTF16","UTF32ToString","stringToUTF32","lengthBytesUTF32","allocateUTF8","allocateUTF8OnStack","writeStringToMemory","writeArrayToMemory","writeAsciiToMemory","SYSCALLS","getSocketFromFD","getSocketAddress","JSEvents","registerKeyEventCallback","specialHTMLTargets","maybeCStringToJsString","findEventTarget","findCanvasEventTarget","getBoundingClientRect","fillMouseEventData","registerMouseEventCallback","registerWheelEventCallback","registerUiEventCallback","registerFocusEventCallback","fillDeviceOrientationEventData","registerDeviceOrientationEventCallback","fillDeviceMotionEventData","registerDeviceMotionEventCallback","screenOrientation","fillOrientationChangeEventData","registerOrientationChangeEventCallback","fillFullscreenChangeEventData","registerFullscreenChangeEventCallback","JSEvents_requestFullscreen","JSEvents_resizeCanvasForFullscreen","registerRestoreOldStyle","hideEverythingExceptGivenElement","restoreHiddenElements","setLetterbox","currentFullscreenStrategy","restoreOldWindowedStyle","softFullscreenResizeWebGLRenderTarget","doRequestFullscreen","fillPointerlockChangeEventData","registerPointerlockChangeEventCallback","registerPointerlockErrorEventCallback","requestPointerLock","fillVisibilityChangeEventData","registerVisibilityChangeEventCallback","registerTouchEventCallback","fillGamepadEventData","registerGamepadEventCallback","registerBeforeUnloadEventCallback","fillBatteryEventData","battery","registerBatteryEventCallback","setCanvasElementSize","getCanvasElementSize","demangle","demangleAll","jsStackTrace","stackTrace","ExitStatus","getEnvStrings","checkWasiClock","flush_NO_FILESYSTEM","dlopenMissingError","setImmediateWrapped","clearImmediateWrapped","polyfillSetImmediate","uncaughtExceptionCount","exceptionLast","exceptionCaught","ExceptionInfo","exception_addRef","exception_decRef","Browser","setMainLoop","wget","FS","MEMFS","TTY","PIPEFS","SOCKFS","_setNetworkCallback","tempFixedLengthArray","miniTempWebGLFloatBuffers","heapObjectForWebGLType","heapAccessShiftForWebGLHeap","GL","emscriptenWebGLGet","computeUnpackAlignedImageSize","emscriptenWebGLGetTexPixelData","emscriptenWebGLGetUniform","webglGetUniformLocation","webglPrepareUniformLocationsBeforeFirstUse","webglGetLeftBracePos","emscriptenWebGLGetVertexAttrib","writeGLArray","AL","SDL_unicode","SDL_ttfContext","SDL_audio","SDL","SDL_gfx","GLUT","EGL","GLFW_Window","GLFW","GLEW","IDBStore","runAndAbortIfError","ALLOC_NORMAL","ALLOC_STACK","allocate","InternalError","BindingError","UnboundTypeError","PureVirtualError","init_embind","throwInternalError","throwBindingError","throwUnboundTypeError","ensureOverloadTable","exposePublicSymbol","replacePublicSymbol","extendError","createNamedFunction","embindRepr","registeredInstances","getBasestPointer","registerInheritedInstance","unregisterInheritedInstance","getInheritedInstance","getInheritedInstanceCount","getLiveInheritedInstances","registeredTypes","awaitingDependencies","typeDependencies","registeredPointers","registerType","whenDependentTypesAreResolved","embind_charCodes","embind_init_charCodes","readLatin1String","getTypeName","heap32VectorToArray","requireRegisteredType","getShiftFromSize","integerReadValueFromPointer","enumReadValueFromPointer","floatReadValueFromPointer","simpleReadValueFromPointer","runDestructors","new_","craftInvokerFunction","embind__requireFunction","tupleRegistrations","structRegistrations","genericPointerToWireType","constNoSmartPtrRawPointerToWireType","nonConstNoSmartPtrRawPointerToWireType","init_RegisteredPointer","RegisteredPointer","RegisteredPointer_getPointee","RegisteredPointer_destructor","RegisteredPointer_deleteObject","RegisteredPointer_fromWireType","runDestructor","releaseClassHandle","finalizationRegistry","detachFinalizer_deps","detachFinalizer","attachFinalizer","makeClassHandle","init_ClassHandle","ClassHandle","ClassHandle_isAliasOf","throwInstanceAlreadyDeleted","ClassHandle_clone","ClassHandle_delete","deletionQueue","ClassHandle_isDeleted","ClassHandle_deleteLater","flushPendingDeletes","delayFunction","setDelayFunction","RegisteredClass","shallowCopyInternalPointer","downcastPointer","upcastPointer","validateThis","char_0","char_9","makeLegalFunctionName","emval_handle_array","emval_free_list","emval_symbols","init_emval","count_emval_handles","get_first_emval","getStringOrSymbol","Emval","emval_newers","craftEmvalAllocator","emval_get_global","emval_lookupTypes","emval_allocateDestructors","emval_methodCallers","emval_addMethodCaller","emval_registeredMethods"].forEach((function(e){Object.getOwnPropertyDescriptor(r,e)||Object.defineProperty(r,e,{configurable:!0,get:function(){var t="'"+e+"' was not exported. add it to EXPORTED_RUNTIME_METHODS (see the FAQ)";m(e)&&(t+=". Alternatively, forcing filesystem support (-sFORCE_FILESYSTEM) can export this for you"),j(t)}})})),["ptrToString","zeroMemory","stringToNewUTF8","exitJS","setErrNo","inetPton4","inetNtop4","inetPton6","inetNtop6","readSockaddr","writeSockaddr","getHostByName","getRandomDevice","traverseStack","convertPCtoSourceLocation","readAsmConstArgs","mainThreadEM_ASM","jstoi_q","jstoi_s","listenOnce","autoResumeAudioContext","runtimeKeepalivePush","runtimeKeepalivePop","callUserCallback","maybeExit","safeSetTimeout","asmjsMangle","asyncLoad","alignMemory","mmapAlloc","writeI53ToI64","writeI53ToI64Clamped","writeI53ToI64Signaling","writeI53ToU64Clamped","writeI53ToU64Signaling","readI53FromI64","readI53FromU64","convertI32PairToI53","convertU32PairToI53","reallyNegative","unSign","strLen","reSign","formatString","getSocketFromFD","getSocketAddress","registerKeyEventCallback","maybeCStringToJsString","findEventTarget","findCanvasEventTarget","getBoundingClientRect","fillMouseEventData","registerMouseEventCallback","registerWheelEventCallback","registerUiEventCallback","registerFocusEventCallback","fillDeviceOrientationEventData","registerDeviceOrientationEventCallback","fillDeviceMotionEventData","registerDeviceMotionEventCallback","screenOrientation","fillOrientationChangeEventData","registerOrientationChangeEventCallback","fillFullscreenChangeEventData","registerFullscreenChangeEventCallback","JSEvents_requestFullscreen","JSEvents_resizeCanvasForFullscreen","registerRestoreOldStyle","hideEverythingExceptGivenElement","restoreHiddenElements","setLetterbox","softFullscreenResizeWebGLRenderTarget","doRequestFullscreen","fillPointerlockChangeEventData","registerPointerlockChangeEventCallback","registerPointerlockErrorEventCallback","requestPointerLock","fillVisibilityChangeEventData","registerVisibilityChangeEventCallback","registerTouchEventCallback","fillGamepadEventData","registerGamepadEventCallback","registerBeforeUnloadEventCallback","fillBatteryEventData","battery","registerBatteryEventCallback","setCanvasElementSize","getCanvasElementSize","checkWasiClock","setImmediateWrapped","clearImmediateWrapped","polyfillSetImmediate","exception_addRef","exception_decRef","setMainLoop","_setNetworkCallback","heapObjectForWebGLType","heapAccessShiftForWebGLHeap","emscriptenWebGLGet","computeUnpackAlignedImageSize","emscriptenWebGLGetTexPixelData","emscriptenWebGLGetUniform","webglGetUniformLocation","webglPrepareUniformLocationsBeforeFirstUse","webglGetLeftBracePos","emscriptenWebGLGetVertexAttrib","writeGLArray","SDL_unicode","SDL_ttfContext","SDL_audio","GLFW_Window","runAndAbortIfError","registerInheritedInstance","unregisterInheritedInstance","requireRegisteredType","enumReadValueFromPointer","validateThis","getStringOrSymbol","craftEmvalAllocator","emval_get_global","emval_lookupTypes","emval_allocateDestructors","emval_addMethodCaller"].forEach((function(e){"undefined"==typeof globalThis||Object.getOwnPropertyDescriptor(globalThis,e)||Object.defineProperty(globalThis,e,{configurable:!0,get:function(){var t="`"+e+"` is a library symbol and not included by default; add it to your library.js __deps or to DEFAULT_LIBRARY_FUNCS_TO_INCLUDE on the command line";m(e)&&(t+=". Alternatively, forcing filesystem support (-sFORCE_FILESYSTEM) can export this for you"),Z(t)}})})),H=function e(){mt||bt(),mt||(H=e)},r.preInit)for("function"==typeof r.preInit&&(r.preInit=[r.preInit]);r.preInit.length>0;)r.preInit.pop()();return bt(),e.ready});e.exports=n},7709:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.allSettled=void 0,t.allSettled=function(e){return Promise.all(e.map((e=>{const t=e=>({status:"fulfilled",value:e}),n=e=>({status:"rejected",reason:e}),i=Promise.resolve(e);try{return i.then(t,n)}catch(e){return Promise.reject(e)}})))}},7833:(e,t,n)=>{t.formatArgs=function(t){if(t[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+t[0]+(this.useColors?"%c ":" ")+"+"+e.exports.humanize(this.diff),!this.useColors)return;const n="color: "+this.color;t.splice(1,0,n,"color: inherit");let i=0,r=0;t[0].replace(/%[a-zA-Z%]/g,(e=>{"%%"!==e&&(i++,"%c"===e&&(r=i))})),t.splice(r,0,n)},t.save=function(e){try{e?t.storage.setItem("debug",e):t.storage.removeItem("debug")}catch(e){}},t.load=function(){let e;try{e=t.storage.getItem("debug")}catch(e){}return!e&&"undefined"!=typeof process&&"env"in process&&(e=process.env.DEBUG),e},t.useColors=function(){if("undefined"!=typeof window&&window.process&&("renderer"===window.process.type||window.process.__nwjs))return!0;if("undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let e;return"undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&(e=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(e[1],10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},t.storage=function(){try{return localStorage}catch(e){}}(),t.destroy=(()=>{let e=!1;return()=>{e||(e=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],t.log=console.debug||console.log||(()=>{}),e.exports=n(736)(t);const{formatters:i}=e.exports;i.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}},7952:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.formatGuid=t.parsePoint=void 0;const i=n(876);t.parsePoint=function(e){const t=i.Binary.toDataView(e);if(24!==t.byteLength)throw new Error(`Invalid tuple buffer length: ${t.byteLength}`);return[t.getFloat64(0,!0),t.getFloat64(8,!0),t.getFloat64(16,!0)]},t.formatGuid=function(e){const t=i.Binary.toDataView(e);if(16!==t.byteLength)throw new Error(`Invalid GUID buffer length: ${t.byteLength}`);let n="";for(let e=0;e<t.byteLength;e+=4)n+=t.getUint32(e,!0).toString(16).padStart(8,"0");return[n.slice(0,8),n.slice(8,12),n.slice(12,16),n.slice(16,32)].join("-")}},8148:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.View=void 0;const i=n(876),r=n(1652),s=n(1677);t.View={create:function(e,t,n=[],a){let o=s.Extractor.create(t,n);if(a){const e=new Set([...a]);o=Object.entries(o).reduce(((t,[n,i])=>(e.has(n)&&(t[n]=i),t)),{})}const l=r.Dimensions.create(o,n),c=i.Binary.toDataView(e),h=t.pointDataRecordLength;if(c.byteLength%h!=0)throw new Error(`Invalid buffer length (${c.byteLength}) for point length ${h}`);const u=c.byteLength/t.pointDataRecordLength;return{pointCount:u,dimensions:l,getter:function(e){const t=o[e];if(!t)throw new Error(`No extractor for dimension: ${e}`);return function(e){if(e>=u)throw new RangeError(`View index (${e}) out of range: ${u}`);return t(c,e)}}}}}},8215:function(e,t,n){"use strict";var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.createProxyModule=t.createProxyFunction=void 0;const r=i(n(7833)),s=n(4527),a=n(9278),o=n(1898),l=n(6712),c=n(2781),h=r.default("threads:master:messages");let u=1;function d(e,t){return(...n)=>{const i=u++,{args:r,transferables:d}=function(e){if(0===e.length)return{args:[],transferables:[]};const t=[],n=[];for(const i of e)l.isTransferDescriptor(i)?(t.push(a.serialize(i.send)),n.push(...i.transferables)):t.push(a.serialize(i));return{args:t,transferables:0===n.length?n:(i=n,Array.from(new Set(i)))};var i}(n),p={type:c.MasterMessageType.run,uid:i,method:t,args:r};h("Sending command to run function to worker:",p);try{e.postMessage(p,d)}catch(e){return o.ObservablePromise.from(Promise.reject(e))}return o.ObservablePromise.from(s.multicast(function(e,t){return new s.Observable((n=>{let i;const r=s=>{var o;if(h("Message from worker:",s.data),s.data&&s.data.uid===t)if((o=s.data)&&o.type===c.WorkerMessageType.running)i=s.data.resultType;else if((e=>e&&e.type===c.WorkerMessageType.result)(s.data))"promise"===i?(void 0!==s.data.payload&&n.next(a.deserialize(s.data.payload)),n.complete(),e.removeEventListener("message",r)):(s.data.payload&&n.next(a.deserialize(s.data.payload)),s.data.complete&&(n.complete(),e.removeEventListener("message",r)));else if((e=>e&&e.type===c.WorkerMessageType.error)(s.data)){const t=a.deserialize(s.data.error);n.error(t),e.removeEventListener("message",r)}};return e.addEventListener("message",r),()=>{if("observable"===i||!i){const n={type:c.MasterMessageType.cancel,uid:t};e.postMessage(n)}e.removeEventListener("message",r)}}))}(e,i)))}}t.createProxyFunction=d,t.createProxyModule=function(e,t){const n={};for(const i of t)n[i]=d(e,i);return n}},8300:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.evlrHeaderLength=t.vlrHeaderLength=t.minHeaderLength=void 0,t.minHeaderLength=375,t.vlrHeaderLength=54,t.evlrHeaderLength=60},8363:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Hierarchy=void 0;const i=n(876),r=n(329);function s(e){const t=i.Binary.toDataView(e);if(t.byteLength%r.hierarchyItemLength!=0)throw new Error(`Invalid hierarchy page length: ${t.byteLength}`);const n={},s={};for(let e=0;e<t.byteLength;e+=r.hierarchyItemLength){const r=t.getInt32(e+0,!0),a=t.getInt32(e+4,!0),o=t.getInt32(e+8,!0),l=t.getInt32(e+12,!0),c=(0,i.parseBigInt)((0,i.getBigUint64)(t,e+16,!0)),h=t.getInt32(e+24,!0),u=t.getInt32(e+28,!0),d=i.Key.toString([r,a,o,l]);if(u<-1)throw new Error(`Invalid hierarchy point count at key: ${d}`);-1===u?s[d]={pageOffset:c,pageLength:h}:n[d]={pointCount:u,pointDataOffset:c,pointDataLength:h}}return{nodes:n,pages:s}}t.Hierarchy={parse:s,load:async function(e,t){const n=i.Getter.create(e);return s(await n(t.pageOffset,t.pageOffset+t.pageLength))}}},8916:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Header=void 0;const i=n(876),r=n(8300),s=n(7952);function a(e){const t=i.Binary.toDataView(e),n=[];for(let e=0;e<120;e+=8)n.push((0,i.getBigUint64)(t,e,!0));return n.map((e=>(0,i.parseBigInt)(e)))}function o(e){const t=i.Binary.toDataView(e),n=[];for(let e=0;e<20;e+=4)n.push(t.getUint32(e,!0));return n}t.Header={parse:function(e){if(e.byteLength<r.minHeaderLength)throw new Error(`Invalid header: must be at least ${r.minHeaderLength} bytes`);const t=i.Binary.toDataView(e),n=i.Binary.toCString(e.slice(0,4));if("LASF"!==n)throw new Error(`Invalid file signature: ${n}`);const l=t.getUint8(24),c=t.getUint8(25);if(1!==l||2!==c&&4!==c)throw new Error(`Invalid version (only 1.2 and 1.4 supported): ${l}.${c}`);const h={fileSignature:n,fileSourceId:t.getUint16(4,!0),globalEncoding:t.getUint16(6,!0),projectId:(0,s.formatGuid)(e.slice(8,24)),majorVersion:l,minorVersion:c,systemIdentifier:i.Binary.toCString(e.slice(26,58)),generatingSoftware:i.Binary.toCString(e.slice(58,90)),fileCreationDayOfYear:t.getUint16(90,!0),fileCreationYear:t.getUint16(92,!0),headerLength:t.getUint16(94,!0),pointDataOffset:t.getUint32(96,!0),vlrCount:t.getUint32(100,!0),pointDataRecordFormat:15&t.getUint8(104),pointDataRecordLength:t.getUint16(105,!0),pointCount:t.getUint32(107,!0),pointCountByReturn:o(e.slice(111,131)),scale:(0,s.parsePoint)(e.slice(131,155)),offset:(0,s.parsePoint)(e.slice(155,179)),min:[t.getFloat64(187,!0),t.getFloat64(203,!0),t.getFloat64(219,!0)],max:[t.getFloat64(179,!0),t.getFloat64(195,!0),t.getFloat64(211,!0)],waveformDataOffset:0,evlrOffset:0,evlrCount:0};return 2==c?h:{...h,pointCount:(0,i.parseBigInt)((0,i.getBigUint64)(t,247,!0)),pointCountByReturn:a(e.slice(255,375)),waveformDataOffset:(0,i.parseBigInt)((0,i.getBigUint64)(t,227,!0)),evlrOffset:(0,i.parseBigInt)((0,i.getBigUint64)(t,235,!0)),evlrCount:t.getUint32(243,!0)}}}},8962:function(e,t,n){"use strict";var i=this&&this.__createBinding||(Object.create?function(e,t,n,i){void 0===i&&(i=n);var r=Object.getOwnPropertyDescriptor(t,n);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,i,r)}:function(e,t,n,i){void 0===i&&(i=n),e[i]=t[n]}),r=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||i(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),r(n(9545),t),r(n(4305),t)},9278:(e,t,n)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.serialize=t.deserialize=t.registerSerializer=void 0;const i=n(5914);let r=i.DefaultSerializer;t.registerSerializer=function(e){r=i.extendSerializer(r,e)},t.deserialize=function(e){return r.deserialize(e)},t.serialize=function(e){return r.serialize(e)}},9459:(e,t)=>{"use strict";function n([e,t,n,i,r,s]){return[e+(i-e)/2,t+(r-t)/2,n+(s-n)/2]}function i(e){return e[3]-e[0]}function r(e){return e[4]-e[1]}function s(e){return e[5]-e[2]}function a(e,[t,i,r]){const[s,a,o,l,c,h]=e,[u,d,p]=n(e);return[t?u:s,i?d:a,r?p:o,t?l:u,i?c:d,r?h:p]}Object.defineProperty(t,"__esModule",{value:!0}),t.Bounds=void 0,t.Bounds={min:function(e){return[e[0],e[1],e[2]]},max:function(e){return[e[3],e[4],e[5]]},mid:n,width:i,depth:r,height:s,cube:function(e){const t=n(e),a=Math.max(i(e),r(e),s(e))/2;return[t[0]-a,t[1]-a,t[2]-a,t[0]+a,t[1]+a,t[2]+a]},step:a,stepTo:function(e,[t,n,i,r]){for(let s=t-1;s>=0;--s)e=a(e,[n>>s&1,i>>s&1,r>>s&1]);return e},intersection:function(e,t){return[Math.max(e[0],t[0]),Math.max(e[1],t[1]),Math.max(e[2],t[2]),Math.min(e[3],t[3]),Math.min(e[4],t[4]),Math.min(e[5],t[5])]}}},9545:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})}},t={};function n(i){var r=t[i];if(void 0!==r)return r.exports;var s=t[i]={exports:{}};return e[i].call(s.exports,s,s.exports,n),s.exports}n.m=e,n.d=(e,t)=>{for(var i in t)n.o(t,i)&&!n.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},n.u=e=>({343:"itowns_potree2worker",899:"itowns_lasparser"}[e]+".js"),n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.p="/assets/js/",n.b=document.baseURI||self.location.href,(()=>{"use strict";var e={};n.r(e),n.d(e,{gO9:()=>u,EZo:()=>c,wrO:()=>se,lGu:()=>R,$p8:()=>uc,tz3:()=>Ql,hsX:()=>s,$Kf:()=>Lo,UtB:()=>Ic,NRn:()=>ln,THS:()=>Di,LoY:()=>ji,i7d:()=>ur,GOR:()=>gl,tcD:()=>Al,ghU:()=>G,Q1f:()=>Ci,ppV:()=>Ot,iOZ:()=>fl,c5h:()=>ml,FvD:()=>pl,bCz:()=>h,dYF:()=>nn,GYF:()=>Po,h_9:()=>Vl,VCu:()=>us,ZyN:()=>hc,$EB:()=>a,hdd:()=>_,wn6:()=>E,U3G:()=>P,O9p:()=>jn,Qev:()=>At,Y9S:()=>Yl,qtW:()=>Oi,RQf:()=>ee,hB5:()=>r,PPD:()=>Sr,Gwm:()=>D,YJl:()=>oo,ix0:()=>te,Kzg:()=>pc,uWO:()=>Oo,ZLX:()=>jo,eB$:()=>vo,eHs:()=>xo,lGw:()=>Tl,ljd:()=>We,PJ3:()=>Ye,brA:()=>B,xSv:()=>L,N1A:()=>el,mrM:()=>qo,FCc:()=>sl,DXC:()=>rl,k6q:()=>W,$_I:()=>X,kRr:()=>Y,Zr2:()=>tt,VxR:()=>nt,aHM:()=>jl,r6x:()=>dc,KPJ:()=>Hl,CMB:()=>le,Kzv:()=>oe,kBv:()=>i,imn:()=>Ri,cj9:()=>Tt,k_V:()=>Cc,dwI:()=>Rt,kn4:()=>Nn,eaF:()=>ir,V9B:()=>Bi,G_z:()=>bl,tXL:()=>El,uSd:()=>xl,_4j:()=>_l,kTW:()=>H,hxR:()=>V,Cfg:()=>q,pHI:()=>j,eHc:()=>I,XIg:()=>o,jf0:()=>Ze,NTi:()=>l,bw0:()=>U,Hit:()=>Nl,B69:()=>li,qad:()=>m,Nt7:()=>x,aEY:()=>b,OuU:()=>v,LiQ:()=>A,qUd:()=>Gr,ubm:()=>mr,Zcv:()=>br,bdM:()=>Ir,HiM:()=>lc,ONl:()=>ul,BH$:()=>al,Nwf:()=>_c,PTz:()=>rn,MBL:()=>Ol,GWd:()=>ae,qa3:()=>Ce,Qrf:()=>Be,Fn:()=>ze,KDk:()=>Se,HXV:()=>Ee,Nz6:()=>Ae,BXX:()=>ve,W9U:()=>He,CVz:()=>we,Riy:()=>Me,k6Q:()=>_e,paN:()=>pe,D$Q:()=>vl,RlV:()=>Dn,tBo:()=>bc,VT0:()=>ue,GJx:()=>z,nST:()=>p,er$:()=>et,KLL:()=>it,Z58:()=>yo,vxI:()=>Rr,BKk:()=>hr,EAD:()=>Uo,I46:()=>Bo,iyt:()=>Sn,Gu$:()=>yl,YHV:()=>Sc,nCl:()=>ic,ie2:()=>y,hgQ:()=>w,f4X:()=>g,FXf:()=>d,gPd:()=>Jt,Tap:()=>Kl,Vwu:()=>io,lMl:()=>Ei,rYR:()=>$e,O49:()=>Je,RJ4:()=>Ke,nc$:()=>xc,fCn:()=>Br,LlO:()=>cr,OUM:()=>K,Wew:()=>ne,gJ2:()=>ie,cHt:()=>J,I9Y:()=>It,Pq0:()=>sn,IUQ:()=>$t,RiT:()=>kl,nWS:()=>en,JeP:()=>Ao,ojh:()=>f});const t="170",i={LEFT:0,MIDDLE:1,RIGHT:2,ROTATE:0,DOLLY:1,PAN:2},r=0,s=1,a=2,o=0,l=1,c=2,h=5,u=100,d=101,p=102,f=200,m=201,g=202,A=203,y=204,v=205,_=206,x=207,E=208,b=209,w=210,M=211,S=212,C=213,T=214,I=0,R=1,B=2,L=3,P=4,D=5,N=6,U=7,O="attached",F=301,k=302,Q=306,z=1e3,G=1001,H=1002,V=1003,j=1004,q=1005,W=1006,Y=1007,X=1008,K=1009,J=1012,$=1013,Z=1014,ee=1015,te=1016,ne=1017,ie=1018,re=1020,se=1021,ae=1023,oe=1024,le=1025,ce=1026,he=1027,ue=1028,de=1029,pe=1030,fe=1031,me=1033,ge=33776,Ae=33777,ye=33778,ve=33779,_e=35840,xe=35841,Ee=35842,be=35843,we=36196,Me=37492,Se=37496,Ce=37808,Te=37809,Ie=37810,Re=37811,Be=37812,Le=37813,Pe=37814,De=37815,Ne=37816,Ue=37817,Oe=37818,Fe=37819,ke=37820,Qe=37821,ze=36492,Ge=36494,He=36495,Ve=36284,je=36285,qe=36286,We=2300,Ye=2301,Xe=2302,Ke=0,Je=1,$e=2,Ze="",et="srgb",tt="srgb-linear",nt="linear",it="srgb",rt=7680,st=512,at=513,ot=514,lt=515,ct=516,ht=517,ut=518,dt=519,pt=35044,ft="300 es",mt=2e3,gt=2001;class At{addEventListener(e,t){void 0===this._listeners&&(this._listeners={});const n=this._listeners;void 0===n[e]&&(n[e]=[]),-1===n[e].indexOf(t)&&n[e].push(t)}hasEventListener(e,t){if(void 0===this._listeners)return!1;const n=this._listeners;return void 0!==n[e]&&-1!==n[e].indexOf(t)}removeEventListener(e,t){if(void 0===this._listeners)return;const n=this._listeners[e];if(void 0!==n){const e=n.indexOf(t);-1!==e&&n.splice(e,1)}}dispatchEvent(e){if(void 0===this._listeners)return;const t=this._listeners[e.type];if(void 0!==t){e.target=this;const n=t.slice(0);for(let t=0,i=n.length;t<i;t++)n[t].call(this,e);e.target=null}}}const yt=["00","01","02","03","04","05","06","07","08","09","0a","0b","0c","0d","0e","0f","10","11","12","13","14","15","16","17","18","19","1a","1b","1c","1d","1e","1f","20","21","22","23","24","25","26","27","28","29","2a","2b","2c","2d","2e","2f","30","31","32","33","34","35","36","37","38","39","3a","3b","3c","3d","3e","3f","40","41","42","43","44","45","46","47","48","49","4a","4b","4c","4d","4e","4f","50","51","52","53","54","55","56","57","58","59","5a","5b","5c","5d","5e","5f","60","61","62","63","64","65","66","67","68","69","6a","6b","6c","6d","6e","6f","70","71","72","73","74","75","76","77","78","79","7a","7b","7c","7d","7e","7f","80","81","82","83","84","85","86","87","88","89","8a","8b","8c","8d","8e","8f","90","91","92","93","94","95","96","97","98","99","9a","9b","9c","9d","9e","9f","a0","a1","a2","a3","a4","a5","a6","a7","a8","a9","aa","ab","ac","ad","ae","af","b0","b1","b2","b3","b4","b5","b6","b7","b8","b9","ba","bb","bc","bd","be","bf","c0","c1","c2","c3","c4","c5","c6","c7","c8","c9","ca","cb","cc","cd","ce","cf","d0","d1","d2","d3","d4","d5","d6","d7","d8","d9","da","db","dc","dd","de","df","e0","e1","e2","e3","e4","e5","e6","e7","e8","e9","ea","eb","ec","ed","ee","ef","f0","f1","f2","f3","f4","f5","f6","f7","f8","f9","fa","fb","fc","fd","fe","ff"];let vt=1234567;const _t=Math.PI/180,xt=180/Math.PI;function Et(){const e=4294967295*Math.random()|0,t=4294967295*Math.random()|0,n=4294967295*Math.random()|0,i=4294967295*Math.random()|0;return(yt[255&e]+yt[e>>8&255]+yt[e>>16&255]+yt[e>>24&255]+"-"+yt[255&t]+yt[t>>8&255]+"-"+yt[t>>16&15|64]+yt[t>>24&255]+"-"+yt[63&n|128]+yt[n>>8&255]+"-"+yt[n>>16&255]+yt[n>>24&255]+yt[255&i]+yt[i>>8&255]+yt[i>>16&255]+yt[i>>24&255]).toLowerCase()}function bt(e,t,n){return Math.max(t,Math.min(n,e))}function wt(e,t){return(e%t+t)%t}function Mt(e,t,n){return(1-n)*e+n*t}function St(e,t){switch(t.constructor){case Float32Array:return e;case Uint32Array:return e/4294967295;case Uint16Array:return e/65535;case Uint8Array:return e/255;case Int32Array:return Math.max(e/2147483647,-1);case Int16Array:return Math.max(e/32767,-1);case Int8Array:return Math.max(e/127,-1);default:throw new Error("Invalid component type.")}}function Ct(e,t){switch(t.constructor){case Float32Array:return e;case Uint32Array:return Math.round(4294967295*e);case Uint16Array:return Math.round(65535*e);case Uint8Array:return Math.round(255*e);case Int32Array:return Math.round(2147483647*e);case Int16Array:return Math.round(32767*e);case Int8Array:return Math.round(127*e);default:throw new Error("Invalid component type.")}}const Tt={DEG2RAD:_t,RAD2DEG:xt,generateUUID:Et,clamp:bt,euclideanModulo:wt,mapLinear:function(e,t,n,i,r){return i+(e-t)*(r-i)/(n-t)},inverseLerp:function(e,t,n){return e!==t?(n-e)/(t-e):0},lerp:Mt,damp:function(e,t,n,i){return Mt(e,t,1-Math.exp(-n*i))},pingpong:function(e,t=1){return t-Math.abs(wt(e,2*t)-t)},smoothstep:function(e,t,n){return e<=t?0:e>=n?1:(e=(e-t)/(n-t))*e*(3-2*e)},smootherstep:function(e,t,n){return e<=t?0:e>=n?1:(e=(e-t)/(n-t))*e*e*(e*(6*e-15)+10)},randInt:function(e,t){return e+Math.floor(Math.random()*(t-e+1))},randFloat:function(e,t){return e+Math.random()*(t-e)},randFloatSpread:function(e){return e*(.5-Math.random())},seededRandom:function(e){void 0!==e&&(vt=e);let t=vt+=1831565813;return t=Math.imul(t^t>>>15,1|t),t^=t+Math.imul(t^t>>>7,61|t),((t^t>>>14)>>>0)/4294967296},degToRad:function(e){return e*_t},radToDeg:function(e){return e*xt},isPowerOfTwo:function(e){return!(e&e-1)&&0!==e},ceilPowerOfTwo:function(e){return Math.pow(2,Math.ceil(Math.log(e)/Math.LN2))},floorPowerOfTwo:function(e){return Math.pow(2,Math.floor(Math.log(e)/Math.LN2))},setQuaternionFromProperEuler:function(e,t,n,i,r){const s=Math.cos,a=Math.sin,o=s(n/2),l=a(n/2),c=s((t+i)/2),h=a((t+i)/2),u=s((t-i)/2),d=a((t-i)/2),p=s((i-t)/2),f=a((i-t)/2);switch(r){case"XYX":e.set(o*h,l*u,l*d,o*c);break;case"YZY":e.set(l*d,o*h,l*u,o*c);break;case"ZXZ":e.set(l*u,l*d,o*h,o*c);break;case"XZX":e.set(o*h,l*f,l*p,o*c);break;case"YXY":e.set(l*p,o*h,l*f,o*c);break;case"ZYZ":e.set(l*f,l*p,o*h,o*c);break;default:console.warn("THREE.MathUtils: .setQuaternionFromProperEuler() encountered an unknown order: "+r)}},normalize:Ct,denormalize:St};class It{constructor(e=0,t=0){It.prototype.isVector2=!0,this.x=e,this.y=t}get width(){return this.x}set width(e){this.x=e}get height(){return this.y}set height(e){this.y=e}set(e,t){return this.x=e,this.y=t,this}setScalar(e){return this.x=e,this.y=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y)}copy(e){return this.x=e.x,this.y=e.y,this}add(e){return this.x+=e.x,this.y+=e.y,this}addScalar(e){return this.x+=e,this.y+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this}subScalar(e){return this.x-=e,this.y-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this}multiply(e){return this.x*=e.x,this.y*=e.y,this}multiplyScalar(e){return this.x*=e,this.y*=e,this}divide(e){return this.x/=e.x,this.y/=e.y,this}divideScalar(e){return this.multiplyScalar(1/e)}applyMatrix3(e){const t=this.x,n=this.y,i=e.elements;return this.x=i[0]*t+i[3]*n+i[6],this.y=i[1]*t+i[4]*n+i[7],this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this}clamp(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this}clampScalar(e,t){return this.x=Math.max(e,Math.min(t,this.x)),this.y=Math.max(e,Math.min(t,this.y)),this}clampLength(e,t){const n=this.length();return this.divideScalar(n||1).multiplyScalar(Math.max(e,Math.min(t,n)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(e){return this.x*e.x+this.y*e.y}cross(e){return this.x*e.y-this.y*e.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}angleTo(e){const t=Math.sqrt(this.lengthSq()*e.lengthSq());if(0===t)return Math.PI/2;const n=this.dot(e)/t;return Math.acos(bt(n,-1,1))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,n=this.y-e.y;return t*t+n*n}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this}lerpVectors(e,t,n){return this.x=e.x+(t.x-e.x)*n,this.y=e.y+(t.y-e.y)*n,this}equals(e){return e.x===this.x&&e.y===this.y}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e}fromBufferAttribute(e,t){return this.x=e.getX(t),this.y=e.getY(t),this}rotateAround(e,t){const n=Math.cos(t),i=Math.sin(t),r=this.x-e.x,s=this.y-e.y;return this.x=r*n-s*i+e.x,this.y=r*i+s*n+e.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y}}class Rt{constructor(e,t,n,i,r,s,a,o,l){Rt.prototype.isMatrix3=!0,this.elements=[1,0,0,0,1,0,0,0,1],void 0!==e&&this.set(e,t,n,i,r,s,a,o,l)}set(e,t,n,i,r,s,a,o,l){const c=this.elements;return c[0]=e,c[1]=i,c[2]=a,c[3]=t,c[4]=r,c[5]=o,c[6]=n,c[7]=s,c[8]=l,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copy(e){const t=this.elements,n=e.elements;return t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t[4]=n[4],t[5]=n[5],t[6]=n[6],t[7]=n[7],t[8]=n[8],this}extractBasis(e,t,n){return e.setFromMatrix3Column(this,0),t.setFromMatrix3Column(this,1),n.setFromMatrix3Column(this,2),this}setFromMatrix4(e){const t=e.elements;return this.set(t[0],t[4],t[8],t[1],t[5],t[9],t[2],t[6],t[10]),this}multiply(e){return this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,t){const n=e.elements,i=t.elements,r=this.elements,s=n[0],a=n[3],o=n[6],l=n[1],c=n[4],h=n[7],u=n[2],d=n[5],p=n[8],f=i[0],m=i[3],g=i[6],A=i[1],y=i[4],v=i[7],_=i[2],x=i[5],E=i[8];return r[0]=s*f+a*A+o*_,r[3]=s*m+a*y+o*x,r[6]=s*g+a*v+o*E,r[1]=l*f+c*A+h*_,r[4]=l*m+c*y+h*x,r[7]=l*g+c*v+h*E,r[2]=u*f+d*A+p*_,r[5]=u*m+d*y+p*x,r[8]=u*g+d*v+p*E,this}multiplyScalar(e){const t=this.elements;return t[0]*=e,t[3]*=e,t[6]*=e,t[1]*=e,t[4]*=e,t[7]*=e,t[2]*=e,t[5]*=e,t[8]*=e,this}determinant(){const e=this.elements,t=e[0],n=e[1],i=e[2],r=e[3],s=e[4],a=e[5],o=e[6],l=e[7],c=e[8];return t*s*c-t*a*l-n*r*c+n*a*o+i*r*l-i*s*o}invert(){const e=this.elements,t=e[0],n=e[1],i=e[2],r=e[3],s=e[4],a=e[5],o=e[6],l=e[7],c=e[8],h=c*s-a*l,u=a*o-c*r,d=l*r-s*o,p=t*h+n*u+i*d;if(0===p)return this.set(0,0,0,0,0,0,0,0,0);const f=1/p;return e[0]=h*f,e[1]=(i*l-c*n)*f,e[2]=(a*n-i*s)*f,e[3]=u*f,e[4]=(c*t-i*o)*f,e[5]=(i*r-a*t)*f,e[6]=d*f,e[7]=(n*o-l*t)*f,e[8]=(s*t-n*r)*f,this}transpose(){let e;const t=this.elements;return e=t[1],t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this}getNormalMatrix(e){return this.setFromMatrix4(e).invert().transpose()}transposeIntoArray(e){const t=this.elements;return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],this}setUvTransform(e,t,n,i,r,s,a){const o=Math.cos(r),l=Math.sin(r);return this.set(n*o,n*l,-n*(o*s+l*a)+s+e,-i*l,i*o,-i*(-l*s+o*a)+a+t,0,0,1),this}scale(e,t){return this.premultiply(Bt.makeScale(e,t)),this}rotate(e){return this.premultiply(Bt.makeRotation(-e)),this}translate(e,t){return this.premultiply(Bt.makeTranslation(e,t)),this}makeTranslation(e,t){return e.isVector2?this.set(1,0,e.x,0,1,e.y,0,0,1):this.set(1,0,e,0,1,t,0,0,1),this}makeRotation(e){const t=Math.cos(e),n=Math.sin(e);return this.set(t,-n,0,n,t,0,0,0,1),this}makeScale(e,t){return this.set(e,0,0,0,t,0,0,0,1),this}equals(e){const t=this.elements,n=e.elements;for(let e=0;e<9;e++)if(t[e]!==n[e])return!1;return!0}fromArray(e,t=0){for(let n=0;n<9;n++)this.elements[n]=e[n+t];return this}toArray(e=[],t=0){const n=this.elements;return e[t]=n[0],e[t+1]=n[1],e[t+2]=n[2],e[t+3]=n[3],e[t+4]=n[4],e[t+5]=n[5],e[t+6]=n[6],e[t+7]=n[7],e[t+8]=n[8],e}clone(){return(new this.constructor).fromArray(this.elements)}}const Bt=new Rt;function Lt(e){for(let t=e.length-1;t>=0;--t)if(e[t]>=65535)return!0;return!1}function Pt(e){return document.createElementNS("http://www.w3.org/1999/xhtml",e)}function Dt(){const e=Pt("canvas");return e.style.display="block",e}Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array;const Nt={};function Ut(e){e in Nt||(Nt[e]=!0,console.warn(e))}const Ot={enabled:!0,workingColorSpace:tt,spaces:{},convert:function(e,t,n){return!1!==this.enabled&&t!==n&&t&&n?(this.spaces[t].transfer===it&&(e.r=Ft(e.r),e.g=Ft(e.g),e.b=Ft(e.b)),this.spaces[t].primaries!==this.spaces[n].primaries&&(e.applyMatrix3(this.spaces[t].toXYZ),e.applyMatrix3(this.spaces[n].fromXYZ)),this.spaces[n].transfer===it&&(e.r=kt(e.r),e.g=kt(e.g),e.b=kt(e.b)),e):e},fromWorkingColorSpace:function(e,t){return this.convert(e,this.workingColorSpace,t)},toWorkingColorSpace:function(e,t){return this.convert(e,t,this.workingColorSpace)},getPrimaries:function(e){return this.spaces[e].primaries},getTransfer:function(e){return e===Ze?nt:this.spaces[e].transfer},getLuminanceCoefficients:function(e,t=this.workingColorSpace){return e.fromArray(this.spaces[t].luminanceCoefficients)},define:function(e){Object.assign(this.spaces,e)},_getMatrix:function(e,t,n){return e.copy(this.spaces[t].toXYZ).multiply(this.spaces[n].fromXYZ)},_getDrawingBufferColorSpace:function(e){return this.spaces[e].outputColorSpaceConfig.drawingBufferColorSpace},_getUnpackColorSpace:function(e=this.workingColorSpace){return this.spaces[e].workingColorSpaceConfig.unpackColorSpace}};function Ft(e){return e<.04045?.0773993808*e:Math.pow(.9478672986*e+.0521327014,2.4)}function kt(e){return e<.0031308?12.92*e:1.055*Math.pow(e,.41666)-.055}const Qt=[.64,.33,.3,.6,.15,.06],zt=[.2126,.7152,.0722],Gt=[.3127,.329],Ht=(new Rt).set(.4123908,.3575843,.1804808,.212639,.7151687,.0721923,.0193308,.1191948,.9505322),Vt=(new Rt).set(3.2409699,-1.5373832,-.4986108,-.9692436,1.8759675,.0415551,.0556301,-.203977,1.0569715);let jt;Ot.define({[tt]:{primaries:Qt,whitePoint:Gt,transfer:nt,toXYZ:Ht,fromXYZ:Vt,luminanceCoefficients:zt,workingColorSpaceConfig:{unpackColorSpace:et},outputColorSpaceConfig:{drawingBufferColorSpace:et}},[et]:{primaries:Qt,whitePoint:Gt,transfer:it,toXYZ:Ht,fromXYZ:Vt,luminanceCoefficients:zt,outputColorSpaceConfig:{drawingBufferColorSpace:et}}});class qt{static getDataURL(e){if(/^data:/i.test(e.src))return e.src;if("undefined"==typeof HTMLCanvasElement)return e.src;let t;if(e instanceof HTMLCanvasElement)t=e;else{void 0===jt&&(jt=Pt("canvas")),jt.width=e.width,jt.height=e.height;const n=jt.getContext("2d");e instanceof ImageData?n.putImageData(e,0,0):n.drawImage(e,0,0,e.width,e.height),t=jt}return t.width>2048||t.height>2048?(console.warn("THREE.ImageUtils.getDataURL: Image converted to jpg for performance reasons",e),t.toDataURL("image/jpeg",.6)):t.toDataURL("image/png")}static sRGBToLinear(e){if("undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap){const t=Pt("canvas");t.width=e.width,t.height=e.height;const n=t.getContext("2d");n.drawImage(e,0,0,e.width,e.height);const i=n.getImageData(0,0,e.width,e.height),r=i.data;for(let e=0;e<r.length;e++)r[e]=255*Ft(r[e]/255);return n.putImageData(i,0,0),t}if(e.data){const t=e.data.slice(0);for(let e=0;e<t.length;e++)t instanceof Uint8Array||t instanceof Uint8ClampedArray?t[e]=Math.floor(255*Ft(t[e]/255)):t[e]=Ft(t[e]);return{data:t,width:e.width,height:e.height}}return console.warn("THREE.ImageUtils.sRGBToLinear(): Unsupported image type. No color space conversion applied."),e}}let Wt=0;class Yt{constructor(e=null){this.isSource=!0,Object.defineProperty(this,"id",{value:Wt++}),this.uuid=Et(),this.data=e,this.dataReady=!0,this.version=0}set needsUpdate(e){!0===e&&this.version++}toJSON(e){const t=void 0===e||"string"==typeof e;if(!t&&void 0!==e.images[this.uuid])return e.images[this.uuid];const n={uuid:this.uuid,url:""},i=this.data;if(null!==i){let e;if(Array.isArray(i)){e=[];for(let t=0,n=i.length;t<n;t++)i[t].isDataTexture?e.push(Xt(i[t].image)):e.push(Xt(i[t]))}else e=Xt(i);n.url=e}return t||(e.images[this.uuid]=n),n}}function Xt(e){return"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap?qt.getDataURL(e):e.data?{data:Array.from(e.data),width:e.width,height:e.height,type:e.data.constructor.name}:(console.warn("THREE.Texture: Unable to serialize Texture."),{})}let Kt=0;class Jt extends At{constructor(e=Jt.DEFAULT_IMAGE,t=Jt.DEFAULT_MAPPING,n=G,i=G,r=W,s=X,a=ae,o=K,l=Jt.DEFAULT_ANISOTROPY,c=Ze){super(),this.isTexture=!0,Object.defineProperty(this,"id",{value:Kt++}),this.uuid=Et(),this.name="",this.source=new Yt(e),this.mipmaps=[],this.mapping=t,this.channel=0,this.wrapS=n,this.wrapT=i,this.magFilter=r,this.minFilter=s,this.anisotropy=l,this.format=a,this.internalFormat=null,this.type=o,this.offset=new It(0,0),this.repeat=new It(1,1),this.center=new It(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new Rt,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.colorSpace=c,this.userData={},this.version=0,this.onUpdate=null,this.isRenderTargetTexture=!1,this.pmremVersion=0}get image(){return this.source.data}set image(e=null){this.source.data=e}updateMatrix(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)}clone(){return(new this.constructor).copy(this)}copy(e){return this.name=e.name,this.source=e.source,this.mipmaps=e.mipmaps.slice(0),this.mapping=e.mapping,this.channel=e.channel,this.wrapS=e.wrapS,this.wrapT=e.wrapT,this.magFilter=e.magFilter,this.minFilter=e.minFilter,this.anisotropy=e.anisotropy,this.format=e.format,this.internalFormat=e.internalFormat,this.type=e.type,this.offset.copy(e.offset),this.repeat.copy(e.repeat),this.center.copy(e.center),this.rotation=e.rotation,this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrix.copy(e.matrix),this.generateMipmaps=e.generateMipmaps,this.premultiplyAlpha=e.premultiplyAlpha,this.flipY=e.flipY,this.unpackAlignment=e.unpackAlignment,this.colorSpace=e.colorSpace,this.userData=JSON.parse(JSON.stringify(e.userData)),this.needsUpdate=!0,this}toJSON(e){const t=void 0===e||"string"==typeof e;if(!t&&void 0!==e.textures[this.uuid])return e.textures[this.uuid];const n={metadata:{version:4.6,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,image:this.source.toJSON(e).uuid,mapping:this.mapping,channel:this.channel,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,internalFormat:this.internalFormat,type:this.type,colorSpace:this.colorSpace,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY,generateMipmaps:this.generateMipmaps,premultiplyAlpha:this.premultiplyAlpha,unpackAlignment:this.unpackAlignment};return Object.keys(this.userData).length>0&&(n.userData=this.userData),t||(e.textures[this.uuid]=n),n}dispose(){this.dispatchEvent({type:"dispose"})}transformUv(e){if(300!==this.mapping)return e;if(e.applyMatrix3(this.matrix),e.x<0||e.x>1)switch(this.wrapS){case z:e.x=e.x-Math.floor(e.x);break;case G:e.x=e.x<0?0:1;break;case H:1===Math.abs(Math.floor(e.x)%2)?e.x=Math.ceil(e.x)-e.x:e.x=e.x-Math.floor(e.x)}if(e.y<0||e.y>1)switch(this.wrapT){case z:e.y=e.y-Math.floor(e.y);break;case G:e.y=e.y<0?0:1;break;case H:1===Math.abs(Math.floor(e.y)%2)?e.y=Math.ceil(e.y)-e.y:e.y=e.y-Math.floor(e.y)}return this.flipY&&(e.y=1-e.y),e}set needsUpdate(e){!0===e&&(this.version++,this.source.needsUpdate=!0)}set needsPMREMUpdate(e){!0===e&&this.pmremVersion++}}Jt.DEFAULT_IMAGE=null,Jt.DEFAULT_MAPPING=300,Jt.DEFAULT_ANISOTROPY=1;class $t{constructor(e=0,t=0,n=0,i=1){$t.prototype.isVector4=!0,this.x=e,this.y=t,this.z=n,this.w=i}get width(){return this.z}set width(e){this.z=e}get height(){return this.w}set height(e){this.w=e}set(e,t,n,i){return this.x=e,this.y=t,this.z=n,this.w=i,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this.w=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setW(e){return this.w=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;case 3:this.w=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z,this.w)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=void 0!==e.w?e.w:1,this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this.w+=e.w*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this.w-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this}applyMatrix4(e){const t=this.x,n=this.y,i=this.z,r=this.w,s=e.elements;return this.x=s[0]*t+s[4]*n+s[8]*i+s[12]*r,this.y=s[1]*t+s[5]*n+s[9]*i+s[13]*r,this.z=s[2]*t+s[6]*n+s[10]*i+s[14]*r,this.w=s[3]*t+s[7]*n+s[11]*i+s[15]*r,this}divide(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this.w/=e.w,this}divideScalar(e){return this.multiplyScalar(1/e)}setAxisAngleFromQuaternion(e){this.w=2*Math.acos(e.w);const t=Math.sqrt(1-e.w*e.w);return t<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=e.x/t,this.y=e.y/t,this.z=e.z/t),this}setAxisAngleFromRotationMatrix(e){let t,n,i,r;const s=.01,a=.1,o=e.elements,l=o[0],c=o[4],h=o[8],u=o[1],d=o[5],p=o[9],f=o[2],m=o[6],g=o[10];if(Math.abs(c-u)<s&&Math.abs(h-f)<s&&Math.abs(p-m)<s){if(Math.abs(c+u)<a&&Math.abs(h+f)<a&&Math.abs(p+m)<a&&Math.abs(l+d+g-3)<a)return this.set(1,0,0,0),this;t=Math.PI;const e=(l+1)/2,o=(d+1)/2,A=(g+1)/2,y=(c+u)/4,v=(h+f)/4,_=(p+m)/4;return e>o&&e>A?e<s?(n=0,i=.707106781,r=.707106781):(n=Math.sqrt(e),i=y/n,r=v/n):o>A?o<s?(n=.707106781,i=0,r=.707106781):(i=Math.sqrt(o),n=y/i,r=_/i):A<s?(n=.707106781,i=.707106781,r=0):(r=Math.sqrt(A),n=v/r,i=_/r),this.set(n,i,r,t),this}let A=Math.sqrt((m-p)*(m-p)+(h-f)*(h-f)+(u-c)*(u-c));return Math.abs(A)<.001&&(A=1),this.x=(m-p)/A,this.y=(h-f)/A,this.z=(u-c)/A,this.w=Math.acos((l+d+g-1)/2),this}setFromMatrixPosition(e){const t=e.elements;return this.x=t[12],this.y=t[13],this.z=t[14],this.w=t[15],this}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this.w=Math.min(this.w,e.w),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this.w=Math.max(this.w,e.w),this}clamp(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this.w=Math.max(e.w,Math.min(t.w,this.w)),this}clampScalar(e,t){return this.x=Math.max(e,Math.min(t,this.x)),this.y=Math.max(e,Math.min(t,this.y)),this.z=Math.max(e,Math.min(t,this.z)),this.w=Math.max(e,Math.min(t,this.w)),this}clampLength(e,t){const n=this.length();return this.divideScalar(n||1).multiplyScalar(Math.max(e,Math.min(t,n)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this.w=Math.trunc(this.w),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this.w+=(e.w-this.w)*t,this}lerpVectors(e,t,n){return this.x=e.x+(t.x-e.x)*n,this.y=e.y+(t.y-e.y)*n,this.z=e.z+(t.z-e.z)*n,this.w=e.w+(t.w-e.w)*n,this}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.w===this.w}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,e}fromBufferAttribute(e,t){return this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this.w=e.getW(t),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this.w=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z,yield this.w}}class Zt extends At{constructor(e=1,t=1,n={}){super(),this.isRenderTarget=!0,this.width=e,this.height=t,this.depth=1,this.scissor=new $t(0,0,e,t),this.scissorTest=!1,this.viewport=new $t(0,0,e,t);const i={width:e,height:t,depth:1};n=Object.assign({generateMipmaps:!1,internalFormat:null,minFilter:W,depthBuffer:!0,stencilBuffer:!1,resolveDepthBuffer:!0,resolveStencilBuffer:!0,depthTexture:null,samples:0,count:1},n);const r=new Jt(i,n.mapping,n.wrapS,n.wrapT,n.magFilter,n.minFilter,n.format,n.type,n.anisotropy,n.colorSpace);r.flipY=!1,r.generateMipmaps=n.generateMipmaps,r.internalFormat=n.internalFormat,this.textures=[];const s=n.count;for(let e=0;e<s;e++)this.textures[e]=r.clone(),this.textures[e].isRenderTargetTexture=!0;this.depthBuffer=n.depthBuffer,this.stencilBuffer=n.stencilBuffer,this.resolveDepthBuffer=n.resolveDepthBuffer,this.resolveStencilBuffer=n.resolveStencilBuffer,this.depthTexture=n.depthTexture,this.samples=n.samples}get texture(){return this.textures[0]}set texture(e){this.textures[0]=e}setSize(e,t,n=1){if(this.width!==e||this.height!==t||this.depth!==n){this.width=e,this.height=t,this.depth=n;for(let i=0,r=this.textures.length;i<r;i++)this.textures[i].image.width=e,this.textures[i].image.height=t,this.textures[i].image.depth=n;this.dispose()}this.viewport.set(0,0,e,t),this.scissor.set(0,0,e,t)}clone(){return(new this.constructor).copy(this)}copy(e){this.width=e.width,this.height=e.height,this.depth=e.depth,this.scissor.copy(e.scissor),this.scissorTest=e.scissorTest,this.viewport.copy(e.viewport),this.textures.length=0;for(let t=0,n=e.textures.length;t<n;t++)this.textures[t]=e.textures[t].clone(),this.textures[t].isRenderTargetTexture=!0;const t=Object.assign({},e.texture.image);return this.texture.source=new Yt(t),this.depthBuffer=e.depthBuffer,this.stencilBuffer=e.stencilBuffer,this.resolveDepthBuffer=e.resolveDepthBuffer,this.resolveStencilBuffer=e.resolveStencilBuffer,null!==e.depthTexture&&(this.depthTexture=e.depthTexture.clone()),this.samples=e.samples,this}dispose(){this.dispatchEvent({type:"dispose"})}}class en extends Zt{constructor(e=1,t=1,n={}){super(e,t,n),this.isWebGLRenderTarget=!0}}class tn extends Jt{constructor(e=null,t=1,n=1,i=1){super(null),this.isDataArrayTexture=!0,this.image={data:e,width:t,height:n,depth:i},this.magFilter=V,this.minFilter=V,this.wrapR=G,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1,this.layerUpdates=new Set}addLayerUpdate(e){this.layerUpdates.add(e)}clearLayerUpdates(){this.layerUpdates.clear()}}class nn extends Jt{constructor(e=null,t=1,n=1,i=1){super(null),this.isData3DTexture=!0,this.image={data:e,width:t,height:n,depth:i},this.magFilter=V,this.minFilter=V,this.wrapR=G,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}class rn{constructor(e=0,t=0,n=0,i=1){this.isQuaternion=!0,this._x=e,this._y=t,this._z=n,this._w=i}static slerpFlat(e,t,n,i,r,s,a){let o=n[i+0],l=n[i+1],c=n[i+2],h=n[i+3];const u=r[s+0],d=r[s+1],p=r[s+2],f=r[s+3];if(0===a)return e[t+0]=o,e[t+1]=l,e[t+2]=c,void(e[t+3]=h);if(1===a)return e[t+0]=u,e[t+1]=d,e[t+2]=p,void(e[t+3]=f);if(h!==f||o!==u||l!==d||c!==p){let e=1-a;const t=o*u+l*d+c*p+h*f,n=t>=0?1:-1,i=1-t*t;if(i>Number.EPSILON){const r=Math.sqrt(i),s=Math.atan2(r,t*n);e=Math.sin(e*s)/r,a=Math.sin(a*s)/r}const r=a*n;if(o=o*e+u*r,l=l*e+d*r,c=c*e+p*r,h=h*e+f*r,e===1-a){const e=1/Math.sqrt(o*o+l*l+c*c+h*h);o*=e,l*=e,c*=e,h*=e}}e[t]=o,e[t+1]=l,e[t+2]=c,e[t+3]=h}static multiplyQuaternionsFlat(e,t,n,i,r,s){const a=n[i],o=n[i+1],l=n[i+2],c=n[i+3],h=r[s],u=r[s+1],d=r[s+2],p=r[s+3];return e[t]=a*p+c*h+o*d-l*u,e[t+1]=o*p+c*u+l*h-a*d,e[t+2]=l*p+c*d+a*u-o*h,e[t+3]=c*p-a*h-o*u-l*d,e}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get w(){return this._w}set w(e){this._w=e,this._onChangeCallback()}set(e,t,n,i){return this._x=e,this._y=t,this._z=n,this._w=i,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(e){return this._x=e.x,this._y=e.y,this._z=e.z,this._w=e.w,this._onChangeCallback(),this}setFromEuler(e,t=!0){const n=e._x,i=e._y,r=e._z,s=e._order,a=Math.cos,o=Math.sin,l=a(n/2),c=a(i/2),h=a(r/2),u=o(n/2),d=o(i/2),p=o(r/2);switch(s){case"XYZ":this._x=u*c*h+l*d*p,this._y=l*d*h-u*c*p,this._z=l*c*p+u*d*h,this._w=l*c*h-u*d*p;break;case"YXZ":this._x=u*c*h+l*d*p,this._y=l*d*h-u*c*p,this._z=l*c*p-u*d*h,this._w=l*c*h+u*d*p;break;case"ZXY":this._x=u*c*h-l*d*p,this._y=l*d*h+u*c*p,this._z=l*c*p+u*d*h,this._w=l*c*h-u*d*p;break;case"ZYX":this._x=u*c*h-l*d*p,this._y=l*d*h+u*c*p,this._z=l*c*p-u*d*h,this._w=l*c*h+u*d*p;break;case"YZX":this._x=u*c*h+l*d*p,this._y=l*d*h+u*c*p,this._z=l*c*p-u*d*h,this._w=l*c*h-u*d*p;break;case"XZY":this._x=u*c*h-l*d*p,this._y=l*d*h-u*c*p,this._z=l*c*p+u*d*h,this._w=l*c*h+u*d*p;break;default:console.warn("THREE.Quaternion: .setFromEuler() encountered an unknown order: "+s)}return!0===t&&this._onChangeCallback(),this}setFromAxisAngle(e,t){const n=t/2,i=Math.sin(n);return this._x=e.x*i,this._y=e.y*i,this._z=e.z*i,this._w=Math.cos(n),this._onChangeCallback(),this}setFromRotationMatrix(e){const t=e.elements,n=t[0],i=t[4],r=t[8],s=t[1],a=t[5],o=t[9],l=t[2],c=t[6],h=t[10],u=n+a+h;if(u>0){const e=.5/Math.sqrt(u+1);this._w=.25/e,this._x=(c-o)*e,this._y=(r-l)*e,this._z=(s-i)*e}else if(n>a&&n>h){const e=2*Math.sqrt(1+n-a-h);this._w=(c-o)/e,this._x=.25*e,this._y=(i+s)/e,this._z=(r+l)/e}else if(a>h){const e=2*Math.sqrt(1+a-n-h);this._w=(r-l)/e,this._x=(i+s)/e,this._y=.25*e,this._z=(o+c)/e}else{const e=2*Math.sqrt(1+h-n-a);this._w=(s-i)/e,this._x=(r+l)/e,this._y=(o+c)/e,this._z=.25*e}return this._onChangeCallback(),this}setFromUnitVectors(e,t){let n=e.dot(t)+1;return n<Number.EPSILON?(n=0,Math.abs(e.x)>Math.abs(e.z)?(this._x=-e.y,this._y=e.x,this._z=0,this._w=n):(this._x=0,this._y=-e.z,this._z=e.y,this._w=n)):(this._x=e.y*t.z-e.z*t.y,this._y=e.z*t.x-e.x*t.z,this._z=e.x*t.y-e.y*t.x,this._w=n),this.normalize()}angleTo(e){return 2*Math.acos(Math.abs(bt(this.dot(e),-1,1)))}rotateTowards(e,t){const n=this.angleTo(e);if(0===n)return this;const i=Math.min(1,t/n);return this.slerp(e,i),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(e){return this._x*e._x+this._y*e._y+this._z*e._z+this._w*e._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let e=this.length();return 0===e?(this._x=0,this._y=0,this._z=0,this._w=1):(e=1/e,this._x=this._x*e,this._y=this._y*e,this._z=this._z*e,this._w=this._w*e),this._onChangeCallback(),this}multiply(e){return this.multiplyQuaternions(this,e)}premultiply(e){return this.multiplyQuaternions(e,this)}multiplyQuaternions(e,t){const n=e._x,i=e._y,r=e._z,s=e._w,a=t._x,o=t._y,l=t._z,c=t._w;return this._x=n*c+s*a+i*l-r*o,this._y=i*c+s*o+r*a-n*l,this._z=r*c+s*l+n*o-i*a,this._w=s*c-n*a-i*o-r*l,this._onChangeCallback(),this}slerp(e,t){if(0===t)return this;if(1===t)return this.copy(e);const n=this._x,i=this._y,r=this._z,s=this._w;let a=s*e._w+n*e._x+i*e._y+r*e._z;if(a<0?(this._w=-e._w,this._x=-e._x,this._y=-e._y,this._z=-e._z,a=-a):this.copy(e),a>=1)return this._w=s,this._x=n,this._y=i,this._z=r,this;const o=1-a*a;if(o<=Number.EPSILON){const e=1-t;return this._w=e*s+t*this._w,this._x=e*n+t*this._x,this._y=e*i+t*this._y,this._z=e*r+t*this._z,this.normalize(),this}const l=Math.sqrt(o),c=Math.atan2(l,a),h=Math.sin((1-t)*c)/l,u=Math.sin(t*c)/l;return this._w=s*h+this._w*u,this._x=n*h+this._x*u,this._y=i*h+this._y*u,this._z=r*h+this._z*u,this._onChangeCallback(),this}slerpQuaternions(e,t,n){return this.copy(e).slerp(t,n)}random(){const e=2*Math.PI*Math.random(),t=2*Math.PI*Math.random(),n=Math.random(),i=Math.sqrt(1-n),r=Math.sqrt(n);return this.set(i*Math.sin(e),i*Math.cos(e),r*Math.sin(t),r*Math.cos(t))}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._w===this._w}fromArray(e,t=0){return this._x=e[t],this._y=e[t+1],this._z=e[t+2],this._w=e[t+3],this._onChangeCallback(),this}toArray(e=[],t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,e}fromBufferAttribute(e,t){return this._x=e.getX(t),this._y=e.getY(t),this._z=e.getZ(t),this._w=e.getW(t),this._onChangeCallback(),this}toJSON(){return this.toArray()}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._w}}class sn{constructor(e=0,t=0,n=0){sn.prototype.isVector3=!0,this.x=e,this.y=t,this.z=n}set(e,t,n){return void 0===n&&(n=this.z),this.x=e,this.y=t,this.z=n,this}setScalar(e){return this.x=e,this.y=e,this.z=e,this}setX(e){return this.x=e,this}setY(e){return this.y=e,this}setZ(e){return this.z=e,this}setComponent(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;default:throw new Error("index is out of range: "+e)}return this}getComponent(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+e)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}addScalar(e){return this.x+=e,this.y+=e,this.z+=e,this}addVectors(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this}addScaledVector(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}subScalar(e){return this.x-=e,this.y-=e,this.z-=e,this}subVectors(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this}multiply(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this}multiplyScalar(e){return this.x*=e,this.y*=e,this.z*=e,this}multiplyVectors(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this}applyEuler(e){return this.applyQuaternion(on.setFromEuler(e))}applyAxisAngle(e,t){return this.applyQuaternion(on.setFromAxisAngle(e,t))}applyMatrix3(e){const t=this.x,n=this.y,i=this.z,r=e.elements;return this.x=r[0]*t+r[3]*n+r[6]*i,this.y=r[1]*t+r[4]*n+r[7]*i,this.z=r[2]*t+r[5]*n+r[8]*i,this}applyNormalMatrix(e){return this.applyMatrix3(e).normalize()}applyMatrix4(e){const t=this.x,n=this.y,i=this.z,r=e.elements,s=1/(r[3]*t+r[7]*n+r[11]*i+r[15]);return this.x=(r[0]*t+r[4]*n+r[8]*i+r[12])*s,this.y=(r[1]*t+r[5]*n+r[9]*i+r[13])*s,this.z=(r[2]*t+r[6]*n+r[10]*i+r[14])*s,this}applyQuaternion(e){const t=this.x,n=this.y,i=this.z,r=e.x,s=e.y,a=e.z,o=e.w,l=2*(s*i-a*n),c=2*(a*t-r*i),h=2*(r*n-s*t);return this.x=t+o*l+s*h-a*c,this.y=n+o*c+a*l-r*h,this.z=i+o*h+r*c-s*l,this}project(e){return this.applyMatrix4(e.matrixWorldInverse).applyMatrix4(e.projectionMatrix)}unproject(e){return this.applyMatrix4(e.projectionMatrixInverse).applyMatrix4(e.matrixWorld)}transformDirection(e){const t=this.x,n=this.y,i=this.z,r=e.elements;return this.x=r[0]*t+r[4]*n+r[8]*i,this.y=r[1]*t+r[5]*n+r[9]*i,this.z=r[2]*t+r[6]*n+r[10]*i,this.normalize()}divide(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this}divideScalar(e){return this.multiplyScalar(1/e)}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this}clamp(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this}clampScalar(e,t){return this.x=Math.max(e,Math.min(t,this.x)),this.y=Math.max(e,Math.min(t,this.y)),this.z=Math.max(e,Math.min(t,this.z)),this}clampLength(e,t){const n=this.length();return this.divideScalar(n||1).multiplyScalar(Math.max(e,Math.min(t,n)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.z=Math.trunc(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(e){return this.normalize().multiplyScalar(e)}lerp(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this}lerpVectors(e,t,n){return this.x=e.x+(t.x-e.x)*n,this.y=e.y+(t.y-e.y)*n,this.z=e.z+(t.z-e.z)*n,this}cross(e){return this.crossVectors(this,e)}crossVectors(e,t){const n=e.x,i=e.y,r=e.z,s=t.x,a=t.y,o=t.z;return this.x=i*o-r*a,this.y=r*s-n*o,this.z=n*a-i*s,this}projectOnVector(e){const t=e.lengthSq();if(0===t)return this.set(0,0,0);const n=e.dot(this)/t;return this.copy(e).multiplyScalar(n)}projectOnPlane(e){return an.copy(this).projectOnVector(e),this.sub(an)}reflect(e){return this.sub(an.copy(e).multiplyScalar(2*this.dot(e)))}angleTo(e){const t=Math.sqrt(this.lengthSq()*e.lengthSq());if(0===t)return Math.PI/2;const n=this.dot(e)/t;return Math.acos(bt(n,-1,1))}distanceTo(e){return Math.sqrt(this.distanceToSquared(e))}distanceToSquared(e){const t=this.x-e.x,n=this.y-e.y,i=this.z-e.z;return t*t+n*n+i*i}manhattanDistanceTo(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)+Math.abs(this.z-e.z)}setFromSpherical(e){return this.setFromSphericalCoords(e.radius,e.phi,e.theta)}setFromSphericalCoords(e,t,n){const i=Math.sin(t)*e;return this.x=i*Math.sin(n),this.y=Math.cos(t)*e,this.z=i*Math.cos(n),this}setFromCylindrical(e){return this.setFromCylindricalCoords(e.radius,e.theta,e.y)}setFromCylindricalCoords(e,t,n){return this.x=e*Math.sin(t),this.y=n,this.z=e*Math.cos(t),this}setFromMatrixPosition(e){const t=e.elements;return this.x=t[12],this.y=t[13],this.z=t[14],this}setFromMatrixScale(e){const t=this.setFromMatrixColumn(e,0).length(),n=this.setFromMatrixColumn(e,1).length(),i=this.setFromMatrixColumn(e,2).length();return this.x=t,this.y=n,this.z=i,this}setFromMatrixColumn(e,t){return this.fromArray(e.elements,4*t)}setFromMatrix3Column(e,t){return this.fromArray(e.elements,3*t)}setFromEuler(e){return this.x=e._x,this.y=e._y,this.z=e._z,this}setFromColor(e){return this.x=e.r,this.y=e.g,this.z=e.b,this}equals(e){return e.x===this.x&&e.y===this.y&&e.z===this.z}fromArray(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this}toArray(e=[],t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e}fromBufferAttribute(e,t){return this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}randomDirection(){const e=Math.random()*Math.PI*2,t=2*Math.random()-1,n=Math.sqrt(1-t*t);return this.x=n*Math.cos(e),this.y=t,this.z=n*Math.sin(e),this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z}}const an=new sn,on=new rn;class ln{constructor(e=new sn(1/0,1/0,1/0),t=new sn(-1/0,-1/0,-1/0)){this.isBox3=!0,this.min=e,this.max=t}set(e,t){return this.min.copy(e),this.max.copy(t),this}setFromArray(e){this.makeEmpty();for(let t=0,n=e.length;t<n;t+=3)this.expandByPoint(hn.fromArray(e,t));return this}setFromBufferAttribute(e){this.makeEmpty();for(let t=0,n=e.count;t<n;t++)this.expandByPoint(hn.fromBufferAttribute(e,t));return this}setFromPoints(e){this.makeEmpty();for(let t=0,n=e.length;t<n;t++)this.expandByPoint(e[t]);return this}setFromCenterAndSize(e,t){const n=hn.copy(t).multiplyScalar(.5);return this.min.copy(e).sub(n),this.max.copy(e).add(n),this}setFromObject(e,t=!1){return this.makeEmpty(),this.expandByObject(e,t)}clone(){return(new this.constructor).copy(this)}copy(e){return this.min.copy(e.min),this.max.copy(e.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(e){return this.isEmpty()?e.set(0,0,0):e.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(e){return this.isEmpty()?e.set(0,0,0):e.subVectors(this.max,this.min)}expandByPoint(e){return this.min.min(e),this.max.max(e),this}expandByVector(e){return this.min.sub(e),this.max.add(e),this}expandByScalar(e){return this.min.addScalar(-e),this.max.addScalar(e),this}expandByObject(e,t=!1){e.updateWorldMatrix(!1,!1);const n=e.geometry;if(void 0!==n){const i=n.getAttribute("position");if(!0===t&&void 0!==i&&!0!==e.isInstancedMesh)for(let t=0,n=i.count;t<n;t++)!0===e.isMesh?e.getVertexPosition(t,hn):hn.fromBufferAttribute(i,t),hn.applyMatrix4(e.matrixWorld),this.expandByPoint(hn);else void 0!==e.boundingBox?(null===e.boundingBox&&e.computeBoundingBox(),un.copy(e.boundingBox)):(null===n.boundingBox&&n.computeBoundingBox(),un.copy(n.boundingBox)),un.applyMatrix4(e.matrixWorld),this.union(un)}const i=e.children;for(let e=0,n=i.length;e<n;e++)this.expandByObject(i[e],t);return this}containsPoint(e){return e.x>=this.min.x&&e.x<=this.max.x&&e.y>=this.min.y&&e.y<=this.max.y&&e.z>=this.min.z&&e.z<=this.max.z}containsBox(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y&&this.min.z<=e.min.z&&e.max.z<=this.max.z}getParameter(e,t){return t.set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y),(e.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(e){return e.max.x>=this.min.x&&e.min.x<=this.max.x&&e.max.y>=this.min.y&&e.min.y<=this.max.y&&e.max.z>=this.min.z&&e.min.z<=this.max.z}intersectsSphere(e){return this.clampPoint(e.center,hn),hn.distanceToSquared(e.center)<=e.radius*e.radius}intersectsPlane(e){let t,n;return e.normal.x>0?(t=e.normal.x*this.min.x,n=e.normal.x*this.max.x):(t=e.normal.x*this.max.x,n=e.normal.x*this.min.x),e.normal.y>0?(t+=e.normal.y*this.min.y,n+=e.normal.y*this.max.y):(t+=e.normal.y*this.max.y,n+=e.normal.y*this.min.y),e.normal.z>0?(t+=e.normal.z*this.min.z,n+=e.normal.z*this.max.z):(t+=e.normal.z*this.max.z,n+=e.normal.z*this.min.z),t<=-e.constant&&n>=-e.constant}intersectsTriangle(e){if(this.isEmpty())return!1;this.getCenter(yn),vn.subVectors(this.max,yn),dn.subVectors(e.a,yn),pn.subVectors(e.b,yn),fn.subVectors(e.c,yn),mn.subVectors(pn,dn),gn.subVectors(fn,pn),An.subVectors(dn,fn);let t=[0,-mn.z,mn.y,0,-gn.z,gn.y,0,-An.z,An.y,mn.z,0,-mn.x,gn.z,0,-gn.x,An.z,0,-An.x,-mn.y,mn.x,0,-gn.y,gn.x,0,-An.y,An.x,0];return!!En(t,dn,pn,fn,vn)&&(t=[1,0,0,0,1,0,0,0,1],!!En(t,dn,pn,fn,vn)&&(_n.crossVectors(mn,gn),t=[_n.x,_n.y,_n.z],En(t,dn,pn,fn,vn)))}clampPoint(e,t){return t.copy(e).clamp(this.min,this.max)}distanceToPoint(e){return this.clampPoint(e,hn).distanceTo(e)}getBoundingSphere(e){return this.isEmpty()?e.makeEmpty():(this.getCenter(e.center),e.radius=.5*this.getSize(hn).length()),e}intersect(e){return this.min.max(e.min),this.max.min(e.max),this.isEmpty()&&this.makeEmpty(),this}union(e){return this.min.min(e.min),this.max.max(e.max),this}applyMatrix4(e){return this.isEmpty()||(cn[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(e),cn[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(e),cn[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(e),cn[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(e),cn[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(e),cn[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(e),cn[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(e),cn[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(e),this.setFromPoints(cn)),this}translate(e){return this.min.add(e),this.max.add(e),this}equals(e){return e.min.equals(this.min)&&e.max.equals(this.max)}}const cn=[new sn,new sn,new sn,new sn,new sn,new sn,new sn,new sn],hn=new sn,un=new ln,dn=new sn,pn=new sn,fn=new sn,mn=new sn,gn=new sn,An=new sn,yn=new sn,vn=new sn,_n=new sn,xn=new sn;function En(e,t,n,i,r){for(let s=0,a=e.length-3;s<=a;s+=3){xn.fromArray(e,s);const a=r.x*Math.abs(xn.x)+r.y*Math.abs(xn.y)+r.z*Math.abs(xn.z),o=t.dot(xn),l=n.dot(xn),c=i.dot(xn);if(Math.max(-Math.max(o,l,c),Math.min(o,l,c))>a)return!1}return!0}const bn=new ln,wn=new sn,Mn=new sn;class Sn{constructor(e=new sn,t=-1){this.isSphere=!0,this.center=e,this.radius=t}set(e,t){return this.center.copy(e),this.radius=t,this}setFromPoints(e,t){const n=this.center;void 0!==t?n.copy(t):bn.setFromPoints(e).getCenter(n);let i=0;for(let t=0,r=e.length;t<r;t++)i=Math.max(i,n.distanceToSquared(e[t]));return this.radius=Math.sqrt(i),this}copy(e){return this.center.copy(e.center),this.radius=e.radius,this}isEmpty(){return this.radius<0}makeEmpty(){return this.center.set(0,0,0),this.radius=-1,this}containsPoint(e){return e.distanceToSquared(this.center)<=this.radius*this.radius}distanceToPoint(e){return e.distanceTo(this.center)-this.radius}intersectsSphere(e){const t=this.radius+e.radius;return e.center.distanceToSquared(this.center)<=t*t}intersectsBox(e){return e.intersectsSphere(this)}intersectsPlane(e){return Math.abs(e.distanceToPoint(this.center))<=this.radius}clampPoint(e,t){const n=this.center.distanceToSquared(e);return t.copy(e),n>this.radius*this.radius&&(t.sub(this.center).normalize(),t.multiplyScalar(this.radius).add(this.center)),t}getBoundingBox(e){return this.isEmpty()?(e.makeEmpty(),e):(e.set(this.center,this.center),e.expandByScalar(this.radius),e)}applyMatrix4(e){return this.center.applyMatrix4(e),this.radius=this.radius*e.getMaxScaleOnAxis(),this}translate(e){return this.center.add(e),this}expandByPoint(e){if(this.isEmpty())return this.center.copy(e),this.radius=0,this;wn.subVectors(e,this.center);const t=wn.lengthSq();if(t>this.radius*this.radius){const e=Math.sqrt(t),n=.5*(e-this.radius);this.center.addScaledVector(wn,n/e),this.radius+=n}return this}union(e){return e.isEmpty()?this:this.isEmpty()?(this.copy(e),this):(!0===this.center.equals(e.center)?this.radius=Math.max(this.radius,e.radius):(Mn.subVectors(e.center,this.center).setLength(e.radius),this.expandByPoint(wn.copy(e.center).add(Mn)),this.expandByPoint(wn.copy(e.center).sub(Mn))),this)}equals(e){return e.center.equals(this.center)&&e.radius===this.radius}clone(){return(new this.constructor).copy(this)}}const Cn=new sn,Tn=new sn,In=new sn,Rn=new sn,Bn=new sn,Ln=new sn,Pn=new sn;class Dn{constructor(e=new sn,t=new sn(0,0,-1)){this.origin=e,this.direction=t}set(e,t){return this.origin.copy(e),this.direction.copy(t),this}copy(e){return this.origin.copy(e.origin),this.direction.copy(e.direction),this}at(e,t){return t.copy(this.origin).addScaledVector(this.direction,e)}lookAt(e){return this.direction.copy(e).sub(this.origin).normalize(),this}recast(e){return this.origin.copy(this.at(e,Cn)),this}closestPointToPoint(e,t){t.subVectors(e,this.origin);const n=t.dot(this.direction);return n<0?t.copy(this.origin):t.copy(this.origin).addScaledVector(this.direction,n)}distanceToPoint(e){return Math.sqrt(this.distanceSqToPoint(e))}distanceSqToPoint(e){const t=Cn.subVectors(e,this.origin).dot(this.direction);return t<0?this.origin.distanceToSquared(e):(Cn.copy(this.origin).addScaledVector(this.direction,t),Cn.distanceToSquared(e))}distanceSqToSegment(e,t,n,i){Tn.copy(e).add(t).multiplyScalar(.5),In.copy(t).sub(e).normalize(),Rn.copy(this.origin).sub(Tn);const r=.5*e.distanceTo(t),s=-this.direction.dot(In),a=Rn.dot(this.direction),o=-Rn.dot(In),l=Rn.lengthSq(),c=Math.abs(1-s*s);let h,u,d,p;if(c>0)if(h=s*o-a,u=s*a-o,p=r*c,h>=0)if(u>=-p)if(u<=p){const e=1/c;h*=e,u*=e,d=h*(h+s*u+2*a)+u*(s*h+u+2*o)+l}else u=r,h=Math.max(0,-(s*u+a)),d=-h*h+u*(u+2*o)+l;else u=-r,h=Math.max(0,-(s*u+a)),d=-h*h+u*(u+2*o)+l;else u<=-p?(h=Math.max(0,-(-s*r+a)),u=h>0?-r:Math.min(Math.max(-r,-o),r),d=-h*h+u*(u+2*o)+l):u<=p?(h=0,u=Math.min(Math.max(-r,-o),r),d=u*(u+2*o)+l):(h=Math.max(0,-(s*r+a)),u=h>0?r:Math.min(Math.max(-r,-o),r),d=-h*h+u*(u+2*o)+l);else u=s>0?-r:r,h=Math.max(0,-(s*u+a)),d=-h*h+u*(u+2*o)+l;return n&&n.copy(this.origin).addScaledVector(this.direction,h),i&&i.copy(Tn).addScaledVector(In,u),d}intersectSphere(e,t){Cn.subVectors(e.center,this.origin);const n=Cn.dot(this.direction),i=Cn.dot(Cn)-n*n,r=e.radius*e.radius;if(i>r)return null;const s=Math.sqrt(r-i),a=n-s,o=n+s;return o<0?null:a<0?this.at(o,t):this.at(a,t)}intersectsSphere(e){return this.distanceSqToPoint(e.center)<=e.radius*e.radius}distanceToPlane(e){const t=e.normal.dot(this.direction);if(0===t)return 0===e.distanceToPoint(this.origin)?0:null;const n=-(this.origin.dot(e.normal)+e.constant)/t;return n>=0?n:null}intersectPlane(e,t){const n=this.distanceToPlane(e);return null===n?null:this.at(n,t)}intersectsPlane(e){const t=e.distanceToPoint(this.origin);return 0===t||e.normal.dot(this.direction)*t<0}intersectBox(e,t){let n,i,r,s,a,o;const l=1/this.direction.x,c=1/this.direction.y,h=1/this.direction.z,u=this.origin;return l>=0?(n=(e.min.x-u.x)*l,i=(e.max.x-u.x)*l):(n=(e.max.x-u.x)*l,i=(e.min.x-u.x)*l),c>=0?(r=(e.min.y-u.y)*c,s=(e.max.y-u.y)*c):(r=(e.max.y-u.y)*c,s=(e.min.y-u.y)*c),n>s||r>i?null:((r>n||isNaN(n))&&(n=r),(s<i||isNaN(i))&&(i=s),h>=0?(a=(e.min.z-u.z)*h,o=(e.max.z-u.z)*h):(a=(e.max.z-u.z)*h,o=(e.min.z-u.z)*h),n>o||a>i?null:((a>n||n!=n)&&(n=a),(o<i||i!=i)&&(i=o),i<0?null:this.at(n>=0?n:i,t)))}intersectsBox(e){return null!==this.intersectBox(e,Cn)}intersectTriangle(e,t,n,i,r){Bn.subVectors(t,e),Ln.subVectors(n,e),Pn.crossVectors(Bn,Ln);let s,a=this.direction.dot(Pn);if(a>0){if(i)return null;s=1}else{if(!(a<0))return null;s=-1,a=-a}Rn.subVectors(this.origin,e);const o=s*this.direction.dot(Ln.crossVectors(Rn,Ln));if(o<0)return null;const l=s*this.direction.dot(Bn.cross(Rn));if(l<0)return null;if(o+l>a)return null;const c=-s*Rn.dot(Pn);return c<0?null:this.at(c/a,r)}applyMatrix4(e){return this.origin.applyMatrix4(e),this.direction.transformDirection(e),this}equals(e){return e.origin.equals(this.origin)&&e.direction.equals(this.direction)}clone(){return(new this.constructor).copy(this)}}class Nn{constructor(e,t,n,i,r,s,a,o,l,c,h,u,d,p,f,m){Nn.prototype.isMatrix4=!0,this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],void 0!==e&&this.set(e,t,n,i,r,s,a,o,l,c,h,u,d,p,f,m)}set(e,t,n,i,r,s,a,o,l,c,h,u,d,p,f,m){const g=this.elements;return g[0]=e,g[4]=t,g[8]=n,g[12]=i,g[1]=r,g[5]=s,g[9]=a,g[13]=o,g[2]=l,g[6]=c,g[10]=h,g[14]=u,g[3]=d,g[7]=p,g[11]=f,g[15]=m,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return(new Nn).fromArray(this.elements)}copy(e){const t=this.elements,n=e.elements;return t[0]=n[0],t[1]=n[1],t[2]=n[2],t[3]=n[3],t[4]=n[4],t[5]=n[5],t[6]=n[6],t[7]=n[7],t[8]=n[8],t[9]=n[9],t[10]=n[10],t[11]=n[11],t[12]=n[12],t[13]=n[13],t[14]=n[14],t[15]=n[15],this}copyPosition(e){const t=this.elements,n=e.elements;return t[12]=n[12],t[13]=n[13],t[14]=n[14],this}setFromMatrix3(e){const t=e.elements;return this.set(t[0],t[3],t[6],0,t[1],t[4],t[7],0,t[2],t[5],t[8],0,0,0,0,1),this}extractBasis(e,t,n){return e.setFromMatrixColumn(this,0),t.setFromMatrixColumn(this,1),n.setFromMatrixColumn(this,2),this}makeBasis(e,t,n){return this.set(e.x,t.x,n.x,0,e.y,t.y,n.y,0,e.z,t.z,n.z,0,0,0,0,1),this}extractRotation(e){const t=this.elements,n=e.elements,i=1/Un.setFromMatrixColumn(e,0).length(),r=1/Un.setFromMatrixColumn(e,1).length(),s=1/Un.setFromMatrixColumn(e,2).length();return t[0]=n[0]*i,t[1]=n[1]*i,t[2]=n[2]*i,t[3]=0,t[4]=n[4]*r,t[5]=n[5]*r,t[6]=n[6]*r,t[7]=0,t[8]=n[8]*s,t[9]=n[9]*s,t[10]=n[10]*s,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromEuler(e){const t=this.elements,n=e.x,i=e.y,r=e.z,s=Math.cos(n),a=Math.sin(n),o=Math.cos(i),l=Math.sin(i),c=Math.cos(r),h=Math.sin(r);if("XYZ"===e.order){const e=s*c,n=s*h,i=a*c,r=a*h;t[0]=o*c,t[4]=-o*h,t[8]=l,t[1]=n+i*l,t[5]=e-r*l,t[9]=-a*o,t[2]=r-e*l,t[6]=i+n*l,t[10]=s*o}else if("YXZ"===e.order){const e=o*c,n=o*h,i=l*c,r=l*h;t[0]=e+r*a,t[4]=i*a-n,t[8]=s*l,t[1]=s*h,t[5]=s*c,t[9]=-a,t[2]=n*a-i,t[6]=r+e*a,t[10]=s*o}else if("ZXY"===e.order){const e=o*c,n=o*h,i=l*c,r=l*h;t[0]=e-r*a,t[4]=-s*h,t[8]=i+n*a,t[1]=n+i*a,t[5]=s*c,t[9]=r-e*a,t[2]=-s*l,t[6]=a,t[10]=s*o}else if("ZYX"===e.order){const e=s*c,n=s*h,i=a*c,r=a*h;t[0]=o*c,t[4]=i*l-n,t[8]=e*l+r,t[1]=o*h,t[5]=r*l+e,t[9]=n*l-i,t[2]=-l,t[6]=a*o,t[10]=s*o}else if("YZX"===e.order){const e=s*o,n=s*l,i=a*o,r=a*l;t[0]=o*c,t[4]=r-e*h,t[8]=i*h+n,t[1]=h,t[5]=s*c,t[9]=-a*c,t[2]=-l*c,t[6]=n*h+i,t[10]=e-r*h}else if("XZY"===e.order){const e=s*o,n=s*l,i=a*o,r=a*l;t[0]=o*c,t[4]=-h,t[8]=l*c,t[1]=e*h+r,t[5]=s*c,t[9]=n*h-i,t[2]=i*h-n,t[6]=a*c,t[10]=r*h+e}return t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this}makeRotationFromQuaternion(e){return this.compose(Fn,e,kn)}lookAt(e,t,n){const i=this.elements;return Gn.subVectors(e,t),0===Gn.lengthSq()&&(Gn.z=1),Gn.normalize(),Qn.crossVectors(n,Gn),0===Qn.lengthSq()&&(1===Math.abs(n.z)?Gn.x+=1e-4:Gn.z+=1e-4,Gn.normalize(),Qn.crossVectors(n,Gn)),Qn.normalize(),zn.crossVectors(Gn,Qn),i[0]=Qn.x,i[4]=zn.x,i[8]=Gn.x,i[1]=Qn.y,i[5]=zn.y,i[9]=Gn.y,i[2]=Qn.z,i[6]=zn.z,i[10]=Gn.z,this}multiply(e){return this.multiplyMatrices(this,e)}premultiply(e){return this.multiplyMatrices(e,this)}multiplyMatrices(e,t){const n=e.elements,i=t.elements,r=this.elements,s=n[0],a=n[4],o=n[8],l=n[12],c=n[1],h=n[5],u=n[9],d=n[13],p=n[2],f=n[6],m=n[10],g=n[14],A=n[3],y=n[7],v=n[11],_=n[15],x=i[0],E=i[4],b=i[8],w=i[12],M=i[1],S=i[5],C=i[9],T=i[13],I=i[2],R=i[6],B=i[10],L=i[14],P=i[3],D=i[7],N=i[11],U=i[15];return r[0]=s*x+a*M+o*I+l*P,r[4]=s*E+a*S+o*R+l*D,r[8]=s*b+a*C+o*B+l*N,r[12]=s*w+a*T+o*L+l*U,r[1]=c*x+h*M+u*I+d*P,r[5]=c*E+h*S+u*R+d*D,r[9]=c*b+h*C+u*B+d*N,r[13]=c*w+h*T+u*L+d*U,r[2]=p*x+f*M+m*I+g*P,r[6]=p*E+f*S+m*R+g*D,r[10]=p*b+f*C+m*B+g*N,r[14]=p*w+f*T+m*L+g*U,r[3]=A*x+y*M+v*I+_*P,r[7]=A*E+y*S+v*R+_*D,r[11]=A*b+y*C+v*B+_*N,r[15]=A*w+y*T+v*L+_*U,this}multiplyScalar(e){const t=this.elements;return t[0]*=e,t[4]*=e,t[8]*=e,t[12]*=e,t[1]*=e,t[5]*=e,t[9]*=e,t[13]*=e,t[2]*=e,t[6]*=e,t[10]*=e,t[14]*=e,t[3]*=e,t[7]*=e,t[11]*=e,t[15]*=e,this}determinant(){const e=this.elements,t=e[0],n=e[4],i=e[8],r=e[12],s=e[1],a=e[5],o=e[9],l=e[13],c=e[2],h=e[6],u=e[10],d=e[14];return e[3]*(+r*o*h-i*l*h-r*a*u+n*l*u+i*a*d-n*o*d)+e[7]*(+t*o*d-t*l*u+r*s*u-i*s*d+i*l*c-r*o*c)+e[11]*(+t*l*h-t*a*d-r*s*h+n*s*d+r*a*c-n*l*c)+e[15]*(-i*a*c-t*o*h+t*a*u+i*s*h-n*s*u+n*o*c)}transpose(){const e=this.elements;let t;return t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this}setPosition(e,t,n){const i=this.elements;return e.isVector3?(i[12]=e.x,i[13]=e.y,i[14]=e.z):(i[12]=e,i[13]=t,i[14]=n),this}invert(){const e=this.elements,t=e[0],n=e[1],i=e[2],r=e[3],s=e[4],a=e[5],o=e[6],l=e[7],c=e[8],h=e[9],u=e[10],d=e[11],p=e[12],f=e[13],m=e[14],g=e[15],A=h*m*l-f*u*l+f*o*d-a*m*d-h*o*g+a*u*g,y=p*u*l-c*m*l-p*o*d+s*m*d+c*o*g-s*u*g,v=c*f*l-p*h*l+p*a*d-s*f*d-c*a*g+s*h*g,_=p*h*o-c*f*o-p*a*u+s*f*u+c*a*m-s*h*m,x=t*A+n*y+i*v+r*_;if(0===x)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const E=1/x;return e[0]=A*E,e[1]=(f*u*r-h*m*r-f*i*d+n*m*d+h*i*g-n*u*g)*E,e[2]=(a*m*r-f*o*r+f*i*l-n*m*l-a*i*g+n*o*g)*E,e[3]=(h*o*r-a*u*r-h*i*l+n*u*l+a*i*d-n*o*d)*E,e[4]=y*E,e[5]=(c*m*r-p*u*r+p*i*d-t*m*d-c*i*g+t*u*g)*E,e[6]=(p*o*r-s*m*r-p*i*l+t*m*l+s*i*g-t*o*g)*E,e[7]=(s*u*r-c*o*r+c*i*l-t*u*l-s*i*d+t*o*d)*E,e[8]=v*E,e[9]=(p*h*r-c*f*r-p*n*d+t*f*d+c*n*g-t*h*g)*E,e[10]=(s*f*r-p*a*r+p*n*l-t*f*l-s*n*g+t*a*g)*E,e[11]=(c*a*r-s*h*r-c*n*l+t*h*l+s*n*d-t*a*d)*E,e[12]=_*E,e[13]=(c*f*i-p*h*i+p*n*u-t*f*u-c*n*m+t*h*m)*E,e[14]=(p*a*i-s*f*i-p*n*o+t*f*o+s*n*m-t*a*m)*E,e[15]=(s*h*i-c*a*i+c*n*o-t*h*o-s*n*u+t*a*u)*E,this}scale(e){const t=this.elements,n=e.x,i=e.y,r=e.z;return t[0]*=n,t[4]*=i,t[8]*=r,t[1]*=n,t[5]*=i,t[9]*=r,t[2]*=n,t[6]*=i,t[10]*=r,t[3]*=n,t[7]*=i,t[11]*=r,this}getMaxScaleOnAxis(){const e=this.elements,t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],n=e[4]*e[4]+e[5]*e[5]+e[6]*e[6],i=e[8]*e[8]+e[9]*e[9]+e[10]*e[10];return Math.sqrt(Math.max(t,n,i))}makeTranslation(e,t,n){return e.isVector3?this.set(1,0,0,e.x,0,1,0,e.y,0,0,1,e.z,0,0,0,1):this.set(1,0,0,e,0,1,0,t,0,0,1,n,0,0,0,1),this}makeRotationX(e){const t=Math.cos(e),n=Math.sin(e);return this.set(1,0,0,0,0,t,-n,0,0,n,t,0,0,0,0,1),this}makeRotationY(e){const t=Math.cos(e),n=Math.sin(e);return this.set(t,0,n,0,0,1,0,0,-n,0,t,0,0,0,0,1),this}makeRotationZ(e){const t=Math.cos(e),n=Math.sin(e);return this.set(t,-n,0,0,n,t,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(e,t){const n=Math.cos(t),i=Math.sin(t),r=1-n,s=e.x,a=e.y,o=e.z,l=r*s,c=r*a;return this.set(l*s+n,l*a-i*o,l*o+i*a,0,l*a+i*o,c*a+n,c*o-i*s,0,l*o-i*a,c*o+i*s,r*o*o+n,0,0,0,0,1),this}makeScale(e,t,n){return this.set(e,0,0,0,0,t,0,0,0,0,n,0,0,0,0,1),this}makeShear(e,t,n,i,r,s){return this.set(1,n,r,0,e,1,s,0,t,i,1,0,0,0,0,1),this}compose(e,t,n){const i=this.elements,r=t._x,s=t._y,a=t._z,o=t._w,l=r+r,c=s+s,h=a+a,u=r*l,d=r*c,p=r*h,f=s*c,m=s*h,g=a*h,A=o*l,y=o*c,v=o*h,_=n.x,x=n.y,E=n.z;return i[0]=(1-(f+g))*_,i[1]=(d+v)*_,i[2]=(p-y)*_,i[3]=0,i[4]=(d-v)*x,i[5]=(1-(u+g))*x,i[6]=(m+A)*x,i[7]=0,i[8]=(p+y)*E,i[9]=(m-A)*E,i[10]=(1-(u+f))*E,i[11]=0,i[12]=e.x,i[13]=e.y,i[14]=e.z,i[15]=1,this}decompose(e,t,n){const i=this.elements;let r=Un.set(i[0],i[1],i[2]).length();const s=Un.set(i[4],i[5],i[6]).length(),a=Un.set(i[8],i[9],i[10]).length();this.determinant()<0&&(r=-r),e.x=i[12],e.y=i[13],e.z=i[14],On.copy(this);const o=1/r,l=1/s,c=1/a;return On.elements[0]*=o,On.elements[1]*=o,On.elements[2]*=o,On.elements[4]*=l,On.elements[5]*=l,On.elements[6]*=l,On.elements[8]*=c,On.elements[9]*=c,On.elements[10]*=c,t.setFromRotationMatrix(On),n.x=r,n.y=s,n.z=a,this}makePerspective(e,t,n,i,r,s,a=2e3){const o=this.elements,l=2*r/(t-e),c=2*r/(n-i),h=(t+e)/(t-e),u=(n+i)/(n-i);let d,p;if(a===mt)d=-(s+r)/(s-r),p=-2*s*r/(s-r);else{if(a!==gt)throw new Error("THREE.Matrix4.makePerspective(): Invalid coordinate system: "+a);d=-s/(s-r),p=-s*r/(s-r)}return o[0]=l,o[4]=0,o[8]=h,o[12]=0,o[1]=0,o[5]=c,o[9]=u,o[13]=0,o[2]=0,o[6]=0,o[10]=d,o[14]=p,o[3]=0,o[7]=0,o[11]=-1,o[15]=0,this}makeOrthographic(e,t,n,i,r,s,a=2e3){const o=this.elements,l=1/(t-e),c=1/(n-i),h=1/(s-r),u=(t+e)*l,d=(n+i)*c;let p,f;if(a===mt)p=(s+r)*h,f=-2*h;else{if(a!==gt)throw new Error("THREE.Matrix4.makeOrthographic(): Invalid coordinate system: "+a);p=r*h,f=-1*h}return o[0]=2*l,o[4]=0,o[8]=0,o[12]=-u,o[1]=0,o[5]=2*c,o[9]=0,o[13]=-d,o[2]=0,o[6]=0,o[10]=f,o[14]=-p,o[3]=0,o[7]=0,o[11]=0,o[15]=1,this}equals(e){const t=this.elements,n=e.elements;for(let e=0;e<16;e++)if(t[e]!==n[e])return!1;return!0}fromArray(e,t=0){for(let n=0;n<16;n++)this.elements[n]=e[n+t];return this}toArray(e=[],t=0){const n=this.elements;return e[t]=n[0],e[t+1]=n[1],e[t+2]=n[2],e[t+3]=n[3],e[t+4]=n[4],e[t+5]=n[5],e[t+6]=n[6],e[t+7]=n[7],e[t+8]=n[8],e[t+9]=n[9],e[t+10]=n[10],e[t+11]=n[11],e[t+12]=n[12],e[t+13]=n[13],e[t+14]=n[14],e[t+15]=n[15],e}}const Un=new sn,On=new Nn,Fn=new sn(0,0,0),kn=new sn(1,1,1),Qn=new sn,zn=new sn,Gn=new sn,Hn=new Nn,Vn=new rn;class jn{constructor(e=0,t=0,n=0,i=jn.DEFAULT_ORDER){this.isEuler=!0,this._x=e,this._y=t,this._z=n,this._order=i}get x(){return this._x}set x(e){this._x=e,this._onChangeCallback()}get y(){return this._y}set y(e){this._y=e,this._onChangeCallback()}get z(){return this._z}set z(e){this._z=e,this._onChangeCallback()}get order(){return this._order}set order(e){this._order=e,this._onChangeCallback()}set(e,t,n,i=this._order){return this._x=e,this._y=t,this._z=n,this._order=i,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._order)}copy(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._order=e._order,this._onChangeCallback(),this}setFromRotationMatrix(e,t=this._order,n=!0){const i=e.elements,r=i[0],s=i[4],a=i[8],o=i[1],l=i[5],c=i[9],h=i[2],u=i[6],d=i[10];switch(t){case"XYZ":this._y=Math.asin(bt(a,-1,1)),Math.abs(a)<.9999999?(this._x=Math.atan2(-c,d),this._z=Math.atan2(-s,r)):(this._x=Math.atan2(u,l),this._z=0);break;case"YXZ":this._x=Math.asin(-bt(c,-1,1)),Math.abs(c)<.9999999?(this._y=Math.atan2(a,d),this._z=Math.atan2(o,l)):(this._y=Math.atan2(-h,r),this._z=0);break;case"ZXY":this._x=Math.asin(bt(u,-1,1)),Math.abs(u)<.9999999?(this._y=Math.atan2(-h,d),this._z=Math.atan2(-s,l)):(this._y=0,this._z=Math.atan2(o,r));break;case"ZYX":this._y=Math.asin(-bt(h,-1,1)),Math.abs(h)<.9999999?(this._x=Math.atan2(u,d),this._z=Math.atan2(o,r)):(this._x=0,this._z=Math.atan2(-s,l));break;case"YZX":this._z=Math.asin(bt(o,-1,1)),Math.abs(o)<.9999999?(this._x=Math.atan2(-c,l),this._y=Math.atan2(-h,r)):(this._x=0,this._y=Math.atan2(a,d));break;case"XZY":this._z=Math.asin(-bt(s,-1,1)),Math.abs(s)<.9999999?(this._x=Math.atan2(u,l),this._y=Math.atan2(a,r)):(this._x=Math.atan2(-c,d),this._y=0);break;default:console.warn("THREE.Euler: .setFromRotationMatrix() encountered an unknown order: "+t)}return this._order=t,!0===n&&this._onChangeCallback(),this}setFromQuaternion(e,t,n){return Hn.makeRotationFromQuaternion(e),this.setFromRotationMatrix(Hn,t,n)}setFromVector3(e,t=this._order){return this.set(e.x,e.y,e.z,t)}reorder(e){return Vn.setFromEuler(this),this.setFromQuaternion(Vn,e)}equals(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._order===this._order}fromArray(e){return this._x=e[0],this._y=e[1],this._z=e[2],void 0!==e[3]&&(this._order=e[3]),this._onChangeCallback(),this}toArray(e=[],t=0){return e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._order,e}_onChange(e){return this._onChangeCallback=e,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._order}}jn.DEFAULT_ORDER="XYZ";class qn{constructor(){this.mask=1}set(e){this.mask=1<<e>>>0}enable(e){this.mask|=1<<e}enableAll(){this.mask=-1}toggle(e){this.mask^=1<<e}disable(e){this.mask&=~(1<<e)}disableAll(){this.mask=0}test(e){return!!(this.mask&e.mask)}isEnabled(e){return!!(this.mask&1<<e)}}let Wn=0;const Yn=new sn,Xn=new rn,Kn=new Nn,Jn=new sn,$n=new sn,Zn=new sn,ei=new rn,ti=new sn(1,0,0),ni=new sn(0,1,0),ii=new sn(0,0,1),ri={type:"added"},si={type:"removed"},ai={type:"childadded",child:null},oi={type:"childremoved",child:null};class li extends At{constructor(){super(),this.isObject3D=!0,Object.defineProperty(this,"id",{value:Wn++}),this.uuid=Et(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=li.DEFAULT_UP.clone();const e=new sn,t=new jn,n=new rn,i=new sn(1,1,1);t._onChange((function(){n.setFromEuler(t,!1)})),n._onChange((function(){t.setFromQuaternion(n,void 0,!1)})),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:e},rotation:{configurable:!0,enumerable:!0,value:t},quaternion:{configurable:!0,enumerable:!0,value:n},scale:{configurable:!0,enumerable:!0,value:i},modelViewMatrix:{value:new Nn},normalMatrix:{value:new Rt}}),this.matrix=new Nn,this.matrixWorld=new Nn,this.matrixAutoUpdate=li.DEFAULT_MATRIX_AUTO_UPDATE,this.matrixWorldAutoUpdate=li.DEFAULT_MATRIX_WORLD_AUTO_UPDATE,this.matrixWorldNeedsUpdate=!1,this.layers=new qn,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.animations=[],this.userData={}}onBeforeShadow(){}onAfterShadow(){}onBeforeRender(){}onAfterRender(){}applyMatrix4(e){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(e),this.matrix.decompose(this.position,this.quaternion,this.scale)}applyQuaternion(e){return this.quaternion.premultiply(e),this}setRotationFromAxisAngle(e,t){this.quaternion.setFromAxisAngle(e,t)}setRotationFromEuler(e){this.quaternion.setFromEuler(e,!0)}setRotationFromMatrix(e){this.quaternion.setFromRotationMatrix(e)}setRotationFromQuaternion(e){this.quaternion.copy(e)}rotateOnAxis(e,t){return Xn.setFromAxisAngle(e,t),this.quaternion.multiply(Xn),this}rotateOnWorldAxis(e,t){return Xn.setFromAxisAngle(e,t),this.quaternion.premultiply(Xn),this}rotateX(e){return this.rotateOnAxis(ti,e)}rotateY(e){return this.rotateOnAxis(ni,e)}rotateZ(e){return this.rotateOnAxis(ii,e)}translateOnAxis(e,t){return Yn.copy(e).applyQuaternion(this.quaternion),this.position.add(Yn.multiplyScalar(t)),this}translateX(e){return this.translateOnAxis(ti,e)}translateY(e){return this.translateOnAxis(ni,e)}translateZ(e){return this.translateOnAxis(ii,e)}localToWorld(e){return this.updateWorldMatrix(!0,!1),e.applyMatrix4(this.matrixWorld)}worldToLocal(e){return this.updateWorldMatrix(!0,!1),e.applyMatrix4(Kn.copy(this.matrixWorld).invert())}lookAt(e,t,n){e.isVector3?Jn.copy(e):Jn.set(e,t,n);const i=this.parent;this.updateWorldMatrix(!0,!1),$n.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?Kn.lookAt($n,Jn,this.up):Kn.lookAt(Jn,$n,this.up),this.quaternion.setFromRotationMatrix(Kn),i&&(Kn.extractRotation(i.matrixWorld),Xn.setFromRotationMatrix(Kn),this.quaternion.premultiply(Xn.invert()))}add(e){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.add(arguments[e]);return this}return e===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",e),this):(e&&e.isObject3D?(e.removeFromParent(),e.parent=this,this.children.push(e),e.dispatchEvent(ri),ai.child=e,this.dispatchEvent(ai),ai.child=null):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",e),this)}remove(e){if(arguments.length>1){for(let e=0;e<arguments.length;e++)this.remove(arguments[e]);return this}const t=this.children.indexOf(e);return-1!==t&&(e.parent=null,this.children.splice(t,1),e.dispatchEvent(si),oi.child=e,this.dispatchEvent(oi),oi.child=null),this}removeFromParent(){const e=this.parent;return null!==e&&e.remove(this),this}clear(){return this.remove(...this.children)}attach(e){return this.updateWorldMatrix(!0,!1),Kn.copy(this.matrixWorld).invert(),null!==e.parent&&(e.parent.updateWorldMatrix(!0,!1),Kn.multiply(e.parent.matrixWorld)),e.applyMatrix4(Kn),e.removeFromParent(),e.parent=this,this.children.push(e),e.updateWorldMatrix(!1,!0),e.dispatchEvent(ri),ai.child=e,this.dispatchEvent(ai),ai.child=null,this}getObjectById(e){return this.getObjectByProperty("id",e)}getObjectByName(e){return this.getObjectByProperty("name",e)}getObjectByProperty(e,t){if(this[e]===t)return this;for(let n=0,i=this.children.length;n<i;n++){const i=this.children[n].getObjectByProperty(e,t);if(void 0!==i)return i}}getObjectsByProperty(e,t,n=[]){this[e]===t&&n.push(this);const i=this.children;for(let r=0,s=i.length;r<s;r++)i[r].getObjectsByProperty(e,t,n);return n}getWorldPosition(e){return this.updateWorldMatrix(!0,!1),e.setFromMatrixPosition(this.matrixWorld)}getWorldQuaternion(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose($n,e,Zn),e}getWorldScale(e){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose($n,ei,e),e}getWorldDirection(e){this.updateWorldMatrix(!0,!1);const t=this.matrixWorld.elements;return e.set(t[8],t[9],t[10]).normalize()}raycast(){}traverse(e){e(this);const t=this.children;for(let n=0,i=t.length;n<i;n++)t[n].traverse(e)}traverseVisible(e){if(!1===this.visible)return;e(this);const t=this.children;for(let n=0,i=t.length;n<i;n++)t[n].traverseVisible(e)}traverseAncestors(e){const t=this.parent;null!==t&&(e(t),t.traverseAncestors(e))}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(e){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||e)&&(!0===this.matrixWorldAutoUpdate&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),this.matrixWorldNeedsUpdate=!1,e=!0);const t=this.children;for(let n=0,i=t.length;n<i;n++)t[n].updateMatrixWorld(e)}updateWorldMatrix(e,t){const n=this.parent;if(!0===e&&null!==n&&n.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),!0===this.matrixWorldAutoUpdate&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix)),!0===t){const e=this.children;for(let t=0,n=e.length;t<n;t++)e[t].updateWorldMatrix(!1,!0)}}toJSON(e){const t=void 0===e||"string"==typeof e,n={};t&&(e={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}},n.metadata={version:4.6,type:"Object",generator:"Object3D.toJSON"});const i={};function r(t,n){return void 0===t[n.uuid]&&(t[n.uuid]=n.toJSON(e)),n.uuid}if(i.uuid=this.uuid,i.type=this.type,""!==this.name&&(i.name=this.name),!0===this.castShadow&&(i.castShadow=!0),!0===this.receiveShadow&&(i.receiveShadow=!0),!1===this.visible&&(i.visible=!1),!1===this.frustumCulled&&(i.frustumCulled=!1),0!==this.renderOrder&&(i.renderOrder=this.renderOrder),Object.keys(this.userData).length>0&&(i.userData=this.userData),i.layers=this.layers.mask,i.matrix=this.matrix.toArray(),i.up=this.up.toArray(),!1===this.matrixAutoUpdate&&(i.matrixAutoUpdate=!1),this.isInstancedMesh&&(i.type="InstancedMesh",i.count=this.count,i.instanceMatrix=this.instanceMatrix.toJSON(),null!==this.instanceColor&&(i.instanceColor=this.instanceColor.toJSON())),this.isBatchedMesh&&(i.type="BatchedMesh",i.perObjectFrustumCulled=this.perObjectFrustumCulled,i.sortObjects=this.sortObjects,i.drawRanges=this._drawRanges,i.reservedRanges=this._reservedRanges,i.visibility=this._visibility,i.active=this._active,i.bounds=this._bounds.map((e=>({boxInitialized:e.boxInitialized,boxMin:e.box.min.toArray(),boxMax:e.box.max.toArray(),sphereInitialized:e.sphereInitialized,sphereRadius:e.sphere.radius,sphereCenter:e.sphere.center.toArray()}))),i.maxInstanceCount=this._maxInstanceCount,i.maxVertexCount=this._maxVertexCount,i.maxIndexCount=this._maxIndexCount,i.geometryInitialized=this._geometryInitialized,i.geometryCount=this._geometryCount,i.matricesTexture=this._matricesTexture.toJSON(e),null!==this._colorsTexture&&(i.colorsTexture=this._colorsTexture.toJSON(e)),null!==this.boundingSphere&&(i.boundingSphere={center:i.boundingSphere.center.toArray(),radius:i.boundingSphere.radius}),null!==this.boundingBox&&(i.boundingBox={min:i.boundingBox.min.toArray(),max:i.boundingBox.max.toArray()})),this.isScene)this.background&&(this.background.isColor?i.background=this.background.toJSON():this.background.isTexture&&(i.background=this.background.toJSON(e).uuid)),this.environment&&this.environment.isTexture&&!0!==this.environment.isRenderTargetTexture&&(i.environment=this.environment.toJSON(e).uuid);else if(this.isMesh||this.isLine||this.isPoints){i.geometry=r(e.geometries,this.geometry);const t=this.geometry.parameters;if(void 0!==t&&void 0!==t.shapes){const n=t.shapes;if(Array.isArray(n))for(let t=0,i=n.length;t<i;t++){const i=n[t];r(e.shapes,i)}else r(e.shapes,n)}}if(this.isSkinnedMesh&&(i.bindMode=this.bindMode,i.bindMatrix=this.bindMatrix.toArray(),void 0!==this.skeleton&&(r(e.skeletons,this.skeleton),i.skeleton=this.skeleton.uuid)),void 0!==this.material)if(Array.isArray(this.material)){const t=[];for(let n=0,i=this.material.length;n<i;n++)t.push(r(e.materials,this.material[n]));i.material=t}else i.material=r(e.materials,this.material);if(this.children.length>0){i.children=[];for(let t=0;t<this.children.length;t++)i.children.push(this.children[t].toJSON(e).object)}if(this.animations.length>0){i.animations=[];for(let t=0;t<this.animations.length;t++){const n=this.animations[t];i.animations.push(r(e.animations,n))}}if(t){const t=s(e.geometries),i=s(e.materials),r=s(e.textures),a=s(e.images),o=s(e.shapes),l=s(e.skeletons),c=s(e.animations),h=s(e.nodes);t.length>0&&(n.geometries=t),i.length>0&&(n.materials=i),r.length>0&&(n.textures=r),a.length>0&&(n.images=a),o.length>0&&(n.shapes=o),l.length>0&&(n.skeletons=l),c.length>0&&(n.animations=c),h.length>0&&(n.nodes=h)}return n.object=i,n;function s(e){const t=[];for(const n in e){const i=e[n];delete i.metadata,t.push(i)}return t}}clone(e){return(new this.constructor).copy(this,e)}copy(e,t=!0){if(this.name=e.name,this.up.copy(e.up),this.position.copy(e.position),this.rotation.order=e.rotation.order,this.quaternion.copy(e.quaternion),this.scale.copy(e.scale),this.matrix.copy(e.matrix),this.matrixWorld.copy(e.matrixWorld),this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrixWorldAutoUpdate=e.matrixWorldAutoUpdate,this.matrixWorldNeedsUpdate=e.matrixWorldNeedsUpdate,this.layers.mask=e.layers.mask,this.visible=e.visible,this.castShadow=e.castShadow,this.receiveShadow=e.receiveShadow,this.frustumCulled=e.frustumCulled,this.renderOrder=e.renderOrder,this.animations=e.animations.slice(),this.userData=JSON.parse(JSON.stringify(e.userData)),!0===t)for(let t=0;t<e.children.length;t++){const n=e.children[t];this.add(n.clone())}return this}}li.DEFAULT_UP=new sn(0,1,0),li.DEFAULT_MATRIX_AUTO_UPDATE=!0,li.DEFAULT_MATRIX_WORLD_AUTO_UPDATE=!0;const ci=new sn,hi=new sn,ui=new sn,di=new sn,pi=new sn,fi=new sn,mi=new sn,gi=new sn,Ai=new sn,yi=new sn,vi=new $t,_i=new $t,xi=new $t;class Ei{constructor(e=new sn,t=new sn,n=new sn){this.a=e,this.b=t,this.c=n}static getNormal(e,t,n,i){i.subVectors(n,t),ci.subVectors(e,t),i.cross(ci);const r=i.lengthSq();return r>0?i.multiplyScalar(1/Math.sqrt(r)):i.set(0,0,0)}static getBarycoord(e,t,n,i,r){ci.subVectors(i,t),hi.subVectors(n,t),ui.subVectors(e,t);const s=ci.dot(ci),a=ci.dot(hi),o=ci.dot(ui),l=hi.dot(hi),c=hi.dot(ui),h=s*l-a*a;if(0===h)return r.set(0,0,0),null;const u=1/h,d=(l*o-a*c)*u,p=(s*c-a*o)*u;return r.set(1-d-p,p,d)}static containsPoint(e,t,n,i){return null!==this.getBarycoord(e,t,n,i,di)&&di.x>=0&&di.y>=0&&di.x+di.y<=1}static getInterpolation(e,t,n,i,r,s,a,o){return null===this.getBarycoord(e,t,n,i,di)?(o.x=0,o.y=0,"z"in o&&(o.z=0),"w"in o&&(o.w=0),null):(o.setScalar(0),o.addScaledVector(r,di.x),o.addScaledVector(s,di.y),o.addScaledVector(a,di.z),o)}static getInterpolatedAttribute(e,t,n,i,r,s){return vi.setScalar(0),_i.setScalar(0),xi.setScalar(0),vi.fromBufferAttribute(e,t),_i.fromBufferAttribute(e,n),xi.fromBufferAttribute(e,i),s.setScalar(0),s.addScaledVector(vi,r.x),s.addScaledVector(_i,r.y),s.addScaledVector(xi,r.z),s}static isFrontFacing(e,t,n,i){return ci.subVectors(n,t),hi.subVectors(e,t),ci.cross(hi).dot(i)<0}set(e,t,n){return this.a.copy(e),this.b.copy(t),this.c.copy(n),this}setFromPointsAndIndices(e,t,n,i){return this.a.copy(e[t]),this.b.copy(e[n]),this.c.copy(e[i]),this}setFromAttributeAndIndices(e,t,n,i){return this.a.fromBufferAttribute(e,t),this.b.fromBufferAttribute(e,n),this.c.fromBufferAttribute(e,i),this}clone(){return(new this.constructor).copy(this)}copy(e){return this.a.copy(e.a),this.b.copy(e.b),this.c.copy(e.c),this}getArea(){return ci.subVectors(this.c,this.b),hi.subVectors(this.a,this.b),.5*ci.cross(hi).length()}getMidpoint(e){return e.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)}getNormal(e){return Ei.getNormal(this.a,this.b,this.c,e)}getPlane(e){return e.setFromCoplanarPoints(this.a,this.b,this.c)}getBarycoord(e,t){return Ei.getBarycoord(e,this.a,this.b,this.c,t)}getInterpolation(e,t,n,i,r){return Ei.getInterpolation(e,this.a,this.b,this.c,t,n,i,r)}containsPoint(e){return Ei.containsPoint(e,this.a,this.b,this.c)}isFrontFacing(e){return Ei.isFrontFacing(this.a,this.b,this.c,e)}intersectsBox(e){return e.intersectsTriangle(this)}closestPointToPoint(e,t){const n=this.a,i=this.b,r=this.c;let s,a;pi.subVectors(i,n),fi.subVectors(r,n),gi.subVectors(e,n);const o=pi.dot(gi),l=fi.dot(gi);if(o<=0&&l<=0)return t.copy(n);Ai.subVectors(e,i);const c=pi.dot(Ai),h=fi.dot(Ai);if(c>=0&&h<=c)return t.copy(i);const u=o*h-c*l;if(u<=0&&o>=0&&c<=0)return s=o/(o-c),t.copy(n).addScaledVector(pi,s);yi.subVectors(e,r);const d=pi.dot(yi),p=fi.dot(yi);if(p>=0&&d<=p)return t.copy(r);const f=d*l-o*p;if(f<=0&&l>=0&&p<=0)return a=l/(l-p),t.copy(n).addScaledVector(fi,a);const m=c*p-d*h;if(m<=0&&h-c>=0&&d-p>=0)return mi.subVectors(r,i),a=(h-c)/(h-c+(d-p)),t.copy(i).addScaledVector(mi,a);const g=1/(m+f+u);return s=f*g,a=u*g,t.copy(n).addScaledVector(pi,s).addScaledVector(fi,a)}equals(e){return e.a.equals(this.a)&&e.b.equals(this.b)&&e.c.equals(this.c)}}const bi={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},wi={h:0,s:0,l:0},Mi={h:0,s:0,l:0};function Si(e,t,n){return n<0&&(n+=1),n>1&&(n-=1),n<1/6?e+6*(t-e)*n:n<.5?t:n<2/3?e+6*(t-e)*(2/3-n):e}class Ci{constructor(e,t,n){return this.isColor=!0,this.r=1,this.g=1,this.b=1,this.set(e,t,n)}set(e,t,n){if(void 0===t&&void 0===n){const t=e;t&&t.isColor?this.copy(t):"number"==typeof t?this.setHex(t):"string"==typeof t&&this.setStyle(t)}else this.setRGB(e,t,n);return this}setScalar(e){return this.r=e,this.g=e,this.b=e,this}setHex(e,t=et){return e=Math.floor(e),this.r=(e>>16&255)/255,this.g=(e>>8&255)/255,this.b=(255&e)/255,Ot.toWorkingColorSpace(this,t),this}setRGB(e,t,n,i=Ot.workingColorSpace){return this.r=e,this.g=t,this.b=n,Ot.toWorkingColorSpace(this,i),this}setHSL(e,t,n,i=Ot.workingColorSpace){if(e=wt(e,1),t=bt(t,0,1),n=bt(n,0,1),0===t)this.r=this.g=this.b=n;else{const i=n<=.5?n*(1+t):n+t-n*t,r=2*n-i;this.r=Si(r,i,e+1/3),this.g=Si(r,i,e),this.b=Si(r,i,e-1/3)}return Ot.toWorkingColorSpace(this,i),this}setStyle(e,t=et){function n(t){void 0!==t&&parseFloat(t)<1&&console.warn("THREE.Color: Alpha component of "+e+" will be ignored.")}let i;if(i=/^(\w+)\(([^\)]*)\)/.exec(e)){let r;const s=i[1],a=i[2];switch(s){case"rgb":case"rgba":if(r=/^\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(a))return n(r[4]),this.setRGB(Math.min(255,parseInt(r[1],10))/255,Math.min(255,parseInt(r[2],10))/255,Math.min(255,parseInt(r[3],10))/255,t);if(r=/^\s*(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(a))return n(r[4]),this.setRGB(Math.min(100,parseInt(r[1],10))/100,Math.min(100,parseInt(r[2],10))/100,Math.min(100,parseInt(r[3],10))/100,t);break;case"hsl":case"hsla":if(r=/^\s*(\d*\.?\d+)\s*,\s*(\d*\.?\d+)\%\s*,\s*(\d*\.?\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(a))return n(r[4]),this.setHSL(parseFloat(r[1])/360,parseFloat(r[2])/100,parseFloat(r[3])/100,t);break;default:console.warn("THREE.Color: Unknown color model "+e)}}else if(i=/^\#([A-Fa-f\d]+)$/.exec(e)){const n=i[1],r=n.length;if(3===r)return this.setRGB(parseInt(n.charAt(0),16)/15,parseInt(n.charAt(1),16)/15,parseInt(n.charAt(2),16)/15,t);if(6===r)return this.setHex(parseInt(n,16),t);console.warn("THREE.Color: Invalid hex color "+e)}else if(e&&e.length>0)return this.setColorName(e,t);return this}setColorName(e,t=et){const n=bi[e.toLowerCase()];return void 0!==n?this.setHex(n,t):console.warn("THREE.Color: Unknown color "+e),this}clone(){return new this.constructor(this.r,this.g,this.b)}copy(e){return this.r=e.r,this.g=e.g,this.b=e.b,this}copySRGBToLinear(e){return this.r=Ft(e.r),this.g=Ft(e.g),this.b=Ft(e.b),this}copyLinearToSRGB(e){return this.r=kt(e.r),this.g=kt(e.g),this.b=kt(e.b),this}convertSRGBToLinear(){return this.copySRGBToLinear(this),this}convertLinearToSRGB(){return this.copyLinearToSRGB(this),this}getHex(e=et){return Ot.fromWorkingColorSpace(Ti.copy(this),e),65536*Math.round(bt(255*Ti.r,0,255))+256*Math.round(bt(255*Ti.g,0,255))+Math.round(bt(255*Ti.b,0,255))}getHexString(e=et){return("000000"+this.getHex(e).toString(16)).slice(-6)}getHSL(e,t=Ot.workingColorSpace){Ot.fromWorkingColorSpace(Ti.copy(this),t);const n=Ti.r,i=Ti.g,r=Ti.b,s=Math.max(n,i,r),a=Math.min(n,i,r);let o,l;const c=(a+s)/2;if(a===s)o=0,l=0;else{const e=s-a;switch(l=c<=.5?e/(s+a):e/(2-s-a),s){case n:o=(i-r)/e+(i<r?6:0);break;case i:o=(r-n)/e+2;break;case r:o=(n-i)/e+4}o/=6}return e.h=o,e.s=l,e.l=c,e}getRGB(e,t=Ot.workingColorSpace){return Ot.fromWorkingColorSpace(Ti.copy(this),t),e.r=Ti.r,e.g=Ti.g,e.b=Ti.b,e}getStyle(e=et){Ot.fromWorkingColorSpace(Ti.copy(this),e);const t=Ti.r,n=Ti.g,i=Ti.b;return e!==et?`color(${e} ${t.toFixed(3)} ${n.toFixed(3)} ${i.toFixed(3)})`:`rgb(${Math.round(255*t)},${Math.round(255*n)},${Math.round(255*i)})`}offsetHSL(e,t,n){return this.getHSL(wi),this.setHSL(wi.h+e,wi.s+t,wi.l+n)}add(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this}addColors(e,t){return this.r=e.r+t.r,this.g=e.g+t.g,this.b=e.b+t.b,this}addScalar(e){return this.r+=e,this.g+=e,this.b+=e,this}sub(e){return this.r=Math.max(0,this.r-e.r),this.g=Math.max(0,this.g-e.g),this.b=Math.max(0,this.b-e.b),this}multiply(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this}multiplyScalar(e){return this.r*=e,this.g*=e,this.b*=e,this}lerp(e,t){return this.r+=(e.r-this.r)*t,this.g+=(e.g-this.g)*t,this.b+=(e.b-this.b)*t,this}lerpColors(e,t,n){return this.r=e.r+(t.r-e.r)*n,this.g=e.g+(t.g-e.g)*n,this.b=e.b+(t.b-e.b)*n,this}lerpHSL(e,t){this.getHSL(wi),e.getHSL(Mi);const n=Mt(wi.h,Mi.h,t),i=Mt(wi.s,Mi.s,t),r=Mt(wi.l,Mi.l,t);return this.setHSL(n,i,r),this}setFromVector3(e){return this.r=e.x,this.g=e.y,this.b=e.z,this}applyMatrix3(e){const t=this.r,n=this.g,i=this.b,r=e.elements;return this.r=r[0]*t+r[3]*n+r[6]*i,this.g=r[1]*t+r[4]*n+r[7]*i,this.b=r[2]*t+r[5]*n+r[8]*i,this}equals(e){return e.r===this.r&&e.g===this.g&&e.b===this.b}fromArray(e,t=0){return this.r=e[t],this.g=e[t+1],this.b=e[t+2],this}toArray(e=[],t=0){return e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e}fromBufferAttribute(e,t){return this.r=e.getX(t),this.g=e.getY(t),this.b=e.getZ(t),this}toJSON(){return this.getHex()}*[Symbol.iterator](){yield this.r,yield this.g,yield this.b}}const Ti=new Ci;Ci.NAMES=bi;let Ii=0;class Ri extends At{static get type(){return"Material"}get type(){return this.constructor.type}set type(e){}constructor(){super(),this.isMaterial=!0,Object.defineProperty(this,"id",{value:Ii++}),this.uuid=Et(),this.name="",this.blending=l,this.side=r,this.vertexColors=!1,this.opacity=1,this.transparent=!1,this.alphaHash=!1,this.blendSrc=y,this.blendDst=v,this.blendEquation=u,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.blendColor=new Ci(0,0,0),this.blendAlpha=0,this.depthFunc=L,this.depthTest=!0,this.depthWrite=!0,this.stencilWriteMask=255,this.stencilFunc=519,this.stencilRef=0,this.stencilFuncMask=255,this.stencilFail=rt,this.stencilZFail=rt,this.stencilZPass=rt,this.stencilWrite=!1,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.shadowSide=null,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.dithering=!1,this.alphaToCoverage=!1,this.premultipliedAlpha=!1,this.forceSinglePass=!1,this.visible=!0,this.toneMapped=!0,this.userData={},this.version=0,this._alphaTest=0}get alphaTest(){return this._alphaTest}set alphaTest(e){this._alphaTest>0!=e>0&&this.version++,this._alphaTest=e}onBeforeRender(){}onBeforeCompile(){}customProgramCacheKey(){return this.onBeforeCompile.toString()}setValues(e){if(void 0!==e)for(const t in e){const n=e[t];if(void 0===n){console.warn(`THREE.Material: parameter '${t}' has value of undefined.`);continue}const i=this[t];void 0!==i?i&&i.isColor?i.set(n):i&&i.isVector3&&n&&n.isVector3?i.copy(n):this[t]=n:console.warn(`THREE.Material: '${t}' is not a property of THREE.${this.type}.`)}}toJSON(e){const t=void 0===e||"string"==typeof e;t&&(e={textures:{},images:{}});const n={metadata:{version:4.6,type:"Material",generator:"Material.toJSON"}};function i(e){const t=[];for(const n in e){const i=e[n];delete i.metadata,t.push(i)}return t}if(n.uuid=this.uuid,n.type=this.type,""!==this.name&&(n.name=this.name),this.color&&this.color.isColor&&(n.color=this.color.getHex()),void 0!==this.roughness&&(n.roughness=this.roughness),void 0!==this.metalness&&(n.metalness=this.metalness),void 0!==this.sheen&&(n.sheen=this.sheen),this.sheenColor&&this.sheenColor.isColor&&(n.sheenColor=this.sheenColor.getHex()),void 0!==this.sheenRoughness&&(n.sheenRoughness=this.sheenRoughness),this.emissive&&this.emissive.isColor&&(n.emissive=this.emissive.getHex()),void 0!==this.emissiveIntensity&&1!==this.emissiveIntensity&&(n.emissiveIntensity=this.emissiveIntensity),this.specular&&this.specular.isColor&&(n.specular=this.specular.getHex()),void 0!==this.specularIntensity&&(n.specularIntensity=this.specularIntensity),this.specularColor&&this.specularColor.isColor&&(n.specularColor=this.specularColor.getHex()),void 0!==this.shininess&&(n.shininess=this.shininess),void 0!==this.clearcoat&&(n.clearcoat=this.clearcoat),void 0!==this.clearcoatRoughness&&(n.clearcoatRoughness=this.clearcoatRoughness),this.clearcoatMap&&this.clearcoatMap.isTexture&&(n.clearcoatMap=this.clearcoatMap.toJSON(e).uuid),this.clearcoatRoughnessMap&&this.clearcoatRoughnessMap.isTexture&&(n.clearcoatRoughnessMap=this.clearcoatRoughnessMap.toJSON(e).uuid),this.clearcoatNormalMap&&this.clearcoatNormalMap.isTexture&&(n.clearcoatNormalMap=this.clearcoatNormalMap.toJSON(e).uuid,n.clearcoatNormalScale=this.clearcoatNormalScale.toArray()),void 0!==this.dispersion&&(n.dispersion=this.dispersion),void 0!==this.iridescence&&(n.iridescence=this.iridescence),void 0!==this.iridescenceIOR&&(n.iridescenceIOR=this.iridescenceIOR),void 0!==this.iridescenceThicknessRange&&(n.iridescenceThicknessRange=this.iridescenceThicknessRange),this.iridescenceMap&&this.iridescenceMap.isTexture&&(n.iridescenceMap=this.iridescenceMap.toJSON(e).uuid),this.iridescenceThicknessMap&&this.iridescenceThicknessMap.isTexture&&(n.iridescenceThicknessMap=this.iridescenceThicknessMap.toJSON(e).uuid),void 0!==this.anisotropy&&(n.anisotropy=this.anisotropy),void 0!==this.anisotropyRotation&&(n.anisotropyRotation=this.anisotropyRotation),this.anisotropyMap&&this.anisotropyMap.isTexture&&(n.anisotropyMap=this.anisotropyMap.toJSON(e).uuid),this.map&&this.map.isTexture&&(n.map=this.map.toJSON(e).uuid),this.matcap&&this.matcap.isTexture&&(n.matcap=this.matcap.toJSON(e).uuid),this.alphaMap&&this.alphaMap.isTexture&&(n.alphaMap=this.alphaMap.toJSON(e).uuid),this.lightMap&&this.lightMap.isTexture&&(n.lightMap=this.lightMap.toJSON(e).uuid,n.lightMapIntensity=this.lightMapIntensity),this.aoMap&&this.aoMap.isTexture&&(n.aoMap=this.aoMap.toJSON(e).uuid,n.aoMapIntensity=this.aoMapIntensity),this.bumpMap&&this.bumpMap.isTexture&&(n.bumpMap=this.bumpMap.toJSON(e).uuid,n.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(n.normalMap=this.normalMap.toJSON(e).uuid,n.normalMapType=this.normalMapType,n.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(n.displacementMap=this.displacementMap.toJSON(e).uuid,n.displacementScale=this.displacementScale,n.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(n.roughnessMap=this.roughnessMap.toJSON(e).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(n.metalnessMap=this.metalnessMap.toJSON(e).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(n.emissiveMap=this.emissiveMap.toJSON(e).uuid),this.specularMap&&this.specularMap.isTexture&&(n.specularMap=this.specularMap.toJSON(e).uuid),this.specularIntensityMap&&this.specularIntensityMap.isTexture&&(n.specularIntensityMap=this.specularIntensityMap.toJSON(e).uuid),this.specularColorMap&&this.specularColorMap.isTexture&&(n.specularColorMap=this.specularColorMap.toJSON(e).uuid),this.envMap&&this.envMap.isTexture&&(n.envMap=this.envMap.toJSON(e).uuid,void 0!==this.combine&&(n.combine=this.combine)),void 0!==this.envMapRotation&&(n.envMapRotation=this.envMapRotation.toArray()),void 0!==this.envMapIntensity&&(n.envMapIntensity=this.envMapIntensity),void 0!==this.reflectivity&&(n.reflectivity=this.reflectivity),void 0!==this.refractionRatio&&(n.refractionRatio=this.refractionRatio),this.gradientMap&&this.gradientMap.isTexture&&(n.gradientMap=this.gradientMap.toJSON(e).uuid),void 0!==this.transmission&&(n.transmission=this.transmission),this.transmissionMap&&this.transmissionMap.isTexture&&(n.transmissionMap=this.transmissionMap.toJSON(e).uuid),void 0!==this.thickness&&(n.thickness=this.thickness),this.thicknessMap&&this.thicknessMap.isTexture&&(n.thicknessMap=this.thicknessMap.toJSON(e).uuid),void 0!==this.attenuationDistance&&this.attenuationDistance!==1/0&&(n.attenuationDistance=this.attenuationDistance),void 0!==this.attenuationColor&&(n.attenuationColor=this.attenuationColor.getHex()),void 0!==this.size&&(n.size=this.size),null!==this.shadowSide&&(n.shadowSide=this.shadowSide),void 0!==this.sizeAttenuation&&(n.sizeAttenuation=this.sizeAttenuation),this.blending!==l&&(n.blending=this.blending),this.side!==r&&(n.side=this.side),!0===this.vertexColors&&(n.vertexColors=!0),this.opacity<1&&(n.opacity=this.opacity),!0===this.transparent&&(n.transparent=!0),this.blendSrc!==y&&(n.blendSrc=this.blendSrc),this.blendDst!==v&&(n.blendDst=this.blendDst),this.blendEquation!==u&&(n.blendEquation=this.blendEquation),null!==this.blendSrcAlpha&&(n.blendSrcAlpha=this.blendSrcAlpha),null!==this.blendDstAlpha&&(n.blendDstAlpha=this.blendDstAlpha),null!==this.blendEquationAlpha&&(n.blendEquationAlpha=this.blendEquationAlpha),this.blendColor&&this.blendColor.isColor&&(n.blendColor=this.blendColor.getHex()),0!==this.blendAlpha&&(n.blendAlpha=this.blendAlpha),this.depthFunc!==L&&(n.depthFunc=this.depthFunc),!1===this.depthTest&&(n.depthTest=this.depthTest),!1===this.depthWrite&&(n.depthWrite=this.depthWrite),!1===this.colorWrite&&(n.colorWrite=this.colorWrite),255!==this.stencilWriteMask&&(n.stencilWriteMask=this.stencilWriteMask),519!==this.stencilFunc&&(n.stencilFunc=this.stencilFunc),0!==this.stencilRef&&(n.stencilRef=this.stencilRef),255!==this.stencilFuncMask&&(n.stencilFuncMask=this.stencilFuncMask),this.stencilFail!==rt&&(n.stencilFail=this.stencilFail),this.stencilZFail!==rt&&(n.stencilZFail=this.stencilZFail),this.stencilZPass!==rt&&(n.stencilZPass=this.stencilZPass),!0===this.stencilWrite&&(n.stencilWrite=this.stencilWrite),void 0!==this.rotation&&0!==this.rotation&&(n.rotation=this.rotation),!0===this.polygonOffset&&(n.polygonOffset=!0),0!==this.polygonOffsetFactor&&(n.polygonOffsetFactor=this.polygonOffsetFactor),0!==this.polygonOffsetUnits&&(n.polygonOffsetUnits=this.polygonOffsetUnits),void 0!==this.linewidth&&1!==this.linewidth&&(n.linewidth=this.linewidth),void 0!==this.dashSize&&(n.dashSize=this.dashSize),void 0!==this.gapSize&&(n.gapSize=this.gapSize),void 0!==this.scale&&(n.scale=this.scale),!0===this.dithering&&(n.dithering=!0),this.alphaTest>0&&(n.alphaTest=this.alphaTest),!0===this.alphaHash&&(n.alphaHash=!0),!0===this.alphaToCoverage&&(n.alphaToCoverage=!0),!0===this.premultipliedAlpha&&(n.premultipliedAlpha=!0),!0===this.forceSinglePass&&(n.forceSinglePass=!0),!0===this.wireframe&&(n.wireframe=!0),this.wireframeLinewidth>1&&(n.wireframeLinewidth=this.wireframeLinewidth),"round"!==this.wireframeLinecap&&(n.wireframeLinecap=this.wireframeLinecap),"round"!==this.wireframeLinejoin&&(n.wireframeLinejoin=this.wireframeLinejoin),!0===this.flatShading&&(n.flatShading=!0),!1===this.visible&&(n.visible=!1),!1===this.toneMapped&&(n.toneMapped=!1),!1===this.fog&&(n.fog=!1),Object.keys(this.userData).length>0&&(n.userData=this.userData),t){const t=i(e.textures),r=i(e.images);t.length>0&&(n.textures=t),r.length>0&&(n.images=r)}return n}clone(){return(new this.constructor).copy(this)}copy(e){this.name=e.name,this.blending=e.blending,this.side=e.side,this.vertexColors=e.vertexColors,this.opacity=e.opacity,this.transparent=e.transparent,this.blendSrc=e.blendSrc,this.blendDst=e.blendDst,this.blendEquation=e.blendEquation,this.blendSrcAlpha=e.blendSrcAlpha,this.blendDstAlpha=e.blendDstAlpha,this.blendEquationAlpha=e.blendEquationAlpha,this.blendColor.copy(e.blendColor),this.blendAlpha=e.blendAlpha,this.depthFunc=e.depthFunc,this.depthTest=e.depthTest,this.depthWrite=e.depthWrite,this.stencilWriteMask=e.stencilWriteMask,this.stencilFunc=e.stencilFunc,this.stencilRef=e.stencilRef,this.stencilFuncMask=e.stencilFuncMask,this.stencilFail=e.stencilFail,this.stencilZFail=e.stencilZFail,this.stencilZPass=e.stencilZPass,this.stencilWrite=e.stencilWrite;const t=e.clippingPlanes;let n=null;if(null!==t){const e=t.length;n=new Array(e);for(let i=0;i!==e;++i)n[i]=t[i].clone()}return this.clippingPlanes=n,this.clipIntersection=e.clipIntersection,this.clipShadows=e.clipShadows,this.shadowSide=e.shadowSide,this.colorWrite=e.colorWrite,this.precision=e.precision,this.polygonOffset=e.polygonOffset,this.polygonOffsetFactor=e.polygonOffsetFactor,this.polygonOffsetUnits=e.polygonOffsetUnits,this.dithering=e.dithering,this.alphaTest=e.alphaTest,this.alphaHash=e.alphaHash,this.alphaToCoverage=e.alphaToCoverage,this.premultipliedAlpha=e.premultipliedAlpha,this.forceSinglePass=e.forceSinglePass,this.visible=e.visible,this.toneMapped=e.toneMapped,this.userData=JSON.parse(JSON.stringify(e.userData)),this}dispose(){this.dispatchEvent({type:"dispose"})}set needsUpdate(e){!0===e&&this.version++}onBuild(){console.warn("Material: onBuild() has been removed.")}}class Bi extends Ri{static get type(){return"MeshBasicMaterial"}constructor(e){super(),this.isMeshBasicMaterial=!0,this.color=new Ci(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new jn,this.combine=0,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapRotation.copy(e.envMapRotation),this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.fog=e.fog,this}}const Li=new sn,Pi=new It;class Di{constructor(e,t,n=!1){if(Array.isArray(e))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.isBufferAttribute=!0,this.name="",this.array=e,this.itemSize=t,this.count=void 0!==e?e.length/t:0,this.normalized=n,this.usage=pt,this.updateRanges=[],this.gpuType=ee,this.version=0}onUploadCallback(){}set needsUpdate(e){!0===e&&this.version++}setUsage(e){return this.usage=e,this}addUpdateRange(e,t){this.updateRanges.push({start:e,count:t})}clearUpdateRanges(){this.updateRanges.length=0}copy(e){return this.name=e.name,this.array=new e.array.constructor(e.array),this.itemSize=e.itemSize,this.count=e.count,this.normalized=e.normalized,this.usage=e.usage,this.gpuType=e.gpuType,this}copyAt(e,t,n){e*=this.itemSize,n*=t.itemSize;for(let i=0,r=this.itemSize;i<r;i++)this.array[e+i]=t.array[n+i];return this}copyArray(e){return this.array.set(e),this}applyMatrix3(e){if(2===this.itemSize)for(let t=0,n=this.count;t<n;t++)Pi.fromBufferAttribute(this,t),Pi.applyMatrix3(e),this.setXY(t,Pi.x,Pi.y);else if(3===this.itemSize)for(let t=0,n=this.count;t<n;t++)Li.fromBufferAttribute(this,t),Li.applyMatrix3(e),this.setXYZ(t,Li.x,Li.y,Li.z);return this}applyMatrix4(e){for(let t=0,n=this.count;t<n;t++)Li.fromBufferAttribute(this,t),Li.applyMatrix4(e),this.setXYZ(t,Li.x,Li.y,Li.z);return this}applyNormalMatrix(e){for(let t=0,n=this.count;t<n;t++)Li.fromBufferAttribute(this,t),Li.applyNormalMatrix(e),this.setXYZ(t,Li.x,Li.y,Li.z);return this}transformDirection(e){for(let t=0,n=this.count;t<n;t++)Li.fromBufferAttribute(this,t),Li.transformDirection(e),this.setXYZ(t,Li.x,Li.y,Li.z);return this}set(e,t=0){return this.array.set(e,t),this}getComponent(e,t){let n=this.array[e*this.itemSize+t];return this.normalized&&(n=St(n,this.array)),n}setComponent(e,t,n){return this.normalized&&(n=Ct(n,this.array)),this.array[e*this.itemSize+t]=n,this}getX(e){let t=this.array[e*this.itemSize];return this.normalized&&(t=St(t,this.array)),t}setX(e,t){return this.normalized&&(t=Ct(t,this.array)),this.array[e*this.itemSize]=t,this}getY(e){let t=this.array[e*this.itemSize+1];return this.normalized&&(t=St(t,this.array)),t}setY(e,t){return this.normalized&&(t=Ct(t,this.array)),this.array[e*this.itemSize+1]=t,this}getZ(e){let t=this.array[e*this.itemSize+2];return this.normalized&&(t=St(t,this.array)),t}setZ(e,t){return this.normalized&&(t=Ct(t,this.array)),this.array[e*this.itemSize+2]=t,this}getW(e){let t=this.array[e*this.itemSize+3];return this.normalized&&(t=St(t,this.array)),t}setW(e,t){return this.normalized&&(t=Ct(t,this.array)),this.array[e*this.itemSize+3]=t,this}setXY(e,t,n){return e*=this.itemSize,this.normalized&&(t=Ct(t,this.array),n=Ct(n,this.array)),this.array[e+0]=t,this.array[e+1]=n,this}setXYZ(e,t,n,i){return e*=this.itemSize,this.normalized&&(t=Ct(t,this.array),n=Ct(n,this.array),i=Ct(i,this.array)),this.array[e+0]=t,this.array[e+1]=n,this.array[e+2]=i,this}setXYZW(e,t,n,i,r){return e*=this.itemSize,this.normalized&&(t=Ct(t,this.array),n=Ct(n,this.array),i=Ct(i,this.array),r=Ct(r,this.array)),this.array[e+0]=t,this.array[e+1]=n,this.array[e+2]=i,this.array[e+3]=r,this}onUpload(e){return this.onUploadCallback=e,this}clone(){return new this.constructor(this.array,this.itemSize).copy(this)}toJSON(){const e={itemSize:this.itemSize,type:this.array.constructor.name,array:Array.from(this.array),normalized:this.normalized};return""!==this.name&&(e.name=this.name),this.usage!==pt&&(e.usage=this.usage),e}}class Ni extends Di{constructor(e,t,n){super(new Uint16Array(e),t,n)}}class Ui extends Di{constructor(e,t,n){super(new Uint32Array(e),t,n)}}class Oi extends Di{constructor(e,t,n){super(new Float32Array(e),t,n)}}let Fi=0;const ki=new Nn,Qi=new li,zi=new sn,Gi=new ln,Hi=new ln,Vi=new sn;class ji extends At{constructor(){super(),this.isBufferGeometry=!0,Object.defineProperty(this,"id",{value:Fi++}),this.uuid=Et(),this.name="",this.type="BufferGeometry",this.index=null,this.indirect=null,this.attributes={},this.morphAttributes={},this.morphTargetsRelative=!1,this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0},this.userData={}}getIndex(){return this.index}setIndex(e){return Array.isArray(e)?this.index=new(Lt(e)?Ui:Ni)(e,1):this.index=e,this}setIndirect(e){return this.indirect=e,this}getIndirect(){return this.indirect}getAttribute(e){return this.attributes[e]}setAttribute(e,t){return this.attributes[e]=t,this}deleteAttribute(e){return delete this.attributes[e],this}hasAttribute(e){return void 0!==this.attributes[e]}addGroup(e,t,n=0){this.groups.push({start:e,count:t,materialIndex:n})}clearGroups(){this.groups=[]}setDrawRange(e,t){this.drawRange.start=e,this.drawRange.count=t}applyMatrix4(e){const t=this.attributes.position;void 0!==t&&(t.applyMatrix4(e),t.needsUpdate=!0);const n=this.attributes.normal;if(void 0!==n){const t=(new Rt).getNormalMatrix(e);n.applyNormalMatrix(t),n.needsUpdate=!0}const i=this.attributes.tangent;return void 0!==i&&(i.transformDirection(e),i.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this}applyQuaternion(e){return ki.makeRotationFromQuaternion(e),this.applyMatrix4(ki),this}rotateX(e){return ki.makeRotationX(e),this.applyMatrix4(ki),this}rotateY(e){return ki.makeRotationY(e),this.applyMatrix4(ki),this}rotateZ(e){return ki.makeRotationZ(e),this.applyMatrix4(ki),this}translate(e,t,n){return ki.makeTranslation(e,t,n),this.applyMatrix4(ki),this}scale(e,t,n){return ki.makeScale(e,t,n),this.applyMatrix4(ki),this}lookAt(e){return Qi.lookAt(e),Qi.updateMatrix(),this.applyMatrix4(Qi.matrix),this}center(){return this.computeBoundingBox(),this.boundingBox.getCenter(zi).negate(),this.translate(zi.x,zi.y,zi.z),this}setFromPoints(e){const t=this.getAttribute("position");if(void 0===t){const t=[];for(let n=0,i=e.length;n<i;n++){const i=e[n];t.push(i.x,i.y,i.z||0)}this.setAttribute("position",new Oi(t,3))}else{for(let n=0,i=t.count;n<i;n++){const i=e[n];t.setXYZ(n,i.x,i.y,i.z||0)}e.length>t.count&&console.warn("THREE.BufferGeometry: Buffer size too small for points data. Use .dispose() and create a new geometry."),t.needsUpdate=!0}return this}computeBoundingBox(){null===this.boundingBox&&(this.boundingBox=new ln);const e=this.attributes.position,t=this.morphAttributes.position;if(e&&e.isGLBufferAttribute)return console.error("THREE.BufferGeometry.computeBoundingBox(): GLBufferAttribute requires a manual bounding box.",this),void this.boundingBox.set(new sn(-1/0,-1/0,-1/0),new sn(1/0,1/0,1/0));if(void 0!==e){if(this.boundingBox.setFromBufferAttribute(e),t)for(let e=0,n=t.length;e<n;e++){const n=t[e];Gi.setFromBufferAttribute(n),this.morphTargetsRelative?(Vi.addVectors(this.boundingBox.min,Gi.min),this.boundingBox.expandByPoint(Vi),Vi.addVectors(this.boundingBox.max,Gi.max),this.boundingBox.expandByPoint(Vi)):(this.boundingBox.expandByPoint(Gi.min),this.boundingBox.expandByPoint(Gi.max))}}else this.boundingBox.makeEmpty();(isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z))&&console.error('THREE.BufferGeometry.computeBoundingBox(): Computed min/max have NaN values. The "position" attribute is likely to have NaN values.',this)}computeBoundingSphere(){null===this.boundingSphere&&(this.boundingSphere=new Sn);const e=this.attributes.position,t=this.morphAttributes.position;if(e&&e.isGLBufferAttribute)return console.error("THREE.BufferGeometry.computeBoundingSphere(): GLBufferAttribute requires a manual bounding sphere.",this),void this.boundingSphere.set(new sn,1/0);if(e){const n=this.boundingSphere.center;if(Gi.setFromBufferAttribute(e),t)for(let e=0,n=t.length;e<n;e++){const n=t[e];Hi.setFromBufferAttribute(n),this.morphTargetsRelative?(Vi.addVectors(Gi.min,Hi.min),Gi.expandByPoint(Vi),Vi.addVectors(Gi.max,Hi.max),Gi.expandByPoint(Vi)):(Gi.expandByPoint(Hi.min),Gi.expandByPoint(Hi.max))}Gi.getCenter(n);let i=0;for(let t=0,r=e.count;t<r;t++)Vi.fromBufferAttribute(e,t),i=Math.max(i,n.distanceToSquared(Vi));if(t)for(let r=0,s=t.length;r<s;r++){const s=t[r],a=this.morphTargetsRelative;for(let t=0,r=s.count;t<r;t++)Vi.fromBufferAttribute(s,t),a&&(zi.fromBufferAttribute(e,t),Vi.add(zi)),i=Math.max(i,n.distanceToSquared(Vi))}this.boundingSphere.radius=Math.sqrt(i),isNaN(this.boundingSphere.radius)&&console.error('THREE.BufferGeometry.computeBoundingSphere(): Computed radius is NaN. The "position" attribute is likely to have NaN values.',this)}}computeTangents(){const e=this.index,t=this.attributes;if(null===e||void 0===t.position||void 0===t.normal||void 0===t.uv)return void console.error("THREE.BufferGeometry: .computeTangents() failed. Missing required attributes (index, position, normal or uv)");const n=t.position,i=t.normal,r=t.uv;!1===this.hasAttribute("tangent")&&this.setAttribute("tangent",new Di(new Float32Array(4*n.count),4));const s=this.getAttribute("tangent"),a=[],o=[];for(let e=0;e<n.count;e++)a[e]=new sn,o[e]=new sn;const l=new sn,c=new sn,h=new sn,u=new It,d=new It,p=new It,f=new sn,m=new sn;function g(e,t,i){l.fromBufferAttribute(n,e),c.fromBufferAttribute(n,t),h.fromBufferAttribute(n,i),u.fromBufferAttribute(r,e),d.fromBufferAttribute(r,t),p.fromBufferAttribute(r,i),c.sub(l),h.sub(l),d.sub(u),p.sub(u);const s=1/(d.x*p.y-p.x*d.y);isFinite(s)&&(f.copy(c).multiplyScalar(p.y).addScaledVector(h,-d.y).multiplyScalar(s),m.copy(h).multiplyScalar(d.x).addScaledVector(c,-p.x).multiplyScalar(s),a[e].add(f),a[t].add(f),a[i].add(f),o[e].add(m),o[t].add(m),o[i].add(m))}let A=this.groups;0===A.length&&(A=[{start:0,count:e.count}]);for(let t=0,n=A.length;t<n;++t){const n=A[t],i=n.start;for(let t=i,r=i+n.count;t<r;t+=3)g(e.getX(t+0),e.getX(t+1),e.getX(t+2))}const y=new sn,v=new sn,_=new sn,x=new sn;function E(e){_.fromBufferAttribute(i,e),x.copy(_);const t=a[e];y.copy(t),y.sub(_.multiplyScalar(_.dot(t))).normalize(),v.crossVectors(x,t);const n=v.dot(o[e])<0?-1:1;s.setXYZW(e,y.x,y.y,y.z,n)}for(let t=0,n=A.length;t<n;++t){const n=A[t],i=n.start;for(let t=i,r=i+n.count;t<r;t+=3)E(e.getX(t+0)),E(e.getX(t+1)),E(e.getX(t+2))}}computeVertexNormals(){const e=this.index,t=this.getAttribute("position");if(void 0!==t){let n=this.getAttribute("normal");if(void 0===n)n=new Di(new Float32Array(3*t.count),3),this.setAttribute("normal",n);else for(let e=0,t=n.count;e<t;e++)n.setXYZ(e,0,0,0);const i=new sn,r=new sn,s=new sn,a=new sn,o=new sn,l=new sn,c=new sn,h=new sn;if(e)for(let u=0,d=e.count;u<d;u+=3){const d=e.getX(u+0),p=e.getX(u+1),f=e.getX(u+2);i.fromBufferAttribute(t,d),r.fromBufferAttribute(t,p),s.fromBufferAttribute(t,f),c.subVectors(s,r),h.subVectors(i,r),c.cross(h),a.fromBufferAttribute(n,d),o.fromBufferAttribute(n,p),l.fromBufferAttribute(n,f),a.add(c),o.add(c),l.add(c),n.setXYZ(d,a.x,a.y,a.z),n.setXYZ(p,o.x,o.y,o.z),n.setXYZ(f,l.x,l.y,l.z)}else for(let e=0,a=t.count;e<a;e+=3)i.fromBufferAttribute(t,e+0),r.fromBufferAttribute(t,e+1),s.fromBufferAttribute(t,e+2),c.subVectors(s,r),h.subVectors(i,r),c.cross(h),n.setXYZ(e+0,c.x,c.y,c.z),n.setXYZ(e+1,c.x,c.y,c.z),n.setXYZ(e+2,c.x,c.y,c.z);this.normalizeNormals(),n.needsUpdate=!0}}normalizeNormals(){const e=this.attributes.normal;for(let t=0,n=e.count;t<n;t++)Vi.fromBufferAttribute(e,t),Vi.normalize(),e.setXYZ(t,Vi.x,Vi.y,Vi.z)}toNonIndexed(){function e(e,t){const n=e.array,i=e.itemSize,r=e.normalized,s=new n.constructor(t.length*i);let a=0,o=0;for(let r=0,l=t.length;r<l;r++){a=e.isInterleavedBufferAttribute?t[r]*e.data.stride+e.offset:t[r]*i;for(let e=0;e<i;e++)s[o++]=n[a++]}return new Di(s,i,r)}if(null===this.index)return console.warn("THREE.BufferGeometry.toNonIndexed(): BufferGeometry is already non-indexed."),this;const t=new ji,n=this.index.array,i=this.attributes;for(const r in i){const s=e(i[r],n);t.setAttribute(r,s)}const r=this.morphAttributes;for(const i in r){const s=[],a=r[i];for(let t=0,i=a.length;t<i;t++){const i=e(a[t],n);s.push(i)}t.morphAttributes[i]=s}t.morphTargetsRelative=this.morphTargetsRelative;const s=this.groups;for(let e=0,n=s.length;e<n;e++){const n=s[e];t.addGroup(n.start,n.count,n.materialIndex)}return t}toJSON(){const e={metadata:{version:4.6,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(e.uuid=this.uuid,e.type=this.type,""!==this.name&&(e.name=this.name),Object.keys(this.userData).length>0&&(e.userData=this.userData),void 0!==this.parameters){const t=this.parameters;for(const n in t)void 0!==t[n]&&(e[n]=t[n]);return e}e.data={attributes:{}};const t=this.index;null!==t&&(e.data.index={type:t.array.constructor.name,array:Array.prototype.slice.call(t.array)});const n=this.attributes;for(const t in n){const i=n[t];e.data.attributes[t]=i.toJSON(e.data)}const i={};let r=!1;for(const t in this.morphAttributes){const n=this.morphAttributes[t],s=[];for(let t=0,i=n.length;t<i;t++){const i=n[t];s.push(i.toJSON(e.data))}s.length>0&&(i[t]=s,r=!0)}r&&(e.data.morphAttributes=i,e.data.morphTargetsRelative=this.morphTargetsRelative);const s=this.groups;s.length>0&&(e.data.groups=JSON.parse(JSON.stringify(s)));const a=this.boundingSphere;return null!==a&&(e.data.boundingSphere={center:a.center.toArray(),radius:a.radius}),e}clone(){return(new this.constructor).copy(this)}copy(e){this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null;const t={};this.name=e.name;const n=e.index;null!==n&&this.setIndex(n.clone(t));const i=e.attributes;for(const e in i){const n=i[e];this.setAttribute(e,n.clone(t))}const r=e.morphAttributes;for(const e in r){const n=[],i=r[e];for(let e=0,r=i.length;e<r;e++)n.push(i[e].clone(t));this.morphAttributes[e]=n}this.morphTargetsRelative=e.morphTargetsRelative;const s=e.groups;for(let e=0,t=s.length;e<t;e++){const t=s[e];this.addGroup(t.start,t.count,t.materialIndex)}const a=e.boundingBox;null!==a&&(this.boundingBox=a.clone());const o=e.boundingSphere;return null!==o&&(this.boundingSphere=o.clone()),this.drawRange.start=e.drawRange.start,this.drawRange.count=e.drawRange.count,this.userData=e.userData,this}dispose(){this.dispatchEvent({type:"dispose"})}}const qi=new Nn,Wi=new Dn,Yi=new Sn,Xi=new sn,Ki=new sn,Ji=new sn,$i=new sn,Zi=new sn,er=new sn,tr=new sn,nr=new sn;class ir extends li{constructor(e=new ji,t=new Bi){super(),this.isMesh=!0,this.type="Mesh",this.geometry=e,this.material=t,this.updateMorphTargets()}copy(e,t){return super.copy(e,t),void 0!==e.morphTargetInfluences&&(this.morphTargetInfluences=e.morphTargetInfluences.slice()),void 0!==e.morphTargetDictionary&&(this.morphTargetDictionary=Object.assign({},e.morphTargetDictionary)),this.material=Array.isArray(e.material)?e.material.slice():e.material,this.geometry=e.geometry,this}updateMorphTargets(){const e=this.geometry.morphAttributes,t=Object.keys(e);if(t.length>0){const n=e[t[0]];if(void 0!==n){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,t=n.length;e<t;e++){const t=n[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[t]=e}}}}getVertexPosition(e,t){const n=this.geometry,i=n.attributes.position,r=n.morphAttributes.position,s=n.morphTargetsRelative;t.fromBufferAttribute(i,e);const a=this.morphTargetInfluences;if(r&&a){er.set(0,0,0);for(let n=0,i=r.length;n<i;n++){const i=a[n],o=r[n];0!==i&&(Zi.fromBufferAttribute(o,e),s?er.addScaledVector(Zi,i):er.addScaledVector(Zi.sub(t),i))}t.add(er)}return t}raycast(e,t){const n=this.geometry,i=this.material,r=this.matrixWorld;if(void 0!==i){if(null===n.boundingSphere&&n.computeBoundingSphere(),Yi.copy(n.boundingSphere),Yi.applyMatrix4(r),Wi.copy(e.ray).recast(e.near),!1===Yi.containsPoint(Wi.origin)){if(null===Wi.intersectSphere(Yi,Xi))return;if(Wi.origin.distanceToSquared(Xi)>(e.far-e.near)**2)return}qi.copy(r).invert(),Wi.copy(e.ray).applyMatrix4(qi),null!==n.boundingBox&&!1===Wi.intersectsBox(n.boundingBox)||this._computeIntersections(e,t,Wi)}}_computeIntersections(e,t,n){let i;const r=this.geometry,s=this.material,a=r.index,o=r.attributes.position,l=r.attributes.uv,c=r.attributes.uv1,h=r.attributes.normal,u=r.groups,d=r.drawRange;if(null!==a)if(Array.isArray(s))for(let r=0,o=u.length;r<o;r++){const o=u[r],p=s[o.materialIndex];for(let r=Math.max(o.start,d.start),s=Math.min(a.count,Math.min(o.start+o.count,d.start+d.count));r<s;r+=3)i=rr(this,p,e,n,l,c,h,a.getX(r),a.getX(r+1),a.getX(r+2)),i&&(i.faceIndex=Math.floor(r/3),i.face.materialIndex=o.materialIndex,t.push(i))}else for(let r=Math.max(0,d.start),o=Math.min(a.count,d.start+d.count);r<o;r+=3)i=rr(this,s,e,n,l,c,h,a.getX(r),a.getX(r+1),a.getX(r+2)),i&&(i.faceIndex=Math.floor(r/3),t.push(i));else if(void 0!==o)if(Array.isArray(s))for(let r=0,a=u.length;r<a;r++){const a=u[r],p=s[a.materialIndex];for(let r=Math.max(a.start,d.start),s=Math.min(o.count,Math.min(a.start+a.count,d.start+d.count));r<s;r+=3)i=rr(this,p,e,n,l,c,h,r,r+1,r+2),i&&(i.faceIndex=Math.floor(r/3),i.face.materialIndex=a.materialIndex,t.push(i))}else for(let r=Math.max(0,d.start),a=Math.min(o.count,d.start+d.count);r<a;r+=3)i=rr(this,s,e,n,l,c,h,r,r+1,r+2),i&&(i.faceIndex=Math.floor(r/3),t.push(i))}}function rr(e,t,n,i,a,o,l,c,h,u){e.getVertexPosition(c,Ki),e.getVertexPosition(h,Ji),e.getVertexPosition(u,$i);const d=function(e,t,n,i,a,o,l,c){let h;if(h=t.side===s?i.intersectTriangle(l,o,a,!0,c):i.intersectTriangle(a,o,l,t.side===r,c),null===h)return null;nr.copy(c),nr.applyMatrix4(e.matrixWorld);const u=n.ray.origin.distanceTo(nr);return u<n.near||u>n.far?null:{distance:u,point:nr.clone(),object:e}}(e,t,n,i,Ki,Ji,$i,tr);if(d){const e=new sn;Ei.getBarycoord(tr,Ki,Ji,$i,e),a&&(d.uv=Ei.getInterpolatedAttribute(a,c,h,u,e,new It)),o&&(d.uv1=Ei.getInterpolatedAttribute(o,c,h,u,e,new It)),l&&(d.normal=Ei.getInterpolatedAttribute(l,c,h,u,e,new sn),d.normal.dot(i.direction)>0&&d.normal.multiplyScalar(-1));const t={a:c,b:h,c:u,normal:new sn,materialIndex:0};Ei.getNormal(Ki,Ji,$i,t.normal),d.face=t,d.barycoord=e}return d}class sr extends ji{constructor(e=1,t=1,n=1,i=1,r=1,s=1){super(),this.type="BoxGeometry",this.parameters={width:e,height:t,depth:n,widthSegments:i,heightSegments:r,depthSegments:s};const a=this;i=Math.floor(i),r=Math.floor(r),s=Math.floor(s);const o=[],l=[],c=[],h=[];let u=0,d=0;function p(e,t,n,i,r,s,p,f,m,g,A){const y=s/m,v=p/g,_=s/2,x=p/2,E=f/2,b=m+1,w=g+1;let M=0,S=0;const C=new sn;for(let s=0;s<w;s++){const a=s*v-x;for(let o=0;o<b;o++){const u=o*y-_;C[e]=u*i,C[t]=a*r,C[n]=E,l.push(C.x,C.y,C.z),C[e]=0,C[t]=0,C[n]=f>0?1:-1,c.push(C.x,C.y,C.z),h.push(o/m),h.push(1-s/g),M+=1}}for(let e=0;e<g;e++)for(let t=0;t<m;t++){const n=u+t+b*e,i=u+t+b*(e+1),r=u+(t+1)+b*(e+1),s=u+(t+1)+b*e;o.push(n,i,s),o.push(i,r,s),S+=6}a.addGroup(d,S,A),d+=S,u+=M}p("z","y","x",-1,-1,n,t,e,s,r,0),p("z","y","x",1,-1,n,t,-e,s,r,1),p("x","z","y",1,1,e,n,t,i,s,2),p("x","z","y",1,-1,e,n,-t,i,s,3),p("x","y","z",1,-1,e,t,n,i,r,4),p("x","y","z",-1,-1,e,t,-n,i,r,5),this.setIndex(o),this.setAttribute("position",new Oi(l,3)),this.setAttribute("normal",new Oi(c,3)),this.setAttribute("uv",new Oi(h,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new sr(e.width,e.height,e.depth,e.widthSegments,e.heightSegments,e.depthSegments)}}function ar(e){const t={};for(const n in e){t[n]={};for(const i in e[n]){const r=e[n][i];r&&(r.isColor||r.isMatrix3||r.isMatrix4||r.isVector2||r.isVector3||r.isVector4||r.isTexture||r.isQuaternion)?r.isRenderTargetTexture?(console.warn("UniformsUtils: Textures of render targets cannot be cloned via cloneUniforms() or mergeUniforms()."),t[n][i]=null):t[n][i]=r.clone():Array.isArray(r)?t[n][i]=r.slice():t[n][i]=r}}return t}function or(e){const t={};for(let n=0;n<e.length;n++){const i=ar(e[n]);for(const e in i)t[e]=i[e]}return t}function lr(e){const t=e.getRenderTarget();return null===t?e.outputColorSpace:!0===t.isXRRenderTarget?t.texture.colorSpace:Ot.workingColorSpace}const cr={clone:ar,merge:or};class hr extends Ri{static get type(){return"ShaderMaterial"}constructor(e){super(),this.isShaderMaterial=!0,this.defines={},this.uniforms={},this.uniformsGroups=[],this.vertexShader="void main() {\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",this.fragmentShader="void main() {\n\tgl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );\n}",this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.clipping=!1,this.forceSinglePass=!0,this.extensions={clipCullDistance:!1,multiDraw:!1},this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv1:[0,0]},this.index0AttributeName=void 0,this.uniformsNeedUpdate=!1,this.glslVersion=null,void 0!==e&&this.setValues(e)}copy(e){return super.copy(e),this.fragmentShader=e.fragmentShader,this.vertexShader=e.vertexShader,this.uniforms=ar(e.uniforms),this.uniformsGroups=function(e){const t=[];for(let n=0;n<e.length;n++)t.push(e[n].clone());return t}(e.uniformsGroups),this.defines=Object.assign({},e.defines),this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.fog=e.fog,this.lights=e.lights,this.clipping=e.clipping,this.extensions=Object.assign({},e.extensions),this.glslVersion=e.glslVersion,this}toJSON(e){const t=super.toJSON(e);t.glslVersion=this.glslVersion,t.uniforms={};for(const n in this.uniforms){const i=this.uniforms[n].value;i&&i.isTexture?t.uniforms[n]={type:"t",value:i.toJSON(e).uuid}:i&&i.isColor?t.uniforms[n]={type:"c",value:i.getHex()}:i&&i.isVector2?t.uniforms[n]={type:"v2",value:i.toArray()}:i&&i.isVector3?t.uniforms[n]={type:"v3",value:i.toArray()}:i&&i.isVector4?t.uniforms[n]={type:"v4",value:i.toArray()}:i&&i.isMatrix3?t.uniforms[n]={type:"m3",value:i.toArray()}:i&&i.isMatrix4?t.uniforms[n]={type:"m4",value:i.toArray()}:t.uniforms[n]={value:i}}Object.keys(this.defines).length>0&&(t.defines=this.defines),t.vertexShader=this.vertexShader,t.fragmentShader=this.fragmentShader,t.lights=this.lights,t.clipping=this.clipping;const n={};for(const e in this.extensions)!0===this.extensions[e]&&(n[e]=!0);return Object.keys(n).length>0&&(t.extensions=n),t}}class ur extends li{constructor(){super(),this.isCamera=!0,this.type="Camera",this.matrixWorldInverse=new Nn,this.projectionMatrix=new Nn,this.projectionMatrixInverse=new Nn,this.coordinateSystem=mt}copy(e,t){return super.copy(e,t),this.matrixWorldInverse.copy(e.matrixWorldInverse),this.projectionMatrix.copy(e.projectionMatrix),this.projectionMatrixInverse.copy(e.projectionMatrixInverse),this.coordinateSystem=e.coordinateSystem,this}getWorldDirection(e){return super.getWorldDirection(e).negate()}updateMatrixWorld(e){super.updateMatrixWorld(e),this.matrixWorldInverse.copy(this.matrixWorld).invert()}updateWorldMatrix(e,t){super.updateWorldMatrix(e,t),this.matrixWorldInverse.copy(this.matrixWorld).invert()}clone(){return(new this.constructor).copy(this)}}const dr=new sn,pr=new It,fr=new It;class mr extends ur{constructor(e=50,t=1,n=.1,i=2e3){super(),this.isPerspectiveCamera=!0,this.type="PerspectiveCamera",this.fov=e,this.zoom=1,this.near=n,this.far=i,this.focus=10,this.aspect=t,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}copy(e,t){return super.copy(e,t),this.fov=e.fov,this.zoom=e.zoom,this.near=e.near,this.far=e.far,this.focus=e.focus,this.aspect=e.aspect,this.view=null===e.view?null:Object.assign({},e.view),this.filmGauge=e.filmGauge,this.filmOffset=e.filmOffset,this}setFocalLength(e){const t=.5*this.getFilmHeight()/e;this.fov=2*xt*Math.atan(t),this.updateProjectionMatrix()}getFocalLength(){const e=Math.tan(.5*_t*this.fov);return.5*this.getFilmHeight()/e}getEffectiveFOV(){return 2*xt*Math.atan(Math.tan(.5*_t*this.fov)/this.zoom)}getFilmWidth(){return this.filmGauge*Math.min(this.aspect,1)}getFilmHeight(){return this.filmGauge/Math.max(this.aspect,1)}getViewBounds(e,t,n){dr.set(-1,-1,.5).applyMatrix4(this.projectionMatrixInverse),t.set(dr.x,dr.y).multiplyScalar(-e/dr.z),dr.set(1,1,.5).applyMatrix4(this.projectionMatrixInverse),n.set(dr.x,dr.y).multiplyScalar(-e/dr.z)}getViewSize(e,t){return this.getViewBounds(e,pr,fr),t.subVectors(fr,pr)}setViewOffset(e,t,n,i,r,s){this.aspect=e/t,null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=t,this.view.offsetX=n,this.view.offsetY=i,this.view.width=r,this.view.height=s,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const e=this.near;let t=e*Math.tan(.5*_t*this.fov)/this.zoom,n=2*t,i=this.aspect*n,r=-.5*i;const s=this.view;if(null!==this.view&&this.view.enabled){const e=s.fullWidth,a=s.fullHeight;r+=s.offsetX*i/e,t-=s.offsetY*n/a,i*=s.width/e,n*=s.height/a}const a=this.filmOffset;0!==a&&(r+=e*a/this.getFilmWidth()),this.projectionMatrix.makePerspective(r,r+i,t,t-n,e,this.far,this.coordinateSystem),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(e){const t=super.toJSON(e);return t.object.fov=this.fov,t.object.zoom=this.zoom,t.object.near=this.near,t.object.far=this.far,t.object.focus=this.focus,t.object.aspect=this.aspect,null!==this.view&&(t.object.view=Object.assign({},this.view)),t.object.filmGauge=this.filmGauge,t.object.filmOffset=this.filmOffset,t}}const gr=-90;class Ar extends li{constructor(e,t,n){super(),this.type="CubeCamera",this.renderTarget=n,this.coordinateSystem=null,this.activeMipmapLevel=0;const i=new mr(gr,1,e,t);i.layers=this.layers,this.add(i);const r=new mr(gr,1,e,t);r.layers=this.layers,this.add(r);const s=new mr(gr,1,e,t);s.layers=this.layers,this.add(s);const a=new mr(gr,1,e,t);a.layers=this.layers,this.add(a);const o=new mr(gr,1,e,t);o.layers=this.layers,this.add(o);const l=new mr(gr,1,e,t);l.layers=this.layers,this.add(l)}updateCoordinateSystem(){const e=this.coordinateSystem,t=this.children.concat(),[n,i,r,s,a,o]=t;for(const e of t)this.remove(e);if(e===mt)n.up.set(0,1,0),n.lookAt(1,0,0),i.up.set(0,1,0),i.lookAt(-1,0,0),r.up.set(0,0,-1),r.lookAt(0,1,0),s.up.set(0,0,1),s.lookAt(0,-1,0),a.up.set(0,1,0),a.lookAt(0,0,1),o.up.set(0,1,0),o.lookAt(0,0,-1);else{if(e!==gt)throw new Error("THREE.CubeCamera.updateCoordinateSystem(): Invalid coordinate system: "+e);n.up.set(0,-1,0),n.lookAt(-1,0,0),i.up.set(0,-1,0),i.lookAt(1,0,0),r.up.set(0,0,1),r.lookAt(0,1,0),s.up.set(0,0,-1),s.lookAt(0,-1,0),a.up.set(0,-1,0),a.lookAt(0,0,1),o.up.set(0,-1,0),o.lookAt(0,0,-1)}for(const e of t)this.add(e),e.updateMatrixWorld()}update(e,t){null===this.parent&&this.updateMatrixWorld();const{renderTarget:n,activeMipmapLevel:i}=this;this.coordinateSystem!==e.coordinateSystem&&(this.coordinateSystem=e.coordinateSystem,this.updateCoordinateSystem());const[r,s,a,o,l,c]=this.children,h=e.getRenderTarget(),u=e.getActiveCubeFace(),d=e.getActiveMipmapLevel(),p=e.xr.enabled;e.xr.enabled=!1;const f=n.texture.generateMipmaps;n.texture.generateMipmaps=!1,e.setRenderTarget(n,0,i),e.render(t,r),e.setRenderTarget(n,1,i),e.render(t,s),e.setRenderTarget(n,2,i),e.render(t,a),e.setRenderTarget(n,3,i),e.render(t,o),e.setRenderTarget(n,4,i),e.render(t,l),n.texture.generateMipmaps=f,e.setRenderTarget(n,5,i),e.render(t,c),e.setRenderTarget(h,u,d),e.xr.enabled=p,n.texture.needsPMREMUpdate=!0}}class yr extends Jt{constructor(e,t,n,i,r,s,a,o,l,c){super(e=void 0!==e?e:[],t=void 0!==t?t:F,n,i,r,s,a,o,l,c),this.isCubeTexture=!0,this.flipY=!1}get images(){return this.image}set images(e){this.image=e}}class vr extends en{constructor(e=1,t={}){super(e,e,t),this.isWebGLCubeRenderTarget=!0;const n={width:e,height:e,depth:1},i=[n,n,n,n,n,n];this.texture=new yr(i,t.mapping,t.wrapS,t.wrapT,t.magFilter,t.minFilter,t.format,t.type,t.anisotropy,t.colorSpace),this.texture.isRenderTargetTexture=!0,this.texture.generateMipmaps=void 0!==t.generateMipmaps&&t.generateMipmaps,this.texture.minFilter=void 0!==t.minFilter?t.minFilter:W}fromEquirectangularTexture(e,t){this.texture.type=t.type,this.texture.colorSpace=t.colorSpace,this.texture.generateMipmaps=t.generateMipmaps,this.texture.minFilter=t.minFilter,this.texture.magFilter=t.magFilter;const n={tEquirect:{value:null}},i="\n\n\t\t\t\tvarying vec3 vWorldDirection;\n\n\t\t\t\tvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\n\t\t\t\t\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n\n\t\t\t\t}\n\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tvWorldDirection = transformDirection( position, modelMatrix );\n\n\t\t\t\t\t#include <begin_vertex>\n\t\t\t\t\t#include <project_vertex>\n\n\t\t\t\t}\n\t\t\t",r="\n\n\t\t\t\tuniform sampler2D tEquirect;\n\n\t\t\t\tvarying vec3 vWorldDirection;\n\n\t\t\t\t#include <common>\n\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tvec3 direction = normalize( vWorldDirection );\n\n\t\t\t\t\tvec2 sampleUV = equirectUv( direction );\n\n\t\t\t\t\tgl_FragColor = texture2D( tEquirect, sampleUV );\n\n\t\t\t\t}\n\t\t\t",a=new sr(5,5,5),l=new hr({name:"CubemapFromEquirect",uniforms:ar(n),vertexShader:i,fragmentShader:r,side:s,blending:o});l.uniforms.tEquirect.value=t;const c=new ir(a,l),h=t.minFilter;return t.minFilter===X&&(t.minFilter=W),new Ar(1,10,this).update(e,c),t.minFilter=h,c.geometry.dispose(),c.material.dispose(),this}clear(e,t,n,i){const r=e.getRenderTarget();for(let r=0;r<6;r++)e.setRenderTarget(this,r),e.clear(t,n,i);e.setRenderTarget(r)}}const _r=new sn,xr=new sn,Er=new Rt;class br{constructor(e=new sn(1,0,0),t=0){this.isPlane=!0,this.normal=e,this.constant=t}set(e,t){return this.normal.copy(e),this.constant=t,this}setComponents(e,t,n,i){return this.normal.set(e,t,n),this.constant=i,this}setFromNormalAndCoplanarPoint(e,t){return this.normal.copy(e),this.constant=-t.dot(this.normal),this}setFromCoplanarPoints(e,t,n){const i=_r.subVectors(n,t).cross(xr.subVectors(e,t)).normalize();return this.setFromNormalAndCoplanarPoint(i,e),this}copy(e){return this.normal.copy(e.normal),this.constant=e.constant,this}normalize(){const e=1/this.normal.length();return this.normal.multiplyScalar(e),this.constant*=e,this}negate(){return this.constant*=-1,this.normal.negate(),this}distanceToPoint(e){return this.normal.dot(e)+this.constant}distanceToSphere(e){return this.distanceToPoint(e.center)-e.radius}projectPoint(e,t){return t.copy(e).addScaledVector(this.normal,-this.distanceToPoint(e))}intersectLine(e,t){const n=e.delta(_r),i=this.normal.dot(n);if(0===i)return 0===this.distanceToPoint(e.start)?t.copy(e.start):null;const r=-(e.start.dot(this.normal)+this.constant)/i;return r<0||r>1?null:t.copy(e.start).addScaledVector(n,r)}intersectsLine(e){const t=this.distanceToPoint(e.start),n=this.distanceToPoint(e.end);return t<0&&n>0||n<0&&t>0}intersectsBox(e){return e.intersectsPlane(this)}intersectsSphere(e){return e.intersectsPlane(this)}coplanarPoint(e){return e.copy(this.normal).multiplyScalar(-this.constant)}applyMatrix4(e,t){const n=t||Er.getNormalMatrix(e),i=this.coplanarPoint(_r).applyMatrix4(e),r=this.normal.applyMatrix3(n).normalize();return this.constant=-i.dot(r),this}translate(e){return this.constant-=e.dot(this.normal),this}equals(e){return e.normal.equals(this.normal)&&e.constant===this.constant}clone(){return(new this.constructor).copy(this)}}const wr=new Sn,Mr=new sn;class Sr{constructor(e=new br,t=new br,n=new br,i=new br,r=new br,s=new br){this.planes=[e,t,n,i,r,s]}set(e,t,n,i,r,s){const a=this.planes;return a[0].copy(e),a[1].copy(t),a[2].copy(n),a[3].copy(i),a[4].copy(r),a[5].copy(s),this}copy(e){const t=this.planes;for(let n=0;n<6;n++)t[n].copy(e.planes[n]);return this}setFromProjectionMatrix(e,t=2e3){const n=this.planes,i=e.elements,r=i[0],s=i[1],a=i[2],o=i[3],l=i[4],c=i[5],h=i[6],u=i[7],d=i[8],p=i[9],f=i[10],m=i[11],g=i[12],A=i[13],y=i[14],v=i[15];if(n[0].setComponents(o-r,u-l,m-d,v-g).normalize(),n[1].setComponents(o+r,u+l,m+d,v+g).normalize(),n[2].setComponents(o+s,u+c,m+p,v+A).normalize(),n[3].setComponents(o-s,u-c,m-p,v-A).normalize(),n[4].setComponents(o-a,u-h,m-f,v-y).normalize(),t===mt)n[5].setComponents(o+a,u+h,m+f,v+y).normalize();else{if(t!==gt)throw new Error("THREE.Frustum.setFromProjectionMatrix(): Invalid coordinate system: "+t);n[5].setComponents(a,h,f,y).normalize()}return this}intersectsObject(e){if(void 0!==e.boundingSphere)null===e.boundingSphere&&e.computeBoundingSphere(),wr.copy(e.boundingSphere).applyMatrix4(e.matrixWorld);else{const t=e.geometry;null===t.boundingSphere&&t.computeBoundingSphere(),wr.copy(t.boundingSphere).applyMatrix4(e.matrixWorld)}return this.intersectsSphere(wr)}intersectsSprite(e){return wr.center.set(0,0,0),wr.radius=.7071067811865476,wr.applyMatrix4(e.matrixWorld),this.intersectsSphere(wr)}intersectsSphere(e){const t=this.planes,n=e.center,i=-e.radius;for(let e=0;e<6;e++)if(t[e].distanceToPoint(n)<i)return!1;return!0}intersectsBox(e){const t=this.planes;for(let n=0;n<6;n++){const i=t[n];if(Mr.x=i.normal.x>0?e.max.x:e.min.x,Mr.y=i.normal.y>0?e.max.y:e.min.y,Mr.z=i.normal.z>0?e.max.z:e.min.z,i.distanceToPoint(Mr)<0)return!1}return!0}containsPoint(e){const t=this.planes;for(let n=0;n<6;n++)if(t[n].distanceToPoint(e)<0)return!1;return!0}clone(){return(new this.constructor).copy(this)}}function Cr(){let e=null,t=!1,n=null,i=null;function r(t,s){n(t,s),i=e.requestAnimationFrame(r)}return{start:function(){!0!==t&&null!==n&&(i=e.requestAnimationFrame(r),t=!0)},stop:function(){e.cancelAnimationFrame(i),t=!1},setAnimationLoop:function(e){n=e},setContext:function(t){e=t}}}function Tr(e){const t=new WeakMap;return{get:function(e){return e.isInterleavedBufferAttribute&&(e=e.data),t.get(e)},remove:function(n){n.isInterleavedBufferAttribute&&(n=n.data);const i=t.get(n);i&&(e.deleteBuffer(i.buffer),t.delete(n))},update:function(n,i){if(n.isInterleavedBufferAttribute&&(n=n.data),n.isGLBufferAttribute){const e=t.get(n);return void((!e||e.version<n.version)&&t.set(n,{buffer:n.buffer,type:n.type,bytesPerElement:n.elementSize,version:n.version}))}const r=t.get(n);if(void 0===r)t.set(n,function(t,n){const i=t.array,r=t.usage,s=i.byteLength,a=e.createBuffer();let o;if(e.bindBuffer(n,a),e.bufferData(n,i,r),t.onUploadCallback(),i instanceof Float32Array)o=e.FLOAT;else if(i instanceof Uint16Array)o=t.isFloat16BufferAttribute?e.HALF_FLOAT:e.UNSIGNED_SHORT;else if(i instanceof Int16Array)o=e.SHORT;else if(i instanceof Uint32Array)o=e.UNSIGNED_INT;else if(i instanceof Int32Array)o=e.INT;else if(i instanceof Int8Array)o=e.BYTE;else if(i instanceof Uint8Array)o=e.UNSIGNED_BYTE;else{if(!(i instanceof Uint8ClampedArray))throw new Error("THREE.WebGLAttributes: Unsupported buffer data format: "+i);o=e.UNSIGNED_BYTE}return{buffer:a,type:o,bytesPerElement:i.BYTES_PER_ELEMENT,version:t.version,size:s}}(n,i));else if(r.version<n.version){if(r.size!==n.array.byteLength)throw new Error("THREE.WebGLAttributes: The size of the buffer attribute's array buffer does not match the original size. Resizing buffer attributes is not supported.");!function(t,n,i){const r=n.array,s=n.updateRanges;if(e.bindBuffer(i,t),0===s.length)e.bufferSubData(i,0,r);else{s.sort(((e,t)=>e.start-t.start));let t=0;for(let e=1;e<s.length;e++){const n=s[t],i=s[e];i.start<=n.start+n.count+1?n.count=Math.max(n.count,i.start+i.count-n.start):(++t,s[t]=i)}s.length=t+1;for(let t=0,n=s.length;t<n;t++){const n=s[t];e.bufferSubData(i,n.start*r.BYTES_PER_ELEMENT,r,n.start,n.count)}n.clearUpdateRanges()}n.onUploadCallback()}(r.buffer,n,i),r.version=n.version}}}}class Ir extends ji{constructor(e=1,t=1,n=1,i=1){super(),this.type="PlaneGeometry",this.parameters={width:e,height:t,widthSegments:n,heightSegments:i};const r=e/2,s=t/2,a=Math.floor(n),o=Math.floor(i),l=a+1,c=o+1,h=e/a,u=t/o,d=[],p=[],f=[],m=[];for(let e=0;e<c;e++){const t=e*u-s;for(let n=0;n<l;n++){const i=n*h-r;p.push(i,-t,0),f.push(0,0,1),m.push(n/a),m.push(1-e/o)}}for(let e=0;e<o;e++)for(let t=0;t<a;t++){const n=t+l*e,i=t+l*(e+1),r=t+1+l*(e+1),s=t+1+l*e;d.push(n,i,s),d.push(i,r,s)}this.setIndex(d),this.setAttribute("position",new Oi(p,3)),this.setAttribute("normal",new Oi(f,3)),this.setAttribute("uv",new Oi(m,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new Ir(e.width,e.height,e.widthSegments,e.heightSegments)}}const Rr={alphahash_fragment:"#ifdef USE_ALPHAHASH\n\tif ( diffuseColor.a < getAlphaHashThreshold( vPosition ) ) discard;\n#endif",alphahash_pars_fragment:"#ifdef USE_ALPHAHASH\n\tconst float ALPHA_HASH_SCALE = 0.05;\n\tfloat hash2D( vec2 value ) {\n\t\treturn fract( 1.0e4 * sin( 17.0 * value.x + 0.1 * value.y ) * ( 0.1 + abs( sin( 13.0 * value.y + value.x ) ) ) );\n\t}\n\tfloat hash3D( vec3 value ) {\n\t\treturn hash2D( vec2( hash2D( value.xy ), value.z ) );\n\t}\n\tfloat getAlphaHashThreshold( vec3 position ) {\n\t\tfloat maxDeriv = max(\n\t\t\tlength( dFdx( position.xyz ) ),\n\t\t\tlength( dFdy( position.xyz ) )\n\t\t);\n\t\tfloat pixScale = 1.0 / ( ALPHA_HASH_SCALE * maxDeriv );\n\t\tvec2 pixScales = vec2(\n\t\t\texp2( floor( log2( pixScale ) ) ),\n\t\t\texp2( ceil( log2( pixScale ) ) )\n\t\t);\n\t\tvec2 alpha = vec2(\n\t\t\thash3D( floor( pixScales.x * position.xyz ) ),\n\t\t\thash3D( floor( pixScales.y * position.xyz ) )\n\t\t);\n\t\tfloat lerpFactor = fract( log2( pixScale ) );\n\t\tfloat x = ( 1.0 - lerpFactor ) * alpha.x + lerpFactor * alpha.y;\n\t\tfloat a = min( lerpFactor, 1.0 - lerpFactor );\n\t\tvec3 cases = vec3(\n\t\t\tx * x / ( 2.0 * a * ( 1.0 - a ) ),\n\t\t\t( x - 0.5 * a ) / ( 1.0 - a ),\n\t\t\t1.0 - ( ( 1.0 - x ) * ( 1.0 - x ) / ( 2.0 * a * ( 1.0 - a ) ) )\n\t\t);\n\t\tfloat threshold = ( x < ( 1.0 - a ) )\n\t\t\t? ( ( x < a ) ? cases.x : cases.y )\n\t\t\t: cases.z;\n\t\treturn clamp( threshold , 1.0e-6, 1.0 );\n\t}\n#endif",alphamap_fragment:"#ifdef USE_ALPHAMAP\n\tdiffuseColor.a *= texture2D( alphaMap, vAlphaMapUv ).g;\n#endif",alphamap_pars_fragment:"#ifdef USE_ALPHAMAP\n\tuniform sampler2D alphaMap;\n#endif",alphatest_fragment:"#ifdef USE_ALPHATEST\n\t#ifdef ALPHA_TO_COVERAGE\n\tdiffuseColor.a = smoothstep( alphaTest, alphaTest + fwidth( diffuseColor.a ), diffuseColor.a );\n\tif ( diffuseColor.a == 0.0 ) discard;\n\t#else\n\tif ( diffuseColor.a < alphaTest ) discard;\n\t#endif\n#endif",alphatest_pars_fragment:"#ifdef USE_ALPHATEST\n\tuniform float alphaTest;\n#endif",aomap_fragment:"#ifdef USE_AOMAP\n\tfloat ambientOcclusion = ( texture2D( aoMap, vAoMapUv ).r - 1.0 ) * aoMapIntensity + 1.0;\n\treflectedLight.indirectDiffuse *= ambientOcclusion;\n\t#if defined( USE_CLEARCOAT ) \n\t\tclearcoatSpecularIndirect *= ambientOcclusion;\n\t#endif\n\t#if defined( USE_SHEEN ) \n\t\tsheenSpecularIndirect *= ambientOcclusion;\n\t#endif\n\t#if defined( USE_ENVMAP ) && defined( STANDARD )\n\t\tfloat dotNV = saturate( dot( geometryNormal, geometryViewDir ) );\n\t\treflectedLight.indirectSpecular *= computeSpecularOcclusion( dotNV, ambientOcclusion, material.roughness );\n\t#endif\n#endif",aomap_pars_fragment:"#ifdef USE_AOMAP\n\tuniform sampler2D aoMap;\n\tuniform float aoMapIntensity;\n#endif",batching_pars_vertex:"#ifdef USE_BATCHING\n\t#if ! defined( GL_ANGLE_multi_draw )\n\t#define gl_DrawID _gl_DrawID\n\tuniform int _gl_DrawID;\n\t#endif\n\tuniform highp sampler2D batchingTexture;\n\tuniform highp usampler2D batchingIdTexture;\n\tmat4 getBatchingMatrix( const in float i ) {\n\t\tint size = textureSize( batchingTexture, 0 ).x;\n\t\tint j = int( i ) * 4;\n\t\tint x = j % size;\n\t\tint y = j / size;\n\t\tvec4 v1 = texelFetch( batchingTexture, ivec2( x, y ), 0 );\n\t\tvec4 v2 = texelFetch( batchingTexture, ivec2( x + 1, y ), 0 );\n\t\tvec4 v3 = texelFetch( batchingTexture, ivec2( x + 2, y ), 0 );\n\t\tvec4 v4 = texelFetch( batchingTexture, ivec2( x + 3, y ), 0 );\n\t\treturn mat4( v1, v2, v3, v4 );\n\t}\n\tfloat getIndirectIndex( const in int i ) {\n\t\tint size = textureSize( batchingIdTexture, 0 ).x;\n\t\tint x = i % size;\n\t\tint y = i / size;\n\t\treturn float( texelFetch( batchingIdTexture, ivec2( x, y ), 0 ).r );\n\t}\n#endif\n#ifdef USE_BATCHING_COLOR\n\tuniform sampler2D batchingColorTexture;\n\tvec3 getBatchingColor( const in float i ) {\n\t\tint size = textureSize( batchingColorTexture, 0 ).x;\n\t\tint j = int( i );\n\t\tint x = j % size;\n\t\tint y = j / size;\n\t\treturn texelFetch( batchingColorTexture, ivec2( x, y ), 0 ).rgb;\n\t}\n#endif",batching_vertex:"#ifdef USE_BATCHING\n\tmat4 batchingMatrix = getBatchingMatrix( getIndirectIndex( gl_DrawID ) );\n#endif",begin_vertex:"vec3 transformed = vec3( position );\n#ifdef USE_ALPHAHASH\n\tvPosition = vec3( position );\n#endif",beginnormal_vertex:"vec3 objectNormal = vec3( normal );\n#ifdef USE_TANGENT\n\tvec3 objectTangent = vec3( tangent.xyz );\n#endif",bsdfs:"float G_BlinnPhong_Implicit( ) {\n\treturn 0.25;\n}\nfloat D_BlinnPhong( const in float shininess, const in float dotNH ) {\n\treturn RECIPROCAL_PI * ( shininess * 0.5 + 1.0 ) * pow( dotNH, shininess );\n}\nvec3 BRDF_BlinnPhong( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in vec3 specularColor, const in float shininess ) {\n\tvec3 halfDir = normalize( lightDir + viewDir );\n\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\tfloat dotVH = saturate( dot( viewDir, halfDir ) );\n\tvec3 F = F_Schlick( specularColor, 1.0, dotVH );\n\tfloat G = G_BlinnPhong_Implicit( );\n\tfloat D = D_BlinnPhong( shininess, dotNH );\n\treturn F * ( G * D );\n} // validated",iridescence_fragment:"#ifdef USE_IRIDESCENCE\n\tconst mat3 XYZ_TO_REC709 = mat3(\n\t\t 3.2404542, -0.9692660,  0.0556434,\n\t\t-1.5371385,  1.8760108, -0.2040259,\n\t\t-0.4985314,  0.0415560,  1.0572252\n\t);\n\tvec3 Fresnel0ToIor( vec3 fresnel0 ) {\n\t\tvec3 sqrtF0 = sqrt( fresnel0 );\n\t\treturn ( vec3( 1.0 ) + sqrtF0 ) / ( vec3( 1.0 ) - sqrtF0 );\n\t}\n\tvec3 IorToFresnel0( vec3 transmittedIor, float incidentIor ) {\n\t\treturn pow2( ( transmittedIor - vec3( incidentIor ) ) / ( transmittedIor + vec3( incidentIor ) ) );\n\t}\n\tfloat IorToFresnel0( float transmittedIor, float incidentIor ) {\n\t\treturn pow2( ( transmittedIor - incidentIor ) / ( transmittedIor + incidentIor ));\n\t}\n\tvec3 evalSensitivity( float OPD, vec3 shift ) {\n\t\tfloat phase = 2.0 * PI * OPD * 1.0e-9;\n\t\tvec3 val = vec3( 5.4856e-13, 4.4201e-13, 5.2481e-13 );\n\t\tvec3 pos = vec3( 1.6810e+06, 1.7953e+06, 2.2084e+06 );\n\t\tvec3 var = vec3( 4.3278e+09, 9.3046e+09, 6.6121e+09 );\n\t\tvec3 xyz = val * sqrt( 2.0 * PI * var ) * cos( pos * phase + shift ) * exp( - pow2( phase ) * var );\n\t\txyz.x += 9.7470e-14 * sqrt( 2.0 * PI * 4.5282e+09 ) * cos( 2.2399e+06 * phase + shift[ 0 ] ) * exp( - 4.5282e+09 * pow2( phase ) );\n\t\txyz /= 1.0685e-7;\n\t\tvec3 rgb = XYZ_TO_REC709 * xyz;\n\t\treturn rgb;\n\t}\n\tvec3 evalIridescence( float outsideIOR, float eta2, float cosTheta1, float thinFilmThickness, vec3 baseF0 ) {\n\t\tvec3 I;\n\t\tfloat iridescenceIOR = mix( outsideIOR, eta2, smoothstep( 0.0, 0.03, thinFilmThickness ) );\n\t\tfloat sinTheta2Sq = pow2( outsideIOR / iridescenceIOR ) * ( 1.0 - pow2( cosTheta1 ) );\n\t\tfloat cosTheta2Sq = 1.0 - sinTheta2Sq;\n\t\tif ( cosTheta2Sq < 0.0 ) {\n\t\t\treturn vec3( 1.0 );\n\t\t}\n\t\tfloat cosTheta2 = sqrt( cosTheta2Sq );\n\t\tfloat R0 = IorToFresnel0( iridescenceIOR, outsideIOR );\n\t\tfloat R12 = F_Schlick( R0, 1.0, cosTheta1 );\n\t\tfloat T121 = 1.0 - R12;\n\t\tfloat phi12 = 0.0;\n\t\tif ( iridescenceIOR < outsideIOR ) phi12 = PI;\n\t\tfloat phi21 = PI - phi12;\n\t\tvec3 baseIOR = Fresnel0ToIor( clamp( baseF0, 0.0, 0.9999 ) );\t\tvec3 R1 = IorToFresnel0( baseIOR, iridescenceIOR );\n\t\tvec3 R23 = F_Schlick( R1, 1.0, cosTheta2 );\n\t\tvec3 phi23 = vec3( 0.0 );\n\t\tif ( baseIOR[ 0 ] < iridescenceIOR ) phi23[ 0 ] = PI;\n\t\tif ( baseIOR[ 1 ] < iridescenceIOR ) phi23[ 1 ] = PI;\n\t\tif ( baseIOR[ 2 ] < iridescenceIOR ) phi23[ 2 ] = PI;\n\t\tfloat OPD = 2.0 * iridescenceIOR * thinFilmThickness * cosTheta2;\n\t\tvec3 phi = vec3( phi21 ) + phi23;\n\t\tvec3 R123 = clamp( R12 * R23, 1e-5, 0.9999 );\n\t\tvec3 r123 = sqrt( R123 );\n\t\tvec3 Rs = pow2( T121 ) * R23 / ( vec3( 1.0 ) - R123 );\n\t\tvec3 C0 = R12 + Rs;\n\t\tI = C0;\n\t\tvec3 Cm = Rs - T121;\n\t\tfor ( int m = 1; m <= 2; ++ m ) {\n\t\t\tCm *= r123;\n\t\t\tvec3 Sm = 2.0 * evalSensitivity( float( m ) * OPD, float( m ) * phi );\n\t\t\tI += Cm * Sm;\n\t\t}\n\t\treturn max( I, vec3( 0.0 ) );\n\t}\n#endif",bumpmap_pars_fragment:"#ifdef USE_BUMPMAP\n\tuniform sampler2D bumpMap;\n\tuniform float bumpScale;\n\tvec2 dHdxy_fwd() {\n\t\tvec2 dSTdx = dFdx( vBumpMapUv );\n\t\tvec2 dSTdy = dFdy( vBumpMapUv );\n\t\tfloat Hll = bumpScale * texture2D( bumpMap, vBumpMapUv ).x;\n\t\tfloat dBx = bumpScale * texture2D( bumpMap, vBumpMapUv + dSTdx ).x - Hll;\n\t\tfloat dBy = bumpScale * texture2D( bumpMap, vBumpMapUv + dSTdy ).x - Hll;\n\t\treturn vec2( dBx, dBy );\n\t}\n\tvec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy, float faceDirection ) {\n\t\tvec3 vSigmaX = normalize( dFdx( surf_pos.xyz ) );\n\t\tvec3 vSigmaY = normalize( dFdy( surf_pos.xyz ) );\n\t\tvec3 vN = surf_norm;\n\t\tvec3 R1 = cross( vSigmaY, vN );\n\t\tvec3 R2 = cross( vN, vSigmaX );\n\t\tfloat fDet = dot( vSigmaX, R1 ) * faceDirection;\n\t\tvec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );\n\t\treturn normalize( abs( fDet ) * surf_norm - vGrad );\n\t}\n#endif",clipping_planes_fragment:"#if NUM_CLIPPING_PLANES > 0\n\tvec4 plane;\n\t#ifdef ALPHA_TO_COVERAGE\n\t\tfloat distanceToPlane, distanceGradient;\n\t\tfloat clipOpacity = 1.0;\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < UNION_CLIPPING_PLANES; i ++ ) {\n\t\t\tplane = clippingPlanes[ i ];\n\t\t\tdistanceToPlane = - dot( vClipPosition, plane.xyz ) + plane.w;\n\t\t\tdistanceGradient = fwidth( distanceToPlane ) / 2.0;\n\t\t\tclipOpacity *= smoothstep( - distanceGradient, distanceGradient, distanceToPlane );\n\t\t\tif ( clipOpacity == 0.0 ) discard;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t\t#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\n\t\t\tfloat unionClipOpacity = 1.0;\n\t\t\t#pragma unroll_loop_start\n\t\t\tfor ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; i ++ ) {\n\t\t\t\tplane = clippingPlanes[ i ];\n\t\t\t\tdistanceToPlane = - dot( vClipPosition, plane.xyz ) + plane.w;\n\t\t\t\tdistanceGradient = fwidth( distanceToPlane ) / 2.0;\n\t\t\t\tunionClipOpacity *= 1.0 - smoothstep( - distanceGradient, distanceGradient, distanceToPlane );\n\t\t\t}\n\t\t\t#pragma unroll_loop_end\n\t\t\tclipOpacity *= 1.0 - unionClipOpacity;\n\t\t#endif\n\t\tdiffuseColor.a *= clipOpacity;\n\t\tif ( diffuseColor.a == 0.0 ) discard;\n\t#else\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < UNION_CLIPPING_PLANES; i ++ ) {\n\t\t\tplane = clippingPlanes[ i ];\n\t\t\tif ( dot( vClipPosition, plane.xyz ) > plane.w ) discard;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t\t#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\n\t\t\tbool clipped = true;\n\t\t\t#pragma unroll_loop_start\n\t\t\tfor ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; i ++ ) {\n\t\t\t\tplane = clippingPlanes[ i ];\n\t\t\t\tclipped = ( dot( vClipPosition, plane.xyz ) > plane.w ) && clipped;\n\t\t\t}\n\t\t\t#pragma unroll_loop_end\n\t\t\tif ( clipped ) discard;\n\t\t#endif\n\t#endif\n#endif",clipping_planes_pars_fragment:"#if NUM_CLIPPING_PLANES > 0\n\tvarying vec3 vClipPosition;\n\tuniform vec4 clippingPlanes[ NUM_CLIPPING_PLANES ];\n#endif",clipping_planes_pars_vertex:"#if NUM_CLIPPING_PLANES > 0\n\tvarying vec3 vClipPosition;\n#endif",clipping_planes_vertex:"#if NUM_CLIPPING_PLANES > 0\n\tvClipPosition = - mvPosition.xyz;\n#endif",color_fragment:"#if defined( USE_COLOR_ALPHA )\n\tdiffuseColor *= vColor;\n#elif defined( USE_COLOR )\n\tdiffuseColor.rgb *= vColor;\n#endif",color_pars_fragment:"#if defined( USE_COLOR_ALPHA )\n\tvarying vec4 vColor;\n#elif defined( USE_COLOR )\n\tvarying vec3 vColor;\n#endif",color_pars_vertex:"#if defined( USE_COLOR_ALPHA )\n\tvarying vec4 vColor;\n#elif defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR ) || defined( USE_BATCHING_COLOR )\n\tvarying vec3 vColor;\n#endif",color_vertex:"#if defined( USE_COLOR_ALPHA )\n\tvColor = vec4( 1.0 );\n#elif defined( USE_COLOR ) || defined( USE_INSTANCING_COLOR ) || defined( USE_BATCHING_COLOR )\n\tvColor = vec3( 1.0 );\n#endif\n#ifdef USE_COLOR\n\tvColor *= color;\n#endif\n#ifdef USE_INSTANCING_COLOR\n\tvColor.xyz *= instanceColor.xyz;\n#endif\n#ifdef USE_BATCHING_COLOR\n\tvec3 batchingColor = getBatchingColor( getIndirectIndex( gl_DrawID ) );\n\tvColor.xyz *= batchingColor.xyz;\n#endif",common:"#define PI 3.141592653589793\n#define PI2 6.283185307179586\n#define PI_HALF 1.5707963267948966\n#define RECIPROCAL_PI 0.3183098861837907\n#define RECIPROCAL_PI2 0.15915494309189535\n#define EPSILON 1e-6\n#ifndef saturate\n#define saturate( a ) clamp( a, 0.0, 1.0 )\n#endif\n#define whiteComplement( a ) ( 1.0 - saturate( a ) )\nfloat pow2( const in float x ) { return x*x; }\nvec3 pow2( const in vec3 x ) { return x*x; }\nfloat pow3( const in float x ) { return x*x*x; }\nfloat pow4( const in float x ) { float x2 = x*x; return x2*x2; }\nfloat max3( const in vec3 v ) { return max( max( v.x, v.y ), v.z ); }\nfloat average( const in vec3 v ) { return dot( v, vec3( 0.3333333 ) ); }\nhighp float rand( const in vec2 uv ) {\n\tconst highp float a = 12.9898, b = 78.233, c = 43758.5453;\n\thighp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );\n\treturn fract( sin( sn ) * c );\n}\n#ifdef HIGH_PRECISION\n\tfloat precisionSafeLength( vec3 v ) { return length( v ); }\n#else\n\tfloat precisionSafeLength( vec3 v ) {\n\t\tfloat maxComponent = max3( abs( v ) );\n\t\treturn length( v / maxComponent ) * maxComponent;\n\t}\n#endif\nstruct IncidentLight {\n\tvec3 color;\n\tvec3 direction;\n\tbool visible;\n};\nstruct ReflectedLight {\n\tvec3 directDiffuse;\n\tvec3 directSpecular;\n\tvec3 indirectDiffuse;\n\tvec3 indirectSpecular;\n};\n#ifdef USE_ALPHAHASH\n\tvarying vec3 vPosition;\n#endif\nvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n}\nvec3 inverseTransformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );\n}\nmat3 transposeMat3( const in mat3 m ) {\n\tmat3 tmp;\n\ttmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );\n\ttmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );\n\ttmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );\n\treturn tmp;\n}\nbool isPerspectiveMatrix( mat4 m ) {\n\treturn m[ 2 ][ 3 ] == - 1.0;\n}\nvec2 equirectUv( in vec3 dir ) {\n\tfloat u = atan( dir.z, dir.x ) * RECIPROCAL_PI2 + 0.5;\n\tfloat v = asin( clamp( dir.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;\n\treturn vec2( u, v );\n}\nvec3 BRDF_Lambert( const in vec3 diffuseColor ) {\n\treturn RECIPROCAL_PI * diffuseColor;\n}\nvec3 F_Schlick( const in vec3 f0, const in float f90, const in float dotVH ) {\n\tfloat fresnel = exp2( ( - 5.55473 * dotVH - 6.98316 ) * dotVH );\n\treturn f0 * ( 1.0 - fresnel ) + ( f90 * fresnel );\n}\nfloat F_Schlick( const in float f0, const in float f90, const in float dotVH ) {\n\tfloat fresnel = exp2( ( - 5.55473 * dotVH - 6.98316 ) * dotVH );\n\treturn f0 * ( 1.0 - fresnel ) + ( f90 * fresnel );\n} // validated",cube_uv_reflection_fragment:"#ifdef ENVMAP_TYPE_CUBE_UV\n\t#define cubeUV_minMipLevel 4.0\n\t#define cubeUV_minTileSize 16.0\n\tfloat getFace( vec3 direction ) {\n\t\tvec3 absDirection = abs( direction );\n\t\tfloat face = - 1.0;\n\t\tif ( absDirection.x > absDirection.z ) {\n\t\t\tif ( absDirection.x > absDirection.y )\n\t\t\t\tface = direction.x > 0.0 ? 0.0 : 3.0;\n\t\t\telse\n\t\t\t\tface = direction.y > 0.0 ? 1.0 : 4.0;\n\t\t} else {\n\t\t\tif ( absDirection.z > absDirection.y )\n\t\t\t\tface = direction.z > 0.0 ? 2.0 : 5.0;\n\t\t\telse\n\t\t\t\tface = direction.y > 0.0 ? 1.0 : 4.0;\n\t\t}\n\t\treturn face;\n\t}\n\tvec2 getUV( vec3 direction, float face ) {\n\t\tvec2 uv;\n\t\tif ( face == 0.0 ) {\n\t\t\tuv = vec2( direction.z, direction.y ) / abs( direction.x );\n\t\t} else if ( face == 1.0 ) {\n\t\t\tuv = vec2( - direction.x, - direction.z ) / abs( direction.y );\n\t\t} else if ( face == 2.0 ) {\n\t\t\tuv = vec2( - direction.x, direction.y ) / abs( direction.z );\n\t\t} else if ( face == 3.0 ) {\n\t\t\tuv = vec2( - direction.z, direction.y ) / abs( direction.x );\n\t\t} else if ( face == 4.0 ) {\n\t\t\tuv = vec2( - direction.x, direction.z ) / abs( direction.y );\n\t\t} else {\n\t\t\tuv = vec2( direction.x, direction.y ) / abs( direction.z );\n\t\t}\n\t\treturn 0.5 * ( uv + 1.0 );\n\t}\n\tvec3 bilinearCubeUV( sampler2D envMap, vec3 direction, float mipInt ) {\n\t\tfloat face = getFace( direction );\n\t\tfloat filterInt = max( cubeUV_minMipLevel - mipInt, 0.0 );\n\t\tmipInt = max( mipInt, cubeUV_minMipLevel );\n\t\tfloat faceSize = exp2( mipInt );\n\t\thighp vec2 uv = getUV( direction, face ) * ( faceSize - 2.0 ) + 1.0;\n\t\tif ( face > 2.0 ) {\n\t\t\tuv.y += faceSize;\n\t\t\tface -= 3.0;\n\t\t}\n\t\tuv.x += face * faceSize;\n\t\tuv.x += filterInt * 3.0 * cubeUV_minTileSize;\n\t\tuv.y += 4.0 * ( exp2( CUBEUV_MAX_MIP ) - faceSize );\n\t\tuv.x *= CUBEUV_TEXEL_WIDTH;\n\t\tuv.y *= CUBEUV_TEXEL_HEIGHT;\n\t\t#ifdef texture2DGradEXT\n\t\t\treturn texture2DGradEXT( envMap, uv, vec2( 0.0 ), vec2( 0.0 ) ).rgb;\n\t\t#else\n\t\t\treturn texture2D( envMap, uv ).rgb;\n\t\t#endif\n\t}\n\t#define cubeUV_r0 1.0\n\t#define cubeUV_m0 - 2.0\n\t#define cubeUV_r1 0.8\n\t#define cubeUV_m1 - 1.0\n\t#define cubeUV_r4 0.4\n\t#define cubeUV_m4 2.0\n\t#define cubeUV_r5 0.305\n\t#define cubeUV_m5 3.0\n\t#define cubeUV_r6 0.21\n\t#define cubeUV_m6 4.0\n\tfloat roughnessToMip( float roughness ) {\n\t\tfloat mip = 0.0;\n\t\tif ( roughness >= cubeUV_r1 ) {\n\t\t\tmip = ( cubeUV_r0 - roughness ) * ( cubeUV_m1 - cubeUV_m0 ) / ( cubeUV_r0 - cubeUV_r1 ) + cubeUV_m0;\n\t\t} else if ( roughness >= cubeUV_r4 ) {\n\t\t\tmip = ( cubeUV_r1 - roughness ) * ( cubeUV_m4 - cubeUV_m1 ) / ( cubeUV_r1 - cubeUV_r4 ) + cubeUV_m1;\n\t\t} else if ( roughness >= cubeUV_r5 ) {\n\t\t\tmip = ( cubeUV_r4 - roughness ) * ( cubeUV_m5 - cubeUV_m4 ) / ( cubeUV_r4 - cubeUV_r5 ) + cubeUV_m4;\n\t\t} else if ( roughness >= cubeUV_r6 ) {\n\t\t\tmip = ( cubeUV_r5 - roughness ) * ( cubeUV_m6 - cubeUV_m5 ) / ( cubeUV_r5 - cubeUV_r6 ) + cubeUV_m5;\n\t\t} else {\n\t\t\tmip = - 2.0 * log2( 1.16 * roughness );\t\t}\n\t\treturn mip;\n\t}\n\tvec4 textureCubeUV( sampler2D envMap, vec3 sampleDir, float roughness ) {\n\t\tfloat mip = clamp( roughnessToMip( roughness ), cubeUV_m0, CUBEUV_MAX_MIP );\n\t\tfloat mipF = fract( mip );\n\t\tfloat mipInt = floor( mip );\n\t\tvec3 color0 = bilinearCubeUV( envMap, sampleDir, mipInt );\n\t\tif ( mipF == 0.0 ) {\n\t\t\treturn vec4( color0, 1.0 );\n\t\t} else {\n\t\t\tvec3 color1 = bilinearCubeUV( envMap, sampleDir, mipInt + 1.0 );\n\t\t\treturn vec4( mix( color0, color1, mipF ), 1.0 );\n\t\t}\n\t}\n#endif",defaultnormal_vertex:"vec3 transformedNormal = objectNormal;\n#ifdef USE_TANGENT\n\tvec3 transformedTangent = objectTangent;\n#endif\n#ifdef USE_BATCHING\n\tmat3 bm = mat3( batchingMatrix );\n\ttransformedNormal /= vec3( dot( bm[ 0 ], bm[ 0 ] ), dot( bm[ 1 ], bm[ 1 ] ), dot( bm[ 2 ], bm[ 2 ] ) );\n\ttransformedNormal = bm * transformedNormal;\n\t#ifdef USE_TANGENT\n\t\ttransformedTangent = bm * transformedTangent;\n\t#endif\n#endif\n#ifdef USE_INSTANCING\n\tmat3 im = mat3( instanceMatrix );\n\ttransformedNormal /= vec3( dot( im[ 0 ], im[ 0 ] ), dot( im[ 1 ], im[ 1 ] ), dot( im[ 2 ], im[ 2 ] ) );\n\ttransformedNormal = im * transformedNormal;\n\t#ifdef USE_TANGENT\n\t\ttransformedTangent = im * transformedTangent;\n\t#endif\n#endif\ntransformedNormal = normalMatrix * transformedNormal;\n#ifdef FLIP_SIDED\n\ttransformedNormal = - transformedNormal;\n#endif\n#ifdef USE_TANGENT\n\ttransformedTangent = ( modelViewMatrix * vec4( transformedTangent, 0.0 ) ).xyz;\n\t#ifdef FLIP_SIDED\n\t\ttransformedTangent = - transformedTangent;\n\t#endif\n#endif",displacementmap_pars_vertex:"#ifdef USE_DISPLACEMENTMAP\n\tuniform sampler2D displacementMap;\n\tuniform float displacementScale;\n\tuniform float displacementBias;\n#endif",displacementmap_vertex:"#ifdef USE_DISPLACEMENTMAP\n\ttransformed += normalize( objectNormal ) * ( texture2D( displacementMap, vDisplacementMapUv ).x * displacementScale + displacementBias );\n#endif",emissivemap_fragment:"#ifdef USE_EMISSIVEMAP\n\tvec4 emissiveColor = texture2D( emissiveMap, vEmissiveMapUv );\n\t#ifdef DECODE_VIDEO_TEXTURE_EMISSIVE\n\t\temissiveColor = sRGBTransferEOTF( emissiveColor );\n\t#endif\n\ttotalEmissiveRadiance *= emissiveColor.rgb;\n#endif",emissivemap_pars_fragment:"#ifdef USE_EMISSIVEMAP\n\tuniform sampler2D emissiveMap;\n#endif",colorspace_fragment:"gl_FragColor = linearToOutputTexel( gl_FragColor );",colorspace_pars_fragment:"vec4 LinearTransferOETF( in vec4 value ) {\n\treturn value;\n}\nvec4 sRGBTransferEOTF( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.a );\n}\nvec4 sRGBTransferOETF( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb, vec3( 0.41666 ) ) * 1.055 - vec3( 0.055 ), value.rgb * 12.92, vec3( lessThanEqual( value.rgb, vec3( 0.0031308 ) ) ) ), value.a );\n}",envmap_fragment:"#ifdef USE_ENVMAP\n\t#ifdef ENV_WORLDPOS\n\t\tvec3 cameraToFrag;\n\t\tif ( isOrthographic ) {\n\t\t\tcameraToFrag = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );\n\t\t} else {\n\t\t\tcameraToFrag = normalize( vWorldPosition - cameraPosition );\n\t\t}\n\t\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvec3 reflectVec = reflect( cameraToFrag, worldNormal );\n\t\t#else\n\t\t\tvec3 reflectVec = refract( cameraToFrag, worldNormal, refractionRatio );\n\t\t#endif\n\t#else\n\t\tvec3 reflectVec = vReflect;\n\t#endif\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tvec4 envColor = textureCube( envMap, envMapRotation * vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );\n\t#else\n\t\tvec4 envColor = vec4( 0.0 );\n\t#endif\n\t#ifdef ENVMAP_BLENDING_MULTIPLY\n\t\toutgoingLight = mix( outgoingLight, outgoingLight * envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_MIX )\n\t\toutgoingLight = mix( outgoingLight, envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_ADD )\n\t\toutgoingLight += envColor.xyz * specularStrength * reflectivity;\n\t#endif\n#endif",envmap_common_pars_fragment:"#ifdef USE_ENVMAP\n\tuniform float envMapIntensity;\n\tuniform float flipEnvMap;\n\tuniform mat3 envMapRotation;\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tuniform samplerCube envMap;\n\t#else\n\t\tuniform sampler2D envMap;\n\t#endif\n\t\n#endif",envmap_pars_fragment:"#ifdef USE_ENVMAP\n\tuniform float reflectivity;\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) || defined( LAMBERT )\n\t\t#define ENV_WORLDPOS\n\t#endif\n\t#ifdef ENV_WORLDPOS\n\t\tvarying vec3 vWorldPosition;\n\t\tuniform float refractionRatio;\n\t#else\n\t\tvarying vec3 vReflect;\n\t#endif\n#endif",envmap_pars_vertex:"#ifdef USE_ENVMAP\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) || defined( LAMBERT )\n\t\t#define ENV_WORLDPOS\n\t#endif\n\t#ifdef ENV_WORLDPOS\n\t\t\n\t\tvarying vec3 vWorldPosition;\n\t#else\n\t\tvarying vec3 vReflect;\n\t\tuniform float refractionRatio;\n\t#endif\n#endif",envmap_physical_pars_fragment:"#ifdef USE_ENVMAP\n\tvec3 getIBLIrradiance( const in vec3 normal ) {\n\t\t#ifdef ENVMAP_TYPE_CUBE_UV\n\t\t\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\t\t\tvec4 envMapColor = textureCubeUV( envMap, envMapRotation * worldNormal, 1.0 );\n\t\t\treturn PI * envMapColor.rgb * envMapIntensity;\n\t\t#else\n\t\t\treturn vec3( 0.0 );\n\t\t#endif\n\t}\n\tvec3 getIBLRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness ) {\n\t\t#ifdef ENVMAP_TYPE_CUBE_UV\n\t\t\tvec3 reflectVec = reflect( - viewDir, normal );\n\t\t\treflectVec = normalize( mix( reflectVec, normal, roughness * roughness) );\n\t\t\treflectVec = inverseTransformDirection( reflectVec, viewMatrix );\n\t\t\tvec4 envMapColor = textureCubeUV( envMap, envMapRotation * reflectVec, roughness );\n\t\t\treturn envMapColor.rgb * envMapIntensity;\n\t\t#else\n\t\t\treturn vec3( 0.0 );\n\t\t#endif\n\t}\n\t#ifdef USE_ANISOTROPY\n\t\tvec3 getIBLAnisotropyRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness, const in vec3 bitangent, const in float anisotropy ) {\n\t\t\t#ifdef ENVMAP_TYPE_CUBE_UV\n\t\t\t\tvec3 bentNormal = cross( bitangent, viewDir );\n\t\t\t\tbentNormal = normalize( cross( bentNormal, bitangent ) );\n\t\t\t\tbentNormal = normalize( mix( bentNormal, normal, pow2( pow2( 1.0 - anisotropy * ( 1.0 - roughness ) ) ) ) );\n\t\t\t\treturn getIBLRadiance( viewDir, bentNormal, roughness );\n\t\t\t#else\n\t\t\t\treturn vec3( 0.0 );\n\t\t\t#endif\n\t\t}\n\t#endif\n#endif",envmap_vertex:"#ifdef USE_ENVMAP\n\t#ifdef ENV_WORLDPOS\n\t\tvWorldPosition = worldPosition.xyz;\n\t#else\n\t\tvec3 cameraToVertex;\n\t\tif ( isOrthographic ) {\n\t\t\tcameraToVertex = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );\n\t\t} else {\n\t\t\tcameraToVertex = normalize( worldPosition.xyz - cameraPosition );\n\t\t}\n\t\tvec3 worldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvReflect = reflect( cameraToVertex, worldNormal );\n\t\t#else\n\t\t\tvReflect = refract( cameraToVertex, worldNormal, refractionRatio );\n\t\t#endif\n\t#endif\n#endif",fog_vertex:"#ifdef USE_FOG\n\tvFogDepth = - mvPosition.z;\n#endif",fog_pars_vertex:"#ifdef USE_FOG\n\tvarying float vFogDepth;\n#endif",fog_fragment:"#ifdef USE_FOG\n\t#ifdef FOG_EXP2\n\t\tfloat fogFactor = 1.0 - exp( - fogDensity * fogDensity * vFogDepth * vFogDepth );\n\t#else\n\t\tfloat fogFactor = smoothstep( fogNear, fogFar, vFogDepth );\n\t#endif\n\tgl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );\n#endif",fog_pars_fragment:"#ifdef USE_FOG\n\tuniform vec3 fogColor;\n\tvarying float vFogDepth;\n\t#ifdef FOG_EXP2\n\t\tuniform float fogDensity;\n\t#else\n\t\tuniform float fogNear;\n\t\tuniform float fogFar;\n\t#endif\n#endif",gradientmap_pars_fragment:"#ifdef USE_GRADIENTMAP\n\tuniform sampler2D gradientMap;\n#endif\nvec3 getGradientIrradiance( vec3 normal, vec3 lightDirection ) {\n\tfloat dotNL = dot( normal, lightDirection );\n\tvec2 coord = vec2( dotNL * 0.5 + 0.5, 0.0 );\n\t#ifdef USE_GRADIENTMAP\n\t\treturn vec3( texture2D( gradientMap, coord ).r );\n\t#else\n\t\tvec2 fw = fwidth( coord ) * 0.5;\n\t\treturn mix( vec3( 0.7 ), vec3( 1.0 ), smoothstep( 0.7 - fw.x, 0.7 + fw.x, coord.x ) );\n\t#endif\n}",lightmap_pars_fragment:"#ifdef USE_LIGHTMAP\n\tuniform sampler2D lightMap;\n\tuniform float lightMapIntensity;\n#endif",lights_lambert_fragment:"LambertMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;\nmaterial.specularStrength = specularStrength;",lights_lambert_pars_fragment:"varying vec3 vViewPosition;\nstruct LambertMaterial {\n\tvec3 diffuseColor;\n\tfloat specularStrength;\n};\nvoid RE_Direct_Lambert( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in LambertMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometryNormal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Lambert( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in LambertMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_Lambert\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Lambert",lights_pars_begin:"uniform bool receiveShadow;\nuniform vec3 ambientLightColor;\n#if defined( USE_LIGHT_PROBES )\n\tuniform vec3 lightProbe[ 9 ];\n#endif\nvec3 shGetIrradianceAt( in vec3 normal, in vec3 shCoefficients[ 9 ] ) {\n\tfloat x = normal.x, y = normal.y, z = normal.z;\n\tvec3 result = shCoefficients[ 0 ] * 0.886227;\n\tresult += shCoefficients[ 1 ] * 2.0 * 0.511664 * y;\n\tresult += shCoefficients[ 2 ] * 2.0 * 0.511664 * z;\n\tresult += shCoefficients[ 3 ] * 2.0 * 0.511664 * x;\n\tresult += shCoefficients[ 4 ] * 2.0 * 0.429043 * x * y;\n\tresult += shCoefficients[ 5 ] * 2.0 * 0.429043 * y * z;\n\tresult += shCoefficients[ 6 ] * ( 0.743125 * z * z - 0.247708 );\n\tresult += shCoefficients[ 7 ] * 2.0 * 0.429043 * x * z;\n\tresult += shCoefficients[ 8 ] * 0.429043 * ( x * x - y * y );\n\treturn result;\n}\nvec3 getLightProbeIrradiance( const in vec3 lightProbe[ 9 ], const in vec3 normal ) {\n\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\tvec3 irradiance = shGetIrradianceAt( worldNormal, lightProbe );\n\treturn irradiance;\n}\nvec3 getAmbientLightIrradiance( const in vec3 ambientLightColor ) {\n\tvec3 irradiance = ambientLightColor;\n\treturn irradiance;\n}\nfloat getDistanceAttenuation( const in float lightDistance, const in float cutoffDistance, const in float decayExponent ) {\n\tfloat distanceFalloff = 1.0 / max( pow( lightDistance, decayExponent ), 0.01 );\n\tif ( cutoffDistance > 0.0 ) {\n\t\tdistanceFalloff *= pow2( saturate( 1.0 - pow4( lightDistance / cutoffDistance ) ) );\n\t}\n\treturn distanceFalloff;\n}\nfloat getSpotAttenuation( const in float coneCosine, const in float penumbraCosine, const in float angleCosine ) {\n\treturn smoothstep( coneCosine, penumbraCosine, angleCosine );\n}\n#if NUM_DIR_LIGHTS > 0\n\tstruct DirectionalLight {\n\t\tvec3 direction;\n\t\tvec3 color;\n\t};\n\tuniform DirectionalLight directionalLights[ NUM_DIR_LIGHTS ];\n\tvoid getDirectionalLightInfo( const in DirectionalLight directionalLight, out IncidentLight light ) {\n\t\tlight.color = directionalLight.color;\n\t\tlight.direction = directionalLight.direction;\n\t\tlight.visible = true;\n\t}\n#endif\n#if NUM_POINT_LIGHTS > 0\n\tstruct PointLight {\n\t\tvec3 position;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t};\n\tuniform PointLight pointLights[ NUM_POINT_LIGHTS ];\n\tvoid getPointLightInfo( const in PointLight pointLight, const in vec3 geometryPosition, out IncidentLight light ) {\n\t\tvec3 lVector = pointLight.position - geometryPosition;\n\t\tlight.direction = normalize( lVector );\n\t\tfloat lightDistance = length( lVector );\n\t\tlight.color = pointLight.color;\n\t\tlight.color *= getDistanceAttenuation( lightDistance, pointLight.distance, pointLight.decay );\n\t\tlight.visible = ( light.color != vec3( 0.0 ) );\n\t}\n#endif\n#if NUM_SPOT_LIGHTS > 0\n\tstruct SpotLight {\n\t\tvec3 position;\n\t\tvec3 direction;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t\tfloat coneCos;\n\t\tfloat penumbraCos;\n\t};\n\tuniform SpotLight spotLights[ NUM_SPOT_LIGHTS ];\n\tvoid getSpotLightInfo( const in SpotLight spotLight, const in vec3 geometryPosition, out IncidentLight light ) {\n\t\tvec3 lVector = spotLight.position - geometryPosition;\n\t\tlight.direction = normalize( lVector );\n\t\tfloat angleCos = dot( light.direction, spotLight.direction );\n\t\tfloat spotAttenuation = getSpotAttenuation( spotLight.coneCos, spotLight.penumbraCos, angleCos );\n\t\tif ( spotAttenuation > 0.0 ) {\n\t\t\tfloat lightDistance = length( lVector );\n\t\t\tlight.color = spotLight.color * spotAttenuation;\n\t\t\tlight.color *= getDistanceAttenuation( lightDistance, spotLight.distance, spotLight.decay );\n\t\t\tlight.visible = ( light.color != vec3( 0.0 ) );\n\t\t} else {\n\t\t\tlight.color = vec3( 0.0 );\n\t\t\tlight.visible = false;\n\t\t}\n\t}\n#endif\n#if NUM_RECT_AREA_LIGHTS > 0\n\tstruct RectAreaLight {\n\t\tvec3 color;\n\t\tvec3 position;\n\t\tvec3 halfWidth;\n\t\tvec3 halfHeight;\n\t};\n\tuniform sampler2D ltc_1;\tuniform sampler2D ltc_2;\n\tuniform RectAreaLight rectAreaLights[ NUM_RECT_AREA_LIGHTS ];\n#endif\n#if NUM_HEMI_LIGHTS > 0\n\tstruct HemisphereLight {\n\t\tvec3 direction;\n\t\tvec3 skyColor;\n\t\tvec3 groundColor;\n\t};\n\tuniform HemisphereLight hemisphereLights[ NUM_HEMI_LIGHTS ];\n\tvec3 getHemisphereLightIrradiance( const in HemisphereLight hemiLight, const in vec3 normal ) {\n\t\tfloat dotNL = dot( normal, hemiLight.direction );\n\t\tfloat hemiDiffuseWeight = 0.5 * dotNL + 0.5;\n\t\tvec3 irradiance = mix( hemiLight.groundColor, hemiLight.skyColor, hemiDiffuseWeight );\n\t\treturn irradiance;\n\t}\n#endif",lights_toon_fragment:"ToonMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;",lights_toon_pars_fragment:"varying vec3 vViewPosition;\nstruct ToonMaterial {\n\tvec3 diffuseColor;\n};\nvoid RE_Direct_Toon( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {\n\tvec3 irradiance = getGradientIrradiance( geometryNormal, directLight.direction ) * directLight.color;\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Toon( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in ToonMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_Toon\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Toon",lights_phong_fragment:"BlinnPhongMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;\nmaterial.specularColor = specular;\nmaterial.specularShininess = shininess;\nmaterial.specularStrength = specularStrength;",lights_phong_pars_fragment:"varying vec3 vViewPosition;\nstruct BlinnPhongMaterial {\n\tvec3 diffuseColor;\n\tvec3 specularColor;\n\tfloat specularShininess;\n\tfloat specularStrength;\n};\nvoid RE_Direct_BlinnPhong( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometryNormal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n\treflectedLight.directSpecular += irradiance * BRDF_BlinnPhong( directLight.direction, geometryViewDir, geometryNormal, material.specularColor, material.specularShininess ) * material.specularStrength;\n}\nvoid RE_IndirectDiffuse_BlinnPhong( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_BlinnPhong\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_BlinnPhong",lights_physical_fragment:"PhysicalMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb * ( 1.0 - metalnessFactor );\nvec3 dxy = max( abs( dFdx( nonPerturbedNormal ) ), abs( dFdy( nonPerturbedNormal ) ) );\nfloat geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );\nmaterial.roughness = max( roughnessFactor, 0.0525 );material.roughness += geometryRoughness;\nmaterial.roughness = min( material.roughness, 1.0 );\n#ifdef IOR\n\tmaterial.ior = ior;\n\t#ifdef USE_SPECULAR\n\t\tfloat specularIntensityFactor = specularIntensity;\n\t\tvec3 specularColorFactor = specularColor;\n\t\t#ifdef USE_SPECULAR_COLORMAP\n\t\t\tspecularColorFactor *= texture2D( specularColorMap, vSpecularColorMapUv ).rgb;\n\t\t#endif\n\t\t#ifdef USE_SPECULAR_INTENSITYMAP\n\t\t\tspecularIntensityFactor *= texture2D( specularIntensityMap, vSpecularIntensityMapUv ).a;\n\t\t#endif\n\t\tmaterial.specularF90 = mix( specularIntensityFactor, 1.0, metalnessFactor );\n\t#else\n\t\tfloat specularIntensityFactor = 1.0;\n\t\tvec3 specularColorFactor = vec3( 1.0 );\n\t\tmaterial.specularF90 = 1.0;\n\t#endif\n\tmaterial.specularColor = mix( min( pow2( ( material.ior - 1.0 ) / ( material.ior + 1.0 ) ) * specularColorFactor, vec3( 1.0 ) ) * specularIntensityFactor, diffuseColor.rgb, metalnessFactor );\n#else\n\tmaterial.specularColor = mix( vec3( 0.04 ), diffuseColor.rgb, metalnessFactor );\n\tmaterial.specularF90 = 1.0;\n#endif\n#ifdef USE_CLEARCOAT\n\tmaterial.clearcoat = clearcoat;\n\tmaterial.clearcoatRoughness = clearcoatRoughness;\n\tmaterial.clearcoatF0 = vec3( 0.04 );\n\tmaterial.clearcoatF90 = 1.0;\n\t#ifdef USE_CLEARCOATMAP\n\t\tmaterial.clearcoat *= texture2D( clearcoatMap, vClearcoatMapUv ).x;\n\t#endif\n\t#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\t\tmaterial.clearcoatRoughness *= texture2D( clearcoatRoughnessMap, vClearcoatRoughnessMapUv ).y;\n\t#endif\n\tmaterial.clearcoat = saturate( material.clearcoat );\tmaterial.clearcoatRoughness = max( material.clearcoatRoughness, 0.0525 );\n\tmaterial.clearcoatRoughness += geometryRoughness;\n\tmaterial.clearcoatRoughness = min( material.clearcoatRoughness, 1.0 );\n#endif\n#ifdef USE_DISPERSION\n\tmaterial.dispersion = dispersion;\n#endif\n#ifdef USE_IRIDESCENCE\n\tmaterial.iridescence = iridescence;\n\tmaterial.iridescenceIOR = iridescenceIOR;\n\t#ifdef USE_IRIDESCENCEMAP\n\t\tmaterial.iridescence *= texture2D( iridescenceMap, vIridescenceMapUv ).r;\n\t#endif\n\t#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\t\tmaterial.iridescenceThickness = (iridescenceThicknessMaximum - iridescenceThicknessMinimum) * texture2D( iridescenceThicknessMap, vIridescenceThicknessMapUv ).g + iridescenceThicknessMinimum;\n\t#else\n\t\tmaterial.iridescenceThickness = iridescenceThicknessMaximum;\n\t#endif\n#endif\n#ifdef USE_SHEEN\n\tmaterial.sheenColor = sheenColor;\n\t#ifdef USE_SHEEN_COLORMAP\n\t\tmaterial.sheenColor *= texture2D( sheenColorMap, vSheenColorMapUv ).rgb;\n\t#endif\n\tmaterial.sheenRoughness = clamp( sheenRoughness, 0.07, 1.0 );\n\t#ifdef USE_SHEEN_ROUGHNESSMAP\n\t\tmaterial.sheenRoughness *= texture2D( sheenRoughnessMap, vSheenRoughnessMapUv ).a;\n\t#endif\n#endif\n#ifdef USE_ANISOTROPY\n\t#ifdef USE_ANISOTROPYMAP\n\t\tmat2 anisotropyMat = mat2( anisotropyVector.x, anisotropyVector.y, - anisotropyVector.y, anisotropyVector.x );\n\t\tvec3 anisotropyPolar = texture2D( anisotropyMap, vAnisotropyMapUv ).rgb;\n\t\tvec2 anisotropyV = anisotropyMat * normalize( 2.0 * anisotropyPolar.rg - vec2( 1.0 ) ) * anisotropyPolar.b;\n\t#else\n\t\tvec2 anisotropyV = anisotropyVector;\n\t#endif\n\tmaterial.anisotropy = length( anisotropyV );\n\tif( material.anisotropy == 0.0 ) {\n\t\tanisotropyV = vec2( 1.0, 0.0 );\n\t} else {\n\t\tanisotropyV /= material.anisotropy;\n\t\tmaterial.anisotropy = saturate( material.anisotropy );\n\t}\n\tmaterial.alphaT = mix( pow2( material.roughness ), 1.0, pow2( material.anisotropy ) );\n\tmaterial.anisotropyT = tbn[ 0 ] * anisotropyV.x + tbn[ 1 ] * anisotropyV.y;\n\tmaterial.anisotropyB = tbn[ 1 ] * anisotropyV.x - tbn[ 0 ] * anisotropyV.y;\n#endif",lights_physical_pars_fragment:"struct PhysicalMaterial {\n\tvec3 diffuseColor;\n\tfloat roughness;\n\tvec3 specularColor;\n\tfloat specularF90;\n\tfloat dispersion;\n\t#ifdef USE_CLEARCOAT\n\t\tfloat clearcoat;\n\t\tfloat clearcoatRoughness;\n\t\tvec3 clearcoatF0;\n\t\tfloat clearcoatF90;\n\t#endif\n\t#ifdef USE_IRIDESCENCE\n\t\tfloat iridescence;\n\t\tfloat iridescenceIOR;\n\t\tfloat iridescenceThickness;\n\t\tvec3 iridescenceFresnel;\n\t\tvec3 iridescenceF0;\n\t#endif\n\t#ifdef USE_SHEEN\n\t\tvec3 sheenColor;\n\t\tfloat sheenRoughness;\n\t#endif\n\t#ifdef IOR\n\t\tfloat ior;\n\t#endif\n\t#ifdef USE_TRANSMISSION\n\t\tfloat transmission;\n\t\tfloat transmissionAlpha;\n\t\tfloat thickness;\n\t\tfloat attenuationDistance;\n\t\tvec3 attenuationColor;\n\t#endif\n\t#ifdef USE_ANISOTROPY\n\t\tfloat anisotropy;\n\t\tfloat alphaT;\n\t\tvec3 anisotropyT;\n\t\tvec3 anisotropyB;\n\t#endif\n};\nvec3 clearcoatSpecularDirect = vec3( 0.0 );\nvec3 clearcoatSpecularIndirect = vec3( 0.0 );\nvec3 sheenSpecularDirect = vec3( 0.0 );\nvec3 sheenSpecularIndirect = vec3(0.0 );\nvec3 Schlick_to_F0( const in vec3 f, const in float f90, const in float dotVH ) {\n    float x = clamp( 1.0 - dotVH, 0.0, 1.0 );\n    float x2 = x * x;\n    float x5 = clamp( x * x2 * x2, 0.0, 0.9999 );\n    return ( f - vec3( f90 ) * x5 ) / ( 1.0 - x5 );\n}\nfloat V_GGX_SmithCorrelated( const in float alpha, const in float dotNL, const in float dotNV ) {\n\tfloat a2 = pow2( alpha );\n\tfloat gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\n\tfloat gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\n\treturn 0.5 / max( gv + gl, EPSILON );\n}\nfloat D_GGX( const in float alpha, const in float dotNH ) {\n\tfloat a2 = pow2( alpha );\n\tfloat denom = pow2( dotNH ) * ( a2 - 1.0 ) + 1.0;\n\treturn RECIPROCAL_PI * a2 / pow2( denom );\n}\n#ifdef USE_ANISOTROPY\n\tfloat V_GGX_SmithCorrelated_Anisotropic( const in float alphaT, const in float alphaB, const in float dotTV, const in float dotBV, const in float dotTL, const in float dotBL, const in float dotNV, const in float dotNL ) {\n\t\tfloat gv = dotNL * length( vec3( alphaT * dotTV, alphaB * dotBV, dotNV ) );\n\t\tfloat gl = dotNV * length( vec3( alphaT * dotTL, alphaB * dotBL, dotNL ) );\n\t\tfloat v = 0.5 / ( gv + gl );\n\t\treturn saturate(v);\n\t}\n\tfloat D_GGX_Anisotropic( const in float alphaT, const in float alphaB, const in float dotNH, const in float dotTH, const in float dotBH ) {\n\t\tfloat a2 = alphaT * alphaB;\n\t\thighp vec3 v = vec3( alphaB * dotTH, alphaT * dotBH, a2 * dotNH );\n\t\thighp float v2 = dot( v, v );\n\t\tfloat w2 = a2 / v2;\n\t\treturn RECIPROCAL_PI * a2 * pow2 ( w2 );\n\t}\n#endif\n#ifdef USE_CLEARCOAT\n\tvec3 BRDF_GGX_Clearcoat( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in PhysicalMaterial material) {\n\t\tvec3 f0 = material.clearcoatF0;\n\t\tfloat f90 = material.clearcoatF90;\n\t\tfloat roughness = material.clearcoatRoughness;\n\t\tfloat alpha = pow2( roughness );\n\t\tvec3 halfDir = normalize( lightDir + viewDir );\n\t\tfloat dotNL = saturate( dot( normal, lightDir ) );\n\t\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\t\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\t\tfloat dotVH = saturate( dot( viewDir, halfDir ) );\n\t\tvec3 F = F_Schlick( f0, f90, dotVH );\n\t\tfloat V = V_GGX_SmithCorrelated( alpha, dotNL, dotNV );\n\t\tfloat D = D_GGX( alpha, dotNH );\n\t\treturn F * ( V * D );\n\t}\n#endif\nvec3 BRDF_GGX( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, const in PhysicalMaterial material ) {\n\tvec3 f0 = material.specularColor;\n\tfloat f90 = material.specularF90;\n\tfloat roughness = material.roughness;\n\tfloat alpha = pow2( roughness );\n\tvec3 halfDir = normalize( lightDir + viewDir );\n\tfloat dotNL = saturate( dot( normal, lightDir ) );\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\tfloat dotVH = saturate( dot( viewDir, halfDir ) );\n\tvec3 F = F_Schlick( f0, f90, dotVH );\n\t#ifdef USE_IRIDESCENCE\n\t\tF = mix( F, material.iridescenceFresnel, material.iridescence );\n\t#endif\n\t#ifdef USE_ANISOTROPY\n\t\tfloat dotTL = dot( material.anisotropyT, lightDir );\n\t\tfloat dotTV = dot( material.anisotropyT, viewDir );\n\t\tfloat dotTH = dot( material.anisotropyT, halfDir );\n\t\tfloat dotBL = dot( material.anisotropyB, lightDir );\n\t\tfloat dotBV = dot( material.anisotropyB, viewDir );\n\t\tfloat dotBH = dot( material.anisotropyB, halfDir );\n\t\tfloat V = V_GGX_SmithCorrelated_Anisotropic( material.alphaT, alpha, dotTV, dotBV, dotTL, dotBL, dotNV, dotNL );\n\t\tfloat D = D_GGX_Anisotropic( material.alphaT, alpha, dotNH, dotTH, dotBH );\n\t#else\n\t\tfloat V = V_GGX_SmithCorrelated( alpha, dotNL, dotNV );\n\t\tfloat D = D_GGX( alpha, dotNH );\n\t#endif\n\treturn F * ( V * D );\n}\nvec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {\n\tconst float LUT_SIZE = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS = 0.5 / LUT_SIZE;\n\tfloat dotNV = saturate( dot( N, V ) );\n\tvec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );\n\tuv = uv * LUT_SCALE + LUT_BIAS;\n\treturn uv;\n}\nfloat LTC_ClippedSphereFormFactor( const in vec3 f ) {\n\tfloat l = length( f );\n\treturn max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );\n}\nvec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {\n\tfloat x = dot( v1, v2 );\n\tfloat y = abs( x );\n\tfloat a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;\n\tfloat b = 3.4175940 + ( 4.1616724 + y ) * y;\n\tfloat v = a / b;\n\tfloat theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;\n\treturn cross( v1, v2 ) * theta_sintheta;\n}\nvec3 LTC_Evaluate( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in vec3 rectCoords[ 4 ] ) {\n\tvec3 v1 = rectCoords[ 1 ] - rectCoords[ 0 ];\n\tvec3 v2 = rectCoords[ 3 ] - rectCoords[ 0 ];\n\tvec3 lightNormal = cross( v1, v2 );\n\tif( dot( lightNormal, P - rectCoords[ 0 ] ) < 0.0 ) return vec3( 0.0 );\n\tvec3 T1, T2;\n\tT1 = normalize( V - N * dot( V, N ) );\n\tT2 = - cross( N, T1 );\n\tmat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );\n\tvec3 coords[ 4 ];\n\tcoords[ 0 ] = mat * ( rectCoords[ 0 ] - P );\n\tcoords[ 1 ] = mat * ( rectCoords[ 1 ] - P );\n\tcoords[ 2 ] = mat * ( rectCoords[ 2 ] - P );\n\tcoords[ 3 ] = mat * ( rectCoords[ 3 ] - P );\n\tcoords[ 0 ] = normalize( coords[ 0 ] );\n\tcoords[ 1 ] = normalize( coords[ 1 ] );\n\tcoords[ 2 ] = normalize( coords[ 2 ] );\n\tcoords[ 3 ] = normalize( coords[ 3 ] );\n\tvec3 vectorFormFactor = vec3( 0.0 );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );\n\tfloat result = LTC_ClippedSphereFormFactor( vectorFormFactor );\n\treturn vec3( result );\n}\n#if defined( USE_SHEEN )\nfloat D_Charlie( float roughness, float dotNH ) {\n\tfloat alpha = pow2( roughness );\n\tfloat invAlpha = 1.0 / alpha;\n\tfloat cos2h = dotNH * dotNH;\n\tfloat sin2h = max( 1.0 - cos2h, 0.0078125 );\n\treturn ( 2.0 + invAlpha ) * pow( sin2h, invAlpha * 0.5 ) / ( 2.0 * PI );\n}\nfloat V_Neubelt( float dotNV, float dotNL ) {\n\treturn saturate( 1.0 / ( 4.0 * ( dotNL + dotNV - dotNL * dotNV ) ) );\n}\nvec3 BRDF_Sheen( const in vec3 lightDir, const in vec3 viewDir, const in vec3 normal, vec3 sheenColor, const in float sheenRoughness ) {\n\tvec3 halfDir = normalize( lightDir + viewDir );\n\tfloat dotNL = saturate( dot( normal, lightDir ) );\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tfloat dotNH = saturate( dot( normal, halfDir ) );\n\tfloat D = D_Charlie( sheenRoughness, dotNH );\n\tfloat V = V_Neubelt( dotNV, dotNL );\n\treturn sheenColor * ( D * V );\n}\n#endif\nfloat IBLSheenBRDF( const in vec3 normal, const in vec3 viewDir, const in float roughness ) {\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tfloat r2 = roughness * roughness;\n\tfloat a = roughness < 0.25 ? -339.2 * r2 + 161.4 * roughness - 25.9 : -8.48 * r2 + 14.3 * roughness - 9.95;\n\tfloat b = roughness < 0.25 ? 44.0 * r2 - 23.7 * roughness + 3.26 : 1.97 * r2 - 3.27 * roughness + 0.72;\n\tfloat DG = exp( a * dotNV + b ) + ( roughness < 0.25 ? 0.0 : 0.1 * ( roughness - 0.25 ) );\n\treturn saturate( DG * RECIPROCAL_PI );\n}\nvec2 DFGApprox( const in vec3 normal, const in vec3 viewDir, const in float roughness ) {\n\tfloat dotNV = saturate( dot( normal, viewDir ) );\n\tconst vec4 c0 = vec4( - 1, - 0.0275, - 0.572, 0.022 );\n\tconst vec4 c1 = vec4( 1, 0.0425, 1.04, - 0.04 );\n\tvec4 r = roughness * c0 + c1;\n\tfloat a004 = min( r.x * r.x, exp2( - 9.28 * dotNV ) ) * r.x + r.y;\n\tvec2 fab = vec2( - 1.04, 1.04 ) * a004 + r.zw;\n\treturn fab;\n}\nvec3 EnvironmentBRDF( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float roughness ) {\n\tvec2 fab = DFGApprox( normal, viewDir, roughness );\n\treturn specularColor * fab.x + specularF90 * fab.y;\n}\n#ifdef USE_IRIDESCENCE\nvoid computeMultiscatteringIridescence( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float iridescence, const in vec3 iridescenceF0, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {\n#else\nvoid computeMultiscattering( const in vec3 normal, const in vec3 viewDir, const in vec3 specularColor, const in float specularF90, const in float roughness, inout vec3 singleScatter, inout vec3 multiScatter ) {\n#endif\n\tvec2 fab = DFGApprox( normal, viewDir, roughness );\n\t#ifdef USE_IRIDESCENCE\n\t\tvec3 Fr = mix( specularColor, iridescenceF0, iridescence );\n\t#else\n\t\tvec3 Fr = specularColor;\n\t#endif\n\tvec3 FssEss = Fr * fab.x + specularF90 * fab.y;\n\tfloat Ess = fab.x + fab.y;\n\tfloat Ems = 1.0 - Ess;\n\tvec3 Favg = Fr + ( 1.0 - Fr ) * 0.047619;\tvec3 Fms = FssEss * Favg / ( 1.0 - Ems * Favg );\n\tsingleScatter += FssEss;\n\tmultiScatter += Fms * Ems;\n}\n#if NUM_RECT_AREA_LIGHTS > 0\n\tvoid RE_Direct_RectArea_Physical( const in RectAreaLight rectAreaLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\t\tvec3 normal = geometryNormal;\n\t\tvec3 viewDir = geometryViewDir;\n\t\tvec3 position = geometryPosition;\n\t\tvec3 lightPos = rectAreaLight.position;\n\t\tvec3 halfWidth = rectAreaLight.halfWidth;\n\t\tvec3 halfHeight = rectAreaLight.halfHeight;\n\t\tvec3 lightColor = rectAreaLight.color;\n\t\tfloat roughness = material.roughness;\n\t\tvec3 rectCoords[ 4 ];\n\t\trectCoords[ 0 ] = lightPos + halfWidth - halfHeight;\t\trectCoords[ 1 ] = lightPos - halfWidth - halfHeight;\n\t\trectCoords[ 2 ] = lightPos - halfWidth + halfHeight;\n\t\trectCoords[ 3 ] = lightPos + halfWidth + halfHeight;\n\t\tvec2 uv = LTC_Uv( normal, viewDir, roughness );\n\t\tvec4 t1 = texture2D( ltc_1, uv );\n\t\tvec4 t2 = texture2D( ltc_2, uv );\n\t\tmat3 mInv = mat3(\n\t\t\tvec3( t1.x, 0, t1.y ),\n\t\t\tvec3(    0, 1,    0 ),\n\t\t\tvec3( t1.z, 0, t1.w )\n\t\t);\n\t\tvec3 fresnel = ( material.specularColor * t2.x + ( vec3( 1.0 ) - material.specularColor ) * t2.y );\n\t\treflectedLight.directSpecular += lightColor * fresnel * LTC_Evaluate( normal, viewDir, position, mInv, rectCoords );\n\t\treflectedLight.directDiffuse += lightColor * material.diffuseColor * LTC_Evaluate( normal, viewDir, position, mat3( 1.0 ), rectCoords );\n\t}\n#endif\nvoid RE_Direct_Physical( const in IncidentLight directLight, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometryNormal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\t#ifdef USE_CLEARCOAT\n\t\tfloat dotNLcc = saturate( dot( geometryClearcoatNormal, directLight.direction ) );\n\t\tvec3 ccIrradiance = dotNLcc * directLight.color;\n\t\tclearcoatSpecularDirect += ccIrradiance * BRDF_GGX_Clearcoat( directLight.direction, geometryViewDir, geometryClearcoatNormal, material );\n\t#endif\n\t#ifdef USE_SHEEN\n\t\tsheenSpecularDirect += irradiance * BRDF_Sheen( directLight.direction, geometryViewDir, geometryNormal, material.sheenColor, material.sheenRoughness );\n\t#endif\n\treflectedLight.directSpecular += irradiance * BRDF_GGX( directLight.direction, geometryViewDir, geometryNormal, material );\n\treflectedLight.directDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectDiffuse_Physical( const in vec3 irradiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectSpecular_Physical( const in vec3 radiance, const in vec3 irradiance, const in vec3 clearcoatRadiance, const in vec3 geometryPosition, const in vec3 geometryNormal, const in vec3 geometryViewDir, const in vec3 geometryClearcoatNormal, const in PhysicalMaterial material, inout ReflectedLight reflectedLight) {\n\t#ifdef USE_CLEARCOAT\n\t\tclearcoatSpecularIndirect += clearcoatRadiance * EnvironmentBRDF( geometryClearcoatNormal, geometryViewDir, material.clearcoatF0, material.clearcoatF90, material.clearcoatRoughness );\n\t#endif\n\t#ifdef USE_SHEEN\n\t\tsheenSpecularIndirect += irradiance * material.sheenColor * IBLSheenBRDF( geometryNormal, geometryViewDir, material.sheenRoughness );\n\t#endif\n\tvec3 singleScattering = vec3( 0.0 );\n\tvec3 multiScattering = vec3( 0.0 );\n\tvec3 cosineWeightedIrradiance = irradiance * RECIPROCAL_PI;\n\t#ifdef USE_IRIDESCENCE\n\t\tcomputeMultiscatteringIridescence( geometryNormal, geometryViewDir, material.specularColor, material.specularF90, material.iridescence, material.iridescenceFresnel, material.roughness, singleScattering, multiScattering );\n\t#else\n\t\tcomputeMultiscattering( geometryNormal, geometryViewDir, material.specularColor, material.specularF90, material.roughness, singleScattering, multiScattering );\n\t#endif\n\tvec3 totalScattering = singleScattering + multiScattering;\n\tvec3 diffuse = material.diffuseColor * ( 1.0 - max( max( totalScattering.r, totalScattering.g ), totalScattering.b ) );\n\treflectedLight.indirectSpecular += radiance * singleScattering;\n\treflectedLight.indirectSpecular += multiScattering * cosineWeightedIrradiance;\n\treflectedLight.indirectDiffuse += diffuse * cosineWeightedIrradiance;\n}\n#define RE_Direct\t\t\t\tRE_Direct_Physical\n#define RE_Direct_RectArea\t\tRE_Direct_RectArea_Physical\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Physical\n#define RE_IndirectSpecular\t\tRE_IndirectSpecular_Physical\nfloat computeSpecularOcclusion( const in float dotNV, const in float ambientOcclusion, const in float roughness ) {\n\treturn saturate( pow( dotNV + ambientOcclusion, exp2( - 16.0 * roughness - 1.0 ) ) - 1.0 + ambientOcclusion );\n}",lights_fragment_begin:"\nvec3 geometryPosition = - vViewPosition;\nvec3 geometryNormal = normal;\nvec3 geometryViewDir = ( isOrthographic ) ? vec3( 0, 0, 1 ) : normalize( vViewPosition );\nvec3 geometryClearcoatNormal = vec3( 0.0 );\n#ifdef USE_CLEARCOAT\n\tgeometryClearcoatNormal = clearcoatNormal;\n#endif\n#ifdef USE_IRIDESCENCE\n\tfloat dotNVi = saturate( dot( normal, geometryViewDir ) );\n\tif ( material.iridescenceThickness == 0.0 ) {\n\t\tmaterial.iridescence = 0.0;\n\t} else {\n\t\tmaterial.iridescence = saturate( material.iridescence );\n\t}\n\tif ( material.iridescence > 0.0 ) {\n\t\tmaterial.iridescenceFresnel = evalIridescence( 1.0, material.iridescenceIOR, dotNVi, material.iridescenceThickness, material.specularColor );\n\t\tmaterial.iridescenceF0 = Schlick_to_F0( material.iridescenceFresnel, 1.0, dotNVi );\n\t}\n#endif\nIncidentLight directLight;\n#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )\n\tPointLight pointLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_POINT_LIGHT_SHADOWS > 0\n\tPointLightShadow pointLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tpointLight = pointLights[ i ];\n\t\tgetPointLightInfo( pointLight, geometryPosition, directLight );\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_POINT_LIGHT_SHADOWS )\n\t\tpointLightShadow = pointLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getPointShadow( pointShadowMap[ i ], pointLightShadow.shadowMapSize, pointLightShadow.shadowIntensity, pointLightShadow.shadowBias, pointLightShadow.shadowRadius, vPointShadowCoord[ i ], pointLightShadow.shadowCameraNear, pointLightShadow.shadowCameraFar ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )\n\tSpotLight spotLight;\n\tvec4 spotColor;\n\tvec3 spotLightCoord;\n\tbool inSpotLightMap;\n\t#if defined( USE_SHADOWMAP ) && NUM_SPOT_LIGHT_SHADOWS > 0\n\tSpotLightShadow spotLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tspotLight = spotLights[ i ];\n\t\tgetSpotLightInfo( spotLight, geometryPosition, directLight );\n\t\t#if ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS )\n\t\t#define SPOT_LIGHT_MAP_INDEX UNROLLED_LOOP_INDEX\n\t\t#elif ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\t#define SPOT_LIGHT_MAP_INDEX NUM_SPOT_LIGHT_MAPS\n\t\t#else\n\t\t#define SPOT_LIGHT_MAP_INDEX ( UNROLLED_LOOP_INDEX - NUM_SPOT_LIGHT_SHADOWS + NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS )\n\t\t#endif\n\t\t#if ( SPOT_LIGHT_MAP_INDEX < NUM_SPOT_LIGHT_MAPS )\n\t\t\tspotLightCoord = vSpotLightCoord[ i ].xyz / vSpotLightCoord[ i ].w;\n\t\t\tinSpotLightMap = all( lessThan( abs( spotLightCoord * 2. - 1. ), vec3( 1.0 ) ) );\n\t\t\tspotColor = texture2D( spotLightMap[ SPOT_LIGHT_MAP_INDEX ], spotLightCoord.xy );\n\t\t\tdirectLight.color = inSpotLightMap ? directLight.color * spotColor.rgb : directLight.color;\n\t\t#endif\n\t\t#undef SPOT_LIGHT_MAP_INDEX\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\tspotLightShadow = spotLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( spotShadowMap[ i ], spotLightShadow.shadowMapSize, spotLightShadow.shadowIntensity, spotLightShadow.shadowBias, spotLightShadow.shadowRadius, vSpotLightCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )\n\tDirectionalLight directionalLight;\n\t#if defined( USE_SHADOWMAP ) && NUM_DIR_LIGHT_SHADOWS > 0\n\tDirectionalLightShadow directionalLightShadow;\n\t#endif\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tdirectionalLight = directionalLights[ i ];\n\t\tgetDirectionalLightInfo( directionalLight, directLight );\n\t\t#if defined( USE_SHADOWMAP ) && ( UNROLLED_LOOP_INDEX < NUM_DIR_LIGHT_SHADOWS )\n\t\tdirectionalLightShadow = directionalLightShadows[ i ];\n\t\tdirectLight.color *= ( directLight.visible && receiveShadow ) ? getShadow( directionalShadowMap[ i ], directionalLightShadow.shadowMapSize, directionalLightShadow.shadowIntensity, directionalLightShadow.shadowBias, directionalLightShadow.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )\n\tRectAreaLight rectAreaLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {\n\t\trectAreaLight = rectAreaLights[ i ];\n\t\tRE_Direct_RectArea( rectAreaLight, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n\t}\n\t#pragma unroll_loop_end\n#endif\n#if defined( RE_IndirectDiffuse )\n\tvec3 iblIrradiance = vec3( 0.0 );\n\tvec3 irradiance = getAmbientLightIrradiance( ambientLightColor );\n\t#if defined( USE_LIGHT_PROBES )\n\t\tirradiance += getLightProbeIrradiance( lightProbe, geometryNormal );\n\t#endif\n\t#if ( NUM_HEMI_LIGHTS > 0 )\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\t\t\tirradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometryNormal );\n\t\t}\n\t\t#pragma unroll_loop_end\n\t#endif\n#endif\n#if defined( RE_IndirectSpecular )\n\tvec3 radiance = vec3( 0.0 );\n\tvec3 clearcoatRadiance = vec3( 0.0 );\n#endif",lights_fragment_maps:"#if defined( RE_IndirectDiffuse )\n\t#ifdef USE_LIGHTMAP\n\t\tvec4 lightMapTexel = texture2D( lightMap, vLightMapUv );\n\t\tvec3 lightMapIrradiance = lightMapTexel.rgb * lightMapIntensity;\n\t\tirradiance += lightMapIrradiance;\n\t#endif\n\t#if defined( USE_ENVMAP ) && defined( STANDARD ) && defined( ENVMAP_TYPE_CUBE_UV )\n\t\tiblIrradiance += getIBLIrradiance( geometryNormal );\n\t#endif\n#endif\n#if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )\n\t#ifdef USE_ANISOTROPY\n\t\tradiance += getIBLAnisotropyRadiance( geometryViewDir, geometryNormal, material.roughness, material.anisotropyB, material.anisotropy );\n\t#else\n\t\tradiance += getIBLRadiance( geometryViewDir, geometryNormal, material.roughness );\n\t#endif\n\t#ifdef USE_CLEARCOAT\n\t\tclearcoatRadiance += getIBLRadiance( geometryViewDir, geometryClearcoatNormal, material.clearcoatRoughness );\n\t#endif\n#endif",lights_fragment_end:"#if defined( RE_IndirectDiffuse )\n\tRE_IndirectDiffuse( irradiance, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n#endif\n#if defined( RE_IndirectSpecular )\n\tRE_IndirectSpecular( radiance, iblIrradiance, clearcoatRadiance, geometryPosition, geometryNormal, geometryViewDir, geometryClearcoatNormal, material, reflectedLight );\n#endif",logdepthbuf_fragment:"#if defined( USE_LOGDEPTHBUF )\n\tgl_FragDepth = vIsPerspective == 0.0 ? gl_FragCoord.z : log2( vFragDepth ) * logDepthBufFC * 0.5;\n#endif",logdepthbuf_pars_fragment:"#if defined( USE_LOGDEPTHBUF )\n\tuniform float logDepthBufFC;\n\tvarying float vFragDepth;\n\tvarying float vIsPerspective;\n#endif",logdepthbuf_pars_vertex:"#ifdef USE_LOGDEPTHBUF\n\tvarying float vFragDepth;\n\tvarying float vIsPerspective;\n#endif",logdepthbuf_vertex:"#ifdef USE_LOGDEPTHBUF\n\tvFragDepth = 1.0 + gl_Position.w;\n\tvIsPerspective = float( isPerspectiveMatrix( projectionMatrix ) );\n#endif",map_fragment:"#ifdef USE_MAP\n\tvec4 sampledDiffuseColor = texture2D( map, vMapUv );\n\t#ifdef DECODE_VIDEO_TEXTURE\n\t\tsampledDiffuseColor = sRGBTransferEOTF( sampledDiffuseColor );\n\t#endif\n\tdiffuseColor *= sampledDiffuseColor;\n#endif",map_pars_fragment:"#ifdef USE_MAP\n\tuniform sampler2D map;\n#endif",map_particle_fragment:"#if defined( USE_MAP ) || defined( USE_ALPHAMAP )\n\t#if defined( USE_POINTS_UV )\n\t\tvec2 uv = vUv;\n\t#else\n\t\tvec2 uv = ( uvTransform * vec3( gl_PointCoord.x, 1.0 - gl_PointCoord.y, 1 ) ).xy;\n\t#endif\n#endif\n#ifdef USE_MAP\n\tdiffuseColor *= texture2D( map, uv );\n#endif\n#ifdef USE_ALPHAMAP\n\tdiffuseColor.a *= texture2D( alphaMap, uv ).g;\n#endif",map_particle_pars_fragment:"#if defined( USE_POINTS_UV )\n\tvarying vec2 vUv;\n#else\n\t#if defined( USE_MAP ) || defined( USE_ALPHAMAP )\n\t\tuniform mat3 uvTransform;\n\t#endif\n#endif\n#ifdef USE_MAP\n\tuniform sampler2D map;\n#endif\n#ifdef USE_ALPHAMAP\n\tuniform sampler2D alphaMap;\n#endif",metalnessmap_fragment:"float metalnessFactor = metalness;\n#ifdef USE_METALNESSMAP\n\tvec4 texelMetalness = texture2D( metalnessMap, vMetalnessMapUv );\n\tmetalnessFactor *= texelMetalness.b;\n#endif",metalnessmap_pars_fragment:"#ifdef USE_METALNESSMAP\n\tuniform sampler2D metalnessMap;\n#endif",morphinstance_vertex:"#ifdef USE_INSTANCING_MORPH\n\tfloat morphTargetInfluences[ MORPHTARGETS_COUNT ];\n\tfloat morphTargetBaseInfluence = texelFetch( morphTexture, ivec2( 0, gl_InstanceID ), 0 ).r;\n\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t\tmorphTargetInfluences[i] =  texelFetch( morphTexture, ivec2( i + 1, gl_InstanceID ), 0 ).r;\n\t}\n#endif",morphcolor_vertex:"#if defined( USE_MORPHCOLORS )\n\tvColor *= morphTargetBaseInfluence;\n\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t\t#if defined( USE_COLOR_ALPHA )\n\t\t\tif ( morphTargetInfluences[ i ] != 0.0 ) vColor += getMorph( gl_VertexID, i, 2 ) * morphTargetInfluences[ i ];\n\t\t#elif defined( USE_COLOR )\n\t\t\tif ( morphTargetInfluences[ i ] != 0.0 ) vColor += getMorph( gl_VertexID, i, 2 ).rgb * morphTargetInfluences[ i ];\n\t\t#endif\n\t}\n#endif",morphnormal_vertex:"#ifdef USE_MORPHNORMALS\n\tobjectNormal *= morphTargetBaseInfluence;\n\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t\tif ( morphTargetInfluences[ i ] != 0.0 ) objectNormal += getMorph( gl_VertexID, i, 1 ).xyz * morphTargetInfluences[ i ];\n\t}\n#endif",morphtarget_pars_vertex:"#ifdef USE_MORPHTARGETS\n\t#ifndef USE_INSTANCING_MORPH\n\t\tuniform float morphTargetBaseInfluence;\n\t\tuniform float morphTargetInfluences[ MORPHTARGETS_COUNT ];\n\t#endif\n\tuniform sampler2DArray morphTargetsTexture;\n\tuniform ivec2 morphTargetsTextureSize;\n\tvec4 getMorph( const in int vertexIndex, const in int morphTargetIndex, const in int offset ) {\n\t\tint texelIndex = vertexIndex * MORPHTARGETS_TEXTURE_STRIDE + offset;\n\t\tint y = texelIndex / morphTargetsTextureSize.x;\n\t\tint x = texelIndex - y * morphTargetsTextureSize.x;\n\t\tivec3 morphUV = ivec3( x, y, morphTargetIndex );\n\t\treturn texelFetch( morphTargetsTexture, morphUV, 0 );\n\t}\n#endif",morphtarget_vertex:"#ifdef USE_MORPHTARGETS\n\ttransformed *= morphTargetBaseInfluence;\n\tfor ( int i = 0; i < MORPHTARGETS_COUNT; i ++ ) {\n\t\tif ( morphTargetInfluences[ i ] != 0.0 ) transformed += getMorph( gl_VertexID, i, 0 ).xyz * morphTargetInfluences[ i ];\n\t}\n#endif",normal_fragment_begin:"float faceDirection = gl_FrontFacing ? 1.0 : - 1.0;\n#ifdef FLAT_SHADED\n\tvec3 fdx = dFdx( vViewPosition );\n\tvec3 fdy = dFdy( vViewPosition );\n\tvec3 normal = normalize( cross( fdx, fdy ) );\n#else\n\tvec3 normal = normalize( vNormal );\n\t#ifdef DOUBLE_SIDED\n\t\tnormal *= faceDirection;\n\t#endif\n#endif\n#if defined( USE_NORMALMAP_TANGENTSPACE ) || defined( USE_CLEARCOAT_NORMALMAP ) || defined( USE_ANISOTROPY )\n\t#ifdef USE_TANGENT\n\t\tmat3 tbn = mat3( normalize( vTangent ), normalize( vBitangent ), normal );\n\t#else\n\t\tmat3 tbn = getTangentFrame( - vViewPosition, normal,\n\t\t#if defined( USE_NORMALMAP )\n\t\t\tvNormalMapUv\n\t\t#elif defined( USE_CLEARCOAT_NORMALMAP )\n\t\t\tvClearcoatNormalMapUv\n\t\t#else\n\t\t\tvUv\n\t\t#endif\n\t\t);\n\t#endif\n\t#if defined( DOUBLE_SIDED ) && ! defined( FLAT_SHADED )\n\t\ttbn[0] *= faceDirection;\n\t\ttbn[1] *= faceDirection;\n\t#endif\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\t#ifdef USE_TANGENT\n\t\tmat3 tbn2 = mat3( normalize( vTangent ), normalize( vBitangent ), normal );\n\t#else\n\t\tmat3 tbn2 = getTangentFrame( - vViewPosition, normal, vClearcoatNormalMapUv );\n\t#endif\n\t#if defined( DOUBLE_SIDED ) && ! defined( FLAT_SHADED )\n\t\ttbn2[0] *= faceDirection;\n\t\ttbn2[1] *= faceDirection;\n\t#endif\n#endif\nvec3 nonPerturbedNormal = normal;",normal_fragment_maps:"#ifdef USE_NORMALMAP_OBJECTSPACE\n\tnormal = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0;\n\t#ifdef FLIP_SIDED\n\t\tnormal = - normal;\n\t#endif\n\t#ifdef DOUBLE_SIDED\n\t\tnormal = normal * faceDirection;\n\t#endif\n\tnormal = normalize( normalMatrix * normal );\n#elif defined( USE_NORMALMAP_TANGENTSPACE )\n\tvec3 mapN = texture2D( normalMap, vNormalMapUv ).xyz * 2.0 - 1.0;\n\tmapN.xy *= normalScale;\n\tnormal = normalize( tbn * mapN );\n#elif defined( USE_BUMPMAP )\n\tnormal = perturbNormalArb( - vViewPosition, normal, dHdxy_fwd(), faceDirection );\n#endif",normal_pars_fragment:"#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif",normal_pars_vertex:"#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n\t#ifdef USE_TANGENT\n\t\tvarying vec3 vTangent;\n\t\tvarying vec3 vBitangent;\n\t#endif\n#endif",normal_vertex:"#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n\t#ifdef USE_TANGENT\n\t\tvTangent = normalize( transformedTangent );\n\t\tvBitangent = normalize( cross( vNormal, vTangent ) * tangent.w );\n\t#endif\n#endif",normalmap_pars_fragment:"#ifdef USE_NORMALMAP\n\tuniform sampler2D normalMap;\n\tuniform vec2 normalScale;\n#endif\n#ifdef USE_NORMALMAP_OBJECTSPACE\n\tuniform mat3 normalMatrix;\n#endif\n#if ! defined ( USE_TANGENT ) && ( defined ( USE_NORMALMAP_TANGENTSPACE ) || defined ( USE_CLEARCOAT_NORMALMAP ) || defined( USE_ANISOTROPY ) )\n\tmat3 getTangentFrame( vec3 eye_pos, vec3 surf_norm, vec2 uv ) {\n\t\tvec3 q0 = dFdx( eye_pos.xyz );\n\t\tvec3 q1 = dFdy( eye_pos.xyz );\n\t\tvec2 st0 = dFdx( uv.st );\n\t\tvec2 st1 = dFdy( uv.st );\n\t\tvec3 N = surf_norm;\n\t\tvec3 q1perp = cross( q1, N );\n\t\tvec3 q0perp = cross( N, q0 );\n\t\tvec3 T = q1perp * st0.x + q0perp * st1.x;\n\t\tvec3 B = q1perp * st0.y + q0perp * st1.y;\n\t\tfloat det = max( dot( T, T ), dot( B, B ) );\n\t\tfloat scale = ( det == 0.0 ) ? 0.0 : inversesqrt( det );\n\t\treturn mat3( T * scale, B * scale, N );\n\t}\n#endif",clearcoat_normal_fragment_begin:"#ifdef USE_CLEARCOAT\n\tvec3 clearcoatNormal = nonPerturbedNormal;\n#endif",clearcoat_normal_fragment_maps:"#ifdef USE_CLEARCOAT_NORMALMAP\n\tvec3 clearcoatMapN = texture2D( clearcoatNormalMap, vClearcoatNormalMapUv ).xyz * 2.0 - 1.0;\n\tclearcoatMapN.xy *= clearcoatNormalScale;\n\tclearcoatNormal = normalize( tbn2 * clearcoatMapN );\n#endif",clearcoat_pars_fragment:"#ifdef USE_CLEARCOATMAP\n\tuniform sampler2D clearcoatMap;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tuniform sampler2D clearcoatNormalMap;\n\tuniform vec2 clearcoatNormalScale;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tuniform sampler2D clearcoatRoughnessMap;\n#endif",iridescence_pars_fragment:"#ifdef USE_IRIDESCENCEMAP\n\tuniform sampler2D iridescenceMap;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tuniform sampler2D iridescenceThicknessMap;\n#endif",opaque_fragment:"#ifdef OPAQUE\ndiffuseColor.a = 1.0;\n#endif\n#ifdef USE_TRANSMISSION\ndiffuseColor.a *= material.transmissionAlpha;\n#endif\ngl_FragColor = vec4( outgoingLight, diffuseColor.a );",packing:"vec3 packNormalToRGB( const in vec3 normal ) {\n\treturn normalize( normal ) * 0.5 + 0.5;\n}\nvec3 unpackRGBToNormal( const in vec3 rgb ) {\n\treturn 2.0 * rgb.xyz - 1.0;\n}\nconst float PackUpscale = 256. / 255.;const float UnpackDownscale = 255. / 256.;const float ShiftRight8 = 1. / 256.;\nconst float Inv255 = 1. / 255.;\nconst vec4 PackFactors = vec4( 1.0, 256.0, 256.0 * 256.0, 256.0 * 256.0 * 256.0 );\nconst vec2 UnpackFactors2 = vec2( UnpackDownscale, 1.0 / PackFactors.g );\nconst vec3 UnpackFactors3 = vec3( UnpackDownscale / PackFactors.rg, 1.0 / PackFactors.b );\nconst vec4 UnpackFactors4 = vec4( UnpackDownscale / PackFactors.rgb, 1.0 / PackFactors.a );\nvec4 packDepthToRGBA( const in float v ) {\n\tif( v <= 0.0 )\n\t\treturn vec4( 0., 0., 0., 0. );\n\tif( v >= 1.0 )\n\t\treturn vec4( 1., 1., 1., 1. );\n\tfloat vuf;\n\tfloat af = modf( v * PackFactors.a, vuf );\n\tfloat bf = modf( vuf * ShiftRight8, vuf );\n\tfloat gf = modf( vuf * ShiftRight8, vuf );\n\treturn vec4( vuf * Inv255, gf * PackUpscale, bf * PackUpscale, af );\n}\nvec3 packDepthToRGB( const in float v ) {\n\tif( v <= 0.0 )\n\t\treturn vec3( 0., 0., 0. );\n\tif( v >= 1.0 )\n\t\treturn vec3( 1., 1., 1. );\n\tfloat vuf;\n\tfloat bf = modf( v * PackFactors.b, vuf );\n\tfloat gf = modf( vuf * ShiftRight8, vuf );\n\treturn vec3( vuf * Inv255, gf * PackUpscale, bf );\n}\nvec2 packDepthToRG( const in float v ) {\n\tif( v <= 0.0 )\n\t\treturn vec2( 0., 0. );\n\tif( v >= 1.0 )\n\t\treturn vec2( 1., 1. );\n\tfloat vuf;\n\tfloat gf = modf( v * 256., vuf );\n\treturn vec2( vuf * Inv255, gf );\n}\nfloat unpackRGBAToDepth( const in vec4 v ) {\n\treturn dot( v, UnpackFactors4 );\n}\nfloat unpackRGBToDepth( const in vec3 v ) {\n\treturn dot( v, UnpackFactors3 );\n}\nfloat unpackRGToDepth( const in vec2 v ) {\n\treturn v.r * UnpackFactors2.r + v.g * UnpackFactors2.g;\n}\nvec4 pack2HalfToRGBA( const in vec2 v ) {\n\tvec4 r = vec4( v.x, fract( v.x * 255.0 ), v.y, fract( v.y * 255.0 ) );\n\treturn vec4( r.x - r.y / 255.0, r.y, r.z - r.w / 255.0, r.w );\n}\nvec2 unpackRGBATo2Half( const in vec4 v ) {\n\treturn vec2( v.x + ( v.y / 255.0 ), v.z + ( v.w / 255.0 ) );\n}\nfloat viewZToOrthographicDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn ( viewZ + near ) / ( near - far );\n}\nfloat orthographicDepthToViewZ( const in float depth, const in float near, const in float far ) {\n\treturn depth * ( near - far ) - near;\n}\nfloat viewZToPerspectiveDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn ( ( near + viewZ ) * far ) / ( ( far - near ) * viewZ );\n}\nfloat perspectiveDepthToViewZ( const in float depth, const in float near, const in float far ) {\n\treturn ( near * far ) / ( ( far - near ) * depth - far );\n}",premultiplied_alpha_fragment:"#ifdef PREMULTIPLIED_ALPHA\n\tgl_FragColor.rgb *= gl_FragColor.a;\n#endif",project_vertex:"vec4 mvPosition = vec4( transformed, 1.0 );\n#ifdef USE_BATCHING\n\tmvPosition = batchingMatrix * mvPosition;\n#endif\n#ifdef USE_INSTANCING\n\tmvPosition = instanceMatrix * mvPosition;\n#endif\nmvPosition = modelViewMatrix * mvPosition;\ngl_Position = projectionMatrix * mvPosition;",dithering_fragment:"#ifdef DITHERING\n\tgl_FragColor.rgb = dithering( gl_FragColor.rgb );\n#endif",dithering_pars_fragment:"#ifdef DITHERING\n\tvec3 dithering( vec3 color ) {\n\t\tfloat grid_position = rand( gl_FragCoord.xy );\n\t\tvec3 dither_shift_RGB = vec3( 0.25 / 255.0, -0.25 / 255.0, 0.25 / 255.0 );\n\t\tdither_shift_RGB = mix( 2.0 * dither_shift_RGB, -2.0 * dither_shift_RGB, grid_position );\n\t\treturn color + dither_shift_RGB;\n\t}\n#endif",roughnessmap_fragment:"float roughnessFactor = roughness;\n#ifdef USE_ROUGHNESSMAP\n\tvec4 texelRoughness = texture2D( roughnessMap, vRoughnessMapUv );\n\troughnessFactor *= texelRoughness.g;\n#endif",roughnessmap_pars_fragment:"#ifdef USE_ROUGHNESSMAP\n\tuniform sampler2D roughnessMap;\n#endif",shadowmap_pars_fragment:"#if NUM_SPOT_LIGHT_COORDS > 0\n\tvarying vec4 vSpotLightCoord[ NUM_SPOT_LIGHT_COORDS ];\n#endif\n#if NUM_SPOT_LIGHT_MAPS > 0\n\tuniform sampler2D spotLightMap[ NUM_SPOT_LIGHT_MAPS ];\n#endif\n#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D directionalShadowMap[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tstruct DirectionalLightShadow {\n\t\t\tfloat shadowIntensity;\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D spotShadowMap[ NUM_SPOT_LIGHT_SHADOWS ];\n\t\tstruct SpotLightShadow {\n\t\t\tfloat shadowIntensity;\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\tuniform sampler2D pointShadowMap[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tstruct PointLightShadow {\n\t\t\tfloat shadowIntensity;\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t\tfloat shadowCameraNear;\n\t\t\tfloat shadowCameraFar;\n\t\t};\n\t\tuniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];\n\t#endif\n\tfloat texture2DCompare( sampler2D depths, vec2 uv, float compare ) {\n\t\treturn step( compare, unpackRGBAToDepth( texture2D( depths, uv ) ) );\n\t}\n\tvec2 texture2DDistribution( sampler2D shadow, vec2 uv ) {\n\t\treturn unpackRGBATo2Half( texture2D( shadow, uv ) );\n\t}\n\tfloat VSMShadow (sampler2D shadow, vec2 uv, float compare ){\n\t\tfloat occlusion = 1.0;\n\t\tvec2 distribution = texture2DDistribution( shadow, uv );\n\t\tfloat hard_shadow = step( compare , distribution.x );\n\t\tif (hard_shadow != 1.0 ) {\n\t\t\tfloat distance = compare - distribution.x ;\n\t\t\tfloat variance = max( 0.00000, distribution.y * distribution.y );\n\t\t\tfloat softness_probability = variance / (variance + distance * distance );\t\t\tsoftness_probability = clamp( ( softness_probability - 0.3 ) / ( 0.95 - 0.3 ), 0.0, 1.0 );\t\t\tocclusion = clamp( max( hard_shadow, softness_probability ), 0.0, 1.0 );\n\t\t}\n\t\treturn occlusion;\n\t}\n\tfloat getShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowIntensity, float shadowBias, float shadowRadius, vec4 shadowCoord ) {\n\t\tfloat shadow = 1.0;\n\t\tshadowCoord.xyz /= shadowCoord.w;\n\t\tshadowCoord.z += shadowBias;\n\t\tbool inFrustum = shadowCoord.x >= 0.0 && shadowCoord.x <= 1.0 && shadowCoord.y >= 0.0 && shadowCoord.y <= 1.0;\n\t\tbool frustumTest = inFrustum && shadowCoord.z <= 1.0;\n\t\tif ( frustumTest ) {\n\t\t#if defined( SHADOWMAP_TYPE_PCF )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx0 = - texelSize.x * shadowRadius;\n\t\t\tfloat dy0 = - texelSize.y * shadowRadius;\n\t\t\tfloat dx1 = + texelSize.x * shadowRadius;\n\t\t\tfloat dy1 = + texelSize.y * shadowRadius;\n\t\t\tfloat dx2 = dx0 / 2.0;\n\t\t\tfloat dy2 = dy0 / 2.0;\n\t\t\tfloat dx3 = dx1 / 2.0;\n\t\t\tfloat dy3 = dy1 / 2.0;\n\t\t\tshadow = (\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy2 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx2, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx3, dy3 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )\n\t\t\t) * ( 1.0 / 17.0 );\n\t\t#elif defined( SHADOWMAP_TYPE_PCF_SOFT )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx = texelSize.x;\n\t\t\tfloat dy = texelSize.y;\n\t\t\tvec2 uv = shadowCoord.xy;\n\t\t\tvec2 f = fract( uv * shadowMapSize + 0.5 );\n\t\t\tuv -= f * texelSize;\n\t\t\tshadow = (\n\t\t\t\ttexture2DCompare( shadowMap, uv, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + vec2( dx, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + vec2( 0.0, dy ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, uv + texelSize, shadowCoord.z ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( -dx, 0.0 ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 0.0 ), shadowCoord.z ),\n\t\t\t\t\t f.x ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( -dx, dy ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, dy ), shadowCoord.z ),\n\t\t\t\t\t f.x ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( 0.0, -dy ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( 0.0, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t f.y ) +\n\t\t\t\tmix( texture2DCompare( shadowMap, uv + vec2( dx, -dy ), shadowCoord.z ),\n\t\t\t\t\t texture2DCompare( shadowMap, uv + vec2( dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t f.y ) +\n\t\t\t\tmix( mix( texture2DCompare( shadowMap, uv + vec2( -dx, -dy ), shadowCoord.z ),\n\t\t\t\t\t\t  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, -dy ), shadowCoord.z ),\n\t\t\t\t\t\t  f.x ),\n\t\t\t\t\t mix( texture2DCompare( shadowMap, uv + vec2( -dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t\t  texture2DCompare( shadowMap, uv + vec2( 2.0 * dx, 2.0 * dy ), shadowCoord.z ),\n\t\t\t\t\t\t  f.x ),\n\t\t\t\t\t f.y )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#elif defined( SHADOWMAP_TYPE_VSM )\n\t\t\tshadow = VSMShadow( shadowMap, shadowCoord.xy, shadowCoord.z );\n\t\t#else\n\t\t\tshadow = texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );\n\t\t#endif\n\t\t}\n\t\treturn mix( 1.0, shadow, shadowIntensity );\n\t}\n\tvec2 cubeToUV( vec3 v, float texelSizeY ) {\n\t\tvec3 absV = abs( v );\n\t\tfloat scaleToCube = 1.0 / max( absV.x, max( absV.y, absV.z ) );\n\t\tabsV *= scaleToCube;\n\t\tv *= scaleToCube * ( 1.0 - 2.0 * texelSizeY );\n\t\tvec2 planar = v.xy;\n\t\tfloat almostATexel = 1.5 * texelSizeY;\n\t\tfloat almostOne = 1.0 - almostATexel;\n\t\tif ( absV.z >= almostOne ) {\n\t\t\tif ( v.z > 0.0 )\n\t\t\t\tplanar.x = 4.0 - v.x;\n\t\t} else if ( absV.x >= almostOne ) {\n\t\t\tfloat signX = sign( v.x );\n\t\t\tplanar.x = v.z * signX + 2.0 * signX;\n\t\t} else if ( absV.y >= almostOne ) {\n\t\t\tfloat signY = sign( v.y );\n\t\t\tplanar.x = v.x + 2.0 * signY + 2.0;\n\t\t\tplanar.y = v.z * signY - 2.0;\n\t\t}\n\t\treturn vec2( 0.125, 0.25 ) * planar + vec2( 0.375, 0.75 );\n\t}\n\tfloat getPointShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowIntensity, float shadowBias, float shadowRadius, vec4 shadowCoord, float shadowCameraNear, float shadowCameraFar ) {\n\t\tfloat shadow = 1.0;\n\t\tvec3 lightToPosition = shadowCoord.xyz;\n\t\t\n\t\tfloat lightToPositionLength = length( lightToPosition );\n\t\tif ( lightToPositionLength - shadowCameraFar <= 0.0 && lightToPositionLength - shadowCameraNear >= 0.0 ) {\n\t\t\tfloat dp = ( lightToPositionLength - shadowCameraNear ) / ( shadowCameraFar - shadowCameraNear );\t\t\tdp += shadowBias;\n\t\t\tvec3 bd3D = normalize( lightToPosition );\n\t\t\tvec2 texelSize = vec2( 1.0 ) / ( shadowMapSize * vec2( 4.0, 2.0 ) );\n\t\t\t#if defined( SHADOWMAP_TYPE_PCF ) || defined( SHADOWMAP_TYPE_PCF_SOFT ) || defined( SHADOWMAP_TYPE_VSM )\n\t\t\t\tvec2 offset = vec2( - 1, 1 ) * shadowRadius * texelSize.y;\n\t\t\t\tshadow = (\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyy, texelSize.y ), dp ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyy, texelSize.y ), dp ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyx, texelSize.y ), dp ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyx, texelSize.y ), dp ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxy, texelSize.y ), dp ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxy, texelSize.y ), dp ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxx, texelSize.y ), dp ) +\n\t\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxx, texelSize.y ), dp )\n\t\t\t\t) * ( 1.0 / 9.0 );\n\t\t\t#else\n\t\t\t\tshadow = texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp );\n\t\t\t#endif\n\t\t}\n\t\treturn mix( 1.0, shadow, shadowIntensity );\n\t}\n#endif",shadowmap_pars_vertex:"#if NUM_SPOT_LIGHT_COORDS > 0\n\tuniform mat4 spotLightMatrix[ NUM_SPOT_LIGHT_COORDS ];\n\tvarying vec4 vSpotLightCoord[ NUM_SPOT_LIGHT_COORDS ];\n#endif\n#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\tuniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHT_SHADOWS ];\n\t\tstruct DirectionalLightShadow {\n\t\t\tfloat shadowIntensity;\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform DirectionalLightShadow directionalLightShadows[ NUM_DIR_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\t\tstruct SpotLightShadow {\n\t\t\tfloat shadowIntensity;\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t};\n\t\tuniform SpotLightShadow spotLightShadows[ NUM_SPOT_LIGHT_SHADOWS ];\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\tuniform mat4 pointShadowMatrix[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHT_SHADOWS ];\n\t\tstruct PointLightShadow {\n\t\t\tfloat shadowIntensity;\n\t\t\tfloat shadowBias;\n\t\t\tfloat shadowNormalBias;\n\t\t\tfloat shadowRadius;\n\t\t\tvec2 shadowMapSize;\n\t\t\tfloat shadowCameraNear;\n\t\t\tfloat shadowCameraFar;\n\t\t};\n\t\tuniform PointLightShadow pointLightShadows[ NUM_POINT_LIGHT_SHADOWS ];\n\t#endif\n#endif",shadowmap_vertex:"#if ( defined( USE_SHADOWMAP ) && ( NUM_DIR_LIGHT_SHADOWS > 0 || NUM_POINT_LIGHT_SHADOWS > 0 ) ) || ( NUM_SPOT_LIGHT_COORDS > 0 )\n\tvec3 shadowWorldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\tvec4 shadowWorldPosition;\n#endif\n#if defined( USE_SHADOWMAP )\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {\n\t\t\tshadowWorldPosition = worldPosition + vec4( shadowWorldNormal * directionalLightShadows[ i ].shadowNormalBias, 0 );\n\t\t\tvDirectionalShadowCoord[ i ] = directionalShadowMatrix[ i ] * shadowWorldPosition;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\t\t#pragma unroll_loop_start\n\t\tfor ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {\n\t\t\tshadowWorldPosition = worldPosition + vec4( shadowWorldNormal * pointLightShadows[ i ].shadowNormalBias, 0 );\n\t\t\tvPointShadowCoord[ i ] = pointShadowMatrix[ i ] * shadowWorldPosition;\n\t\t}\n\t\t#pragma unroll_loop_end\n\t#endif\n#endif\n#if NUM_SPOT_LIGHT_COORDS > 0\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHT_COORDS; i ++ ) {\n\t\tshadowWorldPosition = worldPosition;\n\t\t#if ( defined( USE_SHADOWMAP ) && UNROLLED_LOOP_INDEX < NUM_SPOT_LIGHT_SHADOWS )\n\t\t\tshadowWorldPosition.xyz += shadowWorldNormal * spotLightShadows[ i ].shadowNormalBias;\n\t\t#endif\n\t\tvSpotLightCoord[ i ] = spotLightMatrix[ i ] * shadowWorldPosition;\n\t}\n\t#pragma unroll_loop_end\n#endif",shadowmask_pars_fragment:"float getShadowMask() {\n\tfloat shadow = 1.0;\n\t#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHT_SHADOWS > 0\n\tDirectionalLightShadow directionalLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_DIR_LIGHT_SHADOWS; i ++ ) {\n\t\tdirectionalLight = directionalLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowIntensity, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_SPOT_LIGHT_SHADOWS > 0\n\tSpotLightShadow spotLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_SPOT_LIGHT_SHADOWS; i ++ ) {\n\t\tspotLight = spotLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowIntensity, spotLight.shadowBias, spotLight.shadowRadius, vSpotLightCoord[ i ] ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#if NUM_POINT_LIGHT_SHADOWS > 0\n\tPointLightShadow pointLight;\n\t#pragma unroll_loop_start\n\tfor ( int i = 0; i < NUM_POINT_LIGHT_SHADOWS; i ++ ) {\n\t\tpointLight = pointLightShadows[ i ];\n\t\tshadow *= receiveShadow ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowIntensity, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ], pointLight.shadowCameraNear, pointLight.shadowCameraFar ) : 1.0;\n\t}\n\t#pragma unroll_loop_end\n\t#endif\n\t#endif\n\treturn shadow;\n}",skinbase_vertex:"#ifdef USE_SKINNING\n\tmat4 boneMatX = getBoneMatrix( skinIndex.x );\n\tmat4 boneMatY = getBoneMatrix( skinIndex.y );\n\tmat4 boneMatZ = getBoneMatrix( skinIndex.z );\n\tmat4 boneMatW = getBoneMatrix( skinIndex.w );\n#endif",skinning_pars_vertex:"#ifdef USE_SKINNING\n\tuniform mat4 bindMatrix;\n\tuniform mat4 bindMatrixInverse;\n\tuniform highp sampler2D boneTexture;\n\tmat4 getBoneMatrix( const in float i ) {\n\t\tint size = textureSize( boneTexture, 0 ).x;\n\t\tint j = int( i ) * 4;\n\t\tint x = j % size;\n\t\tint y = j / size;\n\t\tvec4 v1 = texelFetch( boneTexture, ivec2( x, y ), 0 );\n\t\tvec4 v2 = texelFetch( boneTexture, ivec2( x + 1, y ), 0 );\n\t\tvec4 v3 = texelFetch( boneTexture, ivec2( x + 2, y ), 0 );\n\t\tvec4 v4 = texelFetch( boneTexture, ivec2( x + 3, y ), 0 );\n\t\treturn mat4( v1, v2, v3, v4 );\n\t}\n#endif",skinning_vertex:"#ifdef USE_SKINNING\n\tvec4 skinVertex = bindMatrix * vec4( transformed, 1.0 );\n\tvec4 skinned = vec4( 0.0 );\n\tskinned += boneMatX * skinVertex * skinWeight.x;\n\tskinned += boneMatY * skinVertex * skinWeight.y;\n\tskinned += boneMatZ * skinVertex * skinWeight.z;\n\tskinned += boneMatW * skinVertex * skinWeight.w;\n\ttransformed = ( bindMatrixInverse * skinned ).xyz;\n#endif",skinnormal_vertex:"#ifdef USE_SKINNING\n\tmat4 skinMatrix = mat4( 0.0 );\n\tskinMatrix += skinWeight.x * boneMatX;\n\tskinMatrix += skinWeight.y * boneMatY;\n\tskinMatrix += skinWeight.z * boneMatZ;\n\tskinMatrix += skinWeight.w * boneMatW;\n\tskinMatrix = bindMatrixInverse * skinMatrix * bindMatrix;\n\tobjectNormal = vec4( skinMatrix * vec4( objectNormal, 0.0 ) ).xyz;\n\t#ifdef USE_TANGENT\n\t\tobjectTangent = vec4( skinMatrix * vec4( objectTangent, 0.0 ) ).xyz;\n\t#endif\n#endif",specularmap_fragment:"float specularStrength;\n#ifdef USE_SPECULARMAP\n\tvec4 texelSpecular = texture2D( specularMap, vSpecularMapUv );\n\tspecularStrength = texelSpecular.r;\n#else\n\tspecularStrength = 1.0;\n#endif",specularmap_pars_fragment:"#ifdef USE_SPECULARMAP\n\tuniform sampler2D specularMap;\n#endif",tonemapping_fragment:"#if defined( TONE_MAPPING )\n\tgl_FragColor.rgb = toneMapping( gl_FragColor.rgb );\n#endif",tonemapping_pars_fragment:"#ifndef saturate\n#define saturate( a ) clamp( a, 0.0, 1.0 )\n#endif\nuniform float toneMappingExposure;\nvec3 LinearToneMapping( vec3 color ) {\n\treturn saturate( toneMappingExposure * color );\n}\nvec3 ReinhardToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\treturn saturate( color / ( vec3( 1.0 ) + color ) );\n}\nvec3 CineonToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\tcolor = max( vec3( 0.0 ), color - 0.004 );\n\treturn pow( ( color * ( 6.2 * color + 0.5 ) ) / ( color * ( 6.2 * color + 1.7 ) + 0.06 ), vec3( 2.2 ) );\n}\nvec3 RRTAndODTFit( vec3 v ) {\n\tvec3 a = v * ( v + 0.0245786 ) - 0.000090537;\n\tvec3 b = v * ( 0.983729 * v + 0.4329510 ) + 0.238081;\n\treturn a / b;\n}\nvec3 ACESFilmicToneMapping( vec3 color ) {\n\tconst mat3 ACESInputMat = mat3(\n\t\tvec3( 0.59719, 0.07600, 0.02840 ),\t\tvec3( 0.35458, 0.90834, 0.13383 ),\n\t\tvec3( 0.04823, 0.01566, 0.83777 )\n\t);\n\tconst mat3 ACESOutputMat = mat3(\n\t\tvec3(  1.60475, -0.10208, -0.00327 ),\t\tvec3( -0.53108,  1.10813, -0.07276 ),\n\t\tvec3( -0.07367, -0.00605,  1.07602 )\n\t);\n\tcolor *= toneMappingExposure / 0.6;\n\tcolor = ACESInputMat * color;\n\tcolor = RRTAndODTFit( color );\n\tcolor = ACESOutputMat * color;\n\treturn saturate( color );\n}\nconst mat3 LINEAR_REC2020_TO_LINEAR_SRGB = mat3(\n\tvec3( 1.6605, - 0.1246, - 0.0182 ),\n\tvec3( - 0.5876, 1.1329, - 0.1006 ),\n\tvec3( - 0.0728, - 0.0083, 1.1187 )\n);\nconst mat3 LINEAR_SRGB_TO_LINEAR_REC2020 = mat3(\n\tvec3( 0.6274, 0.0691, 0.0164 ),\n\tvec3( 0.3293, 0.9195, 0.0880 ),\n\tvec3( 0.0433, 0.0113, 0.8956 )\n);\nvec3 agxDefaultContrastApprox( vec3 x ) {\n\tvec3 x2 = x * x;\n\tvec3 x4 = x2 * x2;\n\treturn + 15.5 * x4 * x2\n\t\t- 40.14 * x4 * x\n\t\t+ 31.96 * x4\n\t\t- 6.868 * x2 * x\n\t\t+ 0.4298 * x2\n\t\t+ 0.1191 * x\n\t\t- 0.00232;\n}\nvec3 AgXToneMapping( vec3 color ) {\n\tconst mat3 AgXInsetMatrix = mat3(\n\t\tvec3( 0.856627153315983, 0.137318972929847, 0.11189821299995 ),\n\t\tvec3( 0.0951212405381588, 0.761241990602591, 0.0767994186031903 ),\n\t\tvec3( 0.0482516061458583, 0.101439036467562, 0.811302368396859 )\n\t);\n\tconst mat3 AgXOutsetMatrix = mat3(\n\t\tvec3( 1.1271005818144368, - 0.1413297634984383, - 0.14132976349843826 ),\n\t\tvec3( - 0.11060664309660323, 1.157823702216272, - 0.11060664309660294 ),\n\t\tvec3( - 0.016493938717834573, - 0.016493938717834257, 1.2519364065950405 )\n\t);\n\tconst float AgxMinEv = - 12.47393;\tconst float AgxMaxEv = 4.026069;\n\tcolor *= toneMappingExposure;\n\tcolor = LINEAR_SRGB_TO_LINEAR_REC2020 * color;\n\tcolor = AgXInsetMatrix * color;\n\tcolor = max( color, 1e-10 );\tcolor = log2( color );\n\tcolor = ( color - AgxMinEv ) / ( AgxMaxEv - AgxMinEv );\n\tcolor = clamp( color, 0.0, 1.0 );\n\tcolor = agxDefaultContrastApprox( color );\n\tcolor = AgXOutsetMatrix * color;\n\tcolor = pow( max( vec3( 0.0 ), color ), vec3( 2.2 ) );\n\tcolor = LINEAR_REC2020_TO_LINEAR_SRGB * color;\n\tcolor = clamp( color, 0.0, 1.0 );\n\treturn color;\n}\nvec3 NeutralToneMapping( vec3 color ) {\n\tconst float StartCompression = 0.8 - 0.04;\n\tconst float Desaturation = 0.15;\n\tcolor *= toneMappingExposure;\n\tfloat x = min( color.r, min( color.g, color.b ) );\n\tfloat offset = x < 0.08 ? x - 6.25 * x * x : 0.04;\n\tcolor -= offset;\n\tfloat peak = max( color.r, max( color.g, color.b ) );\n\tif ( peak < StartCompression ) return color;\n\tfloat d = 1. - StartCompression;\n\tfloat newPeak = 1. - d * d / ( peak + d - StartCompression );\n\tcolor *= newPeak / peak;\n\tfloat g = 1. - 1. / ( Desaturation * ( peak - newPeak ) + 1. );\n\treturn mix( color, vec3( newPeak ), g );\n}\nvec3 CustomToneMapping( vec3 color ) { return color; }",transmission_fragment:"#ifdef USE_TRANSMISSION\n\tmaterial.transmission = transmission;\n\tmaterial.transmissionAlpha = 1.0;\n\tmaterial.thickness = thickness;\n\tmaterial.attenuationDistance = attenuationDistance;\n\tmaterial.attenuationColor = attenuationColor;\n\t#ifdef USE_TRANSMISSIONMAP\n\t\tmaterial.transmission *= texture2D( transmissionMap, vTransmissionMapUv ).r;\n\t#endif\n\t#ifdef USE_THICKNESSMAP\n\t\tmaterial.thickness *= texture2D( thicknessMap, vThicknessMapUv ).g;\n\t#endif\n\tvec3 pos = vWorldPosition;\n\tvec3 v = normalize( cameraPosition - pos );\n\tvec3 n = inverseTransformDirection( normal, viewMatrix );\n\tvec4 transmitted = getIBLVolumeRefraction(\n\t\tn, v, material.roughness, material.diffuseColor, material.specularColor, material.specularF90,\n\t\tpos, modelMatrix, viewMatrix, projectionMatrix, material.dispersion, material.ior, material.thickness,\n\t\tmaterial.attenuationColor, material.attenuationDistance );\n\tmaterial.transmissionAlpha = mix( material.transmissionAlpha, transmitted.a, material.transmission );\n\ttotalDiffuse = mix( totalDiffuse, transmitted.rgb, material.transmission );\n#endif",transmission_pars_fragment:"#ifdef USE_TRANSMISSION\n\tuniform float transmission;\n\tuniform float thickness;\n\tuniform float attenuationDistance;\n\tuniform vec3 attenuationColor;\n\t#ifdef USE_TRANSMISSIONMAP\n\t\tuniform sampler2D transmissionMap;\n\t#endif\n\t#ifdef USE_THICKNESSMAP\n\t\tuniform sampler2D thicknessMap;\n\t#endif\n\tuniform vec2 transmissionSamplerSize;\n\tuniform sampler2D transmissionSamplerMap;\n\tuniform mat4 modelMatrix;\n\tuniform mat4 projectionMatrix;\n\tvarying vec3 vWorldPosition;\n\tfloat w0( float a ) {\n\t\treturn ( 1.0 / 6.0 ) * ( a * ( a * ( - a + 3.0 ) - 3.0 ) + 1.0 );\n\t}\n\tfloat w1( float a ) {\n\t\treturn ( 1.0 / 6.0 ) * ( a *  a * ( 3.0 * a - 6.0 ) + 4.0 );\n\t}\n\tfloat w2( float a ){\n\t\treturn ( 1.0 / 6.0 ) * ( a * ( a * ( - 3.0 * a + 3.0 ) + 3.0 ) + 1.0 );\n\t}\n\tfloat w3( float a ) {\n\t\treturn ( 1.0 / 6.0 ) * ( a * a * a );\n\t}\n\tfloat g0( float a ) {\n\t\treturn w0( a ) + w1( a );\n\t}\n\tfloat g1( float a ) {\n\t\treturn w2( a ) + w3( a );\n\t}\n\tfloat h0( float a ) {\n\t\treturn - 1.0 + w1( a ) / ( w0( a ) + w1( a ) );\n\t}\n\tfloat h1( float a ) {\n\t\treturn 1.0 + w3( a ) / ( w2( a ) + w3( a ) );\n\t}\n\tvec4 bicubic( sampler2D tex, vec2 uv, vec4 texelSize, float lod ) {\n\t\tuv = uv * texelSize.zw + 0.5;\n\t\tvec2 iuv = floor( uv );\n\t\tvec2 fuv = fract( uv );\n\t\tfloat g0x = g0( fuv.x );\n\t\tfloat g1x = g1( fuv.x );\n\t\tfloat h0x = h0( fuv.x );\n\t\tfloat h1x = h1( fuv.x );\n\t\tfloat h0y = h0( fuv.y );\n\t\tfloat h1y = h1( fuv.y );\n\t\tvec2 p0 = ( vec2( iuv.x + h0x, iuv.y + h0y ) - 0.5 ) * texelSize.xy;\n\t\tvec2 p1 = ( vec2( iuv.x + h1x, iuv.y + h0y ) - 0.5 ) * texelSize.xy;\n\t\tvec2 p2 = ( vec2( iuv.x + h0x, iuv.y + h1y ) - 0.5 ) * texelSize.xy;\n\t\tvec2 p3 = ( vec2( iuv.x + h1x, iuv.y + h1y ) - 0.5 ) * texelSize.xy;\n\t\treturn g0( fuv.y ) * ( g0x * textureLod( tex, p0, lod ) + g1x * textureLod( tex, p1, lod ) ) +\n\t\t\tg1( fuv.y ) * ( g0x * textureLod( tex, p2, lod ) + g1x * textureLod( tex, p3, lod ) );\n\t}\n\tvec4 textureBicubic( sampler2D sampler, vec2 uv, float lod ) {\n\t\tvec2 fLodSize = vec2( textureSize( sampler, int( lod ) ) );\n\t\tvec2 cLodSize = vec2( textureSize( sampler, int( lod + 1.0 ) ) );\n\t\tvec2 fLodSizeInv = 1.0 / fLodSize;\n\t\tvec2 cLodSizeInv = 1.0 / cLodSize;\n\t\tvec4 fSample = bicubic( sampler, uv, vec4( fLodSizeInv, fLodSize ), floor( lod ) );\n\t\tvec4 cSample = bicubic( sampler, uv, vec4( cLodSizeInv, cLodSize ), ceil( lod ) );\n\t\treturn mix( fSample, cSample, fract( lod ) );\n\t}\n\tvec3 getVolumeTransmissionRay( const in vec3 n, const in vec3 v, const in float thickness, const in float ior, const in mat4 modelMatrix ) {\n\t\tvec3 refractionVector = refract( - v, normalize( n ), 1.0 / ior );\n\t\tvec3 modelScale;\n\t\tmodelScale.x = length( vec3( modelMatrix[ 0 ].xyz ) );\n\t\tmodelScale.y = length( vec3( modelMatrix[ 1 ].xyz ) );\n\t\tmodelScale.z = length( vec3( modelMatrix[ 2 ].xyz ) );\n\t\treturn normalize( refractionVector ) * thickness * modelScale;\n\t}\n\tfloat applyIorToRoughness( const in float roughness, const in float ior ) {\n\t\treturn roughness * clamp( ior * 2.0 - 2.0, 0.0, 1.0 );\n\t}\n\tvec4 getTransmissionSample( const in vec2 fragCoord, const in float roughness, const in float ior ) {\n\t\tfloat lod = log2( transmissionSamplerSize.x ) * applyIorToRoughness( roughness, ior );\n\t\treturn textureBicubic( transmissionSamplerMap, fragCoord.xy, lod );\n\t}\n\tvec3 volumeAttenuation( const in float transmissionDistance, const in vec3 attenuationColor, const in float attenuationDistance ) {\n\t\tif ( isinf( attenuationDistance ) ) {\n\t\t\treturn vec3( 1.0 );\n\t\t} else {\n\t\t\tvec3 attenuationCoefficient = -log( attenuationColor ) / attenuationDistance;\n\t\t\tvec3 transmittance = exp( - attenuationCoefficient * transmissionDistance );\t\t\treturn transmittance;\n\t\t}\n\t}\n\tvec4 getIBLVolumeRefraction( const in vec3 n, const in vec3 v, const in float roughness, const in vec3 diffuseColor,\n\t\tconst in vec3 specularColor, const in float specularF90, const in vec3 position, const in mat4 modelMatrix,\n\t\tconst in mat4 viewMatrix, const in mat4 projMatrix, const in float dispersion, const in float ior, const in float thickness,\n\t\tconst in vec3 attenuationColor, const in float attenuationDistance ) {\n\t\tvec4 transmittedLight;\n\t\tvec3 transmittance;\n\t\t#ifdef USE_DISPERSION\n\t\t\tfloat halfSpread = ( ior - 1.0 ) * 0.025 * dispersion;\n\t\t\tvec3 iors = vec3( ior - halfSpread, ior, ior + halfSpread );\n\t\t\tfor ( int i = 0; i < 3; i ++ ) {\n\t\t\t\tvec3 transmissionRay = getVolumeTransmissionRay( n, v, thickness, iors[ i ], modelMatrix );\n\t\t\t\tvec3 refractedRayExit = position + transmissionRay;\n\t\t\n\t\t\t\tvec4 ndcPos = projMatrix * viewMatrix * vec4( refractedRayExit, 1.0 );\n\t\t\t\tvec2 refractionCoords = ndcPos.xy / ndcPos.w;\n\t\t\t\trefractionCoords += 1.0;\n\t\t\t\trefractionCoords /= 2.0;\n\t\t\n\t\t\t\tvec4 transmissionSample = getTransmissionSample( refractionCoords, roughness, iors[ i ] );\n\t\t\t\ttransmittedLight[ i ] = transmissionSample[ i ];\n\t\t\t\ttransmittedLight.a += transmissionSample.a;\n\t\t\t\ttransmittance[ i ] = diffuseColor[ i ] * volumeAttenuation( length( transmissionRay ), attenuationColor, attenuationDistance )[ i ];\n\t\t\t}\n\t\t\ttransmittedLight.a /= 3.0;\n\t\t\n\t\t#else\n\t\t\n\t\t\tvec3 transmissionRay = getVolumeTransmissionRay( n, v, thickness, ior, modelMatrix );\n\t\t\tvec3 refractedRayExit = position + transmissionRay;\n\t\t\tvec4 ndcPos = projMatrix * viewMatrix * vec4( refractedRayExit, 1.0 );\n\t\t\tvec2 refractionCoords = ndcPos.xy / ndcPos.w;\n\t\t\trefractionCoords += 1.0;\n\t\t\trefractionCoords /= 2.0;\n\t\t\ttransmittedLight = getTransmissionSample( refractionCoords, roughness, ior );\n\t\t\ttransmittance = diffuseColor * volumeAttenuation( length( transmissionRay ), attenuationColor, attenuationDistance );\n\t\t\n\t\t#endif\n\t\tvec3 attenuatedColor = transmittance * transmittedLight.rgb;\n\t\tvec3 F = EnvironmentBRDF( n, v, specularColor, specularF90, roughness );\n\t\tfloat transmittanceFactor = ( transmittance.r + transmittance.g + transmittance.b ) / 3.0;\n\t\treturn vec4( ( 1.0 - F ) * attenuatedColor, 1.0 - ( 1.0 - transmittedLight.a ) * transmittanceFactor );\n\t}\n#endif",uv_pars_fragment:"#if defined( USE_UV ) || defined( USE_ANISOTROPY )\n\tvarying vec2 vUv;\n#endif\n#ifdef USE_MAP\n\tvarying vec2 vMapUv;\n#endif\n#ifdef USE_ALPHAMAP\n\tvarying vec2 vAlphaMapUv;\n#endif\n#ifdef USE_LIGHTMAP\n\tvarying vec2 vLightMapUv;\n#endif\n#ifdef USE_AOMAP\n\tvarying vec2 vAoMapUv;\n#endif\n#ifdef USE_BUMPMAP\n\tvarying vec2 vBumpMapUv;\n#endif\n#ifdef USE_NORMALMAP\n\tvarying vec2 vNormalMapUv;\n#endif\n#ifdef USE_EMISSIVEMAP\n\tvarying vec2 vEmissiveMapUv;\n#endif\n#ifdef USE_METALNESSMAP\n\tvarying vec2 vMetalnessMapUv;\n#endif\n#ifdef USE_ROUGHNESSMAP\n\tvarying vec2 vRoughnessMapUv;\n#endif\n#ifdef USE_ANISOTROPYMAP\n\tvarying vec2 vAnisotropyMapUv;\n#endif\n#ifdef USE_CLEARCOATMAP\n\tvarying vec2 vClearcoatMapUv;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tvarying vec2 vClearcoatNormalMapUv;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tvarying vec2 vClearcoatRoughnessMapUv;\n#endif\n#ifdef USE_IRIDESCENCEMAP\n\tvarying vec2 vIridescenceMapUv;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tvarying vec2 vIridescenceThicknessMapUv;\n#endif\n#ifdef USE_SHEEN_COLORMAP\n\tvarying vec2 vSheenColorMapUv;\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\n\tvarying vec2 vSheenRoughnessMapUv;\n#endif\n#ifdef USE_SPECULARMAP\n\tvarying vec2 vSpecularMapUv;\n#endif\n#ifdef USE_SPECULAR_COLORMAP\n\tvarying vec2 vSpecularColorMapUv;\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\n\tvarying vec2 vSpecularIntensityMapUv;\n#endif\n#ifdef USE_TRANSMISSIONMAP\n\tuniform mat3 transmissionMapTransform;\n\tvarying vec2 vTransmissionMapUv;\n#endif\n#ifdef USE_THICKNESSMAP\n\tuniform mat3 thicknessMapTransform;\n\tvarying vec2 vThicknessMapUv;\n#endif",uv_pars_vertex:"#if defined( USE_UV ) || defined( USE_ANISOTROPY )\n\tvarying vec2 vUv;\n#endif\n#ifdef USE_MAP\n\tuniform mat3 mapTransform;\n\tvarying vec2 vMapUv;\n#endif\n#ifdef USE_ALPHAMAP\n\tuniform mat3 alphaMapTransform;\n\tvarying vec2 vAlphaMapUv;\n#endif\n#ifdef USE_LIGHTMAP\n\tuniform mat3 lightMapTransform;\n\tvarying vec2 vLightMapUv;\n#endif\n#ifdef USE_AOMAP\n\tuniform mat3 aoMapTransform;\n\tvarying vec2 vAoMapUv;\n#endif\n#ifdef USE_BUMPMAP\n\tuniform mat3 bumpMapTransform;\n\tvarying vec2 vBumpMapUv;\n#endif\n#ifdef USE_NORMALMAP\n\tuniform mat3 normalMapTransform;\n\tvarying vec2 vNormalMapUv;\n#endif\n#ifdef USE_DISPLACEMENTMAP\n\tuniform mat3 displacementMapTransform;\n\tvarying vec2 vDisplacementMapUv;\n#endif\n#ifdef USE_EMISSIVEMAP\n\tuniform mat3 emissiveMapTransform;\n\tvarying vec2 vEmissiveMapUv;\n#endif\n#ifdef USE_METALNESSMAP\n\tuniform mat3 metalnessMapTransform;\n\tvarying vec2 vMetalnessMapUv;\n#endif\n#ifdef USE_ROUGHNESSMAP\n\tuniform mat3 roughnessMapTransform;\n\tvarying vec2 vRoughnessMapUv;\n#endif\n#ifdef USE_ANISOTROPYMAP\n\tuniform mat3 anisotropyMapTransform;\n\tvarying vec2 vAnisotropyMapUv;\n#endif\n#ifdef USE_CLEARCOATMAP\n\tuniform mat3 clearcoatMapTransform;\n\tvarying vec2 vClearcoatMapUv;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tuniform mat3 clearcoatNormalMapTransform;\n\tvarying vec2 vClearcoatNormalMapUv;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tuniform mat3 clearcoatRoughnessMapTransform;\n\tvarying vec2 vClearcoatRoughnessMapUv;\n#endif\n#ifdef USE_SHEEN_COLORMAP\n\tuniform mat3 sheenColorMapTransform;\n\tvarying vec2 vSheenColorMapUv;\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\n\tuniform mat3 sheenRoughnessMapTransform;\n\tvarying vec2 vSheenRoughnessMapUv;\n#endif\n#ifdef USE_IRIDESCENCEMAP\n\tuniform mat3 iridescenceMapTransform;\n\tvarying vec2 vIridescenceMapUv;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tuniform mat3 iridescenceThicknessMapTransform;\n\tvarying vec2 vIridescenceThicknessMapUv;\n#endif\n#ifdef USE_SPECULARMAP\n\tuniform mat3 specularMapTransform;\n\tvarying vec2 vSpecularMapUv;\n#endif\n#ifdef USE_SPECULAR_COLORMAP\n\tuniform mat3 specularColorMapTransform;\n\tvarying vec2 vSpecularColorMapUv;\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\n\tuniform mat3 specularIntensityMapTransform;\n\tvarying vec2 vSpecularIntensityMapUv;\n#endif\n#ifdef USE_TRANSMISSIONMAP\n\tuniform mat3 transmissionMapTransform;\n\tvarying vec2 vTransmissionMapUv;\n#endif\n#ifdef USE_THICKNESSMAP\n\tuniform mat3 thicknessMapTransform;\n\tvarying vec2 vThicknessMapUv;\n#endif",uv_vertex:"#if defined( USE_UV ) || defined( USE_ANISOTROPY )\n\tvUv = vec3( uv, 1 ).xy;\n#endif\n#ifdef USE_MAP\n\tvMapUv = ( mapTransform * vec3( MAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_ALPHAMAP\n\tvAlphaMapUv = ( alphaMapTransform * vec3( ALPHAMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_LIGHTMAP\n\tvLightMapUv = ( lightMapTransform * vec3( LIGHTMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_AOMAP\n\tvAoMapUv = ( aoMapTransform * vec3( AOMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_BUMPMAP\n\tvBumpMapUv = ( bumpMapTransform * vec3( BUMPMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_NORMALMAP\n\tvNormalMapUv = ( normalMapTransform * vec3( NORMALMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_DISPLACEMENTMAP\n\tvDisplacementMapUv = ( displacementMapTransform * vec3( DISPLACEMENTMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_EMISSIVEMAP\n\tvEmissiveMapUv = ( emissiveMapTransform * vec3( EMISSIVEMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_METALNESSMAP\n\tvMetalnessMapUv = ( metalnessMapTransform * vec3( METALNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_ROUGHNESSMAP\n\tvRoughnessMapUv = ( roughnessMapTransform * vec3( ROUGHNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_ANISOTROPYMAP\n\tvAnisotropyMapUv = ( anisotropyMapTransform * vec3( ANISOTROPYMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_CLEARCOATMAP\n\tvClearcoatMapUv = ( clearcoatMapTransform * vec3( CLEARCOATMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\tvClearcoatNormalMapUv = ( clearcoatNormalMapTransform * vec3( CLEARCOAT_NORMALMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\tvClearcoatRoughnessMapUv = ( clearcoatRoughnessMapTransform * vec3( CLEARCOAT_ROUGHNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_IRIDESCENCEMAP\n\tvIridescenceMapUv = ( iridescenceMapTransform * vec3( IRIDESCENCEMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\tvIridescenceThicknessMapUv = ( iridescenceThicknessMapTransform * vec3( IRIDESCENCE_THICKNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SHEEN_COLORMAP\n\tvSheenColorMapUv = ( sheenColorMapTransform * vec3( SHEEN_COLORMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\n\tvSheenRoughnessMapUv = ( sheenRoughnessMapTransform * vec3( SHEEN_ROUGHNESSMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SPECULARMAP\n\tvSpecularMapUv = ( specularMapTransform * vec3( SPECULARMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SPECULAR_COLORMAP\n\tvSpecularColorMapUv = ( specularColorMapTransform * vec3( SPECULAR_COLORMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\n\tvSpecularIntensityMapUv = ( specularIntensityMapTransform * vec3( SPECULAR_INTENSITYMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_TRANSMISSIONMAP\n\tvTransmissionMapUv = ( transmissionMapTransform * vec3( TRANSMISSIONMAP_UV, 1 ) ).xy;\n#endif\n#ifdef USE_THICKNESSMAP\n\tvThicknessMapUv = ( thicknessMapTransform * vec3( THICKNESSMAP_UV, 1 ) ).xy;\n#endif",worldpos_vertex:"#if defined( USE_ENVMAP ) || defined( DISTANCE ) || defined ( USE_SHADOWMAP ) || defined ( USE_TRANSMISSION ) || NUM_SPOT_LIGHT_COORDS > 0\n\tvec4 worldPosition = vec4( transformed, 1.0 );\n\t#ifdef USE_BATCHING\n\t\tworldPosition = batchingMatrix * worldPosition;\n\t#endif\n\t#ifdef USE_INSTANCING\n\t\tworldPosition = instanceMatrix * worldPosition;\n\t#endif\n\tworldPosition = modelMatrix * worldPosition;\n#endif",background_vert:"varying vec2 vUv;\nuniform mat3 uvTransform;\nvoid main() {\n\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n\tgl_Position = vec4( position.xy, 1.0, 1.0 );\n}",background_frag:"uniform sampler2D t2D;\nuniform float backgroundIntensity;\nvarying vec2 vUv;\nvoid main() {\n\tvec4 texColor = texture2D( t2D, vUv );\n\t#ifdef DECODE_VIDEO_TEXTURE\n\t\ttexColor = vec4( mix( pow( texColor.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), texColor.rgb * 0.0773993808, vec3( lessThanEqual( texColor.rgb, vec3( 0.04045 ) ) ) ), texColor.w );\n\t#endif\n\ttexColor.rgb *= backgroundIntensity;\n\tgl_FragColor = texColor;\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",backgroundCube_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\tgl_Position.z = gl_Position.w;\n}",backgroundCube_frag:"#ifdef ENVMAP_TYPE_CUBE\n\tuniform samplerCube envMap;\n#elif defined( ENVMAP_TYPE_CUBE_UV )\n\tuniform sampler2D envMap;\n#endif\nuniform float flipEnvMap;\nuniform float backgroundBlurriness;\nuniform float backgroundIntensity;\nuniform mat3 backgroundRotation;\nvarying vec3 vWorldDirection;\n#include <cube_uv_reflection_fragment>\nvoid main() {\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tvec4 texColor = textureCube( envMap, backgroundRotation * vec3( flipEnvMap * vWorldDirection.x, vWorldDirection.yz ) );\n\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\t\tvec4 texColor = textureCubeUV( envMap, backgroundRotation * vWorldDirection, backgroundBlurriness );\n\t#else\n\t\tvec4 texColor = vec4( 0.0, 0.0, 0.0, 1.0 );\n\t#endif\n\ttexColor.rgb *= backgroundIntensity;\n\tgl_FragColor = texColor;\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",cube_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\tgl_Position.z = gl_Position.w;\n}",cube_frag:"uniform samplerCube tCube;\nuniform float tFlip;\nuniform float opacity;\nvarying vec3 vWorldDirection;\nvoid main() {\n\tvec4 texColor = textureCube( tCube, vec3( tFlip * vWorldDirection.x, vWorldDirection.yz ) );\n\tgl_FragColor = texColor;\n\tgl_FragColor.a *= opacity;\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",depth_vert:"#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvarying vec2 vHighPrecisionZW;\nvoid main() {\n\t#include <uv_vertex>\n\t#include <batching_vertex>\n\t#include <skinbase_vertex>\n\t#include <morphinstance_vertex>\n\t#ifdef USE_DISPLACEMENTMAP\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvHighPrecisionZW = gl_Position.zw;\n}",depth_frag:"#if DEPTH_PACKING == 3200\n\tuniform float opacity;\n#endif\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvarying vec2 vHighPrecisionZW;\nvoid main() {\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#include <clipping_planes_fragment>\n\t#if DEPTH_PACKING == 3200\n\t\tdiffuseColor.a = opacity;\n\t#endif\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <logdepthbuf_fragment>\n\tfloat fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;\n\t#if DEPTH_PACKING == 3200\n\t\tgl_FragColor = vec4( vec3( 1.0 - fragCoordZ ), opacity );\n\t#elif DEPTH_PACKING == 3201\n\t\tgl_FragColor = packDepthToRGBA( fragCoordZ );\n\t#elif DEPTH_PACKING == 3202\n\t\tgl_FragColor = vec4( packDepthToRGB( fragCoordZ ), 1.0 );\n\t#elif DEPTH_PACKING == 3203\n\t\tgl_FragColor = vec4( packDepthToRG( fragCoordZ ), 0.0, 1.0 );\n\t#endif\n}",distanceRGBA_vert:"#define DISTANCE\nvarying vec3 vWorldPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <batching_vertex>\n\t#include <skinbase_vertex>\n\t#include <morphinstance_vertex>\n\t#ifdef USE_DISPLACEMENTMAP\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <worldpos_vertex>\n\t#include <clipping_planes_vertex>\n\tvWorldPosition = worldPosition.xyz;\n}",distanceRGBA_frag:"#define DISTANCE\nuniform vec3 referencePosition;\nuniform float nearDistance;\nuniform float farDistance;\nvarying vec3 vWorldPosition;\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main () {\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#include <clipping_planes_fragment>\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\tfloat dist = length( vWorldPosition - referencePosition );\n\tdist = ( dist - nearDistance ) / ( farDistance - nearDistance );\n\tdist = saturate( dist );\n\tgl_FragColor = packDepthToRGBA( dist );\n}",equirect_vert:"varying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvWorldDirection = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n}",equirect_frag:"uniform sampler2D tEquirect;\nvarying vec3 vWorldDirection;\n#include <common>\nvoid main() {\n\tvec3 direction = normalize( vWorldDirection );\n\tvec2 sampleUV = equirectUv( direction );\n\tgl_FragColor = texture2D( tEquirect, sampleUV );\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n}",linedashed_vert:"uniform float scale;\nattribute float lineDistance;\nvarying float vLineDistance;\n#include <common>\n#include <uv_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\tvLineDistance = scale * lineDistance;\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}",linedashed_frag:"uniform vec3 diffuse;\nuniform float opacity;\nuniform float dashSize;\nuniform float totalSize;\nvarying float vLineDistance;\n#include <common>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tif ( mod( vLineDistance, totalSize ) > dashSize ) {\n\t\tdiscard;\n\t}\n\tvec3 outgoingLight = vec3( 0.0 );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n}",meshbasic_vert:"#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#if defined ( USE_ENVMAP ) || defined ( USE_SKINNING )\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinbase_vertex>\n\t\t#include <skinnormal_vertex>\n\t\t#include <defaultnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <fog_vertex>\n}",meshbasic_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <specularmap_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\t#ifdef USE_LIGHTMAP\n\t\tvec4 lightMapTexel = texture2D( lightMap, vLightMapUv );\n\t\treflectedLight.indirectDiffuse += lightMapTexel.rgb * lightMapIntensity * RECIPROCAL_PI;\n\t#else\n\t\treflectedLight.indirectDiffuse += vec3( 1.0 );\n\t#endif\n\t#include <aomap_fragment>\n\treflectedLight.indirectDiffuse *= diffuseColor.rgb;\n\tvec3 outgoingLight = reflectedLight.indirectDiffuse;\n\t#include <envmap_fragment>\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshlambert_vert:"#define LAMBERT\nvarying vec3 vViewPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshlambert_frag:"#define LAMBERT\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_lambert_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <specularmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_lambert_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshmatcap_vert:"#define MATCAP\nvarying vec3 vViewPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <color_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n\tvViewPosition = - mvPosition.xyz;\n}",meshmatcap_frag:"#define MATCAP\nuniform vec3 diffuse;\nuniform float opacity;\nuniform sampler2D matcap;\nvarying vec3 vViewPosition;\n#include <common>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <fog_pars_fragment>\n#include <normal_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\tvec3 viewDir = normalize( vViewPosition );\n\tvec3 x = normalize( vec3( viewDir.z, 0.0, - viewDir.x ) );\n\tvec3 y = cross( viewDir, x );\n\tvec2 uv = vec2( dot( x, normal ), dot( y, normal ) ) * 0.495 + 0.5;\n\t#ifdef USE_MATCAP\n\t\tvec4 matcapColor = texture2D( matcap, uv );\n\t#else\n\t\tvec4 matcapColor = vec4( vec3( mix( 0.2, 0.8, uv.y ) ), 1.0 );\n\t#endif\n\tvec3 outgoingLight = diffuseColor.rgb * matcapColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshnormal_vert:"#define NORMAL\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )\n\tvarying vec3 vViewPosition;\n#endif\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )\n\tvViewPosition = - mvPosition.xyz;\n#endif\n}",meshnormal_frag:"#define NORMAL\nuniform float opacity;\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP_TANGENTSPACE )\n\tvarying vec3 vViewPosition;\n#endif\n#include <packing>\n#include <uv_pars_fragment>\n#include <normal_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( 0.0, 0.0, 0.0, opacity );\n\t#include <clipping_planes_fragment>\n\t#include <logdepthbuf_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\tgl_FragColor = vec4( packNormalToRGB( normal ), diffuseColor.a );\n\t#ifdef OPAQUE\n\t\tgl_FragColor.a = 1.0;\n\t#endif\n}",meshphong_vert:"#define PHONG\nvarying vec3 vViewPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshphong_frag:"#define PHONG\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 specular;\nuniform float shininess;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_phong_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <specularmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_phong_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshphysical_vert:"#define STANDARD\nvarying vec3 vViewPosition;\n#ifdef USE_TRANSMISSION\n\tvarying vec3 vWorldPosition;\n#endif\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n#ifdef USE_TRANSMISSION\n\tvWorldPosition = worldPosition.xyz;\n#endif\n}",meshphysical_frag:"#define STANDARD\n#ifdef PHYSICAL\n\t#define IOR\n\t#define USE_SPECULAR\n#endif\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\n#ifdef IOR\n\tuniform float ior;\n#endif\n#ifdef USE_SPECULAR\n\tuniform float specularIntensity;\n\tuniform vec3 specularColor;\n\t#ifdef USE_SPECULAR_COLORMAP\n\t\tuniform sampler2D specularColorMap;\n\t#endif\n\t#ifdef USE_SPECULAR_INTENSITYMAP\n\t\tuniform sampler2D specularIntensityMap;\n\t#endif\n#endif\n#ifdef USE_CLEARCOAT\n\tuniform float clearcoat;\n\tuniform float clearcoatRoughness;\n#endif\n#ifdef USE_DISPERSION\n\tuniform float dispersion;\n#endif\n#ifdef USE_IRIDESCENCE\n\tuniform float iridescence;\n\tuniform float iridescenceIOR;\n\tuniform float iridescenceThicknessMinimum;\n\tuniform float iridescenceThicknessMaximum;\n#endif\n#ifdef USE_SHEEN\n\tuniform vec3 sheenColor;\n\tuniform float sheenRoughness;\n\t#ifdef USE_SHEEN_COLORMAP\n\t\tuniform sampler2D sheenColorMap;\n\t#endif\n\t#ifdef USE_SHEEN_ROUGHNESSMAP\n\t\tuniform sampler2D sheenRoughnessMap;\n\t#endif\n#endif\n#ifdef USE_ANISOTROPY\n\tuniform vec2 anisotropyVector;\n\t#ifdef USE_ANISOTROPYMAP\n\t\tuniform sampler2D anisotropyMap;\n\t#endif\n#endif\nvarying vec3 vViewPosition;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <iridescence_fragment>\n#include <cube_uv_reflection_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_physical_pars_fragment>\n#include <fog_pars_fragment>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_physical_pars_fragment>\n#include <transmission_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <clearcoat_pars_fragment>\n#include <iridescence_pars_fragment>\n#include <roughnessmap_pars_fragment>\n#include <metalnessmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <roughnessmap_fragment>\n\t#include <metalnessmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <clearcoat_normal_fragment_begin>\n\t#include <clearcoat_normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_physical_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 totalDiffuse = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse;\n\tvec3 totalSpecular = reflectedLight.directSpecular + reflectedLight.indirectSpecular;\n\t#include <transmission_fragment>\n\tvec3 outgoingLight = totalDiffuse + totalSpecular + totalEmissiveRadiance;\n\t#ifdef USE_SHEEN\n\t\tfloat sheenEnergyComp = 1.0 - 0.157 * max3( material.sheenColor );\n\t\toutgoingLight = outgoingLight * sheenEnergyComp + sheenSpecularDirect + sheenSpecularIndirect;\n\t#endif\n\t#ifdef USE_CLEARCOAT\n\t\tfloat dotNVcc = saturate( dot( geometryClearcoatNormal, geometryViewDir ) );\n\t\tvec3 Fcc = F_Schlick( material.clearcoatF0, material.clearcoatF90, dotNVcc );\n\t\toutgoingLight = outgoingLight * ( 1.0 - material.clearcoat * Fcc ) + ( clearcoatSpecularDirect + clearcoatSpecularIndirect ) * material.clearcoat;\n\t#endif\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",meshtoon_vert:"#define TOON\nvarying vec3 vViewPosition;\n#include <common>\n#include <batching_pars_vertex>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",meshtoon_frag:"#define TOON\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <gradientmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_toon_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_toon_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}",points_vert:"uniform float size;\nuniform float scale;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n#ifdef USE_POINTS_UV\n\tvarying vec2 vUv;\n\tuniform mat3 uvTransform;\n#endif\nvoid main() {\n\t#ifdef USE_POINTS_UV\n\t\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n\t#endif\n\t#include <color_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphcolor_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <project_vertex>\n\tgl_PointSize = size;\n\t#ifdef USE_SIZEATTENUATION\n\t\tbool isPerspective = isPerspectiveMatrix( projectionMatrix );\n\t\tif ( isPerspective ) gl_PointSize *= ( scale / - mvPosition.z );\n\t#endif\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <fog_vertex>\n}",points_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <color_pars_fragment>\n#include <map_particle_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\t#include <logdepthbuf_fragment>\n\t#include <map_particle_fragment>\n\t#include <color_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n}",shadow_vert:"#include <common>\n#include <batching_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <shadowmap_pars_vertex>\nvoid main() {\n\t#include <batching_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphinstance_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}",shadow_frag:"uniform vec3 color;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <logdepthbuf_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\nvoid main() {\n\t#include <logdepthbuf_fragment>\n\tgl_FragColor = vec4( color, opacity * ( 1.0 - getShadowMask() ) );\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n}",sprite_vert:"uniform float rotation;\nuniform vec2 center;\n#include <common>\n#include <uv_pars_vertex>\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\tvec4 mvPosition = modelViewMatrix[ 3 ];\n\tvec2 scale = vec2( length( modelMatrix[ 0 ].xyz ), length( modelMatrix[ 1 ].xyz ) );\n\t#ifndef USE_SIZEATTENUATION\n\t\tbool isPerspective = isPerspectiveMatrix( projectionMatrix );\n\t\tif ( isPerspective ) scale *= - mvPosition.z;\n\t#endif\n\tvec2 alignedPosition = ( position.xy - ( center - vec2( 0.5 ) ) ) * scale;\n\tvec2 rotatedPosition;\n\trotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;\n\trotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;\n\tmvPosition.xy += rotatedPosition;\n\tgl_Position = projectionMatrix * mvPosition;\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}",sprite_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <alphahash_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\t#include <opaque_fragment>\n\t#include <tonemapping_fragment>\n\t#include <colorspace_fragment>\n\t#include <fog_fragment>\n}"},Br={common:{diffuse:{value:new Ci(16777215)},opacity:{value:1},map:{value:null},mapTransform:{value:new Rt},alphaMap:{value:null},alphaMapTransform:{value:new Rt},alphaTest:{value:0}},specularmap:{specularMap:{value:null},specularMapTransform:{value:new Rt}},envmap:{envMap:{value:null},envMapRotation:{value:new Rt},flipEnvMap:{value:-1},reflectivity:{value:1},ior:{value:1.5},refractionRatio:{value:.98}},aomap:{aoMap:{value:null},aoMapIntensity:{value:1},aoMapTransform:{value:new Rt}},lightmap:{lightMap:{value:null},lightMapIntensity:{value:1},lightMapTransform:{value:new Rt}},bumpmap:{bumpMap:{value:null},bumpMapTransform:{value:new Rt},bumpScale:{value:1}},normalmap:{normalMap:{value:null},normalMapTransform:{value:new Rt},normalScale:{value:new It(1,1)}},displacementmap:{displacementMap:{value:null},displacementMapTransform:{value:new Rt},displacementScale:{value:1},displacementBias:{value:0}},emissivemap:{emissiveMap:{value:null},emissiveMapTransform:{value:new Rt}},metalnessmap:{metalnessMap:{value:null},metalnessMapTransform:{value:new Rt}},roughnessmap:{roughnessMap:{value:null},roughnessMapTransform:{value:new Rt}},gradientmap:{gradientMap:{value:null}},fog:{fogDensity:{value:25e-5},fogNear:{value:1},fogFar:{value:2e3},fogColor:{value:new Ci(16777215)}},lights:{ambientLightColor:{value:[]},lightProbe:{value:[]},directionalLights:{value:[],properties:{direction:{},color:{}}},directionalLightShadows:{value:[],properties:{shadowIntensity:1,shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},directionalShadowMap:{value:[]},directionalShadowMatrix:{value:[]},spotLights:{value:[],properties:{color:{},position:{},direction:{},distance:{},coneCos:{},penumbraCos:{},decay:{}}},spotLightShadows:{value:[],properties:{shadowIntensity:1,shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{}}},spotLightMap:{value:[]},spotShadowMap:{value:[]},spotLightMatrix:{value:[]},pointLights:{value:[],properties:{color:{},position:{},decay:{},distance:{}}},pointLightShadows:{value:[],properties:{shadowIntensity:1,shadowBias:{},shadowNormalBias:{},shadowRadius:{},shadowMapSize:{},shadowCameraNear:{},shadowCameraFar:{}}},pointShadowMap:{value:[]},pointShadowMatrix:{value:[]},hemisphereLights:{value:[],properties:{direction:{},skyColor:{},groundColor:{}}},rectAreaLights:{value:[],properties:{color:{},position:{},width:{},height:{}}},ltc_1:{value:null},ltc_2:{value:null}},points:{diffuse:{value:new Ci(16777215)},opacity:{value:1},size:{value:1},scale:{value:1},map:{value:null},alphaMap:{value:null},alphaMapTransform:{value:new Rt},alphaTest:{value:0},uvTransform:{value:new Rt}},sprite:{diffuse:{value:new Ci(16777215)},opacity:{value:1},center:{value:new It(.5,.5)},rotation:{value:0},map:{value:null},mapTransform:{value:new Rt},alphaMap:{value:null},alphaMapTransform:{value:new Rt},alphaTest:{value:0}}},Lr={basic:{uniforms:or([Br.common,Br.specularmap,Br.envmap,Br.aomap,Br.lightmap,Br.fog]),vertexShader:Rr.meshbasic_vert,fragmentShader:Rr.meshbasic_frag},lambert:{uniforms:or([Br.common,Br.specularmap,Br.envmap,Br.aomap,Br.lightmap,Br.emissivemap,Br.bumpmap,Br.normalmap,Br.displacementmap,Br.fog,Br.lights,{emissive:{value:new Ci(0)}}]),vertexShader:Rr.meshlambert_vert,fragmentShader:Rr.meshlambert_frag},phong:{uniforms:or([Br.common,Br.specularmap,Br.envmap,Br.aomap,Br.lightmap,Br.emissivemap,Br.bumpmap,Br.normalmap,Br.displacementmap,Br.fog,Br.lights,{emissive:{value:new Ci(0)},specular:{value:new Ci(1118481)},shininess:{value:30}}]),vertexShader:Rr.meshphong_vert,fragmentShader:Rr.meshphong_frag},standard:{uniforms:or([Br.common,Br.envmap,Br.aomap,Br.lightmap,Br.emissivemap,Br.bumpmap,Br.normalmap,Br.displacementmap,Br.roughnessmap,Br.metalnessmap,Br.fog,Br.lights,{emissive:{value:new Ci(0)},roughness:{value:1},metalness:{value:0},envMapIntensity:{value:1}}]),vertexShader:Rr.meshphysical_vert,fragmentShader:Rr.meshphysical_frag},toon:{uniforms:or([Br.common,Br.aomap,Br.lightmap,Br.emissivemap,Br.bumpmap,Br.normalmap,Br.displacementmap,Br.gradientmap,Br.fog,Br.lights,{emissive:{value:new Ci(0)}}]),vertexShader:Rr.meshtoon_vert,fragmentShader:Rr.meshtoon_frag},matcap:{uniforms:or([Br.common,Br.bumpmap,Br.normalmap,Br.displacementmap,Br.fog,{matcap:{value:null}}]),vertexShader:Rr.meshmatcap_vert,fragmentShader:Rr.meshmatcap_frag},points:{uniforms:or([Br.points,Br.fog]),vertexShader:Rr.points_vert,fragmentShader:Rr.points_frag},dashed:{uniforms:or([Br.common,Br.fog,{scale:{value:1},dashSize:{value:1},totalSize:{value:2}}]),vertexShader:Rr.linedashed_vert,fragmentShader:Rr.linedashed_frag},depth:{uniforms:or([Br.common,Br.displacementmap]),vertexShader:Rr.depth_vert,fragmentShader:Rr.depth_frag},normal:{uniforms:or([Br.common,Br.bumpmap,Br.normalmap,Br.displacementmap,{opacity:{value:1}}]),vertexShader:Rr.meshnormal_vert,fragmentShader:Rr.meshnormal_frag},sprite:{uniforms:or([Br.sprite,Br.fog]),vertexShader:Rr.sprite_vert,fragmentShader:Rr.sprite_frag},background:{uniforms:{uvTransform:{value:new Rt},t2D:{value:null},backgroundIntensity:{value:1}},vertexShader:Rr.background_vert,fragmentShader:Rr.background_frag},backgroundCube:{uniforms:{envMap:{value:null},flipEnvMap:{value:-1},backgroundBlurriness:{value:0},backgroundIntensity:{value:1},backgroundRotation:{value:new Rt}},vertexShader:Rr.backgroundCube_vert,fragmentShader:Rr.backgroundCube_frag},cube:{uniforms:{tCube:{value:null},tFlip:{value:-1},opacity:{value:1}},vertexShader:Rr.cube_vert,fragmentShader:Rr.cube_frag},equirect:{uniforms:{tEquirect:{value:null}},vertexShader:Rr.equirect_vert,fragmentShader:Rr.equirect_frag},distanceRGBA:{uniforms:or([Br.common,Br.displacementmap,{referencePosition:{value:new sn},nearDistance:{value:1},farDistance:{value:1e3}}]),vertexShader:Rr.distanceRGBA_vert,fragmentShader:Rr.distanceRGBA_frag},shadow:{uniforms:or([Br.lights,Br.fog,{color:{value:new Ci(0)},opacity:{value:1}}]),vertexShader:Rr.shadow_vert,fragmentShader:Rr.shadow_frag}};Lr.physical={uniforms:or([Lr.standard.uniforms,{clearcoat:{value:0},clearcoatMap:{value:null},clearcoatMapTransform:{value:new Rt},clearcoatNormalMap:{value:null},clearcoatNormalMapTransform:{value:new Rt},clearcoatNormalScale:{value:new It(1,1)},clearcoatRoughness:{value:0},clearcoatRoughnessMap:{value:null},clearcoatRoughnessMapTransform:{value:new Rt},dispersion:{value:0},iridescence:{value:0},iridescenceMap:{value:null},iridescenceMapTransform:{value:new Rt},iridescenceIOR:{value:1.3},iridescenceThicknessMinimum:{value:100},iridescenceThicknessMaximum:{value:400},iridescenceThicknessMap:{value:null},iridescenceThicknessMapTransform:{value:new Rt},sheen:{value:0},sheenColor:{value:new Ci(0)},sheenColorMap:{value:null},sheenColorMapTransform:{value:new Rt},sheenRoughness:{value:1},sheenRoughnessMap:{value:null},sheenRoughnessMapTransform:{value:new Rt},transmission:{value:0},transmissionMap:{value:null},transmissionMapTransform:{value:new Rt},transmissionSamplerSize:{value:new It},transmissionSamplerMap:{value:null},thickness:{value:0},thicknessMap:{value:null},thicknessMapTransform:{value:new Rt},attenuationDistance:{value:0},attenuationColor:{value:new Ci(0)},specularColor:{value:new Ci(1,1,1)},specularColorMap:{value:null},specularColorMapTransform:{value:new Rt},specularIntensity:{value:1},specularIntensityMap:{value:null},specularIntensityMapTransform:{value:new Rt},anisotropyVector:{value:new It},anisotropyMap:{value:null},anisotropyMapTransform:{value:new Rt}}]),vertexShader:Rr.meshphysical_vert,fragmentShader:Rr.meshphysical_frag};const Pr={r:0,b:0,g:0},Dr=new jn,Nr=new Nn;function Ur(e,t,n,i,a,o,l){const c=new Ci(0);let h,u,d=!0===o?0:1,p=null,f=0,m=null;function g(e){let i=!0===e.isScene?e.background:null;return i&&i.isTexture&&(i=(e.backgroundBlurriness>0?n:t).get(i)),i}function A(t,n){t.getRGB(Pr,lr(e)),i.buffers.color.setClear(Pr.r,Pr.g,Pr.b,n,l)}return{getClearColor:function(){return c},setClearColor:function(e,t=1){c.set(e),d=t,A(c,d)},getClearAlpha:function(){return d},setClearAlpha:function(e){d=e,A(c,d)},render:function(t){let n=!1;const r=g(t);null===r?A(c,d):r&&r.isColor&&(A(r,1),n=!0);const s=e.xr.getEnvironmentBlendMode();"additive"===s?i.buffers.color.setClear(0,0,0,1,l):"alpha-blend"===s&&i.buffers.color.setClear(0,0,0,0,l),(e.autoClear||n)&&(i.buffers.depth.setTest(!0),i.buffers.depth.setMask(!0),i.buffers.color.setMask(!0),e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil))},addToRenderList:function(t,n){const i=g(n);i&&(i.isCubeTexture||i.mapping===Q)?(void 0===u&&(u=new ir(new sr(1,1,1),new hr({name:"BackgroundCubeMaterial",uniforms:ar(Lr.backgroundCube.uniforms),vertexShader:Lr.backgroundCube.vertexShader,fragmentShader:Lr.backgroundCube.fragmentShader,side:s,depthTest:!1,depthWrite:!1,fog:!1})),u.geometry.deleteAttribute("normal"),u.geometry.deleteAttribute("uv"),u.onBeforeRender=function(e,t,n){this.matrixWorld.copyPosition(n.matrixWorld)},Object.defineProperty(u.material,"envMap",{get:function(){return this.uniforms.envMap.value}}),a.update(u)),Dr.copy(n.backgroundRotation),Dr.x*=-1,Dr.y*=-1,Dr.z*=-1,i.isCubeTexture&&!1===i.isRenderTargetTexture&&(Dr.y*=-1,Dr.z*=-1),u.material.uniforms.envMap.value=i,u.material.uniforms.flipEnvMap.value=i.isCubeTexture&&!1===i.isRenderTargetTexture?-1:1,u.material.uniforms.backgroundBlurriness.value=n.backgroundBlurriness,u.material.uniforms.backgroundIntensity.value=n.backgroundIntensity,u.material.uniforms.backgroundRotation.value.setFromMatrix4(Nr.makeRotationFromEuler(Dr)),u.material.toneMapped=Ot.getTransfer(i.colorSpace)!==it,p===i&&f===i.version&&m===e.toneMapping||(u.material.needsUpdate=!0,p=i,f=i.version,m=e.toneMapping),u.layers.enableAll(),t.unshift(u,u.geometry,u.material,0,0,null)):i&&i.isTexture&&(void 0===h&&(h=new ir(new Ir(2,2),new hr({name:"BackgroundMaterial",uniforms:ar(Lr.background.uniforms),vertexShader:Lr.background.vertexShader,fragmentShader:Lr.background.fragmentShader,side:r,depthTest:!1,depthWrite:!1,fog:!1})),h.geometry.deleteAttribute("normal"),Object.defineProperty(h.material,"map",{get:function(){return this.uniforms.t2D.value}}),a.update(h)),h.material.uniforms.t2D.value=i,h.material.uniforms.backgroundIntensity.value=n.backgroundIntensity,h.material.toneMapped=Ot.getTransfer(i.colorSpace)!==it,!0===i.matrixAutoUpdate&&i.updateMatrix(),h.material.uniforms.uvTransform.value.copy(i.matrix),p===i&&f===i.version&&m===e.toneMapping||(h.material.needsUpdate=!0,p=i,f=i.version,m=e.toneMapping),h.layers.enableAll(),t.unshift(h,h.geometry,h.material,0,0,null))}}}function Or(e,t){const n=e.getParameter(e.MAX_VERTEX_ATTRIBS),i={},r=c(null);let s=r,a=!1;function o(t){return e.bindVertexArray(t)}function l(t){return e.deleteVertexArray(t)}function c(e){const t=[],i=[],r=[];for(let e=0;e<n;e++)t[e]=0,i[e]=0,r[e]=0;return{geometry:null,program:null,wireframe:!1,newAttributes:t,enabledAttributes:i,attributeDivisors:r,object:e,attributes:{},index:null}}function h(){const e=s.newAttributes;for(let t=0,n=e.length;t<n;t++)e[t]=0}function u(e){d(e,0)}function d(t,n){const i=s.newAttributes,r=s.enabledAttributes,a=s.attributeDivisors;i[t]=1,0===r[t]&&(e.enableVertexAttribArray(t),r[t]=1),a[t]!==n&&(e.vertexAttribDivisor(t,n),a[t]=n)}function p(){const t=s.newAttributes,n=s.enabledAttributes;for(let i=0,r=n.length;i<r;i++)n[i]!==t[i]&&(e.disableVertexAttribArray(i),n[i]=0)}function f(t,n,i,r,s,a,o){!0===o?e.vertexAttribIPointer(t,n,i,s,a):e.vertexAttribPointer(t,n,i,r,s,a)}function m(){g(),a=!0,s!==r&&(s=r,o(s.object))}function g(){r.geometry=null,r.program=null,r.wireframe=!1}return{setup:function(n,r,l,m,g){let A=!1;const y=function(t,n,r){const s=!0===r.wireframe;let a=i[t.id];void 0===a&&(a={},i[t.id]=a);let o=a[n.id];void 0===o&&(o={},a[n.id]=o);let l=o[s];return void 0===l&&(l=c(e.createVertexArray()),o[s]=l),l}(m,l,r);s!==y&&(s=y,o(s.object)),A=function(e,t,n,i){const r=s.attributes,a=t.attributes;let o=0;const l=n.getAttributes();for(const t in l)if(l[t].location>=0){const n=r[t];let i=a[t];if(void 0===i&&("instanceMatrix"===t&&e.instanceMatrix&&(i=e.instanceMatrix),"instanceColor"===t&&e.instanceColor&&(i=e.instanceColor)),void 0===n)return!0;if(n.attribute!==i)return!0;if(i&&n.data!==i.data)return!0;o++}return s.attributesNum!==o||s.index!==i}(n,m,l,g),A&&function(e,t,n,i){const r={},a=t.attributes;let o=0;const l=n.getAttributes();for(const t in l)if(l[t].location>=0){let n=a[t];void 0===n&&("instanceMatrix"===t&&e.instanceMatrix&&(n=e.instanceMatrix),"instanceColor"===t&&e.instanceColor&&(n=e.instanceColor));const i={};i.attribute=n,n&&n.data&&(i.data=n.data),r[t]=i,o++}s.attributes=r,s.attributesNum=o,s.index=i}(n,m,l,g),null!==g&&t.update(g,e.ELEMENT_ARRAY_BUFFER),(A||a)&&(a=!1,function(n,i,r,s){h();const a=s.attributes,o=r.getAttributes(),l=i.defaultAttributeValues;for(const i in o){const r=o[i];if(r.location>=0){let o=a[i];if(void 0===o&&("instanceMatrix"===i&&n.instanceMatrix&&(o=n.instanceMatrix),"instanceColor"===i&&n.instanceColor&&(o=n.instanceColor)),void 0!==o){const i=o.normalized,a=o.itemSize,l=t.get(o);if(void 0===l)continue;const c=l.buffer,h=l.type,p=l.bytesPerElement,m=h===e.INT||h===e.UNSIGNED_INT||o.gpuType===$;if(o.isInterleavedBufferAttribute){const t=o.data,l=t.stride,g=o.offset;if(t.isInstancedInterleavedBuffer){for(let e=0;e<r.locationSize;e++)d(r.location+e,t.meshPerAttribute);!0!==n.isInstancedMesh&&void 0===s._maxInstanceCount&&(s._maxInstanceCount=t.meshPerAttribute*t.count)}else for(let e=0;e<r.locationSize;e++)u(r.location+e);e.bindBuffer(e.ARRAY_BUFFER,c);for(let e=0;e<r.locationSize;e++)f(r.location+e,a/r.locationSize,h,i,l*p,(g+a/r.locationSize*e)*p,m)}else{if(o.isInstancedBufferAttribute){for(let e=0;e<r.locationSize;e++)d(r.location+e,o.meshPerAttribute);!0!==n.isInstancedMesh&&void 0===s._maxInstanceCount&&(s._maxInstanceCount=o.meshPerAttribute*o.count)}else for(let e=0;e<r.locationSize;e++)u(r.location+e);e.bindBuffer(e.ARRAY_BUFFER,c);for(let e=0;e<r.locationSize;e++)f(r.location+e,a/r.locationSize,h,i,a*p,a/r.locationSize*e*p,m)}}else if(void 0!==l){const t=l[i];if(void 0!==t)switch(t.length){case 2:e.vertexAttrib2fv(r.location,t);break;case 3:e.vertexAttrib3fv(r.location,t);break;case 4:e.vertexAttrib4fv(r.location,t);break;default:e.vertexAttrib1fv(r.location,t)}}}}p()}(n,r,l,m),null!==g&&e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,t.get(g).buffer))},reset:m,resetDefaultState:g,dispose:function(){m();for(const e in i){const t=i[e];for(const e in t){const n=t[e];for(const e in n)l(n[e].object),delete n[e];delete t[e]}delete i[e]}},releaseStatesOfGeometry:function(e){if(void 0===i[e.id])return;const t=i[e.id];for(const e in t){const n=t[e];for(const e in n)l(n[e].object),delete n[e];delete t[e]}delete i[e.id]},releaseStatesOfProgram:function(e){for(const t in i){const n=i[t];if(void 0===n[e.id])continue;const r=n[e.id];for(const e in r)l(r[e].object),delete r[e];delete n[e.id]}},initAttributes:h,enableAttribute:u,disableUnusedAttributes:p}}function Fr(e,t,n){let i;function r(t,r,s){0!==s&&(e.drawArraysInstanced(i,t,r,s),n.update(r,i,s))}this.setMode=function(e){i=e},this.render=function(t,r){e.drawArrays(i,t,r),n.update(r,i,1)},this.renderInstances=r,this.renderMultiDraw=function(e,r,s){if(0===s)return;t.get("WEBGL_multi_draw").multiDrawArraysWEBGL(i,e,0,r,0,s);let a=0;for(let e=0;e<s;e++)a+=r[e];n.update(a,i,1)},this.renderMultiDrawInstances=function(e,s,a,o){if(0===a)return;const l=t.get("WEBGL_multi_draw");if(null===l)for(let t=0;t<e.length;t++)r(e[t],s[t],o[t]);else{l.multiDrawArraysInstancedWEBGL(i,e,0,s,0,o,0,a);let t=0;for(let e=0;e<a;e++)t+=s[e]*o[e];n.update(t,i,1)}}}function kr(e,t,n,i){let r;function s(t){if("highp"===t){if(e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.HIGH_FLOAT).precision>0&&e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT).precision>0)return"highp";t="mediump"}return"mediump"===t&&e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.MEDIUM_FLOAT).precision>0&&e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT).precision>0?"mediump":"lowp"}let a=void 0!==n.precision?n.precision:"highp";const o=s(a);o!==a&&(console.warn("THREE.WebGLRenderer:",a,"not supported, using",o,"instead."),a=o);const l=!0===n.logarithmicDepthBuffer,c=!0===n.reverseDepthBuffer&&t.has("EXT_clip_control"),h=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),u=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS);return{isWebGL2:!0,getMaxAnisotropy:function(){if(void 0!==r)return r;if(!0===t.has("EXT_texture_filter_anisotropic")){const n=t.get("EXT_texture_filter_anisotropic");r=e.getParameter(n.MAX_TEXTURE_MAX_ANISOTROPY_EXT)}else r=0;return r},getMaxPrecision:s,textureFormatReadable:function(t){return t===ae||i.convert(t)===e.getParameter(e.IMPLEMENTATION_COLOR_READ_FORMAT)},textureTypeReadable:function(n){const r=n===te&&(t.has("EXT_color_buffer_half_float")||t.has("EXT_color_buffer_float"));return!(n!==K&&i.convert(n)!==e.getParameter(e.IMPLEMENTATION_COLOR_READ_TYPE)&&n!==ee&&!r)},precision:a,logarithmicDepthBuffer:l,reverseDepthBuffer:c,maxTextures:h,maxVertexTextures:u,maxTextureSize:e.getParameter(e.MAX_TEXTURE_SIZE),maxCubemapSize:e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),maxAttributes:e.getParameter(e.MAX_VERTEX_ATTRIBS),maxVertexUniforms:e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),maxVaryings:e.getParameter(e.MAX_VARYING_VECTORS),maxFragmentUniforms:e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),vertexTextures:u>0,maxSamples:e.getParameter(e.MAX_SAMPLES)}}function Qr(e){const t=this;let n=null,i=0,r=!1,s=!1;const a=new br,o=new Rt,l={value:null,needsUpdate:!1};function c(e,n,i,r){const s=null!==e?e.length:0;let c=null;if(0!==s){if(c=l.value,!0!==r||null===c){const t=i+4*s,r=n.matrixWorldInverse;o.getNormalMatrix(r),(null===c||c.length<t)&&(c=new Float32Array(t));for(let t=0,n=i;t!==s;++t,n+=4)a.copy(e[t]).applyMatrix4(r,o),a.normal.toArray(c,n),c[n+3]=a.constant}l.value=c,l.needsUpdate=!0}return t.numPlanes=s,t.numIntersection=0,c}this.uniform=l,this.numPlanes=0,this.numIntersection=0,this.init=function(e,t){const n=0!==e.length||t||0!==i||r;return r=t,i=e.length,n},this.beginShadows=function(){s=!0,c(null)},this.endShadows=function(){s=!1},this.setGlobalState=function(e,t){n=c(e,t,0)},this.setState=function(a,o,h){const u=a.clippingPlanes,d=a.clipIntersection,p=a.clipShadows,f=e.get(a);if(!r||null===u||0===u.length||s&&!p)s?c(null):(l.value!==n&&(l.value=n,l.needsUpdate=i>0),t.numPlanes=i,t.numIntersection=0);else{const e=s?0:i,t=4*e;let r=f.clippingState||null;l.value=r,r=c(u,o,t,h);for(let e=0;e!==t;++e)r[e]=n[e];f.clippingState=r,this.numIntersection=d?this.numPlanes:0,this.numPlanes+=e}}}function zr(e){let t=new WeakMap;function n(e,t){return 303===t?e.mapping=F:304===t&&(e.mapping=k),e}function i(e){const n=e.target;n.removeEventListener("dispose",i);const r=t.get(n);void 0!==r&&(t.delete(n),r.dispose())}return{get:function(r){if(r&&r.isTexture){const s=r.mapping;if(303===s||304===s){if(t.has(r))return n(t.get(r).texture,r.mapping);{const s=r.image;if(s&&s.height>0){const a=new vr(s.height);return a.fromEquirectangularTexture(e,r),t.set(r,a),r.addEventListener("dispose",i),n(a.texture,r.mapping)}return null}}}return r},dispose:function(){t=new WeakMap}}}class Gr extends ur{constructor(e=-1,t=1,n=1,i=-1,r=.1,s=2e3){super(),this.isOrthographicCamera=!0,this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=e,this.right=t,this.top=n,this.bottom=i,this.near=r,this.far=s,this.updateProjectionMatrix()}copy(e,t){return super.copy(e,t),this.left=e.left,this.right=e.right,this.top=e.top,this.bottom=e.bottom,this.near=e.near,this.far=e.far,this.zoom=e.zoom,this.view=null===e.view?null:Object.assign({},e.view),this}setViewOffset(e,t,n,i,r,s){null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=e,this.view.fullHeight=t,this.view.offsetX=n,this.view.offsetY=i,this.view.width=r,this.view.height=s,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const e=(this.right-this.left)/(2*this.zoom),t=(this.top-this.bottom)/(2*this.zoom),n=(this.right+this.left)/2,i=(this.top+this.bottom)/2;let r=n-e,s=n+e,a=i+t,o=i-t;if(null!==this.view&&this.view.enabled){const e=(this.right-this.left)/this.view.fullWidth/this.zoom,t=(this.top-this.bottom)/this.view.fullHeight/this.zoom;r+=e*this.view.offsetX,s=r+e*this.view.width,a-=t*this.view.offsetY,o=a-t*this.view.height}this.projectionMatrix.makeOrthographic(r,s,a,o,this.near,this.far,this.coordinateSystem),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(e){const t=super.toJSON(e);return t.object.zoom=this.zoom,t.object.left=this.left,t.object.right=this.right,t.object.top=this.top,t.object.bottom=this.bottom,t.object.near=this.near,t.object.far=this.far,null!==this.view&&(t.object.view=Object.assign({},this.view)),t}}const Hr=[.125,.215,.35,.446,.526,.582],Vr=new Gr,jr=new Ci;let qr=null,Wr=0,Yr=0,Xr=!1;const Kr=(1+Math.sqrt(5))/2,Jr=1/Kr,$r=[new sn(-Kr,Jr,0),new sn(Kr,Jr,0),new sn(-Jr,0,Kr),new sn(Jr,0,Kr),new sn(0,Kr,-Jr),new sn(0,Kr,Jr),new sn(-1,1,-1),new sn(1,1,-1),new sn(-1,1,1),new sn(1,1,1)];class Zr{constructor(e){this._renderer=e,this._pingPongRenderTarget=null,this._lodMax=0,this._cubeSize=0,this._lodPlanes=[],this._sizeLods=[],this._sigmas=[],this._blurMaterial=null,this._cubemapMaterial=null,this._equirectMaterial=null,this._compileMaterial(this._blurMaterial)}fromScene(e,t=0,n=.1,i=100){qr=this._renderer.getRenderTarget(),Wr=this._renderer.getActiveCubeFace(),Yr=this._renderer.getActiveMipmapLevel(),Xr=this._renderer.xr.enabled,this._renderer.xr.enabled=!1,this._setSize(256);const r=this._allocateTargets();return r.depthBuffer=!0,this._sceneToCubeUV(e,n,i,r),t>0&&this._blur(r,0,0,t),this._applyPMREM(r),this._cleanup(r),r}fromEquirectangular(e,t=null){return this._fromTexture(e,t)}fromCubemap(e,t=null){return this._fromTexture(e,t)}compileCubemapShader(){null===this._cubemapMaterial&&(this._cubemapMaterial=is(),this._compileMaterial(this._cubemapMaterial))}compileEquirectangularShader(){null===this._equirectMaterial&&(this._equirectMaterial=ns(),this._compileMaterial(this._equirectMaterial))}dispose(){this._dispose(),null!==this._cubemapMaterial&&this._cubemapMaterial.dispose(),null!==this._equirectMaterial&&this._equirectMaterial.dispose()}_setSize(e){this._lodMax=Math.floor(Math.log2(e)),this._cubeSize=Math.pow(2,this._lodMax)}_dispose(){null!==this._blurMaterial&&this._blurMaterial.dispose(),null!==this._pingPongRenderTarget&&this._pingPongRenderTarget.dispose();for(let e=0;e<this._lodPlanes.length;e++)this._lodPlanes[e].dispose()}_cleanup(e){this._renderer.setRenderTarget(qr,Wr,Yr),this._renderer.xr.enabled=Xr,e.scissorTest=!1,ts(e,0,0,e.width,e.height)}_fromTexture(e,t){e.mapping===F||e.mapping===k?this._setSize(0===e.image.length?16:e.image[0].width||e.image[0].image.width):this._setSize(e.image.width/4),qr=this._renderer.getRenderTarget(),Wr=this._renderer.getActiveCubeFace(),Yr=this._renderer.getActiveMipmapLevel(),Xr=this._renderer.xr.enabled,this._renderer.xr.enabled=!1;const n=t||this._allocateTargets();return this._textureToCubeUV(e,n),this._applyPMREM(n),this._cleanup(n),n}_allocateTargets(){const e=3*Math.max(this._cubeSize,112),t=4*this._cubeSize,n={magFilter:W,minFilter:W,generateMipmaps:!1,type:te,format:ae,colorSpace:tt,depthBuffer:!1},i=es(e,t,n);if(null===this._pingPongRenderTarget||this._pingPongRenderTarget.width!==e||this._pingPongRenderTarget.height!==t){null!==this._pingPongRenderTarget&&this._dispose(),this._pingPongRenderTarget=es(e,t,n);const{_lodMax:i}=this;({sizeLods:this._sizeLods,lodPlanes:this._lodPlanes,sigmas:this._sigmas}=function(e){const t=[],n=[],i=[];let r=e;const s=e-4+1+Hr.length;for(let a=0;a<s;a++){const s=Math.pow(2,r);n.push(s);let o=1/s;a>e-4?o=Hr[a-e+4-1]:0===a&&(o=0),i.push(o);const l=1/(s-2),c=-l,h=1+l,u=[c,c,h,c,h,h,c,c,h,h,c,h],d=6,p=6,f=3,m=2,g=1,A=new Float32Array(f*p*d),y=new Float32Array(m*p*d),v=new Float32Array(g*p*d);for(let e=0;e<d;e++){const t=e%3*2/3-1,n=e>2?0:-1,i=[t,n,0,t+2/3,n,0,t+2/3,n+1,0,t,n,0,t+2/3,n+1,0,t,n+1,0];A.set(i,f*p*e),y.set(u,m*p*e);const r=[e,e,e,e,e,e];v.set(r,g*p*e)}const _=new ji;_.setAttribute("position",new Di(A,f)),_.setAttribute("uv",new Di(y,m)),_.setAttribute("faceIndex",new Di(v,g)),t.push(_),r>4&&r--}return{lodPlanes:t,sizeLods:n,sigmas:i}}(i)),this._blurMaterial=function(e,t,n){const i=new Float32Array(20),r=new sn(0,1,0);return new hr({name:"SphericalGaussianBlur",defines:{n:20,CUBEUV_TEXEL_WIDTH:1/t,CUBEUV_TEXEL_HEIGHT:1/n,CUBEUV_MAX_MIP:`${e}.0`},uniforms:{envMap:{value:null},samples:{value:1},weights:{value:i},latitudinal:{value:!1},dTheta:{value:0},mipInt:{value:0},poleAxis:{value:r}},vertexShader:"\n\n\t\tprecision mediump float;\n\t\tprecision mediump int;\n\n\t\tattribute float faceIndex;\n\n\t\tvarying vec3 vOutputDirection;\n\n\t\t// RH coordinate system; PMREM face-indexing convention\n\t\tvec3 getDirection( vec2 uv, float face ) {\n\n\t\t\tuv = 2.0 * uv - 1.0;\n\n\t\t\tvec3 direction = vec3( uv, 1.0 );\n\n\t\t\tif ( face == 0.0 ) {\n\n\t\t\t\tdirection = direction.zyx; // ( 1, v, u ) pos x\n\n\t\t\t} else if ( face == 1.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xz *= -1.0; // ( -u, 1, -v ) pos y\n\n\t\t\t} else if ( face == 2.0 ) {\n\n\t\t\t\tdirection.x *= -1.0; // ( -u, v, 1 ) pos z\n\n\t\t\t} else if ( face == 3.0 ) {\n\n\t\t\t\tdirection = direction.zyx;\n\t\t\t\tdirection.xz *= -1.0; // ( -1, v, -u ) neg x\n\n\t\t\t} else if ( face == 4.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xy *= -1.0; // ( -u, -1, v ) neg y\n\n\t\t\t} else if ( face == 5.0 ) {\n\n\t\t\t\tdirection.z *= -1.0; // ( u, v, -1 ) neg z\n\n\t\t\t}\n\n\t\t\treturn direction;\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tvOutputDirection = getDirection( uv, faceIndex );\n\t\t\tgl_Position = vec4( position, 1.0 );\n\n\t\t}\n\t",fragmentShader:"\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform sampler2D envMap;\n\t\t\tuniform int samples;\n\t\t\tuniform float weights[ n ];\n\t\t\tuniform bool latitudinal;\n\t\t\tuniform float dTheta;\n\t\t\tuniform float mipInt;\n\t\t\tuniform vec3 poleAxis;\n\n\t\t\t#define ENVMAP_TYPE_CUBE_UV\n\t\t\t#include <cube_uv_reflection_fragment>\n\n\t\t\tvec3 getSample( float theta, vec3 axis ) {\n\n\t\t\t\tfloat cosTheta = cos( theta );\n\t\t\t\t// Rodrigues' axis-angle rotation\n\t\t\t\tvec3 sampleDirection = vOutputDirection * cosTheta\n\t\t\t\t\t+ cross( axis, vOutputDirection ) * sin( theta )\n\t\t\t\t\t+ axis * dot( axis, vOutputDirection ) * ( 1.0 - cosTheta );\n\n\t\t\t\treturn bilinearCubeUV( envMap, sampleDirection, mipInt );\n\n\t\t\t}\n\n\t\t\tvoid main() {\n\n\t\t\t\tvec3 axis = latitudinal ? poleAxis : cross( poleAxis, vOutputDirection );\n\n\t\t\t\tif ( all( equal( axis, vec3( 0.0 ) ) ) ) {\n\n\t\t\t\t\taxis = vec3( vOutputDirection.z, 0.0, - vOutputDirection.x );\n\n\t\t\t\t}\n\n\t\t\t\taxis = normalize( axis );\n\n\t\t\t\tgl_FragColor = vec4( 0.0, 0.0, 0.0, 1.0 );\n\t\t\t\tgl_FragColor.rgb += weights[ 0 ] * getSample( 0.0, axis );\n\n\t\t\t\tfor ( int i = 1; i < n; i++ ) {\n\n\t\t\t\t\tif ( i >= samples ) {\n\n\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t}\n\n\t\t\t\t\tfloat theta = dTheta * float( i );\n\t\t\t\t\tgl_FragColor.rgb += weights[ i ] * getSample( -1.0 * theta, axis );\n\t\t\t\t\tgl_FragColor.rgb += weights[ i ] * getSample( theta, axis );\n\n\t\t\t\t}\n\n\t\t\t}\n\t\t",blending:o,depthTest:!1,depthWrite:!1})}(i,e,t)}return i}_compileMaterial(e){const t=new ir(this._lodPlanes[0],e);this._renderer.compile(t,Vr)}_sceneToCubeUV(e,t,n,i){const r=new mr(90,1,t,n),a=[1,-1,1,1,1,1],o=[1,1,1,-1,-1,-1],l=this._renderer,c=l.autoClear,h=l.toneMapping;l.getClearColor(jr),l.toneMapping=0,l.autoClear=!1;const u=new Bi({name:"PMREM.Background",side:s,depthWrite:!1,depthTest:!1}),d=new ir(new sr,u);let p=!1;const f=e.background;f?f.isColor&&(u.color.copy(f),e.background=null,p=!0):(u.color.copy(jr),p=!0);for(let t=0;t<6;t++){const n=t%3;0===n?(r.up.set(0,a[t],0),r.lookAt(o[t],0,0)):1===n?(r.up.set(0,0,a[t]),r.lookAt(0,o[t],0)):(r.up.set(0,a[t],0),r.lookAt(0,0,o[t]));const s=this._cubeSize;ts(i,n*s,t>2?s:0,s,s),l.setRenderTarget(i),p&&l.render(d,r),l.render(e,r)}d.geometry.dispose(),d.material.dispose(),l.toneMapping=h,l.autoClear=c,e.background=f}_textureToCubeUV(e,t){const n=this._renderer,i=e.mapping===F||e.mapping===k;i?(null===this._cubemapMaterial&&(this._cubemapMaterial=is()),this._cubemapMaterial.uniforms.flipEnvMap.value=!1===e.isRenderTargetTexture?-1:1):null===this._equirectMaterial&&(this._equirectMaterial=ns());const r=i?this._cubemapMaterial:this._equirectMaterial,s=new ir(this._lodPlanes[0],r);r.uniforms.envMap.value=e;const a=this._cubeSize;ts(t,0,0,3*a,2*a),n.setRenderTarget(t),n.render(s,Vr)}_applyPMREM(e){const t=this._renderer,n=t.autoClear;t.autoClear=!1;const i=this._lodPlanes.length;for(let t=1;t<i;t++){const n=Math.sqrt(this._sigmas[t]*this._sigmas[t]-this._sigmas[t-1]*this._sigmas[t-1]),r=$r[(i-t-1)%$r.length];this._blur(e,t-1,t,n,r)}t.autoClear=n}_blur(e,t,n,i,r){const s=this._pingPongRenderTarget;this._halfBlur(e,s,t,n,i,"latitudinal",r),this._halfBlur(s,e,n,n,i,"longitudinal",r)}_halfBlur(e,t,n,i,r,s,a){const o=this._renderer,l=this._blurMaterial;"latitudinal"!==s&&"longitudinal"!==s&&console.error("blur direction must be either latitudinal or longitudinal!");const c=new ir(this._lodPlanes[i],l),h=l.uniforms,u=this._sizeLods[n]-1,d=isFinite(r)?Math.PI/(2*u):2*Math.PI/39,p=r/d,f=isFinite(r)?1+Math.floor(3*p):20;f>20&&console.warn(`sigmaRadians, ${r}, is too large and will clip, as it requested ${f} samples when the maximum is set to 20`);const m=[];let g=0;for(let e=0;e<20;++e){const t=e/p,n=Math.exp(-t*t/2);m.push(n),0===e?g+=n:e<f&&(g+=2*n)}for(let e=0;e<m.length;e++)m[e]=m[e]/g;h.envMap.value=e.texture,h.samples.value=f,h.weights.value=m,h.latitudinal.value="latitudinal"===s,a&&(h.poleAxis.value=a);const{_lodMax:A}=this;h.dTheta.value=d,h.mipInt.value=A-n;const y=this._sizeLods[i];ts(t,3*y*(i>A-4?i-A+4:0),4*(this._cubeSize-y),3*y,2*y),o.setRenderTarget(t),o.render(c,Vr)}}function es(e,t,n){const i=new en(e,t,n);return i.texture.mapping=Q,i.texture.name="PMREM.cubeUv",i.scissorTest=!0,i}function ts(e,t,n,i,r){e.viewport.set(t,n,i,r),e.scissor.set(t,n,i,r)}function ns(){return new hr({name:"EquirectangularToCubeUV",uniforms:{envMap:{value:null}},vertexShader:"\n\n\t\tprecision mediump float;\n\t\tprecision mediump int;\n\n\t\tattribute float faceIndex;\n\n\t\tvarying vec3 vOutputDirection;\n\n\t\t// RH coordinate system; PMREM face-indexing convention\n\t\tvec3 getDirection( vec2 uv, float face ) {\n\n\t\t\tuv = 2.0 * uv - 1.0;\n\n\t\t\tvec3 direction = vec3( uv, 1.0 );\n\n\t\t\tif ( face == 0.0 ) {\n\n\t\t\t\tdirection = direction.zyx; // ( 1, v, u ) pos x\n\n\t\t\t} else if ( face == 1.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xz *= -1.0; // ( -u, 1, -v ) pos y\n\n\t\t\t} else if ( face == 2.0 ) {\n\n\t\t\t\tdirection.x *= -1.0; // ( -u, v, 1 ) pos z\n\n\t\t\t} else if ( face == 3.0 ) {\n\n\t\t\t\tdirection = direction.zyx;\n\t\t\t\tdirection.xz *= -1.0; // ( -1, v, -u ) neg x\n\n\t\t\t} else if ( face == 4.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xy *= -1.0; // ( -u, -1, v ) neg y\n\n\t\t\t} else if ( face == 5.0 ) {\n\n\t\t\t\tdirection.z *= -1.0; // ( u, v, -1 ) neg z\n\n\t\t\t}\n\n\t\t\treturn direction;\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tvOutputDirection = getDirection( uv, faceIndex );\n\t\t\tgl_Position = vec4( position, 1.0 );\n\n\t\t}\n\t",fragmentShader:"\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform sampler2D envMap;\n\n\t\t\t#include <common>\n\n\t\t\tvoid main() {\n\n\t\t\t\tvec3 outputDirection = normalize( vOutputDirection );\n\t\t\t\tvec2 uv = equirectUv( outputDirection );\n\n\t\t\t\tgl_FragColor = vec4( texture2D ( envMap, uv ).rgb, 1.0 );\n\n\t\t\t}\n\t\t",blending:o,depthTest:!1,depthWrite:!1})}function is(){return new hr({name:"CubemapToCubeUV",uniforms:{envMap:{value:null},flipEnvMap:{value:-1}},vertexShader:"\n\n\t\tprecision mediump float;\n\t\tprecision mediump int;\n\n\t\tattribute float faceIndex;\n\n\t\tvarying vec3 vOutputDirection;\n\n\t\t// RH coordinate system; PMREM face-indexing convention\n\t\tvec3 getDirection( vec2 uv, float face ) {\n\n\t\t\tuv = 2.0 * uv - 1.0;\n\n\t\t\tvec3 direction = vec3( uv, 1.0 );\n\n\t\t\tif ( face == 0.0 ) {\n\n\t\t\t\tdirection = direction.zyx; // ( 1, v, u ) pos x\n\n\t\t\t} else if ( face == 1.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xz *= -1.0; // ( -u, 1, -v ) pos y\n\n\t\t\t} else if ( face == 2.0 ) {\n\n\t\t\t\tdirection.x *= -1.0; // ( -u, v, 1 ) pos z\n\n\t\t\t} else if ( face == 3.0 ) {\n\n\t\t\t\tdirection = direction.zyx;\n\t\t\t\tdirection.xz *= -1.0; // ( -1, v, -u ) neg x\n\n\t\t\t} else if ( face == 4.0 ) {\n\n\t\t\t\tdirection = direction.xzy;\n\t\t\t\tdirection.xy *= -1.0; // ( -u, -1, v ) neg y\n\n\t\t\t} else if ( face == 5.0 ) {\n\n\t\t\t\tdirection.z *= -1.0; // ( u, v, -1 ) neg z\n\n\t\t\t}\n\n\t\t\treturn direction;\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\tvOutputDirection = getDirection( uv, faceIndex );\n\t\t\tgl_Position = vec4( position, 1.0 );\n\n\t\t}\n\t",fragmentShader:"\n\n\t\t\tprecision mediump float;\n\t\t\tprecision mediump int;\n\n\t\t\tuniform float flipEnvMap;\n\n\t\t\tvarying vec3 vOutputDirection;\n\n\t\t\tuniform samplerCube envMap;\n\n\t\t\tvoid main() {\n\n\t\t\t\tgl_FragColor = textureCube( envMap, vec3( flipEnvMap * vOutputDirection.x, vOutputDirection.yz ) );\n\n\t\t\t}\n\t\t",blending:o,depthTest:!1,depthWrite:!1})}function rs(e){let t=new WeakMap,n=null;function i(e){const n=e.target;n.removeEventListener("dispose",i);const r=t.get(n);void 0!==r&&(t.delete(n),r.dispose())}return{get:function(r){if(r&&r.isTexture){const s=r.mapping,a=303===s||304===s,o=s===F||s===k;if(a||o){let s=t.get(r);const l=void 0!==s?s.texture.pmremVersion:0;if(r.isRenderTargetTexture&&r.pmremVersion!==l)return null===n&&(n=new Zr(e)),s=a?n.fromEquirectangular(r,s):n.fromCubemap(r,s),s.texture.pmremVersion=r.pmremVersion,t.set(r,s),s.texture;if(void 0!==s)return s.texture;{const l=r.image;return a&&l&&l.height>0||o&&l&&function(e){let t=0;for(let n=0;n<6;n++)void 0!==e[n]&&t++;return 6===t}(l)?(null===n&&(n=new Zr(e)),s=a?n.fromEquirectangular(r):n.fromCubemap(r),s.texture.pmremVersion=r.pmremVersion,t.set(r,s),r.addEventListener("dispose",i),s.texture):null}}}return r},dispose:function(){t=new WeakMap,null!==n&&(n.dispose(),n=null)}}}function ss(e){const t={};function n(n){if(void 0!==t[n])return t[n];let i;switch(n){case"WEBGL_depth_texture":i=e.getExtension("WEBGL_depth_texture")||e.getExtension("MOZ_WEBGL_depth_texture")||e.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":i=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":i=e.getExtension("WEBGL_compressed_texture_s3tc")||e.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":i=e.getExtension("WEBGL_compressed_texture_pvrtc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;default:i=e.getExtension(n)}return t[n]=i,i}return{has:function(e){return null!==n(e)},init:function(){n("EXT_color_buffer_float"),n("WEBGL_clip_cull_distance"),n("OES_texture_float_linear"),n("EXT_color_buffer_half_float"),n("WEBGL_multisampled_render_to_texture"),n("WEBGL_render_shared_exponent")},get:function(e){const t=n(e);return null===t&&Ut("THREE.WebGLRenderer: "+e+" extension not supported."),t}}}function as(e,t,n,i){const r={},s=new WeakMap;function a(e){const o=e.target;null!==o.index&&t.remove(o.index);for(const e in o.attributes)t.remove(o.attributes[e]);for(const e in o.morphAttributes){const n=o.morphAttributes[e];for(let e=0,i=n.length;e<i;e++)t.remove(n[e])}o.removeEventListener("dispose",a),delete r[o.id];const l=s.get(o);l&&(t.remove(l),s.delete(o)),i.releaseStatesOfGeometry(o),!0===o.isInstancedBufferGeometry&&delete o._maxInstanceCount,n.memory.geometries--}function o(e){const n=[],i=e.index,r=e.attributes.position;let a=0;if(null!==i){const e=i.array;a=i.version;for(let t=0,i=e.length;t<i;t+=3){const i=e[t+0],r=e[t+1],s=e[t+2];n.push(i,r,r,s,s,i)}}else{if(void 0===r)return;{const e=r.array;a=r.version;for(let t=0,i=e.length/3-1;t<i;t+=3){const e=t+0,i=t+1,r=t+2;n.push(e,i,i,r,r,e)}}}const o=new(Lt(n)?Ui:Ni)(n,1);o.version=a;const l=s.get(e);l&&t.remove(l),s.set(e,o)}return{get:function(e,t){return!0===r[t.id]||(t.addEventListener("dispose",a),r[t.id]=!0,n.memory.geometries++),t},update:function(n){const i=n.attributes;for(const n in i)t.update(i[n],e.ARRAY_BUFFER);const r=n.morphAttributes;for(const n in r){const i=r[n];for(let n=0,r=i.length;n<r;n++)t.update(i[n],e.ARRAY_BUFFER)}},getWireframeAttribute:function(e){const t=s.get(e);if(t){const n=e.index;null!==n&&t.version<n.version&&o(e)}else o(e);return s.get(e)}}}function os(e,t,n){let i,r,s;function a(t,a,o){0!==o&&(e.drawElementsInstanced(i,a,r,t*s,o),n.update(a,i,o))}this.setMode=function(e){i=e},this.setIndex=function(e){r=e.type,s=e.bytesPerElement},this.render=function(t,a){e.drawElements(i,a,r,t*s),n.update(a,i,1)},this.renderInstances=a,this.renderMultiDraw=function(e,s,a){if(0===a)return;t.get("WEBGL_multi_draw").multiDrawElementsWEBGL(i,s,0,r,e,0,a);let o=0;for(let e=0;e<a;e++)o+=s[e];n.update(o,i,1)},this.renderMultiDrawInstances=function(e,o,l,c){if(0===l)return;const h=t.get("WEBGL_multi_draw");if(null===h)for(let t=0;t<e.length;t++)a(e[t]/s,o[t],c[t]);else{h.multiDrawElementsInstancedWEBGL(i,o,0,r,e,0,c,0,l);let t=0;for(let e=0;e<l;e++)t+=o[e]*c[e];n.update(t,i,1)}}}function ls(e){const t={frame:0,calls:0,triangles:0,points:0,lines:0};return{memory:{geometries:0,textures:0},render:t,programs:null,autoReset:!0,reset:function(){t.calls=0,t.triangles=0,t.points=0,t.lines=0},update:function(n,i,r){switch(t.calls++,i){case e.TRIANGLES:t.triangles+=r*(n/3);break;case e.LINES:t.lines+=r*(n/2);break;case e.LINE_STRIP:t.lines+=r*(n-1);break;case e.LINE_LOOP:t.lines+=r*n;break;case e.POINTS:t.points+=r*n;break;default:console.error("THREE.WebGLInfo: Unknown draw mode:",i)}}}}function cs(e,t,n){const i=new WeakMap,r=new $t;return{update:function(s,a,o){const l=s.morphTargetInfluences,c=a.morphAttributes.position||a.morphAttributes.normal||a.morphAttributes.color,h=void 0!==c?c.length:0;let u=i.get(a);if(void 0===u||u.count!==h){void 0!==u&&u.texture.dispose();const d=void 0!==a.morphAttributes.position,p=void 0!==a.morphAttributes.normal,f=void 0!==a.morphAttributes.color,m=a.morphAttributes.position||[],g=a.morphAttributes.normal||[],A=a.morphAttributes.color||[];let y=0;!0===d&&(y=1),!0===p&&(y=2),!0===f&&(y=3);let v=a.attributes.position.count*y,_=1;v>t.maxTextureSize&&(_=Math.ceil(v/t.maxTextureSize),v=t.maxTextureSize);const x=new Float32Array(v*_*4*h),E=new tn(x,v,_,h);E.type=ee,E.needsUpdate=!0;const b=4*y;for(let M=0;M<h;M++){const S=m[M],C=g[M],T=A[M],I=v*_*4*M;for(let R=0;R<S.count;R++){const B=R*b;!0===d&&(r.fromBufferAttribute(S,R),x[I+B+0]=r.x,x[I+B+1]=r.y,x[I+B+2]=r.z,x[I+B+3]=0),!0===p&&(r.fromBufferAttribute(C,R),x[I+B+4]=r.x,x[I+B+5]=r.y,x[I+B+6]=r.z,x[I+B+7]=0),!0===f&&(r.fromBufferAttribute(T,R),x[I+B+8]=r.x,x[I+B+9]=r.y,x[I+B+10]=r.z,x[I+B+11]=4===T.itemSize?r.w:1)}}function w(){E.dispose(),i.delete(a),a.removeEventListener("dispose",w)}u={count:h,texture:E,size:new It(v,_)},i.set(a,u),a.addEventListener("dispose",w)}if(!0===s.isInstancedMesh&&null!==s.morphTexture)o.getUniforms().setValue(e,"morphTexture",s.morphTexture,n);else{let L=0;for(let D=0;D<l.length;D++)L+=l[D];const P=a.morphTargetsRelative?1:1-L;o.getUniforms().setValue(e,"morphTargetBaseInfluence",P),o.getUniforms().setValue(e,"morphTargetInfluences",l)}o.getUniforms().setValue(e,"morphTargetsTexture",u.texture,n),o.getUniforms().setValue(e,"morphTargetsTextureSize",u.size)}}}function hs(e,t,n,i){let r=new WeakMap;function s(e){const t=e.target;t.removeEventListener("dispose",s),n.remove(t.instanceMatrix),null!==t.instanceColor&&n.remove(t.instanceColor)}return{update:function(a){const o=i.render.frame,l=a.geometry,c=t.get(a,l);if(r.get(c)!==o&&(t.update(c),r.set(c,o)),a.isInstancedMesh&&(!1===a.hasEventListener("dispose",s)&&a.addEventListener("dispose",s),r.get(a)!==o&&(n.update(a.instanceMatrix,e.ARRAY_BUFFER),null!==a.instanceColor&&n.update(a.instanceColor,e.ARRAY_BUFFER),r.set(a,o))),a.isSkinnedMesh){const e=a.skeleton;r.get(e)!==o&&(e.update(),r.set(e,o))}return c},dispose:function(){r=new WeakMap}}}class us extends Jt{constructor(e,t,n,i,r,s,a,o,l,c=1026){if(c!==ce&&c!==he)throw new Error("DepthTexture format must be either THREE.DepthFormat or THREE.DepthStencilFormat");void 0===n&&c===ce&&(n=Z),void 0===n&&c===he&&(n=re),super(null,i,r,s,a,o,c,n,l),this.isDepthTexture=!0,this.image={width:e,height:t},this.magFilter=void 0!==a?a:V,this.minFilter=void 0!==o?o:V,this.flipY=!1,this.generateMipmaps=!1,this.compareFunction=null}copy(e){return super.copy(e),this.compareFunction=e.compareFunction,this}toJSON(e){const t=super.toJSON(e);return null!==this.compareFunction&&(t.compareFunction=this.compareFunction),t}}const ds=new Jt,ps=new us(1,1),fs=new tn,ms=new nn,gs=new yr,As=[],ys=[],vs=new Float32Array(16),_s=new Float32Array(9),xs=new Float32Array(4);function Es(e,t,n){const i=e[0];if(i<=0||i>0)return e;const r=t*n;let s=As[r];if(void 0===s&&(s=new Float32Array(r),As[r]=s),0!==t){i.toArray(s,0);for(let i=1,r=0;i!==t;++i)r+=n,e[i].toArray(s,r)}return s}function bs(e,t){if(e.length!==t.length)return!1;for(let n=0,i=e.length;n<i;n++)if(e[n]!==t[n])return!1;return!0}function ws(e,t){for(let n=0,i=t.length;n<i;n++)e[n]=t[n]}function Ms(e,t){let n=ys[t];void 0===n&&(n=new Int32Array(t),ys[t]=n);for(let i=0;i!==t;++i)n[i]=e.allocateTextureUnit();return n}function Ss(e,t){const n=this.cache;n[0]!==t&&(e.uniform1f(this.addr,t),n[0]=t)}function Cs(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y||(e.uniform2f(this.addr,t.x,t.y),n[0]=t.x,n[1]=t.y);else{if(bs(n,t))return;e.uniform2fv(this.addr,t),ws(n,t)}}function Ts(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y&&n[2]===t.z||(e.uniform3f(this.addr,t.x,t.y,t.z),n[0]=t.x,n[1]=t.y,n[2]=t.z);else if(void 0!==t.r)n[0]===t.r&&n[1]===t.g&&n[2]===t.b||(e.uniform3f(this.addr,t.r,t.g,t.b),n[0]=t.r,n[1]=t.g,n[2]=t.b);else{if(bs(n,t))return;e.uniform3fv(this.addr,t),ws(n,t)}}function Is(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y&&n[2]===t.z&&n[3]===t.w||(e.uniform4f(this.addr,t.x,t.y,t.z,t.w),n[0]=t.x,n[1]=t.y,n[2]=t.z,n[3]=t.w);else{if(bs(n,t))return;e.uniform4fv(this.addr,t),ws(n,t)}}function Rs(e,t){const n=this.cache,i=t.elements;if(void 0===i){if(bs(n,t))return;e.uniformMatrix2fv(this.addr,!1,t),ws(n,t)}else{if(bs(n,i))return;xs.set(i),e.uniformMatrix2fv(this.addr,!1,xs),ws(n,i)}}function Bs(e,t){const n=this.cache,i=t.elements;if(void 0===i){if(bs(n,t))return;e.uniformMatrix3fv(this.addr,!1,t),ws(n,t)}else{if(bs(n,i))return;_s.set(i),e.uniformMatrix3fv(this.addr,!1,_s),ws(n,i)}}function Ls(e,t){const n=this.cache,i=t.elements;if(void 0===i){if(bs(n,t))return;e.uniformMatrix4fv(this.addr,!1,t),ws(n,t)}else{if(bs(n,i))return;vs.set(i),e.uniformMatrix4fv(this.addr,!1,vs),ws(n,i)}}function Ps(e,t){const n=this.cache;n[0]!==t&&(e.uniform1i(this.addr,t),n[0]=t)}function Ds(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y||(e.uniform2i(this.addr,t.x,t.y),n[0]=t.x,n[1]=t.y);else{if(bs(n,t))return;e.uniform2iv(this.addr,t),ws(n,t)}}function Ns(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y&&n[2]===t.z||(e.uniform3i(this.addr,t.x,t.y,t.z),n[0]=t.x,n[1]=t.y,n[2]=t.z);else{if(bs(n,t))return;e.uniform3iv(this.addr,t),ws(n,t)}}function Us(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y&&n[2]===t.z&&n[3]===t.w||(e.uniform4i(this.addr,t.x,t.y,t.z,t.w),n[0]=t.x,n[1]=t.y,n[2]=t.z,n[3]=t.w);else{if(bs(n,t))return;e.uniform4iv(this.addr,t),ws(n,t)}}function Os(e,t){const n=this.cache;n[0]!==t&&(e.uniform1ui(this.addr,t),n[0]=t)}function Fs(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y||(e.uniform2ui(this.addr,t.x,t.y),n[0]=t.x,n[1]=t.y);else{if(bs(n,t))return;e.uniform2uiv(this.addr,t),ws(n,t)}}function ks(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y&&n[2]===t.z||(e.uniform3ui(this.addr,t.x,t.y,t.z),n[0]=t.x,n[1]=t.y,n[2]=t.z);else{if(bs(n,t))return;e.uniform3uiv(this.addr,t),ws(n,t)}}function Qs(e,t){const n=this.cache;if(void 0!==t.x)n[0]===t.x&&n[1]===t.y&&n[2]===t.z&&n[3]===t.w||(e.uniform4ui(this.addr,t.x,t.y,t.z,t.w),n[0]=t.x,n[1]=t.y,n[2]=t.z,n[3]=t.w);else{if(bs(n,t))return;e.uniform4uiv(this.addr,t),ws(n,t)}}function zs(e,t,n){const i=this.cache,r=n.allocateTextureUnit();let s;i[0]!==r&&(e.uniform1i(this.addr,r),i[0]=r),this.type===e.SAMPLER_2D_SHADOW?(ps.compareFunction=515,s=ps):s=ds,n.setTexture2D(t||s,r)}function Gs(e,t,n){const i=this.cache,r=n.allocateTextureUnit();i[0]!==r&&(e.uniform1i(this.addr,r),i[0]=r),n.setTexture3D(t||ms,r)}function Hs(e,t,n){const i=this.cache,r=n.allocateTextureUnit();i[0]!==r&&(e.uniform1i(this.addr,r),i[0]=r),n.setTextureCube(t||gs,r)}function Vs(e,t,n){const i=this.cache,r=n.allocateTextureUnit();i[0]!==r&&(e.uniform1i(this.addr,r),i[0]=r),n.setTexture2DArray(t||fs,r)}function js(e,t){e.uniform1fv(this.addr,t)}function qs(e,t){const n=Es(t,this.size,2);e.uniform2fv(this.addr,n)}function Ws(e,t){const n=Es(t,this.size,3);e.uniform3fv(this.addr,n)}function Ys(e,t){const n=Es(t,this.size,4);e.uniform4fv(this.addr,n)}function Xs(e,t){const n=Es(t,this.size,4);e.uniformMatrix2fv(this.addr,!1,n)}function Ks(e,t){const n=Es(t,this.size,9);e.uniformMatrix3fv(this.addr,!1,n)}function Js(e,t){const n=Es(t,this.size,16);e.uniformMatrix4fv(this.addr,!1,n)}function $s(e,t){e.uniform1iv(this.addr,t)}function Zs(e,t){e.uniform2iv(this.addr,t)}function ea(e,t){e.uniform3iv(this.addr,t)}function ta(e,t){e.uniform4iv(this.addr,t)}function na(e,t){e.uniform1uiv(this.addr,t)}function ia(e,t){e.uniform2uiv(this.addr,t)}function ra(e,t){e.uniform3uiv(this.addr,t)}function sa(e,t){e.uniform4uiv(this.addr,t)}function aa(e,t,n){const i=this.cache,r=t.length,s=Ms(n,r);bs(i,s)||(e.uniform1iv(this.addr,s),ws(i,s));for(let e=0;e!==r;++e)n.setTexture2D(t[e]||ds,s[e])}function oa(e,t,n){const i=this.cache,r=t.length,s=Ms(n,r);bs(i,s)||(e.uniform1iv(this.addr,s),ws(i,s));for(let e=0;e!==r;++e)n.setTexture3D(t[e]||ms,s[e])}function la(e,t,n){const i=this.cache,r=t.length,s=Ms(n,r);bs(i,s)||(e.uniform1iv(this.addr,s),ws(i,s));for(let e=0;e!==r;++e)n.setTextureCube(t[e]||gs,s[e])}function ca(e,t,n){const i=this.cache,r=t.length,s=Ms(n,r);bs(i,s)||(e.uniform1iv(this.addr,s),ws(i,s));for(let e=0;e!==r;++e)n.setTexture2DArray(t[e]||fs,s[e])}class ha{constructor(e,t,n){this.id=e,this.addr=n,this.cache=[],this.type=t.type,this.setValue=function(e){switch(e){case 5126:return Ss;case 35664:return Cs;case 35665:return Ts;case 35666:return Is;case 35674:return Rs;case 35675:return Bs;case 35676:return Ls;case 5124:case 35670:return Ps;case 35667:case 35671:return Ds;case 35668:case 35672:return Ns;case 35669:case 35673:return Us;case 5125:return Os;case 36294:return Fs;case 36295:return ks;case 36296:return Qs;case 35678:case 36198:case 36298:case 36306:case 35682:return zs;case 35679:case 36299:case 36307:return Gs;case 35680:case 36300:case 36308:case 36293:return Hs;case 36289:case 36303:case 36311:case 36292:return Vs}}(t.type)}}class ua{constructor(e,t,n){this.id=e,this.addr=n,this.cache=[],this.type=t.type,this.size=t.size,this.setValue=function(e){switch(e){case 5126:return js;case 35664:return qs;case 35665:return Ws;case 35666:return Ys;case 35674:return Xs;case 35675:return Ks;case 35676:return Js;case 5124:case 35670:return $s;case 35667:case 35671:return Zs;case 35668:case 35672:return ea;case 35669:case 35673:return ta;case 5125:return na;case 36294:return ia;case 36295:return ra;case 36296:return sa;case 35678:case 36198:case 36298:case 36306:case 35682:return aa;case 35679:case 36299:case 36307:return oa;case 35680:case 36300:case 36308:case 36293:return la;case 36289:case 36303:case 36311:case 36292:return ca}}(t.type)}}class da{constructor(e){this.id=e,this.seq=[],this.map={}}setValue(e,t,n){const i=this.seq;for(let r=0,s=i.length;r!==s;++r){const s=i[r];s.setValue(e,t[s.id],n)}}}const pa=/(\w+)(\])?(\[|\.)?/g;function fa(e,t){e.seq.push(t),e.map[t.id]=t}function ma(e,t,n){const i=e.name,r=i.length;for(pa.lastIndex=0;;){const s=pa.exec(i),a=pa.lastIndex;let o=s[1];const l="]"===s[2],c=s[3];if(l&&(o|=0),void 0===c||"["===c&&a+2===r){fa(n,void 0===c?new ha(o,e,t):new ua(o,e,t));break}{let e=n.map[o];void 0===e&&(e=new da(o),fa(n,e)),n=e}}}class ga{constructor(e,t){this.seq=[],this.map={};const n=e.getProgramParameter(t,e.ACTIVE_UNIFORMS);for(let i=0;i<n;++i){const n=e.getActiveUniform(t,i);ma(n,e.getUniformLocation(t,n.name),this)}}setValue(e,t,n,i){const r=this.map[t];void 0!==r&&r.setValue(e,n,i)}setOptional(e,t,n){const i=t[n];void 0!==i&&this.setValue(e,n,i)}static upload(e,t,n,i){for(let r=0,s=t.length;r!==s;++r){const s=t[r],a=n[s.id];!1!==a.needsUpdate&&s.setValue(e,a.value,i)}}static seqWithValue(e,t){const n=[];for(let i=0,r=e.length;i!==r;++i){const r=e[i];r.id in t&&n.push(r)}return n}}function Aa(e,t,n){const i=e.createShader(t);return e.shaderSource(i,n),e.compileShader(i),i}let ya=0;const va=new Rt;function _a(e,t,n){const i=e.getShaderParameter(t,e.COMPILE_STATUS),r=e.getShaderInfoLog(t).trim();if(i&&""===r)return"";const s=/ERROR: 0:(\d+)/.exec(r);if(s){const i=parseInt(s[1]);return n.toUpperCase()+"\n\n"+r+"\n\n"+function(e,t){const n=e.split("\n"),i=[],r=Math.max(t-6,0),s=Math.min(t+6,n.length);for(let e=r;e<s;e++){const r=e+1;i.push(`${r===t?">":" "} ${r}: ${n[e]}`)}return i.join("\n")}(e.getShaderSource(t),i)}return r}function xa(e,t){const n=function(e){Ot._getMatrix(va,Ot.workingColorSpace,e);const t=`mat3( ${va.elements.map((e=>e.toFixed(4)))} )`;switch(Ot.getTransfer(e)){case nt:return[t,"LinearTransferOETF"];case it:return[t,"sRGBTransferOETF"];default:return console.warn("THREE.WebGLProgram: Unsupported color space: ",e),[t,"LinearTransferOETF"]}}(t);return[`vec4 ${e}( vec4 value ) {`,`\treturn ${n[1]}( vec4( value.rgb * ${n[0]}, value.a ) );`,"}"].join("\n")}function Ea(e,t){let n;switch(t){case 1:n="Linear";break;case 2:n="Reinhard";break;case 3:n="Cineon";break;case 4:n="ACESFilmic";break;case 6:n="AgX";break;case 7:n="Neutral";break;case 5:n="Custom";break;default:console.warn("THREE.WebGLProgram: Unsupported toneMapping:",t),n="Linear"}return"vec3 "+e+"( vec3 color ) { return "+n+"ToneMapping( color ); }"}const ba=new sn;function wa(e){return""!==e}function Ma(e,t){const n=t.numSpotLightShadows+t.numSpotLightMaps-t.numSpotLightShadowsWithMaps;return e.replace(/NUM_DIR_LIGHTS/g,t.numDirLights).replace(/NUM_SPOT_LIGHTS/g,t.numSpotLights).replace(/NUM_SPOT_LIGHT_MAPS/g,t.numSpotLightMaps).replace(/NUM_SPOT_LIGHT_COORDS/g,n).replace(/NUM_RECT_AREA_LIGHTS/g,t.numRectAreaLights).replace(/NUM_POINT_LIGHTS/g,t.numPointLights).replace(/NUM_HEMI_LIGHTS/g,t.numHemiLights).replace(/NUM_DIR_LIGHT_SHADOWS/g,t.numDirLightShadows).replace(/NUM_SPOT_LIGHT_SHADOWS_WITH_MAPS/g,t.numSpotLightShadowsWithMaps).replace(/NUM_SPOT_LIGHT_SHADOWS/g,t.numSpotLightShadows).replace(/NUM_POINT_LIGHT_SHADOWS/g,t.numPointLightShadows)}function Sa(e,t){return e.replace(/NUM_CLIPPING_PLANES/g,t.numClippingPlanes).replace(/UNION_CLIPPING_PLANES/g,t.numClippingPlanes-t.numClipIntersection)}const Ca=/^[ \t]*#include +<([\w\d./]+)>/gm;function Ta(e){return e.replace(Ca,Ra)}const Ia=new Map;function Ra(e,t){let n=Rr[t];if(void 0===n){const e=Ia.get(t);if(void 0===e)throw new Error("Can not resolve #include <"+t+">");n=Rr[e],console.warn('THREE.WebGLRenderer: Shader chunk "%s" has been deprecated. Use "%s" instead.',t,e)}return Ta(n)}const Ba=/#pragma unroll_loop_start\s+for\s*\(\s*int\s+i\s*=\s*(\d+)\s*;\s*i\s*<\s*(\d+)\s*;\s*i\s*\+\+\s*\)\s*{([\s\S]+?)}\s+#pragma unroll_loop_end/g;function La(e){return e.replace(Ba,Pa)}function Pa(e,t,n,i){let r="";for(let e=parseInt(t);e<parseInt(n);e++)r+=i.replace(/\[\s*i\s*\]/g,"[ "+e+" ]").replace(/UNROLLED_LOOP_INDEX/g,e);return r}function Da(e){let t=`precision ${e.precision} float;\n\tprecision ${e.precision} int;\n\tprecision ${e.precision} sampler2D;\n\tprecision ${e.precision} samplerCube;\n\tprecision ${e.precision} sampler3D;\n\tprecision ${e.precision} sampler2DArray;\n\tprecision ${e.precision} sampler2DShadow;\n\tprecision ${e.precision} samplerCubeShadow;\n\tprecision ${e.precision} sampler2DArrayShadow;\n\tprecision ${e.precision} isampler2D;\n\tprecision ${e.precision} isampler3D;\n\tprecision ${e.precision} isamplerCube;\n\tprecision ${e.precision} isampler2DArray;\n\tprecision ${e.precision} usampler2D;\n\tprecision ${e.precision} usampler3D;\n\tprecision ${e.precision} usamplerCube;\n\tprecision ${e.precision} usampler2DArray;\n\t`;return"highp"===e.precision?t+="\n#define HIGH_PRECISION":"mediump"===e.precision?t+="\n#define MEDIUM_PRECISION":"lowp"===e.precision&&(t+="\n#define LOW_PRECISION"),t}function Na(e,t,n,i){const r=e.getContext(),s=n.defines;let a=n.vertexShader,o=n.fragmentShader;const l=function(e){let t="SHADOWMAP_TYPE_BASIC";return 1===e.shadowMapType?t="SHADOWMAP_TYPE_PCF":2===e.shadowMapType?t="SHADOWMAP_TYPE_PCF_SOFT":3===e.shadowMapType&&(t="SHADOWMAP_TYPE_VSM"),t}(n),c=function(e){let t="ENVMAP_TYPE_CUBE";if(e.envMap)switch(e.envMapMode){case F:case k:t="ENVMAP_TYPE_CUBE";break;case Q:t="ENVMAP_TYPE_CUBE_UV"}return t}(n),h=function(e){let t="ENVMAP_MODE_REFLECTION";return e.envMap&&e.envMapMode===k&&(t="ENVMAP_MODE_REFRACTION"),t}(n),u=function(e){let t="ENVMAP_BLENDING_NONE";if(e.envMap)switch(e.combine){case 0:t="ENVMAP_BLENDING_MULTIPLY";break;case 1:t="ENVMAP_BLENDING_MIX";break;case 2:t="ENVMAP_BLENDING_ADD"}return t}(n),d=function(e){const t=e.envMapCubeUVHeight;if(null===t)return null;const n=Math.log2(t)-2,i=1/t;return{texelWidth:1/(3*Math.max(Math.pow(2,n),112)),texelHeight:i,maxMip:n}}(n),p=function(e){return[e.extensionClipCullDistance?"#extension GL_ANGLE_clip_cull_distance : require":"",e.extensionMultiDraw?"#extension GL_ANGLE_multi_draw : require":""].filter(wa).join("\n")}(n),f=function(e){const t=[];for(const n in e){const i=e[n];!1!==i&&t.push("#define "+n+" "+i)}return t.join("\n")}(s),m=r.createProgram();let g,A,y=n.glslVersion?"#version "+n.glslVersion+"\n":"";n.isRawShaderMaterial?(g=["#define SHADER_TYPE "+n.shaderType,"#define SHADER_NAME "+n.shaderName,f].filter(wa).join("\n"),g.length>0&&(g+="\n"),A=["#define SHADER_TYPE "+n.shaderType,"#define SHADER_NAME "+n.shaderName,f].filter(wa).join("\n"),A.length>0&&(A+="\n")):(g=[Da(n),"#define SHADER_TYPE "+n.shaderType,"#define SHADER_NAME "+n.shaderName,f,n.extensionClipCullDistance?"#define USE_CLIP_DISTANCE":"",n.batching?"#define USE_BATCHING":"",n.batchingColor?"#define USE_BATCHING_COLOR":"",n.instancing?"#define USE_INSTANCING":"",n.instancingColor?"#define USE_INSTANCING_COLOR":"",n.instancingMorph?"#define USE_INSTANCING_MORPH":"",n.useFog&&n.fog?"#define USE_FOG":"",n.useFog&&n.fogExp2?"#define FOG_EXP2":"",n.map?"#define USE_MAP":"",n.envMap?"#define USE_ENVMAP":"",n.envMap?"#define "+h:"",n.lightMap?"#define USE_LIGHTMAP":"",n.aoMap?"#define USE_AOMAP":"",n.bumpMap?"#define USE_BUMPMAP":"",n.normalMap?"#define USE_NORMALMAP":"",n.normalMapObjectSpace?"#define USE_NORMALMAP_OBJECTSPACE":"",n.normalMapTangentSpace?"#define USE_NORMALMAP_TANGENTSPACE":"",n.displacementMap?"#define USE_DISPLACEMENTMAP":"",n.emissiveMap?"#define USE_EMISSIVEMAP":"",n.anisotropy?"#define USE_ANISOTROPY":"",n.anisotropyMap?"#define USE_ANISOTROPYMAP":"",n.clearcoatMap?"#define USE_CLEARCOATMAP":"",n.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",n.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",n.iridescenceMap?"#define USE_IRIDESCENCEMAP":"",n.iridescenceThicknessMap?"#define USE_IRIDESCENCE_THICKNESSMAP":"",n.specularMap?"#define USE_SPECULARMAP":"",n.specularColorMap?"#define USE_SPECULAR_COLORMAP":"",n.specularIntensityMap?"#define USE_SPECULAR_INTENSITYMAP":"",n.roughnessMap?"#define USE_ROUGHNESSMAP":"",n.metalnessMap?"#define USE_METALNESSMAP":"",n.alphaMap?"#define USE_ALPHAMAP":"",n.alphaHash?"#define USE_ALPHAHASH":"",n.transmission?"#define USE_TRANSMISSION":"",n.transmissionMap?"#define USE_TRANSMISSIONMAP":"",n.thicknessMap?"#define USE_THICKNESSMAP":"",n.sheenColorMap?"#define USE_SHEEN_COLORMAP":"",n.sheenRoughnessMap?"#define USE_SHEEN_ROUGHNESSMAP":"",n.mapUv?"#define MAP_UV "+n.mapUv:"",n.alphaMapUv?"#define ALPHAMAP_UV "+n.alphaMapUv:"",n.lightMapUv?"#define LIGHTMAP_UV "+n.lightMapUv:"",n.aoMapUv?"#define AOMAP_UV "+n.aoMapUv:"",n.emissiveMapUv?"#define EMISSIVEMAP_UV "+n.emissiveMapUv:"",n.bumpMapUv?"#define BUMPMAP_UV "+n.bumpMapUv:"",n.normalMapUv?"#define NORMALMAP_UV "+n.normalMapUv:"",n.displacementMapUv?"#define DISPLACEMENTMAP_UV "+n.displacementMapUv:"",n.metalnessMapUv?"#define METALNESSMAP_UV "+n.metalnessMapUv:"",n.roughnessMapUv?"#define ROUGHNESSMAP_UV "+n.roughnessMapUv:"",n.anisotropyMapUv?"#define ANISOTROPYMAP_UV "+n.anisotropyMapUv:"",n.clearcoatMapUv?"#define CLEARCOATMAP_UV "+n.clearcoatMapUv:"",n.clearcoatNormalMapUv?"#define CLEARCOAT_NORMALMAP_UV "+n.clearcoatNormalMapUv:"",n.clearcoatRoughnessMapUv?"#define CLEARCOAT_ROUGHNESSMAP_UV "+n.clearcoatRoughnessMapUv:"",n.iridescenceMapUv?"#define IRIDESCENCEMAP_UV "+n.iridescenceMapUv:"",n.iridescenceThicknessMapUv?"#define IRIDESCENCE_THICKNESSMAP_UV "+n.iridescenceThicknessMapUv:"",n.sheenColorMapUv?"#define SHEEN_COLORMAP_UV "+n.sheenColorMapUv:"",n.sheenRoughnessMapUv?"#define SHEEN_ROUGHNESSMAP_UV "+n.sheenRoughnessMapUv:"",n.specularMapUv?"#define SPECULARMAP_UV "+n.specularMapUv:"",n.specularColorMapUv?"#define SPECULAR_COLORMAP_UV "+n.specularColorMapUv:"",n.specularIntensityMapUv?"#define SPECULAR_INTENSITYMAP_UV "+n.specularIntensityMapUv:"",n.transmissionMapUv?"#define TRANSMISSIONMAP_UV "+n.transmissionMapUv:"",n.thicknessMapUv?"#define THICKNESSMAP_UV "+n.thicknessMapUv:"",n.vertexTangents&&!1===n.flatShading?"#define USE_TANGENT":"",n.vertexColors?"#define USE_COLOR":"",n.vertexAlphas?"#define USE_COLOR_ALPHA":"",n.vertexUv1s?"#define USE_UV1":"",n.vertexUv2s?"#define USE_UV2":"",n.vertexUv3s?"#define USE_UV3":"",n.pointsUvs?"#define USE_POINTS_UV":"",n.flatShading?"#define FLAT_SHADED":"",n.skinning?"#define USE_SKINNING":"",n.morphTargets?"#define USE_MORPHTARGETS":"",n.morphNormals&&!1===n.flatShading?"#define USE_MORPHNORMALS":"",n.morphColors?"#define USE_MORPHCOLORS":"",n.morphTargetsCount>0?"#define MORPHTARGETS_TEXTURE_STRIDE "+n.morphTextureStride:"",n.morphTargetsCount>0?"#define MORPHTARGETS_COUNT "+n.morphTargetsCount:"",n.doubleSided?"#define DOUBLE_SIDED":"",n.flipSided?"#define FLIP_SIDED":"",n.shadowMapEnabled?"#define USE_SHADOWMAP":"",n.shadowMapEnabled?"#define "+l:"",n.sizeAttenuation?"#define USE_SIZEATTENUATION":"",n.numLightProbes>0?"#define USE_LIGHT_PROBES":"",n.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",n.reverseDepthBuffer?"#define USE_REVERSEDEPTHBUF":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;","#ifdef USE_INSTANCING","\tattribute mat4 instanceMatrix;","#endif","#ifdef USE_INSTANCING_COLOR","\tattribute vec3 instanceColor;","#endif","#ifdef USE_INSTANCING_MORPH","\tuniform sampler2D morphTexture;","#endif","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","#ifdef USE_UV1","\tattribute vec2 uv1;","#endif","#ifdef USE_UV2","\tattribute vec2 uv2;","#endif","#ifdef USE_UV3","\tattribute vec2 uv3;","#endif","#ifdef USE_TANGENT","\tattribute vec4 tangent;","#endif","#if defined( USE_COLOR_ALPHA )","\tattribute vec4 color;","#elif defined( USE_COLOR )","\tattribute vec3 color;","#endif","#ifdef USE_SKINNING","\tattribute vec4 skinIndex;","\tattribute vec4 skinWeight;","#endif","\n"].filter(wa).join("\n"),A=[Da(n),"#define SHADER_TYPE "+n.shaderType,"#define SHADER_NAME "+n.shaderName,f,n.useFog&&n.fog?"#define USE_FOG":"",n.useFog&&n.fogExp2?"#define FOG_EXP2":"",n.alphaToCoverage?"#define ALPHA_TO_COVERAGE":"",n.map?"#define USE_MAP":"",n.matcap?"#define USE_MATCAP":"",n.envMap?"#define USE_ENVMAP":"",n.envMap?"#define "+c:"",n.envMap?"#define "+h:"",n.envMap?"#define "+u:"",d?"#define CUBEUV_TEXEL_WIDTH "+d.texelWidth:"",d?"#define CUBEUV_TEXEL_HEIGHT "+d.texelHeight:"",d?"#define CUBEUV_MAX_MIP "+d.maxMip+".0":"",n.lightMap?"#define USE_LIGHTMAP":"",n.aoMap?"#define USE_AOMAP":"",n.bumpMap?"#define USE_BUMPMAP":"",n.normalMap?"#define USE_NORMALMAP":"",n.normalMapObjectSpace?"#define USE_NORMALMAP_OBJECTSPACE":"",n.normalMapTangentSpace?"#define USE_NORMALMAP_TANGENTSPACE":"",n.emissiveMap?"#define USE_EMISSIVEMAP":"",n.anisotropy?"#define USE_ANISOTROPY":"",n.anisotropyMap?"#define USE_ANISOTROPYMAP":"",n.clearcoat?"#define USE_CLEARCOAT":"",n.clearcoatMap?"#define USE_CLEARCOATMAP":"",n.clearcoatRoughnessMap?"#define USE_CLEARCOAT_ROUGHNESSMAP":"",n.clearcoatNormalMap?"#define USE_CLEARCOAT_NORMALMAP":"",n.dispersion?"#define USE_DISPERSION":"",n.iridescence?"#define USE_IRIDESCENCE":"",n.iridescenceMap?"#define USE_IRIDESCENCEMAP":"",n.iridescenceThicknessMap?"#define USE_IRIDESCENCE_THICKNESSMAP":"",n.specularMap?"#define USE_SPECULARMAP":"",n.specularColorMap?"#define USE_SPECULAR_COLORMAP":"",n.specularIntensityMap?"#define USE_SPECULAR_INTENSITYMAP":"",n.roughnessMap?"#define USE_ROUGHNESSMAP":"",n.metalnessMap?"#define USE_METALNESSMAP":"",n.alphaMap?"#define USE_ALPHAMAP":"",n.alphaTest?"#define USE_ALPHATEST":"",n.alphaHash?"#define USE_ALPHAHASH":"",n.sheen?"#define USE_SHEEN":"",n.sheenColorMap?"#define USE_SHEEN_COLORMAP":"",n.sheenRoughnessMap?"#define USE_SHEEN_ROUGHNESSMAP":"",n.transmission?"#define USE_TRANSMISSION":"",n.transmissionMap?"#define USE_TRANSMISSIONMAP":"",n.thicknessMap?"#define USE_THICKNESSMAP":"",n.vertexTangents&&!1===n.flatShading?"#define USE_TANGENT":"",n.vertexColors||n.instancingColor||n.batchingColor?"#define USE_COLOR":"",n.vertexAlphas?"#define USE_COLOR_ALPHA":"",n.vertexUv1s?"#define USE_UV1":"",n.vertexUv2s?"#define USE_UV2":"",n.vertexUv3s?"#define USE_UV3":"",n.pointsUvs?"#define USE_POINTS_UV":"",n.gradientMap?"#define USE_GRADIENTMAP":"",n.flatShading?"#define FLAT_SHADED":"",n.doubleSided?"#define DOUBLE_SIDED":"",n.flipSided?"#define FLIP_SIDED":"",n.shadowMapEnabled?"#define USE_SHADOWMAP":"",n.shadowMapEnabled?"#define "+l:"",n.premultipliedAlpha?"#define PREMULTIPLIED_ALPHA":"",n.numLightProbes>0?"#define USE_LIGHT_PROBES":"",n.decodeVideoTexture?"#define DECODE_VIDEO_TEXTURE":"",n.decodeVideoTextureEmissive?"#define DECODE_VIDEO_TEXTURE_EMISSIVE":"",n.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",n.reverseDepthBuffer?"#define USE_REVERSEDEPTHBUF":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;","uniform bool isOrthographic;",0!==n.toneMapping?"#define TONE_MAPPING":"",0!==n.toneMapping?Rr.tonemapping_pars_fragment:"",0!==n.toneMapping?Ea("toneMapping",n.toneMapping):"",n.dithering?"#define DITHERING":"",n.opaque?"#define OPAQUE":"",Rr.colorspace_pars_fragment,xa("linearToOutputTexel",n.outputColorSpace),(Ot.getLuminanceCoefficients(ba),["float luminance( const in vec3 rgb ) {",`\tconst vec3 weights = vec3( ${ba.x.toFixed(4)}, ${ba.y.toFixed(4)}, ${ba.z.toFixed(4)} );`,"\treturn dot( weights, rgb );","}"].join("\n")),n.useDepthPacking?"#define DEPTH_PACKING "+n.depthPacking:"","\n"].filter(wa).join("\n")),a=Ta(a),a=Ma(a,n),a=Sa(a,n),o=Ta(o),o=Ma(o,n),o=Sa(o,n),a=La(a),o=La(o),!0!==n.isRawShaderMaterial&&(y="#version 300 es\n",g=[p,"#define attribute in","#define varying out","#define texture2D texture"].join("\n")+"\n"+g,A=["#define varying in",n.glslVersion===ft?"":"layout(location = 0) out highp vec4 pc_fragColor;",n.glslVersion===ft?"":"#define gl_FragColor pc_fragColor","#define gl_FragDepthEXT gl_FragDepth","#define texture2D texture","#define textureCube texture","#define texture2DProj textureProj","#define texture2DLodEXT textureLod","#define texture2DProjLodEXT textureProjLod","#define textureCubeLodEXT textureLod","#define texture2DGradEXT textureGrad","#define texture2DProjGradEXT textureProjGrad","#define textureCubeGradEXT textureGrad"].join("\n")+"\n"+A);const v=y+g+a,_=y+A+o,x=Aa(r,r.VERTEX_SHADER,v),E=Aa(r,r.FRAGMENT_SHADER,_);function b(t){if(e.debug.checkShaderErrors){const n=r.getProgramInfoLog(m).trim(),i=r.getShaderInfoLog(x).trim(),s=r.getShaderInfoLog(E).trim();let a=!0,o=!0;if(!1===r.getProgramParameter(m,r.LINK_STATUS))if(a=!1,"function"==typeof e.debug.onShaderError)e.debug.onShaderError(r,m,x,E);else{const e=_a(r,x,"vertex"),i=_a(r,E,"fragment");console.error("THREE.WebGLProgram: Shader Error "+r.getError()+" - VALIDATE_STATUS "+r.getProgramParameter(m,r.VALIDATE_STATUS)+"\n\nMaterial Name: "+t.name+"\nMaterial Type: "+t.type+"\n\nProgram Info Log: "+n+"\n"+e+"\n"+i)}else""!==n?console.warn("THREE.WebGLProgram: Program Info Log:",n):""!==i&&""!==s||(o=!1);o&&(t.diagnostics={runnable:a,programLog:n,vertexShader:{log:i,prefix:g},fragmentShader:{log:s,prefix:A}})}r.deleteShader(x),r.deleteShader(E),w=new ga(r,m),M=function(e,t){const n={},i=e.getProgramParameter(t,e.ACTIVE_ATTRIBUTES);for(let r=0;r<i;r++){const i=e.getActiveAttrib(t,r),s=i.name;let a=1;i.type===e.FLOAT_MAT2&&(a=2),i.type===e.FLOAT_MAT3&&(a=3),i.type===e.FLOAT_MAT4&&(a=4),n[s]={type:i.type,location:e.getAttribLocation(t,s),locationSize:a}}return n}(r,m)}let w,M;r.attachShader(m,x),r.attachShader(m,E),void 0!==n.index0AttributeName?r.bindAttribLocation(m,0,n.index0AttributeName):!0===n.morphTargets&&r.bindAttribLocation(m,0,"position"),r.linkProgram(m),this.getUniforms=function(){return void 0===w&&b(this),w},this.getAttributes=function(){return void 0===M&&b(this),M};let S=!1===n.rendererExtensionParallelShaderCompile;return this.isReady=function(){return!1===S&&(S=r.getProgramParameter(m,37297)),S},this.destroy=function(){i.releaseStatesOfProgram(this),r.deleteProgram(m),this.program=void 0},this.type=n.shaderType,this.name=n.shaderName,this.id=ya++,this.cacheKey=t,this.usedTimes=1,this.program=m,this.vertexShader=x,this.fragmentShader=E,this}let Ua=0;class Oa{constructor(){this.shaderCache=new Map,this.materialCache=new Map}update(e){const t=e.vertexShader,n=e.fragmentShader,i=this._getShaderStage(t),r=this._getShaderStage(n),s=this._getShaderCacheForMaterial(e);return!1===s.has(i)&&(s.add(i),i.usedTimes++),!1===s.has(r)&&(s.add(r),r.usedTimes++),this}remove(e){const t=this.materialCache.get(e);for(const e of t)e.usedTimes--,0===e.usedTimes&&this.shaderCache.delete(e.code);return this.materialCache.delete(e),this}getVertexShaderID(e){return this._getShaderStage(e.vertexShader).id}getFragmentShaderID(e){return this._getShaderStage(e.fragmentShader).id}dispose(){this.shaderCache.clear(),this.materialCache.clear()}_getShaderCacheForMaterial(e){const t=this.materialCache;let n=t.get(e);return void 0===n&&(n=new Set,t.set(e,n)),n}_getShaderStage(e){const t=this.shaderCache;let n=t.get(e);return void 0===n&&(n=new Fa(e),t.set(e,n)),n}}class Fa{constructor(e){this.id=Ua++,this.code=e,this.usedTimes=0}}function ka(e,t,n,i,r,o,c){const h=new qn,u=new Oa,d=new Set,p=[],f=r.logarithmicDepthBuffer,m=r.vertexTextures;let g=r.precision;const A={MeshDepthMaterial:"depth",MeshDistanceMaterial:"distanceRGBA",MeshNormalMaterial:"normal",MeshBasicMaterial:"basic",MeshLambertMaterial:"lambert",MeshPhongMaterial:"phong",MeshToonMaterial:"toon",MeshStandardMaterial:"physical",MeshPhysicalMaterial:"physical",MeshMatcapMaterial:"matcap",LineBasicMaterial:"basic",LineDashedMaterial:"dashed",PointsMaterial:"points",ShadowMaterial:"shadow",SpriteMaterial:"sprite"};function y(e){return d.add(e),0===e?"uv":`uv${e}`}return{getParameters:function(o,h,p,v,_){const x=v.fog,E=_.geometry,b=o.isMeshStandardMaterial?v.environment:null,w=(o.isMeshStandardMaterial?n:t).get(o.envMap||b),M=w&&w.mapping===Q?w.image.height:null,S=A[o.type];null!==o.precision&&(g=r.getMaxPrecision(o.precision),g!==o.precision&&console.warn("THREE.WebGLProgram.getParameters:",o.precision,"not supported, using",g,"instead."));const C=E.morphAttributes.position||E.morphAttributes.normal||E.morphAttributes.color,T=void 0!==C?C.length:0;let I,R,B,L,P=0;if(void 0!==E.morphAttributes.position&&(P=1),void 0!==E.morphAttributes.normal&&(P=2),void 0!==E.morphAttributes.color&&(P=3),S){const e=Lr[S];I=e.vertexShader,R=e.fragmentShader}else I=o.vertexShader,R=o.fragmentShader,u.update(o),B=u.getVertexShaderID(o),L=u.getFragmentShaderID(o);const D=e.getRenderTarget(),N=e.state.buffers.depth.getReversed(),U=!0===_.isInstancedMesh,O=!0===_.isBatchedMesh,F=!!o.map,k=!!o.matcap,z=!!w,G=!!o.aoMap,H=!!o.lightMap,V=!!o.bumpMap,j=!!o.normalMap,q=!!o.displacementMap,W=!!o.emissiveMap,Y=!!o.metalnessMap,X=!!o.roughnessMap,K=o.anisotropy>0,J=o.clearcoat>0,$=o.dispersion>0,Z=o.iridescence>0,ee=o.sheen>0,te=o.transmission>0,ne=K&&!!o.anisotropyMap,ie=J&&!!o.clearcoatMap,re=J&&!!o.clearcoatNormalMap,se=J&&!!o.clearcoatRoughnessMap,ae=Z&&!!o.iridescenceMap,oe=Z&&!!o.iridescenceThicknessMap,le=ee&&!!o.sheenColorMap,ce=ee&&!!o.sheenRoughnessMap,he=!!o.specularMap,ue=!!o.specularColorMap,de=!!o.specularIntensityMap,pe=te&&!!o.transmissionMap,fe=te&&!!o.thicknessMap,me=!!o.gradientMap,ge=!!o.alphaMap,Ae=o.alphaTest>0,ye=!!o.alphaHash,ve=!!o.extensions;let _e=0;o.toneMapped&&(null!==D&&!0!==D.isXRRenderTarget||(_e=e.toneMapping));const xe={shaderID:S,shaderType:o.type,shaderName:o.name,vertexShader:I,fragmentShader:R,defines:o.defines,customVertexShaderID:B,customFragmentShaderID:L,isRawShaderMaterial:!0===o.isRawShaderMaterial,glslVersion:o.glslVersion,precision:g,batching:O,batchingColor:O&&null!==_._colorsTexture,instancing:U,instancingColor:U&&null!==_.instanceColor,instancingMorph:U&&null!==_.morphTexture,supportsVertexTextures:m,outputColorSpace:null===D?e.outputColorSpace:!0===D.isXRRenderTarget?D.texture.colorSpace:tt,alphaToCoverage:!!o.alphaToCoverage,map:F,matcap:k,envMap:z,envMapMode:z&&w.mapping,envMapCubeUVHeight:M,aoMap:G,lightMap:H,bumpMap:V,normalMap:j,displacementMap:m&&q,emissiveMap:W,normalMapObjectSpace:j&&1===o.normalMapType,normalMapTangentSpace:j&&0===o.normalMapType,metalnessMap:Y,roughnessMap:X,anisotropy:K,anisotropyMap:ne,clearcoat:J,clearcoatMap:ie,clearcoatNormalMap:re,clearcoatRoughnessMap:se,dispersion:$,iridescence:Z,iridescenceMap:ae,iridescenceThicknessMap:oe,sheen:ee,sheenColorMap:le,sheenRoughnessMap:ce,specularMap:he,specularColorMap:ue,specularIntensityMap:de,transmission:te,transmissionMap:pe,thicknessMap:fe,gradientMap:me,opaque:!1===o.transparent&&o.blending===l&&!1===o.alphaToCoverage,alphaMap:ge,alphaTest:Ae,alphaHash:ye,combine:o.combine,mapUv:F&&y(o.map.channel),aoMapUv:G&&y(o.aoMap.channel),lightMapUv:H&&y(o.lightMap.channel),bumpMapUv:V&&y(o.bumpMap.channel),normalMapUv:j&&y(o.normalMap.channel),displacementMapUv:q&&y(o.displacementMap.channel),emissiveMapUv:W&&y(o.emissiveMap.channel),metalnessMapUv:Y&&y(o.metalnessMap.channel),roughnessMapUv:X&&y(o.roughnessMap.channel),anisotropyMapUv:ne&&y(o.anisotropyMap.channel),clearcoatMapUv:ie&&y(o.clearcoatMap.channel),clearcoatNormalMapUv:re&&y(o.clearcoatNormalMap.channel),clearcoatRoughnessMapUv:se&&y(o.clearcoatRoughnessMap.channel),iridescenceMapUv:ae&&y(o.iridescenceMap.channel),iridescenceThicknessMapUv:oe&&y(o.iridescenceThicknessMap.channel),sheenColorMapUv:le&&y(o.sheenColorMap.channel),sheenRoughnessMapUv:ce&&y(o.sheenRoughnessMap.channel),specularMapUv:he&&y(o.specularMap.channel),specularColorMapUv:ue&&y(o.specularColorMap.channel),specularIntensityMapUv:de&&y(o.specularIntensityMap.channel),transmissionMapUv:pe&&y(o.transmissionMap.channel),thicknessMapUv:fe&&y(o.thicknessMap.channel),alphaMapUv:ge&&y(o.alphaMap.channel),vertexTangents:!!E.attributes.tangent&&(j||K),vertexColors:o.vertexColors,vertexAlphas:!0===o.vertexColors&&!!E.attributes.color&&4===E.attributes.color.itemSize,pointsUvs:!0===_.isPoints&&!!E.attributes.uv&&(F||ge),fog:!!x,useFog:!0===o.fog,fogExp2:!!x&&x.isFogExp2,flatShading:!0===o.flatShading,sizeAttenuation:!0===o.sizeAttenuation,logarithmicDepthBuffer:f,reverseDepthBuffer:N,skinning:!0===_.isSkinnedMesh,morphTargets:void 0!==E.morphAttributes.position,morphNormals:void 0!==E.morphAttributes.normal,morphColors:void 0!==E.morphAttributes.color,morphTargetsCount:T,morphTextureStride:P,numDirLights:h.directional.length,numPointLights:h.point.length,numSpotLights:h.spot.length,numSpotLightMaps:h.spotLightMap.length,numRectAreaLights:h.rectArea.length,numHemiLights:h.hemi.length,numDirLightShadows:h.directionalShadowMap.length,numPointLightShadows:h.pointShadowMap.length,numSpotLightShadows:h.spotShadowMap.length,numSpotLightShadowsWithMaps:h.numSpotLightShadowsWithMaps,numLightProbes:h.numLightProbes,numClippingPlanes:c.numPlanes,numClipIntersection:c.numIntersection,dithering:o.dithering,shadowMapEnabled:e.shadowMap.enabled&&p.length>0,shadowMapType:e.shadowMap.type,toneMapping:_e,decodeVideoTexture:F&&!0===o.map.isVideoTexture&&Ot.getTransfer(o.map.colorSpace)===it,decodeVideoTextureEmissive:W&&!0===o.emissiveMap.isVideoTexture&&Ot.getTransfer(o.emissiveMap.colorSpace)===it,premultipliedAlpha:o.premultipliedAlpha,doubleSided:o.side===a,flipSided:o.side===s,useDepthPacking:o.depthPacking>=0,depthPacking:o.depthPacking||0,index0AttributeName:o.index0AttributeName,extensionClipCullDistance:ve&&!0===o.extensions.clipCullDistance&&i.has("WEBGL_clip_cull_distance"),extensionMultiDraw:(ve&&!0===o.extensions.multiDraw||O)&&i.has("WEBGL_multi_draw"),rendererExtensionParallelShaderCompile:i.has("KHR_parallel_shader_compile"),customProgramCacheKey:o.customProgramCacheKey()};return xe.vertexUv1s=d.has(1),xe.vertexUv2s=d.has(2),xe.vertexUv3s=d.has(3),d.clear(),xe},getProgramCacheKey:function(t){const n=[];if(t.shaderID?n.push(t.shaderID):(n.push(t.customVertexShaderID),n.push(t.customFragmentShaderID)),void 0!==t.defines)for(const e in t.defines)n.push(e),n.push(t.defines[e]);return!1===t.isRawShaderMaterial&&(function(e,t){e.push(t.precision),e.push(t.outputColorSpace),e.push(t.envMapMode),e.push(t.envMapCubeUVHeight),e.push(t.mapUv),e.push(t.alphaMapUv),e.push(t.lightMapUv),e.push(t.aoMapUv),e.push(t.bumpMapUv),e.push(t.normalMapUv),e.push(t.displacementMapUv),e.push(t.emissiveMapUv),e.push(t.metalnessMapUv),e.push(t.roughnessMapUv),e.push(t.anisotropyMapUv),e.push(t.clearcoatMapUv),e.push(t.clearcoatNormalMapUv),e.push(t.clearcoatRoughnessMapUv),e.push(t.iridescenceMapUv),e.push(t.iridescenceThicknessMapUv),e.push(t.sheenColorMapUv),e.push(t.sheenRoughnessMapUv),e.push(t.specularMapUv),e.push(t.specularColorMapUv),e.push(t.specularIntensityMapUv),e.push(t.transmissionMapUv),e.push(t.thicknessMapUv),e.push(t.combine),e.push(t.fogExp2),e.push(t.sizeAttenuation),e.push(t.morphTargetsCount),e.push(t.morphAttributeCount),e.push(t.numDirLights),e.push(t.numPointLights),e.push(t.numSpotLights),e.push(t.numSpotLightMaps),e.push(t.numHemiLights),e.push(t.numRectAreaLights),e.push(t.numDirLightShadows),e.push(t.numPointLightShadows),e.push(t.numSpotLightShadows),e.push(t.numSpotLightShadowsWithMaps),e.push(t.numLightProbes),e.push(t.shadowMapType),e.push(t.toneMapping),e.push(t.numClippingPlanes),e.push(t.numClipIntersection),e.push(t.depthPacking)}(n,t),function(e,t){h.disableAll(),t.supportsVertexTextures&&h.enable(0),t.instancing&&h.enable(1),t.instancingColor&&h.enable(2),t.instancingMorph&&h.enable(3),t.matcap&&h.enable(4),t.envMap&&h.enable(5),t.normalMapObjectSpace&&h.enable(6),t.normalMapTangentSpace&&h.enable(7),t.clearcoat&&h.enable(8),t.iridescence&&h.enable(9),t.alphaTest&&h.enable(10),t.vertexColors&&h.enable(11),t.vertexAlphas&&h.enable(12),t.vertexUv1s&&h.enable(13),t.vertexUv2s&&h.enable(14),t.vertexUv3s&&h.enable(15),t.vertexTangents&&h.enable(16),t.anisotropy&&h.enable(17),t.alphaHash&&h.enable(18),t.batching&&h.enable(19),t.dispersion&&h.enable(20),t.batchingColor&&h.enable(21),e.push(h.mask),h.disableAll(),t.fog&&h.enable(0),t.useFog&&h.enable(1),t.flatShading&&h.enable(2),t.logarithmicDepthBuffer&&h.enable(3),t.reverseDepthBuffer&&h.enable(4),t.skinning&&h.enable(5),t.morphTargets&&h.enable(6),t.morphNormals&&h.enable(7),t.morphColors&&h.enable(8),t.premultipliedAlpha&&h.enable(9),t.shadowMapEnabled&&h.enable(10),t.doubleSided&&h.enable(11),t.flipSided&&h.enable(12),t.useDepthPacking&&h.enable(13),t.dithering&&h.enable(14),t.transmission&&h.enable(15),t.sheen&&h.enable(16),t.opaque&&h.enable(17),t.pointsUvs&&h.enable(18),t.decodeVideoTexture&&h.enable(19),t.decodeVideoTextureEmissive&&h.enable(20),t.alphaToCoverage&&h.enable(21),e.push(h.mask)}(n,t),n.push(e.outputColorSpace)),n.push(t.customProgramCacheKey),n.join()},getUniforms:function(e){const t=A[e.type];let n;if(t){const e=Lr[t];n=cr.clone(e.uniforms)}else n=e.uniforms;return n},acquireProgram:function(t,n){let i;for(let e=0,t=p.length;e<t;e++){const t=p[e];if(t.cacheKey===n){i=t,++i.usedTimes;break}}return void 0===i&&(i=new Na(e,n,t,o),p.push(i)),i},releaseProgram:function(e){if(0==--e.usedTimes){const t=p.indexOf(e);p[t]=p[p.length-1],p.pop(),e.destroy()}},releaseShaderCache:function(e){u.remove(e)},programs:p,dispose:function(){u.dispose()}}}function Qa(){let e=new WeakMap;return{has:function(t){return e.has(t)},get:function(t){let n=e.get(t);return void 0===n&&(n={},e.set(t,n)),n},remove:function(t){e.delete(t)},update:function(t,n,i){e.get(t)[n]=i},dispose:function(){e=new WeakMap}}}function za(e,t){return e.groupOrder!==t.groupOrder?e.groupOrder-t.groupOrder:e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.material.id!==t.material.id?e.material.id-t.material.id:e.z!==t.z?e.z-t.z:e.id-t.id}function Ga(e,t){return e.groupOrder!==t.groupOrder?e.groupOrder-t.groupOrder:e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.z!==t.z?t.z-e.z:e.id-t.id}function Ha(){const e=[];let t=0;const n=[],i=[],r=[];function s(n,i,r,s,a,o){let l=e[t];return void 0===l?(l={id:n.id,object:n,geometry:i,material:r,groupOrder:s,renderOrder:n.renderOrder,z:a,group:o},e[t]=l):(l.id=n.id,l.object=n,l.geometry=i,l.material=r,l.groupOrder=s,l.renderOrder=n.renderOrder,l.z=a,l.group=o),t++,l}return{opaque:n,transmissive:i,transparent:r,init:function(){t=0,n.length=0,i.length=0,r.length=0},push:function(e,t,a,o,l,c){const h=s(e,t,a,o,l,c);a.transmission>0?i.push(h):!0===a.transparent?r.push(h):n.push(h)},unshift:function(e,t,a,o,l,c){const h=s(e,t,a,o,l,c);a.transmission>0?i.unshift(h):!0===a.transparent?r.unshift(h):n.unshift(h)},finish:function(){for(let n=t,i=e.length;n<i;n++){const t=e[n];if(null===t.id)break;t.id=null,t.object=null,t.geometry=null,t.material=null,t.group=null}},sort:function(e,t){n.length>1&&n.sort(e||za),i.length>1&&i.sort(t||Ga),r.length>1&&r.sort(t||Ga)}}}function Va(){let e=new WeakMap;return{get:function(t,n){const i=e.get(t);let r;return void 0===i?(r=new Ha,e.set(t,[r])):n>=i.length?(r=new Ha,i.push(r)):r=i[n],r},dispose:function(){e=new WeakMap}}}function ja(){const e={};return{get:function(t){if(void 0!==e[t.id])return e[t.id];let n;switch(t.type){case"DirectionalLight":n={direction:new sn,color:new Ci};break;case"SpotLight":n={position:new sn,direction:new sn,color:new Ci,distance:0,coneCos:0,penumbraCos:0,decay:0};break;case"PointLight":n={position:new sn,color:new Ci,distance:0,decay:0};break;case"HemisphereLight":n={direction:new sn,skyColor:new Ci,groundColor:new Ci};break;case"RectAreaLight":n={color:new Ci,position:new sn,halfWidth:new sn,halfHeight:new sn}}return e[t.id]=n,n}}}let qa=0;function Wa(e,t){return(t.castShadow?2:0)-(e.castShadow?2:0)+(t.map?1:0)-(e.map?1:0)}function Ya(e){const t=new ja,n=function(){const e={};return{get:function(t){if(void 0!==e[t.id])return e[t.id];let n;switch(t.type){case"DirectionalLight":case"SpotLight":n={shadowIntensity:1,shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new It};break;case"PointLight":n={shadowIntensity:1,shadowBias:0,shadowNormalBias:0,shadowRadius:1,shadowMapSize:new It,shadowCameraNear:1,shadowCameraFar:1e3}}return e[t.id]=n,n}}}(),i={version:0,hash:{directionalLength:-1,pointLength:-1,spotLength:-1,rectAreaLength:-1,hemiLength:-1,numDirectionalShadows:-1,numPointShadows:-1,numSpotShadows:-1,numSpotMaps:-1,numLightProbes:-1},ambient:[0,0,0],probe:[],directional:[],directionalShadow:[],directionalShadowMap:[],directionalShadowMatrix:[],spot:[],spotLightMap:[],spotShadow:[],spotShadowMap:[],spotLightMatrix:[],rectArea:[],rectAreaLTC1:null,rectAreaLTC2:null,point:[],pointShadow:[],pointShadowMap:[],pointShadowMatrix:[],hemi:[],numSpotLightShadowsWithMaps:0,numLightProbes:0};for(let e=0;e<9;e++)i.probe.push(new sn);const r=new sn,s=new Nn,a=new Nn;return{setup:function(r){let s=0,a=0,o=0;for(let e=0;e<9;e++)i.probe[e].set(0,0,0);let l=0,c=0,h=0,u=0,d=0,p=0,f=0,m=0,g=0,A=0,y=0;r.sort(Wa);for(let e=0,v=r.length;e<v;e++){const v=r[e],_=v.color,x=v.intensity,E=v.distance,b=v.shadow&&v.shadow.map?v.shadow.map.texture:null;if(v.isAmbientLight)s+=_.r*x,a+=_.g*x,o+=_.b*x;else if(v.isLightProbe){for(let e=0;e<9;e++)i.probe[e].addScaledVector(v.sh.coefficients[e],x);y++}else if(v.isDirectionalLight){const e=t.get(v);if(e.color.copy(v.color).multiplyScalar(v.intensity),v.castShadow){const e=v.shadow,t=n.get(v);t.shadowIntensity=e.intensity,t.shadowBias=e.bias,t.shadowNormalBias=e.normalBias,t.shadowRadius=e.radius,t.shadowMapSize=e.mapSize,i.directionalShadow[l]=t,i.directionalShadowMap[l]=b,i.directionalShadowMatrix[l]=v.shadow.matrix,p++}i.directional[l]=e,l++}else if(v.isSpotLight){const e=t.get(v);e.position.setFromMatrixPosition(v.matrixWorld),e.color.copy(_).multiplyScalar(x),e.distance=E,e.coneCos=Math.cos(v.angle),e.penumbraCos=Math.cos(v.angle*(1-v.penumbra)),e.decay=v.decay,i.spot[h]=e;const r=v.shadow;if(v.map&&(i.spotLightMap[g]=v.map,g++,r.updateMatrices(v),v.castShadow&&A++),i.spotLightMatrix[h]=r.matrix,v.castShadow){const e=n.get(v);e.shadowIntensity=r.intensity,e.shadowBias=r.bias,e.shadowNormalBias=r.normalBias,e.shadowRadius=r.radius,e.shadowMapSize=r.mapSize,i.spotShadow[h]=e,i.spotShadowMap[h]=b,m++}h++}else if(v.isRectAreaLight){const e=t.get(v);e.color.copy(_).multiplyScalar(x),e.halfWidth.set(.5*v.width,0,0),e.halfHeight.set(0,.5*v.height,0),i.rectArea[u]=e,u++}else if(v.isPointLight){const e=t.get(v);if(e.color.copy(v.color).multiplyScalar(v.intensity),e.distance=v.distance,e.decay=v.decay,v.castShadow){const e=v.shadow,t=n.get(v);t.shadowIntensity=e.intensity,t.shadowBias=e.bias,t.shadowNormalBias=e.normalBias,t.shadowRadius=e.radius,t.shadowMapSize=e.mapSize,t.shadowCameraNear=e.camera.near,t.shadowCameraFar=e.camera.far,i.pointShadow[c]=t,i.pointShadowMap[c]=b,i.pointShadowMatrix[c]=v.shadow.matrix,f++}i.point[c]=e,c++}else if(v.isHemisphereLight){const e=t.get(v);e.skyColor.copy(v.color).multiplyScalar(x),e.groundColor.copy(v.groundColor).multiplyScalar(x),i.hemi[d]=e,d++}}u>0&&(!0===e.has("OES_texture_float_linear")?(i.rectAreaLTC1=Br.LTC_FLOAT_1,i.rectAreaLTC2=Br.LTC_FLOAT_2):(i.rectAreaLTC1=Br.LTC_HALF_1,i.rectAreaLTC2=Br.LTC_HALF_2)),i.ambient[0]=s,i.ambient[1]=a,i.ambient[2]=o;const v=i.hash;v.directionalLength===l&&v.pointLength===c&&v.spotLength===h&&v.rectAreaLength===u&&v.hemiLength===d&&v.numDirectionalShadows===p&&v.numPointShadows===f&&v.numSpotShadows===m&&v.numSpotMaps===g&&v.numLightProbes===y||(i.directional.length=l,i.spot.length=h,i.rectArea.length=u,i.point.length=c,i.hemi.length=d,i.directionalShadow.length=p,i.directionalShadowMap.length=p,i.pointShadow.length=f,i.pointShadowMap.length=f,i.spotShadow.length=m,i.spotShadowMap.length=m,i.directionalShadowMatrix.length=p,i.pointShadowMatrix.length=f,i.spotLightMatrix.length=m+g-A,i.spotLightMap.length=g,i.numSpotLightShadowsWithMaps=A,i.numLightProbes=y,v.directionalLength=l,v.pointLength=c,v.spotLength=h,v.rectAreaLength=u,v.hemiLength=d,v.numDirectionalShadows=p,v.numPointShadows=f,v.numSpotShadows=m,v.numSpotMaps=g,v.numLightProbes=y,i.version=qa++)},setupView:function(e,t){let n=0,o=0,l=0,c=0,h=0;const u=t.matrixWorldInverse;for(let t=0,d=e.length;t<d;t++){const d=e[t];if(d.isDirectionalLight){const e=i.directional[n];e.direction.setFromMatrixPosition(d.matrixWorld),r.setFromMatrixPosition(d.target.matrixWorld),e.direction.sub(r),e.direction.transformDirection(u),n++}else if(d.isSpotLight){const e=i.spot[l];e.position.setFromMatrixPosition(d.matrixWorld),e.position.applyMatrix4(u),e.direction.setFromMatrixPosition(d.matrixWorld),r.setFromMatrixPosition(d.target.matrixWorld),e.direction.sub(r),e.direction.transformDirection(u),l++}else if(d.isRectAreaLight){const e=i.rectArea[c];e.position.setFromMatrixPosition(d.matrixWorld),e.position.applyMatrix4(u),a.identity(),s.copy(d.matrixWorld),s.premultiply(u),a.extractRotation(s),e.halfWidth.set(.5*d.width,0,0),e.halfHeight.set(0,.5*d.height,0),e.halfWidth.applyMatrix4(a),e.halfHeight.applyMatrix4(a),c++}else if(d.isPointLight){const e=i.point[o];e.position.setFromMatrixPosition(d.matrixWorld),e.position.applyMatrix4(u),o++}else if(d.isHemisphereLight){const e=i.hemi[h];e.direction.setFromMatrixPosition(d.matrixWorld),e.direction.transformDirection(u),h++}}},state:i}}function Xa(e){const t=new Ya(e),n=[],i=[],r={lightsArray:n,shadowsArray:i,camera:null,lights:t,transmissionRenderTarget:{}};return{init:function(e){r.camera=e,n.length=0,i.length=0},state:r,setupLights:function(){t.setup(n)},setupLightsView:function(e){t.setupView(n,e)},pushLight:function(e){n.push(e)},pushShadow:function(e){i.push(e)}}}function Ka(e){let t=new WeakMap;return{get:function(n,i=0){const r=t.get(n);let s;return void 0===r?(s=new Xa(e),t.set(n,[s])):i>=r.length?(s=new Xa(e),r.push(s)):s=r[i],s},dispose:function(){t=new WeakMap}}}class Ja extends Ri{static get type(){return"MeshDepthMaterial"}constructor(e){super(),this.isMeshDepthMaterial=!0,this.depthPacking=3200,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.setValues(e)}copy(e){return super.copy(e),this.depthPacking=e.depthPacking,this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this}}class $a extends Ri{static get type(){return"MeshDistanceMaterial"}constructor(e){super(),this.isMeshDistanceMaterial=!0,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.setValues(e)}copy(e){return super.copy(e),this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this}}function Za(e,t,n){let i=new Sr;const l=new It,c=new It,h=new $t,u=new Ja({depthPacking:3201}),d=new $a,p={},f=n.maxTextureSize,m={[r]:s,[s]:r,[a]:a},g=new hr({defines:{VSM_SAMPLES:8},uniforms:{shadow_pass:{value:null},resolution:{value:new It},radius:{value:4}},vertexShader:"void main() {\n\tgl_Position = vec4( position, 1.0 );\n}",fragmentShader:"uniform sampler2D shadow_pass;\nuniform vec2 resolution;\nuniform float radius;\n#include <packing>\nvoid main() {\n\tconst float samples = float( VSM_SAMPLES );\n\tfloat mean = 0.0;\n\tfloat squared_mean = 0.0;\n\tfloat uvStride = samples <= 1.0 ? 0.0 : 2.0 / ( samples - 1.0 );\n\tfloat uvStart = samples <= 1.0 ? 0.0 : - 1.0;\n\tfor ( float i = 0.0; i < samples; i ++ ) {\n\t\tfloat uvOffset = uvStart + i * uvStride;\n\t\t#ifdef HORIZONTAL_PASS\n\t\t\tvec2 distribution = unpackRGBATo2Half( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( uvOffset, 0.0 ) * radius ) / resolution ) );\n\t\t\tmean += distribution.x;\n\t\t\tsquared_mean += distribution.y * distribution.y + distribution.x * distribution.x;\n\t\t#else\n\t\t\tfloat depth = unpackRGBAToDepth( texture2D( shadow_pass, ( gl_FragCoord.xy + vec2( 0.0, uvOffset ) * radius ) / resolution ) );\n\t\t\tmean += depth;\n\t\t\tsquared_mean += depth * depth;\n\t\t#endif\n\t}\n\tmean = mean / samples;\n\tsquared_mean = squared_mean / samples;\n\tfloat std_dev = sqrt( squared_mean - mean * mean );\n\tgl_FragColor = pack2HalfToRGBA( vec2( mean, std_dev ) );\n}"}),A=g.clone();A.defines.HORIZONTAL_PASS=1;const y=new ji;y.setAttribute("position",new Di(new Float32Array([-1,-1,.5,3,-1,.5,-1,3,.5]),3));const v=new ir(y,g),_=this;this.enabled=!1,this.autoUpdate=!0,this.needsUpdate=!1,this.type=1;let x=this.type;function E(n,i){const r=t.update(v);g.defines.VSM_SAMPLES!==n.blurSamples&&(g.defines.VSM_SAMPLES=n.blurSamples,A.defines.VSM_SAMPLES=n.blurSamples,g.needsUpdate=!0,A.needsUpdate=!0),null===n.mapPass&&(n.mapPass=new en(l.x,l.y)),g.uniforms.shadow_pass.value=n.map.texture,g.uniforms.resolution.value=n.mapSize,g.uniforms.radius.value=n.radius,e.setRenderTarget(n.mapPass),e.clear(),e.renderBufferDirect(i,null,r,g,v,null),A.uniforms.shadow_pass.value=n.mapPass.texture,A.uniforms.resolution.value=n.mapSize,A.uniforms.radius.value=n.radius,e.setRenderTarget(n.map),e.clear(),e.renderBufferDirect(i,null,r,A,v,null)}function b(t,n,i,r){let s=null;const a=!0===i.isPointLight?t.customDistanceMaterial:t.customDepthMaterial;if(void 0!==a)s=a;else if(s=!0===i.isPointLight?d:u,e.localClippingEnabled&&!0===n.clipShadows&&Array.isArray(n.clippingPlanes)&&0!==n.clippingPlanes.length||n.displacementMap&&0!==n.displacementScale||n.alphaMap&&n.alphaTest>0||n.map&&n.alphaTest>0){const e=s.uuid,t=n.uuid;let i=p[e];void 0===i&&(i={},p[e]=i);let r=i[t];void 0===r&&(r=s.clone(),i[t]=r,n.addEventListener("dispose",M)),s=r}return s.visible=n.visible,s.wireframe=n.wireframe,s.side=3===r?null!==n.shadowSide?n.shadowSide:n.side:null!==n.shadowSide?n.shadowSide:m[n.side],s.alphaMap=n.alphaMap,s.alphaTest=n.alphaTest,s.map=n.map,s.clipShadows=n.clipShadows,s.clippingPlanes=n.clippingPlanes,s.clipIntersection=n.clipIntersection,s.displacementMap=n.displacementMap,s.displacementScale=n.displacementScale,s.displacementBias=n.displacementBias,s.wireframeLinewidth=n.wireframeLinewidth,s.linewidth=n.linewidth,!0===i.isPointLight&&!0===s.isMeshDistanceMaterial&&(e.properties.get(s).light=i),s}function w(n,r,s,a,o){if(!1===n.visible)return;if(n.layers.test(r.layers)&&(n.isMesh||n.isLine||n.isPoints)&&(n.castShadow||n.receiveShadow&&3===o)&&(!n.frustumCulled||i.intersectsObject(n))){n.modelViewMatrix.multiplyMatrices(s.matrixWorldInverse,n.matrixWorld);const i=t.update(n),l=n.material;if(Array.isArray(l)){const t=i.groups;for(let c=0,h=t.length;c<h;c++){const h=t[c],u=l[h.materialIndex];if(u&&u.visible){const t=b(n,u,a,o);n.onBeforeShadow(e,n,r,s,i,t,h),e.renderBufferDirect(s,null,i,t,n,h),n.onAfterShadow(e,n,r,s,i,t,h)}}}else if(l.visible){const t=b(n,l,a,o);n.onBeforeShadow(e,n,r,s,i,t,null),e.renderBufferDirect(s,null,i,t,n,null),n.onAfterShadow(e,n,r,s,i,t,null)}}const l=n.children;for(let e=0,t=l.length;e<t;e++)w(l[e],r,s,a,o)}function M(e){e.target.removeEventListener("dispose",M);for(const t in p){const n=p[t],i=e.target.uuid;i in n&&(n[i].dispose(),delete n[i])}}this.render=function(t,n,r){if(!1===_.enabled)return;if(!1===_.autoUpdate&&!1===_.needsUpdate)return;if(0===t.length)return;const s=e.getRenderTarget(),a=e.getActiveCubeFace(),u=e.getActiveMipmapLevel(),d=e.state;d.setBlending(o),d.buffers.color.setClear(1,1,1,1),d.buffers.depth.setTest(!0),d.setScissorTest(!1);const p=3!==x&&3===this.type,m=3===x&&3!==this.type;for(let s=0,a=t.length;s<a;s++){const a=t[s],o=a.shadow;if(void 0===o){console.warn("THREE.WebGLShadowMap:",a,"has no shadow.");continue}if(!1===o.autoUpdate&&!1===o.needsUpdate)continue;l.copy(o.mapSize);const u=o.getFrameExtents();if(l.multiply(u),c.copy(o.mapSize),(l.x>f||l.y>f)&&(l.x>f&&(c.x=Math.floor(f/u.x),l.x=c.x*u.x,o.mapSize.x=c.x),l.y>f&&(c.y=Math.floor(f/u.y),l.y=c.y*u.y,o.mapSize.y=c.y)),null===o.map||!0===p||!0===m){const e=3!==this.type?{minFilter:V,magFilter:V}:{};null!==o.map&&o.map.dispose(),o.map=new en(l.x,l.y,e),o.map.texture.name=a.name+".shadowMap",o.camera.updateProjectionMatrix()}e.setRenderTarget(o.map),e.clear();const g=o.getViewportCount();for(let e=0;e<g;e++){const t=o.getViewport(e);h.set(c.x*t.x,c.y*t.y,c.x*t.z,c.y*t.w),d.viewport(h),o.updateMatrices(a,e),i=o.getFrustum(),w(n,r,o.camera,a,this.type)}!0!==o.isPointLightShadow&&3===this.type&&E(o,r),o.needsUpdate=!1}x=this.type,_.needsUpdate=!1,e.setRenderTarget(s,a,u)}}const eo={[I]:R,[B]:6,[P]:U,[L]:D,[R]:I,[N]:B,[U]:P,[D]:L};function to(e,t){const n=new function(){let t=!1;const n=new $t;let i=null;const r=new $t(0,0,0,0);return{setMask:function(n){i===n||t||(e.colorMask(n,n,n,n),i=n)},setLocked:function(e){t=e},setClear:function(t,i,s,a,o){!0===o&&(t*=a,i*=a,s*=a),n.set(t,i,s,a),!1===r.equals(n)&&(e.clearColor(t,i,s,a),r.copy(n))},reset:function(){t=!1,i=null,r.set(-1,0,0,0)}}},i=new function(){let n=!1,i=!1,r=null,s=null,a=null;return{setReversed:function(e){if(i!==e){const e=t.get("EXT_clip_control");i?e.clipControlEXT(e.LOWER_LEFT_EXT,e.ZERO_TO_ONE_EXT):e.clipControlEXT(e.LOWER_LEFT_EXT,e.NEGATIVE_ONE_TO_ONE_EXT);const n=a;a=null,this.setClear(n)}i=e},getReversed:function(){return i},setTest:function(t){t?Ae(e.DEPTH_TEST):ye(e.DEPTH_TEST)},setMask:function(t){r===t||n||(e.depthMask(t),r=t)},setFunc:function(t){if(i&&(t=eo[t]),s!==t){switch(t){case I:e.depthFunc(e.NEVER);break;case R:e.depthFunc(e.ALWAYS);break;case B:e.depthFunc(e.LESS);break;case L:e.depthFunc(e.LEQUAL);break;case P:e.depthFunc(e.EQUAL);break;case D:e.depthFunc(e.GEQUAL);break;case 6:e.depthFunc(e.GREATER);break;case U:e.depthFunc(e.NOTEQUAL);break;default:e.depthFunc(e.LEQUAL)}s=t}},setLocked:function(e){n=e},setClear:function(t){a!==t&&(i&&(t=1-t),e.clearDepth(t),a=t)},reset:function(){n=!1,r=null,s=null,a=null,i=!1}}},r=new function(){let t=!1,n=null,i=null,r=null,s=null,a=null,o=null,l=null,c=null;return{setTest:function(n){t||(n?Ae(e.STENCIL_TEST):ye(e.STENCIL_TEST))},setMask:function(i){n===i||t||(e.stencilMask(i),n=i)},setFunc:function(t,n,a){i===t&&r===n&&s===a||(e.stencilFunc(t,n,a),i=t,r=n,s=a)},setOp:function(t,n,i){a===t&&o===n&&l===i||(e.stencilOp(t,n,i),a=t,o=n,l=i)},setLocked:function(e){t=e},setClear:function(t){c!==t&&(e.clearStencil(t),c=t)},reset:function(){t=!1,n=null,i=null,r=null,s=null,a=null,o=null,l=null,c=null}}},N=new WeakMap,O=new WeakMap;let F={},k={},Q=new WeakMap,z=[],G=null,H=!1,V=null,j=null,q=null,W=null,Y=null,X=null,K=null,J=new Ci(0,0,0),$=0,Z=!1,ee=null,te=null,ne=null,ie=null,re=null;const se=e.getParameter(e.MAX_COMBINED_TEXTURE_IMAGE_UNITS);let ae=!1,oe=0;const le=e.getParameter(e.VERSION);-1!==le.indexOf("WebGL")?(oe=parseFloat(/^WebGL (\d)/.exec(le)[1]),ae=oe>=1):-1!==le.indexOf("OpenGL ES")&&(oe=parseFloat(/^OpenGL ES (\d)/.exec(le)[1]),ae=oe>=2);let ce=null,he={};const ue=e.getParameter(e.SCISSOR_BOX),de=e.getParameter(e.VIEWPORT),pe=(new $t).fromArray(ue),fe=(new $t).fromArray(de);function me(t,n,i,r){const s=new Uint8Array(4),a=e.createTexture();e.bindTexture(t,a),e.texParameteri(t,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(t,e.TEXTURE_MAG_FILTER,e.NEAREST);for(let a=0;a<i;a++)t===e.TEXTURE_3D||t===e.TEXTURE_2D_ARRAY?e.texImage3D(n,0,e.RGBA,1,1,r,0,e.RGBA,e.UNSIGNED_BYTE,s):e.texImage2D(n+a,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,s);return a}const ge={};function Ae(t){!0!==F[t]&&(e.enable(t),F[t]=!0)}function ye(t){!1!==F[t]&&(e.disable(t),F[t]=!1)}ge[e.TEXTURE_2D]=me(e.TEXTURE_2D,e.TEXTURE_2D,1),ge[e.TEXTURE_CUBE_MAP]=me(e.TEXTURE_CUBE_MAP,e.TEXTURE_CUBE_MAP_POSITIVE_X,6),ge[e.TEXTURE_2D_ARRAY]=me(e.TEXTURE_2D_ARRAY,e.TEXTURE_2D_ARRAY,1,1),ge[e.TEXTURE_3D]=me(e.TEXTURE_3D,e.TEXTURE_3D,1,1),n.setClear(0,0,0,1),i.setClear(1),r.setClear(0),Ae(e.DEPTH_TEST),i.setFunc(L),Ee(!1),be(1),Ae(e.CULL_FACE),xe(o);const ve={[u]:e.FUNC_ADD,[d]:e.FUNC_SUBTRACT,[p]:e.FUNC_REVERSE_SUBTRACT};ve[103]=e.MIN,ve[104]=e.MAX;const _e={[f]:e.ZERO,[m]:e.ONE,[g]:e.SRC_COLOR,[y]:e.SRC_ALPHA,[w]:e.SRC_ALPHA_SATURATE,[E]:e.DST_COLOR,[_]:e.DST_ALPHA,[A]:e.ONE_MINUS_SRC_COLOR,[v]:e.ONE_MINUS_SRC_ALPHA,[b]:e.ONE_MINUS_DST_COLOR,[x]:e.ONE_MINUS_DST_ALPHA,[M]:e.CONSTANT_COLOR,[S]:e.ONE_MINUS_CONSTANT_COLOR,[C]:e.CONSTANT_ALPHA,[T]:e.ONE_MINUS_CONSTANT_ALPHA};function xe(t,n,i,r,s,a,d,p,f,m){if(t!==o){if(!1===H&&(Ae(e.BLEND),H=!0),t===h)s=s||n,a=a||i,d=d||r,n===j&&s===Y||(e.blendEquationSeparate(ve[n],ve[s]),j=n,Y=s),i===q&&r===W&&a===X&&d===K||(e.blendFuncSeparate(_e[i],_e[r],_e[a],_e[d]),q=i,W=r,X=a,K=d),!1!==p.equals(J)&&f===$||(e.blendColor(p.r,p.g,p.b,f),J.copy(p),$=f),V=t,Z=!1;else if(t!==V||m!==Z){if(j===u&&Y===u||(e.blendEquation(e.FUNC_ADD),j=u,Y=u),m)switch(t){case l:e.blendFuncSeparate(e.ONE,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA);break;case c:e.blendFunc(e.ONE,e.ONE);break;case 3:e.blendFuncSeparate(e.ZERO,e.ONE_MINUS_SRC_COLOR,e.ZERO,e.ONE);break;case 4:e.blendFuncSeparate(e.ZERO,e.SRC_COLOR,e.ZERO,e.SRC_ALPHA);break;default:console.error("THREE.WebGLState: Invalid blending: ",t)}else switch(t){case l:e.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA);break;case c:e.blendFunc(e.SRC_ALPHA,e.ONE);break;case 3:e.blendFuncSeparate(e.ZERO,e.ONE_MINUS_SRC_COLOR,e.ZERO,e.ONE);break;case 4:e.blendFunc(e.ZERO,e.SRC_COLOR);break;default:console.error("THREE.WebGLState: Invalid blending: ",t)}q=null,W=null,X=null,K=null,J.set(0,0,0),$=0,V=t,Z=m}}else!0===H&&(ye(e.BLEND),H=!1)}function Ee(t){ee!==t&&(t?e.frontFace(e.CW):e.frontFace(e.CCW),ee=t)}function be(t){0!==t?(Ae(e.CULL_FACE),t!==te&&(1===t?e.cullFace(e.BACK):2===t?e.cullFace(e.FRONT):e.cullFace(e.FRONT_AND_BACK))):ye(e.CULL_FACE),te=t}function we(t,n,i){t?(Ae(e.POLYGON_OFFSET_FILL),ie===n&&re===i||(e.polygonOffset(n,i),ie=n,re=i)):ye(e.POLYGON_OFFSET_FILL)}return{buffers:{color:n,depth:i,stencil:r},enable:Ae,disable:ye,bindFramebuffer:function(t,n){return k[t]!==n&&(e.bindFramebuffer(t,n),k[t]=n,t===e.DRAW_FRAMEBUFFER&&(k[e.FRAMEBUFFER]=n),t===e.FRAMEBUFFER&&(k[e.DRAW_FRAMEBUFFER]=n),!0)},drawBuffers:function(t,n){let i=z,r=!1;if(t){i=Q.get(n),void 0===i&&(i=[],Q.set(n,i));const s=t.textures;if(i.length!==s.length||i[0]!==e.COLOR_ATTACHMENT0){for(let t=0,n=s.length;t<n;t++)i[t]=e.COLOR_ATTACHMENT0+t;i.length=s.length,r=!0}}else i[0]!==e.BACK&&(i[0]=e.BACK,r=!0);r&&e.drawBuffers(i)},useProgram:function(t){return G!==t&&(e.useProgram(t),G=t,!0)},setBlending:xe,setMaterial:function(t,c){t.side===a?ye(e.CULL_FACE):Ae(e.CULL_FACE);let h=t.side===s;c&&(h=!h),Ee(h),t.blending===l&&!1===t.transparent?xe(o):xe(t.blending,t.blendEquation,t.blendSrc,t.blendDst,t.blendEquationAlpha,t.blendSrcAlpha,t.blendDstAlpha,t.blendColor,t.blendAlpha,t.premultipliedAlpha),i.setFunc(t.depthFunc),i.setTest(t.depthTest),i.setMask(t.depthWrite),n.setMask(t.colorWrite);const u=t.stencilWrite;r.setTest(u),u&&(r.setMask(t.stencilWriteMask),r.setFunc(t.stencilFunc,t.stencilRef,t.stencilFuncMask),r.setOp(t.stencilFail,t.stencilZFail,t.stencilZPass)),we(t.polygonOffset,t.polygonOffsetFactor,t.polygonOffsetUnits),!0===t.alphaToCoverage?Ae(e.SAMPLE_ALPHA_TO_COVERAGE):ye(e.SAMPLE_ALPHA_TO_COVERAGE)},setFlipSided:Ee,setCullFace:be,setLineWidth:function(t){t!==ne&&(ae&&e.lineWidth(t),ne=t)},setPolygonOffset:we,setScissorTest:function(t){t?Ae(e.SCISSOR_TEST):ye(e.SCISSOR_TEST)},activeTexture:function(t){void 0===t&&(t=e.TEXTURE0+se-1),ce!==t&&(e.activeTexture(t),ce=t)},bindTexture:function(t,n,i){void 0===i&&(i=null===ce?e.TEXTURE0+se-1:ce);let r=he[i];void 0===r&&(r={type:void 0,texture:void 0},he[i]=r),r.type===t&&r.texture===n||(ce!==i&&(e.activeTexture(i),ce=i),e.bindTexture(t,n||ge[t]),r.type=t,r.texture=n)},unbindTexture:function(){const t=he[ce];void 0!==t&&void 0!==t.type&&(e.bindTexture(t.type,null),t.type=void 0,t.texture=void 0)},compressedTexImage2D:function(){try{e.compressedTexImage2D.apply(e,arguments)}catch(e){console.error("THREE.WebGLState:",e)}},compressedTexImage3D:function(){try{e.compressedTexImage3D.apply(e,arguments)}catch(e){console.error("THREE.WebGLState:",e)}},texImage2D:function(){try{e.texImage2D.apply(e,arguments)}catch(e){console.error("THREE.WebGLState:",e)}},texImage3D:function(){try{e.texImage3D.apply(e,arguments)}catch(e){console.error("THREE.WebGLState:",e)}},updateUBOMapping:function(t,n){let i=O.get(n);void 0===i&&(i=new WeakMap,O.set(n,i));let r=i.get(t);void 0===r&&(r=e.getUniformBlockIndex(n,t.name),i.set(t,r))},uniformBlockBinding:function(t,n){const i=O.get(n).get(t);N.get(n)!==i&&(e.uniformBlockBinding(n,i,t.__bindingPointIndex),N.set(n,i))},texStorage2D:function(){try{e.texStorage2D.apply(e,arguments)}catch(e){console.error("THREE.WebGLState:",e)}},texStorage3D:function(){try{e.texStorage3D.apply(e,arguments)}catch(e){console.error("THREE.WebGLState:",e)}},texSubImage2D:function(){try{e.texSubImage2D.apply(e,arguments)}catch(e){console.error("THREE.WebGLState:",e)}},texSubImage3D:function(){try{e.texSubImage3D.apply(e,arguments)}catch(e){console.error("THREE.WebGLState:",e)}},compressedTexSubImage2D:function(){try{e.compressedTexSubImage2D.apply(e,arguments)}catch(e){console.error("THREE.WebGLState:",e)}},compressedTexSubImage3D:function(){try{e.compressedTexSubImage3D.apply(e,arguments)}catch(e){console.error("THREE.WebGLState:",e)}},scissor:function(t){!1===pe.equals(t)&&(e.scissor(t.x,t.y,t.z,t.w),pe.copy(t))},viewport:function(t){!1===fe.equals(t)&&(e.viewport(t.x,t.y,t.z,t.w),fe.copy(t))},reset:function(){e.disable(e.BLEND),e.disable(e.CULL_FACE),e.disable(e.DEPTH_TEST),e.disable(e.POLYGON_OFFSET_FILL),e.disable(e.SCISSOR_TEST),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.blendEquation(e.FUNC_ADD),e.blendFunc(e.ONE,e.ZERO),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.blendColor(0,0,0,0),e.colorMask(!0,!0,!0,!0),e.clearColor(0,0,0,0),e.depthMask(!0),e.depthFunc(e.LESS),i.setReversed(!1),e.clearDepth(1),e.stencilMask(4294967295),e.stencilFunc(e.ALWAYS,0,4294967295),e.stencilOp(e.KEEP,e.KEEP,e.KEEP),e.clearStencil(0),e.cullFace(e.BACK),e.frontFace(e.CCW),e.polygonOffset(0,0),e.activeTexture(e.TEXTURE0),e.bindFramebuffer(e.FRAMEBUFFER,null),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,null),e.bindFramebuffer(e.READ_FRAMEBUFFER,null),e.useProgram(null),e.lineWidth(1),e.scissor(0,0,e.canvas.width,e.canvas.height),e.viewport(0,0,e.canvas.width,e.canvas.height),F={},ce=null,he={},k={},Q=new WeakMap,z=[],G=null,H=!1,V=null,j=null,q=null,W=null,Y=null,X=null,K=null,J=new Ci(0,0,0),$=0,Z=!1,ee=null,te=null,ne=null,ie=null,re=null,pe.set(0,0,e.canvas.width,e.canvas.height),fe.set(0,0,e.canvas.width,e.canvas.height),n.reset(),i.reset(),r.reset()}}}function no(e,t,n,i){const r=function(e){switch(e){case K:case 1010:return{byteLength:1,components:1};case J:case 1011:case te:return{byteLength:2,components:1};case ne:case ie:return{byteLength:2,components:4};case Z:case $:case ee:return{byteLength:4,components:1};case 35902:return{byteLength:4,components:3}}throw new Error(`Unknown texture type ${e}.`)}(i);switch(n){case se:case oe:return e*t;case le:return e*t*2;case ue:case de:return e*t/r.components*r.byteLength;case pe:case fe:return e*t*2/r.components*r.byteLength;case 1022:return e*t*3/r.components*r.byteLength;case ae:case me:return e*t*4/r.components*r.byteLength;case ge:case Ae:return Math.floor((e+3)/4)*Math.floor((t+3)/4)*8;case ye:case ve:return Math.floor((e+3)/4)*Math.floor((t+3)/4)*16;case xe:case be:return Math.max(e,16)*Math.max(t,8)/4;case _e:case Ee:return Math.max(e,8)*Math.max(t,8)/2;case we:case Me:return Math.floor((e+3)/4)*Math.floor((t+3)/4)*8;case Se:case Ce:return Math.floor((e+3)/4)*Math.floor((t+3)/4)*16;case Te:return Math.floor((e+4)/5)*Math.floor((t+3)/4)*16;case Ie:return Math.floor((e+4)/5)*Math.floor((t+4)/5)*16;case Re:return Math.floor((e+5)/6)*Math.floor((t+4)/5)*16;case Be:return Math.floor((e+5)/6)*Math.floor((t+5)/6)*16;case Le:return Math.floor((e+7)/8)*Math.floor((t+4)/5)*16;case Pe:return Math.floor((e+7)/8)*Math.floor((t+5)/6)*16;case De:return Math.floor((e+7)/8)*Math.floor((t+7)/8)*16;case Ne:return Math.floor((e+9)/10)*Math.floor((t+4)/5)*16;case Ue:return Math.floor((e+9)/10)*Math.floor((t+5)/6)*16;case Oe:return Math.floor((e+9)/10)*Math.floor((t+7)/8)*16;case Fe:return Math.floor((e+9)/10)*Math.floor((t+9)/10)*16;case ke:return Math.floor((e+11)/12)*Math.floor((t+9)/10)*16;case Qe:return Math.floor((e+11)/12)*Math.floor((t+11)/12)*16;case ze:case Ge:case He:return Math.ceil(e/4)*Math.ceil(t/4)*16;case 36283:case Ve:return Math.ceil(e/4)*Math.ceil(t/4)*8;case je:case qe:return Math.ceil(e/4)*Math.ceil(t/4)*16}throw new Error(`Unable to determine texture byte length for ${n} format.`)}const io={contain:function(e,t){const n=e.image&&e.image.width?e.image.width/e.image.height:1;return n>t?(e.repeat.x=1,e.repeat.y=n/t,e.offset.x=0,e.offset.y=(1-e.repeat.y)/2):(e.repeat.x=t/n,e.repeat.y=1,e.offset.x=(1-e.repeat.x)/2,e.offset.y=0),e},cover:function(e,t){const n=e.image&&e.image.width?e.image.width/e.image.height:1;return n>t?(e.repeat.x=t/n,e.repeat.y=1,e.offset.x=(1-e.repeat.x)/2,e.offset.y=0):(e.repeat.x=1,e.repeat.y=n/t,e.offset.x=0,e.offset.y=(1-e.repeat.y)/2),e},fill:function(e){return e.repeat.x=1,e.repeat.y=1,e.offset.x=0,e.offset.y=0,e},getByteLength:no};function ro(e,t,n,i,r,s,a){const o=t.has("WEBGL_multisampled_render_to_texture")?t.get("WEBGL_multisampled_render_to_texture"):null,l="undefined"!=typeof navigator&&/OculusBrowser/g.test(navigator.userAgent),c=new It,h=new WeakMap;let u;const d=new WeakMap;let p=!1;try{p="undefined"!=typeof OffscreenCanvas&&null!==new OffscreenCanvas(1,1).getContext("2d")}catch(e){}function f(e,t){return p?new OffscreenCanvas(e,t):Pt("canvas")}function m(e,t,n){let i=1;const r=$(e);if((r.width>n||r.height>n)&&(i=n/Math.max(r.width,r.height)),i<1){if("undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap||"undefined"!=typeof VideoFrame&&e instanceof VideoFrame){const n=Math.floor(i*r.width),s=Math.floor(i*r.height);void 0===u&&(u=f(n,s));const a=t?f(n,s):u;return a.width=n,a.height=s,a.getContext("2d").drawImage(e,0,0,n,s),console.warn("THREE.WebGLRenderer: Texture has been resized from ("+r.width+"x"+r.height+") to ("+n+"x"+s+")."),a}return"data"in e&&console.warn("THREE.WebGLRenderer: Image in DataTexture is too big ("+r.width+"x"+r.height+")."),e}return e}function g(e){return e.generateMipmaps}function A(t){e.generateMipmap(t)}function y(t){return t.isWebGLCubeRenderTarget?e.TEXTURE_CUBE_MAP:t.isWebGL3DRenderTarget?e.TEXTURE_3D:t.isWebGLArrayRenderTarget||t.isCompressedArrayTexture?e.TEXTURE_2D_ARRAY:e.TEXTURE_2D}function v(n,i,r,s,a=!1){if(null!==n){if(void 0!==e[n])return e[n];console.warn("THREE.WebGLRenderer: Attempt to use non-existing WebGL internal format '"+n+"'")}let o=i;if(i===e.RED&&(r===e.FLOAT&&(o=e.R32F),r===e.HALF_FLOAT&&(o=e.R16F),r===e.UNSIGNED_BYTE&&(o=e.R8)),i===e.RED_INTEGER&&(r===e.UNSIGNED_BYTE&&(o=e.R8UI),r===e.UNSIGNED_SHORT&&(o=e.R16UI),r===e.UNSIGNED_INT&&(o=e.R32UI),r===e.BYTE&&(o=e.R8I),r===e.SHORT&&(o=e.R16I),r===e.INT&&(o=e.R32I)),i===e.RG&&(r===e.FLOAT&&(o=e.RG32F),r===e.HALF_FLOAT&&(o=e.RG16F),r===e.UNSIGNED_BYTE&&(o=e.RG8)),i===e.RG_INTEGER&&(r===e.UNSIGNED_BYTE&&(o=e.RG8UI),r===e.UNSIGNED_SHORT&&(o=e.RG16UI),r===e.UNSIGNED_INT&&(o=e.RG32UI),r===e.BYTE&&(o=e.RG8I),r===e.SHORT&&(o=e.RG16I),r===e.INT&&(o=e.RG32I)),i===e.RGB_INTEGER&&(r===e.UNSIGNED_BYTE&&(o=e.RGB8UI),r===e.UNSIGNED_SHORT&&(o=e.RGB16UI),r===e.UNSIGNED_INT&&(o=e.RGB32UI),r===e.BYTE&&(o=e.RGB8I),r===e.SHORT&&(o=e.RGB16I),r===e.INT&&(o=e.RGB32I)),i===e.RGBA_INTEGER&&(r===e.UNSIGNED_BYTE&&(o=e.RGBA8UI),r===e.UNSIGNED_SHORT&&(o=e.RGBA16UI),r===e.UNSIGNED_INT&&(o=e.RGBA32UI),r===e.BYTE&&(o=e.RGBA8I),r===e.SHORT&&(o=e.RGBA16I),r===e.INT&&(o=e.RGBA32I)),i===e.RGB&&r===e.UNSIGNED_INT_5_9_9_9_REV&&(o=e.RGB9_E5),i===e.RGBA){const t=a?nt:Ot.getTransfer(s);r===e.FLOAT&&(o=e.RGBA32F),r===e.HALF_FLOAT&&(o=e.RGBA16F),r===e.UNSIGNED_BYTE&&(o=t===it?e.SRGB8_ALPHA8:e.RGBA8),r===e.UNSIGNED_SHORT_4_4_4_4&&(o=e.RGBA4),r===e.UNSIGNED_SHORT_5_5_5_1&&(o=e.RGB5_A1)}return o!==e.R16F&&o!==e.R32F&&o!==e.RG16F&&o!==e.RG32F&&o!==e.RGBA16F&&o!==e.RGBA32F||t.get("EXT_color_buffer_float"),o}function _(t,n){let i;return t?null===n||n===Z||n===re?i=e.DEPTH24_STENCIL8:n===ee?i=e.DEPTH32F_STENCIL8:n===J&&(i=e.DEPTH24_STENCIL8,console.warn("DepthTexture: 16 bit depth attachment is not supported with stencil. Using 24-bit attachment.")):null===n||n===Z||n===re?i=e.DEPTH_COMPONENT24:n===ee?i=e.DEPTH_COMPONENT32F:n===J&&(i=e.DEPTH_COMPONENT16),i}function x(e,t){return!0===g(e)||e.isFramebufferTexture&&e.minFilter!==V&&e.minFilter!==W?Math.log2(Math.max(t.width,t.height))+1:void 0!==e.mipmaps&&e.mipmaps.length>0?e.mipmaps.length:e.isCompressedTexture&&Array.isArray(e.image)?t.mipmaps.length:1}function E(e){const t=e.target;t.removeEventListener("dispose",E),function(e){const t=i.get(e);if(void 0===t.__webglInit)return;const n=e.source,r=d.get(n);if(r){const i=r[t.__cacheKey];i.usedTimes--,0===i.usedTimes&&w(e),0===Object.keys(r).length&&d.delete(n)}i.remove(e)}(t),t.isVideoTexture&&h.delete(t)}function b(t){const n=t.target;n.removeEventListener("dispose",b),function(t){const n=i.get(t);if(t.depthTexture&&(t.depthTexture.dispose(),i.remove(t.depthTexture)),t.isWebGLCubeRenderTarget)for(let t=0;t<6;t++){if(Array.isArray(n.__webglFramebuffer[t]))for(let i=0;i<n.__webglFramebuffer[t].length;i++)e.deleteFramebuffer(n.__webglFramebuffer[t][i]);else e.deleteFramebuffer(n.__webglFramebuffer[t]);n.__webglDepthbuffer&&e.deleteRenderbuffer(n.__webglDepthbuffer[t])}else{if(Array.isArray(n.__webglFramebuffer))for(let t=0;t<n.__webglFramebuffer.length;t++)e.deleteFramebuffer(n.__webglFramebuffer[t]);else e.deleteFramebuffer(n.__webglFramebuffer);if(n.__webglDepthbuffer&&e.deleteRenderbuffer(n.__webglDepthbuffer),n.__webglMultisampledFramebuffer&&e.deleteFramebuffer(n.__webglMultisampledFramebuffer),n.__webglColorRenderbuffer)for(let t=0;t<n.__webglColorRenderbuffer.length;t++)n.__webglColorRenderbuffer[t]&&e.deleteRenderbuffer(n.__webglColorRenderbuffer[t]);n.__webglDepthRenderbuffer&&e.deleteRenderbuffer(n.__webglDepthRenderbuffer)}const r=t.textures;for(let t=0,n=r.length;t<n;t++){const n=i.get(r[t]);n.__webglTexture&&(e.deleteTexture(n.__webglTexture),a.memory.textures--),i.remove(r[t])}i.remove(t)}(n)}function w(t){const n=i.get(t);e.deleteTexture(n.__webglTexture);const r=t.source;delete d.get(r)[n.__cacheKey],a.memory.textures--}let M=0;function S(t,r){const s=i.get(t);if(t.isVideoTexture&&function(e){const t=a.render.frame;h.get(e)!==t&&(h.set(e,t),e.update())}(t),!1===t.isRenderTargetTexture&&t.version>0&&s.__version!==t.version){const e=t.image;if(null===e)console.warn("THREE.WebGLRenderer: Texture marked for update but no image data found.");else{if(!1!==e.complete)return void L(s,t,r);console.warn("THREE.WebGLRenderer: Texture marked for update but image is incomplete")}}n.bindTexture(e.TEXTURE_2D,s.__webglTexture,e.TEXTURE0+r)}const C={[z]:e.REPEAT,[G]:e.CLAMP_TO_EDGE,[H]:e.MIRRORED_REPEAT},T={[V]:e.NEAREST,[j]:e.NEAREST_MIPMAP_NEAREST,[q]:e.NEAREST_MIPMAP_LINEAR,[W]:e.LINEAR,[Y]:e.LINEAR_MIPMAP_NEAREST,[X]:e.LINEAR_MIPMAP_LINEAR},I={[st]:e.NEVER,[dt]:e.ALWAYS,[at]:e.LESS,[lt]:e.LEQUAL,[ot]:e.EQUAL,[ut]:e.GEQUAL,[ct]:e.GREATER,[ht]:e.NOTEQUAL};function R(n,s){if(s.type!==ee||!1!==t.has("OES_texture_float_linear")||s.magFilter!==W&&s.magFilter!==Y&&s.magFilter!==q&&s.magFilter!==X&&s.minFilter!==W&&s.minFilter!==Y&&s.minFilter!==q&&s.minFilter!==X||console.warn("THREE.WebGLRenderer: Unable to use linear filtering with floating point textures. OES_texture_float_linear not supported on this device."),e.texParameteri(n,e.TEXTURE_WRAP_S,C[s.wrapS]),e.texParameteri(n,e.TEXTURE_WRAP_T,C[s.wrapT]),n!==e.TEXTURE_3D&&n!==e.TEXTURE_2D_ARRAY||e.texParameteri(n,e.TEXTURE_WRAP_R,C[s.wrapR]),e.texParameteri(n,e.TEXTURE_MAG_FILTER,T[s.magFilter]),e.texParameteri(n,e.TEXTURE_MIN_FILTER,T[s.minFilter]),s.compareFunction&&(e.texParameteri(n,e.TEXTURE_COMPARE_MODE,e.COMPARE_REF_TO_TEXTURE),e.texParameteri(n,e.TEXTURE_COMPARE_FUNC,I[s.compareFunction])),!0===t.has("EXT_texture_filter_anisotropic")){if(s.magFilter===V)return;if(s.minFilter!==q&&s.minFilter!==X)return;if(s.type===ee&&!1===t.has("OES_texture_float_linear"))return;if(s.anisotropy>1||i.get(s).__currentAnisotropy){const a=t.get("EXT_texture_filter_anisotropic");e.texParameterf(n,a.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(s.anisotropy,r.getMaxAnisotropy())),i.get(s).__currentAnisotropy=s.anisotropy}}}function B(t,n){let i=!1;void 0===t.__webglInit&&(t.__webglInit=!0,n.addEventListener("dispose",E));const r=n.source;let s=d.get(r);void 0===s&&(s={},d.set(r,s));const o=function(e){const t=[];return t.push(e.wrapS),t.push(e.wrapT),t.push(e.wrapR||0),t.push(e.magFilter),t.push(e.minFilter),t.push(e.anisotropy),t.push(e.internalFormat),t.push(e.format),t.push(e.type),t.push(e.generateMipmaps),t.push(e.premultiplyAlpha),t.push(e.flipY),t.push(e.unpackAlignment),t.push(e.colorSpace),t.join()}(n);if(o!==t.__cacheKey){void 0===s[o]&&(s[o]={texture:e.createTexture(),usedTimes:0},a.memory.textures++,i=!0),s[o].usedTimes++;const r=s[t.__cacheKey];void 0!==r&&(s[t.__cacheKey].usedTimes--,0===r.usedTimes&&w(n)),t.__cacheKey=o,t.__webglTexture=s[o].texture}return i}function L(t,a,o){let l=e.TEXTURE_2D;(a.isDataArrayTexture||a.isCompressedArrayTexture)&&(l=e.TEXTURE_2D_ARRAY),a.isData3DTexture&&(l=e.TEXTURE_3D);const c=B(t,a),h=a.source;n.bindTexture(l,t.__webglTexture,e.TEXTURE0+o);const u=i.get(h);if(h.version!==u.__version||!0===c){n.activeTexture(e.TEXTURE0+o);const t=Ot.getPrimaries(Ot.workingColorSpace),i=a.colorSpace===Ze?null:Ot.getPrimaries(a.colorSpace),d=a.colorSpace===Ze||t===i?e.NONE:e.BROWSER_DEFAULT_WEBGL;e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,a.flipY),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,a.premultiplyAlpha),e.pixelStorei(e.UNPACK_ALIGNMENT,a.unpackAlignment),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,d);let p=m(a.image,!1,r.maxTextureSize);p=Q(a,p);const f=s.convert(a.format,a.colorSpace),y=s.convert(a.type);let E,b=v(a.internalFormat,f,y,a.colorSpace,a.isVideoTexture);R(l,a);const w=a.mipmaps,M=!0!==a.isVideoTexture,S=void 0===u.__version||!0===c,C=h.dataReady,T=x(a,p);if(a.isDepthTexture)b=_(a.format===he,a.type),S&&(M?n.texStorage2D(e.TEXTURE_2D,1,b,p.width,p.height):n.texImage2D(e.TEXTURE_2D,0,b,p.width,p.height,0,f,y,null));else if(a.isDataTexture)if(w.length>0){M&&S&&n.texStorage2D(e.TEXTURE_2D,T,b,w[0].width,w[0].height);for(let t=0,i=w.length;t<i;t++)E=w[t],M?C&&n.texSubImage2D(e.TEXTURE_2D,t,0,0,E.width,E.height,f,y,E.data):n.texImage2D(e.TEXTURE_2D,t,b,E.width,E.height,0,f,y,E.data);a.generateMipmaps=!1}else M?(S&&n.texStorage2D(e.TEXTURE_2D,T,b,p.width,p.height),C&&n.texSubImage2D(e.TEXTURE_2D,0,0,0,p.width,p.height,f,y,p.data)):n.texImage2D(e.TEXTURE_2D,0,b,p.width,p.height,0,f,y,p.data);else if(a.isCompressedTexture)if(a.isCompressedArrayTexture){M&&S&&n.texStorage3D(e.TEXTURE_2D_ARRAY,T,b,w[0].width,w[0].height,p.depth);for(let t=0,i=w.length;t<i;t++)if(E=w[t],a.format!==ae)if(null!==f)if(M){if(C)if(a.layerUpdates.size>0){const i=no(E.width,E.height,a.format,a.type);for(const r of a.layerUpdates){const s=E.data.subarray(r*i/E.data.BYTES_PER_ELEMENT,(r+1)*i/E.data.BYTES_PER_ELEMENT);n.compressedTexSubImage3D(e.TEXTURE_2D_ARRAY,t,0,0,r,E.width,E.height,1,f,s)}a.clearLayerUpdates()}else n.compressedTexSubImage3D(e.TEXTURE_2D_ARRAY,t,0,0,0,E.width,E.height,p.depth,f,E.data)}else n.compressedTexImage3D(e.TEXTURE_2D_ARRAY,t,b,E.width,E.height,p.depth,0,E.data,0,0);else console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()");else M?C&&n.texSubImage3D(e.TEXTURE_2D_ARRAY,t,0,0,0,E.width,E.height,p.depth,f,y,E.data):n.texImage3D(e.TEXTURE_2D_ARRAY,t,b,E.width,E.height,p.depth,0,f,y,E.data)}else{M&&S&&n.texStorage2D(e.TEXTURE_2D,T,b,w[0].width,w[0].height);for(let t=0,i=w.length;t<i;t++)E=w[t],a.format!==ae?null!==f?M?C&&n.compressedTexSubImage2D(e.TEXTURE_2D,t,0,0,E.width,E.height,f,E.data):n.compressedTexImage2D(e.TEXTURE_2D,t,b,E.width,E.height,0,E.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()"):M?C&&n.texSubImage2D(e.TEXTURE_2D,t,0,0,E.width,E.height,f,y,E.data):n.texImage2D(e.TEXTURE_2D,t,b,E.width,E.height,0,f,y,E.data)}else if(a.isDataArrayTexture)if(M){if(S&&n.texStorage3D(e.TEXTURE_2D_ARRAY,T,b,p.width,p.height,p.depth),C)if(a.layerUpdates.size>0){const t=no(p.width,p.height,a.format,a.type);for(const i of a.layerUpdates){const r=p.data.subarray(i*t/p.data.BYTES_PER_ELEMENT,(i+1)*t/p.data.BYTES_PER_ELEMENT);n.texSubImage3D(e.TEXTURE_2D_ARRAY,0,0,0,i,p.width,p.height,1,f,y,r)}a.clearLayerUpdates()}else n.texSubImage3D(e.TEXTURE_2D_ARRAY,0,0,0,0,p.width,p.height,p.depth,f,y,p.data)}else n.texImage3D(e.TEXTURE_2D_ARRAY,0,b,p.width,p.height,p.depth,0,f,y,p.data);else if(a.isData3DTexture)M?(S&&n.texStorage3D(e.TEXTURE_3D,T,b,p.width,p.height,p.depth),C&&n.texSubImage3D(e.TEXTURE_3D,0,0,0,0,p.width,p.height,p.depth,f,y,p.data)):n.texImage3D(e.TEXTURE_3D,0,b,p.width,p.height,p.depth,0,f,y,p.data);else if(a.isFramebufferTexture){if(S)if(M)n.texStorage2D(e.TEXTURE_2D,T,b,p.width,p.height);else{let t=p.width,i=p.height;for(let r=0;r<T;r++)n.texImage2D(e.TEXTURE_2D,r,b,t,i,0,f,y,null),t>>=1,i>>=1}}else if(w.length>0){if(M&&S){const t=$(w[0]);n.texStorage2D(e.TEXTURE_2D,T,b,t.width,t.height)}for(let t=0,i=w.length;t<i;t++)E=w[t],M?C&&n.texSubImage2D(e.TEXTURE_2D,t,0,0,f,y,E):n.texImage2D(e.TEXTURE_2D,t,b,f,y,E);a.generateMipmaps=!1}else if(M){if(S){const t=$(p);n.texStorage2D(e.TEXTURE_2D,T,b,t.width,t.height)}C&&n.texSubImage2D(e.TEXTURE_2D,0,0,0,f,y,p)}else n.texImage2D(e.TEXTURE_2D,0,b,f,y,p);g(a)&&A(l),u.__version=h.version,a.onUpdate&&a.onUpdate(a)}t.__version=a.version}function P(t,r,a,l,c,h){const u=s.convert(a.format,a.colorSpace),d=s.convert(a.type),p=v(a.internalFormat,u,d,a.colorSpace),f=i.get(r),m=i.get(a);if(m.__renderTarget=r,!f.__hasExternalTextures){const t=Math.max(1,r.width>>h),i=Math.max(1,r.height>>h);c===e.TEXTURE_3D||c===e.TEXTURE_2D_ARRAY?n.texImage3D(c,h,p,t,i,r.depth,0,u,d,null):n.texImage2D(c,h,p,t,i,0,u,d,null)}n.bindFramebuffer(e.FRAMEBUFFER,t),k(r)?o.framebufferTexture2DMultisampleEXT(e.FRAMEBUFFER,l,c,m.__webglTexture,0,F(r)):(c===e.TEXTURE_2D||c>=e.TEXTURE_CUBE_MAP_POSITIVE_X&&c<=e.TEXTURE_CUBE_MAP_NEGATIVE_Z)&&e.framebufferTexture2D(e.FRAMEBUFFER,l,c,m.__webglTexture,h),n.bindFramebuffer(e.FRAMEBUFFER,null)}function D(t,n,i){if(e.bindRenderbuffer(e.RENDERBUFFER,t),n.depthBuffer){const r=n.depthTexture,s=r&&r.isDepthTexture?r.type:null,a=_(n.stencilBuffer,s),l=n.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT,c=F(n);k(n)?o.renderbufferStorageMultisampleEXT(e.RENDERBUFFER,c,a,n.width,n.height):i?e.renderbufferStorageMultisample(e.RENDERBUFFER,c,a,n.width,n.height):e.renderbufferStorage(e.RENDERBUFFER,a,n.width,n.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,l,e.RENDERBUFFER,t)}else{const t=n.textures;for(let r=0;r<t.length;r++){const a=t[r],l=s.convert(a.format,a.colorSpace),c=s.convert(a.type),h=v(a.internalFormat,l,c,a.colorSpace),u=F(n);i&&!1===k(n)?e.renderbufferStorageMultisample(e.RENDERBUFFER,u,h,n.width,n.height):k(n)?o.renderbufferStorageMultisampleEXT(e.RENDERBUFFER,u,h,n.width,n.height):e.renderbufferStorage(e.RENDERBUFFER,h,n.width,n.height)}}e.bindRenderbuffer(e.RENDERBUFFER,null)}function N(t){const r=i.get(t),s=!0===t.isWebGLCubeRenderTarget;if(r.__boundDepthTexture!==t.depthTexture){const e=t.depthTexture;if(r.__depthDisposeCallback&&r.__depthDisposeCallback(),e){const t=()=>{delete r.__boundDepthTexture,delete r.__depthDisposeCallback,e.removeEventListener("dispose",t)};e.addEventListener("dispose",t),r.__depthDisposeCallback=t}r.__boundDepthTexture=e}if(t.depthTexture&&!r.__autoAllocateDepthBuffer){if(s)throw new Error("target.depthTexture not supported in Cube render targets");!function(t,r){if(r&&r.isWebGLCubeRenderTarget)throw new Error("Depth Texture with cube render targets is not supported");if(n.bindFramebuffer(e.FRAMEBUFFER,t),!r.depthTexture||!r.depthTexture.isDepthTexture)throw new Error("renderTarget.depthTexture must be an instance of THREE.DepthTexture");const s=i.get(r.depthTexture);s.__renderTarget=r,s.__webglTexture&&r.depthTexture.image.width===r.width&&r.depthTexture.image.height===r.height||(r.depthTexture.image.width=r.width,r.depthTexture.image.height=r.height,r.depthTexture.needsUpdate=!0),S(r.depthTexture,0);const a=s.__webglTexture,l=F(r);if(r.depthTexture.format===ce)k(r)?o.framebufferTexture2DMultisampleEXT(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,a,0,l):e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,a,0);else{if(r.depthTexture.format!==he)throw new Error("Unknown depthTexture format");k(r)?o.framebufferTexture2DMultisampleEXT(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.TEXTURE_2D,a,0,l):e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.TEXTURE_2D,a,0)}}(r.__webglFramebuffer,t)}else if(s){r.__webglDepthbuffer=[];for(let i=0;i<6;i++)if(n.bindFramebuffer(e.FRAMEBUFFER,r.__webglFramebuffer[i]),void 0===r.__webglDepthbuffer[i])r.__webglDepthbuffer[i]=e.createRenderbuffer(),D(r.__webglDepthbuffer[i],t,!1);else{const n=t.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT,s=r.__webglDepthbuffer[i];e.bindRenderbuffer(e.RENDERBUFFER,s),e.framebufferRenderbuffer(e.FRAMEBUFFER,n,e.RENDERBUFFER,s)}}else if(n.bindFramebuffer(e.FRAMEBUFFER,r.__webglFramebuffer),void 0===r.__webglDepthbuffer)r.__webglDepthbuffer=e.createRenderbuffer(),D(r.__webglDepthbuffer,t,!1);else{const n=t.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT,i=r.__webglDepthbuffer;e.bindRenderbuffer(e.RENDERBUFFER,i),e.framebufferRenderbuffer(e.FRAMEBUFFER,n,e.RENDERBUFFER,i)}n.bindFramebuffer(e.FRAMEBUFFER,null)}const U=[],O=[];function F(e){return Math.min(r.maxSamples,e.samples)}function k(e){const n=i.get(e);return e.samples>0&&!0===t.has("WEBGL_multisampled_render_to_texture")&&!1!==n.__useRenderToTexture}function Q(e,t){const n=e.colorSpace,i=e.format,r=e.type;return!0===e.isCompressedTexture||!0===e.isVideoTexture||n!==tt&&n!==Ze&&(Ot.getTransfer(n)===it?i===ae&&r===K||console.warn("THREE.WebGLTextures: sRGB encoded textures have to use RGBAFormat and UnsignedByteType."):console.error("THREE.WebGLTextures: Unsupported texture color space:",n)),t}function $(e){return"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement?(c.width=e.naturalWidth||e.width,c.height=e.naturalHeight||e.height):"undefined"!=typeof VideoFrame&&e instanceof VideoFrame?(c.width=e.displayWidth,c.height=e.displayHeight):(c.width=e.width,c.height=e.height),c}this.allocateTextureUnit=function(){const e=M;return e>=r.maxTextures&&console.warn("THREE.WebGLTextures: Trying to use "+e+" texture units while this GPU supports only "+r.maxTextures),M+=1,e},this.resetTextureUnits=function(){M=0},this.setTexture2D=S,this.setTexture2DArray=function(t,r){const s=i.get(t);t.version>0&&s.__version!==t.version?L(s,t,r):n.bindTexture(e.TEXTURE_2D_ARRAY,s.__webglTexture,e.TEXTURE0+r)},this.setTexture3D=function(t,r){const s=i.get(t);t.version>0&&s.__version!==t.version?L(s,t,r):n.bindTexture(e.TEXTURE_3D,s.__webglTexture,e.TEXTURE0+r)},this.setTextureCube=function(t,a){const o=i.get(t);t.version>0&&o.__version!==t.version?function(t,a,o){if(6!==a.image.length)return;const l=B(t,a),c=a.source;n.bindTexture(e.TEXTURE_CUBE_MAP,t.__webglTexture,e.TEXTURE0+o);const h=i.get(c);if(c.version!==h.__version||!0===l){n.activeTexture(e.TEXTURE0+o);const t=Ot.getPrimaries(Ot.workingColorSpace),i=a.colorSpace===Ze?null:Ot.getPrimaries(a.colorSpace),u=a.colorSpace===Ze||t===i?e.NONE:e.BROWSER_DEFAULT_WEBGL;e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,a.flipY),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,a.premultiplyAlpha),e.pixelStorei(e.UNPACK_ALIGNMENT,a.unpackAlignment),e.pixelStorei(e.UNPACK_COLORSPACE_CONVERSION_WEBGL,u);const d=a.isCompressedTexture||a.image[0].isCompressedTexture,p=a.image[0]&&a.image[0].isDataTexture,f=[];for(let e=0;e<6;e++)f[e]=d||p?p?a.image[e].image:a.image[e]:m(a.image[e],!0,r.maxCubemapSize),f[e]=Q(a,f[e]);const y=f[0],_=s.convert(a.format,a.colorSpace),E=s.convert(a.type),b=v(a.internalFormat,_,E,a.colorSpace),w=!0!==a.isVideoTexture,M=void 0===h.__version||!0===l,S=c.dataReady;let C,T=x(a,y);if(R(e.TEXTURE_CUBE_MAP,a),d){w&&M&&n.texStorage2D(e.TEXTURE_CUBE_MAP,T,b,y.width,y.height);for(let t=0;t<6;t++){C=f[t].mipmaps;for(let i=0;i<C.length;i++){const r=C[i];a.format!==ae?null!==_?w?S&&n.compressedTexSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,i,0,0,r.width,r.height,_,r.data):n.compressedTexImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,i,b,r.width,r.height,0,r.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .setTextureCube()"):w?S&&n.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,i,0,0,r.width,r.height,_,E,r.data):n.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,i,b,r.width,r.height,0,_,E,r.data)}}}else{if(C=a.mipmaps,w&&M){C.length>0&&T++;const t=$(f[0]);n.texStorage2D(e.TEXTURE_CUBE_MAP,T,b,t.width,t.height)}for(let t=0;t<6;t++)if(p){w?S&&n.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,0,0,f[t].width,f[t].height,_,E,f[t].data):n.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,b,f[t].width,f[t].height,0,_,E,f[t].data);for(let i=0;i<C.length;i++){const r=C[i].image[t].image;w?S&&n.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,i+1,0,0,r.width,r.height,_,E,r.data):n.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,i+1,b,r.width,r.height,0,_,E,r.data)}}else{w?S&&n.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,0,0,_,E,f[t]):n.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,0,b,_,E,f[t]);for(let i=0;i<C.length;i++){const r=C[i];w?S&&n.texSubImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,i+1,0,0,_,E,r.image[t]):n.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+t,i+1,b,_,E,r.image[t])}}}g(a)&&A(e.TEXTURE_CUBE_MAP),h.__version=c.version,a.onUpdate&&a.onUpdate(a)}t.__version=a.version}(o,t,a):n.bindTexture(e.TEXTURE_CUBE_MAP,o.__webglTexture,e.TEXTURE0+a)},this.rebindTextures=function(t,n,r){const s=i.get(t);void 0!==n&&P(s.__webglFramebuffer,t,t.texture,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,0),void 0!==r&&N(t)},this.setupRenderTarget=function(t){const r=t.texture,o=i.get(t),l=i.get(r);t.addEventListener("dispose",b);const c=t.textures,h=!0===t.isWebGLCubeRenderTarget,u=c.length>1;if(u||(void 0===l.__webglTexture&&(l.__webglTexture=e.createTexture()),l.__version=r.version,a.memory.textures++),h){o.__webglFramebuffer=[];for(let t=0;t<6;t++)if(r.mipmaps&&r.mipmaps.length>0){o.__webglFramebuffer[t]=[];for(let n=0;n<r.mipmaps.length;n++)o.__webglFramebuffer[t][n]=e.createFramebuffer()}else o.__webglFramebuffer[t]=e.createFramebuffer()}else{if(r.mipmaps&&r.mipmaps.length>0){o.__webglFramebuffer=[];for(let t=0;t<r.mipmaps.length;t++)o.__webglFramebuffer[t]=e.createFramebuffer()}else o.__webglFramebuffer=e.createFramebuffer();if(u)for(let t=0,n=c.length;t<n;t++){const n=i.get(c[t]);void 0===n.__webglTexture&&(n.__webglTexture=e.createTexture(),a.memory.textures++)}if(t.samples>0&&!1===k(t)){o.__webglMultisampledFramebuffer=e.createFramebuffer(),o.__webglColorRenderbuffer=[],n.bindFramebuffer(e.FRAMEBUFFER,o.__webglMultisampledFramebuffer);for(let n=0;n<c.length;n++){const i=c[n];o.__webglColorRenderbuffer[n]=e.createRenderbuffer(),e.bindRenderbuffer(e.RENDERBUFFER,o.__webglColorRenderbuffer[n]);const r=s.convert(i.format,i.colorSpace),a=s.convert(i.type),l=v(i.internalFormat,r,a,i.colorSpace,!0===t.isXRRenderTarget),h=F(t);e.renderbufferStorageMultisample(e.RENDERBUFFER,h,l,t.width,t.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+n,e.RENDERBUFFER,o.__webglColorRenderbuffer[n])}e.bindRenderbuffer(e.RENDERBUFFER,null),t.depthBuffer&&(o.__webglDepthRenderbuffer=e.createRenderbuffer(),D(o.__webglDepthRenderbuffer,t,!0)),n.bindFramebuffer(e.FRAMEBUFFER,null)}}if(h){n.bindTexture(e.TEXTURE_CUBE_MAP,l.__webglTexture),R(e.TEXTURE_CUBE_MAP,r);for(let n=0;n<6;n++)if(r.mipmaps&&r.mipmaps.length>0)for(let i=0;i<r.mipmaps.length;i++)P(o.__webglFramebuffer[n][i],t,r,e.COLOR_ATTACHMENT0,e.TEXTURE_CUBE_MAP_POSITIVE_X+n,i);else P(o.__webglFramebuffer[n],t,r,e.COLOR_ATTACHMENT0,e.TEXTURE_CUBE_MAP_POSITIVE_X+n,0);g(r)&&A(e.TEXTURE_CUBE_MAP),n.unbindTexture()}else if(u){for(let r=0,s=c.length;r<s;r++){const s=c[r],a=i.get(s);n.bindTexture(e.TEXTURE_2D,a.__webglTexture),R(e.TEXTURE_2D,s),P(o.__webglFramebuffer,t,s,e.COLOR_ATTACHMENT0+r,e.TEXTURE_2D,0),g(s)&&A(e.TEXTURE_2D)}n.unbindTexture()}else{let i=e.TEXTURE_2D;if((t.isWebGL3DRenderTarget||t.isWebGLArrayRenderTarget)&&(i=t.isWebGL3DRenderTarget?e.TEXTURE_3D:e.TEXTURE_2D_ARRAY),n.bindTexture(i,l.__webglTexture),R(i,r),r.mipmaps&&r.mipmaps.length>0)for(let n=0;n<r.mipmaps.length;n++)P(o.__webglFramebuffer[n],t,r,e.COLOR_ATTACHMENT0,i,n);else P(o.__webglFramebuffer,t,r,e.COLOR_ATTACHMENT0,i,0);g(r)&&A(i),n.unbindTexture()}t.depthBuffer&&N(t)},this.updateRenderTargetMipmap=function(e){const t=e.textures;for(let r=0,s=t.length;r<s;r++){const s=t[r];if(g(s)){const t=y(e),r=i.get(s).__webglTexture;n.bindTexture(t,r),A(t),n.unbindTexture()}}},this.updateMultisampleRenderTarget=function(t){if(t.samples>0)if(!1===k(t)){const r=t.textures,s=t.width,a=t.height;let o=e.COLOR_BUFFER_BIT;const c=t.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT,h=i.get(t),u=r.length>1;if(u)for(let t=0;t<r.length;t++)n.bindFramebuffer(e.FRAMEBUFFER,h.__webglMultisampledFramebuffer),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+t,e.RENDERBUFFER,null),n.bindFramebuffer(e.FRAMEBUFFER,h.__webglFramebuffer),e.framebufferTexture2D(e.DRAW_FRAMEBUFFER,e.COLOR_ATTACHMENT0+t,e.TEXTURE_2D,null,0);n.bindFramebuffer(e.READ_FRAMEBUFFER,h.__webglMultisampledFramebuffer),n.bindFramebuffer(e.DRAW_FRAMEBUFFER,h.__webglFramebuffer);for(let n=0;n<r.length;n++){if(t.resolveDepthBuffer&&(t.depthBuffer&&(o|=e.DEPTH_BUFFER_BIT),t.stencilBuffer&&t.resolveStencilBuffer&&(o|=e.STENCIL_BUFFER_BIT)),u){e.framebufferRenderbuffer(e.READ_FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.RENDERBUFFER,h.__webglColorRenderbuffer[n]);const t=i.get(r[n]).__webglTexture;e.framebufferTexture2D(e.DRAW_FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,t,0)}e.blitFramebuffer(0,0,s,a,0,0,s,a,o,e.NEAREST),!0===l&&(U.length=0,O.length=0,U.push(e.COLOR_ATTACHMENT0+n),t.depthBuffer&&!1===t.resolveDepthBuffer&&(U.push(c),O.push(c),e.invalidateFramebuffer(e.DRAW_FRAMEBUFFER,O)),e.invalidateFramebuffer(e.READ_FRAMEBUFFER,U))}if(n.bindFramebuffer(e.READ_FRAMEBUFFER,null),n.bindFramebuffer(e.DRAW_FRAMEBUFFER,null),u)for(let t=0;t<r.length;t++){n.bindFramebuffer(e.FRAMEBUFFER,h.__webglMultisampledFramebuffer),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+t,e.RENDERBUFFER,h.__webglColorRenderbuffer[t]);const s=i.get(r[t]).__webglTexture;n.bindFramebuffer(e.FRAMEBUFFER,h.__webglFramebuffer),e.framebufferTexture2D(e.DRAW_FRAMEBUFFER,e.COLOR_ATTACHMENT0+t,e.TEXTURE_2D,s,0)}n.bindFramebuffer(e.DRAW_FRAMEBUFFER,h.__webglMultisampledFramebuffer)}else if(t.depthBuffer&&!1===t.resolveDepthBuffer&&l){const n=t.stencilBuffer?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT;e.invalidateFramebuffer(e.DRAW_FRAMEBUFFER,[n])}},this.setupDepthRenderbuffer=N,this.setupFrameBufferTexture=P,this.useMultisampledRTT=k}function so(e,t){return{convert:function(n,i=Ze){let r;const s=Ot.getTransfer(i);if(n===K)return e.UNSIGNED_BYTE;if(n===ne)return e.UNSIGNED_SHORT_4_4_4_4;if(n===ie)return e.UNSIGNED_SHORT_5_5_5_1;if(35902===n)return e.UNSIGNED_INT_5_9_9_9_REV;if(1010===n)return e.BYTE;if(1011===n)return e.SHORT;if(n===J)return e.UNSIGNED_SHORT;if(n===$)return e.INT;if(n===Z)return e.UNSIGNED_INT;if(n===ee)return e.FLOAT;if(n===te)return e.HALF_FLOAT;if(n===se)return e.ALPHA;if(1022===n)return e.RGB;if(n===ae)return e.RGBA;if(n===oe)return e.LUMINANCE;if(n===le)return e.LUMINANCE_ALPHA;if(n===ce)return e.DEPTH_COMPONENT;if(n===he)return e.DEPTH_STENCIL;if(n===ue)return e.RED;if(n===de)return e.RED_INTEGER;if(n===pe)return e.RG;if(n===fe)return e.RG_INTEGER;if(n===me)return e.RGBA_INTEGER;if(n===ge||n===Ae||n===ye||n===ve)if(s===it){if(r=t.get("WEBGL_compressed_texture_s3tc_srgb"),null===r)return null;if(n===ge)return r.COMPRESSED_SRGB_S3TC_DXT1_EXT;if(n===Ae)return r.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;if(n===ye)return r.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;if(n===ve)return r.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT}else{if(r=t.get("WEBGL_compressed_texture_s3tc"),null===r)return null;if(n===ge)return r.COMPRESSED_RGB_S3TC_DXT1_EXT;if(n===Ae)return r.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(n===ye)return r.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(n===ve)return r.COMPRESSED_RGBA_S3TC_DXT5_EXT}if(n===_e||n===xe||n===Ee||n===be){if(r=t.get("WEBGL_compressed_texture_pvrtc"),null===r)return null;if(n===_e)return r.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(n===xe)return r.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(n===Ee)return r.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(n===be)return r.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(n===we||n===Me||n===Se){if(r=t.get("WEBGL_compressed_texture_etc"),null===r)return null;if(n===we||n===Me)return s===it?r.COMPRESSED_SRGB8_ETC2:r.COMPRESSED_RGB8_ETC2;if(n===Se)return s===it?r.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:r.COMPRESSED_RGBA8_ETC2_EAC}if(n===Ce||n===Te||n===Ie||n===Re||n===Be||n===Le||n===Pe||n===De||n===Ne||n===Ue||n===Oe||n===Fe||n===ke||n===Qe){if(r=t.get("WEBGL_compressed_texture_astc"),null===r)return null;if(n===Ce)return s===it?r.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR:r.COMPRESSED_RGBA_ASTC_4x4_KHR;if(n===Te)return s===it?r.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR:r.COMPRESSED_RGBA_ASTC_5x4_KHR;if(n===Ie)return s===it?r.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR:r.COMPRESSED_RGBA_ASTC_5x5_KHR;if(n===Re)return s===it?r.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR:r.COMPRESSED_RGBA_ASTC_6x5_KHR;if(n===Be)return s===it?r.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR:r.COMPRESSED_RGBA_ASTC_6x6_KHR;if(n===Le)return s===it?r.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR:r.COMPRESSED_RGBA_ASTC_8x5_KHR;if(n===Pe)return s===it?r.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR:r.COMPRESSED_RGBA_ASTC_8x6_KHR;if(n===De)return s===it?r.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR:r.COMPRESSED_RGBA_ASTC_8x8_KHR;if(n===Ne)return s===it?r.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR:r.COMPRESSED_RGBA_ASTC_10x5_KHR;if(n===Ue)return s===it?r.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR:r.COMPRESSED_RGBA_ASTC_10x6_KHR;if(n===Oe)return s===it?r.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR:r.COMPRESSED_RGBA_ASTC_10x8_KHR;if(n===Fe)return s===it?r.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR:r.COMPRESSED_RGBA_ASTC_10x10_KHR;if(n===ke)return s===it?r.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR:r.COMPRESSED_RGBA_ASTC_12x10_KHR;if(n===Qe)return s===it?r.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR:r.COMPRESSED_RGBA_ASTC_12x12_KHR}if(n===ze||n===Ge||n===He){if(r=t.get("EXT_texture_compression_bptc"),null===r)return null;if(n===ze)return s===it?r.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT:r.COMPRESSED_RGBA_BPTC_UNORM_EXT;if(n===Ge)return r.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT;if(n===He)return r.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT}if(36283===n||n===Ve||n===je||n===qe){if(r=t.get("EXT_texture_compression_rgtc"),null===r)return null;if(n===ze)return r.COMPRESSED_RED_RGTC1_EXT;if(n===Ve)return r.COMPRESSED_SIGNED_RED_RGTC1_EXT;if(n===je)return r.COMPRESSED_RED_GREEN_RGTC2_EXT;if(n===qe)return r.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT}return n===re?e.UNSIGNED_INT_24_8:void 0!==e[n]?e[n]:null}}}class ao extends mr{constructor(e=[]){super(),this.isArrayCamera=!0,this.cameras=e}}class oo extends li{constructor(){super(),this.isGroup=!0,this.type="Group"}}const lo={type:"move"};class co{constructor(){this._targetRay=null,this._grip=null,this._hand=null}getHandSpace(){return null===this._hand&&(this._hand=new oo,this._hand.matrixAutoUpdate=!1,this._hand.visible=!1,this._hand.joints={},this._hand.inputState={pinching:!1}),this._hand}getTargetRaySpace(){return null===this._targetRay&&(this._targetRay=new oo,this._targetRay.matrixAutoUpdate=!1,this._targetRay.visible=!1,this._targetRay.hasLinearVelocity=!1,this._targetRay.linearVelocity=new sn,this._targetRay.hasAngularVelocity=!1,this._targetRay.angularVelocity=new sn),this._targetRay}getGripSpace(){return null===this._grip&&(this._grip=new oo,this._grip.matrixAutoUpdate=!1,this._grip.visible=!1,this._grip.hasLinearVelocity=!1,this._grip.linearVelocity=new sn,this._grip.hasAngularVelocity=!1,this._grip.angularVelocity=new sn),this._grip}dispatchEvent(e){return null!==this._targetRay&&this._targetRay.dispatchEvent(e),null!==this._grip&&this._grip.dispatchEvent(e),null!==this._hand&&this._hand.dispatchEvent(e),this}connect(e){if(e&&e.hand){const t=this._hand;if(t)for(const n of e.hand.values())this._getHandJoint(t,n)}return this.dispatchEvent({type:"connected",data:e}),this}disconnect(e){return this.dispatchEvent({type:"disconnected",data:e}),null!==this._targetRay&&(this._targetRay.visible=!1),null!==this._grip&&(this._grip.visible=!1),null!==this._hand&&(this._hand.visible=!1),this}update(e,t,n){let i=null,r=null,s=null;const a=this._targetRay,o=this._grip,l=this._hand;if(e&&"visible-blurred"!==t.session.visibilityState){if(l&&e.hand){s=!0;for(const i of e.hand.values()){const e=t.getJointPose(i,n),r=this._getHandJoint(l,i);null!==e&&(r.matrix.fromArray(e.transform.matrix),r.matrix.decompose(r.position,r.rotation,r.scale),r.matrixWorldNeedsUpdate=!0,r.jointRadius=e.radius),r.visible=null!==e}const i=l.joints["index-finger-tip"],r=l.joints["thumb-tip"],a=i.position.distanceTo(r.position),o=.02,c=.005;l.inputState.pinching&&a>o+c?(l.inputState.pinching=!1,this.dispatchEvent({type:"pinchend",handedness:e.handedness,target:this})):!l.inputState.pinching&&a<=o-c&&(l.inputState.pinching=!0,this.dispatchEvent({type:"pinchstart",handedness:e.handedness,target:this}))}else null!==o&&e.gripSpace&&(r=t.getPose(e.gripSpace,n),null!==r&&(o.matrix.fromArray(r.transform.matrix),o.matrix.decompose(o.position,o.rotation,o.scale),o.matrixWorldNeedsUpdate=!0,r.linearVelocity?(o.hasLinearVelocity=!0,o.linearVelocity.copy(r.linearVelocity)):o.hasLinearVelocity=!1,r.angularVelocity?(o.hasAngularVelocity=!0,o.angularVelocity.copy(r.angularVelocity)):o.hasAngularVelocity=!1));null!==a&&(i=t.getPose(e.targetRaySpace,n),null===i&&null!==r&&(i=r),null!==i&&(a.matrix.fromArray(i.transform.matrix),a.matrix.decompose(a.position,a.rotation,a.scale),a.matrixWorldNeedsUpdate=!0,i.linearVelocity?(a.hasLinearVelocity=!0,a.linearVelocity.copy(i.linearVelocity)):a.hasLinearVelocity=!1,i.angularVelocity?(a.hasAngularVelocity=!0,a.angularVelocity.copy(i.angularVelocity)):a.hasAngularVelocity=!1,this.dispatchEvent(lo)))}return null!==a&&(a.visible=null!==i),null!==o&&(o.visible=null!==r),null!==l&&(l.visible=null!==s),this}_getHandJoint(e,t){if(void 0===e.joints[t.jointName]){const n=new oo;n.matrixAutoUpdate=!1,n.visible=!1,e.joints[t.jointName]=n,e.add(n)}return e.joints[t.jointName]}}class ho{constructor(){this.texture=null,this.mesh=null,this.depthNear=0,this.depthFar=0}init(e,t,n){if(null===this.texture){const i=new Jt;e.properties.get(i).__webglTexture=t.texture,t.depthNear==n.depthNear&&t.depthFar==n.depthFar||(this.depthNear=t.depthNear,this.depthFar=t.depthFar),this.texture=i}}getMesh(e){if(null!==this.texture&&null===this.mesh){const t=e.cameras[0].viewport,n=new hr({vertexShader:"\nvoid main() {\n\n\tgl_Position = vec4( position, 1.0 );\n\n}",fragmentShader:"\nuniform sampler2DArray depthColor;\nuniform float depthWidth;\nuniform float depthHeight;\n\nvoid main() {\n\n\tvec2 coord = vec2( gl_FragCoord.x / depthWidth, gl_FragCoord.y / depthHeight );\n\n\tif ( coord.x >= 1.0 ) {\n\n\t\tgl_FragDepth = texture( depthColor, vec3( coord.x - 1.0, coord.y, 1 ) ).r;\n\n\t} else {\n\n\t\tgl_FragDepth = texture( depthColor, vec3( coord.x, coord.y, 0 ) ).r;\n\n\t}\n\n}",uniforms:{depthColor:{value:this.texture},depthWidth:{value:t.z},depthHeight:{value:t.w}}});this.mesh=new ir(new Ir(20,20),n)}return this.mesh}reset(){this.texture=null,this.mesh=null}getDepthTexture(){return this.texture}}class uo extends At{constructor(e,t){super();const n=this;let i=null,r=1,s=null,a="local-floor",o=1,l=null,c=null,h=null,u=null,d=null,p=null;const f=new ho,m=t.getContextAttributes();let g=null,A=null;const y=[],v=[],_=new It;let x=null;const E=new mr;E.viewport=new $t;const b=new mr;b.viewport=new $t;const w=[E,b],M=new ao;let S=null,C=null;function T(e){const t=v.indexOf(e.inputSource);if(-1===t)return;const n=y[t];void 0!==n&&(n.update(e.inputSource,e.frame,l||s),n.dispatchEvent({type:e.type,data:e.inputSource}))}function I(){i.removeEventListener("select",T),i.removeEventListener("selectstart",T),i.removeEventListener("selectend",T),i.removeEventListener("squeeze",T),i.removeEventListener("squeezestart",T),i.removeEventListener("squeezeend",T),i.removeEventListener("end",I),i.removeEventListener("inputsourceschange",R);for(let e=0;e<y.length;e++){const t=v[e];null!==t&&(v[e]=null,y[e].disconnect(t))}S=null,C=null,f.reset(),e.setRenderTarget(g),d=null,u=null,h=null,i=null,A=null,N.stop(),n.isPresenting=!1,e.setPixelRatio(x),e.setSize(_.width,_.height,!1),n.dispatchEvent({type:"sessionend"})}function R(e){for(let t=0;t<e.removed.length;t++){const n=e.removed[t],i=v.indexOf(n);i>=0&&(v[i]=null,y[i].disconnect(n))}for(let t=0;t<e.added.length;t++){const n=e.added[t];let i=v.indexOf(n);if(-1===i){for(let e=0;e<y.length;e++){if(e>=v.length){v.push(n),i=e;break}if(null===v[e]){v[e]=n,i=e;break}}if(-1===i)break}const r=y[i];r&&r.connect(n)}}this.cameraAutoUpdate=!0,this.enabled=!1,this.isPresenting=!1,this.getController=function(e){let t=y[e];return void 0===t&&(t=new co,y[e]=t),t.getTargetRaySpace()},this.getControllerGrip=function(e){let t=y[e];return void 0===t&&(t=new co,y[e]=t),t.getGripSpace()},this.getHand=function(e){let t=y[e];return void 0===t&&(t=new co,y[e]=t),t.getHandSpace()},this.setFramebufferScaleFactor=function(e){r=e,!0===n.isPresenting&&console.warn("THREE.WebXRManager: Cannot change framebuffer scale while presenting.")},this.setReferenceSpaceType=function(e){a=e,!0===n.isPresenting&&console.warn("THREE.WebXRManager: Cannot change reference space type while presenting.")},this.getReferenceSpace=function(){return l||s},this.setReferenceSpace=function(e){l=e},this.getBaseLayer=function(){return null!==u?u:d},this.getBinding=function(){return h},this.getFrame=function(){return p},this.getSession=function(){return i},this.setSession=async function(c){if(i=c,null!==i){if(g=e.getRenderTarget(),i.addEventListener("select",T),i.addEventListener("selectstart",T),i.addEventListener("selectend",T),i.addEventListener("squeeze",T),i.addEventListener("squeezestart",T),i.addEventListener("squeezeend",T),i.addEventListener("end",I),i.addEventListener("inputsourceschange",R),!0!==m.xrCompatible&&await t.makeXRCompatible(),x=e.getPixelRatio(),e.getSize(_),void 0===i.renderState.layers){const n={antialias:m.antialias,alpha:!0,depth:m.depth,stencil:m.stencil,framebufferScaleFactor:r};d=new XRWebGLLayer(i,t,n),i.updateRenderState({baseLayer:d}),e.setPixelRatio(1),e.setSize(d.framebufferWidth,d.framebufferHeight,!1),A=new en(d.framebufferWidth,d.framebufferHeight,{format:ae,type:K,colorSpace:e.outputColorSpace,stencilBuffer:m.stencil})}else{let n=null,s=null,a=null;m.depth&&(a=m.stencil?t.DEPTH24_STENCIL8:t.DEPTH_COMPONENT24,n=m.stencil?he:ce,s=m.stencil?re:Z);const o={colorFormat:t.RGBA8,depthFormat:a,scaleFactor:r};h=new XRWebGLBinding(i,t),u=h.createProjectionLayer(o),i.updateRenderState({layers:[u]}),e.setPixelRatio(1),e.setSize(u.textureWidth,u.textureHeight,!1),A=new en(u.textureWidth,u.textureHeight,{format:ae,type:K,depthTexture:new us(u.textureWidth,u.textureHeight,s,void 0,void 0,void 0,void 0,void 0,void 0,n),stencilBuffer:m.stencil,colorSpace:e.outputColorSpace,samples:m.antialias?4:0,resolveDepthBuffer:!1===u.ignoreDepthValues})}A.isXRRenderTarget=!0,this.setFoveation(o),l=null,s=await i.requestReferenceSpace(a),N.setContext(i),N.start(),n.isPresenting=!0,n.dispatchEvent({type:"sessionstart"})}},this.getEnvironmentBlendMode=function(){if(null!==i)return i.environmentBlendMode},this.getDepthTexture=function(){return f.getDepthTexture()};const B=new sn,L=new sn;function P(e,t){null===t?e.matrixWorld.copy(e.matrix):e.matrixWorld.multiplyMatrices(t.matrixWorld,e.matrix),e.matrixWorldInverse.copy(e.matrixWorld).invert()}this.updateCamera=function(e){if(null===i)return;let t=e.near,n=e.far;null!==f.texture&&(f.depthNear>0&&(t=f.depthNear),f.depthFar>0&&(n=f.depthFar)),M.near=b.near=E.near=t,M.far=b.far=E.far=n,S===M.near&&C===M.far||(i.updateRenderState({depthNear:M.near,depthFar:M.far}),S=M.near,C=M.far),E.layers.mask=2|e.layers.mask,b.layers.mask=4|e.layers.mask,M.layers.mask=E.layers.mask|b.layers.mask;const r=e.parent,s=M.cameras;P(M,r);for(let e=0;e<s.length;e++)P(s[e],r);2===s.length?function(e,t,n){B.setFromMatrixPosition(t.matrixWorld),L.setFromMatrixPosition(n.matrixWorld);const i=B.distanceTo(L),r=t.projectionMatrix.elements,s=n.projectionMatrix.elements,a=r[14]/(r[10]-1),o=r[14]/(r[10]+1),l=(r[9]+1)/r[5],c=(r[9]-1)/r[5],h=(r[8]-1)/r[0],u=(s[8]+1)/s[0],d=a*h,p=a*u,f=i/(-h+u),m=f*-h;if(t.matrixWorld.decompose(e.position,e.quaternion,e.scale),e.translateX(m),e.translateZ(f),e.matrixWorld.compose(e.position,e.quaternion,e.scale),e.matrixWorldInverse.copy(e.matrixWorld).invert(),-1===r[10])e.projectionMatrix.copy(t.projectionMatrix),e.projectionMatrixInverse.copy(t.projectionMatrixInverse);else{const t=a+f,n=o+f,r=d-m,s=p+(i-m),h=l*o/n*t,u=c*o/n*t;e.projectionMatrix.makePerspective(r,s,h,u,t,n),e.projectionMatrixInverse.copy(e.projectionMatrix).invert()}}(M,E,b):M.projectionMatrix.copy(E.projectionMatrix),function(e,t,n){null===n?e.matrix.copy(t.matrixWorld):(e.matrix.copy(n.matrixWorld),e.matrix.invert(),e.matrix.multiply(t.matrixWorld)),e.matrix.decompose(e.position,e.quaternion,e.scale),e.updateMatrixWorld(!0),e.projectionMatrix.copy(t.projectionMatrix),e.projectionMatrixInverse.copy(t.projectionMatrixInverse),e.isPerspectiveCamera&&(e.fov=2*xt*Math.atan(1/e.projectionMatrix.elements[5]),e.zoom=1)}(e,M,r)},this.getCamera=function(){return M},this.getFoveation=function(){if(null!==u||null!==d)return o},this.setFoveation=function(e){o=e,null!==u&&(u.fixedFoveation=e),null!==d&&void 0!==d.fixedFoveation&&(d.fixedFoveation=e)},this.hasDepthSensing=function(){return null!==f.texture},this.getDepthSensingMesh=function(){return f.getMesh(M)};let D=null;const N=new Cr;N.setAnimationLoop((function(t,r){if(c=r.getViewerPose(l||s),p=r,null!==c){const t=c.views;null!==d&&(e.setRenderTargetFramebuffer(A,d.framebuffer),e.setRenderTarget(A));let n=!1;t.length!==M.cameras.length&&(M.cameras.length=0,n=!0);for(let i=0;i<t.length;i++){const r=t[i];let s=null;if(null!==d)s=d.getViewport(r);else{const t=h.getViewSubImage(u,r);s=t.viewport,0===i&&(e.setRenderTargetTextures(A,t.colorTexture,u.ignoreDepthValues?void 0:t.depthStencilTexture),e.setRenderTarget(A))}let a=w[i];void 0===a&&(a=new mr,a.layers.enable(i),a.viewport=new $t,w[i]=a),a.matrix.fromArray(r.transform.matrix),a.matrix.decompose(a.position,a.quaternion,a.scale),a.projectionMatrix.fromArray(r.projectionMatrix),a.projectionMatrixInverse.copy(a.projectionMatrix).invert(),a.viewport.set(s.x,s.y,s.width,s.height),0===i&&(M.matrix.copy(a.matrix),M.matrix.decompose(M.position,M.quaternion,M.scale)),!0===n&&M.cameras.push(a)}const r=i.enabledFeatures;if(r&&r.includes("depth-sensing")){const n=h.getDepthInformation(t[0]);n&&n.isValid&&n.texture&&f.init(e,n,i.renderState)}}for(let e=0;e<y.length;e++){const t=v[e],n=y[e];null!==t&&void 0!==n&&n.update(t,r,l||s)}D&&D(t,r),r.detectedPlanes&&n.dispatchEvent({type:"planesdetected",data:r}),p=null})),this.setAnimationLoop=function(e){D=e},this.dispose=function(){}}}const po=new jn,fo=new Nn;function mo(e,t){function n(e,t){!0===e.matrixAutoUpdate&&e.updateMatrix(),t.value.copy(e.matrix)}function i(e,i){e.opacity.value=i.opacity,i.color&&e.diffuse.value.copy(i.color),i.emissive&&e.emissive.value.copy(i.emissive).multiplyScalar(i.emissiveIntensity),i.map&&(e.map.value=i.map,n(i.map,e.mapTransform)),i.alphaMap&&(e.alphaMap.value=i.alphaMap,n(i.alphaMap,e.alphaMapTransform)),i.bumpMap&&(e.bumpMap.value=i.bumpMap,n(i.bumpMap,e.bumpMapTransform),e.bumpScale.value=i.bumpScale,i.side===s&&(e.bumpScale.value*=-1)),i.normalMap&&(e.normalMap.value=i.normalMap,n(i.normalMap,e.normalMapTransform),e.normalScale.value.copy(i.normalScale),i.side===s&&e.normalScale.value.negate()),i.displacementMap&&(e.displacementMap.value=i.displacementMap,n(i.displacementMap,e.displacementMapTransform),e.displacementScale.value=i.displacementScale,e.displacementBias.value=i.displacementBias),i.emissiveMap&&(e.emissiveMap.value=i.emissiveMap,n(i.emissiveMap,e.emissiveMapTransform)),i.specularMap&&(e.specularMap.value=i.specularMap,n(i.specularMap,e.specularMapTransform)),i.alphaTest>0&&(e.alphaTest.value=i.alphaTest);const r=t.get(i),a=r.envMap,o=r.envMapRotation;a&&(e.envMap.value=a,po.copy(o),po.x*=-1,po.y*=-1,po.z*=-1,a.isCubeTexture&&!1===a.isRenderTargetTexture&&(po.y*=-1,po.z*=-1),e.envMapRotation.value.setFromMatrix4(fo.makeRotationFromEuler(po)),e.flipEnvMap.value=a.isCubeTexture&&!1===a.isRenderTargetTexture?-1:1,e.reflectivity.value=i.reflectivity,e.ior.value=i.ior,e.refractionRatio.value=i.refractionRatio),i.lightMap&&(e.lightMap.value=i.lightMap,e.lightMapIntensity.value=i.lightMapIntensity,n(i.lightMap,e.lightMapTransform)),i.aoMap&&(e.aoMap.value=i.aoMap,e.aoMapIntensity.value=i.aoMapIntensity,n(i.aoMap,e.aoMapTransform))}return{refreshFogUniforms:function(t,n){n.color.getRGB(t.fogColor.value,lr(e)),n.isFog?(t.fogNear.value=n.near,t.fogFar.value=n.far):n.isFogExp2&&(t.fogDensity.value=n.density)},refreshMaterialUniforms:function(e,r,a,o,l){r.isMeshBasicMaterial||r.isMeshLambertMaterial?i(e,r):r.isMeshToonMaterial?(i(e,r),function(e,t){t.gradientMap&&(e.gradientMap.value=t.gradientMap)}(e,r)):r.isMeshPhongMaterial?(i(e,r),function(e,t){e.specular.value.copy(t.specular),e.shininess.value=Math.max(t.shininess,1e-4)}(e,r)):r.isMeshStandardMaterial?(i(e,r),function(e,t){e.metalness.value=t.metalness,t.metalnessMap&&(e.metalnessMap.value=t.metalnessMap,n(t.metalnessMap,e.metalnessMapTransform)),e.roughness.value=t.roughness,t.roughnessMap&&(e.roughnessMap.value=t.roughnessMap,n(t.roughnessMap,e.roughnessMapTransform)),t.envMap&&(e.envMapIntensity.value=t.envMapIntensity)}(e,r),r.isMeshPhysicalMaterial&&function(e,t,i){e.ior.value=t.ior,t.sheen>0&&(e.sheenColor.value.copy(t.sheenColor).multiplyScalar(t.sheen),e.sheenRoughness.value=t.sheenRoughness,t.sheenColorMap&&(e.sheenColorMap.value=t.sheenColorMap,n(t.sheenColorMap,e.sheenColorMapTransform)),t.sheenRoughnessMap&&(e.sheenRoughnessMap.value=t.sheenRoughnessMap,n(t.sheenRoughnessMap,e.sheenRoughnessMapTransform))),t.clearcoat>0&&(e.clearcoat.value=t.clearcoat,e.clearcoatRoughness.value=t.clearcoatRoughness,t.clearcoatMap&&(e.clearcoatMap.value=t.clearcoatMap,n(t.clearcoatMap,e.clearcoatMapTransform)),t.clearcoatRoughnessMap&&(e.clearcoatRoughnessMap.value=t.clearcoatRoughnessMap,n(t.clearcoatRoughnessMap,e.clearcoatRoughnessMapTransform)),t.clearcoatNormalMap&&(e.clearcoatNormalMap.value=t.clearcoatNormalMap,n(t.clearcoatNormalMap,e.clearcoatNormalMapTransform),e.clearcoatNormalScale.value.copy(t.clearcoatNormalScale),t.side===s&&e.clearcoatNormalScale.value.negate())),t.dispersion>0&&(e.dispersion.value=t.dispersion),t.iridescence>0&&(e.iridescence.value=t.iridescence,e.iridescenceIOR.value=t.iridescenceIOR,e.iridescenceThicknessMinimum.value=t.iridescenceThicknessRange[0],e.iridescenceThicknessMaximum.value=t.iridescenceThicknessRange[1],t.iridescenceMap&&(e.iridescenceMap.value=t.iridescenceMap,n(t.iridescenceMap,e.iridescenceMapTransform)),t.iridescenceThicknessMap&&(e.iridescenceThicknessMap.value=t.iridescenceThicknessMap,n(t.iridescenceThicknessMap,e.iridescenceThicknessMapTransform))),t.transmission>0&&(e.transmission.value=t.transmission,e.transmissionSamplerMap.value=i.texture,e.transmissionSamplerSize.value.set(i.width,i.height),t.transmissionMap&&(e.transmissionMap.value=t.transmissionMap,n(t.transmissionMap,e.transmissionMapTransform)),e.thickness.value=t.thickness,t.thicknessMap&&(e.thicknessMap.value=t.thicknessMap,n(t.thicknessMap,e.thicknessMapTransform)),e.attenuationDistance.value=t.attenuationDistance,e.attenuationColor.value.copy(t.attenuationColor)),t.anisotropy>0&&(e.anisotropyVector.value.set(t.anisotropy*Math.cos(t.anisotropyRotation),t.anisotropy*Math.sin(t.anisotropyRotation)),t.anisotropyMap&&(e.anisotropyMap.value=t.anisotropyMap,n(t.anisotropyMap,e.anisotropyMapTransform))),e.specularIntensity.value=t.specularIntensity,e.specularColor.value.copy(t.specularColor),t.specularColorMap&&(e.specularColorMap.value=t.specularColorMap,n(t.specularColorMap,e.specularColorMapTransform)),t.specularIntensityMap&&(e.specularIntensityMap.value=t.specularIntensityMap,n(t.specularIntensityMap,e.specularIntensityMapTransform))}(e,r,l)):r.isMeshMatcapMaterial?(i(e,r),function(e,t){t.matcap&&(e.matcap.value=t.matcap)}(e,r)):r.isMeshDepthMaterial?i(e,r):r.isMeshDistanceMaterial?(i(e,r),function(e,n){const i=t.get(n).light;e.referencePosition.value.setFromMatrixPosition(i.matrixWorld),e.nearDistance.value=i.shadow.camera.near,e.farDistance.value=i.shadow.camera.far}(e,r)):r.isMeshNormalMaterial?i(e,r):r.isLineBasicMaterial?(function(e,t){e.diffuse.value.copy(t.color),e.opacity.value=t.opacity,t.map&&(e.map.value=t.map,n(t.map,e.mapTransform))}(e,r),r.isLineDashedMaterial&&function(e,t){e.dashSize.value=t.dashSize,e.totalSize.value=t.dashSize+t.gapSize,e.scale.value=t.scale}(e,r)):r.isPointsMaterial?function(e,t,i,r){e.diffuse.value.copy(t.color),e.opacity.value=t.opacity,e.size.value=t.size*i,e.scale.value=.5*r,t.map&&(e.map.value=t.map,n(t.map,e.uvTransform)),t.alphaMap&&(e.alphaMap.value=t.alphaMap,n(t.alphaMap,e.alphaMapTransform)),t.alphaTest>0&&(e.alphaTest.value=t.alphaTest)}(e,r,a,o):r.isSpriteMaterial?function(e,t){e.diffuse.value.copy(t.color),e.opacity.value=t.opacity,e.rotation.value=t.rotation,t.map&&(e.map.value=t.map,n(t.map,e.mapTransform)),t.alphaMap&&(e.alphaMap.value=t.alphaMap,n(t.alphaMap,e.alphaMapTransform)),t.alphaTest>0&&(e.alphaTest.value=t.alphaTest)}(e,r):r.isShadowMaterial?(e.color.value.copy(r.color),e.opacity.value=r.opacity):r.isShaderMaterial&&(r.uniformsNeedUpdate=!1)}}}function go(e,t,n,i){let r={},s={},a=[];const o=e.getParameter(e.MAX_UNIFORM_BUFFER_BINDINGS);function l(e,t,n,i){const r=e.value,s=t+"_"+n;if(void 0===i[s])return i[s]="number"==typeof r||"boolean"==typeof r?r:r.clone(),!0;{const e=i[s];if("number"==typeof r||"boolean"==typeof r){if(e!==r)return i[s]=r,!0}else if(!1===e.equals(r))return e.copy(r),!0}return!1}function c(e){const t={boundary:0,storage:0};return"number"==typeof e||"boolean"==typeof e?(t.boundary=4,t.storage=4):e.isVector2?(t.boundary=8,t.storage=8):e.isVector3||e.isColor?(t.boundary=16,t.storage=12):e.isVector4?(t.boundary=16,t.storage=16):e.isMatrix3?(t.boundary=48,t.storage=48):e.isMatrix4?(t.boundary=64,t.storage=64):e.isTexture?console.warn("THREE.WebGLRenderer: Texture samplers can not be part of an uniforms group."):console.warn("THREE.WebGLRenderer: Unsupported uniform value type.",e),t}function h(t){const n=t.target;n.removeEventListener("dispose",h);const i=a.indexOf(n.__bindingPointIndex);a.splice(i,1),e.deleteBuffer(r[n.id]),delete r[n.id],delete s[n.id]}return{bind:function(e,t){const n=t.program;i.uniformBlockBinding(e,n)},update:function(n,u){let d=r[n.id];void 0===d&&(function(e){const t=e.uniforms;let n=0;for(let e=0,i=t.length;e<i;e++){const i=Array.isArray(t[e])?t[e]:[t[e]];for(let e=0,t=i.length;e<t;e++){const t=i[e],r=Array.isArray(t.value)?t.value:[t.value];for(let e=0,i=r.length;e<i;e++){const i=c(r[e]),s=n%16,a=s%i.boundary,o=s+a;n+=a,0!==o&&16-o<i.storage&&(n+=16-o),t.__data=new Float32Array(i.storage/Float32Array.BYTES_PER_ELEMENT),t.__offset=n,n+=i.storage}}}const i=n%16;i>0&&(n+=16-i),e.__size=n,e.__cache={}}(n),d=function(t){const n=function(){for(let e=0;e<o;e++)if(-1===a.indexOf(e))return a.push(e),e;return console.error("THREE.WebGLRenderer: Maximum number of simultaneously usable uniforms groups reached."),0}();t.__bindingPointIndex=n;const i=e.createBuffer(),r=t.__size,s=t.usage;return e.bindBuffer(e.UNIFORM_BUFFER,i),e.bufferData(e.UNIFORM_BUFFER,r,s),e.bindBuffer(e.UNIFORM_BUFFER,null),e.bindBufferBase(e.UNIFORM_BUFFER,n,i),i}(n),r[n.id]=d,n.addEventListener("dispose",h));const p=u.program;i.updateUBOMapping(n,p);const f=t.render.frame;s[n.id]!==f&&(function(t){const n=r[t.id],i=t.uniforms,s=t.__cache;e.bindBuffer(e.UNIFORM_BUFFER,n);for(let t=0,n=i.length;t<n;t++){const n=Array.isArray(i[t])?i[t]:[i[t]];for(let i=0,r=n.length;i<r;i++){const r=n[i];if(!0===l(r,t,i,s)){const t=r.__offset,n=Array.isArray(r.value)?r.value:[r.value];let i=0;for(let s=0;s<n.length;s++){const a=n[s],o=c(a);"number"==typeof a||"boolean"==typeof a?(r.__data[0]=a,e.bufferSubData(e.UNIFORM_BUFFER,t+i,r.__data)):a.isMatrix3?(r.__data[0]=a.elements[0],r.__data[1]=a.elements[1],r.__data[2]=a.elements[2],r.__data[3]=0,r.__data[4]=a.elements[3],r.__data[5]=a.elements[4],r.__data[6]=a.elements[5],r.__data[7]=0,r.__data[8]=a.elements[6],r.__data[9]=a.elements[7],r.__data[10]=a.elements[8],r.__data[11]=0):(a.toArray(r.__data,i),i+=o.storage/Float32Array.BYTES_PER_ELEMENT)}e.bufferSubData(e.UNIFORM_BUFFER,t,r.__data)}}}e.bindBuffer(e.UNIFORM_BUFFER,null)}(n),s[n.id]=f)},dispose:function(){for(const t in r)e.deleteBuffer(r[t]);a=[],r={},s={}}}}class Ao{constructor(e={}){const{canvas:n=Dt(),context:i=null,depth:o=!0,stencil:l=!1,alpha:c=!1,antialias:h=!1,premultipliedAlpha:u=!0,preserveDrawingBuffer:d=!1,powerPreference:p="default",failIfMajorPerformanceCaveat:f=!1,reverseDepthBuffer:m=!1}=e;let g;if(this.isWebGLRenderer=!0,null!==i){if("undefined"!=typeof WebGLRenderingContext&&i instanceof WebGLRenderingContext)throw new Error("THREE.WebGLRenderer: WebGL 1 is not supported since r163.");g=i.getContextAttributes().alpha}else g=c;const A=new Uint32Array(4),y=new Int32Array(4);let v=null,_=null;const x=[],E=[];this.domElement=n,this.debug={checkShaderErrors:!0,onShaderError:null},this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.clippingPlanes=[],this.localClippingEnabled=!1,this._outputColorSpace=et,this.toneMapping=0,this.toneMappingExposure=1;const b=this;let w=!1,M=0,S=0,C=null,T=-1,I=null;const R=new $t,B=new $t;let L=null;const P=new Ci(0);let D=0,N=n.width,U=n.height,O=1,F=null,k=null;const Q=new $t(0,0,N,U),z=new $t(0,0,N,U);let G=!1;const H=new Sr;let V=!1,j=!1;const q=new Nn,W=new Nn,Y=new sn,$=new $t,ee={background:null,fog:null,environment:null,overrideMaterial:null,isScene:!0};let se=!1;function ae(){return null===C?O:1}let oe,le,ce,he,ue,pe,ge,Ae,ye,ve,_e,xe,Ee,be,we,Me,Se,Ce,Te,Ie,Re,Be,Le,Pe,De=i;function Ne(e,t){return n.getContext(e,t)}try{const e={alpha:!0,depth:o,stencil:l,antialias:h,premultipliedAlpha:u,preserveDrawingBuffer:d,powerPreference:p,failIfMajorPerformanceCaveat:f};if("setAttribute"in n&&n.setAttribute("data-engine",`three.js r${t}`),n.addEventListener("webglcontextlost",Fe,!1),n.addEventListener("webglcontextrestored",ke,!1),n.addEventListener("webglcontextcreationerror",Qe,!1),null===De){const t="webgl2";if(De=Ne(t,e),null===De)throw Ne(t)?new Error("Error creating WebGL context with your selected attributes."):new Error("Error creating WebGL context.")}}catch(e){throw console.error("THREE.WebGLRenderer: "+e.message),e}function Ue(){oe=new ss(De),oe.init(),Be=new so(De,oe),le=new kr(De,oe,e,Be),ce=new to(De,oe),le.reverseDepthBuffer&&m&&ce.buffers.depth.setReversed(!0),he=new ls(De),ue=new Qa,pe=new ro(De,oe,ce,ue,le,Be,he),ge=new zr(b),Ae=new rs(b),ye=new Tr(De),Le=new Or(De,ye),ve=new as(De,ye,he,Le),_e=new hs(De,ve,ye,he),Te=new cs(De,le,pe),Me=new Qr(ue),xe=new ka(b,ge,Ae,oe,le,Le,Me),Ee=new mo(b,ue),be=new Va,we=new Ka(oe),Ce=new Ur(b,ge,Ae,ce,_e,g,u),Se=new Za(b,_e,le),Pe=new go(De,he,le,ce),Ie=new Fr(De,oe,he),Re=new os(De,oe,he),he.programs=xe.programs,b.capabilities=le,b.extensions=oe,b.properties=ue,b.renderLists=be,b.shadowMap=Se,b.state=ce,b.info=he}Ue();const Oe=new uo(b,De);function Fe(e){e.preventDefault(),console.log("THREE.WebGLRenderer: Context Lost."),w=!0}function ke(){console.log("THREE.WebGLRenderer: Context Restored."),w=!1;const e=he.autoReset,t=Se.enabled,n=Se.autoUpdate,i=Se.needsUpdate,r=Se.type;Ue(),he.autoReset=e,Se.enabled=t,Se.autoUpdate=n,Se.needsUpdate=i,Se.type=r}function Qe(e){console.error("THREE.WebGLRenderer: A WebGL context could not be created. Reason: ",e.statusMessage)}function ze(e){const t=e.target;t.removeEventListener("dispose",ze),function(e){(function(e){const t=ue.get(e).programs;void 0!==t&&(t.forEach((function(e){xe.releaseProgram(e)})),e.isShaderMaterial&&xe.releaseShaderCache(e))})(e),ue.remove(e)}(t)}function Ge(e,t,n){!0===e.transparent&&e.side===a&&!1===e.forceSinglePass?(e.side=s,e.needsUpdate=!0,$e(e,t,n),e.side=r,e.needsUpdate=!0,$e(e,t,n),e.side=a):$e(e,t,n)}this.xr=Oe,this.getContext=function(){return De},this.getContextAttributes=function(){return De.getContextAttributes()},this.forceContextLoss=function(){const e=oe.get("WEBGL_lose_context");e&&e.loseContext()},this.forceContextRestore=function(){const e=oe.get("WEBGL_lose_context");e&&e.restoreContext()},this.getPixelRatio=function(){return O},this.setPixelRatio=function(e){void 0!==e&&(O=e,this.setSize(N,U,!1))},this.getSize=function(e){return e.set(N,U)},this.setSize=function(e,t,i=!0){Oe.isPresenting?console.warn("THREE.WebGLRenderer: Can't change size while VR device is presenting."):(N=e,U=t,n.width=Math.floor(e*O),n.height=Math.floor(t*O),!0===i&&(n.style.width=e+"px",n.style.height=t+"px"),this.setViewport(0,0,e,t))},this.getDrawingBufferSize=function(e){return e.set(N*O,U*O).floor()},this.setDrawingBufferSize=function(e,t,i){N=e,U=t,O=i,n.width=Math.floor(e*i),n.height=Math.floor(t*i),this.setViewport(0,0,e,t)},this.getCurrentViewport=function(e){return e.copy(R)},this.getViewport=function(e){return e.copy(Q)},this.setViewport=function(e,t,n,i){e.isVector4?Q.set(e.x,e.y,e.z,e.w):Q.set(e,t,n,i),ce.viewport(R.copy(Q).multiplyScalar(O).round())},this.getScissor=function(e){return e.copy(z)},this.setScissor=function(e,t,n,i){e.isVector4?z.set(e.x,e.y,e.z,e.w):z.set(e,t,n,i),ce.scissor(B.copy(z).multiplyScalar(O).round())},this.getScissorTest=function(){return G},this.setScissorTest=function(e){ce.setScissorTest(G=e)},this.setOpaqueSort=function(e){F=e},this.setTransparentSort=function(e){k=e},this.getClearColor=function(e){return e.copy(Ce.getClearColor())},this.setClearColor=function(){Ce.setClearColor.apply(Ce,arguments)},this.getClearAlpha=function(){return Ce.getClearAlpha()},this.setClearAlpha=function(){Ce.setClearAlpha.apply(Ce,arguments)},this.clear=function(e=!0,t=!0,n=!0){let i=0;if(e){let e=!1;if(null!==C){const t=C.texture.format;e=t===me||t===fe||t===de}if(e){const e=C.texture.type,t=e===K||e===Z||e===J||e===re||e===ne||e===ie,n=Ce.getClearColor(),i=Ce.getClearAlpha(),r=n.r,s=n.g,a=n.b;t?(A[0]=r,A[1]=s,A[2]=a,A[3]=i,De.clearBufferuiv(De.COLOR,0,A)):(y[0]=r,y[1]=s,y[2]=a,y[3]=i,De.clearBufferiv(De.COLOR,0,y))}else i|=De.COLOR_BUFFER_BIT}t&&(i|=De.DEPTH_BUFFER_BIT),n&&(i|=De.STENCIL_BUFFER_BIT,this.state.buffers.stencil.setMask(4294967295)),De.clear(i)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearStencil=function(){this.clear(!1,!1,!0)},this.dispose=function(){n.removeEventListener("webglcontextlost",Fe,!1),n.removeEventListener("webglcontextrestored",ke,!1),n.removeEventListener("webglcontextcreationerror",Qe,!1),be.dispose(),we.dispose(),ue.dispose(),ge.dispose(),Ae.dispose(),_e.dispose(),Le.dispose(),Pe.dispose(),xe.dispose(),Oe.dispose(),Oe.removeEventListener("sessionstart",Ve),Oe.removeEventListener("sessionend",je),qe.stop()},this.renderBufferDirect=function(e,t,n,i,r,s){null===t&&(t=ee);const a=r.isMesh&&r.matrixWorld.determinant()<0,o=function(e,t,n,i,r){!0!==t.isScene&&(t=ee),pe.resetTextureUnits();const s=t.fog,a=i.isMeshStandardMaterial?t.environment:null,o=null===C?b.outputColorSpace:!0===C.isXRRenderTarget?C.texture.colorSpace:tt,l=(i.isMeshStandardMaterial?Ae:ge).get(i.envMap||a),c=!0===i.vertexColors&&!!n.attributes.color&&4===n.attributes.color.itemSize,h=!!n.attributes.tangent&&(!!i.normalMap||i.anisotropy>0),u=!!n.morphAttributes.position,d=!!n.morphAttributes.normal,p=!!n.morphAttributes.color;let f=0;i.toneMapped&&(null!==C&&!0!==C.isXRRenderTarget||(f=b.toneMapping));const m=n.morphAttributes.position||n.morphAttributes.normal||n.morphAttributes.color,g=void 0!==m?m.length:0,A=ue.get(i),y=_.state.lights;if(!0===V&&(!0===j||e!==I)){const t=e===I&&i.id===T;Me.setState(i,e,t)}let v=!1;i.version===A.__version?A.needsLights&&A.lightsStateVersion!==y.state.version||A.outputColorSpace!==o||r.isBatchedMesh&&!1===A.batching?v=!0:r.isBatchedMesh||!0!==A.batching?r.isBatchedMesh&&!0===A.batchingColor&&null===r.colorTexture||r.isBatchedMesh&&!1===A.batchingColor&&null!==r.colorTexture||r.isInstancedMesh&&!1===A.instancing?v=!0:r.isInstancedMesh||!0!==A.instancing?r.isSkinnedMesh&&!1===A.skinning?v=!0:r.isSkinnedMesh||!0!==A.skinning?r.isInstancedMesh&&!0===A.instancingColor&&null===r.instanceColor||r.isInstancedMesh&&!1===A.instancingColor&&null!==r.instanceColor||r.isInstancedMesh&&!0===A.instancingMorph&&null===r.morphTexture||r.isInstancedMesh&&!1===A.instancingMorph&&null!==r.morphTexture||A.envMap!==l||!0===i.fog&&A.fog!==s?v=!0:void 0===A.numClippingPlanes||A.numClippingPlanes===Me.numPlanes&&A.numIntersection===Me.numIntersection?(A.vertexAlphas!==c||A.vertexTangents!==h||A.morphTargets!==u||A.morphNormals!==d||A.morphColors!==p||A.toneMapping!==f||A.morphTargetsCount!==g)&&(v=!0):v=!0:v=!0:v=!0:v=!0:(v=!0,A.__version=i.version);let x=A.currentProgram;!0===v&&(x=$e(i,t,r));let E=!1,w=!1,M=!1;const S=x.getUniforms(),R=A.uniforms;if(ce.useProgram(x.program)&&(E=!0,w=!0,M=!0),i.id!==T&&(T=i.id,w=!0),E||I!==e){ce.buffers.depth.getReversed()?(q.copy(e.projectionMatrix),function(e){const t=e.elements;t[2]=.5*t[2]+.5*t[3],t[6]=.5*t[6]+.5*t[7],t[10]=.5*t[10]+.5*t[11],t[14]=.5*t[14]+.5*t[15]}(q),function(e){const t=e.elements;-1===t[11]?(t[10]=-t[10]-1,t[14]=-t[14]):(t[10]=-t[10],t[14]=1-t[14])}(q),S.setValue(De,"projectionMatrix",q)):S.setValue(De,"projectionMatrix",e.projectionMatrix),S.setValue(De,"viewMatrix",e.matrixWorldInverse);const t=S.map.cameraPosition;void 0!==t&&t.setValue(De,Y.setFromMatrixPosition(e.matrixWorld)),le.logarithmicDepthBuffer&&S.setValue(De,"logDepthBufFC",2/(Math.log(e.far+1)/Math.LN2)),(i.isMeshPhongMaterial||i.isMeshToonMaterial||i.isMeshLambertMaterial||i.isMeshBasicMaterial||i.isMeshStandardMaterial||i.isShaderMaterial)&&S.setValue(De,"isOrthographic",!0===e.isOrthographicCamera),I!==e&&(I=e,w=!0,M=!0)}if(r.isSkinnedMesh){S.setOptional(De,r,"bindMatrix"),S.setOptional(De,r,"bindMatrixInverse");const e=r.skeleton;e&&(null===e.boneTexture&&e.computeBoneTexture(),S.setValue(De,"boneTexture",e.boneTexture,pe))}r.isBatchedMesh&&(S.setOptional(De,r,"batchingTexture"),S.setValue(De,"batchingTexture",r._matricesTexture,pe),S.setOptional(De,r,"batchingIdTexture"),S.setValue(De,"batchingIdTexture",r._indirectTexture,pe),S.setOptional(De,r,"batchingColorTexture"),null!==r._colorsTexture&&S.setValue(De,"batchingColorTexture",r._colorsTexture,pe));const B=n.morphAttributes;var L,P;if(void 0===B.position&&void 0===B.normal&&void 0===B.color||Te.update(r,n,x),(w||A.receiveShadow!==r.receiveShadow)&&(A.receiveShadow=r.receiveShadow,S.setValue(De,"receiveShadow",r.receiveShadow)),i.isMeshGouraudMaterial&&null!==i.envMap&&(R.envMap.value=l,R.flipEnvMap.value=l.isCubeTexture&&!1===l.isRenderTargetTexture?-1:1),i.isMeshStandardMaterial&&null===i.envMap&&null!==t.environment&&(R.envMapIntensity.value=t.environmentIntensity),w&&(S.setValue(De,"toneMappingExposure",b.toneMappingExposure),A.needsLights&&(P=M,(L=R).ambientLightColor.needsUpdate=P,L.lightProbe.needsUpdate=P,L.directionalLights.needsUpdate=P,L.directionalLightShadows.needsUpdate=P,L.pointLights.needsUpdate=P,L.pointLightShadows.needsUpdate=P,L.spotLights.needsUpdate=P,L.spotLightShadows.needsUpdate=P,L.rectAreaLights.needsUpdate=P,L.hemisphereLights.needsUpdate=P),s&&!0===i.fog&&Ee.refreshFogUniforms(R,s),Ee.refreshMaterialUniforms(R,i,O,U,_.state.transmissionRenderTarget[e.id]),ga.upload(De,Ze(A),R,pe)),i.isShaderMaterial&&!0===i.uniformsNeedUpdate&&(ga.upload(De,Ze(A),R,pe),i.uniformsNeedUpdate=!1),i.isSpriteMaterial&&S.setValue(De,"center",r.center),S.setValue(De,"modelViewMatrix",r.modelViewMatrix),S.setValue(De,"normalMatrix",r.normalMatrix),S.setValue(De,"modelMatrix",r.matrixWorld),i.isShaderMaterial||i.isRawShaderMaterial){const e=i.uniformsGroups;for(let t=0,n=e.length;t<n;t++){const n=e[t];Pe.update(n,x),Pe.bind(n,x)}}return x}(e,t,n,i,r);ce.setMaterial(i,a);let l=n.index,c=1;if(!0===i.wireframe){if(l=ve.getWireframeAttribute(n),void 0===l)return;c=2}const h=n.drawRange,u=n.attributes.position;let d=h.start*c,p=(h.start+h.count)*c;null!==s&&(d=Math.max(d,s.start*c),p=Math.min(p,(s.start+s.count)*c)),null!==l?(d=Math.max(d,0),p=Math.min(p,l.count)):null!=u&&(d=Math.max(d,0),p=Math.min(p,u.count));const f=p-d;if(f<0||f===1/0)return;let m;Le.setup(r,i,o,n,l);let g=Ie;if(null!==l&&(m=ye.get(l),g=Re,g.setIndex(m)),r.isMesh)!0===i.wireframe?(ce.setLineWidth(i.wireframeLinewidth*ae()),g.setMode(De.LINES)):g.setMode(De.TRIANGLES);else if(r.isLine){let e=i.linewidth;void 0===e&&(e=1),ce.setLineWidth(e*ae()),r.isLineSegments?g.setMode(De.LINES):r.isLineLoop?g.setMode(De.LINE_LOOP):g.setMode(De.LINE_STRIP)}else r.isPoints?g.setMode(De.POINTS):r.isSprite&&g.setMode(De.TRIANGLES);if(r.isBatchedMesh)if(null!==r._multiDrawInstances)g.renderMultiDrawInstances(r._multiDrawStarts,r._multiDrawCounts,r._multiDrawCount,r._multiDrawInstances);else if(oe.get("WEBGL_multi_draw"))g.renderMultiDraw(r._multiDrawStarts,r._multiDrawCounts,r._multiDrawCount);else{const e=r._multiDrawStarts,t=r._multiDrawCounts,n=r._multiDrawCount,s=l?ye.get(l).bytesPerElement:1,a=ue.get(i).currentProgram.getUniforms();for(let i=0;i<n;i++)a.setValue(De,"_gl_DrawID",i),g.render(e[i]/s,t[i])}else if(r.isInstancedMesh)g.renderInstances(d,f,r.count);else if(n.isInstancedBufferGeometry){const e=void 0!==n._maxInstanceCount?n._maxInstanceCount:1/0,t=Math.min(n.instanceCount,e);g.renderInstances(d,f,t)}else g.render(d,f)},this.compile=function(e,t,n=null){null===n&&(n=e),_=we.get(n),_.init(t),E.push(_),n.traverseVisible((function(e){e.isLight&&e.layers.test(t.layers)&&(_.pushLight(e),e.castShadow&&_.pushShadow(e))})),e!==n&&e.traverseVisible((function(e){e.isLight&&e.layers.test(t.layers)&&(_.pushLight(e),e.castShadow&&_.pushShadow(e))})),_.setupLights();const i=new Set;return e.traverse((function(e){if(!(e.isMesh||e.isPoints||e.isLine||e.isSprite))return;const t=e.material;if(t)if(Array.isArray(t))for(let r=0;r<t.length;r++){const s=t[r];Ge(s,n,e),i.add(s)}else Ge(t,n,e),i.add(t)})),E.pop(),_=null,i},this.compileAsync=function(e,t,n=null){const i=this.compile(e,t,n);return new Promise((t=>{function n(){i.forEach((function(e){ue.get(e).currentProgram.isReady()&&i.delete(e)})),0!==i.size?setTimeout(n,10):t(e)}null!==oe.get("KHR_parallel_shader_compile")?n():setTimeout(n,10)}))};let He=null;function Ve(){qe.stop()}function je(){qe.start()}const qe=new Cr;function We(e,t,n,i){if(!1===e.visible)return;if(e.layers.test(t.layers))if(e.isGroup)n=e.renderOrder;else if(e.isLOD)!0===e.autoUpdate&&e.update(t);else if(e.isLight)_.pushLight(e),e.castShadow&&_.pushShadow(e);else if(e.isSprite){if(!e.frustumCulled||H.intersectsSprite(e)){i&&$.setFromMatrixPosition(e.matrixWorld).applyMatrix4(W);const t=_e.update(e),r=e.material;r.visible&&v.push(e,t,r,n,$.z,null)}}else if((e.isMesh||e.isLine||e.isPoints)&&(!e.frustumCulled||H.intersectsObject(e))){const t=_e.update(e),r=e.material;if(i&&(void 0!==e.boundingSphere?(null===e.boundingSphere&&e.computeBoundingSphere(),$.copy(e.boundingSphere.center)):(null===t.boundingSphere&&t.computeBoundingSphere(),$.copy(t.boundingSphere.center)),$.applyMatrix4(e.matrixWorld).applyMatrix4(W)),Array.isArray(r)){const i=t.groups;for(let s=0,a=i.length;s<a;s++){const a=i[s],o=r[a.materialIndex];o&&o.visible&&v.push(e,t,o,n,$.z,a)}}else r.visible&&v.push(e,t,r,n,$.z,null)}const r=e.children;for(let e=0,s=r.length;e<s;e++)We(r[e],t,n,i)}function Ye(e,t,n,i){const r=e.opaque,s=e.transmissive,a=e.transparent;_.setupLightsView(n),!0===V&&Me.setGlobalState(b.clippingPlanes,n),i&&ce.viewport(R.copy(i)),r.length>0&&Ke(r,t,n),s.length>0&&Ke(s,t,n),a.length>0&&Ke(a,t,n),ce.buffers.depth.setTest(!0),ce.buffers.depth.setMask(!0),ce.buffers.color.setMask(!0),ce.setPolygonOffset(!1)}function Xe(e,t,n,i){if(null!==(!0===n.isScene?n.overrideMaterial:null))return;void 0===_.state.transmissionRenderTarget[i.id]&&(_.state.transmissionRenderTarget[i.id]=new en(1,1,{generateMipmaps:!0,type:oe.has("EXT_color_buffer_half_float")||oe.has("EXT_color_buffer_float")?te:K,minFilter:X,samples:4,stencilBuffer:l,resolveDepthBuffer:!1,resolveStencilBuffer:!1,colorSpace:Ot.workingColorSpace}));const r=_.state.transmissionRenderTarget[i.id],o=i.viewport||R;r.setSize(o.z,o.w);const c=b.getRenderTarget();b.setRenderTarget(r),b.getClearColor(P),D=b.getClearAlpha(),D<1&&b.setClearColor(16777215,.5),b.clear(),se&&Ce.render(n);const h=b.toneMapping;b.toneMapping=0;const u=i.viewport;if(void 0!==i.viewport&&(i.viewport=void 0),_.setupLightsView(i),!0===V&&Me.setGlobalState(b.clippingPlanes,i),Ke(e,n,i),pe.updateMultisampleRenderTarget(r),pe.updateRenderTargetMipmap(r),!1===oe.has("WEBGL_multisampled_render_to_texture")){let e=!1;for(let r=0,o=t.length;r<o;r++){const o=t[r],l=o.object,c=o.geometry,h=o.material,u=o.group;if(h.side===a&&l.layers.test(i.layers)){const t=h.side;h.side=s,h.needsUpdate=!0,Je(l,n,i,c,h,u),h.side=t,h.needsUpdate=!0,e=!0}}!0===e&&(pe.updateMultisampleRenderTarget(r),pe.updateRenderTargetMipmap(r))}b.setRenderTarget(c),b.setClearColor(P,D),void 0!==u&&(i.viewport=u),b.toneMapping=h}function Ke(e,t,n){const i=!0===t.isScene?t.overrideMaterial:null;for(let r=0,s=e.length;r<s;r++){const s=e[r],a=s.object,o=s.geometry,l=null===i?s.material:i,c=s.group;a.layers.test(n.layers)&&Je(a,t,n,o,l,c)}}function Je(e,t,n,i,o,l){e.onBeforeRender(b,t,n,i,o,l),e.modelViewMatrix.multiplyMatrices(n.matrixWorldInverse,e.matrixWorld),e.normalMatrix.getNormalMatrix(e.modelViewMatrix),o.onBeforeRender(b,t,n,i,e,l),!0===o.transparent&&o.side===a&&!1===o.forceSinglePass?(o.side=s,o.needsUpdate=!0,b.renderBufferDirect(n,t,i,o,e,l),o.side=r,o.needsUpdate=!0,b.renderBufferDirect(n,t,i,o,e,l),o.side=a):b.renderBufferDirect(n,t,i,o,e,l),e.onAfterRender(b,t,n,i,o,l)}function $e(e,t,n){!0!==t.isScene&&(t=ee);const i=ue.get(e),r=_.state.lights,s=_.state.shadowsArray,a=r.state.version,o=xe.getParameters(e,r.state,s,t,n),l=xe.getProgramCacheKey(o);let c=i.programs;i.environment=e.isMeshStandardMaterial?t.environment:null,i.fog=t.fog,i.envMap=(e.isMeshStandardMaterial?Ae:ge).get(e.envMap||i.environment),i.envMapRotation=null!==i.environment&&null===e.envMap?t.environmentRotation:e.envMapRotation,void 0===c&&(e.addEventListener("dispose",ze),c=new Map,i.programs=c);let h=c.get(l);if(void 0!==h){if(i.currentProgram===h&&i.lightsStateVersion===a)return nt(e,o),h}else o.uniforms=xe.getUniforms(e),e.onBeforeCompile(o,b),h=xe.acquireProgram(o,l),c.set(l,h),i.uniforms=o.uniforms;const u=i.uniforms;return(e.isShaderMaterial||e.isRawShaderMaterial)&&!0!==e.clipping||(u.clippingPlanes=Me.uniform),nt(e,o),i.needsLights=function(e){return e.isMeshLambertMaterial||e.isMeshToonMaterial||e.isMeshPhongMaterial||e.isMeshStandardMaterial||e.isShadowMaterial||e.isShaderMaterial&&!0===e.lights}(e),i.lightsStateVersion=a,i.needsLights&&(u.ambientLightColor.value=r.state.ambient,u.lightProbe.value=r.state.probe,u.directionalLights.value=r.state.directional,u.directionalLightShadows.value=r.state.directionalShadow,u.spotLights.value=r.state.spot,u.spotLightShadows.value=r.state.spotShadow,u.rectAreaLights.value=r.state.rectArea,u.ltc_1.value=r.state.rectAreaLTC1,u.ltc_2.value=r.state.rectAreaLTC2,u.pointLights.value=r.state.point,u.pointLightShadows.value=r.state.pointShadow,u.hemisphereLights.value=r.state.hemi,u.directionalShadowMap.value=r.state.directionalShadowMap,u.directionalShadowMatrix.value=r.state.directionalShadowMatrix,u.spotShadowMap.value=r.state.spotShadowMap,u.spotLightMatrix.value=r.state.spotLightMatrix,u.spotLightMap.value=r.state.spotLightMap,u.pointShadowMap.value=r.state.pointShadowMap,u.pointShadowMatrix.value=r.state.pointShadowMatrix),i.currentProgram=h,i.uniformsList=null,h}function Ze(e){if(null===e.uniformsList){const t=e.currentProgram.getUniforms();e.uniformsList=ga.seqWithValue(t.seq,e.uniforms)}return e.uniformsList}function nt(e,t){const n=ue.get(e);n.outputColorSpace=t.outputColorSpace,n.batching=t.batching,n.batchingColor=t.batchingColor,n.instancing=t.instancing,n.instancingColor=t.instancingColor,n.instancingMorph=t.instancingMorph,n.skinning=t.skinning,n.morphTargets=t.morphTargets,n.morphNormals=t.morphNormals,n.morphColors=t.morphColors,n.morphTargetsCount=t.morphTargetsCount,n.numClippingPlanes=t.numClippingPlanes,n.numIntersection=t.numClipIntersection,n.vertexAlphas=t.vertexAlphas,n.vertexTangents=t.vertexTangents,n.toneMapping=t.toneMapping}qe.setAnimationLoop((function(e){He&&He(e)})),"undefined"!=typeof self&&qe.setContext(self),this.setAnimationLoop=function(e){He=e,Oe.setAnimationLoop(e),null===e?qe.stop():qe.start()},Oe.addEventListener("sessionstart",Ve),Oe.addEventListener("sessionend",je),this.render=function(e,t){if(void 0!==t&&!0!==t.isCamera)return void console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera.");if(!0===w)return;if(!0===e.matrixWorldAutoUpdate&&e.updateMatrixWorld(),null===t.parent&&!0===t.matrixWorldAutoUpdate&&t.updateMatrixWorld(),!0===Oe.enabled&&!0===Oe.isPresenting&&(!0===Oe.cameraAutoUpdate&&Oe.updateCamera(t),t=Oe.getCamera()),!0===e.isScene&&e.onBeforeRender(b,e,t,C),_=we.get(e,E.length),_.init(t),E.push(_),W.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),H.setFromProjectionMatrix(W),j=this.localClippingEnabled,V=Me.init(this.clippingPlanes,j),v=be.get(e,x.length),v.init(),x.push(v),!0===Oe.enabled&&!0===Oe.isPresenting){const e=b.xr.getDepthSensingMesh();null!==e&&We(e,t,-1/0,b.sortObjects)}We(e,t,0,b.sortObjects),v.finish(),!0===b.sortObjects&&v.sort(F,k),se=!1===Oe.enabled||!1===Oe.isPresenting||!1===Oe.hasDepthSensing(),se&&Ce.addToRenderList(v,e),this.info.render.frame++,!0===V&&Me.beginShadows();const n=_.state.shadowsArray;Se.render(n,e,t),!0===V&&Me.endShadows(),!0===this.info.autoReset&&this.info.reset();const i=v.opaque,r=v.transmissive;if(_.setupLights(),t.isArrayCamera){const n=t.cameras;if(r.length>0)for(let t=0,s=n.length;t<s;t++)Xe(i,r,e,n[t]);se&&Ce.render(e);for(let t=0,i=n.length;t<i;t++){const i=n[t];Ye(v,e,i,i.viewport)}}else r.length>0&&Xe(i,r,e,t),se&&Ce.render(e),Ye(v,e,t);null!==C&&(pe.updateMultisampleRenderTarget(C),pe.updateRenderTargetMipmap(C)),!0===e.isScene&&e.onAfterRender(b,e,t),Le.resetDefaultState(),T=-1,I=null,E.pop(),E.length>0?(_=E[E.length-1],!0===V&&Me.setGlobalState(b.clippingPlanes,_.state.camera)):_=null,x.pop(),v=x.length>0?x[x.length-1]:null},this.getActiveCubeFace=function(){return M},this.getActiveMipmapLevel=function(){return S},this.getRenderTarget=function(){return C},this.setRenderTargetTextures=function(e,t,n){ue.get(e.texture).__webglTexture=t,ue.get(e.depthTexture).__webglTexture=n;const i=ue.get(e);i.__hasExternalTextures=!0,i.__autoAllocateDepthBuffer=void 0===n,i.__autoAllocateDepthBuffer||!0===oe.has("WEBGL_multisampled_render_to_texture")&&(console.warn("THREE.WebGLRenderer: Render-to-texture extension was disabled because an external texture was provided"),i.__useRenderToTexture=!1)},this.setRenderTargetFramebuffer=function(e,t){const n=ue.get(e);n.__webglFramebuffer=t,n.__useDefaultFramebuffer=void 0===t},this.setRenderTarget=function(e,t=0,n=0){C=e,M=t,S=n;let i=!0,r=null,s=!1,a=!1;if(e){const o=ue.get(e);if(void 0!==o.__useDefaultFramebuffer)ce.bindFramebuffer(De.FRAMEBUFFER,null),i=!1;else if(void 0===o.__webglFramebuffer)pe.setupRenderTarget(e);else if(o.__hasExternalTextures)pe.rebindTextures(e,ue.get(e.texture).__webglTexture,ue.get(e.depthTexture).__webglTexture);else if(e.depthBuffer){const t=e.depthTexture;if(o.__boundDepthTexture!==t){if(null!==t&&ue.has(t)&&(e.width!==t.image.width||e.height!==t.image.height))throw new Error("WebGLRenderTarget: Attached DepthTexture is initialized to the incorrect size.");pe.setupDepthRenderbuffer(e)}}const l=e.texture;(l.isData3DTexture||l.isDataArrayTexture||l.isCompressedArrayTexture)&&(a=!0);const c=ue.get(e).__webglFramebuffer;e.isWebGLCubeRenderTarget?(r=Array.isArray(c[t])?c[t][n]:c[t],s=!0):r=e.samples>0&&!1===pe.useMultisampledRTT(e)?ue.get(e).__webglMultisampledFramebuffer:Array.isArray(c)?c[n]:c,R.copy(e.viewport),B.copy(e.scissor),L=e.scissorTest}else R.copy(Q).multiplyScalar(O).floor(),B.copy(z).multiplyScalar(O).floor(),L=G;if(ce.bindFramebuffer(De.FRAMEBUFFER,r)&&i&&ce.drawBuffers(e,r),ce.viewport(R),ce.scissor(B),ce.setScissorTest(L),s){const i=ue.get(e.texture);De.framebufferTexture2D(De.FRAMEBUFFER,De.COLOR_ATTACHMENT0,De.TEXTURE_CUBE_MAP_POSITIVE_X+t,i.__webglTexture,n)}else if(a){const i=ue.get(e.texture),r=t||0;De.framebufferTextureLayer(De.FRAMEBUFFER,De.COLOR_ATTACHMENT0,i.__webglTexture,n||0,r)}T=-1},this.readRenderTargetPixels=function(e,t,n,i,r,s,a){if(!e||!e.isWebGLRenderTarget)return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.");let o=ue.get(e).__webglFramebuffer;if(e.isWebGLCubeRenderTarget&&void 0!==a&&(o=o[a]),o){ce.bindFramebuffer(De.FRAMEBUFFER,o);try{const a=e.texture,o=a.format,l=a.type;if(!le.textureFormatReadable(o))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in RGBA or implementation defined format.");if(!le.textureTypeReadable(l))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in UnsignedByteType or implementation defined type.");t>=0&&t<=e.width-i&&n>=0&&n<=e.height-r&&De.readPixels(t,n,i,r,Be.convert(o),Be.convert(l),s)}finally{const e=null!==C?ue.get(C).__webglFramebuffer:null;ce.bindFramebuffer(De.FRAMEBUFFER,e)}}},this.readRenderTargetPixelsAsync=async function(e,t,n,i,r,s,a){if(!e||!e.isWebGLRenderTarget)throw new Error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.");let o=ue.get(e).__webglFramebuffer;if(e.isWebGLCubeRenderTarget&&void 0!==a&&(o=o[a]),o){const a=e.texture,l=a.format,c=a.type;if(!le.textureFormatReadable(l))throw new Error("THREE.WebGLRenderer.readRenderTargetPixelsAsync: renderTarget is not in RGBA or implementation defined format.");if(!le.textureTypeReadable(c))throw new Error("THREE.WebGLRenderer.readRenderTargetPixelsAsync: renderTarget is not in UnsignedByteType or implementation defined type.");if(t>=0&&t<=e.width-i&&n>=0&&n<=e.height-r){ce.bindFramebuffer(De.FRAMEBUFFER,o);const e=De.createBuffer();De.bindBuffer(De.PIXEL_PACK_BUFFER,e),De.bufferData(De.PIXEL_PACK_BUFFER,s.byteLength,De.STREAM_READ),De.readPixels(t,n,i,r,Be.convert(l),Be.convert(c),0);const a=null!==C?ue.get(C).__webglFramebuffer:null;ce.bindFramebuffer(De.FRAMEBUFFER,a);const h=De.fenceSync(De.SYNC_GPU_COMMANDS_COMPLETE,0);return De.flush(),await function(e,t){return new Promise((function(n,i){setTimeout((function r(){switch(e.clientWaitSync(t,e.SYNC_FLUSH_COMMANDS_BIT,0)){case e.WAIT_FAILED:i();break;case e.TIMEOUT_EXPIRED:setTimeout(r,4);break;default:n()}}),4)}))}(De,h),De.bindBuffer(De.PIXEL_PACK_BUFFER,e),De.getBufferSubData(De.PIXEL_PACK_BUFFER,0,s),De.deleteBuffer(e),De.deleteSync(h),s}throw new Error("THREE.WebGLRenderer.readRenderTargetPixelsAsync: requested read bounds are out of range.")}},this.copyFramebufferToTexture=function(e,t=null,n=0){!0!==e.isTexture&&(Ut("WebGLRenderer: copyFramebufferToTexture function signature has changed."),t=arguments[0]||null,e=arguments[1]);const i=Math.pow(2,-n),r=Math.floor(e.image.width*i),s=Math.floor(e.image.height*i),a=null!==t?t.x:0,o=null!==t?t.y:0;pe.setTexture2D(e,0),De.copyTexSubImage2D(De.TEXTURE_2D,n,0,0,a,o,r,s),ce.unbindTexture()},this.copyTextureToTexture=function(e,t,n=null,i=null,r=0){let s,a,o,l,c,h,u,d,p;!0!==e.isTexture&&(Ut("WebGLRenderer: copyTextureToTexture function signature has changed."),i=arguments[0]||null,e=arguments[1],t=arguments[2],r=arguments[3]||0,n=null);const f=e.isCompressedTexture?e.mipmaps[r]:e.image;null!==n?(s=n.max.x-n.min.x,a=n.max.y-n.min.y,o=n.isBox3?n.max.z-n.min.z:1,l=n.min.x,c=n.min.y,h=n.isBox3?n.min.z:0):(s=f.width,a=f.height,o=f.depth||1,l=0,c=0,h=0),null!==i?(u=i.x,d=i.y,p=i.z):(u=0,d=0,p=0);const m=Be.convert(t.format),g=Be.convert(t.type);let A;t.isData3DTexture?(pe.setTexture3D(t,0),A=De.TEXTURE_3D):t.isDataArrayTexture||t.isCompressedArrayTexture?(pe.setTexture2DArray(t,0),A=De.TEXTURE_2D_ARRAY):(pe.setTexture2D(t,0),A=De.TEXTURE_2D),De.pixelStorei(De.UNPACK_FLIP_Y_WEBGL,t.flipY),De.pixelStorei(De.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t.premultiplyAlpha),De.pixelStorei(De.UNPACK_ALIGNMENT,t.unpackAlignment);const y=De.getParameter(De.UNPACK_ROW_LENGTH),v=De.getParameter(De.UNPACK_IMAGE_HEIGHT),_=De.getParameter(De.UNPACK_SKIP_PIXELS),x=De.getParameter(De.UNPACK_SKIP_ROWS),E=De.getParameter(De.UNPACK_SKIP_IMAGES);De.pixelStorei(De.UNPACK_ROW_LENGTH,f.width),De.pixelStorei(De.UNPACK_IMAGE_HEIGHT,f.height),De.pixelStorei(De.UNPACK_SKIP_PIXELS,l),De.pixelStorei(De.UNPACK_SKIP_ROWS,c),De.pixelStorei(De.UNPACK_SKIP_IMAGES,h);const b=e.isDataArrayTexture||e.isData3DTexture,w=t.isDataArrayTexture||t.isData3DTexture;if(e.isRenderTargetTexture||e.isDepthTexture){const n=ue.get(e),i=ue.get(t),f=ue.get(n.__renderTarget),m=ue.get(i.__renderTarget);ce.bindFramebuffer(De.READ_FRAMEBUFFER,f.__webglFramebuffer),ce.bindFramebuffer(De.DRAW_FRAMEBUFFER,m.__webglFramebuffer);for(let n=0;n<o;n++)b&&De.framebufferTextureLayer(De.READ_FRAMEBUFFER,De.COLOR_ATTACHMENT0,ue.get(e).__webglTexture,r,h+n),e.isDepthTexture?(w&&De.framebufferTextureLayer(De.DRAW_FRAMEBUFFER,De.COLOR_ATTACHMENT0,ue.get(t).__webglTexture,r,p+n),De.blitFramebuffer(l,c,s,a,u,d,s,a,De.DEPTH_BUFFER_BIT,De.NEAREST)):w?De.copyTexSubImage3D(A,r,u,d,p+n,l,c,s,a):De.copyTexSubImage2D(A,r,u,d,p+n,l,c,s,a);ce.bindFramebuffer(De.READ_FRAMEBUFFER,null),ce.bindFramebuffer(De.DRAW_FRAMEBUFFER,null)}else w?e.isDataTexture||e.isData3DTexture?De.texSubImage3D(A,r,u,d,p,s,a,o,m,g,f.data):t.isCompressedArrayTexture?De.compressedTexSubImage3D(A,r,u,d,p,s,a,o,m,f.data):De.texSubImage3D(A,r,u,d,p,s,a,o,m,g,f):e.isDataTexture?De.texSubImage2D(De.TEXTURE_2D,r,u,d,s,a,m,g,f.data):e.isCompressedTexture?De.compressedTexSubImage2D(De.TEXTURE_2D,r,u,d,f.width,f.height,m,f.data):De.texSubImage2D(De.TEXTURE_2D,r,u,d,s,a,m,g,f);De.pixelStorei(De.UNPACK_ROW_LENGTH,y),De.pixelStorei(De.UNPACK_IMAGE_HEIGHT,v),De.pixelStorei(De.UNPACK_SKIP_PIXELS,_),De.pixelStorei(De.UNPACK_SKIP_ROWS,x),De.pixelStorei(De.UNPACK_SKIP_IMAGES,E),0===r&&t.generateMipmaps&&De.generateMipmap(A),ce.unbindTexture()},this.copyTextureToTexture3D=function(e,t,n=null,i=null,r=0){return!0!==e.isTexture&&(Ut("WebGLRenderer: copyTextureToTexture3D function signature has changed."),n=arguments[0]||null,i=arguments[1]||null,e=arguments[2],t=arguments[3],r=arguments[4]||0),Ut('WebGLRenderer: copyTextureToTexture3D function has been deprecated. Use "copyTextureToTexture" instead.'),this.copyTextureToTexture(e,t,n,i,r)},this.initRenderTarget=function(e){void 0===ue.get(e).__webglFramebuffer&&pe.setupRenderTarget(e)},this.initTexture=function(e){e.isCubeTexture?pe.setTextureCube(e,0):e.isData3DTexture?pe.setTexture3D(e,0):e.isDataArrayTexture||e.isCompressedArrayTexture?pe.setTexture2DArray(e,0):pe.setTexture2D(e,0),ce.unbindTexture()},this.resetState=function(){M=0,S=0,C=null,ce.reset(),Le.reset()},"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}get coordinateSystem(){return mt}get outputColorSpace(){return this._outputColorSpace}set outputColorSpace(e){this._outputColorSpace=e;const t=this.getContext();t.drawingBufferColorspace=Ot._getDrawingBufferColorSpace(e),t.unpackColorSpace=Ot._getUnpackColorSpace()}}class yo extends li{constructor(){super(),this.isScene=!0,this.type="Scene",this.background=null,this.environment=null,this.fog=null,this.backgroundBlurriness=0,this.backgroundIntensity=1,this.backgroundRotation=new jn,this.environmentIntensity=1,this.environmentRotation=new jn,this.overrideMaterial=null,"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}copy(e,t){return super.copy(e,t),null!==e.background&&(this.background=e.background.clone()),null!==e.environment&&(this.environment=e.environment.clone()),null!==e.fog&&(this.fog=e.fog.clone()),this.backgroundBlurriness=e.backgroundBlurriness,this.backgroundIntensity=e.backgroundIntensity,this.backgroundRotation.copy(e.backgroundRotation),this.environmentIntensity=e.environmentIntensity,this.environmentRotation.copy(e.environmentRotation),null!==e.overrideMaterial&&(this.overrideMaterial=e.overrideMaterial.clone()),this.matrixAutoUpdate=e.matrixAutoUpdate,this}toJSON(e){const t=super.toJSON(e);return null!==this.fog&&(t.object.fog=this.fog.toJSON()),this.backgroundBlurriness>0&&(t.object.backgroundBlurriness=this.backgroundBlurriness),1!==this.backgroundIntensity&&(t.object.backgroundIntensity=this.backgroundIntensity),t.object.backgroundRotation=this.backgroundRotation.toArray(),1!==this.environmentIntensity&&(t.object.environmentIntensity=this.environmentIntensity),t.object.environmentRotation=this.environmentRotation.toArray(),t}}class vo{constructor(e,t){this.isInterleavedBuffer=!0,this.array=e,this.stride=t,this.count=void 0!==e?e.length/t:0,this.usage=pt,this.updateRanges=[],this.version=0,this.uuid=Et()}onUploadCallback(){}set needsUpdate(e){!0===e&&this.version++}setUsage(e){return this.usage=e,this}addUpdateRange(e,t){this.updateRanges.push({start:e,count:t})}clearUpdateRanges(){this.updateRanges.length=0}copy(e){return this.array=new e.array.constructor(e.array),this.count=e.count,this.stride=e.stride,this.usage=e.usage,this}copyAt(e,t,n){e*=this.stride,n*=t.stride;for(let i=0,r=this.stride;i<r;i++)this.array[e+i]=t.array[n+i];return this}set(e,t=0){return this.array.set(e,t),this}clone(e){void 0===e.arrayBuffers&&(e.arrayBuffers={}),void 0===this.array.buffer._uuid&&(this.array.buffer._uuid=Et()),void 0===e.arrayBuffers[this.array.buffer._uuid]&&(e.arrayBuffers[this.array.buffer._uuid]=this.array.slice(0).buffer);const t=new this.array.constructor(e.arrayBuffers[this.array.buffer._uuid]),n=new this.constructor(t,this.stride);return n.setUsage(this.usage),n}onUpload(e){return this.onUploadCallback=e,this}toJSON(e){return void 0===e.arrayBuffers&&(e.arrayBuffers={}),void 0===this.array.buffer._uuid&&(this.array.buffer._uuid=Et()),void 0===e.arrayBuffers[this.array.buffer._uuid]&&(e.arrayBuffers[this.array.buffer._uuid]=Array.from(new Uint32Array(this.array.buffer))),{uuid:this.uuid,buffer:this.array.buffer._uuid,type:this.array.constructor.name,stride:this.stride}}}const _o=new sn;class xo{constructor(e,t,n,i=!1){this.isInterleavedBufferAttribute=!0,this.name="",this.data=e,this.itemSize=t,this.offset=n,this.normalized=i}get count(){return this.data.count}get array(){return this.data.array}set needsUpdate(e){this.data.needsUpdate=e}applyMatrix4(e){for(let t=0,n=this.data.count;t<n;t++)_o.fromBufferAttribute(this,t),_o.applyMatrix4(e),this.setXYZ(t,_o.x,_o.y,_o.z);return this}applyNormalMatrix(e){for(let t=0,n=this.count;t<n;t++)_o.fromBufferAttribute(this,t),_o.applyNormalMatrix(e),this.setXYZ(t,_o.x,_o.y,_o.z);return this}transformDirection(e){for(let t=0,n=this.count;t<n;t++)_o.fromBufferAttribute(this,t),_o.transformDirection(e),this.setXYZ(t,_o.x,_o.y,_o.z);return this}getComponent(e,t){let n=this.array[e*this.data.stride+this.offset+t];return this.normalized&&(n=St(n,this.array)),n}setComponent(e,t,n){return this.normalized&&(n=Ct(n,this.array)),this.data.array[e*this.data.stride+this.offset+t]=n,this}setX(e,t){return this.normalized&&(t=Ct(t,this.array)),this.data.array[e*this.data.stride+this.offset]=t,this}setY(e,t){return this.normalized&&(t=Ct(t,this.array)),this.data.array[e*this.data.stride+this.offset+1]=t,this}setZ(e,t){return this.normalized&&(t=Ct(t,this.array)),this.data.array[e*this.data.stride+this.offset+2]=t,this}setW(e,t){return this.normalized&&(t=Ct(t,this.array)),this.data.array[e*this.data.stride+this.offset+3]=t,this}getX(e){let t=this.data.array[e*this.data.stride+this.offset];return this.normalized&&(t=St(t,this.array)),t}getY(e){let t=this.data.array[e*this.data.stride+this.offset+1];return this.normalized&&(t=St(t,this.array)),t}getZ(e){let t=this.data.array[e*this.data.stride+this.offset+2];return this.normalized&&(t=St(t,this.array)),t}getW(e){let t=this.data.array[e*this.data.stride+this.offset+3];return this.normalized&&(t=St(t,this.array)),t}setXY(e,t,n){return e=e*this.data.stride+this.offset,this.normalized&&(t=Ct(t,this.array),n=Ct(n,this.array)),this.data.array[e+0]=t,this.data.array[e+1]=n,this}setXYZ(e,t,n,i){return e=e*this.data.stride+this.offset,this.normalized&&(t=Ct(t,this.array),n=Ct(n,this.array),i=Ct(i,this.array)),this.data.array[e+0]=t,this.data.array[e+1]=n,this.data.array[e+2]=i,this}setXYZW(e,t,n,i,r){return e=e*this.data.stride+this.offset,this.normalized&&(t=Ct(t,this.array),n=Ct(n,this.array),i=Ct(i,this.array),r=Ct(r,this.array)),this.data.array[e+0]=t,this.data.array[e+1]=n,this.data.array[e+2]=i,this.data.array[e+3]=r,this}clone(e){if(void 0===e){console.log("THREE.InterleavedBufferAttribute.clone(): Cloning an interleaved buffer attribute will de-interleave buffer data.");const e=[];for(let t=0;t<this.count;t++){const n=t*this.data.stride+this.offset;for(let t=0;t<this.itemSize;t++)e.push(this.data.array[n+t])}return new Di(new this.array.constructor(e),this.itemSize,this.normalized)}return void 0===e.interleavedBuffers&&(e.interleavedBuffers={}),void 0===e.interleavedBuffers[this.data.uuid]&&(e.interleavedBuffers[this.data.uuid]=this.data.clone(e)),new xo(e.interleavedBuffers[this.data.uuid],this.itemSize,this.offset,this.normalized)}toJSON(e){if(void 0===e){console.log("THREE.InterleavedBufferAttribute.toJSON(): Serializing an interleaved buffer attribute will de-interleave buffer data.");const e=[];for(let t=0;t<this.count;t++){const n=t*this.data.stride+this.offset;for(let t=0;t<this.itemSize;t++)e.push(this.data.array[n+t])}return{itemSize:this.itemSize,type:this.array.constructor.name,array:e,normalized:this.normalized}}return void 0===e.interleavedBuffers&&(e.interleavedBuffers={}),void 0===e.interleavedBuffers[this.data.uuid]&&(e.interleavedBuffers[this.data.uuid]=this.data.toJSON(e)),{isInterleavedBufferAttribute:!0,itemSize:this.itemSize,data:this.data.uuid,offset:this.offset,normalized:this.normalized}}}const Eo=new sn,bo=new $t,wo=new $t,Mo=new sn,So=new Nn,Co=new sn,To=new Sn,Io=new Nn,Ro=new Dn;class Bo extends ir{constructor(e,t){super(e,t),this.isSkinnedMesh=!0,this.type="SkinnedMesh",this.bindMode=O,this.bindMatrix=new Nn,this.bindMatrixInverse=new Nn,this.boundingBox=null,this.boundingSphere=null}computeBoundingBox(){const e=this.geometry;null===this.boundingBox&&(this.boundingBox=new ln),this.boundingBox.makeEmpty();const t=e.getAttribute("position");for(let e=0;e<t.count;e++)this.getVertexPosition(e,Co),this.boundingBox.expandByPoint(Co)}computeBoundingSphere(){const e=this.geometry;null===this.boundingSphere&&(this.boundingSphere=new Sn),this.boundingSphere.makeEmpty();const t=e.getAttribute("position");for(let e=0;e<t.count;e++)this.getVertexPosition(e,Co),this.boundingSphere.expandByPoint(Co)}copy(e,t){return super.copy(e,t),this.bindMode=e.bindMode,this.bindMatrix.copy(e.bindMatrix),this.bindMatrixInverse.copy(e.bindMatrixInverse),this.skeleton=e.skeleton,null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),this}raycast(e,t){const n=this.material,i=this.matrixWorld;void 0!==n&&(null===this.boundingSphere&&this.computeBoundingSphere(),To.copy(this.boundingSphere),To.applyMatrix4(i),!1!==e.ray.intersectsSphere(To)&&(Io.copy(i).invert(),Ro.copy(e.ray).applyMatrix4(Io),null!==this.boundingBox&&!1===Ro.intersectsBox(this.boundingBox)||this._computeIntersections(e,t,Ro)))}getVertexPosition(e,t){return super.getVertexPosition(e,t),this.applyBoneTransform(e,t),t}bind(e,t){this.skeleton=e,void 0===t&&(this.updateMatrixWorld(!0),this.skeleton.calculateInverses(),t=this.matrixWorld),this.bindMatrix.copy(t),this.bindMatrixInverse.copy(t).invert()}pose(){this.skeleton.pose()}normalizeSkinWeights(){const e=new $t,t=this.geometry.attributes.skinWeight;for(let n=0,i=t.count;n<i;n++){e.fromBufferAttribute(t,n);const i=1/e.manhattanLength();i!==1/0?e.multiplyScalar(i):e.set(1,0,0,0),t.setXYZW(n,e.x,e.y,e.z,e.w)}}updateMatrixWorld(e){super.updateMatrixWorld(e),this.bindMode===O?this.bindMatrixInverse.copy(this.matrixWorld).invert():"detached"===this.bindMode?this.bindMatrixInverse.copy(this.bindMatrix).invert():console.warn("THREE.SkinnedMesh: Unrecognized bindMode: "+this.bindMode)}applyBoneTransform(e,t){const n=this.skeleton,i=this.geometry;bo.fromBufferAttribute(i.attributes.skinIndex,e),wo.fromBufferAttribute(i.attributes.skinWeight,e),Eo.copy(t).applyMatrix4(this.bindMatrix),t.set(0,0,0);for(let e=0;e<4;e++){const i=wo.getComponent(e);if(0!==i){const r=bo.getComponent(e);So.multiplyMatrices(n.bones[r].matrixWorld,n.boneInverses[r]),t.addScaledVector(Mo.copy(Eo).applyMatrix4(So),i)}}return t.applyMatrix4(this.bindMatrixInverse)}}class Lo extends li{constructor(){super(),this.isBone=!0,this.type="Bone"}}class Po extends Jt{constructor(e=null,t=1,n=1,i,r,s,a,o,l=V,c=V,h,u){super(null,s,a,o,l,c,i,r,h,u),this.isDataTexture=!0,this.image={data:e,width:t,height:n},this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}const Do=new Nn,No=new Nn;class Uo{constructor(e=[],t=[]){this.uuid=Et(),this.bones=e.slice(0),this.boneInverses=t,this.boneMatrices=null,this.boneTexture=null,this.init()}init(){const e=this.bones,t=this.boneInverses;if(this.boneMatrices=new Float32Array(16*e.length),0===t.length)this.calculateInverses();else if(e.length!==t.length){console.warn("THREE.Skeleton: Number of inverse bone matrices does not match amount of bones."),this.boneInverses=[];for(let e=0,t=this.bones.length;e<t;e++)this.boneInverses.push(new Nn)}}calculateInverses(){this.boneInverses.length=0;for(let e=0,t=this.bones.length;e<t;e++){const t=new Nn;this.bones[e]&&t.copy(this.bones[e].matrixWorld).invert(),this.boneInverses.push(t)}}pose(){for(let e=0,t=this.bones.length;e<t;e++){const t=this.bones[e];t&&t.matrixWorld.copy(this.boneInverses[e]).invert()}for(let e=0,t=this.bones.length;e<t;e++){const t=this.bones[e];t&&(t.parent&&t.parent.isBone?(t.matrix.copy(t.parent.matrixWorld).invert(),t.matrix.multiply(t.matrixWorld)):t.matrix.copy(t.matrixWorld),t.matrix.decompose(t.position,t.quaternion,t.scale))}}update(){const e=this.bones,t=this.boneInverses,n=this.boneMatrices,i=this.boneTexture;for(let i=0,r=e.length;i<r;i++){const r=e[i]?e[i].matrixWorld:No;Do.multiplyMatrices(r,t[i]),Do.toArray(n,16*i)}null!==i&&(i.needsUpdate=!0)}clone(){return new Uo(this.bones,this.boneInverses)}computeBoneTexture(){let e=Math.sqrt(4*this.bones.length);e=4*Math.ceil(e/4),e=Math.max(e,4);const t=new Float32Array(e*e*4);t.set(this.boneMatrices);const n=new Po(t,e,e,ae,ee);return n.needsUpdate=!0,this.boneMatrices=t,this.boneTexture=n,this}getBoneByName(e){for(let t=0,n=this.bones.length;t<n;t++){const n=this.bones[t];if(n.name===e)return n}}dispose(){null!==this.boneTexture&&(this.boneTexture.dispose(),this.boneTexture=null)}fromJSON(e,t){this.uuid=e.uuid;for(let n=0,i=e.bones.length;n<i;n++){const i=e.bones[n];let r=t[i];void 0===r&&(console.warn("THREE.Skeleton: No bone found with UUID:",i),r=new Lo),this.bones.push(r),this.boneInverses.push((new Nn).fromArray(e.boneInverses[n]))}return this.init(),this}toJSON(){const e={metadata:{version:4.6,type:"Skeleton",generator:"Skeleton.toJSON"},bones:[],boneInverses:[]};e.uuid=this.uuid;const t=this.bones,n=this.boneInverses;for(let i=0,r=t.length;i<r;i++){const r=t[i];e.bones.push(r.uuid);const s=n[i];e.boneInverses.push(s.toArray())}return e}}class Oo extends Di{constructor(e,t,n,i=1){super(e,t,n),this.isInstancedBufferAttribute=!0,this.meshPerAttribute=i}copy(e){return super.copy(e),this.meshPerAttribute=e.meshPerAttribute,this}toJSON(){const e=super.toJSON();return e.meshPerAttribute=this.meshPerAttribute,e.isInstancedBufferAttribute=!0,e}}const Fo=new Nn,ko=new Nn,Qo=[],zo=new ln,Go=new Nn,Ho=new ir,Vo=new Sn;class jo extends ir{constructor(e,t,n){super(e,t),this.isInstancedMesh=!0,this.instanceMatrix=new Oo(new Float32Array(16*n),16),this.instanceColor=null,this.morphTexture=null,this.count=n,this.boundingBox=null,this.boundingSphere=null;for(let e=0;e<n;e++)this.setMatrixAt(e,Go)}computeBoundingBox(){const e=this.geometry,t=this.count;null===this.boundingBox&&(this.boundingBox=new ln),null===e.boundingBox&&e.computeBoundingBox(),this.boundingBox.makeEmpty();for(let n=0;n<t;n++)this.getMatrixAt(n,Fo),zo.copy(e.boundingBox).applyMatrix4(Fo),this.boundingBox.union(zo)}computeBoundingSphere(){const e=this.geometry,t=this.count;null===this.boundingSphere&&(this.boundingSphere=new Sn),null===e.boundingSphere&&e.computeBoundingSphere(),this.boundingSphere.makeEmpty();for(let n=0;n<t;n++)this.getMatrixAt(n,Fo),Vo.copy(e.boundingSphere).applyMatrix4(Fo),this.boundingSphere.union(Vo)}copy(e,t){return super.copy(e,t),this.instanceMatrix.copy(e.instanceMatrix),null!==e.morphTexture&&(this.morphTexture=e.morphTexture.clone()),null!==e.instanceColor&&(this.instanceColor=e.instanceColor.clone()),this.count=e.count,null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),this}getColorAt(e,t){t.fromArray(this.instanceColor.array,3*e)}getMatrixAt(e,t){t.fromArray(this.instanceMatrix.array,16*e)}getMorphAt(e,t){const n=t.morphTargetInfluences,i=this.morphTexture.source.data.data,r=e*(n.length+1)+1;for(let e=0;e<n.length;e++)n[e]=i[r+e]}raycast(e,t){const n=this.matrixWorld,i=this.count;if(Ho.geometry=this.geometry,Ho.material=this.material,void 0!==Ho.material&&(null===this.boundingSphere&&this.computeBoundingSphere(),Vo.copy(this.boundingSphere),Vo.applyMatrix4(n),!1!==e.ray.intersectsSphere(Vo)))for(let r=0;r<i;r++){this.getMatrixAt(r,Fo),ko.multiplyMatrices(n,Fo),Ho.matrixWorld=ko,Ho.raycast(e,Qo);for(let e=0,n=Qo.length;e<n;e++){const n=Qo[e];n.instanceId=r,n.object=this,t.push(n)}Qo.length=0}}setColorAt(e,t){null===this.instanceColor&&(this.instanceColor=new Oo(new Float32Array(3*this.instanceMatrix.count).fill(1),3)),t.toArray(this.instanceColor.array,3*e)}setMatrixAt(e,t){t.toArray(this.instanceMatrix.array,16*e)}setMorphAt(e,t){const n=t.morphTargetInfluences,i=n.length+1;null===this.morphTexture&&(this.morphTexture=new Po(new Float32Array(i*this.count),i,this.count,ue,ee));const r=this.morphTexture.source.data.data;let s=0;for(let e=0;e<n.length;e++)s+=n[e];const a=this.geometry.morphTargetsRelative?1:1-s,o=i*e;r[o]=a,r.set(n,o+1)}updateMorphTargets(){}dispose(){return this.dispatchEvent({type:"dispose"}),null!==this.morphTexture&&(this.morphTexture.dispose(),this.morphTexture=null),this}}class qo extends Ri{static get type(){return"LineBasicMaterial"}constructor(e){super(),this.isLineBasicMaterial=!0,this.color=new Ci(16777215),this.map=null,this.linewidth=1,this.linecap="round",this.linejoin="round",this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.linewidth=e.linewidth,this.linecap=e.linecap,this.linejoin=e.linejoin,this.fog=e.fog,this}}const Wo=new sn,Yo=new sn,Xo=new Nn,Ko=new Dn,Jo=new Sn,$o=new sn,Zo=new sn;class el extends li{constructor(e=new ji,t=new qo){super(),this.isLine=!0,this.type="Line",this.geometry=e,this.material=t,this.updateMorphTargets()}copy(e,t){return super.copy(e,t),this.material=Array.isArray(e.material)?e.material.slice():e.material,this.geometry=e.geometry,this}computeLineDistances(){const e=this.geometry;if(null===e.index){const t=e.attributes.position,n=[0];for(let e=1,i=t.count;e<i;e++)Wo.fromBufferAttribute(t,e-1),Yo.fromBufferAttribute(t,e),n[e]=n[e-1],n[e]+=Wo.distanceTo(Yo);e.setAttribute("lineDistance",new Oi(n,1))}else console.warn("THREE.Line.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");return this}raycast(e,t){const n=this.geometry,i=this.matrixWorld,r=e.params.Line.threshold,s=n.drawRange;if(null===n.boundingSphere&&n.computeBoundingSphere(),Jo.copy(n.boundingSphere),Jo.applyMatrix4(i),Jo.radius+=r,!1===e.ray.intersectsSphere(Jo))return;Xo.copy(i).invert(),Ko.copy(e.ray).applyMatrix4(Xo);const a=r/((this.scale.x+this.scale.y+this.scale.z)/3),o=a*a,l=this.isLineSegments?2:1,c=n.index,h=n.attributes.position;if(null!==c){const n=Math.max(0,s.start),i=Math.min(c.count,s.start+s.count);for(let r=n,s=i-1;r<s;r+=l){const n=c.getX(r),i=c.getX(r+1),s=tl(this,e,Ko,o,n,i);s&&t.push(s)}if(this.isLineLoop){const r=c.getX(i-1),s=c.getX(n),a=tl(this,e,Ko,o,r,s);a&&t.push(a)}}else{const n=Math.max(0,s.start),i=Math.min(h.count,s.start+s.count);for(let r=n,s=i-1;r<s;r+=l){const n=tl(this,e,Ko,o,r,r+1);n&&t.push(n)}if(this.isLineLoop){const r=tl(this,e,Ko,o,i-1,n);r&&t.push(r)}}}updateMorphTargets(){const e=this.geometry.morphAttributes,t=Object.keys(e);if(t.length>0){const n=e[t[0]];if(void 0!==n){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,t=n.length;e<t;e++){const t=n[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[t]=e}}}}}function tl(e,t,n,i,r,s){const a=e.geometry.attributes.position;if(Wo.fromBufferAttribute(a,r),Yo.fromBufferAttribute(a,s),n.distanceSqToSegment(Wo,Yo,$o,Zo)>i)return;$o.applyMatrix4(e.matrixWorld);const o=t.ray.origin.distanceTo($o);return o<t.near||o>t.far?void 0:{distance:o,point:Zo.clone().applyMatrix4(e.matrixWorld),index:r,face:null,faceIndex:null,barycoord:null,object:e}}const nl=new sn,il=new sn;class rl extends el{constructor(e,t){super(e,t),this.isLineSegments=!0,this.type="LineSegments"}computeLineDistances(){const e=this.geometry;if(null===e.index){const t=e.attributes.position,n=[];for(let e=0,i=t.count;e<i;e+=2)nl.fromBufferAttribute(t,e),il.fromBufferAttribute(t,e+1),n[e]=0===e?0:n[e-1],n[e+1]=n[e]+nl.distanceTo(il);e.setAttribute("lineDistance",new Oi(n,1))}else console.warn("THREE.LineSegments.computeLineDistances(): Computation only possible with non-indexed BufferGeometry.");return this}}class sl extends el{constructor(e,t){super(e,t),this.isLineLoop=!0,this.type="LineLoop"}}class al extends Ri{static get type(){return"PointsMaterial"}constructor(e){super(),this.isPointsMaterial=!0,this.color=new Ci(16777215),this.map=null,this.alphaMap=null,this.size=1,this.sizeAttenuation=!0,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.alphaMap=e.alphaMap,this.size=e.size,this.sizeAttenuation=e.sizeAttenuation,this.fog=e.fog,this}}const ol=new Nn,ll=new Dn,cl=new Sn,hl=new sn;class ul extends li{constructor(e=new ji,t=new al){super(),this.isPoints=!0,this.type="Points",this.geometry=e,this.material=t,this.updateMorphTargets()}copy(e,t){return super.copy(e,t),this.material=Array.isArray(e.material)?e.material.slice():e.material,this.geometry=e.geometry,this}raycast(e,t){const n=this.geometry,i=this.matrixWorld,r=e.params.Points.threshold,s=n.drawRange;if(null===n.boundingSphere&&n.computeBoundingSphere(),cl.copy(n.boundingSphere),cl.applyMatrix4(i),cl.radius+=r,!1===e.ray.intersectsSphere(cl))return;ol.copy(i).invert(),ll.copy(e.ray).applyMatrix4(ol);const a=r/((this.scale.x+this.scale.y+this.scale.z)/3),o=a*a,l=n.index,c=n.attributes.position;if(null!==l)for(let n=Math.max(0,s.start),r=Math.min(l.count,s.start+s.count);n<r;n++){const r=l.getX(n);hl.fromBufferAttribute(c,r),dl(hl,r,o,i,e,t,this)}else for(let n=Math.max(0,s.start),r=Math.min(c.count,s.start+s.count);n<r;n++)hl.fromBufferAttribute(c,n),dl(hl,n,o,i,e,t,this)}updateMorphTargets(){const e=this.geometry.morphAttributes,t=Object.keys(e);if(t.length>0){const n=e[t[0]];if(void 0!==n){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(let e=0,t=n.length;e<t;e++){const t=n[e].name||String(e);this.morphTargetInfluences.push(0),this.morphTargetDictionary[t]=e}}}}}function dl(e,t,n,i,r,s,a){const o=ll.distanceSqToPoint(e);if(o<n){const n=new sn;ll.closestPointToPoint(e,n),n.applyMatrix4(i);const l=r.ray.origin.distanceTo(n);if(l<r.near||l>r.far)return;s.push({distance:l,distanceToRay:Math.sqrt(o),point:n,index:t,face:null,faceIndex:null,barycoord:null,object:a})}}class pl extends Jt{constructor(e,t,n,i,r,s,a,o,l,c,h,u){super(null,s,a,o,l,c,i,r,h,u),this.isCompressedTexture=!0,this.image={width:t,height:n},this.mipmaps=e,this.flipY=!1,this.generateMipmaps=!1}}class fl extends pl{constructor(e,t,n,i,r,s){super(e,t,n,r,s),this.isCompressedArrayTexture=!0,this.image.depth=i,this.wrapR=G,this.layerUpdates=new Set}addLayerUpdate(e){this.layerUpdates.add(e)}clearLayerUpdates(){this.layerUpdates.clear()}}class ml extends pl{constructor(e,t,n){super(void 0,e[0].width,e[0].height,t,n,F),this.isCompressedCubeTexture=!0,this.isCubeTexture=!0,this.image=e}}class gl extends Jt{constructor(e,t,n,i,r,s,a,o,l){super(e,t,n,i,r,s,a,o,l),this.isCanvasTexture=!0,this.needsUpdate=!0}}class Al extends ji{constructor(e=1,t=32,n=0,i=2*Math.PI){super(),this.type="CircleGeometry",this.parameters={radius:e,segments:t,thetaStart:n,thetaLength:i},t=Math.max(3,t);const r=[],s=[],a=[],o=[],l=new sn,c=new It;s.push(0,0,0),a.push(0,0,1),o.push(.5,.5);for(let r=0,h=3;r<=t;r++,h+=3){const u=n+r/t*i;l.x=e*Math.cos(u),l.y=e*Math.sin(u),s.push(l.x,l.y,l.z),a.push(0,0,1),c.x=(s[h]/e+1)/2,c.y=(s[h+1]/e+1)/2,o.push(c.x,c.y)}for(let e=1;e<=t;e++)r.push(e,e+1,0);this.setIndex(r),this.setAttribute("position",new Oi(s,3)),this.setAttribute("normal",new Oi(a,3)),this.setAttribute("uv",new Oi(o,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new Al(e.radius,e.segments,e.thetaStart,e.thetaLength)}}class yl extends ji{constructor(e=1,t=32,n=16,i=0,r=2*Math.PI,s=0,a=Math.PI){super(),this.type="SphereGeometry",this.parameters={radius:e,widthSegments:t,heightSegments:n,phiStart:i,phiLength:r,thetaStart:s,thetaLength:a},t=Math.max(3,Math.floor(t)),n=Math.max(2,Math.floor(n));const o=Math.min(s+a,Math.PI);let l=0;const c=[],h=new sn,u=new sn,d=[],p=[],f=[],m=[];for(let d=0;d<=n;d++){const g=[],A=d/n;let y=0;0===d&&0===s?y=.5/t:d===n&&o===Math.PI&&(y=-.5/t);for(let n=0;n<=t;n++){const o=n/t;h.x=-e*Math.cos(i+o*r)*Math.sin(s+A*a),h.y=e*Math.cos(s+A*a),h.z=e*Math.sin(i+o*r)*Math.sin(s+A*a),p.push(h.x,h.y,h.z),u.copy(h).normalize(),f.push(u.x,u.y,u.z),m.push(o+y,1-A),g.push(l++)}c.push(g)}for(let e=0;e<n;e++)for(let i=0;i<t;i++){const t=c[e][i+1],r=c[e][i],a=c[e+1][i],l=c[e+1][i+1];(0!==e||s>0)&&d.push(t,r,l),(e!==n-1||o<Math.PI)&&d.push(r,a,l)}this.setIndex(d),this.setAttribute("position",new Oi(p,3)),this.setAttribute("normal",new Oi(f,3)),this.setAttribute("uv",new Oi(m,2))}copy(e){return super.copy(e),this.parameters=Object.assign({},e.parameters),this}static fromJSON(e){return new yl(e.radius,e.widthSegments,e.heightSegments,e.phiStart,e.phiLength,e.thetaStart,e.thetaLength)}}class vl extends hr{static get type(){return"RawShaderMaterial"}constructor(e){super(e),this.isRawShaderMaterial=!0}}class _l extends Ri{static get type(){return"MeshStandardMaterial"}constructor(e){super(),this.isMeshStandardMaterial=!0,this.defines={STANDARD:""},this.color=new Ci(16777215),this.roughness=1,this.metalness=0,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Ci(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new It(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.roughnessMap=null,this.metalnessMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new jn,this.envMapIntensity=1,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.defines={STANDARD:""},this.color.copy(e.color),this.roughness=e.roughness,this.metalness=e.metalness,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.roughnessMap=e.roughnessMap,this.metalnessMap=e.metalnessMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapRotation.copy(e.envMapRotation),this.envMapIntensity=e.envMapIntensity,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.flatShading=e.flatShading,this.fog=e.fog,this}}class xl extends _l{static get type(){return"MeshPhysicalMaterial"}constructor(e){super(),this.isMeshPhysicalMaterial=!0,this.defines={STANDARD:"",PHYSICAL:""},this.anisotropyRotation=0,this.anisotropyMap=null,this.clearcoatMap=null,this.clearcoatRoughness=0,this.clearcoatRoughnessMap=null,this.clearcoatNormalScale=new It(1,1),this.clearcoatNormalMap=null,this.ior=1.5,Object.defineProperty(this,"reflectivity",{get:function(){return bt(2.5*(this.ior-1)/(this.ior+1),0,1)},set:function(e){this.ior=(1+.4*e)/(1-.4*e)}}),this.iridescenceMap=null,this.iridescenceIOR=1.3,this.iridescenceThicknessRange=[100,400],this.iridescenceThicknessMap=null,this.sheenColor=new Ci(0),this.sheenColorMap=null,this.sheenRoughness=1,this.sheenRoughnessMap=null,this.transmissionMap=null,this.thickness=0,this.thicknessMap=null,this.attenuationDistance=1/0,this.attenuationColor=new Ci(1,1,1),this.specularIntensity=1,this.specularIntensityMap=null,this.specularColor=new Ci(1,1,1),this.specularColorMap=null,this._anisotropy=0,this._clearcoat=0,this._dispersion=0,this._iridescence=0,this._sheen=0,this._transmission=0,this.setValues(e)}get anisotropy(){return this._anisotropy}set anisotropy(e){this._anisotropy>0!=e>0&&this.version++,this._anisotropy=e}get clearcoat(){return this._clearcoat}set clearcoat(e){this._clearcoat>0!=e>0&&this.version++,this._clearcoat=e}get iridescence(){return this._iridescence}set iridescence(e){this._iridescence>0!=e>0&&this.version++,this._iridescence=e}get dispersion(){return this._dispersion}set dispersion(e){this._dispersion>0!=e>0&&this.version++,this._dispersion=e}get sheen(){return this._sheen}set sheen(e){this._sheen>0!=e>0&&this.version++,this._sheen=e}get transmission(){return this._transmission}set transmission(e){this._transmission>0!=e>0&&this.version++,this._transmission=e}copy(e){return super.copy(e),this.defines={STANDARD:"",PHYSICAL:""},this.anisotropy=e.anisotropy,this.anisotropyRotation=e.anisotropyRotation,this.anisotropyMap=e.anisotropyMap,this.clearcoat=e.clearcoat,this.clearcoatMap=e.clearcoatMap,this.clearcoatRoughness=e.clearcoatRoughness,this.clearcoatRoughnessMap=e.clearcoatRoughnessMap,this.clearcoatNormalMap=e.clearcoatNormalMap,this.clearcoatNormalScale.copy(e.clearcoatNormalScale),this.dispersion=e.dispersion,this.ior=e.ior,this.iridescence=e.iridescence,this.iridescenceMap=e.iridescenceMap,this.iridescenceIOR=e.iridescenceIOR,this.iridescenceThicknessRange=[...e.iridescenceThicknessRange],this.iridescenceThicknessMap=e.iridescenceThicknessMap,this.sheen=e.sheen,this.sheenColor.copy(e.sheenColor),this.sheenColorMap=e.sheenColorMap,this.sheenRoughness=e.sheenRoughness,this.sheenRoughnessMap=e.sheenRoughnessMap,this.transmission=e.transmission,this.transmissionMap=e.transmissionMap,this.thickness=e.thickness,this.thicknessMap=e.thicknessMap,this.attenuationDistance=e.attenuationDistance,this.attenuationColor.copy(e.attenuationColor),this.specularIntensity=e.specularIntensity,this.specularIntensityMap=e.specularIntensityMap,this.specularColor.copy(e.specularColor),this.specularColorMap=e.specularColorMap,this}}class El extends Ri{static get type(){return"MeshPhongMaterial"}constructor(e){super(),this.isMeshPhongMaterial=!0,this.color=new Ci(16777215),this.specular=new Ci(1118481),this.shininess=30,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Ci(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new It(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new jn,this.combine=0,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.specular.copy(e.specular),this.shininess=e.shininess,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapRotation.copy(e.envMapRotation),this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.flatShading=e.flatShading,this.fog=e.fog,this}}class bl extends Ri{static get type(){return"MeshLambertMaterial"}constructor(e){super(),this.isMeshLambertMaterial=!0,this.color=new Ci(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new Ci(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=0,this.normalScale=new It(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.envMapRotation=new jn,this.combine=0,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.flatShading=!1,this.fog=!0,this.setValues(e)}copy(e){return super.copy(e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalMapType=e.normalMapType,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapRotation.copy(e.envMapRotation),this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.flatShading=e.flatShading,this.fog=e.fog,this}}function wl(e,t,n){return!e||!n&&e.constructor===t?e:"number"==typeof t.BYTES_PER_ELEMENT?new t(e):Array.prototype.slice.call(e)}function Ml(e){const t=e.length,n=new Array(t);for(let e=0;e!==t;++e)n[e]=e;return n.sort((function(t,n){return e[t]-e[n]})),n}function Sl(e,t,n){const i=e.length,r=new e.constructor(i);for(let s=0,a=0;a!==i;++s){const i=n[s]*t;for(let n=0;n!==t;++n)r[a++]=e[i+n]}return r}function Cl(e,t,n,i){let r=1,s=e[0];for(;void 0!==s&&void 0===s[i];)s=e[r++];if(void 0===s)return;let a=s[i];if(void 0!==a)if(Array.isArray(a))do{a=s[i],void 0!==a&&(t.push(s.time),n.push.apply(n,a)),s=e[r++]}while(void 0!==s);else if(void 0!==a.toArray)do{a=s[i],void 0!==a&&(t.push(s.time),a.toArray(n,n.length)),s=e[r++]}while(void 0!==s);else do{a=s[i],void 0!==a&&(t.push(s.time),n.push(a)),s=e[r++]}while(void 0!==s)}class Tl{constructor(e,t,n,i){this.parameterPositions=e,this._cachedIndex=0,this.resultBuffer=void 0!==i?i:new t.constructor(n),this.sampleValues=t,this.valueSize=n,this.settings=null,this.DefaultSettings_={}}evaluate(e){const t=this.parameterPositions;let n=this._cachedIndex,i=t[n],r=t[n-1];e:{t:{let s;n:{i:if(!(e<i)){for(let s=n+2;;){if(void 0===i){if(e<r)break i;return n=t.length,this._cachedIndex=n,this.copySampleValue_(n-1)}if(n===s)break;if(r=i,i=t[++n],e<i)break t}s=t.length;break n}if(e>=r)break e;{const a=t[1];e<a&&(n=2,r=a);for(let s=n-2;;){if(void 0===r)return this._cachedIndex=0,this.copySampleValue_(0);if(n===s)break;if(i=r,r=t[--n-1],e>=r)break t}s=n,n=0}}for(;n<s;){const i=n+s>>>1;e<t[i]?s=i:n=i+1}if(i=t[n],r=t[n-1],void 0===r)return this._cachedIndex=0,this.copySampleValue_(0);if(void 0===i)return n=t.length,this._cachedIndex=n,this.copySampleValue_(n-1)}this._cachedIndex=n,this.intervalChanged_(n,r,i)}return this.interpolate_(n,r,e,i)}getSettings_(){return this.settings||this.DefaultSettings_}copySampleValue_(e){const t=this.resultBuffer,n=this.sampleValues,i=this.valueSize,r=e*i;for(let e=0;e!==i;++e)t[e]=n[r+e];return t}interpolate_(){throw new Error("call to abstract method")}intervalChanged_(){}}class Il extends Tl{constructor(e,t,n,i){super(e,t,n,i),this._weightPrev=-0,this._offsetPrev=-0,this._weightNext=-0,this._offsetNext=-0,this.DefaultSettings_={endingStart:2400,endingEnd:2400}}intervalChanged_(e,t,n){const i=this.parameterPositions;let r=e-2,s=e+1,a=i[r],o=i[s];if(void 0===a)switch(this.getSettings_().endingStart){case 2401:r=e,a=2*t-n;break;case 2402:r=i.length-2,a=t+i[r]-i[r+1];break;default:r=e,a=n}if(void 0===o)switch(this.getSettings_().endingEnd){case 2401:s=e,o=2*n-t;break;case 2402:s=1,o=n+i[1]-i[0];break;default:s=e-1,o=t}const l=.5*(n-t),c=this.valueSize;this._weightPrev=l/(t-a),this._weightNext=l/(o-n),this._offsetPrev=r*c,this._offsetNext=s*c}interpolate_(e,t,n,i){const r=this.resultBuffer,s=this.sampleValues,a=this.valueSize,o=e*a,l=o-a,c=this._offsetPrev,h=this._offsetNext,u=this._weightPrev,d=this._weightNext,p=(n-t)/(i-t),f=p*p,m=f*p,g=-u*m+2*u*f-u*p,A=(1+u)*m+(-1.5-2*u)*f+(-.5+u)*p+1,y=(-1-d)*m+(1.5+d)*f+.5*p,v=d*m-d*f;for(let e=0;e!==a;++e)r[e]=g*s[c+e]+A*s[l+e]+y*s[o+e]+v*s[h+e];return r}}class Rl extends Tl{constructor(e,t,n,i){super(e,t,n,i)}interpolate_(e,t,n,i){const r=this.resultBuffer,s=this.sampleValues,a=this.valueSize,o=e*a,l=o-a,c=(n-t)/(i-t),h=1-c;for(let e=0;e!==a;++e)r[e]=s[l+e]*h+s[o+e]*c;return r}}class Bl extends Tl{constructor(e,t,n,i){super(e,t,n,i)}interpolate_(e){return this.copySampleValue_(e-1)}}class Ll{constructor(e,t,n,i){if(void 0===e)throw new Error("THREE.KeyframeTrack: track name is undefined");if(void 0===t||0===t.length)throw new Error("THREE.KeyframeTrack: no keyframes in track named "+e);this.name=e,this.times=wl(t,this.TimeBufferType),this.values=wl(n,this.ValueBufferType),this.setInterpolation(i||this.DefaultInterpolation)}static toJSON(e){const t=e.constructor;let n;if(t.toJSON!==this.toJSON)n=t.toJSON(e);else{n={name:e.name,times:wl(e.times,Array),values:wl(e.values,Array)};const t=e.getInterpolation();t!==e.DefaultInterpolation&&(n.interpolation=t)}return n.type=e.ValueTypeName,n}InterpolantFactoryMethodDiscrete(e){return new Bl(this.times,this.values,this.getValueSize(),e)}InterpolantFactoryMethodLinear(e){return new Rl(this.times,this.values,this.getValueSize(),e)}InterpolantFactoryMethodSmooth(e){return new Il(this.times,this.values,this.getValueSize(),e)}setInterpolation(e){let t;switch(e){case We:t=this.InterpolantFactoryMethodDiscrete;break;case Ye:t=this.InterpolantFactoryMethodLinear;break;case Xe:t=this.InterpolantFactoryMethodSmooth}if(void 0===t){const t="unsupported interpolation for "+this.ValueTypeName+" keyframe track named "+this.name;if(void 0===this.createInterpolant){if(e===this.DefaultInterpolation)throw new Error(t);this.setInterpolation(this.DefaultInterpolation)}return console.warn("THREE.KeyframeTrack:",t),this}return this.createInterpolant=t,this}getInterpolation(){switch(this.createInterpolant){case this.InterpolantFactoryMethodDiscrete:return We;case this.InterpolantFactoryMethodLinear:return Ye;case this.InterpolantFactoryMethodSmooth:return Xe}}getValueSize(){return this.values.length/this.times.length}shift(e){if(0!==e){const t=this.times;for(let n=0,i=t.length;n!==i;++n)t[n]+=e}return this}scale(e){if(1!==e){const t=this.times;for(let n=0,i=t.length;n!==i;++n)t[n]*=e}return this}trim(e,t){const n=this.times,i=n.length;let r=0,s=i-1;for(;r!==i&&n[r]<e;)++r;for(;-1!==s&&n[s]>t;)--s;if(++s,0!==r||s!==i){r>=s&&(s=Math.max(s,1),r=s-1);const e=this.getValueSize();this.times=n.slice(r,s),this.values=this.values.slice(r*e,s*e)}return this}validate(){let e=!0;const t=this.getValueSize();t-Math.floor(t)!=0&&(console.error("THREE.KeyframeTrack: Invalid value size in track.",this),e=!1);const n=this.times,i=this.values,r=n.length;0===r&&(console.error("THREE.KeyframeTrack: Track is empty.",this),e=!1);let s=null;for(let t=0;t!==r;t++){const i=n[t];if("number"==typeof i&&isNaN(i)){console.error("THREE.KeyframeTrack: Time is not a valid number.",this,t,i),e=!1;break}if(null!==s&&s>i){console.error("THREE.KeyframeTrack: Out of order keys.",this,t,i,s),e=!1;break}s=i}if(void 0!==i&&(a=i,ArrayBuffer.isView(a)&&!(a instanceof DataView)))for(let t=0,n=i.length;t!==n;++t){const n=i[t];if(isNaN(n)){console.error("THREE.KeyframeTrack: Value is not a valid number.",this,t,n),e=!1;break}}var a;return e}optimize(){const e=this.times.slice(),t=this.values.slice(),n=this.getValueSize(),i=this.getInterpolation()===Xe,r=e.length-1;let s=1;for(let a=1;a<r;++a){let r=!1;const o=e[a];if(o!==e[a+1]&&(1!==a||o!==e[0]))if(i)r=!0;else{const e=a*n,i=e-n,s=e+n;for(let a=0;a!==n;++a){const n=t[e+a];if(n!==t[i+a]||n!==t[s+a]){r=!0;break}}}if(r){if(a!==s){e[s]=e[a];const i=a*n,r=s*n;for(let e=0;e!==n;++e)t[r+e]=t[i+e]}++s}}if(r>0){e[s]=e[r];for(let e=r*n,i=s*n,a=0;a!==n;++a)t[i+a]=t[e+a];++s}return s!==e.length?(this.times=e.slice(0,s),this.values=t.slice(0,s*n)):(this.times=e,this.values=t),this}clone(){const e=this.times.slice(),t=this.values.slice(),n=new(0,this.constructor)(this.name,e,t);return n.createInterpolant=this.createInterpolant,n}}Ll.prototype.TimeBufferType=Float32Array,Ll.prototype.ValueBufferType=Float32Array,Ll.prototype.DefaultInterpolation=Ye;class Pl extends Ll{constructor(e,t,n){super(e,t,n)}}Pl.prototype.ValueTypeName="bool",Pl.prototype.ValueBufferType=Array,Pl.prototype.DefaultInterpolation=We,Pl.prototype.InterpolantFactoryMethodLinear=void 0,Pl.prototype.InterpolantFactoryMethodSmooth=void 0;class Dl extends Ll{}Dl.prototype.ValueTypeName="color";class Nl extends Ll{}Nl.prototype.ValueTypeName="number";class Ul extends Tl{constructor(e,t,n,i){super(e,t,n,i)}interpolate_(e,t,n,i){const r=this.resultBuffer,s=this.sampleValues,a=this.valueSize,o=(n-t)/(i-t);let l=e*a;for(let e=l+a;l!==e;l+=4)rn.slerpFlat(r,0,s,l-a,s,l,o);return r}}class Ol extends Ll{InterpolantFactoryMethodLinear(e){return new Ul(this.times,this.values,this.getValueSize(),e)}}Ol.prototype.ValueTypeName="quaternion",Ol.prototype.InterpolantFactoryMethodSmooth=void 0;class Fl extends Ll{constructor(e,t,n){super(e,t,n)}}Fl.prototype.ValueTypeName="string",Fl.prototype.ValueBufferType=Array,Fl.prototype.DefaultInterpolation=We,Fl.prototype.InterpolantFactoryMethodLinear=void 0,Fl.prototype.InterpolantFactoryMethodSmooth=void 0;class kl extends Ll{}kl.prototype.ValueTypeName="vector";class Ql{constructor(e="",t=-1,n=[],i=2500){this.name=e,this.tracks=n,this.duration=t,this.blendMode=i,this.uuid=Et(),this.duration<0&&this.resetDuration()}static parse(e){const t=[],n=e.tracks,i=1/(e.fps||1);for(let e=0,r=n.length;e!==r;++e)t.push(zl(n[e]).scale(i));const r=new this(e.name,e.duration,t,e.blendMode);return r.uuid=e.uuid,r}static toJSON(e){const t=[],n=e.tracks,i={name:e.name,duration:e.duration,tracks:t,uuid:e.uuid,blendMode:e.blendMode};for(let e=0,i=n.length;e!==i;++e)t.push(Ll.toJSON(n[e]));return i}static CreateFromMorphTargetSequence(e,t,n,i){const r=t.length,s=[];for(let e=0;e<r;e++){let a=[],o=[];a.push((e+r-1)%r,e,(e+1)%r),o.push(0,1,0);const l=Ml(a);a=Sl(a,1,l),o=Sl(o,1,l),i||0!==a[0]||(a.push(r),o.push(o[0])),s.push(new Nl(".morphTargetInfluences["+t[e].name+"]",a,o).scale(1/n))}return new this(e,-1,s)}static findByName(e,t){let n=e;if(!Array.isArray(e)){const t=e;n=t.geometry&&t.geometry.animations||t.animations}for(let e=0;e<n.length;e++)if(n[e].name===t)return n[e];return null}static CreateClipsFromMorphTargetSequences(e,t,n){const i={},r=/^([\w-]*?)([\d]+)$/;for(let t=0,n=e.length;t<n;t++){const n=e[t],s=n.name.match(r);if(s&&s.length>1){const e=s[1];let t=i[e];t||(i[e]=t=[]),t.push(n)}}const s=[];for(const e in i)s.push(this.CreateFromMorphTargetSequence(e,i[e],t,n));return s}static parseAnimation(e,t){if(!e)return console.error("THREE.AnimationClip: No animation in JSONLoader data."),null;const n=function(e,t,n,i,r){if(0!==n.length){const s=[],a=[];Cl(n,s,a,i),0!==s.length&&r.push(new e(t,s,a))}},i=[],r=e.name||"default",s=e.fps||30,a=e.blendMode;let o=e.length||-1;const l=e.hierarchy||[];for(let e=0;e<l.length;e++){const r=l[e].keys;if(r&&0!==r.length)if(r[0].morphTargets){const e={};let t;for(t=0;t<r.length;t++)if(r[t].morphTargets)for(let n=0;n<r[t].morphTargets.length;n++)e[r[t].morphTargets[n]]=-1;for(const n in e){const e=[],s=[];for(let i=0;i!==r[t].morphTargets.length;++i){const i=r[t];e.push(i.time),s.push(i.morphTarget===n?1:0)}i.push(new Nl(".morphTargetInfluence["+n+"]",e,s))}o=e.length*s}else{const s=".bones["+t[e].name+"]";n(kl,s+".position",r,"pos",i),n(Ol,s+".quaternion",r,"rot",i),n(kl,s+".scale",r,"scl",i)}}return 0===i.length?null:new this(r,o,i,a)}resetDuration(){let e=0;for(let t=0,n=this.tracks.length;t!==n;++t){const n=this.tracks[t];e=Math.max(e,n.times[n.times.length-1])}return this.duration=e,this}trim(){for(let e=0;e<this.tracks.length;e++)this.tracks[e].trim(0,this.duration);return this}validate(){let e=!0;for(let t=0;t<this.tracks.length;t++)e=e&&this.tracks[t].validate();return e}optimize(){for(let e=0;e<this.tracks.length;e++)this.tracks[e].optimize();return this}clone(){const e=[];for(let t=0;t<this.tracks.length;t++)e.push(this.tracks[t].clone());return new this.constructor(this.name,this.duration,e,this.blendMode)}toJSON(){return this.constructor.toJSON(this)}}function zl(e){if(void 0===e.type)throw new Error("THREE.KeyframeTrack: track type undefined, can not parse");const t=function(e){switch(e.toLowerCase()){case"scalar":case"double":case"float":case"number":case"integer":return Nl;case"vector":case"vector2":case"vector3":case"vector4":return kl;case"color":return Dl;case"quaternion":return Ol;case"bool":case"boolean":return Pl;case"string":return Fl}throw new Error("THREE.KeyframeTrack: Unsupported typeName: "+e)}(e.type);if(void 0===e.times){const t=[],n=[];Cl(e.keys,t,n,"value"),e.times=t,e.values=n}return void 0!==t.parse?t.parse(e):new t(e.name,e.times,e.values,e.interpolation)}const Gl={enabled:!1,files:{},add:function(e,t){!1!==this.enabled&&(this.files[e]=t)},get:function(e){if(!1!==this.enabled)return this.files[e]},remove:function(e){delete this.files[e]},clear:function(){this.files={}}};class Hl{constructor(e,t,n){const i=this;let r,s=!1,a=0,o=0;const l=[];this.onStart=void 0,this.onLoad=e,this.onProgress=t,this.onError=n,this.itemStart=function(e){o++,!1===s&&void 0!==i.onStart&&i.onStart(e,a,o),s=!0},this.itemEnd=function(e){a++,void 0!==i.onProgress&&i.onProgress(e,a,o),a===o&&(s=!1,void 0!==i.onLoad&&i.onLoad())},this.itemError=function(e){void 0!==i.onError&&i.onError(e)},this.resolveURL=function(e){return r?r(e):e},this.setURLModifier=function(e){return r=e,this},this.addHandler=function(e,t){return l.push(e,t),this},this.removeHandler=function(e){const t=l.indexOf(e);return-1!==t&&l.splice(t,2),this},this.getHandler=function(e){for(let t=0,n=l.length;t<n;t+=2){const n=l[t],i=l[t+1];if(n.global&&(n.lastIndex=0),n.test(e))return i}return null}}}const Vl=new Hl;class jl{constructor(e){this.manager=void 0!==e?e:Vl,this.crossOrigin="anonymous",this.withCredentials=!1,this.path="",this.resourcePath="",this.requestHeader={}}load(){}loadAsync(e,t){const n=this;return new Promise((function(i,r){n.load(e,i,t,r)}))}parse(){}setCrossOrigin(e){return this.crossOrigin=e,this}setWithCredentials(e){return this.withCredentials=e,this}setPath(e){return this.path=e,this}setResourcePath(e){return this.resourcePath=e,this}setRequestHeader(e){return this.requestHeader=e,this}}jl.DEFAULT_MATERIAL_NAME="__DEFAULT";const ql={};class Wl extends Error{constructor(e,t){super(e),this.response=t}}class Yl extends jl{constructor(e){super(e)}load(e,t,n,i){void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);const r=Gl.get(e);if(void 0!==r)return this.manager.itemStart(e),setTimeout((()=>{t&&t(r),this.manager.itemEnd(e)}),0),r;if(void 0!==ql[e])return void ql[e].push({onLoad:t,onProgress:n,onError:i});ql[e]=[],ql[e].push({onLoad:t,onProgress:n,onError:i});const s=new Request(e,{headers:new Headers(this.requestHeader),credentials:this.withCredentials?"include":"same-origin"}),a=this.mimeType,o=this.responseType;fetch(s).then((t=>{if(200===t.status||0===t.status){if(0===t.status&&console.warn("THREE.FileLoader: HTTP Status 0 received."),"undefined"==typeof ReadableStream||void 0===t.body||void 0===t.body.getReader)return t;const n=ql[e],i=t.body.getReader(),r=t.headers.get("X-File-Size")||t.headers.get("Content-Length"),s=r?parseInt(r):0,a=0!==s;let o=0;const l=new ReadableStream({start(e){!function t(){i.read().then((({done:i,value:r})=>{if(i)e.close();else{o+=r.byteLength;const i=new ProgressEvent("progress",{lengthComputable:a,loaded:o,total:s});for(let e=0,t=n.length;e<t;e++){const t=n[e];t.onProgress&&t.onProgress(i)}e.enqueue(r),t()}}),(t=>{e.error(t)}))}()}});return new Response(l)}throw new Wl(`fetch for "${t.url}" responded with ${t.status}: ${t.statusText}`,t)})).then((e=>{switch(o){case"arraybuffer":return e.arrayBuffer();case"blob":return e.blob();case"document":return e.text().then((e=>(new DOMParser).parseFromString(e,a)));case"json":return e.json();default:if(void 0===a)return e.text();{const t=/charset="?([^;"\s]*)"?/i.exec(a),n=t&&t[1]?t[1].toLowerCase():void 0,i=new TextDecoder(n);return e.arrayBuffer().then((e=>i.decode(e)))}}})).then((t=>{Gl.add(e,t);const n=ql[e];delete ql[e];for(let e=0,i=n.length;e<i;e++){const i=n[e];i.onLoad&&i.onLoad(t)}})).catch((t=>{const n=ql[e];if(void 0===n)throw this.manager.itemError(e),t;delete ql[e];for(let e=0,i=n.length;e<i;e++){const i=n[e];i.onError&&i.onError(t)}this.manager.itemError(e)})).finally((()=>{this.manager.itemEnd(e)})),this.manager.itemStart(e)}setResponseType(e){return this.responseType=e,this}setMimeType(e){return this.mimeType=e,this}}class Xl extends jl{constructor(e){super(e)}load(e,t,n,i){void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);const r=this,s=Gl.get(e);if(void 0!==s)return r.manager.itemStart(e),setTimeout((function(){t&&t(s),r.manager.itemEnd(e)}),0),s;const a=Pt("img");function o(){c(),Gl.add(e,this),t&&t(this),r.manager.itemEnd(e)}function l(t){c(),i&&i(t),r.manager.itemError(e),r.manager.itemEnd(e)}function c(){a.removeEventListener("load",o,!1),a.removeEventListener("error",l,!1)}return a.addEventListener("load",o,!1),a.addEventListener("error",l,!1),"data:"!==e.slice(0,5)&&void 0!==this.crossOrigin&&(a.crossOrigin=this.crossOrigin),r.manager.itemStart(e),a.src=e,a}}class Kl extends jl{constructor(e){super(e)}load(e,t,n,i){const r=new Jt,s=new Xl(this.manager);return s.setCrossOrigin(this.crossOrigin),s.setPath(this.path),s.load(e,(function(e){r.image=e,r.needsUpdate=!0,void 0!==t&&t(r)}),n,i),r}}class Jl extends li{constructor(e,t=1){super(),this.isLight=!0,this.type="Light",this.color=new Ci(e),this.intensity=t}dispose(){}copy(e,t){return super.copy(e,t),this.color.copy(e.color),this.intensity=e.intensity,this}toJSON(e){const t=super.toJSON(e);return t.object.color=this.color.getHex(),t.object.intensity=this.intensity,void 0!==this.groundColor&&(t.object.groundColor=this.groundColor.getHex()),void 0!==this.distance&&(t.object.distance=this.distance),void 0!==this.angle&&(t.object.angle=this.angle),void 0!==this.decay&&(t.object.decay=this.decay),void 0!==this.penumbra&&(t.object.penumbra=this.penumbra),void 0!==this.shadow&&(t.object.shadow=this.shadow.toJSON()),void 0!==this.target&&(t.object.target=this.target.uuid),t}}const $l=new Nn,Zl=new sn,ec=new sn;class tc{constructor(e){this.camera=e,this.intensity=1,this.bias=0,this.normalBias=0,this.radius=1,this.blurSamples=8,this.mapSize=new It(512,512),this.map=null,this.mapPass=null,this.matrix=new Nn,this.autoUpdate=!0,this.needsUpdate=!1,this._frustum=new Sr,this._frameExtents=new It(1,1),this._viewportCount=1,this._viewports=[new $t(0,0,1,1)]}getViewportCount(){return this._viewportCount}getFrustum(){return this._frustum}updateMatrices(e){const t=this.camera,n=this.matrix;Zl.setFromMatrixPosition(e.matrixWorld),t.position.copy(Zl),ec.setFromMatrixPosition(e.target.matrixWorld),t.lookAt(ec),t.updateMatrixWorld(),$l.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),this._frustum.setFromProjectionMatrix($l),n.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),n.multiply($l)}getViewport(e){return this._viewports[e]}getFrameExtents(){return this._frameExtents}dispose(){this.map&&this.map.dispose(),this.mapPass&&this.mapPass.dispose()}copy(e){return this.camera=e.camera.clone(),this.intensity=e.intensity,this.bias=e.bias,this.radius=e.radius,this.mapSize.copy(e.mapSize),this}clone(){return(new this.constructor).copy(this)}toJSON(){const e={};return 1!==this.intensity&&(e.intensity=this.intensity),0!==this.bias&&(e.bias=this.bias),0!==this.normalBias&&(e.normalBias=this.normalBias),1!==this.radius&&(e.radius=this.radius),512===this.mapSize.x&&512===this.mapSize.y||(e.mapSize=this.mapSize.toArray()),e.camera=this.camera.toJSON(!1).object,delete e.camera.matrix,e}}class nc extends tc{constructor(){super(new mr(50,1,.5,500)),this.isSpotLightShadow=!0,this.focus=1}updateMatrices(e){const t=this.camera,n=2*xt*e.angle*this.focus,i=this.mapSize.width/this.mapSize.height,r=e.distance||t.far;n===t.fov&&i===t.aspect&&r===t.far||(t.fov=n,t.aspect=i,t.far=r,t.updateProjectionMatrix()),super.updateMatrices(e)}copy(e){return super.copy(e),this.focus=e.focus,this}}class ic extends Jl{constructor(e,t,n=0,i=Math.PI/3,r=0,s=2){super(e,t),this.isSpotLight=!0,this.type="SpotLight",this.position.copy(li.DEFAULT_UP),this.updateMatrix(),this.target=new li,this.distance=n,this.angle=i,this.penumbra=r,this.decay=s,this.map=null,this.shadow=new nc}get power(){return this.intensity*Math.PI}set power(e){this.intensity=e/Math.PI}dispose(){this.shadow.dispose()}copy(e,t){return super.copy(e,t),this.distance=e.distance,this.angle=e.angle,this.penumbra=e.penumbra,this.decay=e.decay,this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}}const rc=new Nn,sc=new sn,ac=new sn;class oc extends tc{constructor(){super(new mr(90,1,.5,500)),this.isPointLightShadow=!0,this._frameExtents=new It(4,2),this._viewportCount=6,this._viewports=[new $t(2,1,1,1),new $t(0,1,1,1),new $t(3,1,1,1),new $t(1,1,1,1),new $t(3,0,1,1),new $t(1,0,1,1)],this._cubeDirections=[new sn(1,0,0),new sn(-1,0,0),new sn(0,0,1),new sn(0,0,-1),new sn(0,1,0),new sn(0,-1,0)],this._cubeUps=[new sn(0,1,0),new sn(0,1,0),new sn(0,1,0),new sn(0,1,0),new sn(0,0,1),new sn(0,0,-1)]}updateMatrices(e,t=0){const n=this.camera,i=this.matrix,r=e.distance||n.far;r!==n.far&&(n.far=r,n.updateProjectionMatrix()),sc.setFromMatrixPosition(e.matrixWorld),n.position.copy(sc),ac.copy(n.position),ac.add(this._cubeDirections[t]),n.up.copy(this._cubeUps[t]),n.lookAt(ac),n.updateMatrixWorld(),i.makeTranslation(-sc.x,-sc.y,-sc.z),rc.multiplyMatrices(n.projectionMatrix,n.matrixWorldInverse),this._frustum.setFromProjectionMatrix(rc)}}class lc extends Jl{constructor(e,t,n=0,i=2){super(e,t),this.isPointLight=!0,this.type="PointLight",this.distance=n,this.decay=i,this.shadow=new oc}get power(){return 4*this.intensity*Math.PI}set power(e){this.intensity=e/(4*Math.PI)}dispose(){this.shadow.dispose()}copy(e,t){return super.copy(e,t),this.distance=e.distance,this.decay=e.decay,this.shadow=e.shadow.clone(),this}}class cc extends tc{constructor(){super(new Gr(-5,5,5,-5,.5,500)),this.isDirectionalLightShadow=!0}}class hc extends Jl{constructor(e,t){super(e,t),this.isDirectionalLight=!0,this.type="DirectionalLight",this.position.copy(li.DEFAULT_UP),this.updateMatrix(),this.target=new li,this.shadow=new cc}dispose(){this.shadow.dispose()}copy(e){return super.copy(e),this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}}class uc extends Jl{constructor(e,t){super(e,t),this.isAmbientLight=!0,this.type="AmbientLight"}}class dc{static decodeText(e){if(console.warn("THREE.LoaderUtils: decodeText() has been deprecated with r165 and will be removed with r175. Use TextDecoder instead."),"undefined"!=typeof TextDecoder)return(new TextDecoder).decode(e);let t="";for(let n=0,i=e.length;n<i;n++)t+=String.fromCharCode(e[n]);try{return decodeURIComponent(escape(t))}catch(e){return t}}static extractUrlBase(e){const t=e.lastIndexOf("/");return-1===t?"./":e.slice(0,t+1)}static resolveURL(e,t){return"string"!=typeof e||""===e?"":(/^https?:\/\//i.test(t)&&/^\//.test(e)&&(t=t.replace(/(^https?:\/\/[^\/]+).*/i,"$1")),/^(https?:)?\/\//i.test(e)||/^data:.*,.*$/i.test(e)||/^blob:.*$/i.test(e)?e:t+e)}}class pc extends jl{constructor(e){super(e),this.isImageBitmapLoader=!0,"undefined"==typeof createImageBitmap&&console.warn("THREE.ImageBitmapLoader: createImageBitmap() not supported."),"undefined"==typeof fetch&&console.warn("THREE.ImageBitmapLoader: fetch() not supported."),this.options={premultiplyAlpha:"none"}}setOptions(e){return this.options=e,this}load(e,t,n,i){void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e),e=this.manager.resolveURL(e);const r=this,s=Gl.get(e);if(void 0!==s)return r.manager.itemStart(e),s.then?void s.then((n=>{t&&t(n),r.manager.itemEnd(e)})).catch((e=>{i&&i(e)})):(setTimeout((function(){t&&t(s),r.manager.itemEnd(e)}),0),s);const a={};a.credentials="anonymous"===this.crossOrigin?"same-origin":"include",a.headers=this.requestHeader;const o=fetch(e,a).then((function(e){return e.blob()})).then((function(e){return createImageBitmap(e,Object.assign(r.options,{colorSpaceConversion:"none"}))})).then((function(n){return Gl.add(e,n),t&&t(n),r.manager.itemEnd(e),n})).catch((function(t){i&&i(t),Gl.remove(e),r.manager.itemError(e),r.manager.itemEnd(e)}));Gl.add(e,o),r.manager.itemStart(e)}}const fc="\\[\\]\\.:\\/",mc=new RegExp("["+fc+"]","g"),gc="[^"+fc+"]",Ac="[^"+fc.replace("\\.","")+"]",yc=new RegExp("^"+/((?:WC+[\/:])*)/.source.replace("WC",gc)+/(WCOD+)?/.source.replace("WCOD",Ac)+/(?:\.(WC+)(?:\[(.+)\])?)?/.source.replace("WC",gc)+/\.(WC+)(?:\[(.+)\])?/.source.replace("WC",gc)+"$"),vc=["material","materials","bones","map"];class _c{constructor(e,t,n){this.path=t,this.parsedPath=n||_c.parseTrackName(t),this.node=_c.findNode(e,this.parsedPath.nodeName),this.rootNode=e,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}static create(e,t,n){return e&&e.isAnimationObjectGroup?new _c.Composite(e,t,n):new _c(e,t,n)}static sanitizeNodeName(e){return e.replace(/\s/g,"_").replace(mc,"")}static parseTrackName(e){const t=yc.exec(e);if(null===t)throw new Error("PropertyBinding: Cannot parse trackName: "+e);const n={nodeName:t[2],objectName:t[3],objectIndex:t[4],propertyName:t[5],propertyIndex:t[6]},i=n.nodeName&&n.nodeName.lastIndexOf(".");if(void 0!==i&&-1!==i){const e=n.nodeName.substring(i+1);-1!==vc.indexOf(e)&&(n.nodeName=n.nodeName.substring(0,i),n.objectName=e)}if(null===n.propertyName||0===n.propertyName.length)throw new Error("PropertyBinding: can not parse propertyName from trackName: "+e);return n}static findNode(e,t){if(void 0===t||""===t||"."===t||-1===t||t===e.name||t===e.uuid)return e;if(e.skeleton){const n=e.skeleton.getBoneByName(t);if(void 0!==n)return n}if(e.children){const n=function(e){for(let i=0;i<e.length;i++){const r=e[i];if(r.name===t||r.uuid===t)return r;const s=n(r.children);if(s)return s}return null},i=n(e.children);if(i)return i}return null}_getValue_unavailable(){}_setValue_unavailable(){}_getValue_direct(e,t){e[t]=this.targetObject[this.propertyName]}_getValue_array(e,t){const n=this.resolvedProperty;for(let i=0,r=n.length;i!==r;++i)e[t++]=n[i]}_getValue_arrayElement(e,t){e[t]=this.resolvedProperty[this.propertyIndex]}_getValue_toArray(e,t){this.resolvedProperty.toArray(e,t)}_setValue_direct(e,t){this.targetObject[this.propertyName]=e[t]}_setValue_direct_setNeedsUpdate(e,t){this.targetObject[this.propertyName]=e[t],this.targetObject.needsUpdate=!0}_setValue_direct_setMatrixWorldNeedsUpdate(e,t){this.targetObject[this.propertyName]=e[t],this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_array(e,t){const n=this.resolvedProperty;for(let i=0,r=n.length;i!==r;++i)n[i]=e[t++]}_setValue_array_setNeedsUpdate(e,t){const n=this.resolvedProperty;for(let i=0,r=n.length;i!==r;++i)n[i]=e[t++];this.targetObject.needsUpdate=!0}_setValue_array_setMatrixWorldNeedsUpdate(e,t){const n=this.resolvedProperty;for(let i=0,r=n.length;i!==r;++i)n[i]=e[t++];this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_arrayElement(e,t){this.resolvedProperty[this.propertyIndex]=e[t]}_setValue_arrayElement_setNeedsUpdate(e,t){this.resolvedProperty[this.propertyIndex]=e[t],this.targetObject.needsUpdate=!0}_setValue_arrayElement_setMatrixWorldNeedsUpdate(e,t){this.resolvedProperty[this.propertyIndex]=e[t],this.targetObject.matrixWorldNeedsUpdate=!0}_setValue_fromArray(e,t){this.resolvedProperty.fromArray(e,t)}_setValue_fromArray_setNeedsUpdate(e,t){this.resolvedProperty.fromArray(e,t),this.targetObject.needsUpdate=!0}_setValue_fromArray_setMatrixWorldNeedsUpdate(e,t){this.resolvedProperty.fromArray(e,t),this.targetObject.matrixWorldNeedsUpdate=!0}_getValue_unbound(e,t){this.bind(),this.getValue(e,t)}_setValue_unbound(e,t){this.bind(),this.setValue(e,t)}bind(){let e=this.node;const t=this.parsedPath,n=t.objectName,i=t.propertyName;let r=t.propertyIndex;if(e||(e=_c.findNode(this.rootNode,t.nodeName),this.node=e),this.getValue=this._getValue_unavailable,this.setValue=this._setValue_unavailable,!e)return void console.warn("THREE.PropertyBinding: No target node found for track: "+this.path+".");if(n){let i=t.objectIndex;switch(n){case"materials":if(!e.material)return void console.error("THREE.PropertyBinding: Can not bind to material as node does not have a material.",this);if(!e.material.materials)return void console.error("THREE.PropertyBinding: Can not bind to material.materials as node.material does not have a materials array.",this);e=e.material.materials;break;case"bones":if(!e.skeleton)return void console.error("THREE.PropertyBinding: Can not bind to bones as node does not have a skeleton.",this);e=e.skeleton.bones;for(let t=0;t<e.length;t++)if(e[t].name===i){i=t;break}break;case"map":if("map"in e){e=e.map;break}if(!e.material)return void console.error("THREE.PropertyBinding: Can not bind to material as node does not have a material.",this);if(!e.material.map)return void console.error("THREE.PropertyBinding: Can not bind to material.map as node.material does not have a map.",this);e=e.material.map;break;default:if(void 0===e[n])return void console.error("THREE.PropertyBinding: Can not bind to objectName of node undefined.",this);e=e[n]}if(void 0!==i){if(void 0===e[i])return void console.error("THREE.PropertyBinding: Trying to bind to objectIndex of objectName, but is undefined.",this,e);e=e[i]}}const s=e[i];if(void 0===s){const n=t.nodeName;return void console.error("THREE.PropertyBinding: Trying to update property for track: "+n+"."+i+" but it wasn't found.",e)}let a=this.Versioning.None;this.targetObject=e,void 0!==e.needsUpdate?a=this.Versioning.NeedsUpdate:void 0!==e.matrixWorldNeedsUpdate&&(a=this.Versioning.MatrixWorldNeedsUpdate);let o=this.BindingType.Direct;if(void 0!==r){if("morphTargetInfluences"===i){if(!e.geometry)return void console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.",this);if(!e.geometry.morphAttributes)return void console.error("THREE.PropertyBinding: Can not bind to morphTargetInfluences because node does not have a geometry.morphAttributes.",this);void 0!==e.morphTargetDictionary[r]&&(r=e.morphTargetDictionary[r])}o=this.BindingType.ArrayElement,this.resolvedProperty=s,this.propertyIndex=r}else void 0!==s.fromArray&&void 0!==s.toArray?(o=this.BindingType.HasFromToArray,this.resolvedProperty=s):Array.isArray(s)?(o=this.BindingType.EntireArray,this.resolvedProperty=s):this.propertyName=i;this.getValue=this.GetterByBindingType[o],this.setValue=this.SetterByBindingTypeAndVersioning[o][a]}unbind(){this.node=null,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}}_c.Composite=class{constructor(e,t,n){const i=n||_c.parseTrackName(t);this._targetGroup=e,this._bindings=e.subscribe_(t,i)}getValue(e,t){this.bind();const n=this._targetGroup.nCachedObjects_,i=this._bindings[n];void 0!==i&&i.getValue(e,t)}setValue(e,t){const n=this._bindings;for(let i=this._targetGroup.nCachedObjects_,r=n.length;i!==r;++i)n[i].setValue(e,t)}bind(){const e=this._bindings;for(let t=this._targetGroup.nCachedObjects_,n=e.length;t!==n;++t)e[t].bind()}unbind(){const e=this._bindings;for(let t=this._targetGroup.nCachedObjects_,n=e.length;t!==n;++t)e[t].unbind()}},_c.prototype.BindingType={Direct:0,EntireArray:1,ArrayElement:2,HasFromToArray:3},_c.prototype.Versioning={None:0,NeedsUpdate:1,MatrixWorldNeedsUpdate:2},_c.prototype.GetterByBindingType=[_c.prototype._getValue_direct,_c.prototype._getValue_array,_c.prototype._getValue_arrayElement,_c.prototype._getValue_toArray],_c.prototype.SetterByBindingTypeAndVersioning=[[_c.prototype._setValue_direct,_c.prototype._setValue_direct_setNeedsUpdate,_c.prototype._setValue_direct_setMatrixWorldNeedsUpdate],[_c.prototype._setValue_array,_c.prototype._setValue_array_setNeedsUpdate,_c.prototype._setValue_array_setMatrixWorldNeedsUpdate],[_c.prototype._setValue_arrayElement,_c.prototype._setValue_arrayElement_setNeedsUpdate,_c.prototype._setValue_arrayElement_setMatrixWorldNeedsUpdate],[_c.prototype._setValue_fromArray,_c.prototype._setValue_fromArray_setNeedsUpdate,_c.prototype._setValue_fromArray_setMatrixWorldNeedsUpdate]],new Float32Array(1);class xc{constructor(e){this.value=e}clone(){return new xc(void 0===this.value.clone?this.value:this.value.clone())}}const Ec=new Nn;class bc{constructor(e,t,n=0,i=1/0){this.ray=new Dn(e,t),this.near=n,this.far=i,this.camera=null,this.layers=new qn,this.params={Mesh:{},Line:{threshold:1},LOD:{},Points:{threshold:1},Sprite:{}}}set(e,t){this.ray.set(e,t)}setFromCamera(e,t){t.isPerspectiveCamera?(this.ray.origin.setFromMatrixPosition(t.matrixWorld),this.ray.direction.set(e.x,e.y,.5).unproject(t).sub(this.ray.origin).normalize(),this.camera=t):t.isOrthographicCamera?(this.ray.origin.set(e.x,e.y,(t.near+t.far)/(t.near-t.far)).unproject(t),this.ray.direction.set(0,0,-1).transformDirection(t.matrixWorld),this.camera=t):console.error("THREE.Raycaster: Unsupported camera type: "+t.type)}setFromXRController(e){return Ec.identity().extractRotation(e.matrixWorld),this.ray.origin.setFromMatrixPosition(e.matrixWorld),this.ray.direction.set(0,0,-1).applyMatrix4(Ec),this}intersectObject(e,t=!0,n=[]){return Mc(e,this,n,t),n.sort(wc),n}intersectObjects(e,t=!0,n=[]){for(let i=0,r=e.length;i<r;i++)Mc(e[i],this,n,t);return n.sort(wc),n}}function wc(e,t){return e.distance-t.distance}function Mc(e,t,n,i){let r=!0;if(e.layers.test(t.layers)&&!1===e.raycast(t,n)&&(r=!1),!0===r&&!0===i){const i=e.children;for(let e=0,r=i.length;e<r;e++)Mc(i[e],t,n,!0)}}class Sc{constructor(e=1,t=0,n=0){return this.radius=e,this.phi=t,this.theta=n,this}set(e,t,n){return this.radius=e,this.phi=t,this.theta=n,this}copy(e){return this.radius=e.radius,this.phi=e.phi,this.theta=e.theta,this}makeSafe(){const e=1e-6;return this.phi=Math.max(e,Math.min(Math.PI-e,this.phi)),this}setFromVector3(e){return this.setFromCartesianCoords(e.x,e.y,e.z)}setFromCartesianCoords(e,t,n){return this.radius=Math.sqrt(e*e+t*t+n*n),0===this.radius?(this.theta=0,this.phi=0):(this.theta=Math.atan2(e,n),this.phi=Math.acos(bt(t/this.radius,-1,1))),this}clone(){return(new this.constructor).copy(this)}}class Cc{constructor(e,t,n,i){Cc.prototype.isMatrix2=!0,this.elements=[1,0,0,1],void 0!==e&&this.set(e,t,n,i)}identity(){return this.set(1,0,0,1),this}fromArray(e,t=0){for(let n=0;n<4;n++)this.elements[n]=e[n+t];return this}set(e,t,n,i){const r=this.elements;return r[0]=e,r[2]=t,r[1]=n,r[3]=i,this}}const Tc=new It;class Ic{constructor(e=new It(1/0,1/0),t=new It(-1/0,-1/0)){this.isBox2=!0,this.min=e,this.max=t}set(e,t){return this.min.copy(e),this.max.copy(t),this}setFromPoints(e){this.makeEmpty();for(let t=0,n=e.length;t<n;t++)this.expandByPoint(e[t]);return this}setFromCenterAndSize(e,t){const n=Tc.copy(t).multiplyScalar(.5);return this.min.copy(e).sub(n),this.max.copy(e).add(n),this}clone(){return(new this.constructor).copy(this)}copy(e){return this.min.copy(e.min),this.max.copy(e.max),this}makeEmpty(){return this.min.x=this.min.y=1/0,this.max.x=this.max.y=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y}getCenter(e){return this.isEmpty()?e.set(0,0):e.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(e){return this.isEmpty()?e.set(0,0):e.subVectors(this.max,this.min)}expandByPoint(e){return this.min.min(e),this.max.max(e),this}expandByVector(e){return this.min.sub(e),this.max.add(e),this}expandByScalar(e){return this.min.addScalar(-e),this.max.addScalar(e),this}containsPoint(e){return e.x>=this.min.x&&e.x<=this.max.x&&e.y>=this.min.y&&e.y<=this.max.y}containsBox(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y}getParameter(e,t){return t.set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y))}intersectsBox(e){return e.max.x>=this.min.x&&e.min.x<=this.max.x&&e.max.y>=this.min.y&&e.min.y<=this.max.y}clampPoint(e,t){return t.copy(e).clamp(this.min,this.max)}distanceToPoint(e){return this.clampPoint(e,Tc).distanceTo(e)}intersect(e){return this.min.max(e.min),this.max.min(e.max),this.isEmpty()&&this.makeEmpty(),this}union(e){return this.min.min(e.min),this.max.max(e.max),this}translate(e){return this.min.add(e),this.max.add(e),this}equals(e){return e.min.equals(this.min)&&e.max.equals(this.max)}}"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("register",{detail:{revision:t}})),"undefined"!=typeof window&&(window.__THREE__?console.warn("WARNING: Multiple instances of Three.js being imported."):window.__THREE__=t);var Rc=6378137,Bc=.0066943799901413165,Lc=484813681109536e-20,Pc=Math.PI/2,Dc=1e-10,Nc=.017453292519943295,Uc=57.29577951308232,Oc=Math.PI/4,Fc=2*Math.PI,kc=3.14159265359,Qc={greenwich:0,lisbon:-9.131906111111,paris:2.337229166667,bogota:-74.080916666667,madrid:-3.687938888889,rome:12.452333333333,bern:7.439583333333,jakarta:106.807719444444,ferro:-17.666666666667,brussels:4.367975,stockholm:18.058277777778,athens:23.7163375,oslo:10.722916666667};const zc={mm:{to_meter:.001},cm:{to_meter:.01},ft:{to_meter:.3048},"us-ft":{to_meter:1200/3937},fath:{to_meter:1.8288},kmi:{to_meter:1852},"us-ch":{to_meter:20.1168402336805},"us-mi":{to_meter:1609.34721869444},km:{to_meter:1e3},"ind-ft":{to_meter:.30479841},"ind-yd":{to_meter:.91439523},mi:{to_meter:1609.344},yd:{to_meter:.9144},ch:{to_meter:20.1168},link:{to_meter:.201168},dm:{to_meter:.01},in:{to_meter:.0254},"ind-ch":{to_meter:20.11669506},"us-in":{to_meter:.025400050800101},"us-yd":{to_meter:.914401828803658}};var Gc=/[\s_\-\/\(\)]/g;function Hc(e,t){if(e[t])return e[t];for(var n,i=Object.keys(e),r=t.toLowerCase().replace(Gc,""),s=-1;++s<i.length;)if((n=i[s]).toLowerCase().replace(Gc,"")===r)return e[n]}function Vc(e){var t,n,i,r={},s=e.split("+").map((function(e){return e.trim()})).filter((function(e){return e})).reduce((function(e,t){var n=t.split("=");return n.push(!0),e[n[0].toLowerCase()]=n[1],e}),{}),a={proj:"projName",datum:"datumCode",rf:function(e){r.rf=parseFloat(e)},lat_0:function(e){r.lat0=e*Nc},lat_1:function(e){r.lat1=e*Nc},lat_2:function(e){r.lat2=e*Nc},lat_ts:function(e){r.lat_ts=e*Nc},lon_0:function(e){r.long0=e*Nc},lon_1:function(e){r.long1=e*Nc},lon_2:function(e){r.long2=e*Nc},alpha:function(e){r.alpha=parseFloat(e)*Nc},gamma:function(e){r.rectified_grid_angle=parseFloat(e)},lonc:function(e){r.longc=e*Nc},x_0:function(e){r.x0=parseFloat(e)},y_0:function(e){r.y0=parseFloat(e)},k_0:function(e){r.k0=parseFloat(e)},k:function(e){r.k0=parseFloat(e)},a:function(e){r.a=parseFloat(e)},b:function(e){r.b=parseFloat(e)},r:function(e){r.a=r.b=parseFloat(e)},r_a:function(){r.R_A=!0},zone:function(e){r.zone=parseInt(e,10)},south:function(){r.utmSouth=!0},towgs84:function(e){r.datum_params=e.split(",").map((function(e){return parseFloat(e)}))},to_meter:function(e){r.to_meter=parseFloat(e)},units:function(e){r.units=e;var t=Hc(zc,e);t&&(r.to_meter=t.to_meter)},from_greenwich:function(e){r.from_greenwich=e*Nc},pm:function(e){var t=Hc(Qc,e);r.from_greenwich=(t||parseFloat(e))*Nc},nadgrids:function(e){"@null"===e?r.datumCode="none":r.nadgrids=e},axis:function(e){var t="ewnsud";3===e.length&&-1!==t.indexOf(e.substr(0,1))&&-1!==t.indexOf(e.substr(1,1))&&-1!==t.indexOf(e.substr(2,1))&&(r.axis=e)},approx:function(){r.approx=!0}};for(t in s)n=s[t],t in a?"function"==typeof(i=a[t])?i(n):r[i]=n:r[t]=n;return"string"==typeof r.datumCode&&"WGS84"!==r.datumCode&&(r.datumCode=r.datumCode.toLowerCase()),r}var jc=1,qc=/\s/,Wc=/[A-Za-z]/,Yc=/[A-Za-z84_]/,Xc=/[,\]]/,Kc=/[\d\.E\-\+]/;function Jc(e){if("string"!=typeof e)throw new Error("not a string");this.text=e.trim(),this.level=0,this.place=0,this.root=null,this.stack=[],this.currentObject=null,this.state=jc}function $c(e,t,n){Array.isArray(t)&&(n.unshift(t),t=null);var i=t?{}:e,r=n.reduce((function(e,t){return Zc(t,e),e}),i);t&&(e[t]=r)}function Zc(e,t){if(Array.isArray(e)){var n=e.shift();if("PARAMETER"===n&&(n=e.shift()),1===e.length)return Array.isArray(e[0])?(t[n]={},void Zc(e[0],t[n])):void(t[n]=e[0]);if(e.length)if("TOWGS84"!==n){if("AXIS"===n)return n in t||(t[n]=[]),void t[n].push(e);var i;switch(Array.isArray(n)||(t[n]={}),n){case"UNIT":case"PRIMEM":case"VERT_DATUM":return t[n]={name:e[0].toLowerCase(),convert:e[1]},void(3===e.length&&Zc(e[2],t[n]));case"SPHEROID":case"ELLIPSOID":return t[n]={name:e[0],a:e[1],rf:e[2]},void(4===e.length&&Zc(e[3],t[n]));case"EDATUM":case"ENGINEERINGDATUM":case"LOCAL_DATUM":case"DATUM":case"VERT_CS":case"VERTCRS":case"VERTICALCRS":return e[0]=["name",e[0]],void $c(t,n,e);case"COMPD_CS":case"COMPOUNDCRS":case"FITTED_CS":case"PROJECTEDCRS":case"PROJCRS":case"GEOGCS":case"GEOCCS":case"PROJCS":case"LOCAL_CS":case"GEODCRS":case"GEODETICCRS":case"GEODETICDATUM":case"ENGCRS":case"ENGINEERINGCRS":return e[0]=["name",e[0]],$c(t,n,e),void(t[n].type=n);default:for(i=-1;++i<e.length;)if(!Array.isArray(e[i]))return Zc(e,t[n]);return $c(t,n,e)}}else t[n]=e;else t[n]=!0}else t[e]=!0}Jc.prototype.readCharicter=function(){var e=this.text[this.place++];if(4!==this.state)for(;qc.test(e);){if(this.place>=this.text.length)return;e=this.text[this.place++]}switch(this.state){case jc:return this.neutral(e);case 2:return this.keyword(e);case 4:return this.quoted(e);case 5:return this.afterquote(e);case 3:return this.number(e);case-1:return}},Jc.prototype.afterquote=function(e){if('"'===e)return this.word+='"',void(this.state=4);if(Xc.test(e))return this.word=this.word.trim(),void this.afterItem(e);throw new Error("havn't handled \""+e+'" in afterquote yet, index '+this.place)},Jc.prototype.afterItem=function(e){return","===e?(null!==this.word&&this.currentObject.push(this.word),this.word=null,void(this.state=jc)):"]"===e?(this.level--,null!==this.word&&(this.currentObject.push(this.word),this.word=null),this.state=jc,this.currentObject=this.stack.pop(),void(this.currentObject||(this.state=-1))):void 0},Jc.prototype.number=function(e){if(!Kc.test(e)){if(Xc.test(e))return this.word=parseFloat(this.word),void this.afterItem(e);throw new Error("havn't handled \""+e+'" in number yet, index '+this.place)}this.word+=e},Jc.prototype.quoted=function(e){'"'!==e?this.word+=e:this.state=5},Jc.prototype.keyword=function(e){if(Yc.test(e))this.word+=e;else{if("["===e){var t=[];return t.push(this.word),this.level++,null===this.root?this.root=t:this.currentObject.push(t),this.stack.push(this.currentObject),this.currentObject=t,void(this.state=jc)}if(!Xc.test(e))throw new Error("havn't handled \""+e+'" in keyword yet, index '+this.place);this.afterItem(e)}},Jc.prototype.neutral=function(e){if(Wc.test(e))return this.word=e,void(this.state=2);if('"'===e)return this.word="",void(this.state=4);if(Kc.test(e))return this.word=e,void(this.state=3);if(!Xc.test(e))throw new Error("havn't handled \""+e+'" in neutral yet, index '+this.place);this.afterItem(e)},Jc.prototype.output=function(){for(;this.place<this.text.length;)this.readCharicter();if(-1===this.state)return this.root;throw new Error('unable to parse string "'+this.text+'". State is '+this.state)};var eh=["PROJECTEDCRS","PROJCRS","GEOGCS","GEOCCS","PROJCS","LOCAL_CS","GEODCRS","GEODETICCRS","GEODETICDATUM","ENGCRS","ENGINEERINGCRS"];function th(e){return.017453292519943295*e}function nh(e){for(var t=Object.keys(e),n=0,i=t.length;n<i;++n){var r=t[n];-1!==eh.indexOf(r)&&ih(e[r]),"object"==typeof e[r]&&nh(e[r])}}function ih(e){if(e.AUTHORITY){var t=Object.keys(e.AUTHORITY)[0];t&&t in e.AUTHORITY&&(e.title=t+":"+e.AUTHORITY[t])}if("GEOGCS"===e.type?e.projName="longlat":"LOCAL_CS"===e.type?(e.projName="identity",e.local=!0):"object"==typeof e.PROJECTION?e.projName=Object.keys(e.PROJECTION)[0]:e.projName=e.PROJECTION,e.AXIS){for(var n="",i=0,r=e.AXIS.length;i<r;++i){var s=[e.AXIS[i][0].toLowerCase(),e.AXIS[i][1].toLowerCase()];-1!==s[0].indexOf("north")||("y"===s[0]||"lat"===s[0])&&"north"===s[1]?n+="n":-1!==s[0].indexOf("south")||("y"===s[0]||"lat"===s[0])&&"south"===s[1]?n+="s":-1!==s[0].indexOf("east")||("x"===s[0]||"lon"===s[0])&&"east"===s[1]?n+="e":-1===s[0].indexOf("west")&&("x"!==s[0]&&"lon"!==s[0]||"west"!==s[1])||(n+="w")}2===n.length&&(n+="u"),3===n.length&&(e.axis=n)}e.UNIT&&(e.units=e.UNIT.name.toLowerCase(),"metre"===e.units&&(e.units="meter"),e.UNIT.convert&&("GEOGCS"===e.type?e.DATUM&&e.DATUM.SPHEROID&&(e.to_meter=e.UNIT.convert*e.DATUM.SPHEROID.a):e.to_meter=e.UNIT.convert));var a=e.GEOGCS;function o(t){return t*(e.to_meter||1)}"GEOGCS"===e.type&&(a=e),a&&(a.DATUM?e.datumCode=a.DATUM.name.toLowerCase():e.datumCode=a.name.toLowerCase(),"d_"===e.datumCode.slice(0,2)&&(e.datumCode=e.datumCode.slice(2)),"new_zealand_1949"===e.datumCode&&(e.datumCode="nzgd49"),"wgs_1984"!==e.datumCode&&"world_geodetic_system_1984"!==e.datumCode||("Mercator_Auxiliary_Sphere"===e.PROJECTION&&(e.sphere=!0),e.datumCode="wgs84"),"belge_1972"===e.datumCode&&(e.datumCode="rnb72"),a.DATUM&&a.DATUM.SPHEROID&&(e.ellps=a.DATUM.SPHEROID.name.replace("_19","").replace(/[Cc]larke\_18/,"clrk"),"international"===e.ellps.toLowerCase().slice(0,13)&&(e.ellps="intl"),e.a=a.DATUM.SPHEROID.a,e.rf=parseFloat(a.DATUM.SPHEROID.rf,10)),a.DATUM&&a.DATUM.TOWGS84&&(e.datum_params=a.DATUM.TOWGS84),~e.datumCode.indexOf("osgb_1936")&&(e.datumCode="osgb36"),~e.datumCode.indexOf("osni_1952")&&(e.datumCode="osni52"),(~e.datumCode.indexOf("tm65")||~e.datumCode.indexOf("geodetic_datum_of_1965"))&&(e.datumCode="ire65"),"ch1903+"===e.datumCode&&(e.datumCode="ch1903"),~e.datumCode.indexOf("israel")&&(e.datumCode="isr93")),e.b&&!isFinite(e.b)&&(e.b=e.a),[["standard_parallel_1","Standard_Parallel_1"],["standard_parallel_1","Latitude of 1st standard parallel"],["standard_parallel_2","Standard_Parallel_2"],["standard_parallel_2","Latitude of 2nd standard parallel"],["false_easting","False_Easting"],["false_easting","False easting"],["false-easting","Easting at false origin"],["false_northing","False_Northing"],["false_northing","False northing"],["false_northing","Northing at false origin"],["central_meridian","Central_Meridian"],["central_meridian","Longitude of natural origin"],["central_meridian","Longitude of false origin"],["latitude_of_origin","Latitude_Of_Origin"],["latitude_of_origin","Central_Parallel"],["latitude_of_origin","Latitude of natural origin"],["latitude_of_origin","Latitude of false origin"],["scale_factor","Scale_Factor"],["k0","scale_factor"],["latitude_of_center","Latitude_Of_Center"],["latitude_of_center","Latitude_of_center"],["lat0","latitude_of_center",th],["longitude_of_center","Longitude_Of_Center"],["longitude_of_center","Longitude_of_center"],["longc","longitude_of_center",th],["x0","false_easting",o],["y0","false_northing",o],["long0","central_meridian",th],["lat0","latitude_of_origin",th],["lat0","standard_parallel_1",th],["lat1","standard_parallel_1",th],["lat2","standard_parallel_2",th],["azimuth","Azimuth"],["alpha","azimuth",th],["srsCode","name"]].forEach((function(t){return function(e,t){var n=t[0],i=t[1];!(n in e)&&i in e&&(e[n]=e[i],3===t.length&&(e[n]=t[2](e[n])))}(e,t)})),e.long0||!e.longc||"Albers_Conic_Equal_Area"!==e.projName&&"Lambert_Azimuthal_Equal_Area"!==e.projName||(e.long0=e.longc),e.lat_ts||!e.lat1||"Stereographic_South_Pole"!==e.projName&&"Polar Stereographic (variant B)"!==e.projName?!e.lat_ts&&e.lat0&&"Polar_Stereographic"===e.projName&&(e.lat_ts=e.lat0,e.lat0=th(e.lat0>0?90:-90)):(e.lat0=th(e.lat1>0?90:-90),e.lat_ts=e.lat1)}function rh(e){var t=new Jc(e).output(),n=t[0],i={};return Zc(t,i),nh(i),i[n]}function sh(e){var t=this;if(2===arguments.length){var n=arguments[1];"string"==typeof n?"+"===n.charAt(0)?sh[e]=Vc(arguments[1]):sh[e]=rh(arguments[1]):sh[e]=n}else if(1===arguments.length){if(Array.isArray(e))return e.map((function(e){Array.isArray(e)?sh.apply(t,e):sh(e)}));if("string"==typeof e){if(e in sh)return sh[e]}else"EPSG"in e?sh["EPSG:"+e.EPSG]=e:"ESRI"in e?sh["ESRI:"+e.ESRI]=e:"IAU2000"in e?sh["IAU2000:"+e.IAU2000]=e:console.log(e);return}}!function(e){e("EPSG:4326","+title=WGS 84 (long/lat) +proj=longlat +ellps=WGS84 +datum=WGS84 +units=degrees"),e("EPSG:4269","+title=NAD83 (long/lat) +proj=longlat +a=6378137.0 +b=6356752.31414036 +ellps=GRS80 +datum=NAD83 +units=degrees"),e("EPSG:3857","+title=WGS 84 / Pseudo-Mercator +proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs");for(var t=1;t<=60;++t)e("EPSG:"+(32600+t),"+proj=utm +zone="+t+" +datum=WGS84 +units=m"),e("EPSG:"+(32700+t),"+proj=utm +zone="+t+" +south +datum=WGS84 +units=m");e.WGS84=e["EPSG:4326"],e["EPSG:3785"]=e["EPSG:3857"],e.GOOGLE=e["EPSG:3857"],e["EPSG:900913"]=e["EPSG:3857"],e["EPSG:102113"]=e["EPSG:3857"]}(sh);const ah=sh;var oh=["PROJECTEDCRS","PROJCRS","GEOGCS","GEOCCS","PROJCS","LOCAL_CS","GEODCRS","GEODETICCRS","GEODETICDATUM","ENGCRS","ENGINEERINGCRS"],lh=["3857","900913","3785","102113"];function ch(e,t){var n,i;if(e=e||{},!t)return e;for(i in t)void 0!==(n=t[i])&&(e[i]=n);return e}function hh(e,t,n){var i=e*t;return n/Math.sqrt(1-i*i)}function uh(e){return e<0?-1:1}function dh(e){return Math.abs(e)<=kc?e:e-uh(e)*Fc}function ph(e,t,n){var i=e*n,r=.5*e;return i=Math.pow((1-i)/(1+i),r),Math.tan(.5*(Pc-t))/i}function fh(e,t){for(var n,i,r=.5*e,s=Pc-2*Math.atan(t),a=0;a<=15;a++)if(n=e*Math.sin(s),s+=i=Pc-2*Math.atan(t*Math.pow((1-n)/(1+n),r))-s,Math.abs(i)<=1e-10)return s;return-9999}function mh(e){return e}var gh=[{init:function(){var e=this.b/this.a;this.es=1-e*e,"x0"in this||(this.x0=0),"y0"in this||(this.y0=0),this.e=Math.sqrt(this.es),this.lat_ts?this.sphere?this.k0=Math.cos(this.lat_ts):this.k0=hh(this.e,Math.sin(this.lat_ts),Math.cos(this.lat_ts)):this.k0||(this.k?this.k0=this.k:this.k0=1)},forward:function(e){var t,n,i=e.x,r=e.y;if(r*Uc>90&&r*Uc<-90&&i*Uc>180&&i*Uc<-180)return null;if(Math.abs(Math.abs(r)-Pc)<=Dc)return null;if(this.sphere)t=this.x0+this.a*this.k0*dh(i-this.long0),n=this.y0+this.a*this.k0*Math.log(Math.tan(Oc+.5*r));else{var s=Math.sin(r),a=ph(this.e,r,s);t=this.x0+this.a*this.k0*dh(i-this.long0),n=this.y0-this.a*this.k0*Math.log(a)}return e.x=t,e.y=n,e},inverse:function(e){var t,n,i=e.x-this.x0,r=e.y-this.y0;if(this.sphere)n=Pc-2*Math.atan(Math.exp(-r/(this.a*this.k0)));else{var s=Math.exp(-r/(this.a*this.k0));if(-9999===(n=fh(this.e,s)))return null}return t=dh(this.long0+i/(this.a*this.k0)),e.x=t,e.y=n,e},names:["Mercator","Popular Visualisation Pseudo Mercator","Mercator_1SP","Mercator_Auxiliary_Sphere","merc"]},{init:function(){},forward:mh,inverse:mh,names:["longlat","identity"]}],Ah={},yh=[];function vh(e,t){var n=yh.length;return e.names?(yh[n]=e,e.names.forEach((function(e){Ah[e.toLowerCase()]=n})),this):(console.log(t),!0)}const _h={start:function(){gh.forEach(vh)},add:vh,get:function(e){if(!e)return!1;var t=e.toLowerCase();return void 0!==Ah[t]&&yh[Ah[t]]?yh[Ah[t]]:void 0}};var xh={MERIT:{a:6378137,rf:298.257,ellipseName:"MERIT 1983"},SGS85:{a:6378136,rf:298.257,ellipseName:"Soviet Geodetic System 85"},GRS80:{a:6378137,rf:298.257222101,ellipseName:"GRS 1980(IUGG, 1980)"},IAU76:{a:6378140,rf:298.257,ellipseName:"IAU 1976"},airy:{a:6377563.396,b:6356256.91,ellipseName:"Airy 1830"},APL4:{a:6378137,rf:298.25,ellipseName:"Appl. Physics. 1965"},NWL9D:{a:6378145,rf:298.25,ellipseName:"Naval Weapons Lab., 1965"},mod_airy:{a:6377340.189,b:6356034.446,ellipseName:"Modified Airy"},andrae:{a:6377104.43,rf:300,ellipseName:"Andrae 1876 (Den., Iclnd.)"},aust_SA:{a:6378160,rf:298.25,ellipseName:"Australian Natl & S. Amer. 1969"},GRS67:{a:6378160,rf:298.247167427,ellipseName:"GRS 67(IUGG 1967)"},bessel:{a:6377397.155,rf:299.1528128,ellipseName:"Bessel 1841"},bess_nam:{a:6377483.865,rf:299.1528128,ellipseName:"Bessel 1841 (Namibia)"},clrk66:{a:6378206.4,b:6356583.8,ellipseName:"Clarke 1866"},clrk80:{a:6378249.145,rf:293.4663,ellipseName:"Clarke 1880 mod."},clrk80ign:{a:6378249.2,b:6356515,rf:293.4660213,ellipseName:"Clarke 1880 (IGN)"},clrk58:{a:6378293.645208759,rf:294.2606763692654,ellipseName:"Clarke 1858"},CPM:{a:6375738.7,rf:334.29,ellipseName:"Comm. des Poids et Mesures 1799"},delmbr:{a:6376428,rf:311.5,ellipseName:"Delambre 1810 (Belgium)"},engelis:{a:6378136.05,rf:298.2566,ellipseName:"Engelis 1985"},evrst30:{a:6377276.345,rf:300.8017,ellipseName:"Everest 1830"},evrst48:{a:6377304.063,rf:300.8017,ellipseName:"Everest 1948"},evrst56:{a:6377301.243,rf:300.8017,ellipseName:"Everest 1956"},evrst69:{a:6377295.664,rf:300.8017,ellipseName:"Everest 1969"},evrstSS:{a:6377298.556,rf:300.8017,ellipseName:"Everest (Sabah & Sarawak)"},fschr60:{a:6378166,rf:298.3,ellipseName:"Fischer (Mercury Datum) 1960"},fschr60m:{a:6378155,rf:298.3,ellipseName:"Fischer 1960"},fschr68:{a:6378150,rf:298.3,ellipseName:"Fischer 1968"},helmert:{a:6378200,rf:298.3,ellipseName:"Helmert 1906"},hough:{a:6378270,rf:297,ellipseName:"Hough"},intl:{a:6378388,rf:297,ellipseName:"International 1909 (Hayford)"},kaula:{a:6378163,rf:298.24,ellipseName:"Kaula 1961"},lerch:{a:6378139,rf:298.257,ellipseName:"Lerch 1979"},mprts:{a:6397300,rf:191,ellipseName:"Maupertius 1738"},new_intl:{a:6378157.5,b:6356772.2,ellipseName:"New International 1967"},plessis:{a:6376523,rf:6355863,ellipseName:"Plessis 1817 (France)"},krass:{a:6378245,rf:298.3,ellipseName:"Krassovsky, 1942"},SEasia:{a:6378155,b:6356773.3205,ellipseName:"Southeast Asia"},walbeck:{a:6376896,b:6355834.8467,ellipseName:"Walbeck"},WGS60:{a:6378165,rf:298.3,ellipseName:"WGS 60"},WGS66:{a:6378145,rf:298.25,ellipseName:"WGS 66"},WGS7:{a:6378135,rf:298.26,ellipseName:"WGS 72"}},Eh=xh.WGS84={a:6378137,rf:298.257223563,ellipseName:"WGS 84"};xh.sphere={a:6370997,b:6370997,ellipseName:"Normal Sphere (r=6370997)"};var bh={wgs84:{towgs84:"0,0,0",ellipse:"WGS84",datumName:"WGS84"},ch1903:{towgs84:"674.374,15.056,405.346",ellipse:"bessel",datumName:"swiss"},ggrs87:{towgs84:"-199.87,74.79,246.62",ellipse:"GRS80",datumName:"Greek_Geodetic_Reference_System_1987"},nad83:{towgs84:"0,0,0",ellipse:"GRS80",datumName:"North_American_Datum_1983"},nad27:{nadgrids:"@conus,@alaska,@ntv2_0.gsb,@ntv1_can.dat",ellipse:"clrk66",datumName:"North_American_Datum_1927"},potsdam:{towgs84:"598.1,73.7,418.2,0.202,0.045,-2.455,6.7",ellipse:"bessel",datumName:"Potsdam Rauenberg 1950 DHDN"},carthage:{towgs84:"-263.0,6.0,431.0",ellipse:"clark80",datumName:"Carthage 1934 Tunisia"},hermannskogel:{towgs84:"577.326,90.129,463.919,5.137,1.474,5.297,2.4232",ellipse:"bessel",datumName:"Hermannskogel"},mgi:{towgs84:"577.326,90.129,463.919,5.137,1.474,5.297,2.4232",ellipse:"bessel",datumName:"Militar-Geographische Institut"},osni52:{towgs84:"482.530,-130.596,564.557,-1.042,-0.214,-0.631,8.15",ellipse:"airy",datumName:"Irish National"},ire65:{towgs84:"482.530,-130.596,564.557,-1.042,-0.214,-0.631,8.15",ellipse:"mod_airy",datumName:"Ireland 1965"},rassadiran:{towgs84:"-133.63,-157.5,-158.62",ellipse:"intl",datumName:"Rassadiran"},nzgd49:{towgs84:"59.47,-5.04,187.44,0.47,-0.1,1.024,-4.5993",ellipse:"intl",datumName:"New Zealand Geodetic Datum 1949"},osgb36:{towgs84:"446.448,-125.157,542.060,0.1502,0.2470,0.8421,-20.4894",ellipse:"airy",datumName:"Ordnance Survey of Great Britain 1936"},s_jtsk:{towgs84:"589,76,480",ellipse:"bessel",datumName:"S-JTSK (Ferro)"},beduaram:{towgs84:"-106,-87,188",ellipse:"clrk80",datumName:"Beduaram"},gunung_segara:{towgs84:"-403,684,41",ellipse:"bessel",datumName:"Gunung Segara Jakarta"},rnb72:{towgs84:"106.869,-52.2978,103.724,-0.33657,0.456955,-1.84218,1",ellipse:"intl",datumName:"Reseau National Belge 1972"}};for(var wh in bh){var Mh=bh[wh];bh[Mh.datumName]=Mh}const Sh=bh;var Ch={};function Th(e){if(0===e.length)return null;var t="@"===e[0];return t&&(e=e.slice(1)),"null"===e?{name:"null",mandatory:!t,grid:null,isNull:!0}:{name:e,mandatory:!t,grid:Ch[e]||null,isNull:!1}}function Ih(e){return e/3600*Math.PI/180}function Rh(e,t,n){return String.fromCharCode.apply(null,new Uint8Array(e.buffer.slice(t,n)))}function Bh(e){return e.map((function(e){return[Ih(e.longitudeShift),Ih(e.latitudeShift)]}))}function Lh(e,t,n){return{name:Rh(e,t+8,t+16).trim(),parent:Rh(e,t+24,t+24+8).trim(),lowerLatitude:e.getFloat64(t+72,n),upperLatitude:e.getFloat64(t+88,n),lowerLongitude:e.getFloat64(t+104,n),upperLongitude:e.getFloat64(t+120,n),latitudeInterval:e.getFloat64(t+136,n),longitudeInterval:e.getFloat64(t+152,n),gridNodeCount:e.getInt32(t+168,n)}}function Ph(e,t,n,i){for(var r=t+176,s=[],a=0;a<n.gridNodeCount;a++){var o={latitudeShift:e.getFloat32(r+16*a,i),longitudeShift:e.getFloat32(r+16*a+4,i),latitudeAccuracy:e.getFloat32(r+16*a+8,i),longitudeAccuracy:e.getFloat32(r+16*a+12,i)};s.push(o)}return s}function Dh(e,t){if(!(this instanceof Dh))return new Dh(e);t=t||function(e){if(e)throw e};var n,i,r,s,a,o,l,c=function(e){if(!function(e){return"string"==typeof e}(e))return e;if(function(e){return e in ah}(e))return ah[e];if(function(e){return oh.some((function(t){return e.indexOf(t)>-1}))}(e)){var t=rh(e);if(function(e){var t=Hc(e,"authority");if(t){var n=Hc(t,"epsg");return n&&lh.indexOf(n)>-1}}(t))return ah["EPSG:3857"];var n=function(e){var t=Hc(e,"extension");if(t)return Hc(t,"proj4")}(t);return n?Vc(n):t}return function(e){return"+"===e[0]}(e)?Vc(e):void 0}(e);if("object"==typeof c){var h=Dh.projections.get(c.projName);if(h){if(c.datumCode&&"none"!==c.datumCode){var u=Hc(Sh,c.datumCode);u&&(c.datum_params=c.datum_params||(u.towgs84?u.towgs84.split(","):null),c.ellps=u.ellipse,c.datumName=u.datumName?u.datumName:c.datumCode)}c.k0=c.k0||1,c.axis=c.axis||"enu",c.ellps=c.ellps||"wgs84",c.lat1=c.lat1||c.lat0;var d=function(e,t,n,i,r){if(!e){var s=Hc(xh,i);s||(s=Eh),e=s.a,t=s.b,n=s.rf}return n&&!t&&(t=(1-1/n)*e),(0===n||Math.abs(e-t)<Dc)&&(r=!0,t=e),{a:e,b:t,rf:n,sphere:r}}(c.a,c.b,c.rf,c.ellps,c.sphere),p=(n=d.a,i=d.b,d.rf,r=c.R_A,o=((s=n*n)-(a=i*i))/s,l=0,r?(s=(n*=1-o*(.16666666666666666+o*(.04722222222222222+.022156084656084655*o)))*n,o=0):l=Math.sqrt(o),{es:o,e:l,ep2:(s-a)/a}),f=function(e){return void 0===e?null:e.split(",").map(Th)}(c.nadgrids),m=c.datum||function(e,t,n,i,r,s,a){var o={};return o.datum_type=void 0===e||"none"===e?5:4,t&&(o.datum_params=t.map(parseFloat),0===o.datum_params[0]&&0===o.datum_params[1]&&0===o.datum_params[2]||(o.datum_type=1),o.datum_params.length>3&&(0===o.datum_params[3]&&0===o.datum_params[4]&&0===o.datum_params[5]&&0===o.datum_params[6]||(o.datum_type=2,o.datum_params[3]*=Lc,o.datum_params[4]*=Lc,o.datum_params[5]*=Lc,o.datum_params[6]=o.datum_params[6]/1e6+1))),a&&(o.datum_type=3,o.grids=a),o.a=n,o.b=i,o.es=r,o.ep2=s,o}(c.datumCode,c.datum_params,d.a,d.b,p.es,p.ep2,f);ch(this,c),ch(this,h),this.a=d.a,this.b=d.b,this.rf=d.rf,this.sphere=d.sphere,this.es=p.es,this.e=p.e,this.ep2=p.ep2,this.datum=m,this.init(),t(null,this)}else t("Could not get projection name from: "+e)}else t("Could not parse to valid json: "+e)}Dh.projections=_h,Dh.projections.start();const Nh=Dh;function Uh(e,t,n){var i,r,s,a,o=e.x,l=e.y,c=e.z?e.z:0;if(l<-Pc&&l>-1.001*Pc)l=-Pc;else if(l>Pc&&l<1.001*Pc)l=Pc;else{if(l<-Pc)return{x:-1/0,y:-1/0,z:e.z};if(l>Pc)return{x:1/0,y:1/0,z:e.z}}return o>Math.PI&&(o-=2*Math.PI),r=Math.sin(l),a=Math.cos(l),s=r*r,{x:((i=n/Math.sqrt(1-t*s))+c)*a*Math.cos(o),y:(i+c)*a*Math.sin(o),z:(i*(1-t)+c)*r}}function Oh(e,t,n,i){var r,s,a,o,l,c,h,u,d,p,f,m,g,A,y,v=e.x,_=e.y,x=e.z?e.z:0;if(r=Math.sqrt(v*v+_*_),s=Math.sqrt(v*v+_*_+x*x),r/n<1e-12){if(A=0,s/n<1e-12)return y=-i,{x:e.x,y:e.y,z:e.z}}else A=Math.atan2(_,v);a=x/s,u=(o=r/s)*(1-t)*(l=1/Math.sqrt(1-t*(2-t)*o*o)),d=a*l,g=0;do{g++,c=t*(h=n/Math.sqrt(1-t*d*d))/(h+(y=r*u+x*d-h*(1-t*d*d))),m=(f=a*(l=1/Math.sqrt(1-c*(2-c)*o*o)))*u-(p=o*(1-c)*l)*d,u=p,d=f}while(m*m>1e-24&&g<30);return{x:A,y:Math.atan(f/Math.abs(p)),z:y}}function Fh(e){return 1===e||2===e}function kh(e,t,n){if(null===e.grids||0===e.grids.length)return console.log("Grid shift grids not found"),-1;var i={x:-n.x,y:n.y},r={x:Number.NaN,y:Number.NaN},s=[];e:for(var a=0;a<e.grids.length;a++){var o=e.grids[a];if(s.push(o.name),o.isNull){r=i;break}if(o.mandatory,null!==o.grid)for(var l=o.grid.subgrids,c=0,h=l.length;c<h;c++){var u=l[c],d=(Math.abs(u.del[1])+Math.abs(u.del[0]))/1e4,p=u.ll[0]-d,f=u.ll[1]-d,m=u.ll[0]+(u.lim[0]-1)*u.del[0]+d,g=u.ll[1]+(u.lim[1]-1)*u.del[1]+d;if(!(f>i.y||p>i.x||g<i.y||m<i.x||(r=Qh(i,t,u),isNaN(r.x))))break e}else if(o.mandatory)return console.log("Unable to find mandatory grid '"+o.name+"'"),-1}return isNaN(r.x)?(console.log("Failed to find a grid shift table for location '"+-i.x*Uc+" "+i.y*Uc+" tried: '"+s+"'"),-1):(n.x=-r.x,n.y=r.y,0)}function Qh(e,t,n){var i={x:Number.NaN,y:Number.NaN};if(isNaN(e.x))return i;var r={x:e.x,y:e.y};r.x-=n.ll[0],r.y-=n.ll[1],r.x=dh(r.x-Math.PI)+Math.PI;var s=zh(r,n);if(t){if(isNaN(s.x))return i;s.x=r.x-s.x,s.y=r.y-s.y;var a,o,l=9;do{if(o=zh(s,n),isNaN(o.x)){console.log("Inverse grid shift iteration failed, presumably at grid edge.  Using first approximation.");break}a={x:r.x-(o.x+s.x),y:r.y-(o.y+s.y)},s.x+=a.x,s.y+=a.y}while(l--&&Math.abs(a.x)>1e-12&&Math.abs(a.y)>1e-12);if(l<0)return console.log("Inverse grid shift iterator failed to converge."),i;i.x=dh(s.x+n.ll[0]),i.y=s.y+n.ll[1]}else isNaN(s.x)||(i.x=e.x+s.x,i.y=e.y+s.y);return i}function zh(e,t){var n,i={x:e.x/t.del[0],y:e.y/t.del[1]},r=Math.floor(i.x),s=Math.floor(i.y),a=i.x-1*r,o=i.y-1*s,l={x:Number.NaN,y:Number.NaN};if(r<0||r>=t.lim[0])return l;if(s<0||s>=t.lim[1])return l;n=s*t.lim[0]+r;var c=t.cvs[n][0],h=t.cvs[n][1];n++;var u=t.cvs[n][0],d=t.cvs[n][1];n+=t.lim[0];var p=t.cvs[n][0],f=t.cvs[n][1];n--;var m=t.cvs[n][0],g=t.cvs[n][1],A=a*o,y=a*(1-o),v=(1-a)*(1-o),_=(1-a)*o;return l.x=v*c+y*u+_*m+A*p,l.y=v*h+y*d+_*g+A*f,l}function Gh(e,t,n){var i,r,s,a=n.x,o=n.y,l=n.z||0,c={};for(s=0;s<3;s++)if(!t||2!==s||void 0!==n.z)switch(0===s?(i=a,r=-1!=="ew".indexOf(e.axis[s])?"x":"y"):1===s?(i=o,r=-1!=="ns".indexOf(e.axis[s])?"y":"x"):(i=l,r="z"),e.axis[s]){case"e":case"n":c[r]=i;break;case"w":case"s":c[r]=-i;break;case"u":void 0!==n[r]&&(c.z=i);break;case"d":void 0!==n[r]&&(c.z=-i);break;default:return null}return c}function Hh(e){var t={x:e[0],y:e[1]};return e.length>2&&(t.z=e[2]),e.length>3&&(t.m=e[3]),t}function Vh(e){if("function"==typeof Number.isFinite){if(Number.isFinite(e))return;throw new TypeError("coordinates must be finite numbers")}if("number"!=typeof e||e!=e||!isFinite(e))throw new TypeError("coordinates must be finite numbers")}function jh(e,t,n,i){var r,s=void 0!==(n=Array.isArray(n)?Hh(n):{x:n.x,y:n.y,z:n.z,m:n.m}).z;if(function(e){Vh(e.x),Vh(e.y)}(n),e.datum&&t.datum&&function(e,t){return(1===e.datum.datum_type||2===e.datum.datum_type||3===e.datum.datum_type)&&"WGS84"!==t.datumCode||(1===t.datum.datum_type||2===t.datum.datum_type||3===t.datum.datum_type)&&"WGS84"!==e.datumCode}(e,t)&&(n=jh(e,r=new Nh("WGS84"),n,i),e=r),i&&"enu"!==e.axis&&(n=Gh(e,!1,n)),"longlat"===e.projName)n={x:n.x*Nc,y:n.y*Nc,z:n.z||0};else if(e.to_meter&&(n={x:n.x*e.to_meter,y:n.y*e.to_meter,z:n.z||0}),!(n=e.inverse(n)))return;if(e.from_greenwich&&(n.x+=e.from_greenwich),n=function(e,t,n){if(function(e,t){return e.datum_type===t.datum_type&&!(e.a!==t.a||Math.abs(e.es-t.es)>5e-11)&&(1===e.datum_type?e.datum_params[0]===t.datum_params[0]&&e.datum_params[1]===t.datum_params[1]&&e.datum_params[2]===t.datum_params[2]:2!==e.datum_type||e.datum_params[0]===t.datum_params[0]&&e.datum_params[1]===t.datum_params[1]&&e.datum_params[2]===t.datum_params[2]&&e.datum_params[3]===t.datum_params[3]&&e.datum_params[4]===t.datum_params[4]&&e.datum_params[5]===t.datum_params[5]&&e.datum_params[6]===t.datum_params[6])}(e,t))return n;if(5===e.datum_type||5===t.datum_type)return n;var i=e.a,r=e.es;if(3===e.datum_type){if(0!==kh(e,!1,n))return;i=Rc,r=Bc}var s=t.a,a=t.b,o=t.es;return 3===t.datum_type&&(s=Rc,a=6356752.314,o=Bc),r!==o||i!==s||Fh(e.datum_type)||Fh(t.datum_type)?(n=Uh(n,r,i),Fh(e.datum_type)&&(n=function(e,t,n){if(1===t)return{x:e.x+n[0],y:e.y+n[1],z:e.z+n[2]};if(2===t){var i=n[0],r=n[1],s=n[2],a=n[3],o=n[4],l=n[5],c=n[6];return{x:c*(e.x-l*e.y+o*e.z)+i,y:c*(l*e.x+e.y-a*e.z)+r,z:c*(-o*e.x+a*e.y+e.z)+s}}}(n,e.datum_type,e.datum_params)),Fh(t.datum_type)&&(n=function(e,t,n){if(1===t)return{x:e.x-n[0],y:e.y-n[1],z:e.z-n[2]};if(2===t){var i=n[0],r=n[1],s=n[2],a=n[3],o=n[4],l=n[5],c=n[6],h=(e.x-i)/c,u=(e.y-r)/c,d=(e.z-s)/c;return{x:h+l*u-o*d,y:-l*h+u+a*d,z:o*h-a*u+d}}}(n,t.datum_type,t.datum_params)),n=Oh(n,o,s,a),3!==t.datum_type||0===kh(t,!0,n)?n:void 0):n}(e.datum,t.datum,n))return t.from_greenwich&&(n={x:n.x-t.from_greenwich,y:n.y,z:n.z||0}),"longlat"===t.projName?n={x:n.x*Uc,y:n.y*Uc,z:n.z||0}:(n=t.forward(n),t.to_meter&&(n={x:n.x/t.to_meter,y:n.y/t.to_meter,z:n.z||0})),i&&"enu"!==t.axis?Gh(t,!0,n):(n&&!s&&delete n.z,n)}var qh=Nh("WGS84");function Wh(e,t,n,i){var r,s,a;return Array.isArray(n)?(r=jh(e,t,n,i)||{x:NaN,y:NaN},n.length>2?void 0!==e.name&&"geocent"===e.name||void 0!==t.name&&"geocent"===t.name?"number"==typeof r.z?[r.x,r.y,r.z].concat(n.slice(3)):[r.x,r.y,n[2]].concat(n.slice(3)):[r.x,r.y].concat(n.slice(2)):[r.x,r.y]):(s=jh(e,t,n,i),2===(a=Object.keys(n)).length||a.forEach((function(i){if(void 0!==e.name&&"geocent"===e.name||void 0!==t.name&&"geocent"===t.name){if("x"===i||"y"===i||"z"===i)return}else if("x"===i||"y"===i)return;s[i]=n[i]})),s)}function Yh(e){return e instanceof Nh?e:e.oProj?e.oProj:Nh(e)}const Xh=function(e,t,n){e=Yh(e);var i,r=!1;return void 0===t?(t=e,e=qh,r=!0):(void 0!==t.x||Array.isArray(t))&&(n=t,t=e,e=qh,r=!0),t=Yh(t),n?Wh(e,t,n):(i={forward:function(n,i){return Wh(e,t,n,i)},inverse:function(n,i){return Wh(t,e,n,i)}},r&&(i.oProj=t),i)};var Kh="AJSAJS",Jh="AFAFAF",$h=65,Zh=73,eu=79;const tu={forward:nu,inverse:function(e){var t=au(lu(e.toUpperCase()));return t.lat&&t.lon?[t.lon,t.lat,t.lon,t.lat]:[t.left,t.bottom,t.right,t.top]},toPoint:iu};function nu(e,t){return t=t||5,function(e,t){var n,i,r,s,a,o,l,c,h,u,d,p="00000"+e.easting,f="00000"+e.northing;return e.zoneNumber+e.zoneLetter+(h=e.easting,u=e.northing,d=ou(e.zoneNumber),n=Math.floor(h/1e5),i=Math.floor(u/1e5)%20,s=Kh.charCodeAt(r=d-1),a=Jh.charCodeAt(r),c=!1,(o=s+n-1)>90&&(o=o-90+$h-1,c=!0),(o===Zh||s<Zh&&o>Zh||(o>Zh||s<Zh)&&c)&&o++,(o===eu||s<eu&&o>eu||(o>eu||s<eu)&&c)&&++o===Zh&&o++,o>90&&(o=o-90+$h-1),(l=a+i)>86?(l=l-86+$h-1,c=!0):c=!1,(l===Zh||a<Zh&&l>Zh||(l>Zh||a<Zh)&&c)&&l++,(l===eu||a<eu&&l>eu||(l>eu||a<eu)&&c)&&++l===Zh&&l++,l>86&&(l=l-86+$h-1),String.fromCharCode(o)+String.fromCharCode(l))+p.substr(p.length-5,t)+f.substr(f.length-5,t)}(function(e){var t,n,i,r,s,a,o,l=e.lat,c=e.lon,h=6378137,u=.00669438,d=.9996,p=ru(l),f=ru(c);o=Math.floor((c+180)/6)+1,180===c&&(o=60),l>=56&&l<64&&c>=3&&c<12&&(o=32),l>=72&&l<84&&(c>=0&&c<9?o=31:c>=9&&c<21?o=33:c>=21&&c<33?o=35:c>=33&&c<42&&(o=37)),a=ru(6*(o-1)-180+3),t=.006739496752268451,n=h/Math.sqrt(1-u*Math.sin(p)*Math.sin(p)),i=Math.tan(p)*Math.tan(p),r=t*Math.cos(p)*Math.cos(p);var m,g,A=d*n*((s=Math.cos(p)*(f-a))+(1-i+r)*s*s*s/6+(5-18*i+i*i+72*r-58*t)*s*s*s*s*s/120)+5e5,y=d*(h*(.9983242984503243*p-.002514607064228144*Math.sin(2*p)+2639046602129982e-21*Math.sin(4*p)-3.418046101696858e-9*Math.sin(6*p))+n*Math.tan(p)*(s*s/2+(5-i+9*r+4*r*r)*s*s*s*s/24+(61-58*i+i*i+600*r-2.2240339282485886)*s*s*s*s*s*s/720));return l<0&&(y+=1e7),{northing:Math.round(y),easting:Math.round(A),zoneNumber:o,zoneLetter:(m=l,g="Z",84>=m&&m>=72?g="X":72>m&&m>=64?g="W":64>m&&m>=56?g="V":56>m&&m>=48?g="U":48>m&&m>=40?g="T":40>m&&m>=32?g="S":32>m&&m>=24?g="R":24>m&&m>=16?g="Q":16>m&&m>=8?g="P":8>m&&m>=0?g="N":0>m&&m>=-8?g="M":-8>m&&m>=-16?g="L":-16>m&&m>=-24?g="K":-24>m&&m>=-32?g="J":-32>m&&m>=-40?g="H":-40>m&&m>=-48?g="G":-48>m&&m>=-56?g="F":-56>m&&m>=-64?g="E":-64>m&&m>=-72?g="D":-72>m&&m>=-80&&(g="C"),g)}}({lat:e[1],lon:e[0]}),t)}function iu(e){var t=au(lu(e.toUpperCase()));return t.lat&&t.lon?[t.lon,t.lat]:[(t.left+t.right)/2,(t.top+t.bottom)/2]}function ru(e){return e*(Math.PI/180)}function su(e){return e/Math.PI*180}function au(e){var t=e.northing,n=e.easting,i=e.zoneLetter,r=e.zoneNumber;if(r<0||r>60)return null;var s,a,o,l,c,h,u,d,p,f=.9996,m=6378137,g=.00669438,A=(1-Math.sqrt(.99330562))/(1+Math.sqrt(.99330562)),y=n-5e5,v=t;i<"N"&&(v-=1e7),u=6*(r-1)-180+3,s=.006739496752268451,p=(d=v/f/6367449.145945056)+(3*A/2-27*A*A*A/32)*Math.sin(2*d)+(21*A*A/16-55*A*A*A*A/32)*Math.sin(4*d)+151*A*A*A/96*Math.sin(6*d),a=m/Math.sqrt(1-g*Math.sin(p)*Math.sin(p)),o=Math.tan(p)*Math.tan(p),l=s*Math.cos(p)*Math.cos(p),c=.99330562*m/Math.pow(1-g*Math.sin(p)*Math.sin(p),1.5),h=y/(a*f);var _=p-a*Math.tan(p)/c*(h*h/2-(5+3*o+10*l-4*l*l-9*s)*h*h*h*h/24+(61+90*o+298*l+45*o*o-1.6983531815716497-3*l*l)*h*h*h*h*h*h/720);_=su(_);var x,E=(h-(1+2*o+l)*h*h*h/6+(5-2*l+28*o-3*l*l+8*s+24*o*o)*h*h*h*h*h/120)/Math.cos(p);if(E=u+su(E),e.accuracy){var b=au({northing:e.northing+e.accuracy,easting:e.easting+e.accuracy,zoneLetter:e.zoneLetter,zoneNumber:e.zoneNumber});x={top:b.lat,right:b.lon,bottom:_,left:E}}else x={lat:_,lon:E};return x}function ou(e){var t=e%6;return 0===t&&(t=6),t}function lu(e){if(e&&0===e.length)throw"MGRSPoint coverting from nothing";for(var t,n=e.length,i=null,r="",s=0;!/[A-Z]/.test(t=e.charAt(s));){if(s>=2)throw"MGRSPoint bad conversion from: "+e;r+=t,s++}var a=parseInt(r,10);if(0===s||s+3>n)throw"MGRSPoint bad conversion from: "+e;var o=e.charAt(s++);if(o<="A"||"B"===o||"Y"===o||o>="Z"||"I"===o||"O"===o)throw"MGRSPoint zone letter "+o+" not handled: "+e;i=e.substring(s,s+=2);for(var l=ou(a),c=function(e,t){for(var n=Kh.charCodeAt(t-1),i=1e5,r=!1;n!==e.charCodeAt(0);){if(++n===Zh&&n++,n===eu&&n++,n>90){if(r)throw"Bad character: "+e;n=$h,r=!0}i+=1e5}return i}(i.charAt(0),l),h=function(e,t){if(e>"V")throw"MGRSPoint given invalid Northing "+e;for(var n=Jh.charCodeAt(t-1),i=0,r=!1;n!==e.charCodeAt(0);){if(++n===Zh&&n++,n===eu&&n++,n>86){if(r)throw"Bad character: "+e;n=$h,r=!0}i+=1e5}return i}(i.charAt(1),l);h<cu(o);)h+=2e6;var u=n-s;if(u%2!=0)throw"MGRSPoint has to have an even number \nof digits after the zone letter and two 100km letters - front \nhalf for easting meters, second half for \nnorthing meters"+e;var d,p,f,m=u/2,g=0,A=0;return m>0&&(d=1e5/Math.pow(10,m),p=e.substring(s,s+m),g=parseFloat(p)*d,f=e.substring(s+m),A=parseFloat(f)*d),{easting:g+c,northing:A+h,zoneLetter:o,zoneNumber:a,accuracy:d}}function cu(e){var t;switch(e){case"C":t=11e5;break;case"D":t=2e6;break;case"E":t=28e5;break;case"F":t=37e5;break;case"G":t=46e5;break;case"H":t=55e5;break;case"J":t=64e5;break;case"K":t=73e5;break;case"L":t=82e5;break;case"M":t=91e5;break;case"N":t=0;break;case"P":t=8e5;break;case"Q":t=17e5;break;case"R":t=26e5;break;case"S":t=35e5;break;case"T":t=44e5;break;case"U":t=53e5;break;case"V":t=62e5;break;case"W":t=7e6;break;case"X":t=79e5;break;default:t=-1}if(t>=0)return t;throw"Invalid zone letter: "+e}function hu(e,t,n){if(!(this instanceof hu))return new hu(e,t,n);if(Array.isArray(e))this.x=e[0],this.y=e[1],this.z=e[2]||0;else if("object"==typeof e)this.x=e.x,this.y=e.y,this.z=e.z||0;else if("string"==typeof e&&void 0===t){var i=e.split(",");this.x=parseFloat(i[0],10),this.y=parseFloat(i[1],10),this.z=parseFloat(i[2],10)||0}else this.x=e,this.y=t,this.z=n||0;console.warn("proj4.Point will be removed in version 3, use proj4.toPoint")}hu.fromMGRS=function(e){return new hu(iu(e))},hu.prototype.toMGRS=function(e){return nu([this.x,this.y],e)};const uu=hu;var du=.046875,pu=.01953125,fu=.01068115234375;function mu(e){var t=[];t[0]=1-e*(.25+e*(du+e*(pu+e*fu))),t[1]=e*(.75-e*(du+e*(pu+e*fu)));var n=e*e;return t[2]=n*(.46875-e*(.013020833333333334+.007120768229166667*e)),n*=e,t[3]=n*(.3645833333333333-.005696614583333333*e),t[4]=n*e*.3076171875,t}function gu(e,t,n,i){return n*=t,t*=t,i[0]*e-n*(i[1]+t*(i[2]+t*(i[3]+t*i[4])))}function Au(e,t,n){for(var i=1/(1-t),r=e,s=20;s;--s){var a=Math.sin(r),o=1-t*a*a;if(r-=o=(gu(r,a,Math.cos(r),n)-e)*(o*Math.sqrt(o))*i,Math.abs(o)<Dc)return r}return r}const yu={init:function(){this.x0=void 0!==this.x0?this.x0:0,this.y0=void 0!==this.y0?this.y0:0,this.long0=void 0!==this.long0?this.long0:0,this.lat0=void 0!==this.lat0?this.lat0:0,this.es&&(this.en=mu(this.es),this.ml0=gu(this.lat0,Math.sin(this.lat0),Math.cos(this.lat0),this.en))},forward:function(e){var t,n,i,r=e.x,s=e.y,a=dh(r-this.long0),o=Math.sin(s),l=Math.cos(s);if(this.es){var c=l*a,h=Math.pow(c,2),u=this.ep2*Math.pow(l,2),d=Math.pow(u,2),p=Math.abs(l)>Dc?Math.tan(s):0,f=Math.pow(p,2),m=Math.pow(f,2);t=1-this.es*Math.pow(o,2),c/=Math.sqrt(t);var g=gu(s,o,l,this.en);n=this.a*(this.k0*c*(1+h/6*(1-f+u+h/20*(5-18*f+m+14*u-58*f*u+h/42*(61+179*m-m*f-479*f)))))+this.x0,i=this.a*(this.k0*(g-this.ml0+o*a*c/2*(1+h/12*(5-f+9*u+4*d+h/30*(61+m-58*f+270*u-330*f*u+h/56*(1385+543*m-m*f-3111*f))))))+this.y0}else{var A=l*Math.sin(a);if(Math.abs(Math.abs(A)-1)<Dc)return 93;if(n=.5*this.a*this.k0*Math.log((1+A)/(1-A))+this.x0,i=l*Math.cos(a)/Math.sqrt(1-Math.pow(A,2)),(A=Math.abs(i))>=1){if(A-1>Dc)return 93;i=0}else i=Math.acos(i);s<0&&(i=-i),i=this.a*this.k0*(i-this.lat0)+this.y0}return e.x=n,e.y=i,e},inverse:function(e){var t,n,i,r,s=(e.x-this.x0)*(1/this.a),a=(e.y-this.y0)*(1/this.a);if(this.es)if(n=Au(t=this.ml0+a/this.k0,this.es,this.en),Math.abs(n)<Pc){var o=Math.sin(n),l=Math.cos(n),c=Math.abs(l)>Dc?Math.tan(n):0,h=this.ep2*Math.pow(l,2),u=Math.pow(h,2),d=Math.pow(c,2),p=Math.pow(d,2);t=1-this.es*Math.pow(o,2);var f=s*Math.sqrt(t)/this.k0,m=Math.pow(f,2);i=n-(t*=c)*m/(1-this.es)*.5*(1-m/12*(5+3*d-9*h*d+h-4*u-m/30*(61+90*d-252*h*d+45*p+46*h-m/56*(1385+3633*d+4095*p+1574*p*d)))),r=dh(this.long0+f*(1-m/6*(1+2*d+h-m/20*(5+28*d+24*p+8*h*d+6*h-m/42*(61+662*d+1320*p+720*p*d))))/l)}else i=Pc*uh(a),r=0;else{var g=Math.exp(s/this.k0),A=.5*(g-1/g),y=this.lat0+a/this.k0,v=Math.cos(y);t=Math.sqrt((1-Math.pow(v,2))/(1+Math.pow(A,2))),i=Math.asin(t),a<0&&(i=-i),r=0===A&&0===v?0:dh(Math.atan2(A,v)+this.long0)}return e.x=r,e.y=i,e},names:["Fast_Transverse_Mercator","Fast Transverse Mercator"]};function vu(e){var t=Math.exp(e);return(t-1/t)/2}function _u(e,t){e=Math.abs(e),t=Math.abs(t);var n=Math.max(e,t),i=Math.min(e,t)/(n||1);return n*Math.sqrt(1+Math.pow(i,2))}function xu(e,t){for(var n,i=2*Math.cos(2*t),r=e.length-1,s=e[r],a=0;--r>=0;)n=i*s-a+e[r],a=s,s=n;return t+n*Math.sin(2*t)}function Eu(e,t,n){for(var i,r,s=Math.sin(t),a=Math.cos(t),o=vu(n),l=function(e){var t=Math.exp(e);return(t+1/t)/2}(n),c=2*a*l,h=-2*s*o,u=e.length-1,d=e[u],p=0,f=0,m=0;--u>=0;)i=f,r=p,d=c*(f=d)-i-h*(p=m)+e[u],m=h*f-r+c*p;return[(c=s*l)*d-(h=a*o)*m,c*m+h*d]}const bu={init:function(){if(!this.approx&&(isNaN(this.es)||this.es<=0))throw new Error('Incorrect elliptical usage. Try using the +approx option in the proj string, or PROJECTION["Fast_Transverse_Mercator"] in the WKT.');this.approx&&(yu.init.apply(this),this.forward=yu.forward,this.inverse=yu.inverse),this.x0=void 0!==this.x0?this.x0:0,this.y0=void 0!==this.y0?this.y0:0,this.long0=void 0!==this.long0?this.long0:0,this.lat0=void 0!==this.lat0?this.lat0:0,this.cgb=[],this.cbg=[],this.utg=[],this.gtu=[];var e=this.es/(1+Math.sqrt(1-this.es)),t=e/(2-e),n=t;this.cgb[0]=t*(2+t*(-2/3+t*(t*(116/45+t*(26/45+t*(-2854/675)))-2))),this.cbg[0]=t*(t*(2/3+t*(4/3+t*(-82/45+t*(32/45+t*(4642/4725)))))-2),n*=t,this.cgb[1]=n*(7/3+t*(t*(-227/45+t*(2704/315+t*(2323/945)))-1.6)),this.cbg[1]=n*(5/3+t*(-16/15+t*(-13/9+t*(904/315+t*(-1522/945))))),n*=t,this.cgb[2]=n*(56/15+t*(-136/35+t*(-1262/105+t*(73814/2835)))),this.cbg[2]=n*(-26/15+t*(34/21+t*(1.6+t*(-12686/2835)))),n*=t,this.cgb[3]=n*(4279/630+t*(-332/35+t*(-399572/14175))),this.cbg[3]=n*(1237/630+t*(t*(-24832/14175)-2.4)),n*=t,this.cgb[4]=n*(4174/315+t*(-144838/6237)),this.cbg[4]=n*(-734/315+t*(109598/31185)),n*=t,this.cgb[5]=n*(601676/22275),this.cbg[5]=n*(444337/155925),n=Math.pow(t,2),this.Qn=this.k0/(1+t)*(1+n*(1/4+n*(1/64+n/256))),this.utg[0]=t*(t*(2/3+t*(-37/96+t*(1/360+t*(81/512+t*(-96199/604800)))))-.5),this.gtu[0]=t*(.5+t*(-2/3+t*(5/16+t*(41/180+t*(-127/288+t*(7891/37800)))))),this.utg[1]=n*(-1/48+t*(-1/15+t*(437/1440+t*(-46/105+t*(1118711/3870720))))),this.gtu[1]=n*(13/48+t*(t*(557/1440+t*(281/630+t*(-1983433/1935360)))-.6)),n*=t,this.utg[2]=n*(-17/480+t*(37/840+t*(209/4480+t*(-5569/90720)))),this.gtu[2]=n*(61/240+t*(-103/140+t*(15061/26880+t*(167603/181440)))),n*=t,this.utg[3]=n*(-4397/161280+t*(11/504+t*(830251/7257600))),this.gtu[3]=n*(49561/161280+t*(-179/168+t*(6601661/7257600))),n*=t,this.utg[4]=n*(-4583/161280+t*(108847/3991680)),this.gtu[4]=n*(34729/80640+t*(-3418889/1995840)),n*=t,this.utg[5]=n*(-20648693/638668800),this.gtu[5]=.6650675310896665*n;var i=xu(this.cbg,this.lat0);this.Zb=-this.Qn*(i+function(e,t){for(var n,i=2*Math.cos(t),r=e.length-1,s=e[r],a=0;--r>=0;)n=i*s-a+e[r],a=s,s=n;return Math.sin(t)*n}(this.gtu,2*i))},forward:function(e){var t=dh(e.x-this.long0),n=e.y;n=xu(this.cbg,n);var i=Math.sin(n),r=Math.cos(n),s=Math.sin(t),a=Math.cos(t);n=Math.atan2(i,a*r),t=Math.atan2(s*r,_u(i,r*a)),t=function(e){var t=Math.abs(e);return t=function(e){var t=1+e,n=t-1;return 0===n?e:e*Math.log(t)/n}(t*(1+t/(_u(1,t)+1))),e<0?-t:t}(Math.tan(t));var o,l,c=Eu(this.gtu,2*n,2*t);return n+=c[0],t+=c[1],Math.abs(t)<=2.623395162778?(o=this.a*(this.Qn*t)+this.x0,l=this.a*(this.Qn*n+this.Zb)+this.y0):(o=1/0,l=1/0),e.x=o,e.y=l,e},inverse:function(e){var t,n,i=(e.x-this.x0)*(1/this.a),r=(e.y-this.y0)*(1/this.a);if(r=(r-this.Zb)/this.Qn,i/=this.Qn,Math.abs(i)<=2.623395162778){var s=Eu(this.utg,2*r,2*i);r+=s[0],i+=s[1],i=Math.atan(vu(i));var a=Math.sin(r),o=Math.cos(r),l=Math.sin(i),c=Math.cos(i);r=Math.atan2(a*c,_u(l,c*o)),t=dh((i=Math.atan2(l,c*o))+this.long0),n=xu(this.cgb,r)}else t=1/0,n=1/0;return e.x=t,e.y=n,e},names:["Extended_Transverse_Mercator","Extended Transverse Mercator","etmerc","Transverse_Mercator","Transverse Mercator","Gauss Kruger","Gauss_Kruger","tmerc"]},wu={init:function(){var e=function(e,t){if(void 0===e){if((e=Math.floor(30*(dh(t)+Math.PI)/Math.PI)+1)<0)return 0;if(e>60)return 60}return e}(this.zone,this.long0);if(void 0===e)throw new Error("unknown utm zone");this.lat0=0,this.long0=(6*Math.abs(e)-183)*Nc,this.x0=5e5,this.y0=this.utmSouth?1e7:0,this.k0=.9996,bu.init.apply(this),this.forward=bu.forward,this.inverse=bu.inverse},names:["Universal Transverse Mercator System","utm"],dependsOn:"etmerc"};function Mu(e,t){return Math.pow((1-e)/(1+e),t)}const Su={init:function(){var e=Math.sin(this.lat0),t=Math.cos(this.lat0);t*=t,this.rc=Math.sqrt(1-this.es)/(1-this.es*e*e),this.C=Math.sqrt(1+this.es*t*t/(1-this.es)),this.phic0=Math.asin(e/this.C),this.ratexp=.5*this.C*this.e,this.K=Math.tan(.5*this.phic0+Oc)/(Math.pow(Math.tan(.5*this.lat0+Oc),this.C)*Mu(this.e*e,this.ratexp))},forward:function(e){var t=e.x,n=e.y;return e.y=2*Math.atan(this.K*Math.pow(Math.tan(.5*n+Oc),this.C)*Mu(this.e*Math.sin(n),this.ratexp))-Pc,e.x=this.C*t,e},inverse:function(e){for(var t=e.x/this.C,n=e.y,i=Math.pow(Math.tan(.5*n+Oc)/this.K,1/this.C),r=20;r>0&&(n=2*Math.atan(i*Mu(this.e*Math.sin(e.y),-.5*this.e))-Pc,!(Math.abs(n-e.y)<1e-14));--r)e.y=n;return r?(e.x=t,e.y=n,e):null},names:["gauss"]},Cu={init:function(){Su.init.apply(this),this.rc&&(this.sinc0=Math.sin(this.phic0),this.cosc0=Math.cos(this.phic0),this.R2=2*this.rc,this.title||(this.title="Oblique Stereographic Alternative"))},forward:function(e){var t,n,i,r;return e.x=dh(e.x-this.long0),Su.forward.apply(this,[e]),t=Math.sin(e.y),n=Math.cos(e.y),i=Math.cos(e.x),r=this.k0*this.R2/(1+this.sinc0*t+this.cosc0*n*i),e.x=r*n*Math.sin(e.x),e.y=r*(this.cosc0*t-this.sinc0*n*i),e.x=this.a*e.x+this.x0,e.y=this.a*e.y+this.y0,e},inverse:function(e){var t,n,i,r,s;if(e.x=(e.x-this.x0)/this.a,e.y=(e.y-this.y0)/this.a,e.x/=this.k0,e.y/=this.k0,s=_u(e.x,e.y)){var a=2*Math.atan2(s,this.R2);t=Math.sin(a),n=Math.cos(a),r=Math.asin(n*this.sinc0+e.y*t*this.cosc0/s),i=Math.atan2(e.x*t,s*this.cosc0*n-e.y*this.sinc0*t)}else r=this.phic0,i=0;return e.x=i,e.y=r,Su.inverse.apply(this,[e]),e.x=dh(e.x+this.long0),e},names:["Stereographic_North_Pole","Oblique_Stereographic","sterea","Oblique Stereographic Alternative","Double_Stereographic"]},Tu={init:function(){this.x0=this.x0||0,this.y0=this.y0||0,this.lat0=this.lat0||0,this.long0=this.long0||0,this.coslat0=Math.cos(this.lat0),this.sinlat0=Math.sin(this.lat0),this.sphere?1===this.k0&&!isNaN(this.lat_ts)&&Math.abs(this.coslat0)<=Dc&&(this.k0=.5*(1+uh(this.lat0)*Math.sin(this.lat_ts))):(Math.abs(this.coslat0)<=Dc&&(this.lat0>0?this.con=1:this.con=-1),this.cons=Math.sqrt(Math.pow(1+this.e,1+this.e)*Math.pow(1-this.e,1-this.e)),1===this.k0&&!isNaN(this.lat_ts)&&Math.abs(this.coslat0)<=Dc&&Math.abs(Math.cos(this.lat_ts))>Dc&&(this.k0=.5*this.cons*hh(this.e,Math.sin(this.lat_ts),Math.cos(this.lat_ts))/ph(this.e,this.con*this.lat_ts,this.con*Math.sin(this.lat_ts))),this.ms1=hh(this.e,this.sinlat0,this.coslat0),this.X0=2*Math.atan(this.ssfn_(this.lat0,this.sinlat0,this.e))-Pc,this.cosX0=Math.cos(this.X0),this.sinX0=Math.sin(this.X0))},forward:function(e){var t,n,i,r,s,a,o=e.x,l=e.y,c=Math.sin(l),h=Math.cos(l),u=dh(o-this.long0);return Math.abs(Math.abs(o-this.long0)-Math.PI)<=Dc&&Math.abs(l+this.lat0)<=Dc?(e.x=NaN,e.y=NaN,e):this.sphere?(t=2*this.k0/(1+this.sinlat0*c+this.coslat0*h*Math.cos(u)),e.x=this.a*t*h*Math.sin(u)+this.x0,e.y=this.a*t*(this.coslat0*c-this.sinlat0*h*Math.cos(u))+this.y0,e):(n=2*Math.atan(this.ssfn_(l,c,this.e))-Pc,r=Math.cos(n),i=Math.sin(n),Math.abs(this.coslat0)<=Dc?(s=ph(this.e,l*this.con,this.con*c),a=2*this.a*this.k0*s/this.cons,e.x=this.x0+a*Math.sin(o-this.long0),e.y=this.y0-this.con*a*Math.cos(o-this.long0),e):(Math.abs(this.sinlat0)<Dc?(t=2*this.a*this.k0/(1+r*Math.cos(u)),e.y=t*i):(t=2*this.a*this.k0*this.ms1/(this.cosX0*(1+this.sinX0*i+this.cosX0*r*Math.cos(u))),e.y=t*(this.cosX0*i-this.sinX0*r*Math.cos(u))+this.y0),e.x=t*r*Math.sin(u)+this.x0,e))},inverse:function(e){var t,n,i,r,s;e.x-=this.x0,e.y-=this.y0;var a=Math.sqrt(e.x*e.x+e.y*e.y);if(this.sphere){var o=2*Math.atan(a/(2*this.a*this.k0));return t=this.long0,n=this.lat0,a<=Dc?(e.x=t,e.y=n,e):(n=Math.asin(Math.cos(o)*this.sinlat0+e.y*Math.sin(o)*this.coslat0/a),t=Math.abs(this.coslat0)<Dc?this.lat0>0?dh(this.long0+Math.atan2(e.x,-1*e.y)):dh(this.long0+Math.atan2(e.x,e.y)):dh(this.long0+Math.atan2(e.x*Math.sin(o),a*this.coslat0*Math.cos(o)-e.y*this.sinlat0*Math.sin(o))),e.x=t,e.y=n,e)}if(Math.abs(this.coslat0)<=Dc){if(a<=Dc)return n=this.lat0,t=this.long0,e.x=t,e.y=n,e;e.x*=this.con,e.y*=this.con,i=a*this.cons/(2*this.a*this.k0),n=this.con*fh(this.e,i),t=this.con*dh(this.con*this.long0+Math.atan2(e.x,-1*e.y))}else r=2*Math.atan(a*this.cosX0/(2*this.a*this.k0*this.ms1)),t=this.long0,a<=Dc?s=this.X0:(s=Math.asin(Math.cos(r)*this.sinX0+e.y*Math.sin(r)*this.cosX0/a),t=dh(this.long0+Math.atan2(e.x*Math.sin(r),a*this.cosX0*Math.cos(r)-e.y*this.sinX0*Math.sin(r)))),n=-1*fh(this.e,Math.tan(.5*(Pc+s)));return e.x=t,e.y=n,e},names:["stere","Stereographic_South_Pole","Polar Stereographic (variant B)","Polar_Stereographic"],ssfn_:function(e,t,n){return t*=n,Math.tan(.5*(Pc+e))*Math.pow((1-t)/(1+t),.5*n)}},Iu={init:function(){var e=this.lat0;this.lambda0=this.long0;var t=Math.sin(e),n=this.a,i=1/this.rf,r=2*i-Math.pow(i,2),s=this.e=Math.sqrt(r);this.R=this.k0*n*Math.sqrt(1-r)/(1-r*Math.pow(t,2)),this.alpha=Math.sqrt(1+r/(1-r)*Math.pow(Math.cos(e),4)),this.b0=Math.asin(t/this.alpha);var a=Math.log(Math.tan(Math.PI/4+this.b0/2)),o=Math.log(Math.tan(Math.PI/4+e/2)),l=Math.log((1+s*t)/(1-s*t));this.K=a-this.alpha*o+this.alpha*s/2*l},forward:function(e){var t=Math.log(Math.tan(Math.PI/4-e.y/2)),n=this.e/2*Math.log((1+this.e*Math.sin(e.y))/(1-this.e*Math.sin(e.y))),i=-this.alpha*(t+n)+this.K,r=2*(Math.atan(Math.exp(i))-Math.PI/4),s=this.alpha*(e.x-this.lambda0),a=Math.atan(Math.sin(s)/(Math.sin(this.b0)*Math.tan(r)+Math.cos(this.b0)*Math.cos(s))),o=Math.asin(Math.cos(this.b0)*Math.sin(r)-Math.sin(this.b0)*Math.cos(r)*Math.cos(s));return e.y=this.R/2*Math.log((1+Math.sin(o))/(1-Math.sin(o)))+this.y0,e.x=this.R*a+this.x0,e},inverse:function(e){for(var t=e.x-this.x0,n=e.y-this.y0,i=t/this.R,r=2*(Math.atan(Math.exp(n/this.R))-Math.PI/4),s=Math.asin(Math.cos(this.b0)*Math.sin(r)+Math.sin(this.b0)*Math.cos(r)*Math.cos(i)),a=Math.atan(Math.sin(i)/(Math.cos(this.b0)*Math.cos(i)-Math.sin(this.b0)*Math.tan(r))),o=this.lambda0+a/this.alpha,l=0,c=s,h=-1e3,u=0;Math.abs(c-h)>1e-7;){if(++u>20)return;l=1/this.alpha*(Math.log(Math.tan(Math.PI/4+s/2))-this.K)+this.e*Math.log(Math.tan(Math.PI/4+Math.asin(this.e*Math.sin(c))/2)),h=c,c=2*Math.atan(Math.exp(l))-Math.PI/2}return e.x=o,e.y=c,e},names:["somerc"]};var Ru=1e-7;const Bu={init:function(){var e,t,n,i,r,s,a,o,l,c,h,u,d,p=0,f=0,m=0,g=0,A=0,y=0,v=0;this.no_off=(d="object"==typeof(u=this).PROJECTION?Object.keys(u.PROJECTION)[0]:u.PROJECTION,"no_uoff"in u||"no_off"in u||-1!==["Hotine_Oblique_Mercator","Hotine_Oblique_Mercator_Azimuth_Natural_Origin"].indexOf(d)),this.no_rot="no_rot"in this;var _=!1;"alpha"in this&&(_=!0);var x=!1;if("rectified_grid_angle"in this&&(x=!0),_&&(v=this.alpha),x&&(p=this.rectified_grid_angle*Nc),_||x)f=this.longc;else if(m=this.long1,A=this.lat1,g=this.long2,y=this.lat2,Math.abs(A-y)<=Ru||(e=Math.abs(A))<=Ru||Math.abs(e-Pc)<=Ru||Math.abs(Math.abs(this.lat0)-Pc)<=Ru||Math.abs(Math.abs(y)-Pc)<=Ru)throw new Error;var E=1-this.es;t=Math.sqrt(E),Math.abs(this.lat0)>Dc?(o=Math.sin(this.lat0),n=Math.cos(this.lat0),e=1-this.es*o*o,this.B=n*n,this.B=Math.sqrt(1+this.es*this.B*this.B/E),this.A=this.B*this.k0*t/e,(r=(i=this.B*t/(n*Math.sqrt(e)))*i-1)<=0?r=0:(r=Math.sqrt(r),this.lat0<0&&(r=-r)),this.E=r+=i,this.E*=Math.pow(ph(this.e,this.lat0,o),this.B)):(this.B=1/t,this.A=this.k0,this.E=i=r=1),_||x?(_?(h=Math.asin(Math.sin(v)/i),x||(p=v)):(h=p,v=Math.asin(i*Math.sin(h))),this.lam0=f-Math.asin(.5*(r-1/r)*Math.tan(h))/this.B):(s=Math.pow(ph(this.e,A,Math.sin(A)),this.B),a=Math.pow(ph(this.e,y,Math.sin(y)),this.B),r=this.E/s,l=(a-s)/(a+s),c=((c=this.E*this.E)-a*s)/(c+a*s),(e=m-g)<-Math.pi?g-=Fc:e>Math.pi&&(g+=Fc),this.lam0=dh(.5*(m+g)-Math.atan(c*Math.tan(.5*this.B*(m-g))/l)/this.B),h=Math.atan(2*Math.sin(this.B*dh(m-this.lam0))/(r-1/r)),p=v=Math.asin(i*Math.sin(h))),this.singam=Math.sin(h),this.cosgam=Math.cos(h),this.sinrot=Math.sin(p),this.cosrot=Math.cos(p),this.rB=1/this.B,this.ArB=this.A*this.rB,this.BrA=1/this.ArB,this.A,this.B,this.no_off?this.u_0=0:(this.u_0=Math.abs(this.ArB*Math.atan(Math.sqrt(i*i-1)/Math.cos(v))),this.lat0<0&&(this.u_0=-this.u_0)),r=.5*h,this.v_pole_n=this.ArB*Math.log(Math.tan(Oc-r)),this.v_pole_s=this.ArB*Math.log(Math.tan(Oc+r))},forward:function(e){var t,n,i,r,s,a,o,l,c={};if(e.x=e.x-this.lam0,Math.abs(Math.abs(e.y)-Pc)>Dc){if(t=.5*((s=this.E/Math.pow(ph(this.e,e.y,Math.sin(e.y)),this.B))-(a=1/s)),n=.5*(s+a),r=Math.sin(this.B*e.x),i=(t*this.singam-r*this.cosgam)/n,Math.abs(Math.abs(i)-1)<Dc)throw new Error;l=.5*this.ArB*Math.log((1-i)/(1+i)),a=Math.cos(this.B*e.x),o=Math.abs(a)<Ru?this.A*e.x:this.ArB*Math.atan2(t*this.cosgam+r*this.singam,a)}else l=e.y>0?this.v_pole_n:this.v_pole_s,o=this.ArB*e.y;return this.no_rot?(c.x=o,c.y=l):(o-=this.u_0,c.x=l*this.cosrot+o*this.sinrot,c.y=o*this.cosrot-l*this.sinrot),c.x=this.a*c.x+this.x0,c.y=this.a*c.y+this.y0,c},inverse:function(e){var t,n,i,r,s,a,o,l={};if(e.x=(e.x-this.x0)*(1/this.a),e.y=(e.y-this.y0)*(1/this.a),this.no_rot?(n=e.y,t=e.x):(n=e.x*this.cosrot-e.y*this.sinrot,t=e.y*this.cosrot+e.x*this.sinrot+this.u_0),r=.5*((i=Math.exp(-this.BrA*n))-1/i),s=.5*(i+1/i),o=((a=Math.sin(this.BrA*t))*this.cosgam+r*this.singam)/s,Math.abs(Math.abs(o)-1)<Dc)l.x=0,l.y=o<0?-Pc:Pc;else{if(l.y=this.E/Math.sqrt((1+o)/(1-o)),l.y=fh(this.e,Math.pow(l.y,1/this.B)),l.y===1/0)throw new Error;l.x=-this.rB*Math.atan2(r*this.cosgam-a*this.singam,Math.cos(this.BrA*t))}return l.x+=this.lam0,l},names:["Hotine_Oblique_Mercator","Hotine Oblique Mercator","Hotine_Oblique_Mercator_Azimuth_Natural_Origin","Hotine_Oblique_Mercator_Two_Point_Natural_Origin","Hotine_Oblique_Mercator_Azimuth_Center","Oblique_Mercator","omerc"]},Lu={init:function(){if(this.lat2||(this.lat2=this.lat1),this.k0||(this.k0=1),this.x0=this.x0||0,this.y0=this.y0||0,!(Math.abs(this.lat1+this.lat2)<Dc)){var e=this.b/this.a;this.e=Math.sqrt(1-e*e);var t=Math.sin(this.lat1),n=Math.cos(this.lat1),i=hh(this.e,t,n),r=ph(this.e,this.lat1,t),s=Math.sin(this.lat2),a=Math.cos(this.lat2),o=hh(this.e,s,a),l=ph(this.e,this.lat2,s),c=ph(this.e,this.lat0,Math.sin(this.lat0));Math.abs(this.lat1-this.lat2)>Dc?this.ns=Math.log(i/o)/Math.log(r/l):this.ns=t,isNaN(this.ns)&&(this.ns=t),this.f0=i/(this.ns*Math.pow(r,this.ns)),this.rh=this.a*this.f0*Math.pow(c,this.ns),this.title||(this.title="Lambert Conformal Conic")}},forward:function(e){var t=e.x,n=e.y;Math.abs(2*Math.abs(n)-Math.PI)<=Dc&&(n=uh(n)*(Pc-2e-10));var i,r,s=Math.abs(Math.abs(n)-Pc);if(s>Dc)i=ph(this.e,n,Math.sin(n)),r=this.a*this.f0*Math.pow(i,this.ns);else{if((s=n*this.ns)<=0)return null;r=0}var a=this.ns*dh(t-this.long0);return e.x=this.k0*(r*Math.sin(a))+this.x0,e.y=this.k0*(this.rh-r*Math.cos(a))+this.y0,e},inverse:function(e){var t,n,i,r,s,a=(e.x-this.x0)/this.k0,o=this.rh-(e.y-this.y0)/this.k0;this.ns>0?(t=Math.sqrt(a*a+o*o),n=1):(t=-Math.sqrt(a*a+o*o),n=-1);var l=0;if(0!==t&&(l=Math.atan2(n*a,n*o)),0!==t||this.ns>0){if(n=1/this.ns,i=Math.pow(t/(this.a*this.f0),n),-9999===(r=fh(this.e,i)))return null}else r=-Pc;return s=dh(l/this.ns+this.long0),e.x=s,e.y=r,e},names:["Lambert Tangential Conformal Conic Projection","Lambert_Conformal_Conic","Lambert_Conformal_Conic_1SP","Lambert_Conformal_Conic_2SP","lcc","Lambert Conic Conformal (1SP)","Lambert Conic Conformal (2SP)"]},Pu={init:function(){this.a=6377397.155,this.es=.006674372230614,this.e=Math.sqrt(this.es),this.lat0||(this.lat0=.863937979737193),this.long0||(this.long0=.4334234309119251),this.k0||(this.k0=.9999),this.s45=.785398163397448,this.s90=2*this.s45,this.fi0=this.lat0,this.e2=this.es,this.e=Math.sqrt(this.e2),this.alfa=Math.sqrt(1+this.e2*Math.pow(Math.cos(this.fi0),4)/(1-this.e2)),this.uq=1.04216856380474,this.u0=Math.asin(Math.sin(this.fi0)/this.alfa),this.g=Math.pow((1+this.e*Math.sin(this.fi0))/(1-this.e*Math.sin(this.fi0)),this.alfa*this.e/2),this.k=Math.tan(this.u0/2+this.s45)/Math.pow(Math.tan(this.fi0/2+this.s45),this.alfa)*this.g,this.k1=this.k0,this.n0=this.a*Math.sqrt(1-this.e2)/(1-this.e2*Math.pow(Math.sin(this.fi0),2)),this.s0=1.37008346281555,this.n=Math.sin(this.s0),this.ro0=this.k1*this.n0/Math.tan(this.s0),this.ad=this.s90-this.uq},forward:function(e){var t,n,i,r,s,a,o,l=e.x,c=e.y,h=dh(l-this.long0);return t=Math.pow((1+this.e*Math.sin(c))/(1-this.e*Math.sin(c)),this.alfa*this.e/2),n=2*(Math.atan(this.k*Math.pow(Math.tan(c/2+this.s45),this.alfa)/t)-this.s45),i=-h*this.alfa,r=Math.asin(Math.cos(this.ad)*Math.sin(n)+Math.sin(this.ad)*Math.cos(n)*Math.cos(i)),s=Math.asin(Math.cos(n)*Math.sin(i)/Math.cos(r)),a=this.n*s,o=this.ro0*Math.pow(Math.tan(this.s0/2+this.s45),this.n)/Math.pow(Math.tan(r/2+this.s45),this.n),e.y=o*Math.cos(a)/1,e.x=o*Math.sin(a)/1,this.czech||(e.y*=-1,e.x*=-1),e},inverse:function(e){var t,n,i,r,s,a,o,l=e.x;e.x=e.y,e.y=l,this.czech||(e.y*=-1,e.x*=-1),s=Math.sqrt(e.x*e.x+e.y*e.y),r=Math.atan2(e.y,e.x)/Math.sin(this.s0),i=2*(Math.atan(Math.pow(this.ro0/s,1/this.n)*Math.tan(this.s0/2+this.s45))-this.s45),t=Math.asin(Math.cos(this.ad)*Math.sin(i)-Math.sin(this.ad)*Math.cos(i)*Math.cos(r)),n=Math.asin(Math.cos(i)*Math.sin(r)/Math.cos(t)),e.x=this.long0-n/this.alfa,a=t,o=0;var c=0;do{e.y=2*(Math.atan(Math.pow(this.k,-1/this.alfa)*Math.pow(Math.tan(t/2+this.s45),1/this.alfa)*Math.pow((1+this.e*Math.sin(a))/(1-this.e*Math.sin(a)),this.e/2))-this.s45),Math.abs(a-e.y)<1e-10&&(o=1),a=e.y,c+=1}while(0===o&&c<15);return c>=15?null:e},names:["Krovak","krovak"]};function Du(e,t,n,i,r){return e*r-t*Math.sin(2*r)+n*Math.sin(4*r)-i*Math.sin(6*r)}function Nu(e){return 1-.25*e*(1+e/16*(3+1.25*e))}function Uu(e){return.375*e*(1+.25*e*(1+.46875*e))}function Ou(e){return.05859375*e*e*(1+.75*e)}function Fu(e){return e*e*e*(35/3072)}function ku(e,t,n){var i=t*n;return e/Math.sqrt(1-i*i)}function Qu(e){return Math.abs(e)<Pc?e:e-uh(e)*Math.PI}function zu(e,t,n,i,r){var s,a;s=e/t;for(var o=0;o<15;o++)if(s+=a=(e-(t*s-n*Math.sin(2*s)+i*Math.sin(4*s)-r*Math.sin(6*s)))/(t-2*n*Math.cos(2*s)+4*i*Math.cos(4*s)-6*r*Math.cos(6*s)),Math.abs(a)<=1e-10)return s;return NaN}const Gu={init:function(){this.sphere||(this.e0=Nu(this.es),this.e1=Uu(this.es),this.e2=Ou(this.es),this.e3=Fu(this.es),this.ml0=this.a*Du(this.e0,this.e1,this.e2,this.e3,this.lat0))},forward:function(e){var t,n,i=e.x,r=e.y;if(i=dh(i-this.long0),this.sphere)t=this.a*Math.asin(Math.cos(r)*Math.sin(i)),n=this.a*(Math.atan2(Math.tan(r),Math.cos(i))-this.lat0);else{var s=Math.sin(r),a=Math.cos(r),o=ku(this.a,this.e,s),l=Math.tan(r)*Math.tan(r),c=i*Math.cos(r),h=c*c,u=this.es*a*a/(1-this.es);t=o*c*(1-h*l*(1/6-(8-l+8*u)*h/120)),n=this.a*Du(this.e0,this.e1,this.e2,this.e3,r)-this.ml0+o*s/a*h*(.5+(5-l+6*u)*h/24)}return e.x=t+this.x0,e.y=n+this.y0,e},inverse:function(e){e.x-=this.x0,e.y-=this.y0;var t,n,i=e.x/this.a,r=e.y/this.a;if(this.sphere){var s=r+this.lat0;t=Math.asin(Math.sin(s)*Math.cos(i)),n=Math.atan2(Math.tan(i),Math.cos(s))}else{var a=zu(this.ml0/this.a+r,this.e0,this.e1,this.e2,this.e3);if(Math.abs(Math.abs(a)-Pc)<=Dc)return e.x=this.long0,e.y=Pc,r<0&&(e.y*=-1),e;var o=ku(this.a,this.e,Math.sin(a)),l=o*o*o/this.a/this.a*(1-this.es),c=Math.pow(Math.tan(a),2),h=i*this.a/o,u=h*h;t=a-o*Math.tan(a)/l*h*h*(.5-(1+3*c)*h*h/24),n=h*(1-u*(c/3+(1+3*c)*c*u/15))/Math.cos(a)}return e.x=dh(n+this.long0),e.y=Qu(t),e},names:["Cassini","Cassini_Soldner","cass"]};function Hu(e,t){var n;return e>1e-7?(1-e*e)*(t/(1-(n=e*t)*n)-.5/e*Math.log((1-n)/(1+n))):2*t}const Vu={init:function(){var e,t=Math.abs(this.lat0);if(Math.abs(t-Pc)<Dc?this.mode=this.lat0<0?this.S_POLE:this.N_POLE:Math.abs(t)<Dc?this.mode=this.EQUIT:this.mode=this.OBLIQ,this.es>0)switch(this.qp=Hu(this.e,1),this.mmf=.5/(1-this.es),this.apa=function(e){var t,n=[];return n[0]=.3333333333333333*e,t=e*e,n[0]+=.17222222222222222*t,n[1]=.06388888888888888*t,t*=e,n[0]+=.10257936507936508*t,n[1]+=.0664021164021164*t,n[2]=.016415012942191543*t,n}(this.es),this.mode){case this.N_POLE:case this.S_POLE:this.dd=1;break;case this.EQUIT:this.rq=Math.sqrt(.5*this.qp),this.dd=1/this.rq,this.xmf=1,this.ymf=.5*this.qp;break;case this.OBLIQ:this.rq=Math.sqrt(.5*this.qp),e=Math.sin(this.lat0),this.sinb1=Hu(this.e,e)/this.qp,this.cosb1=Math.sqrt(1-this.sinb1*this.sinb1),this.dd=Math.cos(this.lat0)/(Math.sqrt(1-this.es*e*e)*this.rq*this.cosb1),this.ymf=(this.xmf=this.rq)/this.dd,this.xmf*=this.dd}else this.mode===this.OBLIQ&&(this.sinph0=Math.sin(this.lat0),this.cosph0=Math.cos(this.lat0))},forward:function(e){var t,n,i,r,s,a,o,l,c,h,u=e.x,d=e.y;if(u=dh(u-this.long0),this.sphere){if(s=Math.sin(d),h=Math.cos(d),i=Math.cos(u),this.mode===this.OBLIQ||this.mode===this.EQUIT){if((n=this.mode===this.EQUIT?1+h*i:1+this.sinph0*s+this.cosph0*h*i)<=Dc)return null;t=(n=Math.sqrt(2/n))*h*Math.sin(u),n*=this.mode===this.EQUIT?s:this.cosph0*s-this.sinph0*h*i}else if(this.mode===this.N_POLE||this.mode===this.S_POLE){if(this.mode===this.N_POLE&&(i=-i),Math.abs(d+this.lat0)<Dc)return null;n=Oc-.5*d,t=(n=2*(this.mode===this.S_POLE?Math.cos(n):Math.sin(n)))*Math.sin(u),n*=i}}else{switch(o=0,l=0,c=0,i=Math.cos(u),r=Math.sin(u),s=Math.sin(d),a=Hu(this.e,s),this.mode!==this.OBLIQ&&this.mode!==this.EQUIT||(o=a/this.qp,l=Math.sqrt(1-o*o)),this.mode){case this.OBLIQ:c=1+this.sinb1*o+this.cosb1*l*i;break;case this.EQUIT:c=1+l*i;break;case this.N_POLE:c=Pc+d,a=this.qp-a;break;case this.S_POLE:c=d-Pc,a=this.qp+a}if(Math.abs(c)<Dc)return null;switch(this.mode){case this.OBLIQ:case this.EQUIT:c=Math.sqrt(2/c),n=this.mode===this.OBLIQ?this.ymf*c*(this.cosb1*o-this.sinb1*l*i):(c=Math.sqrt(2/(1+l*i)))*o*this.ymf,t=this.xmf*c*l*r;break;case this.N_POLE:case this.S_POLE:a>=0?(t=(c=Math.sqrt(a))*r,n=i*(this.mode===this.S_POLE?c:-c)):t=n=0}}return e.x=this.a*t+this.x0,e.y=this.a*n+this.y0,e},inverse:function(e){e.x-=this.x0,e.y-=this.y0;var t,n,i,r,s,a,o,l,c,h,u=e.x/this.a,d=e.y/this.a;if(this.sphere){var p,f=0,m=0;if((n=.5*(p=Math.sqrt(u*u+d*d)))>1)return null;switch(n=2*Math.asin(n),this.mode!==this.OBLIQ&&this.mode!==this.EQUIT||(m=Math.sin(n),f=Math.cos(n)),this.mode){case this.EQUIT:n=Math.abs(p)<=Dc?0:Math.asin(d*m/p),u*=m,d=f*p;break;case this.OBLIQ:n=Math.abs(p)<=Dc?this.lat0:Math.asin(f*this.sinph0+d*m*this.cosph0/p),u*=m*this.cosph0,d=(f-Math.sin(n)*this.sinph0)*p;break;case this.N_POLE:d=-d,n=Pc-n;break;case this.S_POLE:n-=Pc}t=0!==d||this.mode!==this.EQUIT&&this.mode!==this.OBLIQ?Math.atan2(u,d):0}else{if(o=0,this.mode===this.OBLIQ||this.mode===this.EQUIT){if(u/=this.dd,d*=this.dd,(a=Math.sqrt(u*u+d*d))<Dc)return e.x=this.long0,e.y=this.lat0,e;r=2*Math.asin(.5*a/this.rq),i=Math.cos(r),u*=r=Math.sin(r),this.mode===this.OBLIQ?(o=i*this.sinb1+d*r*this.cosb1/a,s=this.qp*o,d=a*this.cosb1*i-d*this.sinb1*r):(o=d*r/a,s=this.qp*o,d=a*i)}else if(this.mode===this.N_POLE||this.mode===this.S_POLE){if(this.mode===this.N_POLE&&(d=-d),!(s=u*u+d*d))return e.x=this.long0,e.y=this.lat0,e;o=1-s/this.qp,this.mode===this.S_POLE&&(o=-o)}t=Math.atan2(u,d),l=Math.asin(o),c=this.apa,h=l+l,n=l+c[0]*Math.sin(h)+c[1]*Math.sin(h+h)+c[2]*Math.sin(h+h+h)}return e.x=dh(this.long0+t),e.y=n,e},names:["Lambert Azimuthal Equal Area","Lambert_Azimuthal_Equal_Area","laea"],S_POLE:1,N_POLE:2,EQUIT:3,OBLIQ:4};function ju(e){return Math.abs(e)>1&&(e=e>1?1:-1),Math.asin(e)}const qu={init:function(){Math.abs(this.lat1+this.lat2)<Dc||(this.temp=this.b/this.a,this.es=1-Math.pow(this.temp,2),this.e3=Math.sqrt(this.es),this.sin_po=Math.sin(this.lat1),this.cos_po=Math.cos(this.lat1),this.t1=this.sin_po,this.con=this.sin_po,this.ms1=hh(this.e3,this.sin_po,this.cos_po),this.qs1=Hu(this.e3,this.sin_po),this.sin_po=Math.sin(this.lat2),this.cos_po=Math.cos(this.lat2),this.t2=this.sin_po,this.ms2=hh(this.e3,this.sin_po,this.cos_po),this.qs2=Hu(this.e3,this.sin_po),this.sin_po=Math.sin(this.lat0),this.cos_po=Math.cos(this.lat0),this.t3=this.sin_po,this.qs0=Hu(this.e3,this.sin_po),Math.abs(this.lat1-this.lat2)>Dc?this.ns0=(this.ms1*this.ms1-this.ms2*this.ms2)/(this.qs2-this.qs1):this.ns0=this.con,this.c=this.ms1*this.ms1+this.ns0*this.qs1,this.rh=this.a*Math.sqrt(this.c-this.ns0*this.qs0)/this.ns0)},forward:function(e){var t=e.x,n=e.y;this.sin_phi=Math.sin(n),this.cos_phi=Math.cos(n);var i=Hu(this.e3,this.sin_phi),r=this.a*Math.sqrt(this.c-this.ns0*i)/this.ns0,s=this.ns0*dh(t-this.long0),a=r*Math.sin(s)+this.x0,o=this.rh-r*Math.cos(s)+this.y0;return e.x=a,e.y=o,e},inverse:function(e){var t,n,i,r,s,a;return e.x-=this.x0,e.y=this.rh-e.y+this.y0,this.ns0>=0?(t=Math.sqrt(e.x*e.x+e.y*e.y),i=1):(t=-Math.sqrt(e.x*e.x+e.y*e.y),i=-1),r=0,0!==t&&(r=Math.atan2(i*e.x,i*e.y)),i=t*this.ns0/this.a,this.sphere?a=Math.asin((this.c-i*i)/(2*this.ns0)):(n=(this.c-i*i)/this.ns0,a=this.phi1z(this.e3,n)),s=dh(r/this.ns0+this.long0),e.x=s,e.y=a,e},names:["Albers_Conic_Equal_Area","Albers","aea"],phi1z:function(e,t){var n,i,r,s,a=ju(.5*t);if(e<Dc)return a;for(var o=e*e,l=1;l<=25;l++)if(a+=s=.5*(r=1-(i=e*(n=Math.sin(a)))*i)*r/Math.cos(a)*(t/(1-o)-n/r+.5/e*Math.log((1-i)/(1+i))),Math.abs(s)<=1e-7)return a;return null}},Wu={init:function(){this.sin_p14=Math.sin(this.lat0),this.cos_p14=Math.cos(this.lat0),this.infinity_dist=1e3*this.a,this.rc=1},forward:function(e){var t,n,i,r,s,a,o,l=e.x,c=e.y;return i=dh(l-this.long0),t=Math.sin(c),n=Math.cos(c),r=Math.cos(i),(s=this.sin_p14*t+this.cos_p14*n*r)>0||Math.abs(s)<=Dc?(a=this.x0+1*this.a*n*Math.sin(i)/s,o=this.y0+1*this.a*(this.cos_p14*t-this.sin_p14*n*r)/s):(a=this.x0+this.infinity_dist*n*Math.sin(i),o=this.y0+this.infinity_dist*(this.cos_p14*t-this.sin_p14*n*r)),e.x=a,e.y=o,e},inverse:function(e){var t,n,i,r,s,a;return e.x=(e.x-this.x0)/this.a,e.y=(e.y-this.y0)/this.a,e.x/=this.k0,e.y/=this.k0,(t=Math.sqrt(e.x*e.x+e.y*e.y))?(r=Math.atan2(t,this.rc),n=Math.sin(r),a=ju((i=Math.cos(r))*this.sin_p14+e.y*n*this.cos_p14/t),s=Math.atan2(e.x*n,t*this.cos_p14*i-e.y*this.sin_p14*n),s=dh(this.long0+s)):(a=this.phic0,s=0),e.x=s,e.y=a,e},names:["gnom"]},Yu={init:function(){this.sphere||(this.k0=hh(this.e,Math.sin(this.lat_ts),Math.cos(this.lat_ts)))},forward:function(e){var t,n,i=e.x,r=e.y,s=dh(i-this.long0);if(this.sphere)t=this.x0+this.a*s*Math.cos(this.lat_ts),n=this.y0+this.a*Math.sin(r)/Math.cos(this.lat_ts);else{var a=Hu(this.e,Math.sin(r));t=this.x0+this.a*this.k0*s,n=this.y0+this.a*a*.5/this.k0}return e.x=t,e.y=n,e},inverse:function(e){var t,n;return e.x-=this.x0,e.y-=this.y0,this.sphere?(t=dh(this.long0+e.x/this.a/Math.cos(this.lat_ts)),n=Math.asin(e.y/this.a*Math.cos(this.lat_ts))):(n=function(e,t){var n=1-(1-e*e)/(2*e)*Math.log((1-e)/(1+e));if(Math.abs(Math.abs(t)-n)<1e-6)return t<0?-1*Pc:Pc;for(var i,r,s,a,o=Math.asin(.5*t),l=0;l<30;l++)if(r=Math.sin(o),s=Math.cos(o),a=e*r,o+=i=Math.pow(1-a*a,2)/(2*s)*(t/(1-e*e)-r/(1-a*a)+.5/e*Math.log((1-a)/(1+a))),Math.abs(i)<=1e-10)return o;return NaN}(this.e,2*e.y*this.k0/this.a),t=dh(this.long0+e.x/(this.a*this.k0))),e.x=t,e.y=n,e},names:["cea"]},Xu={init:function(){this.x0=this.x0||0,this.y0=this.y0||0,this.lat0=this.lat0||0,this.long0=this.long0||0,this.lat_ts=this.lat_ts||0,this.title=this.title||"Equidistant Cylindrical (Plate Carre)",this.rc=Math.cos(this.lat_ts)},forward:function(e){var t=e.x,n=e.y,i=dh(t-this.long0),r=Qu(n-this.lat0);return e.x=this.x0+this.a*i*this.rc,e.y=this.y0+this.a*r,e},inverse:function(e){var t=e.x,n=e.y;return e.x=dh(this.long0+(t-this.x0)/(this.a*this.rc)),e.y=Qu(this.lat0+(n-this.y0)/this.a),e},names:["Equirectangular","Equidistant_Cylindrical","eqc"]},Ku={init:function(){this.temp=this.b/this.a,this.es=1-Math.pow(this.temp,2),this.e=Math.sqrt(this.es),this.e0=Nu(this.es),this.e1=Uu(this.es),this.e2=Ou(this.es),this.e3=Fu(this.es),this.ml0=this.a*Du(this.e0,this.e1,this.e2,this.e3,this.lat0)},forward:function(e){var t,n,i,r=e.x,s=e.y,a=dh(r-this.long0);if(i=a*Math.sin(s),this.sphere)Math.abs(s)<=Dc?(t=this.a*a,n=-1*this.a*this.lat0):(t=this.a*Math.sin(i)/Math.tan(s),n=this.a*(Qu(s-this.lat0)+(1-Math.cos(i))/Math.tan(s)));else if(Math.abs(s)<=Dc)t=this.a*a,n=-1*this.ml0;else{var o=ku(this.a,this.e,Math.sin(s))/Math.tan(s);t=o*Math.sin(i),n=this.a*Du(this.e0,this.e1,this.e2,this.e3,s)-this.ml0+o*(1-Math.cos(i))}return e.x=t+this.x0,e.y=n+this.y0,e},inverse:function(e){var t,n,i,r,s,a,o,l,c;if(i=e.x-this.x0,r=e.y-this.y0,this.sphere)if(Math.abs(r+this.a*this.lat0)<=Dc)t=dh(i/this.a+this.long0),n=0;else{var h;for(a=this.lat0+r/this.a,o=i*i/this.a/this.a+a*a,l=a,s=20;s;--s)if(l+=c=-1*(a*(l*(h=Math.tan(l))+1)-l-.5*(l*l+o)*h)/((l-a)/h-1),Math.abs(c)<=Dc){n=l;break}t=dh(this.long0+Math.asin(i*Math.tan(l)/this.a)/Math.sin(n))}else if(Math.abs(r+this.ml0)<=Dc)n=0,t=dh(this.long0+i/this.a);else{var u,d,p,f,m;for(a=(this.ml0+r)/this.a,o=i*i/this.a/this.a+a*a,l=a,s=20;s;--s)if(m=this.e*Math.sin(l),u=Math.sqrt(1-m*m)*Math.tan(l),d=this.a*Du(this.e0,this.e1,this.e2,this.e3,l),p=this.e0-2*this.e1*Math.cos(2*l)+4*this.e2*Math.cos(4*l)-6*this.e3*Math.cos(6*l),l-=c=(a*(u*(f=d/this.a)+1)-f-.5*u*(f*f+o))/(this.es*Math.sin(2*l)*(f*f+o-2*a*f)/(4*u)+(a-f)*(u*p-2/Math.sin(2*l))-p),Math.abs(c)<=Dc){n=l;break}u=Math.sqrt(1-this.es*Math.pow(Math.sin(n),2))*Math.tan(n),t=dh(this.long0+Math.asin(i*u/this.a)/Math.sin(n))}return e.x=t,e.y=n,e},names:["Polyconic","poly"]},Ju={init:function(){this.A=[],this.A[1]=.6399175073,this.A[2]=-.1358797613,this.A[3]=.063294409,this.A[4]=-.02526853,this.A[5]=.0117879,this.A[6]=-.0055161,this.A[7]=.0026906,this.A[8]=-.001333,this.A[9]=67e-5,this.A[10]=-34e-5,this.B_re=[],this.B_im=[],this.B_re[1]=.7557853228,this.B_im[1]=0,this.B_re[2]=.249204646,this.B_im[2]=.003371507,this.B_re[3]=-.001541739,this.B_im[3]=.04105856,this.B_re[4]=-.10162907,this.B_im[4]=.01727609,this.B_re[5]=-.26623489,this.B_im[5]=-.36249218,this.B_re[6]=-.6870983,this.B_im[6]=-1.1651967,this.C_re=[],this.C_im=[],this.C_re[1]=1.3231270439,this.C_im[1]=0,this.C_re[2]=-.577245789,this.C_im[2]=-.007809598,this.C_re[3]=.508307513,this.C_im[3]=-.112208952,this.C_re[4]=-.15094762,this.C_im[4]=.18200602,this.C_re[5]=1.01418179,this.C_im[5]=1.64497696,this.C_re[6]=1.9660549,this.C_im[6]=2.5127645,this.D=[],this.D[1]=1.5627014243,this.D[2]=.5185406398,this.D[3]=-.03333098,this.D[4]=-.1052906,this.D[5]=-.0368594,this.D[6]=.007317,this.D[7]=.0122,this.D[8]=.00394,this.D[9]=-.0013},forward:function(e){var t,n=e.x,i=e.y-this.lat0,r=n-this.long0,s=i/Lc*1e-5,a=r,o=1,l=0;for(t=1;t<=10;t++)o*=s,l+=this.A[t]*o;var c,h=l,u=a,d=1,p=0,f=0,m=0;for(t=1;t<=6;t++)c=p*h+d*u,d=d*h-p*u,p=c,f=f+this.B_re[t]*d-this.B_im[t]*p,m=m+this.B_im[t]*d+this.B_re[t]*p;return e.x=m*this.a+this.x0,e.y=f*this.a+this.y0,e},inverse:function(e){var t,n,i=e.x,r=e.y,s=i-this.x0,a=(r-this.y0)/this.a,o=s/this.a,l=1,c=0,h=0,u=0;for(t=1;t<=6;t++)n=c*a+l*o,l=l*a-c*o,c=n,h=h+this.C_re[t]*l-this.C_im[t]*c,u=u+this.C_im[t]*l+this.C_re[t]*c;for(var d=0;d<this.iterations;d++){var p,f=h,m=u,g=a,A=o;for(t=2;t<=6;t++)p=m*h+f*u,f=f*h-m*u,m=p,g+=(t-1)*(this.B_re[t]*f-this.B_im[t]*m),A+=(t-1)*(this.B_im[t]*f+this.B_re[t]*m);f=1,m=0;var y=this.B_re[1],v=this.B_im[1];for(t=2;t<=6;t++)p=m*h+f*u,f=f*h-m*u,m=p,y+=t*(this.B_re[t]*f-this.B_im[t]*m),v+=t*(this.B_im[t]*f+this.B_re[t]*m);var _=y*y+v*v;h=(g*y+A*v)/_,u=(A*y-g*v)/_}var x=h,E=u,b=1,w=0;for(t=1;t<=9;t++)b*=x,w+=this.D[t]*b;var M=this.lat0+w*Lc*1e5,S=this.long0+E;return e.x=S,e.y=M,e},names:["New_Zealand_Map_Grid","nzmg"]},$u={init:function(){},forward:function(e){var t=e.x,n=e.y,i=dh(t-this.long0),r=this.x0+this.a*i,s=this.y0+this.a*Math.log(Math.tan(Math.PI/4+n/2.5))*1.25;return e.x=r,e.y=s,e},inverse:function(e){e.x-=this.x0,e.y-=this.y0;var t=dh(this.long0+e.x/this.a),n=2.5*(Math.atan(Math.exp(.8*e.y/this.a))-Math.PI/4);return e.x=t,e.y=n,e},names:["Miller_Cylindrical","mill"]},Zu={init:function(){this.sphere?(this.n=1,this.m=0,this.es=0,this.C_y=Math.sqrt((this.m+1)/this.n),this.C_x=this.C_y/(this.m+1)):this.en=mu(this.es)},forward:function(e){var t,n,i=e.x,r=e.y;if(i=dh(i-this.long0),this.sphere){if(this.m)for(var s=this.n*Math.sin(r),a=20;a;--a){var o=(this.m*r+Math.sin(r)-s)/(this.m+Math.cos(r));if(r-=o,Math.abs(o)<Dc)break}else r=1!==this.n?Math.asin(this.n*Math.sin(r)):r;t=this.a*this.C_x*i*(this.m+Math.cos(r)),n=this.a*this.C_y*r}else{var l=Math.sin(r),c=Math.cos(r);n=this.a*gu(r,l,c,this.en),t=this.a*i*c/Math.sqrt(1-this.es*l*l)}return e.x=t,e.y=n,e},inverse:function(e){var t,n,i;return e.x-=this.x0,n=e.x/this.a,e.y-=this.y0,t=e.y/this.a,this.sphere?(t/=this.C_y,n/=this.C_x*(this.m+Math.cos(t)),this.m?t=ju((this.m*t+Math.sin(t))/this.n):1!==this.n&&(t=ju(Math.sin(t)/this.n)),n=dh(n+this.long0),t=Qu(t)):(t=Au(e.y/this.a,this.es,this.en),(i=Math.abs(t))<Pc?(i=Math.sin(t),n=dh(this.long0+e.x*Math.sqrt(1-this.es*i*i)/(this.a*Math.cos(t)))):i-Dc<Pc&&(n=this.long0)),e.x=n,e.y=t,e},names:["Sinusoidal","sinu"]},ed={init:function(){},forward:function(e){for(var t=e.x,n=e.y,i=dh(t-this.long0),r=n,s=Math.PI*Math.sin(n);;){var a=-(r+Math.sin(r)-s)/(1+Math.cos(r));if(r+=a,Math.abs(a)<Dc)break}r/=2,Math.PI/2-Math.abs(n)<Dc&&(i=0);var o=.900316316158*this.a*i*Math.cos(r)+this.x0,l=1.4142135623731*this.a*Math.sin(r)+this.y0;return e.x=o,e.y=l,e},inverse:function(e){var t,n;e.x-=this.x0,e.y-=this.y0,n=e.y/(1.4142135623731*this.a),Math.abs(n)>.999999999999&&(n=.999999999999),t=Math.asin(n);var i=dh(this.long0+e.x/(.900316316158*this.a*Math.cos(t)));i<-Math.PI&&(i=-Math.PI),i>Math.PI&&(i=Math.PI),n=(2*t+Math.sin(2*t))/Math.PI,Math.abs(n)>1&&(n=1);var r=Math.asin(n);return e.x=i,e.y=r,e},names:["Mollweide","moll"]},td={init:function(){Math.abs(this.lat1+this.lat2)<Dc||(this.lat2=this.lat2||this.lat1,this.temp=this.b/this.a,this.es=1-Math.pow(this.temp,2),this.e=Math.sqrt(this.es),this.e0=Nu(this.es),this.e1=Uu(this.es),this.e2=Ou(this.es),this.e3=Fu(this.es),this.sinphi=Math.sin(this.lat1),this.cosphi=Math.cos(this.lat1),this.ms1=hh(this.e,this.sinphi,this.cosphi),this.ml1=Du(this.e0,this.e1,this.e2,this.e3,this.lat1),Math.abs(this.lat1-this.lat2)<Dc?this.ns=this.sinphi:(this.sinphi=Math.sin(this.lat2),this.cosphi=Math.cos(this.lat2),this.ms2=hh(this.e,this.sinphi,this.cosphi),this.ml2=Du(this.e0,this.e1,this.e2,this.e3,this.lat2),this.ns=(this.ms1-this.ms2)/(this.ml2-this.ml1)),this.g=this.ml1+this.ms1/this.ns,this.ml0=Du(this.e0,this.e1,this.e2,this.e3,this.lat0),this.rh=this.a*(this.g-this.ml0))},forward:function(e){var t,n=e.x,i=e.y;if(this.sphere)t=this.a*(this.g-i);else{var r=Du(this.e0,this.e1,this.e2,this.e3,i);t=this.a*(this.g-r)}var s=this.ns*dh(n-this.long0),a=this.x0+t*Math.sin(s),o=this.y0+this.rh-t*Math.cos(s);return e.x=a,e.y=o,e},inverse:function(e){var t,n,i,r;e.x-=this.x0,e.y=this.rh-e.y+this.y0,this.ns>=0?(n=Math.sqrt(e.x*e.x+e.y*e.y),t=1):(n=-Math.sqrt(e.x*e.x+e.y*e.y),t=-1);var s=0;return 0!==n&&(s=Math.atan2(t*e.x,t*e.y)),this.sphere?(r=dh(this.long0+s/this.ns),i=Qu(this.g-n/this.a),e.x=r,e.y=i,e):(i=zu(this.g-n/this.a,this.e0,this.e1,this.e2,this.e3),r=dh(this.long0+s/this.ns),e.x=r,e.y=i,e)},names:["Equidistant_Conic","eqdc"]},nd={init:function(){this.R=this.a},forward:function(e){var t,n,i=e.x,r=e.y,s=dh(i-this.long0);Math.abs(r)<=Dc&&(t=this.x0+this.R*s,n=this.y0);var a=ju(2*Math.abs(r/Math.PI));(Math.abs(s)<=Dc||Math.abs(Math.abs(r)-Pc)<=Dc)&&(t=this.x0,n=r>=0?this.y0+Math.PI*this.R*Math.tan(.5*a):this.y0+Math.PI*this.R*-Math.tan(.5*a));var o=.5*Math.abs(Math.PI/s-s/Math.PI),l=o*o,c=Math.sin(a),h=Math.cos(a),u=h/(c+h-1),d=u*u,p=u*(2/c-1),f=p*p,m=Math.PI*this.R*(o*(u-f)+Math.sqrt(l*(u-f)*(u-f)-(f+l)*(d-f)))/(f+l);s<0&&(m=-m),t=this.x0+m;var g=l+u;return m=Math.PI*this.R*(p*g-o*Math.sqrt((f+l)*(l+1)-g*g))/(f+l),n=r>=0?this.y0+m:this.y0-m,e.x=t,e.y=n,e},inverse:function(e){var t,n,i,r,s,a,o,l,c,h,u,d;return e.x-=this.x0,e.y-=this.y0,u=Math.PI*this.R,s=(i=e.x/u)*i+(r=e.y/u)*r,u=3*(r*r/(l=-2*(a=-Math.abs(r)*(1+s))+1+2*r*r+s*s)+(2*(o=a-2*r*r+i*i)*o*o/l/l/l-9*a*o/l/l)/27)/(c=(a-o*o/3/l)/l)/(h=2*Math.sqrt(-c/3)),Math.abs(u)>1&&(u=u>=0?1:-1),d=Math.acos(u)/3,n=e.y>=0?(-h*Math.cos(d+Math.PI/3)-o/3/l)*Math.PI:-(-h*Math.cos(d+Math.PI/3)-o/3/l)*Math.PI,t=Math.abs(i)<Dc?this.long0:dh(this.long0+Math.PI*(s-1+Math.sqrt(1+2*(i*i-r*r)+s*s))/2/i),e.x=t,e.y=n,e},names:["Van_der_Grinten_I","VanDerGrinten","vandg"]},id={init:function(){this.sin_p12=Math.sin(this.lat0),this.cos_p12=Math.cos(this.lat0)},forward:function(e){var t,n,i,r,s,a,o,l,c,h,u,d,p,f,m,g,A,y,v,_,x,E,b=e.x,w=e.y,M=Math.sin(e.y),S=Math.cos(e.y),C=dh(b-this.long0);return this.sphere?Math.abs(this.sin_p12-1)<=Dc?(e.x=this.x0+this.a*(Pc-w)*Math.sin(C),e.y=this.y0-this.a*(Pc-w)*Math.cos(C),e):Math.abs(this.sin_p12+1)<=Dc?(e.x=this.x0+this.a*(Pc+w)*Math.sin(C),e.y=this.y0+this.a*(Pc+w)*Math.cos(C),e):(y=this.sin_p12*M+this.cos_p12*S*Math.cos(C),A=(g=Math.acos(y))?g/Math.sin(g):1,e.x=this.x0+this.a*A*S*Math.sin(C),e.y=this.y0+this.a*A*(this.cos_p12*M-this.sin_p12*S*Math.cos(C)),e):(t=Nu(this.es),n=Uu(this.es),i=Ou(this.es),r=Fu(this.es),Math.abs(this.sin_p12-1)<=Dc?(s=this.a*Du(t,n,i,r,Pc),a=this.a*Du(t,n,i,r,w),e.x=this.x0+(s-a)*Math.sin(C),e.y=this.y0-(s-a)*Math.cos(C),e):Math.abs(this.sin_p12+1)<=Dc?(s=this.a*Du(t,n,i,r,Pc),a=this.a*Du(t,n,i,r,w),e.x=this.x0+(s+a)*Math.sin(C),e.y=this.y0+(s+a)*Math.cos(C),e):(o=M/S,l=ku(this.a,this.e,this.sin_p12),c=ku(this.a,this.e,M),h=Math.atan((1-this.es)*o+this.es*l*this.sin_p12/(c*S)),v=0===(u=Math.atan2(Math.sin(C),this.cos_p12*Math.tan(h)-this.sin_p12*Math.cos(C)))?Math.asin(this.cos_p12*Math.sin(h)-this.sin_p12*Math.cos(h)):Math.abs(Math.abs(u)-Math.PI)<=Dc?-Math.asin(this.cos_p12*Math.sin(h)-this.sin_p12*Math.cos(h)):Math.asin(Math.sin(C)*Math.cos(h)/Math.sin(u)),d=this.e*this.sin_p12/Math.sqrt(1-this.es),g=l*v*(1-(_=v*v)*(m=(p=this.e*this.cos_p12*Math.cos(u)/Math.sqrt(1-this.es))*p)*(1-m)/6+(x=_*v)/8*(f=d*p)*(1-2*m)+(E=x*v)/120*(m*(4-7*m)-3*d*d*(1-7*m))-E*v/48*f),e.x=this.x0+g*Math.sin(u),e.y=this.y0+g*Math.cos(u),e))},inverse:function(e){var t,n,i,r,s,a,o,l,c,h,u,d,p,f,m,g,A,y,v,_,x,E,b;if(e.x-=this.x0,e.y-=this.y0,this.sphere){if((t=Math.sqrt(e.x*e.x+e.y*e.y))>2*Pc*this.a)return;return n=t/this.a,i=Math.sin(n),r=Math.cos(n),s=this.long0,Math.abs(t)<=Dc?a=this.lat0:(a=ju(r*this.sin_p12+e.y*i*this.cos_p12/t),o=Math.abs(this.lat0)-Pc,s=Math.abs(o)<=Dc?this.lat0>=0?dh(this.long0+Math.atan2(e.x,-e.y)):dh(this.long0-Math.atan2(-e.x,e.y)):dh(this.long0+Math.atan2(e.x*i,t*this.cos_p12*r-e.y*this.sin_p12*i))),e.x=s,e.y=a,e}return l=Nu(this.es),c=Uu(this.es),h=Ou(this.es),u=Fu(this.es),Math.abs(this.sin_p12-1)<=Dc?(a=zu(((d=this.a*Du(l,c,h,u,Pc))-(t=Math.sqrt(e.x*e.x+e.y*e.y)))/this.a,l,c,h,u),s=dh(this.long0+Math.atan2(e.x,-1*e.y)),e.x=s,e.y=a,e):Math.abs(this.sin_p12+1)<=Dc?(d=this.a*Du(l,c,h,u,Pc),a=zu(((t=Math.sqrt(e.x*e.x+e.y*e.y))-d)/this.a,l,c,h,u),s=dh(this.long0+Math.atan2(e.x,e.y)),e.x=s,e.y=a,e):(t=Math.sqrt(e.x*e.x+e.y*e.y),m=Math.atan2(e.x,e.y),p=ku(this.a,this.e,this.sin_p12),g=Math.cos(m),y=-(A=this.e*this.cos_p12*g)*A/(1-this.es),v=3*this.es*(1-y)*this.sin_p12*this.cos_p12*g/(1-this.es),E=1-y*(x=(_=t/p)-y*(1+y)*Math.pow(_,3)/6-v*(1+3*y)*Math.pow(_,4)/24)*x/2-_*x*x*x/6,f=Math.asin(this.sin_p12*Math.cos(x)+this.cos_p12*Math.sin(x)*g),s=dh(this.long0+Math.asin(Math.sin(m)*Math.sin(x)/Math.cos(f))),b=Math.sin(f),a=Math.atan2((b-this.es*E*this.sin_p12)*Math.tan(f),b*(1-this.es)),e.x=s,e.y=a,e)},names:["Azimuthal_Equidistant","aeqd"]},rd={init:function(){this.sin_p14=Math.sin(this.lat0),this.cos_p14=Math.cos(this.lat0)},forward:function(e){var t,n,i,r,s,a,o,l=e.x,c=e.y;return i=dh(l-this.long0),t=Math.sin(c),n=Math.cos(c),r=Math.cos(i),((s=this.sin_p14*t+this.cos_p14*n*r)>0||Math.abs(s)<=Dc)&&(a=1*this.a*n*Math.sin(i),o=this.y0+1*this.a*(this.cos_p14*t-this.sin_p14*n*r)),e.x=a,e.y=o,e},inverse:function(e){var t,n,i,r,s,a,o;return e.x-=this.x0,e.y-=this.y0,n=ju((t=Math.sqrt(e.x*e.x+e.y*e.y))/this.a),i=Math.sin(n),r=Math.cos(n),a=this.long0,Math.abs(t)<=Dc?(o=this.lat0,e.x=a,e.y=o,e):(o=ju(r*this.sin_p14+e.y*i*this.cos_p14/t),s=Math.abs(this.lat0)-Pc,Math.abs(s)<=Dc?(a=this.lat0>=0?dh(this.long0+Math.atan2(e.x,-e.y)):dh(this.long0-Math.atan2(-e.x,e.y)),e.x=a,e.y=o,e):(a=dh(this.long0+Math.atan2(e.x*i,t*this.cos_p14*r-e.y*this.sin_p14*i)),e.x=a,e.y=o,e))},names:["ortho"]};function sd(e,t,n,i){var r;return e<Dc?(i.value=1,r=0):(r=Math.atan2(t,n),Math.abs(r)<=Oc?i.value=1:r>Oc&&r<=Pc+Oc?(i.value=2,r-=Pc):r>Pc+Oc||r<=-(Pc+Oc)?(i.value=3,r=r>=0?r-kc:r+kc):(i.value=4,r+=Pc)),r}function ad(e,t){var n=e+t;return n<-kc?n+=Fc:n>+kc&&(n-=Fc),n}const od={init:function(){this.x0=this.x0||0,this.y0=this.y0||0,this.lat0=this.lat0||0,this.long0=this.long0||0,this.lat_ts=this.lat_ts||0,this.title=this.title||"Quadrilateralized Spherical Cube",this.lat0>=Pc-Oc/2?this.face=5:this.lat0<=-(Pc-Oc/2)?this.face=6:Math.abs(this.long0)<=Oc?this.face=1:Math.abs(this.long0)<=Pc+Oc?this.face=this.long0>0?2:4:this.face=3,0!==this.es&&(this.one_minus_f=1-(this.a-this.b)/this.a,this.one_minus_f_squared=this.one_minus_f*this.one_minus_f)},forward:function(e){var t,n,i,r,s,a,o={x:0,y:0},l={value:0};if(e.x-=this.long0,t=0!==this.es?Math.atan(this.one_minus_f_squared*Math.tan(e.y)):e.y,n=e.x,5===this.face)r=Pc-t,n>=Oc&&n<=Pc+Oc?(l.value=1,i=n-Pc):n>Pc+Oc||n<=-(Pc+Oc)?(l.value=2,i=n>0?n-kc:n+kc):n>-(Pc+Oc)&&n<=-Oc?(l.value=3,i=n+Pc):(l.value=4,i=n);else if(6===this.face)r=Pc+t,n>=Oc&&n<=Pc+Oc?(l.value=1,i=-n+Pc):n<Oc&&n>=-Oc?(l.value=2,i=-n):n<-Oc&&n>=-(Pc+Oc)?(l.value=3,i=-n-Pc):(l.value=4,i=n>0?-n+kc:-n-kc);else{var c,h,u,d,p,f;2===this.face?n=ad(n,+Pc):3===this.face?n=ad(n,+kc):4===this.face&&(n=ad(n,-Pc)),d=Math.sin(t),p=Math.cos(t),f=Math.sin(n),c=p*Math.cos(n),h=p*f,u=d,1===this.face?i=sd(r=Math.acos(c),u,h,l):2===this.face?i=sd(r=Math.acos(h),u,-c,l):3===this.face?i=sd(r=Math.acos(-c),u,-h,l):4===this.face?i=sd(r=Math.acos(-h),u,c,l):(r=i=0,l.value=1)}return a=Math.atan(12/kc*(i+Math.acos(Math.sin(i)*Math.cos(Oc))-Pc)),s=Math.sqrt((1-Math.cos(r))/(Math.cos(a)*Math.cos(a))/(1-Math.cos(Math.atan(1/Math.cos(i))))),2===l.value?a+=Pc:3===l.value?a+=kc:4===l.value&&(a+=1.5*kc),o.x=s*Math.cos(a),o.y=s*Math.sin(a),o.x=o.x*this.a+this.x0,o.y=o.y*this.a+this.y0,e.x=o.x,e.y=o.y,e},inverse:function(e){var t,n,i,r,s,a,o,l,c,h,u,d,p={lam:0,phi:0},f={value:0};if(e.x=(e.x-this.x0)/this.a,e.y=(e.y-this.y0)/this.a,n=Math.atan(Math.sqrt(e.x*e.x+e.y*e.y)),t=Math.atan2(e.y,e.x),e.x>=0&&e.x>=Math.abs(e.y)?f.value=1:e.y>=0&&e.y>=Math.abs(e.x)?(f.value=2,t-=Pc):e.x<0&&-e.x>=Math.abs(e.y)?(f.value=3,t=t<0?t+kc:t-kc):(f.value=4,t+=Pc),c=kc/12*Math.tan(t),s=Math.sin(c)/(Math.cos(c)-1/Math.sqrt(2)),a=Math.atan(s),(o=1-(i=Math.cos(t))*i*(r=Math.tan(n))*r*(1-Math.cos(Math.atan(1/Math.cos(a)))))<-1?o=-1:o>1&&(o=1),5===this.face)l=Math.acos(o),p.phi=Pc-l,1===f.value?p.lam=a+Pc:2===f.value?p.lam=a<0?a+kc:a-kc:3===f.value?p.lam=a-Pc:p.lam=a;else if(6===this.face)l=Math.acos(o),p.phi=l-Pc,1===f.value?p.lam=-a+Pc:2===f.value?p.lam=-a:3===f.value?p.lam=-a-Pc:p.lam=a<0?-a-kc:-a+kc;else{var m,g,A;c=(m=o)*m,g=(c+=(A=c>=1?0:Math.sqrt(1-c)*Math.sin(a))*A)>=1?0:Math.sqrt(1-c),2===f.value?(c=g,g=-A,A=c):3===f.value?(g=-g,A=-A):4===f.value&&(c=g,g=A,A=-c),2===this.face?(c=m,m=-g,g=c):3===this.face?(m=-m,g=-g):4===this.face&&(c=m,m=g,g=-c),p.phi=Math.acos(-A)-Pc,p.lam=Math.atan2(g,m),2===this.face?p.lam=ad(p.lam,-Pc):3===this.face?p.lam=ad(p.lam,-kc):4===this.face&&(p.lam=ad(p.lam,+Pc))}return 0!==this.es&&(h=p.phi<0?1:0,u=Math.tan(p.phi),d=this.b/Math.sqrt(u*u+this.one_minus_f_squared),p.phi=Math.atan(Math.sqrt(this.a*this.a-d*d)/(this.one_minus_f*d)),h&&(p.phi=-p.phi)),p.lam+=this.long0,e.x=p.lam,e.y=p.phi,e},names:["Quadrilateralized Spherical Cube","Quadrilateralized_Spherical_Cube","qsc"]};var ld=[[1,22199e-21,-715515e-10,31103e-10],[.9986,-482243e-9,-24897e-9,-13309e-10],[.9954,-83103e-8,-448605e-10,-9.86701e-7],[.99,-.00135364,-59661e-9,36777e-10],[.9822,-.00167442,-449547e-11,-572411e-11],[.973,-.00214868,-903571e-10,1.8736e-8],[.96,-.00305085,-900761e-10,164917e-11],[.9427,-.00382792,-653386e-10,-26154e-10],[.9216,-.00467746,-10457e-8,481243e-11],[.8962,-.00536223,-323831e-10,-543432e-11],[.8679,-.00609363,-113898e-9,332484e-11],[.835,-.00698325,-640253e-10,9.34959e-7],[.7986,-.00755338,-500009e-10,9.35324e-7],[.7597,-.00798324,-35971e-9,-227626e-11],[.7186,-.00851367,-701149e-10,-86303e-10],[.6732,-.00986209,-199569e-9,191974e-10],[.6213,-.010418,883923e-10,624051e-11],[.5722,-.00906601,182e-6,624051e-11],[.5322,-.00677797,275608e-9,624051e-11]],cd=[[-520417e-23,.0124,121431e-23,-845284e-16],[.062,.0124,-1.26793e-9,4.22642e-10],[.124,.0124,5.07171e-9,-1.60604e-9],[.186,.0123999,-1.90189e-8,6.00152e-9],[.248,.0124002,7.10039e-8,-2.24e-8],[.31,.0123992,-2.64997e-7,8.35986e-8],[.372,.0124029,9.88983e-7,-3.11994e-7],[.434,.0123893,-369093e-11,-4.35621e-7],[.4958,.0123198,-102252e-10,-3.45523e-7],[.5571,.0121916,-154081e-10,-5.82288e-7],[.6176,.0119938,-241424e-10,-5.25327e-7],[.6769,.011713,-320223e-10,-5.16405e-7],[.7346,.0113541,-397684e-10,-6.09052e-7],[.7903,.0109107,-489042e-10,-104739e-11],[.8435,.0103431,-64615e-9,-1.40374e-9],[.8936,.00969686,-64636e-9,-8547e-9],[.9394,.00840947,-192841e-9,-42106e-10],[.9761,.00616527,-256e-6,-42106e-10],[1,.00328947,-319159e-9,-42106e-10]],hd=.8487,ud=1.3523,dd=Uc/5,pd=1/dd,fd=function(e,t){return e[0]+t*(e[1]+t*(e[2]+t*e[3]))};const md={init:function(){this.x0=this.x0||0,this.y0=this.y0||0,this.long0=this.long0||0,this.es=0,this.title=this.title||"Robinson"},forward:function(e){var t=dh(e.x-this.long0),n=Math.abs(e.y),i=Math.floor(n*dd);i<0?i=0:i>=18&&(i=17);var r={x:fd(ld[i],n=Uc*(n-pd*i))*t,y:fd(cd[i],n)};return e.y<0&&(r.y=-r.y),r.x=r.x*this.a*hd+this.x0,r.y=r.y*this.a*ud+this.y0,r},inverse:function(e){var t={x:(e.x-this.x0)/(this.a*hd),y:Math.abs(e.y-this.y0)/(this.a*ud)};if(t.y>=1)t.x/=ld[18][0],t.y=e.y<0?-Pc:Pc;else{var n=Math.floor(18*t.y);for(n<0?n=0:n>=18&&(n=17);;)if(cd[n][0]>t.y)--n;else{if(!(cd[n+1][0]<=t.y))break;++n}var i=cd[n],r=5*(t.y-i[0])/(cd[n+1][0]-i[0]);r=function(e,t,n,i){for(var r=t;i;--i){var s=e(r);if(r-=s,Math.abs(s)<1e-10)break}return r}((function(e){return(fd(i,e)-t.y)/function(e,t){return e[1]+t*(2*e[2]+3*t*e[3])}(i,e)}),r,0,100),t.x/=fd(ld[n],r),t.y=(5*n+r)*Nc,e.y<0&&(t.y=-t.y)}return t.x=dh(t.x+this.long0),t},names:["Robinson","robin"]},gd={init:function(){this.name="geocent"},forward:function(e){return Uh(e,this.es,this.a)},inverse:function(e){return Oh(e,this.es,this.a,this.b)},names:["Geocentric","geocentric","geocent","Geocent"]};var Ad={h:{def:1e5,num:!0},azi:{def:0,num:!0,degrees:!0},tilt:{def:0,num:!0,degrees:!0},long0:{def:0,num:!0},lat0:{def:0,num:!0}};const yd={init:function(){if(Object.keys(Ad).forEach(function(e){if(void 0===this[e])this[e]=Ad[e].def;else{if(Ad[e].num&&isNaN(this[e]))throw new Error("Invalid parameter value, must be numeric "+e+" = "+this[e]);Ad[e].num&&(this[e]=parseFloat(this[e]))}Ad[e].degrees&&(this[e]=this[e]*Nc)}.bind(this)),Math.abs(Math.abs(this.lat0)-Pc)<Dc?this.mode=this.lat0<0?1:0:Math.abs(this.lat0)<Dc?this.mode=2:(this.mode=3,this.sinph0=Math.sin(this.lat0),this.cosph0=Math.cos(this.lat0)),this.pn1=this.h/this.a,this.pn1<=0||this.pn1>1e10)throw new Error("Invalid height");this.p=1+this.pn1,this.rp=1/this.p,this.h1=1/this.pn1,this.pfact=(this.p+1)*this.h1,this.es=0;var e=this.tilt,t=this.azi;this.cg=Math.cos(t),this.sg=Math.sin(t),this.cw=Math.cos(e),this.sw=Math.sin(e)},forward:function(e){e.x-=this.long0;var t,n,i,r,s=Math.sin(e.y),a=Math.cos(e.y),o=Math.cos(e.x);switch(this.mode){case 3:n=this.sinph0*s+this.cosph0*a*o;break;case 2:n=a*o;break;case 1:n=-s;break;case 0:n=s}switch(t=(n=this.pn1/(this.p-n))*a*Math.sin(e.x),this.mode){case 3:n*=this.cosph0*s-this.sinph0*a*o;break;case 2:n*=s;break;case 0:n*=-a*o;break;case 1:n*=a*o}return r=1/((i=n*this.cg+t*this.sg)*this.sw*this.h1+this.cw),t=(t*this.cg-n*this.sg)*this.cw*r,n=i*r,e.x=t*this.a,e.y=n*this.a,e},inverse:function(e){e.x/=this.a,e.y/=this.a;var t,n,i,r={x:e.x,y:e.y};i=1/(this.pn1-e.y*this.sw),t=this.pn1*e.x*i,n=this.pn1*e.y*this.cw*i,e.x=t*this.cg+n*this.sg,e.y=n*this.cg-t*this.sg;var s=_u(e.x,e.y);if(Math.abs(s)<Dc)r.x=0,r.y=e.y;else{var a,o;switch(o=1-s*s*this.pfact,o=(this.p-Math.sqrt(o))/(this.pn1/s+s/this.pn1),a=Math.sqrt(1-o*o),this.mode){case 3:r.y=Math.asin(a*this.sinph0+e.y*o*this.cosph0/s),e.y=(a-this.sinph0*Math.sin(r.y))*s,e.x*=o*this.cosph0;break;case 2:r.y=Math.asin(e.y*o/s),e.y=a*s,e.x*=o;break;case 0:r.y=Math.asin(a),e.y=-e.y;break;case 1:r.y=-Math.asin(a)}r.x=Math.atan2(e.x,e.y)}return e.x=r.x+this.long0,e.y=r.y,e},names:["Tilted_Perspective","tpers"]},vd={init:function(){if(this.flip_axis="x"===this.sweep?1:0,this.h=Number(this.h),this.radius_g_1=this.h/this.a,this.radius_g_1<=0||this.radius_g_1>1e10)throw new Error;if(this.radius_g=1+this.radius_g_1,this.C=this.radius_g*this.radius_g-1,0!==this.es){var e=1-this.es,t=1/e;this.radius_p=Math.sqrt(e),this.radius_p2=e,this.radius_p_inv2=t,this.shape="ellipse"}else this.radius_p=1,this.radius_p2=1,this.radius_p_inv2=1,this.shape="sphere";this.title||(this.title="Geostationary Satellite View")},forward:function(e){var t,n,i,r,s=e.x,a=e.y;if(s-=this.long0,"ellipse"===this.shape){a=Math.atan(this.radius_p2*Math.tan(a));var o=this.radius_p/_u(this.radius_p*Math.cos(a),Math.sin(a));if(n=o*Math.cos(s)*Math.cos(a),i=o*Math.sin(s)*Math.cos(a),r=o*Math.sin(a),(this.radius_g-n)*n-i*i-r*r*this.radius_p_inv2<0)return e.x=Number.NaN,e.y=Number.NaN,e;t=this.radius_g-n,this.flip_axis?(e.x=this.radius_g_1*Math.atan(i/_u(r,t)),e.y=this.radius_g_1*Math.atan(r/t)):(e.x=this.radius_g_1*Math.atan(i/t),e.y=this.radius_g_1*Math.atan(r/_u(i,t)))}else"sphere"===this.shape&&(t=Math.cos(a),n=Math.cos(s)*t,i=Math.sin(s)*t,r=Math.sin(a),t=this.radius_g-n,this.flip_axis?(e.x=this.radius_g_1*Math.atan(i/_u(r,t)),e.y=this.radius_g_1*Math.atan(r/t)):(e.x=this.radius_g_1*Math.atan(i/t),e.y=this.radius_g_1*Math.atan(r/_u(i,t))));return e.x=e.x*this.a,e.y=e.y*this.a,e},inverse:function(e){var t,n,i,r,s=-1,a=0,o=0;if(e.x=e.x/this.a,e.y=e.y/this.a,"ellipse"===this.shape){this.flip_axis?(o=Math.tan(e.y/this.radius_g_1),a=Math.tan(e.x/this.radius_g_1)*_u(1,o)):(a=Math.tan(e.x/this.radius_g_1),o=Math.tan(e.y/this.radius_g_1)*_u(1,a));var l=o/this.radius_p;if(t=a*a+l*l+s*s,(i=(n=2*this.radius_g*s)*n-4*t*this.C)<0)return e.x=Number.NaN,e.y=Number.NaN,e;r=(-n-Math.sqrt(i))/(2*t),s=this.radius_g+r*s,a*=r,o*=r,e.x=Math.atan2(a,s),e.y=Math.atan(o*Math.cos(e.x)/s),e.y=Math.atan(this.radius_p_inv2*Math.tan(e.y))}else if("sphere"===this.shape){if(this.flip_axis?(o=Math.tan(e.y/this.radius_g_1),a=Math.tan(e.x/this.radius_g_1)*Math.sqrt(1+o*o)):(a=Math.tan(e.x/this.radius_g_1),o=Math.tan(e.y/this.radius_g_1)*Math.sqrt(1+a*a)),t=a*a+o*o+s*s,(i=(n=2*this.radius_g*s)*n-4*t*this.C)<0)return e.x=Number.NaN,e.y=Number.NaN,e;r=(-n-Math.sqrt(i))/(2*t),s=this.radius_g+r*s,a*=r,o*=r,e.x=Math.atan2(a,s),e.y=Math.atan(o*Math.cos(e.x)/s)}return e.x=e.x+this.long0,e},names:["Geostationary Satellite View","Geostationary_Satellite","geos"]};var _d=1.340264,xd=-.081106,Ed=893e-6,bd=.003796,wd=Math.sqrt(3)/2;const Md={init:function(){this.es=0,this.long0=void 0!==this.long0?this.long0:0},forward:function(e){var t=dh(e.x-this.long0),n=e.y,i=Math.asin(wd*Math.sin(n)),r=i*i,s=r*r*r;return e.x=t*Math.cos(i)/(wd*(_d+3*xd*r+s*(7*Ed+9*bd*r))),e.y=i*(_d+xd*r+s*(Ed+bd*r)),e.x=this.a*e.x+this.x0,e.y=this.a*e.y+this.y0,e},inverse:function(e){e.x=(e.x-this.x0)/this.a,e.y=(e.y-this.y0)/this.a;var t,n,i,r,s=e.y;for(r=0;r<12&&(s-=i=(s*(_d+xd*(t=s*s)+(n=t*t*t)*(Ed+bd*t))-e.y)/(_d+3*xd*t+n*(7*Ed+9*bd*t)),!(Math.abs(i)<1e-9));++r);return n=(t=s*s)*t*t,e.x=wd*e.x*(_d+3*xd*t+n*(7*Ed+9*bd*t))/Math.cos(s),e.y=Math.asin(Math.sin(s)/wd),e.x=dh(e.x+this.long0),e},names:["eqearth","Equal Earth","Equal_Earth"]};var Sd=1e-10;function Cd(e){var t,n,i,r=dh(e.x-(this.long0||0)),s=e.y;return t=this.am1+this.m1-gu(s,n=Math.sin(s),i=Math.cos(s),this.en),n=i*r/(t*Math.sqrt(1-this.es*n*n)),e.x=t*Math.sin(n),e.y=this.am1-t*Math.cos(n),e.x=this.a*e.x+(this.x0||0),e.y=this.a*e.y+(this.y0||0),e}function Td(e){var t,n,i,r;if(e.x=(e.x-(this.x0||0))/this.a,e.y=(e.y-(this.y0||0))/this.a,n=_u(e.x,e.y=this.am1-e.y),r=Au(this.am1+this.m1-n,this.es,this.en),(t=Math.abs(r))<Pc)t=Math.sin(r),i=n*Math.atan2(e.x,e.y)*Math.sqrt(1-this.es*t*t)/Math.cos(r);else{if(!(Math.abs(t-Pc)<=Sd))throw new Error;i=0}return e.x=dh(i+(this.long0||0)),e.y=Qu(r),e}function Id(e){var t,n,i=dh(e.x-(this.long0||0)),r=e.y;return n=this.cphi1+this.phi1-r,Math.abs(n)>Sd?(e.x=n*Math.sin(t=i*Math.cos(r)/n),e.y=this.cphi1-n*Math.cos(t)):e.x=e.y=0,e.x=this.a*e.x+(this.x0||0),e.y=this.a*e.y+(this.y0||0),e}function Rd(e){var t,n;e.x=(e.x-(this.x0||0))/this.a,e.y=(e.y-(this.y0||0))/this.a;var i=_u(e.x,e.y=this.cphi1-e.y);if(n=this.cphi1+this.phi1-i,Math.abs(n)>Pc)throw new Error;return t=Math.abs(Math.abs(n)-Pc)<=Sd?0:i*Math.atan2(e.x,e.y)/Math.cos(n),e.x=dh(t+(this.long0||0)),e.y=Qu(n),e}const Bd={init:function(){var e;if(this.phi1=this.lat1,Math.abs(this.phi1)<Sd)throw new Error;this.es?(this.en=mu(this.es),this.m1=gu(this.phi1,this.am1=Math.sin(this.phi1),e=Math.cos(this.phi1),this.en),this.am1=e/(Math.sqrt(1-this.es*this.am1*this.am1)*this.am1),this.inverse=Td,this.forward=Cd):(Math.abs(this.phi1)+Sd>=Pc?this.cphi1=0:this.cphi1=1/Math.tan(this.phi1),this.inverse=Rd,this.forward=Id)},names:["bonne","Bonne (Werner lat_1=90)"]};var Ld;Xh.defaultDatum="WGS84",Xh.Proj=Nh,Xh.WGS84=new Xh.Proj("WGS84"),Xh.Point=uu,Xh.toPoint=Hh,Xh.defs=ah,Xh.nadgrid=function(e,t){var n=new DataView(t),i=function(e){var t=e.getInt32(8,!1);return 11!==t&&(11!==(t=e.getInt32(8,!0))&&console.warn("Failed to detect nadgrid endian-ness, defaulting to little-endian"),!0)}(n),r=function(e,t){return{nFields:e.getInt32(8,t),nSubgridFields:e.getInt32(24,t),nSubgrids:e.getInt32(40,t),shiftType:Rh(e,56,64).trim(),fromSemiMajorAxis:e.getFloat64(120,t),fromSemiMinorAxis:e.getFloat64(136,t),toSemiMajorAxis:e.getFloat64(152,t),toSemiMinorAxis:e.getFloat64(168,t)}}(n,i),s=function(e,t,n){for(var i=176,r=[],s=0;s<t.nSubgrids;s++){var a=Lh(e,i,n),o=Ph(e,i,a,n),l=Math.round(1+(a.upperLongitude-a.lowerLongitude)/a.longitudeInterval),c=Math.round(1+(a.upperLatitude-a.lowerLatitude)/a.latitudeInterval);r.push({ll:[Ih(a.lowerLongitude),Ih(a.lowerLatitude)],del:[Ih(a.longitudeInterval),Ih(a.latitudeInterval)],lim:[l,c],count:a.gridNodeCount,cvs:Bh(o)}),i+=176+16*a.gridNodeCount}return r}(n,r,i),a={header:r,subgrids:s};return Ch[e]=a,a},Xh.transform=jh,Xh.mgrs=tu,Xh.version="__VERSION__",(Ld=Xh).Proj.projections.add(yu),Ld.Proj.projections.add(bu),Ld.Proj.projections.add(wu),Ld.Proj.projections.add(Cu),Ld.Proj.projections.add(Tu),Ld.Proj.projections.add(Iu),Ld.Proj.projections.add(Bu),Ld.Proj.projections.add(Lu),Ld.Proj.projections.add(Pu),Ld.Proj.projections.add(Gu),Ld.Proj.projections.add(Vu),Ld.Proj.projections.add(qu),Ld.Proj.projections.add(Wu),Ld.Proj.projections.add(Yu),Ld.Proj.projections.add(Xu),Ld.Proj.projections.add(Ku),Ld.Proj.projections.add(Ju),Ld.Proj.projections.add($u),Ld.Proj.projections.add(Zu),Ld.Proj.projections.add(ed),Ld.Proj.projections.add(td),Ld.Proj.projections.add(nd),Ld.Proj.projections.add(id),Ld.Proj.projections.add(rd),Ld.Proj.projections.add(od),Ld.Proj.projections.add(md),Ld.Proj.projections.add(gd),Ld.Proj.projections.add(yd),Ld.Proj.projections.add(vd),Ld.Proj.projections.add(Md),Ld.Proj.projections.add(Bd);const Pd=Xh,Dd=new sn(Pd.WGS84.a,Pd.WGS84.a,Pd.WGS84.b),Nd=new sn,Ud=class{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Dd;this.size=new sn,this._radiiSquared=new sn,this._invRadiiSquared=new sn,this.eccentricity=0,this.setSize(e)}geodeticSurfaceNormal(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new sn;return e.toVector3(t).multiply(this._invRadiiSquared).normalize()}geodeticSurfaceNormalCartographic(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new sn;const n=Tt.degToRad(e.longitude),i=Tt.degToRad(e.latitude),r=Math.cos(i);return t.set(r*Math.cos(n),r*Math.sin(n),Math.sin(i))}setSize(e){return this.size.set(e.x,e.y,e.z),this._radiiSquared.multiplyVectors(e,e),this._invRadiiSquared.x=0===e.x?0:1/this._radiiSquared.x,this._invRadiiSquared.y=0===e.y?0:1/this._radiiSquared.y,this._invRadiiSquared.z=0===e.z?0:1/this._radiiSquared.z,this.eccentricity=Math.sqrt(this._radiiSquared.x-this._radiiSquared.z)/this.size.x,this}cartographicToCartesian(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new sn;Nd.copy(e.geodesicNormal),t.multiplyVectors(this._radiiSquared,Nd);const n=Math.sqrt(Nd.dot(t));return t.divideScalar(n),Nd.multiplyScalar(e.altitude),t.add(Nd)}cartesianToCartographic(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Jd("EPSG:4326",0,0,0);const n=Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z),i=this.size.x,r=this.size.z,s=Math.abs((i*i-r*r)/(i*i)),a=1-Math.sqrt(1-s),o=Math.sqrt(e.x*e.x+e.y*e.y),l=Math.atan2(e.y,e.x),c=Math.atan(e.z/o*(1-a+s*i/n)),h=Math.sin(c),u=Math.cos(c),d=Math.atan((e.z*(1-a)+s*i*h*h*h)/((1-a)*(o-s*i*u*u*u))),p=o*Math.cos(d)+e.z*Math.sin(d)-i*Math.sqrt(1-s*Math.sin(d)*Math.sin(d));return t.setFromValues(Tt.radToDeg(l),Tt.radToDeg(d),p)}cartographicToCartesianArray(e){const t=[];for(let n=0;n<e.length;n++)t.push(this.cartographicToCartesian(e[n]));return t}intersection(e){const t=1e-4,n=e.origin,i=e.direction,r=i.x*i.x*this._invRadiiSquared.x+i.y*i.y*this._invRadiiSquared.y+i.z*i.z*this._invRadiiSquared.z,s=2*n.x*i.x*this._invRadiiSquared.x+2*n.y*i.y*this._invRadiiSquared.y+2*n.z*i.z*this._invRadiiSquared.z,a=n.x*n.x*this._invRadiiSquared.x+n.y*n.y*this._invRadiiSquared.y+n.z*n.z*this._invRadiiSquared.z-1;let o=s*s-4*r*a;if(o<0||0===r||0===s||0===a)return!1;o=Math.sqrt(o);const l=(-s+o)/(2*r),c=(-s-o)/(2*r);if(l<=t&&c<=t)return!1;let h=0;if(h=l<=t?c:c<=t||l<c?l:c,h<t)return!1;const u=new sn;return u.addVectors(e.origin,i.clone().setLength(h)),u}geodesicDistance(e,t){const n=Tt.degToRad(e.longitude),i=Tt.degToRad(e.latitude),r=Tt.degToRad(t.longitude),s=Tt.degToRad(t.latitude),a=Math.acos(Math.sin(i)*Math.sin(s)+Math.cos(i)*Math.cos(s)*Math.cos(r-n)),o=this.eccentricity,l=.5*(i+s),c=(o*Math.sin(l))**2,h=this.size.x*(1-o**2)/(1-c)**1.5,u=this.size.x/Math.sqrt(1-c);return a*Math.sqrt(h*u)}};function Od(e){if(!("string"==typeof(t=e)||t instanceof String))throw new Error(`Crs parameter value must be a string: '${e}'`);var t}Pd.defs("EPSG:4978","+proj=geocent +datum=WGS84 +units=m +no_defs"),Pd.defs("EPSG:4326").axis="neu",Pd.defs("EPSG:4269").axis="neu",Pd.defs("WGS84").axis="neu";function Fd(e){return"EPSG:4326"===e}function kd(e){return"degrees"===e.units?1:"m"===e.units||"meter"===e.units?2:"foot"===e.units?3:void 0===e.units&&void 0===e.to_meter?2:void 0}function Qd(e){Od(e);const t=Pd.defs(e);if(t)return kd(t)}function zd(e){return 2===Qd(e)}function Gd(e){Od(e);const t=Pd.defs(e);return!!t&&"geocent"==t.projName}function Hd(e){const t=Pd.defs(e);if(!t)throw new Error(`Undefined crs '${e}'. Add it with proj4.defs('${e}', string)`);if(!kd(t))throw new Error(`No valid unit found for crs '${e}', found ${t.units}`)}const Vd=new Ud,jd={},qd=new sn,Wd=new sn;let Yd,Xd;class Kd{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;this.isCoordinates=!0,Hd(e),this.crs=e,this.x=0,this.y=0,this.z=0,this._normal=new sn,t.length>0?(console.warn("Deprecated Coordinates#constructor(string, number[]),","use `new Coordinates(string).setFromArray(number[])` instead."),this.setFromArray(t)):t.isVector3||t.isCoordinates?(console.warn("Deprecated Coordinates#constructor(string, Vector3),","use `new Coordinates(string).setFromVector3(Vector3)` instead."),this.setFromVector3(t)):this.setFromValues(t,n,i),this._normalNeedsUpdate=!0}setCrs(e){return Hd(e),this.crs=e,this}setFromValues(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return this.x=e,this.y=t,this.z=n,this._normalNeedsUpdate=!0,this}setFromArray(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return this.setFromValues(e[t],e[t+1],e[t+2])}setFromVector3(e){return this.setFromValues(e.x,e.y,e.z)}clone(){return new Kd(this.crs,this.x,this.y,this.z)}copy(e){return this.crs=e.crs,this.setFromVector3(e)}get longitude(){return this.x}get latitude(){return this.y}get altitude(){return this.z}set altitude(e){this.z=e}get geodesicNormal(){return this._normalNeedsUpdate&&(this._normalNeedsUpdate=!1,Fd(this.crs)?Vd.geodeticSurfaceNormalCartographic(this,this._normal):"EPSG:4978"==this.crs?Vd.geodeticSurfaceNormal(this,this._normal):this._normal.set(0,0,1)),this._normal}toVector3(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:new sn).copy(this)}toArray(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return sn.prototype.toArray.call(this,e,t)}planarDistanceTo(e){return this.toVector3(qd).setZ(0),e.toVector3(Wd).setZ(0),qd.distanceTo(Wd)}geodeticDistanceTo(e){return this.as("EPSG:4326",Yd),e.as("EPSG:4326",Xd),Vd.geodesicDistance(Yd,Xd)}spatialEuclideanDistanceTo(e){return this.as("EPSG:4978",Yd).toVector3(qd),e.as("EPSG:4978",Xd).toVector3(Wd),qd.distanceTo(Wd)}applyMatrix4(e){return sn.prototype.applyMatrix4.call(this,e),this}as(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Kd(e);var n,i;return this.crs==e?t.copy(this):(Fd(this.crs)&&"EPSG:3857"==e&&(this.y=Tt.clamp(this.y,-89.999999,89.999999)),t.setFromArray((n=this.crs,i=e,jd[n]||(jd[n]={}),jd[n][i]||(jd[n][i]=Pd(n,i)),jd[n][i]).forward([this.x,this.y,this.z]))),t.crs=e,t}}Yd=new Kd("EPSG:4326",0,0,0),Xd=new Kd("EPSG:4326",0,0,0);const Jd=Kd,$d=new It,Zd=new It,ep=new ln,tp=new It(2,2),np=new Jd("EPSG:4326",0,0,0),ip=new Jd("EPSG:4326",0,0,0),rp=new Jd("EPSG:4326",0,0,0),sp=new sn,ap=new sn;let op;const lp=new Array(8);for(let e=lp.length-1;e>=0;e--)lp[e]=new Jd("EPSG:4326",0,0,0);const cp=new Jd("EPSG:4326",0,0);class hp{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;if(Gd(e))throw new Error(`Non-compatible geocentric projection ${e} to build a geographical extent`);this.isExtent=!0,this.crs=e,this.west=0,this.east=0,this.south=0,this.north=0,this.set(t,n,i,r)}clone(){return new hp(this.crs,this.west,this.east,this.south,this.north)}as(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new hp("EPSG:4326");if(Hd(e),this.crs!=e){const n=this.center(cp);lp[0].setFromValues(this.west,this.north),lp[1].setFromValues(n.x,this.north),lp[2].setFromValues(this.east,this.north),lp[3].setFromValues(this.east,n.y),lp[4].setFromValues(this.east,this.south),lp[5].setFromValues(n.x,this.south),lp[6].setFromValues(this.west,this.south),lp[7].setFromValues(this.west,n.y),t.set(1/0,-1/0,1/0,-1/0);for(let n=0;n<lp.length;n++)lp[n].crs=this.crs,lp[n].as(e,cp),t.north=Math.max(t.north,cp.y),t.south=Math.min(t.south,cp.y),t.east=Math.max(t.east,cp.x),t.west=Math.min(t.west,cp.x);return t.crs=e,t}return t.crs=e,t.set(this.west,this.east,this.south,this.north),t}center(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new Jd(this.crs);return this.planarDimensions($d),e.crs=this.crs,e.setFromValues(this.west+.5*$d.x,this.south+.5*$d.y),e}planarDimensions(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:new It).set(Math.abs(this.east-this.west),Math.abs(this.north-this.south))}geodeticDimensions(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new It;return np.crs=this.crs,ip.crs=this.crs,rp.crs=this.crs,np.setFromValues(this.west,this.north,0),ip.setFromValues(this.west,this.south,0),rp.setFromValues(this.east,this.north,0),e.set(np.geodeticDistanceTo(rp),np.geodeticDistanceTo(ip))}spatialEuclideanDimensions(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new It;return np.crs=this.crs,ip.crs=this.crs,rp.crs=this.crs,np.setFromValues(this.west,this.north,0),ip.setFromValues(this.west,this.south,0),rp.setFromValues(this.east,this.north,0),e.set(np.spatialEuclideanDistanceTo(rp),np.spatialEuclideanDistanceTo(ip))}isPointInside(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return this.crs==e.crs?cp.copy(e):e.as(this.crs,cp),cp.x<=this.east+t&&cp.x>=this.west-t&&cp.y<=this.north+t&&cp.y>=this.south-t}isInside(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Fd(this.crs)?.01:.001;return e.as(this.crs,op),this.east-op.east<=t&&op.west-this.west<=t&&this.north-op.north<=t&&op.south-this.south<=t}offsetToParent(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new $t;if(this.crs!=e.crs)throw new Error("unsupported mix");e.planarDimensions($d),this.planarDimensions(Zd);const n=(this.west-e.west)/$d.x,i=(e.north-this.north)/$d.y,r=Zd.x/$d.x,s=Zd.y/$d.y;return t.set(n,i,r,s)}intersectsExtent(e){return hp.intersectsExtent(this,e)}static intersectsExtent(e,t){const n=t.crs==e.crs?t:t.as(e.crs,op);return!(e.west>=n.east||e.east<=n.west||e.south>=n.north||e.north<=n.south)}intersect(e){return this.intersectsExtent(e)?(e.crs!=this.crs&&(e=e.as(this.crs,op)),new hp(this.crs,Math.max(this.west,e.west),Math.min(this.east,e.east),Math.max(this.south,e.south),Math.min(this.north,e.north))):new hp(this.crs)}set(e,t,n,i){if(null==e)throw new Error("No values to set in the extent");return void 0!==e.west?(console.warn("Deprecated Extent#constructor(string, Extent) and Extent#set(Extent),","use new Extent(string).setFromExtent(Extent) instead."),this.setFromExtent(e)):4==e.length?(console.warn("Deprecated Extent#constructor(string, number[]) and Extent#set(number[]),","use new Extent(string).setFromArray(number[]) instead."),this.setFromArray(e)):void 0!==i&&(this.west=e,this.east=t,this.south=n,this.north=i),this}setFromArray(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return this.west=e[t],this.east=e[t+1],this.south=e[t+2],this.north=e[t+3],this}setFromExtent(e){return this.west=e.west,this.east=e.east,this.south=e.south,this.north=e.north,this}copy(e){return this.crs=e.crs,this.setFromExtent(e)}union(e){if(e.crs!=this.crs)throw new Error("unsupported union between 2 diff crs");if(this.west===1/0)this.copy(e);else{const t=e.west;t<this.west&&(this.west=t);const n=e.east;n>this.east&&(this.east=n);const i=e.south;i<this.south&&(this.south=i);const r=e.north;r>this.north&&(this.north=r)}}expandByCoordinates(e){const t=e.crs==this.crs?e:e.as(this.crs,cp);this.expandByValuesCoordinates(t.x,t.y)}expandByValuesCoordinates(e,t){e<this.west&&(this.west=e),e>this.east&&(this.east=e),t<this.south&&(this.south=t),t>this.north&&(this.north=t)}static fromBox3(e,t){return Gd(e)&&(e="EPSG:4326",t=ep.copy(t),ip.crs=e,ip.setFromVector3(t.min).as(e,ip).toVector3(t.min),rp.crs=e,rp.setFromVector3(t.max).as(e,rp).toVector3(t.max)),new hp(e).setFromExtent({west:t.min.x,east:t.max.x,south:t.min.y,north:t.max.y})}toString(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return`${this.east}${e}${this.north}${e}${this.west}${e}${this.south}`}subdivision(){return this.subdivisionByScheme()}subdivisionByScheme(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:tp;const t=[],n=this.planarDimensions($d).divide(e);for(let i=e.x-1;i>=0;i--)for(let r=e.y-1;r>=0;r--){const e=this.west+i*n.x,s=this.south+r*n.y;t.push(new hp(this.crs,e,e+n.x,s,s+n.y))}return t}applyMatrix4(e){if(sp.set(this.west,this.south,0).applyMatrix4(e),ap.set(this.east,this.north,0).applyMatrix4(e),this.west=sp.x,this.east=ap.x,this.south=sp.y,this.north=ap.y,this.west>this.east){const e=this.west;this.west=this.east,this.east=e}if(this.south>this.north){const e=this.south;this.south=this.north,this.north=e}return this}clampSouthNorth(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.south,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.north;return this.south=Math.max(this.south,e),this.north=Math.min(this.north,t),this}clampWestEast(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.west,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.east;return this.west=Math.max(this.west,e),this.east=Math.min(this.east,t),this}clampByExtent(e){return this.clampSouthNorth(e.south,e.north),this.clampWestEast(e.west,e.east)}}op=new hp("EPSG:4326");const up=hp,dp={getSunPosition(){const e=Math,t=e.PI,n=e.sin,i=e.cos,r=e.tan,s=e.asin,a=e.atan2,o=t/180,l=23.4397*o;function c(e,t,s){return a(n(e),i(e)*n(t)-r(s)*i(t))}function h(e,t,r){return s(n(t)*n(r)+i(t)*i(r)*i(e))}return function(e,u,d){const p=o*-d,f=o*u,m=function(e){return function(e){return e.valueOf()/864e5-.5+2440588}(e)-2451545}(e),g=function(e){return o*(357.5291+.98560028*e)}(m),A=function(e){return o*(1.9148*n(e)+.02*n(2*e)+3e-4*n(3*e))}(g),y=function(e,n){return e+n+102.9372*o+t}(g,A),v=(b=y,s(n(0)*i(l)+i(0)*n(l)*n(b))),_=function(e){return a(n(e)*i(l)-r(0)*n(l),i(e))}(y),x=function(e,t){return o*(280.16+360.9856235*e)-t}(m,p),E=x-_;var b;return{EclipticLongitude:y,declinaison:v,ascension:_,H:E,SiderealTime:x,altitude:h(E,f,v),azimuth:c(E,f,v)+t/2}}},getSunPositionInScene(e,t,n){"number"!=typeof e&&(e=e.valueOf());const i=864e5,r=dp.getSunPosition()(e,t,n).ascension+e%i/i*-360+180;return new Jd("EPSG:4326",r,t,5e7).as("EPSG:4978").toVector3()}},pp=dp;Tt.DEG2RAD,new Nn,new sn,new sn,(new sn).set(0,0,1),new Jd("EPSG:4326",0,0,0),new jn,new rn;const fp=new Jd("EPSG:4326"),mp=new It,gp=class{constructor(e,t,n){Qd(e.crs),this.extent=e,this.step=new It(t.x,t.y||t.x),this.dimensions=this.extent.planarDimensions(),this.dataSize=(new It).addVectors(this.step,this.dimensions).divide(this.step).round(),this.getData=n}getHeightAtCoordinates(e){return e.as(this.extent.crs,fp),mp.set((this.dataSize.x-1)*(fp.x-this.extent.west)/this.dimensions.x,(this.dataSize.y-1)*(fp.y-this.extent.south)/this.dimensions.y),mp.x<0||mp.x>=this.dataSize.x-1||mp.y<0||mp.y>=this.dataSize.y-1?0:function(e,t){const n=Math.floor(e.x),i=Math.floor(e.y),r=e.x-n,s=e.y-i;return(1-r)*((1-s)*t(i,n)+s*t(i+1,n))+r*((1-s)*t(i,n+1)+s*t(i+1,n+1))}(mp,this.getData)}},Ap={v:new sn,coord1:new Jd("EPSG:4978"),coord2:new Jd("EPSG:4978"),offset:new It};function yp(e,t,n,i,r,s){let a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:{},o=arguments.length>8?arguments[8]:void 0;const l=(arguments.length>7?arguments[7]:void 0)||new Jd(i);a.worldFromLocal?l.setFromVector3(Ap.v.copy(r).applyMatrix4(a.worldFromLocal)):l.setFromVector3(r);const c=vp.getTerrainObjectAt(e,l,t,n,o);if(c)return c.coord.z+=s,c.coord.as(i,Ap.coord2).toVector3(r),a.localFromWorld&&r.applyMatrix4(a.localFromWorld),{id:c.texture.id,version:c.texture.version,tile:c.tile}}const vp={getElevationValueAt(e,t){const n=Ip(e,arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,t,(arguments.length>3?arguments[3]:void 0)||e.level0Nodes);if(n)return n.coord.z},getTerrainObjectAt(e,t){let n=arguments.length>4?arguments[4]:void 0;return Ip(e,arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,t,(arguments.length>3?arguments[3]:void 0)||e.level0Nodes,n)},FAST_READ_Z:0,PRECISE_READ_Z:1,placeObjectOnGround:function(e,t,n){let i,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},s=arguments.length>4?arguments[4]:void 0;if(console.warn("placeObjectOnGround has been deprecated because it needs review and test"),i=s?s.concat(e.level0Nodes):e.level0Nodes,r.modifyGeometry){const s={worldFromLocal:n.matrixWorld,localFromWorld:(new Nn).copy(n.matrixWorld).invert()},a=n.geometry;if(a.vertices){r.cache&&(r.cache.length=a.vertices.length);let n=!0;const o=new Jd(t);for(let l=0;l<a.vertices.length;l++){const c=r.cache?r.cache[l]:void 0,h=yp(e,r.method||vp.FAST_READ_Z,i,t,a.vertices[l],r.offset||0,s,o,c);r.cache&&(r.cache[l]=h),h||(n=!1)}return a.verticesNeedUpdate=!0,n}if(a.isBufferGeometry){r.cache&&(r.cache.length=a.attributes.position.count);let n=!0;const o=new sn,l=new Jd(t);for(let c=0;c<a.attributes.position.count;c++){const h=r.cache?r.cache[c]:void 0;o.fromBufferAttribute(a.attributes.position,c);const u=o.z,d=yp(e,r.method||vp.FAST_READ_Z,i,t,o,r.offset||0,s,l,h);r.cache&&(r.cache[c]=d),d||(n=!1),u!=o.z&&(a.attributes.position.needsUpdate=!0),a.attributes.position.setXYZ(c,o.x,o.y,o.z)}return n}}else{r.cache&&(r.cache.length=1);const s={worldFromLocal:n.parent?n.parent.matrixWorld:void 0,localFromWorld:n.parent?(new Nn).copy(n.parent.matrixWorld).invert():void 0},a=yp(e,r.method||vp.FAST_READ_Z,i,t,n.position,r.offset||0,s,void 0,r.cache?r.cache[0]:void 0);if(a)return r.cache&&(r.cache[0]=a),n.updateMatrix(),n.updateMatrixWorld(),!0}}};function _p(e,t){if(t.extent){if(!t.extent.isPointInside(e))return;for(let n=0;n<t.children.length;n++){const i=_p(e,t.children[n]);if(i)return i}const n=t.material.getElevationLayer();return n&&n.level>=0?t:void 0}}let xp;function Ep(e,t){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];for(let e=0;e<i.length;e+=2)i[e]=Tt.clamp(i[e],0,t.image.width-1),i[e+1]=Tt.clamp(i[e+1],0,t.image.height-1);if(t.image.data){if(2===i.length){const n=t.image.data[i[1]*t.image.width+i[0]];return n!=e.noDataValue?n:void 0}const n=[];for(let r=0;r<i.length;r+=2){const s=t.image.data[i[r+1]*t.image.width+i[r]];n.push(s!=e.noDataValue?s:void 0)}return n}{xp||(xp=document.createElement("canvas"),xp.width=2,xp.height=2);let n=1/0,r=1/0,s=-1/0,a=-1/0;for(let e=0;e<i.length;e+=2)n=Math.min(i[e],n),r=Math.min(i[e+1],r),s=Math.max(i[e],s),a=Math.max(i[e+1],a);const o=s-n+1,l=a-r+1;xp.width=Math.max(xp.width,o),xp.height=Math.max(xp.height,l);const c=xp.getContext("2d",{willReadFrequently:!0});c.drawImage(t.image,n,r,o,l,0,0,o,l);const h=c.getImageData(0,0,o,l),u=[];for(let t=0;t<i.length;t+=2){const s=i[t]-n,a=i[t+1]-r,l=Tt.lerp(e.colorTextureElevationMinZ,e.colorTextureElevationMaxZ,h.data[4*a*o+4*s]/255);u.push(l!=e.noDataValue?l:void 0)}return 2===i.length?u[0]:u}}function bp(e,t,n){const i=e.image.width,r=e.image.height,s=Math.max(0,t*i-.5),a=Math.max(0,n*r-.5),o=Math.floor(s),l=Math.ceil(s),c=Math.floor(a);return{u1:o,u2:l,v1:c,v2:Math.ceil(a),wu:s-o,wv:a-c}}function wp(e,t,n){return null==e?t:null==t?e:Tt.lerp(e,t,n)}function Mp(e,t,n,i){const r=bp(t,n,i),[s,a,o,l]=Ep(e,t,r.u1,r.v1,r.u2,r.v1,r.u1,r.v2,r.u2,r.v2),c=wp(s,a,r.wu),h=wp(o,l,r.wu);return wp(c,h,r.wv)}const Sp=new sn,Cp={v:new sn,coord1:new Jd("EPSG:4978"),coord2:new Jd("EPSG:4978"),offset:new It},Tp=new It;function Ip(e,t,n,i,r){const s=n.as(e.extent.crs,Cp.coord1);let a=null;r?.tile?.material&&(a=_p(s,r.tile));for(let e=0;!a&&e<i.length;e++)a=_p(s,i[e]);if(!a)return;const o=a,l=o.material.getElevationLayer(),c=l.textures[0];if(r&&r.id===c.id&&r.version===c.version)return{coord:s,texture:c,tile:o};const h=Math.round(Math.log2(1/l.offsetScales[0].z));for(let e=0;e<h;e++)a=a.parent;return function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new It;if(e.crs!=t.crs)throw new Error(`Unsupported mix: ${e.crs} and ${t.crs}`);t.planarDimensions(Tp);const i=(e.x-t.west)/Tp.x,r=(t.north-e.y)/Tp.y;n.set(i,r)}(s,a.extent,Cp.offset),s.z=1==t?function(e,t,n,i,r){const s=i.x/r.x/16;let a=Math.floor(n.x/s)*s,o=Math.floor(n.y/s)*s;1==a&&(a-=s),1==o&&(o-=s);const l=a,c=a+s,h=o,u=o+s,d=(n.x-a)/s,p=(n.y-o)/s,f=new Ei(new sn(l,u),new sn(c,h),1==p||d/(1-p)>=1?new sn(c,u):new sn(l,h));f.getBarycoord(new sn(n.x,n.y),Sp);const m=e.attachedLayers.filter((e=>e.isElevationLayer))[0],g=Mp(m,t,f.a.x,f.a.y),A=Mp(m,t,f.b.x,f.b.y),y=Mp(m,t,f.c.x,f.c.y);return g*Sp.x+A*Sp.y+y*Sp.z}(e,c,Cp.offset,o.extent.planarDimensions(),a.extent.planarDimensions()):function(e,t,n){return function(e,t,n,i){const r=bp(t,n,i);return Ep(e,t,r.wu<=0?r.u1:r.u2,r.wv<=0?r.v1:r.v2)}(e.attachedLayers.filter((e=>e.isElevationLayer))[0],t,n.x,n.y)}(e,c,Cp.offset),null!=s.z?{coord:s,texture:c,tile:o}:void 0}const Rp={frustum:new Sr,matrix:new Nn,box3:new ln},Bp=new ln(new sn(-1,-1,-1),new sn(1,1,1));function Lp(e,t,n){if(e.camera3D.isOrthographicCamera)e._preSSE=t;else{const i=Tt.degToRad(n);e._preSSE=t/(2*Math.tan(.5*i))}}const Pp=[new sn,new sn,new sn,new sn,new sn,new sn,new sn,new sn],Dp=class{#e=!0;#t=(()=>new Nn)();constructor(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};if(this.crs=e,i.isCamera?(console.warn("options.camera parameter is deprecated. Use options.camera.cameraThree to place a custom camera as a parameter. See the documentation of Camera."),this.camera3D=i):i.cameraThree?this.camera3D=i.cameraThree:1===i.type?this.camera3D=new Gr:this.camera3D=new mr(30),this.camera3D.aspect=this.camera3D.aspect??1,this.width=t,this.height=n,this.resize(t,n),this._preSSE=1/0,this.camera3D.isPerspectiveCamera){let e=this.camera3D.fov;Object.defineProperty(this.camera3D,"fov",{get:()=>e,set:t=>{e=t,Lp(this,this.height,e)}})}}resize(e,t){if(!e||e<=0||!t||t<=0)return void console.warn(`Trying to resize the Camera with invalid height (${t}) or width (${e}). Skipping resize.`);const n=e/t;if(this.camera3D.aspect!==n){if(this.camera3D.isOrthographicCamera){this.camera3D.zoom*=this.width/e;const t=this.camera3D.top*this.camera3D.aspect/n;this.camera3D.bottom=-t,this.camera3D.top=t}else this.camera3D.isPerspectiveCamera&&(this.camera3D.fov=2*Tt.radToDeg(Math.atan(t/this.height*Math.tan(Tt.degToRad(this.camera3D.fov)/2))));this.camera3D.aspect=n}this.width=e,this.height=t,Lp(this,this.height,this.camera3D.fov),this.camera3D.updateProjectionMatrix&&(this.camera3D.updateProjectionMatrix(),this.#e=!0)}update(){this.camera3D.updateMatrixWorld(),this.#e=!0}position(e){return new Jd(this.crs).setFromVector3(this.camera3D.position).as(e||this.crs)}setPosition(e){this.camera3D.position.copy(e.as(this.crs))}isBox3Visible(e,t){return this.box3SizeOnScreen(e,t).intersectsBox(Bp)}isSphereVisible(e,t){return this.#e&&(this.#t.multiplyMatrices(this.camera3D.projectionMatrix,this.camera3D.matrixWorldInverse),this.#e=!1),t?(Rp.matrix.multiplyMatrices(this.#t,t),Rp.frustum.setFromProjectionMatrix(Rp.matrix)):Rp.frustum.setFromProjectionMatrix(this.#t),Rp.frustum.intersectsSphere(e)}box3SizeOnScreen(e,t){const n=function(e,t,n){let i=e.camera3D.matrixWorldInverse;n&&(i=Rp.matrix.multiplyMatrices(e.camera3D.matrixWorldInverse,n)),Pp[0].set(t.min.x,t.min.y,t.min.z).applyMatrix4(i),Pp[1].set(t.min.x,t.min.y,t.max.z).applyMatrix4(i),Pp[2].set(t.min.x,t.max.y,t.min.z).applyMatrix4(i),Pp[3].set(t.min.x,t.max.y,t.max.z).applyMatrix4(i),Pp[4].set(t.max.x,t.min.y,t.min.z).applyMatrix4(i),Pp[5].set(t.max.x,t.min.y,t.max.z).applyMatrix4(i),Pp[6].set(t.max.x,t.max.y,t.min.z).applyMatrix4(i),Pp[7].set(t.max.x,t.max.y,t.max.z).applyMatrix4(i);let r=!1;for(let t=0;t<8;t++)Pp[t].z<=-e.camera3D.near?r=!0:Pp[t].z=-e.camera3D.near;return r?Pp:void 0}(this,e,t);if(!n)return Rp.box3.makeEmpty();for(let e=0;e<8;e++)n[e].applyMatrix4(this.camera3D.projectionMatrix);return Rp.box3.setFromPoints(n)}adjustAltitudeToAvoidCollisionWithLayer(e,t,n){const i=e.camera.position().as("EPSG:4326");if(void 0!==t){const r=vp.getElevationValueAt(t,i);void 0!==r&&i.altitude-(r+n)<0&&(i.altitude=r+n,e.camera3D.position.copy(i.as(e.referenceCrs)),e.notifyChange(this.camera3D))}}},Np="before_render",Up="update_end";function Op(e,t,n){if(n)for(const i of n){const n=t.update(e,t,i),r=t.getObjectToUpdateForAttachedLayers(i);if(r)if(r.element)for(const n of t.attachedLayers)n.ready&&n.update(e,n,r.element,r.parent);else if(r.elements)for(let n=0;n<r.elements.length;n++){if(!r.elements[n].isObject3D)throw new Error("\n                            Invalid object for attached layer to update.\n                            Must be a THREE.Object and have a THREE.Material");for(const i of t.attachedLayers)i.ready&&i.update(e,i,r.elements[n],r.parent)}Op(e,t,n)}}function Fp(e,t){let n=!1;const i=new Set;return e.forEach((e=>{e===t||e.isCamera?(t.info.clear(),n=!0):e.layer===t&&i.add(e)})),n?new Set([t]):i}const kp=class extends At{#n=!1;#i=!0;#r=0;constructor(e,t){super(),this.renderingState=0,this.scheduler=e,this.gfxEngine=t}scheduleViewUpdate(e,t){this.#n|=t,1!==this.renderingState&&(this.renderingState=1,this.gfxEngine.renderer.xr.isPresenting||requestAnimationFrame((t=>{this.step(e,t)})))}#s(e,t,n){const i={camera:e.camera,engine:this.gfxEngine,scheduler:this.scheduler,view:e};t.forEach((e=>{const n=e.layer||e;n.isLayer&&n.parent&&t.add(n.parent)}));for(const r of e.getLayers(((e,t)=>!t)))if(i.geometryLayer=r,r.ready&&r.visible&&!r.frozen){e.execFrameRequesters("before_layer_update",n,this.#i,r);const s=Fp(t,r);if(s.size>0){for(const e of r.attachedLayers)e.ready&&e.preUpdate&&e.preUpdate(i,s);const e=r.preUpdate(i,s);Op(i,r,e),r.postUpdate(i,r,t)}e.execFrameRequesters("after_layer_update",n,this.#i,r)}}step(e,t){const n=t-this.#r;e._executeFrameRequestersRemovals(),e.execFrameRequesters("update_start",n,this.#i);const i=this.#n;this.#r=t,this.#n=!1,this.renderingState=0;const r=new Set(e._changeSources);e._changeSources.clear();const s=this.gfxEngine.getWindowSize();e.execFrameRequesters("before_camera_update",n,this.#i),e.camera.update(s.x,s.y),e.execFrameRequesters("after_camera_update",n,this.#i);const a=e.camera3D.matrixAutoUpdate;e.camera3D.matrixAutoUpdate=!1,this.#s(e,r,n),0==this.scheduler.commandsWaitingExecutionCount()&&this.dispatchEvent({type:"command-queue-empty"}),i&&this.#a(e,n),this.#i=0===this.renderingState,e.camera3D.matrixAutoUpdate=a,e.execFrameRequesters(Up,n,this.#i)}#a(e,t){e.execFrameRequesters(Np,t,this.#i),e.render?e.render():this.gfxEngine.renderView(e),e.execFrameRequesters("after_render",t,this.#i)}};let Qp=!1,zp=8,Gp=4096;function Hp(e,t,n){const i=e.getContext(),r=i.createShader(t);return i.shaderSource(r,n),i.compileShader(r),r}function Vp(){return navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().includes("firefox")}const jp={isLogDepthBufferSupported:()=>Qp,isFirefox:Vp,getMaxTextureUnitsCount:()=>zp,getMaxTextureSize:()=>Gp,updateCapabilities(e){const t=e.getContext();zp=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),Gp=t.getParameter(t.MAX_TEXTURE_SIZE);const n=t.createProgram(),i=Hp(e,t.VERTEX_SHADER,"void main() {\n    gl_Position = vec4( 0.0, 0.0, 0.0, 1.0 );\n}");let r=`#define SAMPLE ${zp}\n`;r+="uniform sampler2D uni[SAMPLE];\nvoid main() {\n    gl_FragColor += texture2D(uni[SAMPLE-1], vec2(0));\n}";const s=Hp(e,t.FRAGMENT_SHADER,r);if(t.attachShader(n,i),t.attachShader(n,s),t.linkProgram(n),!1===t.getProgramParameter(n,t.LINK_STATUS)){if(!(zp>16))throw new Error(`The GPU capabilities could not be determined accurately.\n                    Impossible to link a shader with the Maximum texture units ${zp}`);{const e=t.getProgramInfoLog(n);console.warn(`${e}: using a maximum of 16 texture units instead of the reported value (${zp})`),Vp()&&console.warn("It can come from a Mesa/Firefox bug;\n                        the shader compiles to an error when using more than 16 sampler uniforms,\n                        see https://bugzilla.mozilla.org/show_bug.cgi?id=777028"),zp=16}}t.deleteProgram(n),t.deleteShader(i),t.deleteShader(s),Qp=e.capabilities.logarithmicDepthBuffer}},qp=new RegExp("gl_Position.*(?![^]*gl_Position)"),Wp=new RegExp("[^\\w]*main[^\\w]*(void)?[^\\w]*{"),Yp={patchMaterialForLogDepthSupport(e){if(e.vertexShader.includes("USE_LOGDEPTHBUF")||e.vertexShader.includes("logdepthbuf_pars_vertex"))return;e.vertexShader=`#include <logdepthbuf_pars_vertex>\n#define EPSILON 1e-6\n${e.vertexShader}`;let t=qp.exec(e.vertexShader),n=t[0].length+t.index;e.vertexShader=`${e.vertexShader.slice(0,n)}\n#include <logdepthbuf_vertex>\n${e.vertexShader.slice(n)}`,e.fragmentShader=`#include <itowns/precision_qualifier\n${e.fragmentShader}`,e.fragmentShader=`#include <logdepthbuf_pars_fragment>\n${e.fragmentShader}`,t=Wp.exec(e.fragmentShader),n=t[0].length+t.index,e.fragmentShader=`${e.fragmentShader.slice(0,n)}\n#include <logdepthbuf_fragment>\n${e.fragmentShader.slice(n)}`,e.defines={USE_LOGDEPTHBUF:1,USE_LOGDEPTHBUF_EXT:1}},unrollLoops:(e,t)=>e.replace(/#pragma unroll_loop\s+for\s*\(\s*int\s+i\s*=\s*([\w\d]+);\s*i\s+<\s+([\w\d]+);\s*i\s*\+\+\s*\)\s*\{\n([^}]*)\}/g,(function(e,n,i,r){let s="";n=n in t?t[n]:parseInt(n,10),i=i in t?t[i]:parseInt(i,10);for(let e=n;e<i;e++)s+=r.replace(/\bi\b/g,` ${e} `);return s}))},Xp={FINAL:0,DEPTH:1,ID:2},Kp=Xp,Jp=function(e,t){const n=e.mode??Xp.FINAL;if(n==t)return()=>{};const i=e=>t=>{const n=t.material;n&&(n.mode=e)};return e.traverse(i(t)),()=>{e.traverse(i(n))}},$p={setDefineMapping(e,t,n){Object.keys(n).forEach((i=>{e.defines[`${t}_${i}`]=n[i]}))},setDefineProperty(e,t,n,i){e.defines[n]=i,Object.defineProperty(e,t,{get:()=>e.defines[n],set:t=>{e.defines[n]!=t&&(e.defines[n]=t,e.needsUpdate=!0)}})},setUniformProperty(e,t,n){e.uniforms[t]=new xc(n),Object.defineProperty(e,t,{get:()=>e.uniforms[t].value,set:n=>{e.uniforms[t].value!=n&&(e.uniforms[t].value=n)}})}},Zp=new $t(0,0,1,1),ef=new Jt,tf=255/256,nf=new $t(tf,.0038909912109375,tf/65536,5.9371814131736755e-8);function rf(e,t){return t?nf.dot(e)*t:nf.dot(e)}function sf(){const e=jp.getMaxTextureUnitsCount();return Math.min(e-1,15)}const af={bias:0,noDataValue:-99999,zmin:0,zmax:0,scale:0,mode:0,textureOffset:0,opacity:0,crs:0,effect_parameter:0,effect_type:0,transparent:!1};function of(e,t,n){const i=e.layers.value,r=e.textures.value,s=e.offsetScales.value,a=e.textureCount;let o=0;for(const e of t){e.textureOffset=o;for(let t=0,a=e.textures.length;t<a;++t,++o)o<n&&(s[o]=e.offsetScales[t],r[o]=e.textures[t],i[o]=e)}o>n&&console.warn(`LayeredMaterial: Not enough texture units (${n} < ${o}), excess textures have been discarded.`),a.value=o;for(let e=o;e<r.length;e++)r[e]=ef,s[e]=Zp,i[e]=af}const lf={RGBA:0,COLOR:1,DATA:2};let cf;const hf=[],uf=class extends hr{#o=!0;constructor(){let e=arguments.length>1?arguments[1]:void 0;super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}),cf=cf||[1,sf()],this.defines.NUM_VS_TEXTURES=cf[0],this.defines.NUM_FS_TEXTURES=cf[1],this.defines.USE_FOG=1,this.defines.NUM_CRS=e,$p.setDefineMapping(this,"ELEVATION",lf),$p.setDefineMapping(this,"MODE",Kp),$p.setDefineProperty(this,"mode","MODE",Kp.FINAL),this.vertexShader="#include <itowns/precision_qualifier>\n#include <common>\n#include <itowns/elevation_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#if NUM_CRS > 1\nattribute float     uv_1;\n#endif\n\nuniform bool lightingEnabled;\nvarying vec2 vHighPrecisionZW;\n\n#if MODE == MODE_FINAL\n#include <fog_pars_vertex>\nvarying vec3        vUv;\nvarying vec3        vNormal;\n#endif\nvoid main() {\n        #include <begin_vertex>\n        #include <itowns/elevation_vertex>\n        #include <itowns/geoid_vertex>\n        #include <project_vertex>\n        #include <logdepthbuf_vertex>\n        vHighPrecisionZW = gl_Position.zw;\n#if MODE == MODE_FINAL\n        #include <fog_vertex>\n        #if NUM_CRS > 1\n        vUv = vec3(uv, (uv_1 > 0.) ? uv_1 : uv.y); // set uv_1 = uv if uv_1 is undefined\n        #else\n        vUv = vec3(uv, 0.0);\n        #endif\n        vNormal = normalize ( mat3( modelMatrix[0].xyz, modelMatrix[1].xyz, modelMatrix[2].xyz ) * normal );\n#endif\n}\n",hf[e]=hf[e]||Yp.unrollLoops("#include <itowns/precision_qualifier>\n#include <logdepthbuf_pars_fragment>\n#include <itowns/pitUV>\n#include <itowns/color_layers_pars_fragment>\n#if MODE == MODE_FINAL\n#include <itowns/fog_pars_fragment>\n#include <itowns/overlay_pars_fragment>\n#include <itowns/lighting_pars_fragment>\n#endif\n#include <itowns/mode_pars_fragment>\n\nuniform vec3        diffuse;\nuniform float       opacity;\nvarying vec3        vUv; // uv.x/uv_1.x, uv.y, uv_1.y\nvarying vec2        vHighPrecisionZW;\n\nvoid main() {\n    #include <logdepthbuf_fragment>\n\n#if MODE == MODE_ID\n\n    #include <itowns/mode_id_fragment>\n\n#elif MODE == MODE_DEPTH\n\n    #include <itowns/mode_depth_fragment>\n\n#else\n\n    gl_FragColor = vec4(diffuse, opacity);\n\n    uvs[0] = vec3(vUv.xy, 0.);\n\n#if NUM_CRS > 1\n    uvs[1] = vec3(vUv.x, fract(vUv.z), floor(vUv.z));\n#endif\n\n    vec4 color;\n    #pragma unroll_loop\n    for ( int i = 0; i < NUM_FS_TEXTURES; i ++ ) {\n        color = getLayerColor( i , colorTextures[ i ], colorOffsetScales[ i ], colorLayers[ i ]);\n        gl_FragColor.rgb = mix(gl_FragColor.rgb, color.rgb, color.a);\n    }\n\n  #if defined(DEBUG)\n    if (showOutline) {\n        #pragma unroll_loop\n        for ( int i = 0; i < NUM_CRS; i ++) {\n            color = getOutlineColor( outlineColors[ i ], uvs[ i ].xy);\n            gl_FragColor.rgb = mix(gl_FragColor.rgb, color.rgb, color.a);\n        }\n    }\n  #endif\n\n    #include <itowns/fog_fragment>\n    #include <itowns/lighting_fragment>\n    #include <itowns/overlay_fragment>\n\n#endif\n}\n",this.defines),this.fragmentShader=hf[e],$p.setUniformProperty(this,"diffuse",new Ci(.04,.23,.35)),$p.setUniformProperty(this,"opacity",this.opacity),$p.setUniformProperty(this,"lightingEnabled",!1),$p.setUniformProperty(this,"lightPosition",new sn(-.5,0,1)),$p.setUniformProperty(this,"fogDistance",1e9),$p.setUniformProperty(this,"fogColor",new Ci(.76,.85,1)),$p.setUniformProperty(this,"overlayAlpha",0),$p.setUniformProperty(this,"overlayColor",new Ci(1,.3,0)),$p.setUniformProperty(this,"objectId",0),$p.setUniformProperty(this,"geoidHeight",0),$p.setUniformProperty(this,"minBorderDistance",-.01),this.layers=[],this.elevationLayerIds=[],this.colorLayerIds=[],this.uniforms.elevationLayers=new xc(new Array(cf[0]).fill(af)),this.uniforms.elevationTextures=new xc(new Array(cf[0]).fill(ef)),this.uniforms.elevationOffsetScales=new xc(new Array(cf[0]).fill(Zp)),this.uniforms.elevationTextureCount=new xc(0),this.uniforms.colorLayers=new xc(new Array(cf[1]).fill(af)),this.uniforms.colorTextures=new xc(new Array(cf[1]).fill(ef)),this.uniforms.colorOffsetScales=new xc(new Array(cf[1]).fill(Zp)),this.uniforms.colorTextureCount=new xc(0),Object.defineProperty(this,"visible",{get(){return this.#o},set(e){this.#o!=e&&(this.#o=e,this.dispatchEvent({type:e?"shown":"hidden"}))}})}getUniformByType(e){return{layers:this.uniforms[`${e}Layers`],textures:this.uniforms[`${e}Textures`],offsetScales:this.uniforms[`${e}OffsetScales`],textureCount:this.uniforms[`${e}TextureCount`]}}updateLayersUniforms(){const e=this.layers.filter((e=>this.colorLayerIds.includes(e.id)&&e.visible&&e.opacity>0));if(e.sort(((e,t)=>this.colorLayerIds.indexOf(e.id)-this.colorLayerIds.indexOf(t.id))),of(this.getUniformByType("color"),e,this.defines.NUM_FS_TEXTURES),this.elevationLayerIds.some((e=>this.getLayer(e)))||this.uniforms.elevationTextureCount.value&&!this.elevationLayerIds.length){const e=this.getElevationLayer()?[this.getElevationLayer()]:[];of(this.getUniformByType("elevation"),e,this.defines.NUM_VS_TEXTURES)}this.layersNeedUpdate=!1}dispose(){this.dispatchEvent({type:"dispose"}),this.layers.forEach((e=>e.dispose(!0))),this.layers.length=0,this.layersNeedUpdate=!0}setSequence(e){this.colorLayerIds=e,this.layersNeedUpdate=!0}setSequenceElevation(e){this.elevationLayerIds[0]=e,this.layersNeedUpdate=!0}removeLayer(e){const t=this.layers.findIndex((t=>t.id===e));if(t>-1){this.layers[t].dispose(),this.layers.splice(t,1);const n=this.colorLayerIds.indexOf(e);n>-1?this.colorLayerIds.splice(n,1):this.elevationLayerIds=[]}}addLayer(e){e.layer.id in this.layers&&console.warn('The "{layer.id}" layer was already present in the material, overwritting.'),this.layers.push(e)}getLayer(e){return this.layers.find((t=>t.id===e))}getLayers(e){return this.layers.filter((t=>e.includes(t.id)))}getElevationLayer(){return this.layers.find((e=>e.id===this.elevationLayerIds[0]))}setElevationScale(e){this.elevationLayerIds.length&&(this.getElevationLayer().scale=e)}};const df=new $t;class pf extends At{constructor(e,t){super(),this.layer=t,this.crs=t.parent.tileMatrixSets.indexOf(t.crs),-1==this.crs&&console.error("Unknown crs:",t.crs),this.textures=[],this.offsetScales=[],this.level=-1,this.material=e,this._handlerCBEvent=()=>{this.material.layersNeedUpdate=!0},t.addEventListener("visible-property-changed",this._handlerCBEvent),t.addEventListener("opacity-property-changed",this._handlerCBEvent)}get id(){return this.layer.id}get opacity(){return this.layer.opacity}get visible(){return this.layer.visible}initFromParent(e,t){if(e&&e.level>this.level){let n=0;const i=this.sortBestParentTextures(e.textures);for(const e of t){const t=i.find((t=>t&&e.isInside(t.extent)));t&&this.setTexture(n++,t,e.offsetToParent(t.extent))}}}sortBestParentTextures(e){return e.toSorted(((e,t)=>((e,t)=>e.isTexture===t.isTexture?0:e.isTexture?-1:1)(e,t)||((e,t)=>t.extent.zoom-e.extent.zoom)(e,t)))}disposeRedrawnTextures(e){const t=e.map(((e,t)=>this.shouldWriteTextureAtIndex(t,e)?t:-1)).filter((e=>-1!==e));t.length===e.length?this.dispose(!1):this.disposeAtIndexes(t)}dispose(){(!(arguments.length>0&&void 0!==arguments[0])||arguments[0])&&(this.layer.removeEventListener("visible-property-changed",this._handlerCBEvent),this.layer.removeEventListener("opacity-property-changed",this._handlerCBEvent),this._listeners={}),this.disposeAtIndexes(this.textures.keys()),this.textures=[],this.offsetScales=[],this.level=-1}disposeAtIndexes(e){for(const t of e){const e=this.textures[t];e&&e.isTexture&&e.dispose()}this.material.layersNeedUpdate=!0}setTexture(e,t,n){this.shouldWriteTextureAtIndex(e,t)&&(this.level=t&&t.extent?t.extent.zoom:this.level,this.textures[e]=t||null,this.offsetScales[e]=n,this.material.layersNeedUpdate=!0)}setTextures(e,t){this.disposeRedrawnTextures(e);for(let n=0,i=e.length;n<i;++n)this.setTexture(n,e[n],t[n])}shouldWriteTextureAtIndex(e,t){return!this.textures[e]||t&&t.isTexture}}class ff extends pf{get effect_type(){return this.layer.effect_type}get effect_parameter(){return this.layer.effect_parameter}get transparent(){return this.layer.transparent}}class mf extends pf{constructor(e,t){super(e,t);const n={bias:0,mode:lf.DATA,zmin:-1/0,zmax:1/0};if(this.scaleFactor=1,t.useRgbaTextureElevation)throw n.mode=lf.RGBA,n.zmax=5e3,new Error("Restore this feature");t.useColorTextureElevation?(this.scaleFactor=t.colorTextureElevationMaxZ-t.colorTextureElevationMinZ,n.mode=lf.COLOR,n.bias=t.colorTextureElevationMinZ,this.min=this.layer.colorTextureElevationMinZ,this.max=this.layer.colorTextureElevationMaxZ):(this.min=0,this.max=0),this.bias=t.bias??n.bias,this.mode=t.mode??n.mode,this.zmin=t.zmin??n.zmin,this.zmax=t.zmax??n.zmax,t.addEventListener("scale-property-changed",this._handlerCBEvent)}get scale(){return this.layer.scale*this.scaleFactor}dispose(e){super.dispose(e),e&&this.layer.removeEventListener("scale-property-changed",this._handlerCBEvent)}initFromParent(e,t){const n=this.level;super.initFromParent(e,t),this.updateMinMaxElevation(),n!==this.level&&this.dispatchEvent({type:"rasterElevationLevelChanged",node:this})}setTextures(e,t){const n=e.find((e=>null!=e));if(!n)return;const i=this.level;this.replaceNoDataValueFromTexture(n),super.setTextures(e,t),this.updateMinMaxElevation(),i!==this.level&&this.dispatchEvent({type:"rasterElevationLevelChanged",node:this})}updateMinMaxElevation(){const e=this.textures.findIndex((e=>e.isTexture));if(-1!==e&&!this.layer.useColorTextureElevation){const{min:t,max:n}=function(e,t,n){const{width:i,height:r,data:s}=e.image;if(!s)return{min:null,max:null};let{min:a,max:o}=function(e,t,n){const i=t.x,r=t.y,s=t.z,a=[Mp(n,e,i,r),Mp(n,e,i+s,r),Mp(n,e,i+s,r+s),Mp(n,e,i,r+s)].filter((e=>null!=e));return a.length?{min:Math.min(...a),max:Math.max(...a)}:{min:1/0,max:-1/0}}(e,t,n);const l=Math.floor(t.z*i);if(l>2){const e=Math.floor(t.z*r),c=Math.floor(t.x*i),h=Math.floor(t.y*r),u=Math.max(Math.floor(l/32),2);for(let t=h;t<h+e;t+=u){let e=t*(i||0)+c;const r=e+l;for(;e<r;e+=u){const t=s[e];t!==n.noDataValue&&(o=Math.max(o,t),a=Math.min(a,t))}}}return null!=n.zmin&&(a<n.zmin&&(a=n.zmin),o<n.zmin&&(o=n.zmin)),null!=n.zmax&&(a>n.zmax&&(a=n.zmax),o>n.zmax&&(o=n.zmax)),o===-1/0||a===1/0?{min:null,max:null}:{min:a,max:o}}(this.textures[e],this.offsetScales[e],{noDataValue:this.layer.noDataValue,zmin:this.layer.zmin,zmax:this.layer.zmax});this.min==t&&this.max==n||(this.min=isNaN(t)?this.min:t,this.max=isNaN(n)?this.max:n)}}replaceNoDataValueFromTexture(e){const t=this.layer.noDataValue;if(null==t)return;const n=this.textures.find((e=>null!=e)),i=n&&n.image&&n.image.data,r=e.image&&e.image.data;r&&!function(e,t){const n=e.length;return e[0]>t&&e[n-1]>t&&e[Math.sqrt(n)-1]>t&&e[n-Math.sqrt(n)]>t}(r,t)&&function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:()=>0,n=arguments.length>2?arguments[2]:void 0;for(let i=0,r=e.length;i<r;++i)e[i]===n&&(e[i]=t(i))}(r,i&&function(e,t,n,i){return e.extent.offsetToParent(t.extent,i),e=>n[function(e,t,n){const i=Math.floor(e/n)/n,r=t.x+e%n/n*t.z,s=t.y+i*t.w;return Math.floor(s*n)*n+Math.floor(r*n)}(e,i,256)]}(e,n,i,df),t)}}function gf(e,t){const n=t.groups.filter((t=>t<=e));return n.length?n[n.length-1]:t.groups[0]}function Af(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return-1==t?n.zoom?n.zoom.min:0:Math.min(e,Math.ceil((t+e)/2))}function yf(e,t){let n,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:t.level,r=arguments.length>3?arguments[3]:void 0,s=arguments.length>4?arguments[4]:void 0,a=arguments.length>5?arguments[5]:void 0;const o=s.source.zoom?s.source.zoom.max:1/0;if(a.lowestLevelError!=1/0)n=Af(a.lowestLevelError,r,s.source),n=a.lowestLevelError==n?n-1:n,1==e&&(n=gf(n,s.updateStrategy.options));else{switch(e){case 1:n=gf(i,s.updateStrategy.options);break;case 2:n=function(e,t,n){return Math.min(e,t+(n.increment||1))}(i,r,s.updateStrategy.options);break;case 3:n=Af(i,r,s.source);break;default:n=function(e,t,n,i){return e.pendingSubdivision&&!i.isVectorTileSource?n:t}(t,i,r,s.source)}n=Math.min(n,o)}return n}class vf{constructor(e){this.layer=e}clear(){}update(){}}class _f extends vf{constructor(e){super(e),this.displayed={tiles:new Set},Object.defineProperty(this.displayed,"layers",{get:()=>{let e=[];return this.displayed.tiles.forEach((t=>{const n=t.material;e=[...new Set([...e,...n.colorLayerIds.filter((e=>n.getLayer(e))),...n.elevationLayerIds])]})),this.layer.attachedLayers.filter((t=>e.includes(t.id)))}}),Object.defineProperty(this.displayed,"extent",{get:()=>{const e=new up(this.layer.extent.crs,1/0,-1/0,1/0,-1/0);return e.min=1/0,e.max=-1/0,this.displayed.tiles.forEach((t=>{e.union(t.extent),e.min=Math.min(t.obb.z.min,e.min),e.max=Math.max(t.obb.z.max,e.max)})),e}})}clear(){this.displayed.tiles.clear()}update(e){e.material.visible?this.displayed.tiles.add(e):this.displayed.tiles.delete(e)}}var xf={$version:8,$root:{version:{required:!0,type:"enum",values:[8]},name:{type:"string"},metadata:{type:"*"},center:{type:"array",value:"number"},centerAltitude:{type:"number"},zoom:{type:"number"},bearing:{type:"number",default:0,period:360,units:"degrees"},pitch:{type:"number",default:0,units:"degrees"},roll:{type:"number",default:0,units:"degrees"},light:{type:"light"},sky:{type:"sky"},projection:{type:"projection"},terrain:{type:"terrain"},sources:{required:!0,type:"sources"},sprite:{type:"sprite"},glyphs:{type:"string"},transition:{type:"transition"},layers:{required:!0,type:"array",value:"layer"}},sources:{"*":{type:"source"}},source:["source_vector","source_raster","source_raster_dem","source_geojson","source_video","source_image"],source_vector:{type:{required:!0,type:"enum",values:{vector:{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},scheme:{type:"enum",values:{xyz:{},tms:{}},default:"xyz"},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},attribution:{type:"string"},promoteId:{type:"promoteId"},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_raster:{type:{required:!0,type:"enum",values:{raster:{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},tileSize:{type:"number",default:512,units:"pixels"},scheme:{type:"enum",values:{xyz:{},tms:{}},default:"xyz"},attribution:{type:"string"},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_raster_dem:{type:{required:!0,type:"enum",values:{"raster-dem":{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},tileSize:{type:"number",default:512,units:"pixels"},attribution:{type:"string"},encoding:{type:"enum",values:{terrarium:{},mapbox:{},custom:{}},default:"mapbox"},redFactor:{type:"number",default:1},blueFactor:{type:"number",default:1},greenFactor:{type:"number",default:1},baseShift:{type:"number",default:0},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_geojson:{type:{required:!0,type:"enum",values:{geojson:{}}},data:{required:!0,type:"*"},maxzoom:{type:"number",default:18},attribution:{type:"string"},buffer:{type:"number",default:128,maximum:512,minimum:0},filter:{type:"*"},tolerance:{type:"number",default:.375},cluster:{type:"boolean",default:!1},clusterRadius:{type:"number",default:50,minimum:0},clusterMaxZoom:{type:"number"},clusterMinPoints:{type:"number"},clusterProperties:{type:"*"},lineMetrics:{type:"boolean",default:!1},generateId:{type:"boolean",default:!1},promoteId:{type:"promoteId"}},source_video:{type:{required:!0,type:"enum",values:{video:{}}},urls:{required:!0,type:"array",value:"string"},coordinates:{required:!0,type:"array",length:4,value:{type:"array",length:2,value:"number"}}},source_image:{type:{required:!0,type:"enum",values:{image:{}}},url:{required:!0,type:"string"},coordinates:{required:!0,type:"array",length:4,value:{type:"array",length:2,value:"number"}}},layer:{id:{type:"string",required:!0},type:{type:"enum",values:{fill:{},line:{},symbol:{},circle:{},heatmap:{},"fill-extrusion":{},raster:{},hillshade:{},background:{}},required:!0},metadata:{type:"*"},source:{type:"string"},"source-layer":{type:"string"},minzoom:{type:"number",minimum:0,maximum:24},maxzoom:{type:"number",minimum:0,maximum:24},filter:{type:"filter"},layout:{type:"layout"},paint:{type:"paint"}},layout:["layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_hillshade","layout_background"],layout_background:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_fill:{"fill-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_circle:{"circle-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_heatmap:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},"layout_fill-extrusion":{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_line:{"line-cap":{type:"enum",values:{butt:{},round:{},square:{}},default:"butt",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"line-join":{type:"enum",values:{bevel:{},round:{},miter:{}},default:"miter",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{type:"number",default:2,requires:[{"line-join":"miter"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-round-limit":{type:"number",default:1.05,requires:[{"line-join":"round"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_symbol:{"symbol-placement":{type:"enum",values:{point:{},line:{},"line-center":{}},default:"point",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"symbol-spacing":{type:"number",default:250,minimum:1,units:"pixels",requires:[{"symbol-placement":"line"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{type:"boolean",default:!1,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{type:"enum",values:{auto:{},"viewport-y":{},source:{}},default:"auto",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{type:"boolean",default:!1,requires:["icon-image",{"!":"icon-overlap"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-overlap":{type:"enum",values:{never:{},always:{},cooperative:{}},requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{type:"boolean",default:!1,requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-optional":{type:"boolean",default:!1,requires:["icon-image","text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-size":{type:"number",default:1,minimum:0,units:"factor of the original icon size",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit":{type:"enum",values:{none:{},width:{},height:{},both:{}},default:"none",requires:["icon-image","text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-text-fit-padding":{type:"array",value:"number",length:4,default:[0,0,0,0],units:"pixels",requires:["icon-image","text-field",{"icon-text-fit":["both","width","height"]}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"icon-image":{type:"resolvedImage",tokens:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{type:"number",default:0,period:360,units:"degrees",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{type:"padding",default:[2],units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-keep-upright":{type:"boolean",default:!1,requires:["icon-image",{"icon-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-offset":{type:"array",value:"number",length:2,default:[0,0],requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{type:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},default:"center",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{type:"enum",values:{map:{},viewport:{},"viewport-glyph":{},auto:{}},default:"auto",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-field":{type:"formatted",default:"",tokens:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-font":{type:"array",value:"string",default:["Open Sans Regular","Arial Unicode MS Regular"],requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-size":{type:"number",default:16,minimum:0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-max-width":{type:"number",default:10,minimum:0,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{type:"number",default:1.2,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-letter-spacing":{type:"number",default:0,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-justify":{type:"enum",values:{auto:{},left:{},center:{},right:{}},default:"center",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{type:"number",units:"ems",default:0,requires:["text-field"],"property-type":"data-driven",expression:{interpolated:!0,parameters:["zoom","feature"]}},"text-variable-anchor":{type:"array",value:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-variable-anchor-offset":{type:"variableAnchorOffsetCollection",requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-anchor":{type:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},default:"center",requires:["text-field",{"!":"text-variable-anchor"}],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{type:"number",default:45,units:"degrees",requires:["text-field",{"symbol-placement":["line","line-center"]}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-writing-mode":{type:"array",value:"enum",values:{horizontal:{},vertical:{}},requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-rotate":{type:"number",default:0,period:360,units:"degrees",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-padding":{type:"number",default:2,minimum:0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-keep-upright":{type:"boolean",default:!0,requires:["text-field",{"text-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-transform":{type:"enum",values:{none:{},uppercase:{},lowercase:{}},default:"none",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-offset":{type:"array",value:"number",units:"ems",length:2,default:[0,0],requires:["text-field",{"!":"text-radial-offset"}],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{type:"boolean",default:!1,requires:["text-field",{"!":"text-overlap"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-overlap":{type:"enum",values:{never:{},always:{},cooperative:{}},requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{type:"boolean",default:!1,requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-optional":{type:"boolean",default:!1,requires:["text-field","icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_raster:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_hillshade:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},filter:{type:"array",value:"*"},filter_operator:{type:"enum",values:{"==":{},"!=":{},">":{},">=":{},"<":{},"<=":{},in:{},"!in":{},all:{},any:{},none:{},has:{},"!has":{}}},geometry_type:{type:"enum",values:{Point:{},LineString:{},Polygon:{}}},function:{expression:{type:"expression"},stops:{type:"array",value:"function_stop"},base:{type:"number",default:1,minimum:0},property:{type:"string",default:"$zoom"},type:{type:"enum",values:{identity:{},exponential:{},interval:{},categorical:{}},default:"exponential"},colorSpace:{type:"enum",values:{rgb:{},lab:{},hcl:{}},default:"rgb"},default:{type:"*",required:!1}},function_stop:{type:"array",minimum:0,maximum:24,value:["number","color"],length:2},expression:{type:"array",value:"*",minimum:1},light:{anchor:{type:"enum",default:"viewport",values:{map:{},viewport:{}},"property-type":"data-constant",transition:!1,expression:{interpolated:!1,parameters:["zoom"]}},position:{type:"array",default:[1.15,210,30],length:3,value:"number","property-type":"data-constant",transition:!0,expression:{interpolated:!0,parameters:["zoom"]}},color:{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},intensity:{type:"number","property-type":"data-constant",default:.5,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0}},sky:{"sky-color":{type:"color","property-type":"data-constant",default:"#88C6FC",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"horizon-color":{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"fog-color":{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"fog-ground-blend":{type:"number","property-type":"data-constant",default:.5,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"horizon-fog-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"sky-horizon-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"atmosphere-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0}},terrain:{source:{type:"string",required:!0},exaggeration:{type:"number",minimum:0,default:1}},projection:{type:{type:"projectionDefinition",default:"mercator","property-type":"data-constant",transition:!1,expression:{interpolated:!0,parameters:["zoom"]}}},paint:["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_hillshade","paint_background"],paint_fill:{"fill-antialias":{type:"boolean",default:!0,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"fill-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-outline-color":{type:"color",transition:!0,requires:[{"!":"fill-pattern"},{"fill-antialias":!0}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["fill-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"fill-extrusion-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["fill-extrusion-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"},"fill-extrusion-height":{type:"number",default:0,minimum:0,units:"meters",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{type:"number",default:0,minimum:0,units:"meters",transition:!0,requires:["fill-extrusion-height"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-vertical-gradient":{type:"boolean",default:!0,transition:!1,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},paint_line:{"line-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"line-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["line-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"line-width":{type:"number",default:1,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-gap-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-offset":{type:"number",default:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-dasharray":{type:"array",value:"number",minimum:0,transition:!0,units:"line widths",requires:[{"!":"line-pattern"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"cross-faded"},"line-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"},"line-gradient":{type:"color",transition:!1,requires:[{"!":"line-dasharray"},{"!":"line-pattern"},{source:"geojson",has:{lineMetrics:!0}}],expression:{interpolated:!0,parameters:["line-progress"]},"property-type":"color-ramp"}},paint_circle:{"circle-radius":{type:"number",default:5,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-blur":{type:"number",default:0,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["circle-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{type:"enum",values:{map:{},viewport:{}},default:"map",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{type:"enum",values:{map:{},viewport:{}},default:"viewport",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"}},paint_heatmap:{"heatmap-radius":{type:"number",default:30,minimum:1,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-weight":{type:"number",default:1,minimum:0,transition:!1,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-intensity":{type:"number",default:1,minimum:0,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"heatmap-color":{type:"color",default:["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",.1,"royalblue",.3,"cyan",.5,"lime",.7,"yellow",1,"red"],transition:!1,expression:{interpolated:!0,parameters:["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_symbol:{"icon-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-color":{type:"color",default:"#000000",transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-color":{type:"color",default:"rgba(0, 0, 0, 0)",transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["icon-image","icon-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-color":{type:"color",default:"#000000",transition:!0,overridable:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-color":{type:"color",default:"rgba(0, 0, 0, 0)",transition:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["text-field","text-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},paint_raster:{"raster-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-hue-rotate":{type:"number",default:0,period:360,transition:!0,units:"degrees",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{type:"number",default:0,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-saturation":{type:"number",default:0,minimum:-1,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-contrast":{type:"number",default:0,minimum:-1,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-resampling":{type:"enum",values:{linear:{},nearest:{}},default:"linear",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{type:"number",default:300,minimum:0,transition:!1,units:"milliseconds",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_hillshade:{"hillshade-illumination-direction":{type:"number",default:335,minimum:0,maximum:359,transition:!1,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{type:"enum",values:{map:{},viewport:{}},default:"viewport",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{type:"number",default:.5,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-highlight-color":{type:"color",default:"#FFFFFF",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-accent-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_background:{"background-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"background-pattern"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"background-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"cross-faded"},"background-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},transition:{duration:{type:"number",default:300,minimum:0,units:"milliseconds"},delay:{type:"number",default:0,minimum:0,units:"milliseconds"}},"property-type":{"data-driven":{type:"property-type"},"cross-faded":{type:"property-type"},"cross-faded-data-driven":{type:"property-type"},"color-ramp":{type:"property-type"},"data-constant":{type:"property-type"},constant:{type:"property-type"}},promoteId:{"*":{type:"string"}}};class Ef{constructor(e,t,n,i){this.message=(e?`${e}: `:"")+n,i&&(this.identifier=i),null!=t&&t.__line__&&(this.line=t.__line__)}}function bf(e,...t){for(const n of t)for(const t in n)e[t]=n[t];return e}class wf extends Error{constructor(e,t){super(t),this.message=t,this.key=e}}class Mf{constructor(e,t=[]){this.parent=e,this.bindings={};for(const[e,n]of t)this.bindings[e]=n}concat(e){return new Mf(this,e)}get(e){if(this.bindings[e])return this.bindings[e];if(this.parent)return this.parent.get(e);throw new Error(`${e} not found in scope.`)}has(e){return!!this.bindings[e]||!!this.parent&&this.parent.has(e)}}const Sf={kind:"null"},Cf={kind:"number"},Tf={kind:"string"},If={kind:"boolean"},Rf={kind:"color"},Bf={kind:"projectionDefinition"},Lf={kind:"object"},Pf={kind:"value"},Df={kind:"collator"},Nf={kind:"formatted"},Uf={kind:"padding"},Of={kind:"resolvedImage"},Ff={kind:"variableAnchorOffsetCollection"};function kf(e,t){return{kind:"array",itemType:e,N:t}}function Qf(e){if("array"===e.kind){const t=Qf(e.itemType);return"number"==typeof e.N?`array<${t}, ${e.N}>`:"value"===e.itemType.kind?"array":`array<${t}>`}return e.kind}const zf=[Sf,Cf,Tf,If,Rf,Bf,Nf,Lf,kf(Pf),Uf,Of,Ff];function Gf(e,t){if("error"===t.kind)return null;if("array"===e.kind){if("array"===t.kind&&(0===t.N&&"value"===t.itemType.kind||!Gf(e.itemType,t.itemType))&&("number"!=typeof e.N||e.N===t.N))return null}else{if(e.kind===t.kind)return null;if("value"===e.kind)for(const e of zf)if(!Gf(e,t))return null}return`Expected ${Qf(e)} but found ${Qf(t)} instead.`}function Hf(e,t){return t.some((t=>t.kind===e.kind))}function Vf(e,t){return t.some((t=>"null"===t?null===e:"array"===t?Array.isArray(e):"object"===t?e&&!Array.isArray(e)&&"object"==typeof e:t===typeof e))}function jf(e,t){return"array"===e.kind&&"array"===t.kind?e.itemType.kind===t.itemType.kind&&"number"==typeof e.N:e.kind===t.kind}const qf=.96422,Wf=.82521,Yf=4/29,Xf=6/29,Kf=3*Xf*Xf,Jf=Xf*Xf*Xf,$f=Math.PI/180,Zf=180/Math.PI;function em(e){return(e%=360)<0&&(e+=360),e}function tm([e,t,n,i]){let r,s;const a=im((.2225045*(e=nm(e))+.7168786*(t=nm(t))+.0606169*(n=nm(n)))/1);e===t&&t===n?r=s=a:(r=im((.4360747*e+.3850649*t+.1430804*n)/qf),s=im((.0139322*e+.0971045*t+.7141733*n)/Wf));const o=116*a-16;return[o<0?0:o,500*(r-a),200*(a-s),i]}function nm(e){return e<=.04045?e/12.92:Math.pow((e+.055)/1.055,2.4)}function im(e){return e>Jf?Math.pow(e,1/3):e/Kf+Yf}function rm([e,t,n,i]){let r=(e+16)/116,s=isNaN(t)?r:r+t/500,a=isNaN(n)?r:r-n/200;return r=1*am(r),s=qf*am(s),a=Wf*am(a),[sm(3.1338561*s-1.6168667*r-.4906146*a),sm(-.9787684*s+1.9161415*r+.033454*a),sm(.0719453*s-.2289914*r+1.4052427*a),i]}function sm(e){return(e=e<=.00304?12.92*e:1.055*Math.pow(e,1/2.4)-.055)<0?0:e>1?1:e}function am(e){return e>Xf?e*e*e:Kf*(e-Yf)}function om(e){return parseInt(e.padEnd(2,e),16)/255}function lm(e,t){return cm(t?e/100:e,0,1)}function cm(e,t,n){return Math.min(Math.max(t,e),n)}function hm(e){return!e.some(Number.isNaN)}const um={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]};function dm(e,t,n){return e+n*(t-e)}function pm(e,t,n){return e.map(((e,i)=>dm(e,t[i],n)))}class fm{constructor(e,t,n,i=1,r=!0){this.r=e,this.g=t,this.b=n,this.a=i,r||(this.r*=i,this.g*=i,this.b*=i,i||this.overwriteGetter("rgb",[e,t,n,i]))}static parse(e){if(e instanceof fm)return e;if("string"!=typeof e)return;const t=function(e){if("transparent"===(e=e.toLowerCase().trim()))return[0,0,0,0];const t=um[e];if(t){const[e,n,i]=t;return[e/255,n/255,i/255,1]}if(e.startsWith("#")&&/^#(?:[0-9a-f]{3,4}|[0-9a-f]{6}|[0-9a-f]{8})$/.test(e)){const t=e.length<6?1:2;let n=1;return[om(e.slice(n,n+=t)),om(e.slice(n,n+=t)),om(e.slice(n,n+=t)),om(e.slice(n,n+t)||"ff")]}if(e.startsWith("rgb")){const t=/^rgba?\(\s*([\de.+-]+)(%)?(?:\s+|\s*(,)\s*)([\de.+-]+)(%)?(?:\s+|\s*(,)\s*)([\de.+-]+)(%)?(?:\s*([,\/])\s*([\de.+-]+)(%)?)?\s*\)$/,n=e.match(t);if(n){const[e,t,i,r,s,a,o,l,c,h,u,d]=n,p=[r||" ",o||" ",h].join("");if("  "===p||"  /"===p||",,"===p||",,,"===p){const e=[i,a,c].join(""),n="%%%"===e?100:""===e?255:0;if(n){const e=[cm(+t/n,0,1),cm(+s/n,0,1),cm(+l/n,0,1),u?lm(+u,d):1];if(hm(e))return e}}return}}const n=e.match(/^hsla?\(\s*([\de.+-]+)(?:deg)?(?:\s+|\s*(,)\s*)([\de.+-]+)%(?:\s+|\s*(,)\s*)([\de.+-]+)%(?:\s*([,\/])\s*([\de.+-]+)(%)?)?\s*\)$/);if(n){const[e,t,i,r,s,a,o,l,c]=n,h=[i||" ",s||" ",o].join("");if("  "===h||"  /"===h||",,"===h||",,,"===h){const e=[+t,cm(+r,0,100),cm(+a,0,100),l?lm(+l,c):1];if(hm(e))return function([e,t,n,i]){function r(i){const r=(i+e/30)%12,s=t*Math.min(n,1-n);return n-s*Math.max(-1,Math.min(r-3,9-r,1))}return e=em(e),t/=100,n/=100,[r(0),r(8),r(4),i]}(e)}}}(e);return t?new fm(...t,!1):void 0}get rgb(){const{r:e,g:t,b:n,a:i}=this,r=i||1/0;return this.overwriteGetter("rgb",[e/r,t/r,n/r,i])}get hcl(){return this.overwriteGetter("hcl",function(e){const[t,n,i,r]=tm(e),s=Math.sqrt(n*n+i*i);return[Math.round(1e4*s)?em(Math.atan2(i,n)*Zf):NaN,s,t,r]}(this.rgb))}get lab(){return this.overwriteGetter("lab",tm(this.rgb))}overwriteGetter(e,t){return Object.defineProperty(this,e,{value:t}),t}toString(){const[e,t,n,i]=this.rgb;return`rgba(${[e,t,n].map((e=>Math.round(255*e))).join(",")},${i})`}static interpolate(e,t,n,i="rgb"){switch(i){case"rgb":{const[i,r,s,a]=pm(e.rgb,t.rgb,n);return new fm(i,r,s,a,!1)}case"hcl":{const[i,r,s,a]=e.hcl,[o,l,c,h]=t.hcl;let u,d;if(isNaN(i)||isNaN(o))isNaN(i)?isNaN(o)?u=NaN:(u=o,1!==s&&0!==s||(d=l)):(u=i,1!==c&&0!==c||(d=r));else{let e=o-i;o>i&&e>180?e-=360:o<i&&i-o>180&&(e+=360),u=i+n*e}const[p,f,m,g]=function([e,t,n,i]){return e=isNaN(e)?0:e*$f,rm([n,Math.cos(e)*t,Math.sin(e)*t,i])}([u,null!=d?d:dm(r,l,n),dm(s,c,n),dm(a,h,n)]);return new fm(p,f,m,g,!1)}case"lab":{const[i,r,s,a]=rm(pm(e.lab,t.lab,n));return new fm(i,r,s,a,!1)}}}}fm.black=new fm(0,0,0,1),fm.white=new fm(1,1,1,1),fm.transparent=new fm(0,0,0,0),fm.red=new fm(1,0,0,1);class mm{constructor(e,t,n){this.sensitivity=e?t?"variant":"case":t?"accent":"base",this.locale=n,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(e,t){return this.collator.compare(e,t)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class gm{constructor(e,t,n,i,r){this.text=e,this.image=t,this.scale=n,this.fontStack=i,this.textColor=r}}class Am{constructor(e){this.sections=e}static fromString(e){return new Am([new gm(e,null,null,null,null)])}isEmpty(){return 0===this.sections.length||!this.sections.some((e=>0!==e.text.length||e.image&&0!==e.image.name.length))}static factory(e){return e instanceof Am?e:Am.fromString(e)}toString(){return 0===this.sections.length?"":this.sections.map((e=>e.text)).join("")}}class ym{constructor(e){this.values=e.slice()}static parse(e){if(e instanceof ym)return e;if("number"==typeof e)return new ym([e,e,e,e]);if(Array.isArray(e)&&!(e.length<1||e.length>4)){for(const t of e)if("number"!=typeof t)return;switch(e.length){case 1:e=[e[0],e[0],e[0],e[0]];break;case 2:e=[e[0],e[1],e[0],e[1]];break;case 3:e=[e[0],e[1],e[2],e[1]]}return new ym(e)}}toString(){return JSON.stringify(this.values)}static interpolate(e,t,n){return new ym(pm(e.values,t.values,n))}}class vm{constructor(e){this.name="ExpressionEvaluationError",this.message=e}toJSON(){return this.message}}const _m=new Set(["center","left","right","top","bottom","top-left","top-right","bottom-left","bottom-right"]);class xm{constructor(e){this.values=e.slice()}static parse(e){if(e instanceof xm)return e;if(Array.isArray(e)&&!(e.length<1)&&e.length%2==0){for(let t=0;t<e.length;t+=2){const n=e[t],i=e[t+1];if("string"!=typeof n||!_m.has(n))return;if(!Array.isArray(i)||2!==i.length||"number"!=typeof i[0]||"number"!=typeof i[1])return}return new xm(e)}}toString(){return JSON.stringify(this.values)}static interpolate(e,t,n){const i=e.values,r=t.values;if(i.length!==r.length)throw new vm(`Cannot interpolate values of different length. from: ${e.toString()}, to: ${t.toString()}`);const s=[];for(let e=0;e<i.length;e+=2){if(i[e]!==r[e])throw new vm(`Cannot interpolate values containing mismatched anchors. from[${e}]: ${i[e]}, to[${e}]: ${r[e]}`);s.push(i[e]);const[t,a]=i[e+1],[o,l]=r[e+1];s.push([dm(t,o,n),dm(a,l,n)])}return new xm(s)}}class Em{constructor(e){this.name=e.name,this.available=e.available}toString(){return this.name}static fromString(e){return e?new Em({name:e,available:!1}):null}}class bm{constructor(e,t,n){this.from=e,this.to=t,this.transition=n}static interpolate(e,t,n){return new bm(e,t,n)}static parse(e){return e instanceof bm?e:Array.isArray(e)&&3===e.length&&"string"==typeof e[0]&&"string"==typeof e[1]&&"number"==typeof e[2]?new bm(e[0],e[1],e[2]):"object"==typeof e&&"string"==typeof e.from&&"string"==typeof e.to&&"number"==typeof e.transition?new bm(e.from,e.to,e.transition):"string"==typeof e?new bm(e,e,1):void 0}}function wm(e,t,n,i){return"number"==typeof e&&e>=0&&e<=255&&"number"==typeof t&&t>=0&&t<=255&&"number"==typeof n&&n>=0&&n<=255?void 0===i||"number"==typeof i&&i>=0&&i<=1?null:`Invalid rgba value [${[e,t,n,i].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${("number"==typeof i?[e,t,n,i]:[e,t,n]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function Mm(e){if(null===e||"string"==typeof e||"boolean"==typeof e||"number"==typeof e||e instanceof bm||e instanceof fm||e instanceof mm||e instanceof Am||e instanceof ym||e instanceof xm||e instanceof Em)return!0;if(Array.isArray(e)){for(const t of e)if(!Mm(t))return!1;return!0}if("object"==typeof e){for(const t in e)if(!Mm(e[t]))return!1;return!0}return!1}function Sm(e){if(null===e)return Sf;if("string"==typeof e)return Tf;if("boolean"==typeof e)return If;if("number"==typeof e)return Cf;if(e instanceof fm)return Rf;if(e instanceof bm)return Bf;if(e instanceof mm)return Df;if(e instanceof Am)return Nf;if(e instanceof ym)return Uf;if(e instanceof xm)return Ff;if(e instanceof Em)return Of;if(Array.isArray(e)){const t=e.length;let n;for(const t of e){const e=Sm(t);if(n){if(n===e)continue;n=Pf;break}n=e}return kf(n||Pf,t)}return Lf}function Cm(e){const t=typeof e;return null===e?"":"string"===t||"number"===t||"boolean"===t?String(e):e instanceof fm||e instanceof bm||e instanceof Am||e instanceof ym||e instanceof xm||e instanceof Em?e.toString():JSON.stringify(e)}class Tm{constructor(e,t){this.type=e,this.value=t}static parse(e,t){if(2!==e.length)return t.error(`'literal' expression requires exactly one argument, but found ${e.length-1} instead.`);if(!Mm(e[1]))return t.error("invalid value");const n=e[1];let i=Sm(n);const r=t.expectedType;return"array"!==i.kind||0!==i.N||!r||"array"!==r.kind||"number"==typeof r.N&&0!==r.N||(i=r),new Tm(i,n)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}}const Im={string:Tf,number:Cf,boolean:If,object:Lf};class Rm{constructor(e,t){this.type=e,this.args=t}static parse(e,t){if(e.length<2)return t.error("Expected at least one argument.");let n,i=1;const r=e[0];if("array"===r){let r,s;if(e.length>2){const n=e[1];if("string"!=typeof n||!(n in Im)||"object"===n)return t.error('The item type argument of "array" must be one of string, number, boolean',1);r=Im[n],i++}else r=Pf;if(e.length>3){if(null!==e[2]&&("number"!=typeof e[2]||e[2]<0||e[2]!==Math.floor(e[2])))return t.error('The length argument to "array" must be a positive integer literal',2);s=e[2],i++}n=kf(r,s)}else{if(!Im[r])throw new Error(`Types doesn't contain name = ${r}`);n=Im[r]}const s=[];for(;i<e.length;i++){const n=t.parse(e[i],i,Pf);if(!n)return null;s.push(n)}return new Rm(n,s)}evaluate(e){for(let t=0;t<this.args.length;t++){const n=this.args[t].evaluate(e);if(!Gf(this.type,Sm(n)))return n;if(t===this.args.length-1)throw new vm(`Expected value to be of type ${Qf(this.type)}, but found ${Qf(Sm(n))} instead.`)}throw new Error}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every((e=>e.outputDefined()))}}const Bm={"to-boolean":If,"to-color":Rf,"to-number":Cf,"to-string":Tf};class Lm{constructor(e,t){this.type=e,this.args=t}static parse(e,t){if(e.length<2)return t.error("Expected at least one argument.");const n=e[0];if(!Bm[n])throw new Error(`Can't parse ${n} as it is not part of the known types`);if(("to-boolean"===n||"to-string"===n)&&2!==e.length)return t.error("Expected one argument.");const i=Bm[n],r=[];for(let n=1;n<e.length;n++){const i=t.parse(e[n],n,Pf);if(!i)return null;r.push(i)}return new Lm(i,r)}evaluate(e){switch(this.type.kind){case"boolean":return Boolean(this.args[0].evaluate(e));case"color":{let t,n;for(const i of this.args){if(t=i.evaluate(e),n=null,t instanceof fm)return t;if("string"==typeof t){const n=e.parseColor(t);if(n)return n}else if(Array.isArray(t)&&(n=t.length<3||t.length>4?`Invalid rgba value ${JSON.stringify(t)}: expected an array containing either three or four numeric values.`:wm(t[0],t[1],t[2],t[3]),!n))return new fm(t[0]/255,t[1]/255,t[2]/255,t[3])}throw new vm(n||`Could not parse color from value '${"string"==typeof t?t:JSON.stringify(t)}'`)}case"padding":{let t;for(const n of this.args){t=n.evaluate(e);const i=ym.parse(t);if(i)return i}throw new vm(`Could not parse padding from value '${"string"==typeof t?t:JSON.stringify(t)}'`)}case"variableAnchorOffsetCollection":{let t;for(const n of this.args){t=n.evaluate(e);const i=xm.parse(t);if(i)return i}throw new vm(`Could not parse variableAnchorOffsetCollection from value '${"string"==typeof t?t:JSON.stringify(t)}'`)}case"number":{let t=null;for(const n of this.args){if(t=n.evaluate(e),null===t)return 0;const i=Number(t);if(!isNaN(i))return i}throw new vm(`Could not convert ${JSON.stringify(t)} to number.`)}case"formatted":return Am.fromString(Cm(this.args[0].evaluate(e)));case"resolvedImage":return Em.fromString(Cm(this.args[0].evaluate(e)));case"projectionDefinition":return this.args[0].evaluate(e);default:return Cm(this.args[0].evaluate(e))}}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every((e=>e.outputDefined()))}}function Pm(e){let t=0;for(let n,i,r=0,s=e.length,a=s-1;r<s;a=r++)n=e[r],i=e[a],t+=(i.x-n.x)*(n.y+i.y);return t}const Dm=["Unknown","Point","LineString","Polygon"],Nm={Unknown:"Unknown",Point:"Point",MultiPoint:"Point",LineString:"LineString",MultiLineString:"LineString",Polygon:"Polygon",MultiPolygon:"Polygon"};class Um{constructor(){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null}id(){return this.feature&&"id"in this.feature?this.feature.id:null}geometryDollarType(){return this.feature?"number"==typeof this.feature.type?Dm[this.feature.type]:Nm[this.feature.type]:null}geometryType(){let e=this.feature.type;if("number"!=typeof e)return e;if(e=Dm[this.feature.type],"Unknown"===e)return e;const t=this.geometry();return 1===t.length?e:"Polygon"!==e?`Multi${e}`:function(e){const t=e.length;for(let n,i=0;i<t;i++){const t=Pm(e[i]);if(0!==t)if(void 0===n)n=t<0;else if(n===t<0)return!0}return!1}(t)?"MultiPolygon":"Polygon"}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}parseColor(e){let t=this._parseColorCache[e];return t||(t=this._parseColorCache[e]=fm.parse(e)),t}}class Om{constructor(e,t,n=[],i,r=new Mf,s=[]){this.registry=e,this.path=n,this.key=n.map((e=>`[${e}]`)).join(""),this.scope=r,this.errors=s,this.expectedType=i,this._isConstant=t}parse(e,t,n,i,r={}){return t?this.concat(t,n,i)._parse(e,r):this._parse(e,r)}_parse(e,t){function n(e,t,n){return"assert"===n?new Rm(t,[e]):"coerce"===n?new Lm(t,[e]):e}if(null!==e&&"string"!=typeof e&&"boolean"!=typeof e&&"number"!=typeof e||(e=["literal",e]),Array.isArray(e)){if(0===e.length)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const i=e[0];if("string"!=typeof i)return this.error(`Expression name must be a string, but found ${typeof i} instead. If you wanted a literal array, use ["literal", [...]].`,0),null;const r=this.registry[i];if(r){let i=r.parse(e,this);if(!i)return null;if(this.expectedType){const e=this.expectedType,r=i.type;if("string"!==e.kind&&"number"!==e.kind&&"boolean"!==e.kind&&"object"!==e.kind&&"array"!==e.kind||"value"!==r.kind)if("projectionDefinition"!==e.kind||"string"!==r.kind&&"array"!==r.kind)if("color"!==e.kind&&"formatted"!==e.kind&&"resolvedImage"!==e.kind||"value"!==r.kind&&"string"!==r.kind)if("padding"!==e.kind||"value"!==r.kind&&"number"!==r.kind&&"array"!==r.kind)if("variableAnchorOffsetCollection"!==e.kind||"value"!==r.kind&&"array"!==r.kind){if(this.checkSubtype(e,r))return null}else i=n(i,e,t.typeAnnotation||"coerce");else i=n(i,e,t.typeAnnotation||"coerce");else i=n(i,e,t.typeAnnotation||"coerce");else i=n(i,e,t.typeAnnotation||"coerce");else i=n(i,e,t.typeAnnotation||"assert")}if(!(i instanceof Tm)&&"resolvedImage"!==i.type.kind&&this._isConstant(i)){const e=new Um;try{i=new Tm(i.type,i.evaluate(e))}catch(e){return this.error(e.message),null}}return i}return this.error(`Unknown expression "${i}". If you wanted a literal array, use ["literal", [...]].`,0)}return void 0===e?this.error("'undefined' value invalid. Use null instead."):"object"==typeof e?this.error('Bare objects invalid. Use ["literal", {...}] instead.'):this.error(`Expected an array, but found ${typeof e} instead.`)}concat(e,t,n){const i="number"==typeof e?this.path.concat(e):this.path,r=n?this.scope.concat(n):this.scope;return new Om(this.registry,this._isConstant,i,t||null,r,this.errors)}error(e,...t){const n=`${this.key}${t.map((e=>`[${e}]`)).join("")}`;this.errors.push(new wf(n,e))}checkSubtype(e,t){const n=Gf(e,t);return n&&this.error(n),n}}class Fm{constructor(e,t){this.type=t.type,this.bindings=[].concat(e),this.result=t}evaluate(e){return this.result.evaluate(e)}eachChild(e){for(const t of this.bindings)e(t[1]);e(this.result)}static parse(e,t){if(e.length<4)return t.error(`Expected at least 3 arguments, but found ${e.length-1} instead.`);const n=[];for(let i=1;i<e.length-1;i+=2){const r=e[i];if("string"!=typeof r)return t.error(`Expected string, but found ${typeof r} instead.`,i);if(/[^a-zA-Z0-9_]/.test(r))return t.error("Variable names must contain only alphanumeric characters or '_'.",i);const s=t.parse(e[i+1],i+1);if(!s)return null;n.push([r,s])}const i=t.parse(e[e.length-1],e.length-1,t.expectedType,n);return i?new Fm(n,i):null}outputDefined(){return this.result.outputDefined()}}class km{constructor(e,t){this.type=t.type,this.name=e,this.boundExpression=t}static parse(e,t){if(2!==e.length||"string"!=typeof e[1])return t.error("'var' expression requires exactly one string literal argument.");const n=e[1];return t.scope.has(n)?new km(n,t.scope.get(n)):t.error(`Unknown variable "${n}". Make sure "${n}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(e){return this.boundExpression.evaluate(e)}eachChild(){}outputDefined(){return!1}}class Qm{constructor(e,t,n){this.type=e,this.index=t,this.input=n}static parse(e,t){if(3!==e.length)return t.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const n=t.parse(e[1],1,Cf),i=t.parse(e[2],2,kf(t.expectedType||Pf));if(!n||!i)return null;const r=i.type;return new Qm(r.itemType,n,i)}evaluate(e){const t=this.index.evaluate(e),n=this.input.evaluate(e);if(t<0)throw new vm(`Array index out of bounds: ${t} < 0.`);if(t>=n.length)throw new vm(`Array index out of bounds: ${t} > ${n.length-1}.`);if(t!==Math.floor(t))throw new vm(`Array index must be an integer, but found ${t} instead.`);return n[t]}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}}class zm{constructor(e,t){this.type=If,this.needle=e,this.haystack=t}static parse(e,t){if(3!==e.length)return t.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const n=t.parse(e[1],1,Pf),i=t.parse(e[2],2,Pf);return n&&i?Hf(n.type,[If,Tf,Cf,Sf,Pf])?new zm(n,i):t.error(`Expected first argument to be of type boolean, string, number or null, but found ${Qf(n.type)} instead`):null}evaluate(e){const t=this.needle.evaluate(e),n=this.haystack.evaluate(e);if(!n)return!1;if(!Vf(t,["boolean","string","number","null"]))throw new vm(`Expected first argument to be of type boolean, string, number or null, but found ${Qf(Sm(t))} instead.`);if(!Vf(n,["string","array"]))throw new vm(`Expected second argument to be of type array or string, but found ${Qf(Sm(n))} instead.`);return n.indexOf(t)>=0}eachChild(e){e(this.needle),e(this.haystack)}outputDefined(){return!0}}class Gm{constructor(e,t,n){this.type=Cf,this.needle=e,this.haystack=t,this.fromIndex=n}static parse(e,t){if(e.length<=2||e.length>=5)return t.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const n=t.parse(e[1],1,Pf),i=t.parse(e[2],2,Pf);if(!n||!i)return null;if(!Hf(n.type,[If,Tf,Cf,Sf,Pf]))return t.error(`Expected first argument to be of type boolean, string, number or null, but found ${Qf(n.type)} instead`);if(4===e.length){const r=t.parse(e[3],3,Cf);return r?new Gm(n,i,r):null}return new Gm(n,i)}evaluate(e){const t=this.needle.evaluate(e),n=this.haystack.evaluate(e);if(!Vf(t,["boolean","string","number","null"]))throw new vm(`Expected first argument to be of type boolean, string, number or null, but found ${Qf(Sm(t))} instead.`);let i;if(this.fromIndex&&(i=this.fromIndex.evaluate(e)),Vf(n,["string"])){const e=n.indexOf(t,i);return-1===e?-1:[...n.slice(0,e)].length}if(Vf(n,["array"]))return n.indexOf(t,i);throw new vm(`Expected second argument to be of type array or string, but found ${Qf(Sm(n))} instead.`)}eachChild(e){e(this.needle),e(this.haystack),this.fromIndex&&e(this.fromIndex)}outputDefined(){return!1}}class Hm{constructor(e,t,n,i,r,s){this.inputType=e,this.type=t,this.input=n,this.cases=i,this.outputs=r,this.otherwise=s}static parse(e,t){if(e.length<5)return t.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length%2!=1)return t.error("Expected an even number of arguments.");let n,i;t.expectedType&&"value"!==t.expectedType.kind&&(i=t.expectedType);const r={},s=[];for(let a=2;a<e.length-1;a+=2){let o=e[a];const l=e[a+1];Array.isArray(o)||(o=[o]);const c=t.concat(a);if(0===o.length)return c.error("Expected at least one branch label.");for(const e of o){if("number"!=typeof e&&"string"!=typeof e)return c.error("Branch labels must be numbers or strings.");if("number"==typeof e&&Math.abs(e)>Number.MAX_SAFE_INTEGER)return c.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if("number"==typeof e&&Math.floor(e)!==e)return c.error("Numeric branch labels must be integer values.");if(n){if(c.checkSubtype(n,Sm(e)))return null}else n=Sm(e);if(void 0!==r[String(e)])return c.error("Branch labels must be unique.");r[String(e)]=s.length}const h=t.parse(l,a,i);if(!h)return null;i=i||h.type,s.push(h)}const a=t.parse(e[1],1,Pf);if(!a)return null;const o=t.parse(e[e.length-1],e.length-1,i);return o?"value"!==a.type.kind&&t.concat(1).checkSubtype(n,a.type)?null:new Hm(n,i,a,r,s,o):null}evaluate(e){const t=this.input.evaluate(e);return(Sm(t)===this.inputType&&this.outputs[this.cases[t]]||this.otherwise).evaluate(e)}eachChild(e){e(this.input),this.outputs.forEach(e),e(this.otherwise)}outputDefined(){return this.outputs.every((e=>e.outputDefined()))&&this.otherwise.outputDefined()}}class Vm{constructor(e,t,n){this.type=e,this.branches=t,this.otherwise=n}static parse(e,t){if(e.length<4)return t.error(`Expected at least 3 arguments, but found only ${e.length-1}.`);if(e.length%2!=0)return t.error("Expected an odd number of arguments.");let n;t.expectedType&&"value"!==t.expectedType.kind&&(n=t.expectedType);const i=[];for(let r=1;r<e.length-1;r+=2){const s=t.parse(e[r],r,If);if(!s)return null;const a=t.parse(e[r+1],r+1,n);if(!a)return null;i.push([s,a]),n=n||a.type}const r=t.parse(e[e.length-1],e.length-1,n);if(!r)return null;if(!n)throw new Error("Can't infer output type");return new Vm(n,i,r)}evaluate(e){for(const[t,n]of this.branches)if(t.evaluate(e))return n.evaluate(e);return this.otherwise.evaluate(e)}eachChild(e){for(const[t,n]of this.branches)e(t),e(n);e(this.otherwise)}outputDefined(){return this.branches.every((([e,t])=>t.outputDefined()))&&this.otherwise.outputDefined()}}class jm{constructor(e,t,n,i){this.type=e,this.input=t,this.beginIndex=n,this.endIndex=i}static parse(e,t){if(e.length<=2||e.length>=5)return t.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const n=t.parse(e[1],1,Pf),i=t.parse(e[2],2,Cf);if(!n||!i)return null;if(!Hf(n.type,[kf(Pf),Tf,Pf]))return t.error(`Expected first argument to be of type array or string, but found ${Qf(n.type)} instead`);if(4===e.length){const r=t.parse(e[3],3,Cf);return r?new jm(n.type,n,i,r):null}return new jm(n.type,n,i)}evaluate(e){const t=this.input.evaluate(e),n=this.beginIndex.evaluate(e);let i;if(this.endIndex&&(i=this.endIndex.evaluate(e)),Vf(t,["string"]))return[...t].slice(n,i).join("");if(Vf(t,["array"]))return t.slice(n,i);throw new vm(`Expected first argument to be of type array or string, but found ${Qf(Sm(t))} instead.`)}eachChild(e){e(this.input),e(this.beginIndex),this.endIndex&&e(this.endIndex)}outputDefined(){return!1}}function qm(e,t){const n=e.length-1;let i,r,s=0,a=n,o=0;for(;s<=a;)if(o=Math.floor((s+a)/2),i=e[o],r=e[o+1],i<=t){if(o===n||t<r)return o;s=o+1}else{if(!(i>t))throw new vm("Input is not a number.");a=o-1}return 0}class Wm{constructor(e,t,n){this.type=e,this.input=t,this.labels=[],this.outputs=[];for(const[e,t]of n)this.labels.push(e),this.outputs.push(t)}static parse(e,t){if(e.length-1<4)return t.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!=0)return t.error("Expected an even number of arguments.");const n=t.parse(e[1],1,Cf);if(!n)return null;const i=[];let r=null;t.expectedType&&"value"!==t.expectedType.kind&&(r=t.expectedType);for(let n=1;n<e.length;n+=2){const s=1===n?-1/0:e[n],a=e[n+1],o=n,l=n+1;if("number"!=typeof s)return t.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',o);if(i.length&&i[i.length-1][0]>=s)return t.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',o);const c=t.parse(a,l,r);if(!c)return null;r=r||c.type,i.push([s,c])}return new Wm(r,n,i)}evaluate(e){const t=this.labels,n=this.outputs;if(1===t.length)return n[0].evaluate(e);const i=this.input.evaluate(e);if(i<=t[0])return n[0].evaluate(e);const r=t.length;return i>=t[r-1]?n[r-1].evaluate(e):n[qm(t,i)].evaluate(e)}eachChild(e){e(this.input);for(const t of this.outputs)e(t)}outputDefined(){return this.outputs.every((e=>e.outputDefined()))}}function Ym(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var Xm,Km,Jm=function(){if(Km)return Xm;function e(e,t,n,i){this.cx=3*e,this.bx=3*(n-e)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*t,this.by=3*(i-t)-this.cy,this.ay=1-this.cy-this.by,this.p1x=e,this.p1y=t,this.p2x=n,this.p2y=i}return Km=1,Xm=e,e.prototype={sampleCurveX:function(e){return((this.ax*e+this.bx)*e+this.cx)*e},sampleCurveY:function(e){return((this.ay*e+this.by)*e+this.cy)*e},sampleCurveDerivativeX:function(e){return(3*this.ax*e+2*this.bx)*e+this.cx},solveCurveX:function(e,t){if(void 0===t&&(t=1e-6),e<0)return 0;if(e>1)return 1;for(var n=e,i=0;i<8;i++){var r=this.sampleCurveX(n)-e;if(Math.abs(r)<t)return n;var s=this.sampleCurveDerivativeX(n);if(Math.abs(s)<1e-6)break;n-=r/s}var a=0,o=1;for(n=e,i=0;i<20&&(r=this.sampleCurveX(n),!(Math.abs(r-e)<t));i++)e>r?a=n:o=n,n=.5*(o-a)+a;return n},solve:function(e,t){return this.sampleCurveY(this.solveCurveX(e,t))}},Xm}(),$m=Ym(Jm);class Zm{constructor(e,t,n,i,r){this.type=e,this.operator=t,this.interpolation=n,this.input=i,this.labels=[],this.outputs=[];for(const[e,t]of r)this.labels.push(e),this.outputs.push(t)}static interpolationFactor(e,t,n,i){let r=0;if("exponential"===e.name)r=eg(t,e.base,n,i);else if("linear"===e.name)r=eg(t,1,n,i);else if("cubic-bezier"===e.name){const s=e.controlPoints;r=new $m(s[0],s[1],s[2],s[3]).solve(eg(t,1,n,i))}return r}static parse(e,t){let[n,i,r,...s]=e;if(!Array.isArray(i)||0===i.length)return t.error("Expected an interpolation type expression.",1);if("linear"===i[0])i={name:"linear"};else if("exponential"===i[0]){const e=i[1];if("number"!=typeof e)return t.error("Exponential interpolation requires a numeric base.",1,1);i={name:"exponential",base:e}}else{if("cubic-bezier"!==i[0])return t.error(`Unknown interpolation type ${String(i[0])}`,1,0);{const e=i.slice(1);if(4!==e.length||e.some((e=>"number"!=typeof e||e<0||e>1)))return t.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);i={name:"cubic-bezier",controlPoints:e}}}if(e.length-1<4)return t.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!=0)return t.error("Expected an even number of arguments.");if(r=t.parse(r,2,Cf),!r)return null;const a=[];let o=null;"interpolate-hcl"===n||"interpolate-lab"===n?o=Rf:t.expectedType&&"value"!==t.expectedType.kind&&(o=t.expectedType);for(let e=0;e<s.length;e+=2){const n=s[e],i=s[e+1],r=e+3,l=e+4;if("number"!=typeof n)return t.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',r);if(a.length&&a[a.length-1][0]>=n)return t.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',r);const c=t.parse(i,l,o);if(!c)return null;o=o||c.type,a.push([n,c])}return jf(o,Cf)||jf(o,Bf)||jf(o,Rf)||jf(o,Uf)||jf(o,Ff)||jf(o,kf(Cf))?new Zm(o,n,i,r,a):t.error(`Type ${Qf(o)} is not interpolatable.`)}evaluate(e){const t=this.labels,n=this.outputs;if(1===t.length)return n[0].evaluate(e);const i=this.input.evaluate(e);if(i<=t[0])return n[0].evaluate(e);const r=t.length;if(i>=t[r-1])return n[r-1].evaluate(e);const s=qm(t,i),a=t[s],o=t[s+1],l=Zm.interpolationFactor(this.interpolation,i,a,o),c=n[s].evaluate(e),h=n[s+1].evaluate(e);switch(this.operator){case"interpolate":switch(this.type.kind){case"number":return dm(c,h,l);case"color":return fm.interpolate(c,h,l);case"padding":return ym.interpolate(c,h,l);case"variableAnchorOffsetCollection":return xm.interpolate(c,h,l);case"array":return pm(c,h,l);case"projectionDefinition":return bm.interpolate(c,h,l)}case"interpolate-hcl":return fm.interpolate(c,h,l,"hcl");case"interpolate-lab":return fm.interpolate(c,h,l,"lab")}}eachChild(e){e(this.input);for(const t of this.outputs)e(t)}outputDefined(){return this.outputs.every((e=>e.outputDefined()))}}function eg(e,t,n,i){const r=i-n,s=e-n;return 0===r?0:1===t?s/r:(Math.pow(t,s)-1)/(Math.pow(t,r)-1)}fm.interpolate,ym.interpolate,xm.interpolate;class tg{constructor(e,t){this.type=e,this.args=t}static parse(e,t){if(e.length<2)return t.error("Expected at least one argument.");let n=null;const i=t.expectedType;i&&"value"!==i.kind&&(n=i);const r=[];for(const i of e.slice(1)){const e=t.parse(i,1+r.length,n,void 0,{typeAnnotation:"omit"});if(!e)return null;n=n||e.type,r.push(e)}if(!n)throw new Error("No output type");const s=i&&r.some((e=>Gf(i,e.type)));return new tg(s?Pf:n,r)}evaluate(e){let t,n=null,i=0;for(const r of this.args)if(i++,n=r.evaluate(e),n&&n instanceof Em&&!n.available&&(t||(t=n.name),n=null,i===this.args.length&&(n=t)),null!==n)break;return n}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every((e=>e.outputDefined()))}}function ng(e,t){return"=="===e||"!="===e?"boolean"===t.kind||"string"===t.kind||"number"===t.kind||"null"===t.kind||"value"===t.kind:"string"===t.kind||"number"===t.kind||"value"===t.kind}function ig(e,t,n,i){return 0===i.compare(t,n)}function rg(e,t,n){const i="=="!==e&&"!="!==e;return class r{constructor(e,t,n){this.type=If,this.lhs=e,this.rhs=t,this.collator=n,this.hasUntypedArgument="value"===e.type.kind||"value"===t.type.kind}static parse(e,t){if(3!==e.length&&4!==e.length)return t.error("Expected two or three arguments.");const n=e[0];let s=t.parse(e[1],1,Pf);if(!s)return null;if(!ng(n,s.type))return t.concat(1).error(`"${n}" comparisons are not supported for type '${Qf(s.type)}'.`);let a=t.parse(e[2],2,Pf);if(!a)return null;if(!ng(n,a.type))return t.concat(2).error(`"${n}" comparisons are not supported for type '${Qf(a.type)}'.`);if(s.type.kind!==a.type.kind&&"value"!==s.type.kind&&"value"!==a.type.kind)return t.error(`Cannot compare types '${Qf(s.type)}' and '${Qf(a.type)}'.`);i&&("value"===s.type.kind&&"value"!==a.type.kind?s=new Rm(a.type,[s]):"value"!==s.type.kind&&"value"===a.type.kind&&(a=new Rm(s.type,[a])));let o=null;if(4===e.length){if("string"!==s.type.kind&&"string"!==a.type.kind&&"value"!==s.type.kind&&"value"!==a.type.kind)return t.error("Cannot use collator to compare non-string types.");if(o=t.parse(e[3],3,Df),!o)return null}return new r(s,a,o)}evaluate(r){const s=this.lhs.evaluate(r),a=this.rhs.evaluate(r);if(i&&this.hasUntypedArgument){const t=Sm(s),n=Sm(a);if(t.kind!==n.kind||"string"!==t.kind&&"number"!==t.kind)throw new vm(`Expected arguments for "${e}" to be (string, string) or (number, number), but found (${t.kind}, ${n.kind}) instead.`)}if(this.collator&&!i&&this.hasUntypedArgument){const e=Sm(s),n=Sm(a);if("string"!==e.kind||"string"!==n.kind)return t(r,s,a)}return this.collator?n(r,s,a,this.collator.evaluate(r)):t(r,s,a)}eachChild(e){e(this.lhs),e(this.rhs),this.collator&&e(this.collator)}outputDefined(){return!0}}}const sg=rg("==",(function(e,t,n){return t===n}),ig),ag=rg("!=",(function(e,t,n){return t!==n}),(function(e,t,n,i){return!ig(0,t,n,i)})),og=rg("<",(function(e,t,n){return t<n}),(function(e,t,n,i){return i.compare(t,n)<0})),lg=rg(">",(function(e,t,n){return t>n}),(function(e,t,n,i){return i.compare(t,n)>0})),cg=rg("<=",(function(e,t,n){return t<=n}),(function(e,t,n,i){return i.compare(t,n)<=0})),hg=rg(">=",(function(e,t,n){return t>=n}),(function(e,t,n,i){return i.compare(t,n)>=0}));class ug{constructor(e,t,n){this.type=Df,this.locale=n,this.caseSensitive=e,this.diacriticSensitive=t}static parse(e,t){if(2!==e.length)return t.error("Expected one argument.");const n=e[1];if("object"!=typeof n||Array.isArray(n))return t.error("Collator options argument must be an object.");const i=t.parse(void 0!==n["case-sensitive"]&&n["case-sensitive"],1,If);if(!i)return null;const r=t.parse(void 0!==n["diacritic-sensitive"]&&n["diacritic-sensitive"],1,If);if(!r)return null;let s=null;return n.locale&&(s=t.parse(n.locale,1,Tf),!s)?null:new ug(i,r,s)}evaluate(e){return new mm(this.caseSensitive.evaluate(e),this.diacriticSensitive.evaluate(e),this.locale?this.locale.evaluate(e):null)}eachChild(e){e(this.caseSensitive),e(this.diacriticSensitive),this.locale&&e(this.locale)}outputDefined(){return!1}}class dg{constructor(e,t,n,i,r){this.type=Tf,this.number=e,this.locale=t,this.currency=n,this.minFractionDigits=i,this.maxFractionDigits=r}static parse(e,t){if(3!==e.length)return t.error("Expected two arguments.");const n=t.parse(e[1],1,Cf);if(!n)return null;const i=e[2];if("object"!=typeof i||Array.isArray(i))return t.error("NumberFormat options argument must be an object.");let r=null;if(i.locale&&(r=t.parse(i.locale,1,Tf),!r))return null;let s=null;if(i.currency&&(s=t.parse(i.currency,1,Tf),!s))return null;let a=null;if(i["min-fraction-digits"]&&(a=t.parse(i["min-fraction-digits"],1,Cf),!a))return null;let o=null;return i["max-fraction-digits"]&&(o=t.parse(i["max-fraction-digits"],1,Cf),!o)?null:new dg(n,r,s,a,o)}evaluate(e){return new Intl.NumberFormat(this.locale?this.locale.evaluate(e):[],{style:this.currency?"currency":"decimal",currency:this.currency?this.currency.evaluate(e):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(e):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(e):void 0}).format(this.number.evaluate(e))}eachChild(e){e(this.number),this.locale&&e(this.locale),this.currency&&e(this.currency),this.minFractionDigits&&e(this.minFractionDigits),this.maxFractionDigits&&e(this.maxFractionDigits)}outputDefined(){return!1}}class pg{constructor(e){this.type=Nf,this.sections=e}static parse(e,t){if(e.length<2)return t.error("Expected at least one argument.");const n=e[1];if(!Array.isArray(n)&&"object"==typeof n)return t.error("First argument must be an image or text section.");const i=[];let r=!1;for(let n=1;n<=e.length-1;++n){const s=e[n];if(r&&"object"==typeof s&&!Array.isArray(s)){r=!1;let e=null;if(s["font-scale"]&&(e=t.parse(s["font-scale"],1,Cf),!e))return null;let n=null;if(s["text-font"]&&(n=t.parse(s["text-font"],1,kf(Tf)),!n))return null;let a=null;if(s["text-color"]&&(a=t.parse(s["text-color"],1,Rf),!a))return null;const o=i[i.length-1];o.scale=e,o.font=n,o.textColor=a}else{const s=t.parse(e[n],1,Pf);if(!s)return null;const a=s.type.kind;if("string"!==a&&"value"!==a&&"null"!==a&&"resolvedImage"!==a)return t.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");r=!0,i.push({content:s,scale:null,font:null,textColor:null})}}return new pg(i)}evaluate(e){return new Am(this.sections.map((t=>{const n=t.content.evaluate(e);return Sm(n)===Of?new gm("",n,null,null,null):new gm(Cm(n),null,t.scale?t.scale.evaluate(e):null,t.font?t.font.evaluate(e).join(","):null,t.textColor?t.textColor.evaluate(e):null)})))}eachChild(e){for(const t of this.sections)e(t.content),t.scale&&e(t.scale),t.font&&e(t.font),t.textColor&&e(t.textColor)}outputDefined(){return!1}}class fg{constructor(e){this.type=Of,this.input=e}static parse(e,t){if(2!==e.length)return t.error("Expected two arguments.");const n=t.parse(e[1],1,Tf);return n?new fg(n):t.error("No image name provided.")}evaluate(e){const t=this.input.evaluate(e),n=Em.fromString(t);return n&&e.availableImages&&(n.available=e.availableImages.indexOf(t)>-1),n}eachChild(e){e(this.input)}outputDefined(){return!1}}class mg{constructor(e){this.type=Cf,this.input=e}static parse(e,t){if(2!==e.length)return t.error(`Expected 1 argument, but found ${e.length-1} instead.`);const n=t.parse(e[1],1);return n?"array"!==n.type.kind&&"string"!==n.type.kind&&"value"!==n.type.kind?t.error(`Expected argument of type string or array, but found ${Qf(n.type)} instead.`):new mg(n):null}evaluate(e){const t=this.input.evaluate(e);if("string"==typeof t)return[...t].length;if(Array.isArray(t))return t.length;throw new vm(`Expected value to be of type string or array, but found ${Qf(Sm(t))} instead.`)}eachChild(e){e(this.input)}outputDefined(){return!1}}const gg=8192;function Ag(e,t){const n=(180+e[0])/360,i=(r=e[1],(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+r*Math.PI/360)))/360);var r;const s=Math.pow(2,t.z);return[Math.round(n*s*gg),Math.round(i*s*gg)]}function yg(e,t){const n=Math.pow(2,t.z);return[(r=(e[0]/gg+t.x)/n,360*r-180),(i=(e[1]/gg+t.y)/n,360/Math.PI*Math.atan(Math.exp((180-360*i)*Math.PI/180))-90)];var i,r}function vg(e,t){e[0]=Math.min(e[0],t[0]),e[1]=Math.min(e[1],t[1]),e[2]=Math.max(e[2],t[0]),e[3]=Math.max(e[3],t[1])}function _g(e,t){return!(e[0]<=t[0]||e[2]>=t[2]||e[1]<=t[1]||e[3]>=t[3])}function xg(e,t,n){const i=e[0]-t[0],r=e[1]-t[1],s=e[0]-n[0],a=e[1]-n[1];return i*a-s*r==0&&i*s<=0&&r*a<=0}function Eg(e,t,n,i){const r=[t[0]-e[0],t[1]-e[1]];return 0!==function(e,t){return e[0]*t[1]-e[1]*t[0]}([i[0]-n[0],i[1]-n[1]],r)&&!(!Tg(e,t,n,i)||!Tg(n,i,e,t))}function bg(e,t,n){for(const i of n)for(let n=0;n<i.length-1;++n)if(Eg(e,t,i[n],i[n+1]))return!0;return!1}function wg(e,t,n=!1){let i=!1;for(const o of t)for(let t=0;t<o.length-1;t++){if(xg(e,o[t],o[t+1]))return n;r=e,s=o[t],a=o[t+1],s[1]>r[1]!=a[1]>r[1]&&r[0]<(a[0]-s[0])*(r[1]-s[1])/(a[1]-s[1])+s[0]&&(i=!i)}var r,s,a;return i}function Mg(e,t){for(const n of t)if(wg(e,n))return!0;return!1}function Sg(e,t){for(const n of e)if(!wg(n,t))return!1;for(let n=0;n<e.length-1;++n)if(bg(e[n],e[n+1],t))return!1;return!0}function Cg(e,t){for(const n of t)if(Sg(e,n))return!0;return!1}function Tg(e,t,n,i){const r=e[0]-n[0],s=e[1]-n[1],a=t[0]-n[0],o=t[1]-n[1],l=i[0]-n[0],c=i[1]-n[1],h=r*c-l*s,u=a*c-l*o;return h>0&&u<0||h<0&&u>0}function Ig(e,t,n){const i=[];for(let r=0;r<e.length;r++){const s=[];for(let i=0;i<e[r].length;i++){const a=Ag(e[r][i],n);vg(t,a),s.push(a)}i.push(s)}return i}function Rg(e,t,n){const i=[];for(let r=0;r<e.length;r++){const s=Ig(e[r],t,n);i.push(s)}return i}function Bg(e,t,n,i){if(e[0]<n[0]||e[0]>n[2]){const t=.5*i;let r=e[0]-n[0]>t?-i:n[0]-e[0]>t?i:0;0===r&&(r=e[0]-n[2]>t?-i:n[2]-e[0]>t?i:0),e[0]+=r}vg(t,e)}function Lg(e,t,n,i){const r=Math.pow(2,i.z)*gg,s=[i.x*gg,i.y*gg],a=[];for(const i of e)for(const e of i){const i=[e.x+s[0],e.y+s[1]];Bg(i,t,n,r),a.push(i)}return a}function Pg(e,t,n,i){const r=Math.pow(2,i.z)*gg,s=[i.x*gg,i.y*gg],a=[];for(const n of e){const e=[];for(const i of n){const n=[i.x+s[0],i.y+s[1]];vg(t,n),e.push(n)}a.push(e)}if(t[2]-t[0]<=r/2){(o=t)[0]=o[1]=1/0,o[2]=o[3]=-1/0;for(const e of a)for(const i of e)Bg(i,t,n,r)}var o;return a}class Dg{constructor(e,t){this.type=If,this.geojson=e,this.geometries=t}static parse(e,t){if(2!==e.length)return t.error(`'within' expression requires exactly one argument, but found ${e.length-1} instead.`);if(Mm(e[1])){const t=e[1];if("FeatureCollection"===t.type){const e=[];for(const n of t.features){const{type:t,coordinates:i}=n.geometry;"Polygon"===t&&e.push(i),"MultiPolygon"===t&&e.push(...i)}if(e.length)return new Dg(t,{type:"MultiPolygon",coordinates:e})}else if("Feature"===t.type){const e=t.geometry.type;if("Polygon"===e||"MultiPolygon"===e)return new Dg(t,t.geometry)}else if("Polygon"===t.type||"MultiPolygon"===t.type)return new Dg(t,t)}return t.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(e){if(null!=e.geometry()&&null!=e.canonicalID()){if("Point"===e.geometryDollarType())return function(e,t){const n=[1/0,1/0,-1/0,-1/0],i=[1/0,1/0,-1/0,-1/0],r=e.canonicalID();if("Polygon"===t.type){const s=Ig(t.coordinates,i,r),a=Lg(e.geometry(),n,i,r);if(!_g(n,i))return!1;for(const e of a)if(!wg(e,s))return!1}if("MultiPolygon"===t.type){const s=Rg(t.coordinates,i,r),a=Lg(e.geometry(),n,i,r);if(!_g(n,i))return!1;for(const e of a)if(!Mg(e,s))return!1}return!0}(e,this.geometries);if("LineString"===e.geometryDollarType())return function(e,t){const n=[1/0,1/0,-1/0,-1/0],i=[1/0,1/0,-1/0,-1/0],r=e.canonicalID();if("Polygon"===t.type){const s=Ig(t.coordinates,i,r),a=Pg(e.geometry(),n,i,r);if(!_g(n,i))return!1;for(const e of a)if(!Sg(e,s))return!1}if("MultiPolygon"===t.type){const s=Rg(t.coordinates,i,r),a=Pg(e.geometry(),n,i,r);if(!_g(n,i))return!1;for(const e of a)if(!Cg(e,s))return!1}return!0}(e,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}}class Ng{constructor(e=[],t=(e,t)=>e<t?-1:e>t?1:0){if(this.data=e,this.length=this.data.length,this.compare=t,this.length>0)for(let e=(this.length>>1)-1;e>=0;e--)this._down(e)}push(e){this.data.push(e),this._up(this.length++)}pop(){if(0===this.length)return;const e=this.data[0],t=this.data.pop();return--this.length>0&&(this.data[0]=t,this._down(0)),e}peek(){return this.data[0]}_up(e){const{data:t,compare:n}=this,i=t[e];for(;e>0;){const r=e-1>>1,s=t[r];if(n(i,s)>=0)break;t[e]=s,e=r}t[e]=i}_down(e){const{data:t,compare:n}=this,i=this.length>>1,r=t[e];for(;e<i;){let i=1+(e<<1);const s=i+1;if(s<this.length&&n(t[s],t[i])<0&&(i=s),n(t[i],r)>=0)break;t[e]=t[i],e=i}t[e]=r}}const Ug=1/298.257223563,Og=Ug*(2-Ug),Fg=Math.PI/180;class kg{constructor(e){const t=6378.137*Fg*1e3,n=Math.cos(e*Fg),i=1/(1-Og*(1-n*n)),r=Math.sqrt(i);this.kx=t*r*n,this.ky=t*r*i*(1-Og)}distance(e,t){const n=this.wrap(e[0]-t[0])*this.kx,i=(e[1]-t[1])*this.ky;return Math.sqrt(n*n+i*i)}pointOnLine(e,t){let n,i,r,s,a=1/0;for(let o=0;o<e.length-1;o++){let l=e[o][0],c=e[o][1],h=this.wrap(e[o+1][0]-l)*this.kx,u=(e[o+1][1]-c)*this.ky,d=0;0===h&&0===u||(d=(this.wrap(t[0]-l)*this.kx*h+(t[1]-c)*this.ky*u)/(h*h+u*u),d>1?(l=e[o+1][0],c=e[o+1][1]):d>0&&(l+=h/this.kx*d,c+=u/this.ky*d)),h=this.wrap(t[0]-l)*this.kx,u=(t[1]-c)*this.ky;const p=h*h+u*u;p<a&&(a=p,n=l,i=c,r=o,s=d)}return{point:[n,i],index:r,t:Math.max(0,Math.min(1,s))}}wrap(e){for(;e<-180;)e+=360;for(;e>180;)e-=360;return e}}function Qg(e,t){return t[0]-e[0]}function zg(e){return e[1]-e[0]+1}function Gg(e,t){return e[1]>=e[0]&&e[1]<t}function Hg(e,t){if(e[0]>e[1])return[null,null];const n=zg(e);if(t){if(2===n)return[e,null];const t=Math.floor(n/2);return[[e[0],e[0]+t],[e[0]+t,e[1]]]}if(1===n)return[e,null];const i=Math.floor(n/2)-1;return[[e[0],e[0]+i],[e[0]+i+1,e[1]]]}function Vg(e,t){if(!Gg(t,e.length))return[1/0,1/0,-1/0,-1/0];const n=[1/0,1/0,-1/0,-1/0];for(let i=t[0];i<=t[1];++i)vg(n,e[i]);return n}function jg(e){const t=[1/0,1/0,-1/0,-1/0];for(const n of e)for(const e of n)vg(t,e);return t}function qg(e){return e[0]!==-1/0&&e[1]!==-1/0&&e[2]!==1/0&&e[3]!==1/0}function Wg(e,t,n){if(!qg(e)||!qg(t))return NaN;let i=0,r=0;return e[2]<t[0]&&(i=t[0]-e[2]),e[0]>t[2]&&(i=e[0]-t[2]),e[1]>t[3]&&(r=e[1]-t[3]),e[3]<t[1]&&(r=t[1]-e[3]),n.distance([0,0],[i,r])}function Yg(e,t,n){const i=n.pointOnLine(t,e);return n.distance(e,i.point)}function Xg(e,t,n,i,r){const s=Math.min(Yg(e,[n,i],r),Yg(t,[n,i],r)),a=Math.min(Yg(n,[e,t],r),Yg(i,[e,t],r));return Math.min(s,a)}function Kg(e,t,n,i,r){if(!Gg(t,e.length)||!Gg(i,n.length))return 1/0;let s=1/0;for(let a=t[0];a<t[1];++a){const t=e[a],o=e[a+1];for(let e=i[0];e<i[1];++e){const i=n[e],a=n[e+1];if(Eg(t,o,i,a))return 0;s=Math.min(s,Xg(t,o,i,a,r))}}return s}function Jg(e,t,n,i,r){if(!Gg(t,e.length)||!Gg(i,n.length))return NaN;let s=1/0;for(let a=t[0];a<=t[1];++a)for(let t=i[0];t<=i[1];++t)if(s=Math.min(s,r.distance(e[a],n[t])),0===s)return s;return s}function $g(e,t,n){if(wg(e,t,!0))return 0;let i=1/0;for(const r of t){const t=r[0],s=r[r.length-1];if(t!==s&&(i=Math.min(i,Yg(e,[s,t],n)),0===i))return i;const a=n.pointOnLine(r,e);if(i=Math.min(i,n.distance(e,a.point)),0===i)return i}return i}function Zg(e,t,n,i){if(!Gg(t,e.length))return NaN;for(let i=t[0];i<=t[1];++i)if(wg(e[i],n,!0))return 0;let r=1/0;for(let s=t[0];s<t[1];++s){const t=e[s],a=e[s+1];for(const e of n)for(let n=0,s=e.length,o=s-1;n<s;o=n++){const s=e[o],l=e[n];if(Eg(t,a,s,l))return 0;r=Math.min(r,Xg(t,a,s,l,i))}}return r}function eA(e,t){for(const n of e)for(const e of n)if(wg(e,t,!0))return!0;return!1}function tA(e,t,n,i=1/0){const r=jg(e),s=jg(t);if(i!==1/0&&Wg(r,s,n)>=i)return i;if(_g(r,s)){if(eA(e,t))return 0}else if(eA(t,e))return 0;let a=1/0;for(const i of e)for(let e=0,r=i.length,s=r-1;e<r;s=e++){const r=i[s],o=i[e];for(const e of t)for(let t=0,i=e.length,s=i-1;t<i;s=t++){const i=e[s],l=e[t];if(Eg(r,o,i,l))return 0;a=Math.min(a,Xg(r,o,i,l,n))}}return a}function nA(e,t,n,i,r,s){if(!s)return;const a=Wg(Vg(i,s),r,n);a<t&&e.push([a,s,[0,0]])}function iA(e,t,n,i,r,s,a){if(!s||!a)return;const o=Wg(Vg(i,s),Vg(r,a),n);o<t&&e.push([o,s,a])}function rA(e,t,n,i,r=1/0){let s=Math.min(i.distance(e[0],n[0][0]),r);if(0===s)return s;const a=new Ng([[0,[0,e.length-1],[0,0]]],Qg),o=jg(n);for(;a.length>0;){const r=a.pop();if(r[0]>=s)continue;const l=r[1],c=t?50:100;if(zg(l)<=c){if(!Gg(l,e.length))return NaN;if(t){const t=Zg(e,l,n,i);if(isNaN(t)||0===t)return t;s=Math.min(s,t)}else for(let t=l[0];t<=l[1];++t){const r=$g(e[t],n,i);if(s=Math.min(s,r),0===s)return 0}}else{const n=Hg(l,t);nA(a,s,i,e,o,n[0]),nA(a,s,i,e,o,n[1])}}return s}function sA(e,t,n,i,r,s=1/0){let a=Math.min(s,r.distance(e[0],n[0]));if(0===a)return a;const o=new Ng([[0,[0,e.length-1],[0,n.length-1]]],Qg);for(;o.length>0;){const s=o.pop();if(s[0]>=a)continue;const l=s[1],c=s[2],h=t?50:100,u=i?50:100;if(zg(l)<=h&&zg(c)<=u){if(!Gg(l,e.length)&&Gg(c,n.length))return NaN;let s;if(t&&i)s=Kg(e,l,n,c,r),a=Math.min(a,s);else if(t&&!i){const t=e.slice(l[0],l[1]+1);for(let e=c[0];e<=c[1];++e)if(s=Yg(n[e],t,r),a=Math.min(a,s),0===a)return a}else if(!t&&i){const t=n.slice(c[0],c[1]+1);for(let n=l[0];n<=l[1];++n)if(s=Yg(e[n],t,r),a=Math.min(a,s),0===a)return a}else s=Jg(e,l,n,c,r),a=Math.min(a,s)}else{const s=Hg(l,t),h=Hg(c,i);iA(o,a,r,e,n,s[0],h[0]),iA(o,a,r,e,n,s[0],h[1]),iA(o,a,r,e,n,s[1],h[0]),iA(o,a,r,e,n,s[1],h[1])}}return a}function aA(e){return"MultiPolygon"===e.type?e.coordinates.map((e=>({type:"Polygon",coordinates:e}))):"MultiLineString"===e.type?e.coordinates.map((e=>({type:"LineString",coordinates:e}))):"MultiPoint"===e.type?e.coordinates.map((e=>({type:"Point",coordinates:e}))):[e]}class oA{constructor(e,t){this.type=Cf,this.geojson=e,this.geometries=t}static parse(e,t){if(2!==e.length)return t.error(`'distance' expression requires exactly one argument, but found ${e.length-1} instead.`);if(Mm(e[1])){const t=e[1];if("FeatureCollection"===t.type)return new oA(t,t.features.map((e=>aA(e.geometry))).flat());if("Feature"===t.type)return new oA(t,aA(t.geometry));if("type"in t&&"coordinates"in t)return new oA(t,aA(t))}return t.error("'distance' expression requires valid geojson object that contains polygon geometry type.")}evaluate(e){if(null!=e.geometry()&&null!=e.canonicalID()){if("Point"===e.geometryType())return function(e,t){const n=e.geometry(),i=n.flat().map((t=>yg([t.x,t.y],e.canonical)));if(0===n.length)return NaN;const r=new kg(i[0][1]);let s=1/0;for(const e of t){switch(e.type){case"Point":s=Math.min(s,sA(i,!1,[e.coordinates],!1,r,s));break;case"LineString":s=Math.min(s,sA(i,!1,e.coordinates,!0,r,s));break;case"Polygon":s=Math.min(s,rA(i,!1,e.coordinates,r,s))}if(0===s)return s}return s}(e,this.geometries);if("LineString"===e.geometryType())return function(e,t){const n=e.geometry(),i=n.flat().map((t=>yg([t.x,t.y],e.canonical)));if(0===n.length)return NaN;const r=new kg(i[0][1]);let s=1/0;for(const e of t){switch(e.type){case"Point":s=Math.min(s,sA(i,!0,[e.coordinates],!1,r,s));break;case"LineString":s=Math.min(s,sA(i,!0,e.coordinates,!0,r,s));break;case"Polygon":s=Math.min(s,rA(i,!0,e.coordinates,r,s))}if(0===s)return s}return s}(e,this.geometries);if("Polygon"===e.geometryType())return function(e,t){const n=e.geometry();if(0===n.length||0===n[0].length)return NaN;const i=function(e){if(e.length<=1)return[e];const t=[];let n,i;for(const r of e){const e=Pm(r);0!==e&&(r.area=Math.abs(e),void 0===i&&(i=e<0),i===e<0?(n&&t.push(n),n=[r]):n.push(r))}return n&&t.push(n),t}(n).map((t=>t.map((t=>t.map((t=>yg([t.x,t.y],e.canonical))))))),r=new kg(i[0][0][0][1]);let s=1/0;for(const e of t)for(const t of i){switch(e.type){case"Point":s=Math.min(s,rA([e.coordinates],!1,t,r,s));break;case"LineString":s=Math.min(s,rA(e.coordinates,!0,t,r,s));break;case"Polygon":s=Math.min(s,tA(t,e.coordinates,r,s))}if(0===s)return s}return s}(e,this.geometries)}return NaN}eachChild(){}outputDefined(){return!0}}const lA={"==":sg,"!=":ag,">":lg,"<":og,">=":hg,"<=":cg,array:Rm,at:Qm,boolean:Rm,case:Vm,coalesce:tg,collator:ug,format:pg,image:fg,in:zm,"index-of":Gm,interpolate:Zm,"interpolate-hcl":Zm,"interpolate-lab":Zm,length:mg,let:Fm,literal:Tm,match:Hm,number:Rm,"number-format":dg,object:Rm,slice:jm,step:Wm,string:Rm,"to-boolean":Lm,"to-color":Lm,"to-number":Lm,"to-string":Lm,var:km,within:Dg,distance:oA};class cA{constructor(e,t,n,i){this.name=e,this.type=t,this._evaluate=n,this.args=i}evaluate(e){return this._evaluate(e,this.args)}eachChild(e){this.args.forEach(e)}outputDefined(){return!1}static parse(e,t){const n=e[0],i=cA.definitions[n];if(!i)return t.error(`Unknown expression "${n}". If you wanted a literal array, use ["literal", [...]].`,0);const r=Array.isArray(i)?i[0]:i.type,s=Array.isArray(i)?[[i[1],i[2]]]:i.overloads,a=s.filter((([t])=>!Array.isArray(t)||t.length===e.length-1));let o=null;for(const[i,s]of a){o=new Om(t.registry,fA,t.path,null,t.scope);const a=[];let l=!1;for(let t=1;t<e.length;t++){const n=e[t],r=Array.isArray(i)?i[t-1]:i.type,s=o.parse(n,1+a.length,r);if(!s){l=!0;break}a.push(s)}if(!l)if(Array.isArray(i)&&i.length!==a.length)o.error(`Expected ${i.length} arguments, but found ${a.length} instead.`);else{for(let e=0;e<a.length;e++){const t=Array.isArray(i)?i[e]:i.type,n=a[e];o.concat(e+1).checkSubtype(t,n.type)}if(0===o.errors.length)return new cA(n,r,s,a)}}if(1===a.length)t.errors.push(...o.errors);else{const n=(a.length?a:s).map((([e])=>{return t=e,Array.isArray(t)?`(${t.map(Qf).join(", ")})`:`(${Qf(t.type)}...)`;var t})).join(" | "),i=[];for(let n=1;n<e.length;n++){const r=t.parse(e[n],1+i.length);if(!r)return null;i.push(Qf(r.type))}t.error(`Expected arguments of type ${n}, but found (${i.join(", ")}) instead.`)}return null}static register(e,t){cA.definitions=t;for(const n in t)e[n]=cA}}function hA(e,[t,n,i,r]){t=t.evaluate(e),n=n.evaluate(e),i=i.evaluate(e);const s=r?r.evaluate(e):1,a=wm(t,n,i,s);if(a)throw new vm(a);return new fm(t/255,n/255,i/255,s,!1)}function uA(e,t){return e in t}function dA(e,t){const n=t[e];return void 0===n?null:n}function pA(e){return{type:e}}function fA(e){if(e instanceof km)return fA(e.boundExpression);if(e instanceof cA&&"error"===e.name)return!1;if(e instanceof ug)return!1;if(e instanceof Dg)return!1;if(e instanceof oA)return!1;const t=e instanceof Lm||e instanceof Rm;let n=!0;return e.eachChild((e=>{n=t?n&&fA(e):n&&e instanceof Tm})),!!n&&mA(e)&&AA(e,["zoom","heatmap-density","line-progress","accumulated","is-supported-script"])}function mA(e){if(e instanceof cA){if("get"===e.name&&1===e.args.length)return!1;if("feature-state"===e.name)return!1;if("has"===e.name&&1===e.args.length)return!1;if("properties"===e.name||"geometry-type"===e.name||"id"===e.name)return!1;if(/^filter-/.test(e.name))return!1}if(e instanceof Dg)return!1;if(e instanceof oA)return!1;let t=!0;return e.eachChild((e=>{t&&!mA(e)&&(t=!1)})),t}function gA(e){if(e instanceof cA&&"feature-state"===e.name)return!1;let t=!0;return e.eachChild((e=>{t&&!gA(e)&&(t=!1)})),t}function AA(e,t){if(e instanceof cA&&t.indexOf(e.name)>=0)return!1;let n=!0;return e.eachChild((e=>{n&&!AA(e,t)&&(n=!1)})),n}function yA(e){return{result:"success",value:e}}function vA(e){return{result:"error",value:e}}function _A(e){return"data-driven"===e["property-type"]||"cross-faded-data-driven"===e["property-type"]}function xA(e){return!!e.expression&&e.expression.parameters.indexOf("zoom")>-1}function EA(e){return!!e.expression&&e.expression.interpolated}function bA(e){return e instanceof Number?"number":e instanceof String?"string":e instanceof Boolean?"boolean":Array.isArray(e)?"array":null===e?"null":typeof e}function wA(e){return"object"==typeof e&&null!==e&&!Array.isArray(e)}cA.register(lA,{error:[{kind:"error"},[Tf],(e,[t])=>{throw new vm(t.evaluate(e))}],typeof:[Tf,[Pf],(e,[t])=>Qf(Sm(t.evaluate(e)))],"to-rgba":[kf(Cf,4),[Rf],(e,[t])=>{const[n,i,r,s]=t.evaluate(e).rgb;return[255*n,255*i,255*r,s]}],rgb:[Rf,[Cf,Cf,Cf],hA],rgba:[Rf,[Cf,Cf,Cf,Cf],hA],has:{type:If,overloads:[[[Tf],(e,[t])=>uA(t.evaluate(e),e.properties())],[[Tf,Lf],(e,[t,n])=>uA(t.evaluate(e),n.evaluate(e))]]},get:{type:Pf,overloads:[[[Tf],(e,[t])=>dA(t.evaluate(e),e.properties())],[[Tf,Lf],(e,[t,n])=>dA(t.evaluate(e),n.evaluate(e))]]},"feature-state":[Pf,[Tf],(e,[t])=>dA(t.evaluate(e),e.featureState||{})],properties:[Lf,[],e=>e.properties()],"geometry-type":[Tf,[],e=>e.geometryType()],id:[Pf,[],e=>e.id()],zoom:[Cf,[],e=>e.globals.zoom],"heatmap-density":[Cf,[],e=>e.globals.heatmapDensity||0],"line-progress":[Cf,[],e=>e.globals.lineProgress||0],accumulated:[Pf,[],e=>void 0===e.globals.accumulated?null:e.globals.accumulated],"+":[Cf,pA(Cf),(e,t)=>{let n=0;for(const i of t)n+=i.evaluate(e);return n}],"*":[Cf,pA(Cf),(e,t)=>{let n=1;for(const i of t)n*=i.evaluate(e);return n}],"-":{type:Cf,overloads:[[[Cf,Cf],(e,[t,n])=>t.evaluate(e)-n.evaluate(e)],[[Cf],(e,[t])=>-t.evaluate(e)]]},"/":[Cf,[Cf,Cf],(e,[t,n])=>t.evaluate(e)/n.evaluate(e)],"%":[Cf,[Cf,Cf],(e,[t,n])=>t.evaluate(e)%n.evaluate(e)],ln2:[Cf,[],()=>Math.LN2],pi:[Cf,[],()=>Math.PI],e:[Cf,[],()=>Math.E],"^":[Cf,[Cf,Cf],(e,[t,n])=>Math.pow(t.evaluate(e),n.evaluate(e))],sqrt:[Cf,[Cf],(e,[t])=>Math.sqrt(t.evaluate(e))],log10:[Cf,[Cf],(e,[t])=>Math.log(t.evaluate(e))/Math.LN10],ln:[Cf,[Cf],(e,[t])=>Math.log(t.evaluate(e))],log2:[Cf,[Cf],(e,[t])=>Math.log(t.evaluate(e))/Math.LN2],sin:[Cf,[Cf],(e,[t])=>Math.sin(t.evaluate(e))],cos:[Cf,[Cf],(e,[t])=>Math.cos(t.evaluate(e))],tan:[Cf,[Cf],(e,[t])=>Math.tan(t.evaluate(e))],asin:[Cf,[Cf],(e,[t])=>Math.asin(t.evaluate(e))],acos:[Cf,[Cf],(e,[t])=>Math.acos(t.evaluate(e))],atan:[Cf,[Cf],(e,[t])=>Math.atan(t.evaluate(e))],min:[Cf,pA(Cf),(e,t)=>Math.min(...t.map((t=>t.evaluate(e))))],max:[Cf,pA(Cf),(e,t)=>Math.max(...t.map((t=>t.evaluate(e))))],abs:[Cf,[Cf],(e,[t])=>Math.abs(t.evaluate(e))],round:[Cf,[Cf],(e,[t])=>{const n=t.evaluate(e);return n<0?-Math.round(-n):Math.round(n)}],floor:[Cf,[Cf],(e,[t])=>Math.floor(t.evaluate(e))],ceil:[Cf,[Cf],(e,[t])=>Math.ceil(t.evaluate(e))],"filter-==":[If,[Tf,Pf],(e,[t,n])=>e.properties()[t.value]===n.value],"filter-id-==":[If,[Pf],(e,[t])=>e.id()===t.value],"filter-type-==":[If,[Tf],(e,[t])=>e.geometryDollarType()===t.value],"filter-<":[If,[Tf,Pf],(e,[t,n])=>{const i=e.properties()[t.value],r=n.value;return typeof i==typeof r&&i<r}],"filter-id-<":[If,[Pf],(e,[t])=>{const n=e.id(),i=t.value;return typeof n==typeof i&&n<i}],"filter->":[If,[Tf,Pf],(e,[t,n])=>{const i=e.properties()[t.value],r=n.value;return typeof i==typeof r&&i>r}],"filter-id->":[If,[Pf],(e,[t])=>{const n=e.id(),i=t.value;return typeof n==typeof i&&n>i}],"filter-<=":[If,[Tf,Pf],(e,[t,n])=>{const i=e.properties()[t.value],r=n.value;return typeof i==typeof r&&i<=r}],"filter-id-<=":[If,[Pf],(e,[t])=>{const n=e.id(),i=t.value;return typeof n==typeof i&&n<=i}],"filter->=":[If,[Tf,Pf],(e,[t,n])=>{const i=e.properties()[t.value],r=n.value;return typeof i==typeof r&&i>=r}],"filter-id->=":[If,[Pf],(e,[t])=>{const n=e.id(),i=t.value;return typeof n==typeof i&&n>=i}],"filter-has":[If,[Pf],(e,[t])=>t.value in e.properties()],"filter-has-id":[If,[],e=>null!==e.id()&&void 0!==e.id()],"filter-type-in":[If,[kf(Tf)],(e,[t])=>t.value.indexOf(e.geometryDollarType())>=0],"filter-id-in":[If,[kf(Pf)],(e,[t])=>t.value.indexOf(e.id())>=0],"filter-in-small":[If,[Tf,kf(Pf)],(e,[t,n])=>n.value.indexOf(e.properties()[t.value])>=0],"filter-in-large":[If,[Tf,kf(Pf)],(e,[t,n])=>function(e,t,n,i){for(;n<=i;){const r=n+i>>1;if(t[r]===e)return!0;t[r]>e?i=r-1:n=r+1}return!1}(e.properties()[t.value],n.value,0,n.value.length-1)],all:{type:If,overloads:[[[If,If],(e,[t,n])=>t.evaluate(e)&&n.evaluate(e)],[pA(If),(e,t)=>{for(const n of t)if(!n.evaluate(e))return!1;return!0}]]},any:{type:If,overloads:[[[If,If],(e,[t,n])=>t.evaluate(e)||n.evaluate(e)],[pA(If),(e,t)=>{for(const n of t)if(n.evaluate(e))return!0;return!1}]]},"!":[If,[If],(e,[t])=>!t.evaluate(e)],"is-supported-script":[If,[Tf],(e,[t])=>{const n=e.globals&&e.globals.isSupportedScript;return!n||n(t.evaluate(e))}],upcase:[Tf,[Tf],(e,[t])=>t.evaluate(e).toUpperCase()],downcase:[Tf,[Tf],(e,[t])=>t.evaluate(e).toLowerCase()],concat:[Tf,pA(Pf),(e,t)=>t.map((t=>Cm(t.evaluate(e)))).join("")],"resolved-locale":[Tf,[Df],(e,[t])=>t.evaluate(e).resolvedLocale()]});class MA{constructor(e,t){var n;this.expression=e,this._warningHistory={},this._evaluator=new Um,this._defaultValue=t?"color"===(n=t).type&&wA(n.default)?new fm(0,0,0,0):"color"===n.type?fm.parse(n.default)||null:"padding"===n.type?ym.parse(n.default)||null:"variableAnchorOffsetCollection"===n.type?xm.parse(n.default)||null:"projectionDefinition"===n.type?bm.parse(n.default)||null:void 0===n.default?null:n.default:null,this._enumValues=t&&"enum"===t.type?t.values:null}evaluateWithoutErrorHandling(e,t,n,i,r,s){return this._evaluator.globals=e,this._evaluator.feature=t,this._evaluator.featureState=n,this._evaluator.canonical=i,this._evaluator.availableImages=r||null,this._evaluator.formattedSection=s,this.expression.evaluate(this._evaluator)}evaluate(e,t,n,i,r,s){this._evaluator.globals=e,this._evaluator.feature=t||null,this._evaluator.featureState=n||null,this._evaluator.canonical=i,this._evaluator.availableImages=r||null,this._evaluator.formattedSection=s||null;try{const e=this.expression.evaluate(this._evaluator);if(null==e||"number"==typeof e&&e!=e)return this._defaultValue;if(this._enumValues&&!(e in this._enumValues))throw new vm(`Expected value to be one of ${Object.keys(this._enumValues).map((e=>JSON.stringify(e))).join(", ")}, but found ${JSON.stringify(e)} instead.`);return e}catch(e){return this._warningHistory[e.message]||(this._warningHistory[e.message]=!0,"undefined"!=typeof console&&console.warn(e.message)),this._defaultValue}}}function SA(e){return Array.isArray(e)&&e.length>0&&"string"==typeof e[0]&&e[0]in lA}function CA(e,t){const n=new Om(lA,fA,[],t?function(e){const t={color:Rf,string:Tf,number:Cf,enum:Tf,boolean:If,formatted:Nf,padding:Uf,projectionDefinition:Bf,resolvedImage:Of,variableAnchorOffsetCollection:Ff};return"array"===e.type?kf(t[e.value]||Pf,e.length):t[e.type]}(t):void 0),i=n.parse(e,void 0,void 0,void 0,t&&"string"===t.type?{typeAnnotation:"coerce"}:void 0);return i?yA(new MA(i,t)):vA(n.errors)}class TA{constructor(e,t){this.kind=e,this._styleExpression=t,this.isStateDependent="constant"!==e&&!gA(t.expression)}evaluateWithoutErrorHandling(e,t,n,i,r,s){return this._styleExpression.evaluateWithoutErrorHandling(e,t,n,i,r,s)}evaluate(e,t,n,i,r,s){return this._styleExpression.evaluate(e,t,n,i,r,s)}}class IA{constructor(e,t,n,i){this.kind=e,this.zoomStops=n,this._styleExpression=t,this.isStateDependent="camera"!==e&&!gA(t.expression),this.interpolationType=i}evaluateWithoutErrorHandling(e,t,n,i,r,s){return this._styleExpression.evaluateWithoutErrorHandling(e,t,n,i,r,s)}evaluate(e,t,n,i,r,s){return this._styleExpression.evaluate(e,t,n,i,r,s)}interpolationFactor(e,t,n){return this.interpolationType?Zm.interpolationFactor(this.interpolationType,e,t,n):0}}function RA(e,t){const n=CA(e,t);if("error"===n.result)return n;const i=n.value.expression,r=mA(i);if(!r&&!_A(t))return vA([new wf("","data expressions not supported")]);const s=AA(i,["zoom"]);if(!s&&!xA(t))return vA([new wf("","zoom expressions not supported")]);const a=BA(i);if(!a&&!s)return vA([new wf("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.')]);if(a instanceof wf)return vA([a]);if(a instanceof Zm&&!EA(t))return vA([new wf("",'"interpolate" expressions cannot be used with this property')]);if(!a)return yA(new TA(r?"constant":"source",n.value));const o=a instanceof Zm?a.interpolation:void 0;return yA(new IA(r?"camera":"composite",n.value,a.labels,o))}function BA(e){let t=null;if(e instanceof Fm)t=BA(e.result);else if(e instanceof tg){for(const n of e.args)if(t=BA(n),t)break}else(e instanceof Wm||e instanceof Zm)&&e.input instanceof cA&&"zoom"===e.input.name&&(t=e);return t instanceof wf||e.eachChild((e=>{const n=BA(e);n instanceof wf?t=n:!t&&n?t=new wf("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.'):t&&n&&t!==n&&(t=new wf("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))})),t}function LA(e){if(!0===e||!1===e)return!0;if(!Array.isArray(e)||0===e.length)return!1;switch(e[0]){case"has":return e.length>=2&&"$id"!==e[1]&&"$type"!==e[1];case"in":return e.length>=3&&("string"!=typeof e[1]||Array.isArray(e[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return 3!==e.length||Array.isArray(e[1])||Array.isArray(e[2]);case"any":case"all":for(const t of e.slice(1))if(!LA(t)&&"boolean"!=typeof t)return!1;return!0;default:return!0}}function PA(e){const t=e.key,n=e.value;return n?[new Ef(t,n,"constants have been deprecated as of v8")]:[]}function DA(e){return e instanceof Number||e instanceof String||e instanceof Boolean?e.valueOf():e}function NA(e){if(Array.isArray(e))return e.map(NA);if(e instanceof Object&&!(e instanceof Number||e instanceof String||e instanceof Boolean)){const t={};for(const n in e)t[n]=NA(e[n]);return t}return DA(e)}function UA(e){const t=e.key,n=e.value,i=e.valueSpec||{},r=e.objectElementValidators||{},s=e.style,a=e.styleSpec,o=e.validateSpec;let l=[];const c=bA(n);if("object"!==c)return[new Ef(t,n,`object expected, ${c} found`)];for(const e in n){const c=e.split(".")[0],h=i[c]||i["*"];let u;if(r[c])u=r[c];else if(i[c])u=o;else if(r["*"])u=r["*"];else{if(!i["*"]){l.push(new Ef(t,n[e],`unknown property "${e}"`));continue}u=o}l=l.concat(u({key:(t?`${t}.`:t)+e,value:n[e],valueSpec:h,style:s,styleSpec:a,object:n,objectKey:e,validateSpec:o},n))}for(const e in i)r[e]||i[e].required&&void 0===i[e].default&&void 0===n[e]&&l.push(new Ef(t,n,`missing required property "${e}"`));return l}function OA(e){const t=e.value,n=e.valueSpec,i=e.validateSpec,r=e.style,s=e.styleSpec,a=e.key,o=e.arrayElementValidator||i;if("array"!==bA(t))return[new Ef(a,t,`array expected, ${bA(t)} found`)];if(n.length&&t.length!==n.length)return[new Ef(a,t,`array length ${n.length} expected, length ${t.length} found`)];if(n["min-length"]&&t.length<n["min-length"])return[new Ef(a,t,`array length at least ${n["min-length"]} expected, length ${t.length} found`)];let l={type:n.value,values:n.values};s.$version<7&&(l.function=n.function),"object"===bA(n.value)&&(l=n.value);let c=[];for(let n=0;n<t.length;n++)c=c.concat(o({array:t,arrayIndex:n,value:t[n],valueSpec:l,validateSpec:e.validateSpec,style:r,styleSpec:s,key:`${a}[${n}]`}));return c}function FA(e){const t=e.key,n=e.value,i=e.valueSpec;let r=bA(n);return"number"===r&&n!=n&&(r="NaN"),"number"!==r?[new Ef(t,n,`number expected, ${r} found`)]:"minimum"in i&&n<i.minimum?[new Ef(t,n,`${n} is less than the minimum value ${i.minimum}`)]:"maximum"in i&&n>i.maximum?[new Ef(t,n,`${n} is greater than the maximum value ${i.maximum}`)]:[]}function kA(e){const t=e.valueSpec,n=DA(e.value.type);let i,r,s,a={};const o="categorical"!==n&&void 0===e.value.property,l=!o,c="array"===bA(e.value.stops)&&"array"===bA(e.value.stops[0])&&"object"===bA(e.value.stops[0][0]),h=UA({key:e.key,value:e.value,valueSpec:e.styleSpec.function,validateSpec:e.validateSpec,style:e.style,styleSpec:e.styleSpec,objectElementValidators:{stops:function(e){if("identity"===n)return[new Ef(e.key,e.value,'identity function may not have a "stops" property')];let t=[];const i=e.value;return t=t.concat(OA({key:e.key,value:i,valueSpec:e.valueSpec,validateSpec:e.validateSpec,style:e.style,styleSpec:e.styleSpec,arrayElementValidator:u})),"array"===bA(i)&&0===i.length&&t.push(new Ef(e.key,i,"array must have at least one stop")),t},default:function(e){return e.validateSpec({key:e.key,value:e.value,valueSpec:t,validateSpec:e.validateSpec,style:e.style,styleSpec:e.styleSpec})}}});return"identity"===n&&o&&h.push(new Ef(e.key,e.value,'missing required property "property"')),"identity"===n||e.value.stops||h.push(new Ef(e.key,e.value,'missing required property "stops"')),"exponential"===n&&e.valueSpec.expression&&!EA(e.valueSpec)&&h.push(new Ef(e.key,e.value,"exponential functions not supported")),e.styleSpec.$version>=8&&(l&&!_A(e.valueSpec)?h.push(new Ef(e.key,e.value,"property functions not supported")):o&&!xA(e.valueSpec)&&h.push(new Ef(e.key,e.value,"zoom functions not supported"))),"categorical"!==n&&!c||void 0!==e.value.property||h.push(new Ef(e.key,e.value,'"property" property is required')),h;function u(e){let n=[];const i=e.value,o=e.key;if("array"!==bA(i))return[new Ef(o,i,`array expected, ${bA(i)} found`)];if(2!==i.length)return[new Ef(o,i,`array length 2 expected, length ${i.length} found`)];if(c){if("object"!==bA(i[0]))return[new Ef(o,i,`object expected, ${bA(i[0])} found`)];if(void 0===i[0].zoom)return[new Ef(o,i,"object stop key must have zoom")];if(void 0===i[0].value)return[new Ef(o,i,"object stop key must have value")];if(s&&s>DA(i[0].zoom))return[new Ef(o,i[0].zoom,"stop zoom values must appear in ascending order")];DA(i[0].zoom)!==s&&(s=DA(i[0].zoom),r=void 0,a={}),n=n.concat(UA({key:`${o}[0]`,value:i[0],valueSpec:{zoom:{}},validateSpec:e.validateSpec,style:e.style,styleSpec:e.styleSpec,objectElementValidators:{zoom:FA,value:d}}))}else n=n.concat(d({key:`${o}[0]`,value:i[0],valueSpec:{},validateSpec:e.validateSpec,style:e.style,styleSpec:e.styleSpec},i));return SA(NA(i[1]))?n.concat([new Ef(`${o}[1]`,i[1],"expressions are not allowed in function stops.")]):n.concat(e.validateSpec({key:`${o}[1]`,value:i[1],valueSpec:t,validateSpec:e.validateSpec,style:e.style,styleSpec:e.styleSpec}))}function d(e,s){const o=bA(e.value),l=DA(e.value),c=null!==e.value?e.value:s;if(i){if(o!==i)return[new Ef(e.key,c,`${o} stop domain type must match previous stop domain type ${i}`)]}else i=o;if("number"!==o&&"string"!==o&&"boolean"!==o)return[new Ef(e.key,c,"stop domain value must be a number, string, or boolean")];if("number"!==o&&"categorical"!==n){let i=`number expected, ${o} found`;return _A(t)&&void 0===n&&(i+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new Ef(e.key,c,i)]}return"categorical"!==n||"number"!==o||isFinite(l)&&Math.floor(l)===l?"categorical"!==n&&"number"===o&&void 0!==r&&l<r?[new Ef(e.key,c,"stop domain values must appear in ascending order")]:(r=l,"categorical"===n&&l in a?[new Ef(e.key,c,"stop domain values must be unique")]:(a[l]=!0,[])):[new Ef(e.key,c,`integer expected, found ${l}`)]}}function QA(e){const t=("property"===e.expressionContext?RA:CA)(NA(e.value),e.valueSpec);if("error"===t.result)return t.value.map((t=>new Ef(`${e.key}${t.key}`,e.value,t.message)));const n=t.value.expression||t.value._styleExpression.expression;if("property"===e.expressionContext&&"text-font"===e.propertyKey&&!n.outputDefined())return[new Ef(e.key,e.value,`Invalid data expression for "${e.propertyKey}". Output values must be contained as literals within the expression.`)];if("property"===e.expressionContext&&"layout"===e.propertyType&&!gA(n))return[new Ef(e.key,e.value,'"feature-state" data expressions are not supported with layout properties.')];if("filter"===e.expressionContext&&!gA(n))return[new Ef(e.key,e.value,'"feature-state" data expressions are not supported with filters.')];if(e.expressionContext&&0===e.expressionContext.indexOf("cluster")){if(!AA(n,["zoom","feature-state"]))return[new Ef(e.key,e.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if("cluster-initial"===e.expressionContext&&!mA(n))return[new Ef(e.key,e.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function zA(e){const t=e.key,n=e.value,i=e.valueSpec,r=[];return Array.isArray(i.values)?-1===i.values.indexOf(DA(n))&&r.push(new Ef(t,n,`expected one of [${i.values.join(", ")}], ${JSON.stringify(n)} found`)):-1===Object.keys(i.values).indexOf(DA(n))&&r.push(new Ef(t,n,`expected one of [${Object.keys(i.values).join(", ")}], ${JSON.stringify(n)} found`)),r}function GA(e){return LA(NA(e.value))?QA(bf({},e,{expressionContext:"filter",valueSpec:{value:"boolean"}})):HA(e)}function HA(e){const t=e.value,n=e.key;if("array"!==bA(t))return[new Ef(n,t,`array expected, ${bA(t)} found`)];const i=e.styleSpec;let r,s=[];if(t.length<1)return[new Ef(n,t,"filter array must have at least 1 element")];switch(s=s.concat(zA({key:`${n}[0]`,value:t[0],valueSpec:i.filter_operator,style:e.style,styleSpec:e.styleSpec})),DA(t[0])){case"<":case"<=":case">":case">=":t.length>=2&&"$type"===DA(t[1])&&s.push(new Ef(n,t,`"$type" cannot be use with operator "${t[0]}"`));case"==":case"!=":3!==t.length&&s.push(new Ef(n,t,`filter array for operator "${t[0]}" must have 3 elements`));case"in":case"!in":t.length>=2&&(r=bA(t[1]),"string"!==r&&s.push(new Ef(`${n}[1]`,t[1],`string expected, ${r} found`)));for(let a=2;a<t.length;a++)r=bA(t[a]),"$type"===DA(t[1])?s=s.concat(zA({key:`${n}[${a}]`,value:t[a],valueSpec:i.geometry_type,style:e.style,styleSpec:e.styleSpec})):"string"!==r&&"number"!==r&&"boolean"!==r&&s.push(new Ef(`${n}[${a}]`,t[a],`string, number, or boolean expected, ${r} found`));break;case"any":case"all":case"none":for(let i=1;i<t.length;i++)s=s.concat(HA({key:`${n}[${i}]`,value:t[i],style:e.style,styleSpec:e.styleSpec}));break;case"has":case"!has":r=bA(t[1]),2!==t.length?s.push(new Ef(n,t,`filter array for "${t[0]}" operator must have 2 elements`)):"string"!==r&&s.push(new Ef(`${n}[1]`,t[1],`string expected, ${r} found`))}return s}function VA(e,t){const n=e.key,i=e.validateSpec,r=e.style,s=e.styleSpec,a=e.value,o=e.objectKey,l=s[`${t}_${e.layerType}`];if(!l)return[];const c=o.match(/^(.*)-transition$/);if("paint"===t&&c&&l[c[1]]&&l[c[1]].transition)return i({key:n,value:a,valueSpec:s.transition,style:r,styleSpec:s});const h=e.valueSpec||l[o];if(!h)return[new Ef(n,a,`unknown property "${o}"`)];let u;if("string"===bA(a)&&_A(h)&&!h.tokens&&(u=/^{([^}]+)}$/.exec(a)))return[new Ef(n,a,`"${o}" does not support interpolation syntax\nUse an identity property function instead: \`{ "type": "identity", "property": ${JSON.stringify(u[1])} }\`.`)];const d=[];return"symbol"===e.layerType&&("text-field"===o&&r&&!r.glyphs&&d.push(new Ef(n,a,'use of "text-field" requires a style "glyphs" property')),"text-font"===o&&wA(NA(a))&&"identity"===DA(a.type)&&d.push(new Ef(n,a,'"text-font" does not support identity functions'))),d.concat(i({key:e.key,value:a,valueSpec:h,style:r,styleSpec:s,expressionContext:"property",propertyType:t,propertyKey:o}))}function jA(e){return VA(e,"paint")}function qA(e){return VA(e,"layout")}function WA(e){let t=[];const n=e.value,i=e.key,r=e.style,s=e.styleSpec;n.type||n.ref||t.push(new Ef(i,n,'either "type" or "ref" is required'));let a=DA(n.type);const o=DA(n.ref);if(n.id){const s=DA(n.id);for(let a=0;a<e.arrayIndex;a++){const e=r.layers[a];DA(e.id)===s&&t.push(new Ef(i,n.id,`duplicate layer id "${n.id}", previously used at line ${e.id.__line__}`))}}if("ref"in n){let e;["type","source","source-layer","filter","layout"].forEach((e=>{e in n&&t.push(new Ef(i,n[e],`"${e}" is prohibited for ref layers`))})),r.layers.forEach((t=>{DA(t.id)===o&&(e=t)})),e?e.ref?t.push(new Ef(i,n.ref,"ref cannot reference another ref layer")):a=DA(e.type):t.push(new Ef(i,n.ref,`ref layer "${o}" not found`))}else if("background"!==a)if(n.source){const e=r.sources&&r.sources[n.source],s=e&&DA(e.type);e?"vector"===s&&"raster"===a?t.push(new Ef(i,n.source,`layer "${n.id}" requires a raster source`)):"raster-dem"!==s&&"hillshade"===a?t.push(new Ef(i,n.source,`layer "${n.id}" requires a raster-dem source`)):"raster"===s&&"raster"!==a?t.push(new Ef(i,n.source,`layer "${n.id}" requires a vector source`)):"vector"!==s||n["source-layer"]?"raster-dem"===s&&"hillshade"!==a?t.push(new Ef(i,n.source,"raster-dem source can only be used with layer type 'hillshade'.")):"line"!==a||!n.paint||!n.paint["line-gradient"]||"geojson"===s&&e.lineMetrics||t.push(new Ef(i,n,`layer "${n.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):t.push(new Ef(i,n,`layer "${n.id}" must specify a "source-layer"`)):t.push(new Ef(i,n.source,`source "${n.source}" not found`))}else t.push(new Ef(i,n,'missing required property "source"'));return t=t.concat(UA({key:i,value:n,valueSpec:s.layer,style:e.style,styleSpec:e.styleSpec,validateSpec:e.validateSpec,objectElementValidators:{"*":()=>[],type:()=>e.validateSpec({key:`${i}.type`,value:n.type,valueSpec:s.layer.type,style:e.style,styleSpec:e.styleSpec,validateSpec:e.validateSpec,object:n,objectKey:"type"}),filter:GA,layout:e=>UA({layer:n,key:e.key,value:e.value,style:e.style,styleSpec:e.styleSpec,validateSpec:e.validateSpec,objectElementValidators:{"*":e=>qA(bf({layerType:a},e))}}),paint:e=>UA({layer:n,key:e.key,value:e.value,style:e.style,styleSpec:e.styleSpec,validateSpec:e.validateSpec,objectElementValidators:{"*":e=>jA(bf({layerType:a},e))}})}})),t}function YA(e){const t=e.value,n=e.key,i=bA(t);return"string"!==i?[new Ef(n,t,`string expected, ${i} found`)]:[]}const XA={promoteId:function({key:e,value:t}){if("string"===bA(t))return YA({key:e,value:t});{const n=[];for(const i in t)n.push(...YA({key:`${e}.${i}`,value:t[i]}));return n}}};function KA(e){const t=e.value,n=e.key,i=e.styleSpec,r=e.style,s=e.validateSpec;if(!t.type)return[new Ef(n,t,'"type" is required')];const a=DA(t.type);let o;switch(a){case"vector":case"raster":return o=UA({key:n,value:t,valueSpec:i[`source_${a.replace("-","_")}`],style:e.style,styleSpec:i,objectElementValidators:XA,validateSpec:s}),o;case"raster-dem":return o=function(e){var t;const n=null!==(t=e.sourceName)&&void 0!==t?t:"",i=e.value,r=e.styleSpec,s=r.source_raster_dem,a=e.style;let o=[];const l=bA(i);if(void 0===i)return o;if("object"!==l)return o.push(new Ef("source_raster_dem",i,`object expected, ${l} found`)),o;const c="custom"===DA(i.encoding),h=["redFactor","greenFactor","blueFactor","baseShift"],u=e.value.encoding?`"${e.value.encoding}"`:"Default";for(const t in i)!c&&h.includes(t)?o.push(new Ef(t,i[t],`In "${n}": "${t}" is only valid when "encoding" is set to "custom". ${u} encoding found`)):s[t]?o=o.concat(e.validateSpec({key:t,value:i[t],valueSpec:s[t],validateSpec:e.validateSpec,style:a,styleSpec:r})):o.push(new Ef(t,i[t],`unknown property "${t}"`));return o}({sourceName:n,value:t,style:e.style,styleSpec:i,validateSpec:s}),o;case"geojson":if(o=UA({key:n,value:t,valueSpec:i.source_geojson,style:r,styleSpec:i,validateSpec:s,objectElementValidators:XA}),t.cluster)for(const e in t.clusterProperties){const[i,r]=t.clusterProperties[e],a="string"==typeof i?[i,["accumulated"],["get",e]]:i;o.push(...QA({key:`${n}.${e}.map`,value:r,validateSpec:s,expressionContext:"cluster-map"})),o.push(...QA({key:`${n}.${e}.reduce`,value:a,validateSpec:s,expressionContext:"cluster-reduce"}))}return o;case"video":return UA({key:n,value:t,valueSpec:i.source_video,style:r,validateSpec:s,styleSpec:i});case"image":return UA({key:n,value:t,valueSpec:i.source_image,style:r,validateSpec:s,styleSpec:i});case"canvas":return[new Ef(n,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return zA({key:`${n}.type`,value:t.type,valueSpec:{values:["vector","raster","raster-dem","geojson","video","image"]},style:r,validateSpec:s,styleSpec:i})}}function JA(e){const t=e.value,n=e.styleSpec,i=n.light,r=e.style;let s=[];const a=bA(t);if(void 0===t)return s;if("object"!==a)return s=s.concat([new Ef("light",t,`object expected, ${a} found`)]),s;for(const a in t){const o=a.match(/^(.*)-transition$/);s=o&&i[o[1]]&&i[o[1]].transition?s.concat(e.validateSpec({key:a,value:t[a],valueSpec:n.transition,validateSpec:e.validateSpec,style:r,styleSpec:n})):i[a]?s.concat(e.validateSpec({key:a,value:t[a],valueSpec:i[a],validateSpec:e.validateSpec,style:r,styleSpec:n})):s.concat([new Ef(a,t[a],`unknown property "${a}"`)])}return s}function $A(e){const t=e.value,n=e.styleSpec,i=n.sky,r=e.style,s=bA(t);if(void 0===t)return[];if("object"!==s)return[new Ef("sky",t,`object expected, ${s} found`)];let a=[];for(const s in t)a=i[s]?a.concat(e.validateSpec({key:s,value:t[s],valueSpec:i[s],style:r,styleSpec:n})):a.concat([new Ef(s,t[s],`unknown property "${s}"`)]);return a}function ZA(e){const t=e.value,n=e.styleSpec,i=n.terrain,r=e.style;let s=[];const a=bA(t);if(void 0===t)return s;if("object"!==a)return s=s.concat([new Ef("terrain",t,`object expected, ${a} found`)]),s;for(const a in t)s=i[a]?s.concat(e.validateSpec({key:a,value:t[a],valueSpec:i[a],validateSpec:e.validateSpec,style:r,styleSpec:n})):s.concat([new Ef(a,t[a],`unknown property "${a}"`)]);return s}function ey(e){let t=[];const n=e.value,i=e.key;if(Array.isArray(n)){const r=[],s=[];for(const a in n){n[a].id&&r.includes(n[a].id)&&t.push(new Ef(i,n,`all the sprites' ids must be unique, but ${n[a].id} is duplicated`)),r.push(n[a].id),n[a].url&&s.includes(n[a].url)&&t.push(new Ef(i,n,`all the sprites' URLs must be unique, but ${n[a].url} is duplicated`)),s.push(n[a].url);const o={id:{type:"string",required:!0},url:{type:"string",required:!0}};t=t.concat(UA({key:`${i}[${a}]`,value:n[a],valueSpec:o,validateSpec:e.validateSpec}))}return t}return YA({key:i,value:n})}const ty={"*":()=>[],array:OA,boolean:function(e){const t=e.value,n=e.key,i=bA(t);return"boolean"!==i?[new Ef(n,t,`boolean expected, ${i} found`)]:[]},number:FA,color:function(e){const t=e.key,n=e.value,i=bA(n);return"string"!==i?[new Ef(t,n,`color expected, ${i} found`)]:fm.parse(String(n))?[]:[new Ef(t,n,`color expected, "${n}" found`)]},constants:PA,enum:zA,filter:GA,function:kA,layer:WA,object:UA,source:KA,light:JA,sky:$A,terrain:ZA,projection:function(e){const t=e.value,n=e.styleSpec,i=n.projection,r=e.style,s=bA(t);if(void 0===t)return[];if("object"!==s)return[new Ef("projection",t,`object expected, ${s} found`)];let a=[];for(const s in t)a=i[s]?a.concat(e.validateSpec({key:s,value:t[s],valueSpec:i[s],style:r,styleSpec:n})):a.concat([new Ef(s,t[s],`unknown property "${s}"`)]);return a},projectionDefinition:function(e){const t=e.key;let n=e.value;n=n instanceof String?n.valueOf():n;const i=bA(n);return"array"!==i||function(e){return Array.isArray(e)&&3===e.length&&"string"==typeof e[0]&&"string"==typeof e[1]&&"number"==typeof e[2]}(n)||function(e){return!!["interpolate","step","literal"].includes(e[0])}(n)?["array","string"].includes(i)?[]:[new Ef(t,n,`projection expected, invalid type "${i}" found`)]:[new Ef(t,n,`projection expected, invalid array ${JSON.stringify(n)} found`)]},string:YA,formatted:function(e){return 0===YA(e).length?[]:QA(e)},resolvedImage:function(e){return 0===YA(e).length?[]:QA(e)},padding:function(e){const t=e.key,n=e.value;if("array"===bA(n)){if(n.length<1||n.length>4)return[new Ef(t,n,`padding requires 1 to 4 values; ${n.length} values found`)];const i={type:"number"};let r=[];for(let s=0;s<n.length;s++)r=r.concat(e.validateSpec({key:`${t}[${s}]`,value:n[s],validateSpec:e.validateSpec,valueSpec:i}));return r}return FA({key:t,value:n,valueSpec:{}})},variableAnchorOffsetCollection:function(e){const t=e.key,n=e.value,i=bA(n),r=e.styleSpec;if("array"!==i||n.length<1||n.length%2!=0)return[new Ef(t,n,"variableAnchorOffsetCollection requires a non-empty array of even length")];let s=[];for(let i=0;i<n.length;i+=2)s=s.concat(zA({key:`${t}[${i}]`,value:n[i],valueSpec:r.layout_symbol["text-anchor"]})),s=s.concat(OA({key:`${t}[${i+1}]`,value:n[i+1],valueSpec:{length:2,value:"number"},validateSpec:e.validateSpec,style:e.style,styleSpec:r}));return s},sprite:ey};function ny(e){const t=e.value,n=e.valueSpec,i=e.styleSpec;return e.validateSpec=ny,n.expression&&wA(DA(t))?kA(e):n.expression&&SA(NA(t))?QA(e):n.type&&ty[n.type]?ty[n.type](e):UA(bf({},e,{valueSpec:n.type?i[n.type]:n}))}function iy(e){const t=e.value,n=e.key,i=YA(e);return i.length||(-1===t.indexOf("{fontstack}")&&i.push(new Ef(n,t,'"glyphs" url must include a "{fontstack}" token')),-1===t.indexOf("{range}")&&i.push(new Ef(n,t,'"glyphs" url must include a "{range}" token'))),i}function ry(e,t=xf){let n=[];return n=n.concat(ny({key:"",value:e,valueSpec:t.$root,styleSpec:t,style:e,validateSpec:ny,objectElementValidators:{glyphs:iy,"*":()=>[]}})),e.constants&&(n=n.concat(PA({key:"constants",value:e.constants,style:e,styleSpec:t,validateSpec:ny}))),ay(n)}function sy(e){return function(t){return e({...t,validateSpec:ny})}}function ay(e){return[].concat(e).sort(((e,t)=>e.line-t.line))}function oy(e){return function(...t){return ay(e.apply(this,t))}}ry.source=oy(sy(KA)),ry.sprite=oy(sy(ey)),ry.glyphs=oy(sy(iy)),ry.light=oy(sy(JA)),ry.sky=oy(sy($A)),ry.terrain=oy(sy(ZA)),ry.layer=oy(sy(WA)),ry.filter=oy(sy(GA)),ry.paintProperty=oy(sy(jA)),ry.layoutProperty=oy(sy(qA));const ly=function(e,t){const n=t.type,i={};if(n===dy.POINT){const t={...void 0!==e.fill&&{color:e.fill},...void 0!==e["fill-opacity"]&&{opacity:e["fill-opacity"]},...void 0!==e.stroke&&{line:e.stroke},...void 0!==e.radius&&{radius:e.radius}};Object.keys(t).length&&(i.point=t);const n={...void 0!==e["label-color"]&&{color:e["label-color"]},...void 0!==e["label-opacity"]&&{opacity:e["label-opacity"]},...void 0!==e["label-size"]&&{size:e["label-size"]}};Object.keys(t).length&&(i.text=n);const r={...void 0!==e.icon&&{source:e.icon},...void 0!==e["icon-scale"]&&{size:e["icon-scale"]},...void 0!==e["icon-opacity"]&&{opacity:e["icon-opacity"]},...void 0!==e["icon-color"]&&{color:e["icon-color"]}};Object.keys(r).length&&(i.icon=r)}else{const t={...void 0!==e.stroke&&{color:e.stroke},...void 0!==e["stroke-width"]&&{width:e["stroke-width"]},...void 0!==e["stroke-opacity"]&&{opacity:e["stroke-opacity"]}};if(Object.keys(t).length&&(i.stroke=t),n!==dy.LINE){const t={...void 0!==e.fill&&{color:e.fill},...void 0!==e["fill-opacity"]&&{opacity:e["fill-opacity"]}};Object.keys(t).length&&(i.fill=t)}}return i};function cy(e){return new up(e,1/0,-1/0,1/0,-1/0)}function hy(e,t){e.normals&&t.geodesicNormal.toArray(e.normals,e._pos),e._pushValues(t.x,t.y,t.z)}const uy=new Jd("EPSG:4326",0,0,0),dy={POINT:0,LINE:1,POLYGON:2};class py{#l;constructor(e){this.indices=[],this.properties={},this.size=e.size,e.extent&&(this.extent=cy(e.extent.crs),this.#l=cy(e.extent.crs))}startSubGeometry(e,t){const n=this.indices.length-1,i=this.extent?cy(this.extent.crs):void 0,r=n>-1?this.indices[n].offset+this.indices[n].count:t.vertices.length/this.size;this.indices.push({offset:r,count:e,extent:i}),this.#l=i,function(e,t){e.vertices.length+=t*e.size,e.normals&&(e.normals.length=e.vertices.length)}(t,e)}closeSubGeometry(e,t){const n=this.indices.length-1,i=n>-1?this.indices[n].offset+this.indices[n].count:t.vertices.length/this.size-e;this.indices.push({offset:i,count:e,extent:this.#l}),this.extent&&(this.extent.union(this.#l),this.#l=cy(this.extent.crs))}getLastSubGeometry(){const e=this.indices.length-1;return this.indices[e]}pushCoordinates(e,t){if(e.isCoordinates)return console.warn("Deprecated: change in arguments order, use pushCoordinates(feature, coordIn) instead"),void this.pushCoordinates(t,e);t.as(e.crs,uy),e.transformToLocalSystem(uy),hy(e,uy),this.#l&&this.#l.expandByCoordinates(e.useCrsOut?uy:t)}pushCoordinatesValues(e,t,n){if((arguments.length<=3?0:arguments.length-3)>0)return console.warn("Deprecated: change in arguments, use pushCoordinatesValues(feature, {x: long, y: lat, normal}, coordProj) instead"),void this.pushCoordinatesValues(e,{x:t,y:n,normal:arguments.length<=3?void 0:arguments[3]},arguments.length<=4?void 0:arguments[4]);hy(e,t),this.#l&&this.#l.expandByValuesCoordinates(t.x,t.y)}updateExtent(){if(this.extent){const e=this.indices[this.indices.length-1];e&&this.extent.union(e.extent)}}}function fy(e,t){this.vertices[this._pos++]=e,this.vertices[this._pos++]=t}function my(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;this.vertices[this._pos++]=e,this.vertices[this._pos++]=t,this.vertices[this._pos++]=n}class gy{constructor(e,t){if(!Object.keys(dy).find((t=>dy[t]===e)))throw new Error(`Unsupported Feature type: ${e}`);this.type=e,this.geometries=[],this.vertices=[],this.crs=t.crs,this.size=t.size,this.normals="EPSG:4978"==t.crs?[]:void 0,this.hasRawElevationData=!1,this.transformToLocalSystem=t.transformToLocalSystem.bind(t),t.extent&&(this.extent=cy(t.extent.crs),this.useCrsOut=this.extent.crs==this.crs),this._pos=0,this._pushValues=(3===this.size?my:fy).bind(this),this.style=ly}bindNewGeometry(){const e=new py(this);return this.geometries.push(e),e}updateExtent(e){this.extent&&this.extent.union(e.extent)}get geometryCount(){return this.geometries.length}}const Ay=()=>{},yy=(e,t)=>(e.geodesicNormal.applyNormalMatrix(t.normalMatrixInverse),e.applyMatrix4(t.matrixWorldInverse)),vy=(e,t)=>e.applyMatrix4(t.matrixWorldInverse),_y=new sn(0,0,1),xy=new rn;class Ey extends li{#c=(()=>vy)();#h=(()=>Ay)();constructor(e){super(),this.isFeatureCollection=!0,this.crs=e.accurate||!e.source?.crs?e.crs:e.source.crs,this.features=[],this.mergeFeatures=void 0===e.mergeFeatures||e.mergeFeatures,this.size="3d"==e.structure?3:2,this.filterExtent=e.filterExtent,this.style=e.style,this.isInverted=!1,this.matrixWorldInverse=new Nn,this.center=new Jd("EPSG:4326",0,0),2==this.size?(this.extent=!1===e.buildExtent?void 0:cy(e.forcedExtentCrs||this.crs),this.#h=e=>{e.as(this.crs,this.center),this.position.copy(e),this.updateMatrixWorld(),this.#h=Ay}):(this.extent=e.buildExtent?cy(e.forcedExtentCrs||this.crs):void 0,this.#h=e=>{e.as("EPSG:4326",this.center),"EPSG:4978"==this.crs&&(this.quaternion.setFromUnitVectors(_y,e.geodesicNormal),xy.setFromAxisAngle(_y,Tt.degToRad(90+this.center.longitude)),this.quaternion.multiply(xy)),this.position.copy(e),this.updateMatrixWorld(),this.normalMatrix.getNormalMatrix(this.matrix),this.normalMatrixInverse=(new Rt).copy(this.normalMatrix).invert(),this.#h=Ay},this.#c=yy)}transformToLocalSystem(e){return this.#h(e),this.#c(e,this)}updateExtent(e){if(this.extent){const t=e?[e]:this.features.map((e=>e.extent));for(const e of t)this.extent.union(e)}}updateMatrixWorld(e){super.updateMatrixWorld(e),this.matrixWorldInverse.copy(this.matrixWorld).invert()}removeEmptyFeature(){this.features=this.features.filter((e=>e.geometries.length))}pushFeature(e){this.features.push(e),this.updateExtent(e.extent)}requestFeature(e,t){const n=this.features.find(t);if(n&&this.mergeFeatures)return n;{const t=new gy(e,this);return this.features.push(t),t}}requestFeatureByType(e){return this.requestFeature(e,(t=>t.type===e))}requestFeatureById(e,t){return this.requestFeature(t,(t=>t.id===e))}newFeatureByReference(e){const t=new gy(e.type,this);return t.extent=e.extent,t.geometries=e.geometries,t.normals=e.normals,t.size=e.size,t.vertices=e.vertices,t._pos=e._pos,this.features.push(t),t}}const by=e=>{if(e.crsOut||e.crsIn){console.warn("Parsing options with crsIn and crsOut are deprecated, use { in, out } structure.");const t={in:{},out:{}};return t.in.crs=e.crsIn,t.in.isInverted=e.isInverted,t.in.styles=e.styles,t.in.layers=e.layers,t.in.filter=e.filter,t.out.crs=e.crsOut,t.out.mergeFeatures=e.mergeFeatures,e.withAltitude&&e.withNormal?(console.warn("Parsing options withAltitude and withNormal is deprecated, use out.structure: 2d or 3d."),t.out.structure="3d"):t.out.structure="2d",t.out.filteringExtent=e.filteringExtent,t.out.style=e.style,void 0!==e.crsOut.overrideAltitudeInToZero&&console.error("Parsing options out.overrideAltitudeInToZero is removed, use Style.xxx.base_altitude instead"),t.out.filter=e.filter,t}return e.out&&(void 0===e.out.withAltitude&&void 0===e.out.withNormal||(console.warn("Parsing options out.withAltitude and out.withNormal is deprecated, use out.structure: 2d or 3d."),e.out.withAltitude&&e.out.withNormal?e.out.structure="3d":e.out.structure="2d"),void 0!==e.out.overrideAltitudeInToZero&&console.error("Parsing options out.overrideAltitudeInToZero is removed, use Style.xxx.base_altitude instead")),e},wy=new Jd("EPSG:4978",0,0,0),My=new Jd("EPSG:4978",0,0,0),Sy=new Jd("EPSG:4978",0,0,0),Cy=(e,t,n)=>(wy.crs=n,wy.setFromArray(t[0]),!e.isPointInside(wy)),Ty={populateGeometry(e,t,n,i){n.startSubGeometry(t.length,i),wy.crs=e;for(const e of t)wy.setFromValues(e[0],e[1],e[2]),n.pushCoordinates(i,wy);n.updateExtent()},populateGeometryWithCCW(e,t,n,i){n.startSubGeometry(t.length,i),wy.crs=e;let r=0;Sy.setFromValues(t[0][0],t[0][1],t[0][2]),My.copy(Sy);for(let e=0;e<t.length;e++)wy.setFromValues(t[e][0],t[e][1],t[e][2]),r+=(My.x-wy.x)*(My.y+wy.y),My.copy(wy),n.pushCoordinates(i,wy);r+=(My.x-Sy.x)*(My.y+Sy.y),n.getLastSubGeometry().ccw=r<0,n.updateExtent()},point(e,t,n,i,r){this.default(e,t,[n],i,r)},default(e,t,n,i,r){if(i.filterExtent&&Cy(i.filterExtent,n,t))return;const s=e.bindNewGeometry();s.properties=r,this.populateGeometry(t,n,s,e),e.updateExtent(s)},polygon(e,t,n,i,r){if(i.filterExtent&&Cy(i.filterExtent,n[0],t))return;const s=e.bindNewGeometry();s.properties=r;for(let i=0;i<n.length;i++)this.populateGeometryWithCCW(t,n[i],s,e);e.updateExtent(s)},multi(e,t,n,i,r,s){for(const a of i)this[e](t,n,a,r,s)}},Iy=["type","geometry","properties"],Ry=e=>void 0===e||Array.isArray(e)&&!isNaN(e[0])?e:Ry(e[0]);function By(e,t,n){if(!t.geometry?.type)return console.warn("No geometry provided"),null;const i=t.geometry.type.toLowerCase(),r=function(e){switch(e){case"point":case"multipoint":return dy.POINT;case"linestring":case"multilinestring":return dy.LINE;case"polygon":case"multipolygon":return dy.POLYGON;default:throw new Error(`Unhandled geometry type ${e}`)}}(i),s=n.requestFeatureByType(r),a="point"!=i?t.geometry.coordinates:[t.geometry.coordinates],o=t.properties||{};s.hasRawElevationData=3===Ry(a)?.length;for(const e of Object.keys(t))Iy.includes(e.toLowerCase())||(o.geojson=o.geojson||{},o.geojson[e]=t[e]);return function(e,t,n,i,r,s){if(0!=i.length)switch(e){case"point":case"linestring":return Ty.default(t,n,i,r,s);case"multipoint":return Ty.multi("point",t,n,i,r,s);case"multilinestring":return Ty.multi("default",t,n,i,r,s);case"polygon":return Ty.polygon(t,n,i,r,s);case"multipolygon":return Ty.multi("polygon",t,n,i,r,s);default:throw new Error(`Unhandled geojson type ${t.type}`)}}(i,s,e,a,n,o),s}function Ly(e,t,n){const i=new Ey(n),r=n.filter||(()=>!0);for(const n of t)r(n.properties,n.geometry)&&By(e,n,i);return i.removeEmptyFeature(),i.updateExtent(),i}const Py={parse(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};t=by(t),t.in=t.in||{};const n=t.out,i=t.in;switch("string"==typeof e&&(e=JSON.parse(e)),i.crs=i.crs||function(e){if(e.crs){if("epsg"==e.crs.type.toLowerCase())return`EPSG:${e.crs.properties.code}`;if("name"==e.crs.type.toLowerCase()){if(e.crs.properties.name.toLowerCase().includes("epsg:")){const t=e.crs.properties.name.lastIndexOf(":");if(t>0)return`EPSG:${e.crs.properties.name.substr(t+1)}`}throw new Error(`Unsupported CRS authority '${e.crs.properties.name}'`)}throw new Error(`Unsupported CRS type '${e.crs}'`)}return"EPSG:4326"}(e),n.filteringExtent&&("boolean"==typeof n.filteringExtent?n.filterExtent=t.extent.isExtent?t.extent.as(i.crs):t.extent.toExtent(i.crs):n.filteringExtent.isExtent&&(n.filterExtent=n.filteringExtent)),e.type.toLowerCase()){case"featurecollection":return Promise.resolve(Ly(i.crs,e.features,n));case"feature":return Promise.resolve(Ly(i.crs,[e],n));default:throw new Error(`Unsupported GeoJSON type: '${e.type}`)}}};function Dy(e,t){return Array.from(e.getElementsByTagName(t))}function Ny(e){return"#"===e[0]?e:`#${e}`}function Uy(e){return e?.normalize(),e&&e.textContent||""}function Oy(e,t,n){const i=e.getElementsByTagName(t),r=i.length?i[0]:null;return r&&n&&n(r),r}function Fy(e,t,n){const i={};if(!e)return i;const r=e.getElementsByTagName(t),s=r.length?r[0]:null;return s&&n?n(s,i):i}function ky(e,t,n){const i=Uy(Oy(e,t));return i&&n&&n(i)||{}}function Qy(e,t,n){const i=parseFloat(Uy(Oy(e,t)));if(!isNaN(i))return i&&n&&n(i)||{}}function zy(e,t,n){const i=parseFloat(Uy(Oy(e,t)));if(!isNaN(i))return n&&n(i),i}function Gy(e,t){const n={};for(const i of t)ky(e,i,(e=>{n[i]=e}));return n}function Hy(e){return 1===e?.nodeType}function Vy(e){return Fy(e,"line",(e=>Object.assign({},ky(e,"color",(e=>({stroke:`#${e}`}))),Qy(e,"opacity",(e=>({"stroke-opacity":e}))),Qy(e,"width",(e=>({"stroke-width":96*e/25.4}))))))}function jy(e){let t=[];if(null===e)return t;for(const n of Array.from(e.childNodes)){if(!Hy(n))continue;const e=qy(n.nodeName);if("gpxtpx:TrackPointExtension"===e)t=t.concat(jy(n));else{const i=Uy(n);t.push([e,Wy(i)])}}return t}function qy(e){return["heart","gpxtpx:hr","hr"].includes(e)?"heart":e}function Wy(e){const t=parseFloat(e);return isNaN(t)?e:t}function Yy(e){const t=[parseFloat(e.getAttribute("lon")||""),parseFloat(e.getAttribute("lat")||"")];if(isNaN(t[0])||isNaN(t[1]))return null;zy(e,"ele",(e=>{t.push(e)}));const n=Oy(e,"time");return{coordinates:t,time:n?Uy(n):null,extendedValues:jy(Oy(e,"extensions"))}}function Xy(e){const t=Gy(e,["name","cmt","desc","type","time","keywords"]),n=Array.from(e.getElementsByTagNameNS("http://www.garmin.com/xmlschemas/GpxExtensions/v3","*"));for(const i of n)i.parentNode?.parentNode===e&&(t[i.tagName.replace(":","_")]=Uy(i));const i=Dy(e,"link");return i.length&&(t.links=i.map((e=>Object.assign({href:e.getAttribute("href")},Gy(e,["text","type"]))))),t}function Ky(e,t){const n=Dy(e,t),i=[],r=[],s={};for(let e=0;e<n.length;e++){const t=Yy(n[e]);if(t){i.push(t.coordinates),t.time&&r.push(t.time);for(const[i,r]of t.extendedValues){const t="heart"===i?i:i.replace("gpxtpx:","")+"s";s[t]||(s[t]=Array(n.length).fill(null)),s[t][e]=r}}}if(!(i.length<2))return{line:i,times:r,extendedValues:s}}function Jy(e){const t=Ky(e,"rtept");if(t)return{type:"Feature",properties:Object.assign({_gpxType:"rte"},Xy(e),Vy(Oy(e,"extensions"))),geometry:{type:"LineString",coordinates:t.line}}}function $y(e){const t=Dy(e,"trkseg"),n=[],i=[],r=[];for(const e of t){const t=Ky(e,"trkpt");t&&(r.push(t),t.times&&t.times.length&&i.push(t.times))}if(0===r.length)return null;const s=r.length>1,a=Object.assign({_gpxType:"trk"},Xy(e),Vy(Oy(e,"extensions")),i.length?{coordinateProperties:{times:s?i:i[0]}}:{});for(const e of r){n.push(e.line),a.coordinateProperties||(a.coordinateProperties={});const t=a.coordinateProperties,i=Object.entries(e.extendedValues);for(let e=0;e<i.length;e++){const[n,a]=i[e];s?(t[n]||(t[n]=r.map((e=>new Array(e.line.length).fill(null)))),t[n][e]=a):t[n]=a}}return{type:"Feature",properties:a,geometry:s?{type:"MultiLineString",coordinates:n}:{type:"LineString",coordinates:n[0]}}}function Zy(e){const t=Object.assign(Xy(e),Gy(e,["sym"])),n=Yy(e);return n?{type:"Feature",properties:t,geometry:{type:"Point",coordinates:n.coordinates}}:null}function*ev(e){for(const t of Dy(e,"trk")){const e=$y(t);e&&(yield e)}for(const t of Dy(e,"rte")){const e=Jy(t);e&&(yield e)}for(const t of Dy(e,"wpt")){const e=Zy(t);e&&(yield e)}}function tv(e,t){const n={},i="stroke"==t||"fill"===t?t:t+"-color";return"#"===e[0]&&(e=e.substring(1)),6===e.length||3===e.length?n[i]="#"+e:8===e.length&&(n[t+"-opacity"]=parseInt(e.substring(0,2),16)/255,n[i]="#"+e.substring(6,8)+e.substring(4,6)+e.substring(2,4)),n}function nv(e,t,n){const i={};return zy(e,t,(e=>{i[n]=e})),i}function iv(e,t){return Fy(e,"color",(e=>tv(Uy(e),t)))}function rv(e){return Fy(e,"Icon",((e,t)=>(ky(e,"href",(e=>{t.icon=e})),t)))}function sv(e){return Object.assign({},function(e){return Fy(e,"PolyStyle",((e,t)=>Object.assign(t,Fy(e,"color",(e=>tv(Uy(e),"fill"))),ky(e,"fill",(e=>{if("0"===e)return{"fill-opacity":0}})),ky(e,"outline",(e=>{if("0"===e)return{"stroke-opacity":0}})))))}(e),function(e){return Fy(e,"LineStyle",(e=>Object.assign(iv(e,"stroke"),nv(e,"width","stroke-width"))))}(e),function(e){return Fy(e,"LabelStyle",(e=>Object.assign(iv(e,"label"),nv(e,"scale","label-scale"))))}(e),function(e){return Fy(e,"IconStyle",(e=>Object.assign(iv(e,"icon"),nv(e,"scale","icon-scale"),nv(e,"heading","icon-heading"),Fy(e,"hotSpot",(e=>{const t=parseFloat(e.getAttribute("x")||""),n=parseFloat(e.getAttribute("y")||""),i=e.getAttribute("xunits")||"",r=e.getAttribute("yunits")||"";return isNaN(t)||isNaN(n)?{}:{"icon-offset":[t,n],"icon-offset-units":[i,r]}})),rv(e))))}(e))}const av=e=>Number(e),ov={string:e=>e,int:av,uint:av,short:av,ushort:av,float:av,double:av,bool:e=>Boolean(e)};function lv(e,t){return Fy(e,"ExtendedData",((e,n)=>{for(const t of Dy(e,"Data"))n[t.getAttribute("name")||""]=Uy(Oy(t,"value"));for(const i of Dy(e,"SimpleData")){const e=i.getAttribute("name")||"",r=t[e]||ov.string;n[e]=r(Uy(i))}return n}))}function cv(e){const t=Oy(e,"description");for(const e of Array.from(t?.childNodes||[]))if(4===e.nodeType)return{description:{"@type":"html",value:Uy(e)}};return{}}function hv(e){return Fy(e,"TimeSpan",(e=>({timespan:{begin:Uy(Oy(e,"begin")),end:Uy(Oy(e,"end"))}})))}function uv(e){return Fy(e,"TimeStamp",(e=>({timestamp:Uy(Oy(e,"when"))})))}function dv(e,t){return ky(e,"styleUrl",(e=>(e=Ny(e),t[e]?Object.assign({styleUrl:e},t[e]):{styleUrl:e})))}const pv=/\s*/g,fv=/^\s*|\s*$/g,mv=/\s+/;function gv(e){return e.replace(pv,"").split(",").map(parseFloat).filter((e=>!isNaN(e))).slice(0,3)}function Av(e){return e.replace(fv,"").split(mv).map(gv).filter((e=>e.length>=2))}function yv(e){let t=Dy(e,"coord");var n;0===t.length&&(n=e,t=Array.from(n.getElementsByTagNameNS("*","coord")));const i=t.map((e=>Uy(e).split(" ").map(parseFloat)));return 0===i.length?null:{geometry:i.length>2?{type:"LineString",coordinates:i}:{type:"Point",coordinates:i[0]},times:Dy(e,"when").map((e=>Uy(e)))}}function vv(e){if(0===e.length)return e;const t=e[0],n=e[e.length-1];let i=!0;for(let e=0;e<Math.max(t.length,n.length);e++)if(t[e]!==n[e]){i=!1;break}return i?e:e.concat([e[0]])}function _v(e){return Uy(Oy(e,"coordinates"))}function xv(e){let t=[],n=[];for(let i=0;i<e.childNodes.length;i++){const r=e.childNodes.item(i);if(Hy(r))switch(r.tagName){case"MultiGeometry":case"MultiTrack":case"gx:MultiTrack":{const e=xv(r);t=t.concat(e.geometries),n=n.concat(e.coordTimes);break}case"Point":{const e=gv(_v(r));e.length>=2&&t.push({type:"Point",coordinates:e});break}case"LinearRing":case"LineString":{const e=Av(_v(r));e.length>=2&&t.push({type:"LineString",coordinates:e});break}case"Polygon":{const e=[];for(const t of Dy(r,"LinearRing")){const n=vv(Av(_v(t)));n.length>=4&&e.push(n)}e.length&&t.push({type:"Polygon",coordinates:e});break}case"Track":case"gx:Track":{const e=yv(r);if(!e)break;const{times:i,geometry:s}=e;t.push(s),i.length&&n.push(i);break}}}return{geometries:t,coordTimes:n}}function Ev(e,t,n,i){const{coordTimes:r,geometries:s}=xv(e),a=function(e){return 0===e.length?null:1===e.length?e[0]:{type:"GeometryCollection",geometries:e}}(s);if(!a&&i.skipNullGeometry)return null;const o={type:"Feature",geometry:a,properties:Object.assign(Gy(e,["name","address","visibility","open","phoneNumber","description"]),cv(e),dv(e,t),sv(e),lv(e,n),hv(e),uv(e),r.length?{coordinateProperties:{times:1===r.length?r[0]:r}}:{})};void 0!==o.properties?.visibility&&(o.properties.visibility="0"!==o.properties.visibility);const l=e.getAttribute("id");return null!==l&&""!==l&&(o.id=l),o}const bv=Math.PI/180;function wv(e,t,n,i){const r=function(e){return Oy(e,"gx:LatLonQuad")?{geometry:{type:"Polygon",coordinates:[vv(Av(_v(e)))]}}:function(e){const t=Oy(e,"LatLonBox");if(t){const e=zy(t,"north"),n=zy(t,"west"),i=zy(t,"east"),r=zy(t,"south"),s=zy(t,"rotation");if("number"==typeof e&&"number"==typeof r&&"number"==typeof n&&"number"==typeof i){const t=[n,r,i,e];let a=[[[n,e],[i,e],[i,r],[n,r],[n,e]]];return"number"==typeof s&&(a=function(e,t,n){const i=[(e[0]+e[2])/2,(e[1]+e[3])/2];return[t[0].map((e=>{const t=e[1]-i[1],r=e[0]-i[0],s=Math.sqrt(Math.pow(t,2)+Math.pow(r,2)),a=Math.atan2(t,r)+n*bv;return[i[0]+Math.cos(a)*s,i[1]+Math.sin(a)*s]}))]}(t,a,s)),{bbox:t,geometry:{type:"Polygon",coordinates:a}}}}return null}(e)}(e),s=r?.geometry||null;if(!s&&i.skipNullGeometry)return null;const a={type:"Feature",geometry:s,properties:Object.assign({"@geometry-type":"groundoverlay"},Gy(e,["name","address","visibility","open","phoneNumber","description"]),cv(e),dv(e,t),sv(e),rv(e),lv(e,n),hv(e),uv(e))};r?.bbox&&(a.bbox=r.bbox),void 0!==a.properties?.visibility&&(a.properties.visibility="0"!==a.properties.visibility);const o=e.getAttribute("id");return null!==o&&""!==o&&(a.id=o),a}function Mv(e){let t=e.getAttribute("id");const n=e.parentNode;return!t&&Hy(n)&&"CascadingStyle"===n.localName&&(t=n.getAttribute("kml:id")||n.getAttribute("id")),Ny(t||"")}function*Sv(e,t={skipNullGeometry:!1}){const n=function(e){const t={};for(const n of Dy(e,"Style"))t[Mv(n)]=sv(n);for(const n of Dy(e,"StyleMap")){const e=Ny(n.getAttribute("id")||"");ky(n,"styleUrl",(n=>{n=Ny(n),t[n]&&(t[e]=t[n])}))}return t}(e),i=function(e){const t={};for(const n of Dy(e,"SimpleField"))t[n.getAttribute("name")||""]=ov[n.getAttribute("type")||""]||ov.string;return t}(e);for(const r of Dy(e,"Placemark")){const e=Ev(r,n,i,t);e&&(yield e)}for(const r of Dy(e,"GroundOverlay")){const e=wv(r,n,i,t);e&&(yield e)}}const Cv={parse:(e,t)=>(t=by(t),Py.parse(function(e,t={skipNullGeometry:!1}){return{type:"FeatureCollection",features:Array.from(Sv(e,t))}}(e),t))},Tv={parse(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{in:{}};const n=t.in.dataType||"float";if(!["float","double"].includes(n))throw new Error("`dataType` parameter is incorrect for GTXParser.parse method. This parameter must be either `double` or `float`.");const i=new DataView(e,0,40),r={minX:i.getFloat64(8),minY:i.getFloat64(0),stepX:i.getFloat64(24),stepY:i.getFloat64(16),nColumns:i.getInt32(36),nRows:i.getInt32(32)},s=new DataView(e,40),a=r.minX+r.stepX*(r.nColumns-1),o=r.minY+r.stepY*(r.nRows-1),l=new up(t.in.crs||"EPSG:4326",r.minX,a,r.minY,o),c=new It(r.stepX,r.stepY);return Promise.resolve(new gp(l,c,((e,t)=>"float"===n?s.getFloat32(4*(r.nColumns*e+t)):"double"===n?s.getFloat64(8*(r.nColumns*e+t)):void 0)))}};function Iv(e,t){const n=e[e.indexOf(e.find((e=>e.includes(t))))].split(" ").filter((e=>""!==e));return parseFloat(n[n.length-1])}const Rv={parse(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{in:{}};const n=e.split("\n"),i=n.indexOf(n.find((e=>e.includes("end_of_head"))))+1,r=n.slice(0,i),s={minX:Iv(r,"longlimit_west"),maxX:Iv(r,"longlimit_east"),minY:Iv(r,"latlimit_south"),maxY:Iv(r,"latlimit_north"),stepX:Iv(r,"gridstep"),stepY:Iv(r,"gridstep"),nRows:Iv(r,"latitude_parallels"),nColumns:Iv(r,"longitude_parallels")},a=new DataView(new ArrayBuffer(8*s.nRows*s.nColumns));let o=0;for(let e of n.slice(i,n.length))e=e.split(" ").filter((e=>""!==e)),e.length&&(a.setFloat64(8*o,parseFloat(e[2])),o++);const l=new up(t.in.crs||"EPSG:4326",s.minX,s.maxX,s.minY,s.maxY),c=new It(s.stepX,s.stepY);return Promise.resolve(new gp(l,c,((e,t)=>a.getFloat64(8*(s.nColumns*(s.nRows-e-1)+t)))))}},Bv={parse(e,t){return t=by(t),Py.parse((n=e,{type:"FeatureCollection",features:Array.from(ev(n))}),t);var n}},Lv={parse(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{in:{}};const n=e.split("\n"),i=n.indexOf(n.find((e=>e.includes("end_of_head"))))+1,r=n.slice(0,i),s={minX:Iv(r,"lon min"),maxX:Iv(r,"lon max"),minY:Iv(r,"lat min"),maxY:Iv(r,"lat max"),stepX:Iv(r,"delta lon"),stepY:Iv(r,"delta lat"),nRows:Iv(r,"nrows"),nColumns:Iv(r,"ncols")},a=new DataView(new ArrayBuffer(8*s.nRows*s.nColumns));let o=0;for(let e of n.slice(i,n.length))if(e=e.split(" ").filter((e=>""!==e)),e.length)for(const t of e)a.setFloat64(8*o,parseFloat(t)),o++;const l=new up(t.in.crs||"EPSG:4326",s.minX+s.stepX/2,s.maxX-s.stepX/2,s.minY+s.stepY/2,s.maxY-s.stepY/2),c=new It(s.stepX,s.stepY);return Promise.resolve(new gp(l,c,((e,t)=>a.getFloat64(8*(s.nColumns*e+t)))))}},Pv=4294967296,Dv=1/Pv,Nv="undefined"==typeof TextDecoder?null:new TextDecoder("utf-8");class Uv{constructor(e=new Uint8Array(16)){this.buf=ArrayBuffer.isView(e)?e:new Uint8Array(e),this.dataView=new DataView(this.buf.buffer),this.pos=0,this.type=0,this.length=this.buf.length}readFields(e,t,n=this.length){for(;this.pos<n;){const n=this.readVarint(),i=n>>3,r=this.pos;this.type=7&n,e(i,t,this),this.pos===r&&this.skip(n)}return t}readMessage(e,t){return this.readFields(e,t,this.readVarint()+this.pos)}readFixed32(){const e=this.dataView.getUint32(this.pos,!0);return this.pos+=4,e}readSFixed32(){const e=this.dataView.getInt32(this.pos,!0);return this.pos+=4,e}readFixed64(){const e=this.dataView.getUint32(this.pos,!0)+this.dataView.getUint32(this.pos+4,!0)*Pv;return this.pos+=8,e}readSFixed64(){const e=this.dataView.getUint32(this.pos,!0)+this.dataView.getInt32(this.pos+4,!0)*Pv;return this.pos+=8,e}readFloat(){const e=this.dataView.getFloat32(this.pos,!0);return this.pos+=4,e}readDouble(){const e=this.dataView.getFloat64(this.pos,!0);return this.pos+=8,e}readVarint(e){const t=this.buf;let n,i;return i=t[this.pos++],n=127&i,i<128?n:(i=t[this.pos++],n|=(127&i)<<7,i<128?n:(i=t[this.pos++],n|=(127&i)<<14,i<128?n:(i=t[this.pos++],n|=(127&i)<<21,i<128?n:(i=t[this.pos],n|=(15&i)<<28,function(e,t,n){const i=n.buf;let r,s;if(s=i[n.pos++],r=(112&s)>>4,s<128)return Ov(e,r,t);if(s=i[n.pos++],r|=(127&s)<<3,s<128)return Ov(e,r,t);if(s=i[n.pos++],r|=(127&s)<<10,s<128)return Ov(e,r,t);if(s=i[n.pos++],r|=(127&s)<<17,s<128)return Ov(e,r,t);if(s=i[n.pos++],r|=(127&s)<<24,s<128)return Ov(e,r,t);if(s=i[n.pos++],r|=(1&s)<<31,s<128)return Ov(e,r,t);throw new Error("Expected varint not more than 10 bytes")}(n,e,this)))))}readVarint64(){return this.readVarint(!0)}readSVarint(){const e=this.readVarint();return e%2==1?(e+1)/-2:e/2}readBoolean(){return Boolean(this.readVarint())}readString(){const e=this.readVarint()+this.pos,t=this.pos;return this.pos=e,e-t>=12&&Nv?Nv.decode(this.buf.subarray(t,e)):function(e,t,n){let i="",r=t;for(;r<n;){const t=e[r];let s,a,o,l=null,c=t>239?4:t>223?3:t>191?2:1;if(r+c>n)break;1===c?t<128&&(l=t):2===c?(s=e[r+1],128==(192&s)&&(l=(31&t)<<6|63&s,l<=127&&(l=null))):3===c?(s=e[r+1],a=e[r+2],128==(192&s)&&128==(192&a)&&(l=(15&t)<<12|(63&s)<<6|63&a,(l<=2047||l>=55296&&l<=57343)&&(l=null))):4===c&&(s=e[r+1],a=e[r+2],o=e[r+3],128==(192&s)&&128==(192&a)&&128==(192&o)&&(l=(15&t)<<18|(63&s)<<12|(63&a)<<6|63&o,(l<=65535||l>=1114112)&&(l=null))),null===l?(l=65533,c=1):l>65535&&(l-=65536,i+=String.fromCharCode(l>>>10&1023|55296),l=56320|1023&l),i+=String.fromCharCode(l),r+=c}return i}(this.buf,t,e)}readBytes(){const e=this.readVarint()+this.pos,t=this.buf.subarray(this.pos,e);return this.pos=e,t}readPackedVarint(e=[],t){const n=this.readPackedEnd();for(;this.pos<n;)e.push(this.readVarint(t));return e}readPackedSVarint(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readSVarint());return e}readPackedBoolean(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readBoolean());return e}readPackedFloat(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readFloat());return e}readPackedDouble(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readDouble());return e}readPackedFixed32(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readFixed32());return e}readPackedSFixed32(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readSFixed32());return e}readPackedFixed64(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readFixed64());return e}readPackedSFixed64(e=[]){const t=this.readPackedEnd();for(;this.pos<t;)e.push(this.readSFixed64());return e}readPackedEnd(){return 2===this.type?this.readVarint()+this.pos:this.pos+1}skip(e){const t=7&e;if(0===t)for(;this.buf[this.pos++]>127;);else if(2===t)this.pos=this.readVarint()+this.pos;else if(5===t)this.pos+=4;else{if(1!==t)throw new Error(`Unimplemented type: ${t}`);this.pos+=8}}writeTag(e,t){this.writeVarint(e<<3|t)}realloc(e){let t=this.length||16;for(;t<this.pos+e;)t*=2;if(t!==this.length){const e=new Uint8Array(t);e.set(this.buf),this.buf=e,this.dataView=new DataView(e.buffer),this.length=t}}finish(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)}writeFixed32(e){this.realloc(4),this.dataView.setInt32(this.pos,e,!0),this.pos+=4}writeSFixed32(e){this.realloc(4),this.dataView.setInt32(this.pos,e,!0),this.pos+=4}writeFixed64(e){this.realloc(8),this.dataView.setInt32(this.pos,-1&e,!0),this.dataView.setInt32(this.pos+4,Math.floor(e*Dv),!0),this.pos+=8}writeSFixed64(e){this.realloc(8),this.dataView.setInt32(this.pos,-1&e,!0),this.dataView.setInt32(this.pos+4,Math.floor(e*Dv),!0),this.pos+=8}writeVarint(e){(e=+e||0)>268435455||e<0?function(e,t){let n,i;if(e>=0?(n=e%4294967296|0,i=e/4294967296|0):(n=~(-e%4294967296),i=~(-e/4294967296),4294967295^n?n=n+1|0:(n=0,i=i+1|0)),e>=0x10000000000000000||e<-0x10000000000000000)throw new Error("Given varint doesn't fit into 10 bytes");t.realloc(10),function(e,t,n){n.buf[n.pos++]=127&e|128,e>>>=7,n.buf[n.pos++]=127&e|128,e>>>=7,n.buf[n.pos++]=127&e|128,e>>>=7,n.buf[n.pos++]=127&e|128,e>>>=7,n.buf[n.pos]=127&e}(n,0,t),function(e,t){const n=(7&e)<<4;t.buf[t.pos++]|=n|((e>>>=3)?128:0),e&&(t.buf[t.pos++]=127&e|((e>>>=7)?128:0),e&&(t.buf[t.pos++]=127&e|((e>>>=7)?128:0),e&&(t.buf[t.pos++]=127&e|((e>>>=7)?128:0),e&&(t.buf[t.pos++]=127&e|((e>>>=7)?128:0),e&&(t.buf[t.pos++]=127&e)))))}(i,t)}(e,this):(this.realloc(4),this.buf[this.pos++]=127&e|(e>127?128:0),e<=127||(this.buf[this.pos++]=127&(e>>>=7)|(e>127?128:0),e<=127||(this.buf[this.pos++]=127&(e>>>=7)|(e>127?128:0),e<=127||(this.buf[this.pos++]=e>>>7&127))))}writeSVarint(e){this.writeVarint(e<0?2*-e-1:2*e)}writeBoolean(e){this.writeVarint(+e)}writeString(e){e=String(e),this.realloc(4*e.length),this.pos++;const t=this.pos;this.pos=function(e,t,n){for(let i,r,s=0;s<t.length;s++){if(i=t.charCodeAt(s),i>55295&&i<57344){if(!r){i>56319||s+1===t.length?(e[n++]=239,e[n++]=191,e[n++]=189):r=i;continue}if(i<56320){e[n++]=239,e[n++]=191,e[n++]=189,r=i;continue}i=r-55296<<10|i-56320|65536,r=null}else r&&(e[n++]=239,e[n++]=191,e[n++]=189,r=null);i<128?e[n++]=i:(i<2048?e[n++]=i>>6|192:(i<65536?e[n++]=i>>12|224:(e[n++]=i>>18|240,e[n++]=i>>12&63|128),e[n++]=i>>6&63|128),e[n++]=63&i|128)}return n}(this.buf,e,this.pos);const n=this.pos-t;n>=128&&Fv(t,n,this),this.pos=t-1,this.writeVarint(n),this.pos+=n}writeFloat(e){this.realloc(4),this.dataView.setFloat32(this.pos,e,!0),this.pos+=4}writeDouble(e){this.realloc(8),this.dataView.setFloat64(this.pos,e,!0),this.pos+=8}writeBytes(e){const t=e.length;this.writeVarint(t),this.realloc(t);for(let n=0;n<t;n++)this.buf[this.pos++]=e[n]}writeRawMessage(e,t){this.pos++;const n=this.pos;e(t,this);const i=this.pos-n;i>=128&&Fv(n,i,this),this.pos=n-1,this.writeVarint(i),this.pos+=i}writeMessage(e,t,n){this.writeTag(e,2),this.writeRawMessage(t,n)}writePackedVarint(e,t){t.length&&this.writeMessage(e,kv,t)}writePackedSVarint(e,t){t.length&&this.writeMessage(e,Qv,t)}writePackedBoolean(e,t){t.length&&this.writeMessage(e,Hv,t)}writePackedFloat(e,t){t.length&&this.writeMessage(e,zv,t)}writePackedDouble(e,t){t.length&&this.writeMessage(e,Gv,t)}writePackedFixed32(e,t){t.length&&this.writeMessage(e,Vv,t)}writePackedSFixed32(e,t){t.length&&this.writeMessage(e,jv,t)}writePackedFixed64(e,t){t.length&&this.writeMessage(e,qv,t)}writePackedSFixed64(e,t){t.length&&this.writeMessage(e,Wv,t)}writeBytesField(e,t){this.writeTag(e,2),this.writeBytes(t)}writeFixed32Field(e,t){this.writeTag(e,5),this.writeFixed32(t)}writeSFixed32Field(e,t){this.writeTag(e,5),this.writeSFixed32(t)}writeFixed64Field(e,t){this.writeTag(e,1),this.writeFixed64(t)}writeSFixed64Field(e,t){this.writeTag(e,1),this.writeSFixed64(t)}writeVarintField(e,t){this.writeTag(e,0),this.writeVarint(t)}writeSVarintField(e,t){this.writeTag(e,0),this.writeSVarint(t)}writeStringField(e,t){this.writeTag(e,2),this.writeString(t)}writeFloatField(e,t){this.writeTag(e,5),this.writeFloat(t)}writeDoubleField(e,t){this.writeTag(e,1),this.writeDouble(t)}writeBooleanField(e,t){this.writeVarintField(e,+t)}}function Ov(e,t,n){return n?4294967296*t+(e>>>0):4294967296*(t>>>0)+(e>>>0)}function Fv(e,t,n){const i=t<=16383?1:t<=2097151?2:t<=268435455?3:Math.floor(Math.log(t)/(7*Math.LN2));n.realloc(i);for(let t=n.pos-1;t>=e;t--)n.buf[t+i]=n.buf[t]}function kv(e,t){for(let n=0;n<e.length;n++)t.writeVarint(e[n])}function Qv(e,t){for(let n=0;n<e.length;n++)t.writeSVarint(e[n])}function zv(e,t){for(let n=0;n<e.length;n++)t.writeFloat(e[n])}function Gv(e,t){for(let n=0;n<e.length;n++)t.writeDouble(e[n])}function Hv(e,t){for(let n=0;n<e.length;n++)t.writeBoolean(e[n])}function Vv(e,t){for(let n=0;n<e.length;n++)t.writeFixed32(e[n])}function jv(e,t){for(let n=0;n<e.length;n++)t.writeSFixed32(e[n])}function qv(e,t){for(let n=0;n<e.length;n++)t.writeFixed64(e[n])}function Wv(e,t){for(let n=0;n<e.length;n++)t.writeSFixed64(e[n])}function Yv(e,t){this.x=e,this.y=t}Yv.prototype={clone(){return new Yv(this.x,this.y)},add(e){return this.clone()._add(e)},sub(e){return this.clone()._sub(e)},multByPoint(e){return this.clone()._multByPoint(e)},divByPoint(e){return this.clone()._divByPoint(e)},mult(e){return this.clone()._mult(e)},div(e){return this.clone()._div(e)},rotate(e){return this.clone()._rotate(e)},rotateAround(e,t){return this.clone()._rotateAround(e,t)},matMult(e){return this.clone()._matMult(e)},unit(){return this.clone()._unit()},perp(){return this.clone()._perp()},round(){return this.clone()._round()},mag(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals(e){return this.x===e.x&&this.y===e.y},dist(e){return Math.sqrt(this.distSqr(e))},distSqr(e){const t=e.x-this.x,n=e.y-this.y;return t*t+n*n},angle(){return Math.atan2(this.y,this.x)},angleTo(e){return Math.atan2(this.y-e.y,this.x-e.x)},angleWith(e){return this.angleWithSep(e.x,e.y)},angleWithSep(e,t){return Math.atan2(this.x*t-this.y*e,this.x*e+this.y*t)},_matMult(e){const t=e[0]*this.x+e[1]*this.y,n=e[2]*this.x+e[3]*this.y;return this.x=t,this.y=n,this},_add(e){return this.x+=e.x,this.y+=e.y,this},_sub(e){return this.x-=e.x,this.y-=e.y,this},_mult(e){return this.x*=e,this.y*=e,this},_div(e){return this.x/=e,this.y/=e,this},_multByPoint(e){return this.x*=e.x,this.y*=e.y,this},_divByPoint(e){return this.x/=e.x,this.y/=e.y,this},_unit(){return this._div(this.mag()),this},_perp(){const e=this.y;return this.y=this.x,this.x=-e,this},_rotate(e){const t=Math.cos(e),n=Math.sin(e),i=t*this.x-n*this.y,r=n*this.x+t*this.y;return this.x=i,this.y=r,this},_rotateAround(e,t){const n=Math.cos(e),i=Math.sin(e),r=t.x+n*(this.x-t.x)-i*(this.y-t.y),s=t.y+i*(this.x-t.x)+n*(this.y-t.y);return this.x=r,this.y=s,this},_round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},constructor:Yv},Yv.convert=function(e){if(e instanceof Yv)return e;if(Array.isArray(e))return new Yv(+e[0],+e[1]);if(void 0!==e.x&&void 0!==e.y)return new Yv(+e.x,+e.y);throw new Error("Expected [x, y] or {x, y} point format")};class Xv{constructor(e,t,n,i,r){this.properties={},this.extent=n,this.type=0,this.id=void 0,this._pbf=e,this._geometry=-1,this._keys=i,this._values=r,e.readFields(Kv,this,t)}loadGeometry(){const e=this._pbf;e.pos=this._geometry;const t=e.readVarint()+e.pos,n=[];let i,r=1,s=0,a=0,o=0;for(;e.pos<t;){if(s<=0){const t=e.readVarint();r=7&t,s=t>>3}if(s--,1===r||2===r)a+=e.readSVarint(),o+=e.readSVarint(),1===r&&(i&&n.push(i),i=[]),i&&i.push(new Yv(a,o));else{if(7!==r)throw new Error(`unknown command ${r}`);i&&i.push(i[0].clone())}}return i&&n.push(i),n}bbox(){const e=this._pbf;e.pos=this._geometry;const t=e.readVarint()+e.pos;let n=1,i=0,r=0,s=0,a=1/0,o=-1/0,l=1/0,c=-1/0;for(;e.pos<t;){if(i<=0){const t=e.readVarint();n=7&t,i=t>>3}if(i--,1===n||2===n)r+=e.readSVarint(),s+=e.readSVarint(),r<a&&(a=r),r>o&&(o=r),s<l&&(l=s),s>c&&(c=s);else if(7!==n)throw new Error(`unknown command ${n}`)}return[a,l,o,c]}toGeoJSON(e,t,n){const i=this.extent*Math.pow(2,n),r=this.extent*e,s=this.extent*t,a=this.loadGeometry();function o(e){return[360*(e.x+r)/i-180,360/Math.PI*Math.atan(Math.exp((1-2*(e.y+s)/i)*Math.PI))-90]}function l(e){return e.map(o)}let c;if(1===this.type){const e=[];for(const t of a)e.push(t[0]);const t=l(e);c=1===e.length?{type:"Point",coordinates:t[0]}:{type:"MultiPoint",coordinates:t}}else if(2===this.type){const e=a.map(l);c=1===e.length?{type:"LineString",coordinates:e[0]}:{type:"MultiLineString",coordinates:e}}else{if(3!==this.type)throw new Error("unknown feature type");{const e=function(e){const t=e.length;if(t<=1)return[e];const n=[];let i,r;for(let s=0;s<t;s++){const t=Jv(e[s]);0!==t&&(void 0===r&&(r=t<0),r===t<0?(i&&n.push(i),i=[e[s]]):i&&i.push(e[s]))}return i&&n.push(i),n}(a),t=[];for(const n of e)t.push(n.map(l));c=1===t.length?{type:"Polygon",coordinates:t[0]}:{type:"MultiPolygon",coordinates:t}}}const h={type:"Feature",geometry:c,properties:this.properties};return null!=this.id&&(h.id=this.id),h}}function Kv(e,t,n){1===e?t.id=n.readVarint():2===e?function(e,t){const n=e.readVarint()+e.pos;for(;e.pos<n;){const n=t._keys[e.readVarint()],i=t._values[e.readVarint()];t.properties[n]=i}}(n,t):3===e?t.type=n.readVarint():4===e&&(t._geometry=n.pos)}function Jv(e){let t=0;for(let n,i,r=0,s=e.length,a=s-1;r<s;a=r++)n=e[r],i=e[a],t+=(i.x-n.x)*(n.y+i.y);return t}Xv.types=["Unknown","Point","LineString","Polygon"];class $v{constructor(e,t){this.version=1,this.name="",this.extent=4096,this.length=0,this._pbf=e,this._keys=[],this._values=[],this._features=[],e.readFields(Zv,this,t),this.length=this._features.length}feature(e){if(e<0||e>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[e];const t=this._pbf.readVarint()+this._pbf.pos;return new Xv(this._pbf,t,this.extent,this._keys,this._values)}}function Zv(e,t,n){15===e?t.version=n.readVarint():1===e?t.name=n.readString():5===e?t.extent=n.readVarint():2===e?t._features.push(n.pos):3===e?t._keys.push(n.readString()):4===e&&t._values.push(function(e){let t=null;const n=e.readVarint()+e.pos;for(;e.pos<n;){const n=e.readVarint()>>3;t=1===n?e.readString():2===n?e.readFloat():3===n?e.readDouble():4===n?e.readVarint64():5===n?e.readVarint():6===n?e.readSVarint():7===n?e.readBoolean():null}return t}(n))}class e_{constructor(e,t){this.layers=e.readFields(t_,{},t)}}function t_(e,t,n){if(3===e){const e=new $v(n,n.readVarint()+n.pos);e.length&&(t[e.name]=e)}}const n_=new It,i_=new It,r_=new Map,s_=new Map,a_=new up("EPSG:4326",-180,180,-90,90);r_.set("EPSG:4326",a_);const o_=a_.as("EPSG:3857");o_.clampSouthNorth(o_.west,o_.east),r_.set("EPSG:3857",o_);const l_=new It(1,1);function c_(e){const t=r_.get(e);if(!t)throw new Error(`The tile matrix set ${e} is not defined.`);const n=t.planarDimensions(i_),i=s_.get(e)??l_,r=!e.includes(":NI");return{epsg:e,globalExtent:t,globalDimension:n,sTs:i,isInverted:r}}function h_(e,t){const n=s_.get(e)||l_,i=2**t;return n_.set(i,i).multiply(n),n_}s_.set("EPSG:3857",l_),s_.set("EPSG:4326",new It(2,1));const u_=r_.get("EPSG:3857").planarDimensions(),d_=new sn(u_.x,u_.y,1),p_=new It,f_=new It;function m_(e,t,n,i){const r=i*2**n.z,s=i*n.x,a=i*n.y;return new Jd("EPSG:4326",360*(e+s)/r-180,360/Math.PI*Math.atan(Math.exp((180-360*(t+a)/r)*Math.PI/180))-90)}function g_(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=t.bindNewGeometry();const r=t.type===dy.POLYGON;n=n&&r,i.properties=e.properties;const s=e._pbf;s.pos=e._geometry;const a=s.readVarint()+s.pos;let o=1,l=0,c=0,h=0,u=0,d=0;for(;s.pos<a;){if(l<=0){const e=s.readVarint();o=7&e,l=e>>3}if(l--,1===o||2===o){c+=s.readSVarint(),h+=s.readSVarint(),1===o&&(u&&(n&&d>0&&i.indices.length>0&&(t.updateExtent(i),i=t.bindNewGeometry(),i.properties=e.properties),i.closeSubGeometry(u,t),i.getLastSubGeometry().ccw=d<0),u=0,d=0),u++;const a=m_(c,h,e.tileNumbers,e.extent);i.pushCoordinatesValues(t,{x:c,y:h},a),1==u?(f_.set(c,h),f_.coordProj=a,p_.set(c,h)):r&&u>1&&(d+=(p_.x-c)*(p_.y+h),p_.set(c,h))}else{if(7!==o)throw new Error(`unknown command ${o}`);u&&(u++,i.pushCoordinatesValues(t,{x:f_.x,y:f_.y},f_.coordProj),r&&(d+=(p_.x-f_.x)*(p_.y+f_.y)))}}u&&(n&&d>0&&i.indices.length>0&&(t.updateExtent(i),i=t.bindNewGeometry(),i.properties=e.properties),i.closeSubGeometry(u,t),i.getLastSubGeometry().ccw=d<0),t.updateExtent(i)}const A_={parse:(e,t)=>(t=by(t),Promise.resolve(function(e,t){t.out=t.out||{};const n=new e_(new Uv(e)),i=Object.keys(n.layers),r=new Ey(t.out);if(i.length<1)return Promise.resolve(r);const s=t.extent.col,a=t.extent.zoom,o=t.in.isInverted?t.extent.row:(1<<a)-t.extent.row-1,l=n.layers[i[0]],c=l.extent*2**a,h=-.5*c;return r.scale.set(d_.x/c,-d_.y/c,1),r.position.set(l.extent*s+h,l.extent*o+h,0).multiply(r.scale),r.updateMatrixWorld(),i.forEach((e=>{if(!t.in.layers[e])return Promise.resolve(r);const i=n.layers[e];for(let n=i.length-1;n>=0;n--){const o=i.feature(n);o.tileNumbers={x:s,y:t.extent.row,z:a};const l=t.in.layers[e].filter((e=>e.filterExpression.filter({zoom:a},o)));for(const e of l){const n=r.requestFeatureById(e.id,o.type-1);n.id=e.id,n.order=e.order,n.style=t.in.styles[n.id],g_(o,n)}}})),r.removeEmptyFeature(),r.features.sort(((e,t)=>e.order-t.order)),r.updateExtent(),r.extent=t.extent,r.isInverted=t.in.isInverted,Promise.resolve(r)}(e,t)))},y_=new Kl;function v_(e){if(!e.ok){const t=new Error(`Error loading ${e.url}: status ${e.status}`);throw t.response=e,t}}const __=function(e){return fetch(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:{}).then((e=>(v_(e),e.arrayBuffer())))},x_={text(e){return fetch(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:{}).then((e=>(v_(e),e.text())))},json(e){return fetch(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:{}).then((e=>(v_(e),e.json())))},xml(e){return fetch(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:{}).then((e=>(v_(e),e.text()))).then((e=>(new window.DOMParser).parseFromString(e,"text/xml")))},texture(e){let t,n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};y_.crossOrigin=i.crossOrigin;const r=new Promise(((e,i)=>{t=e,n=i}));return y_.load(e,t,(()=>{}),(t=>{const i=new Error(`Failed to load texture from URL: \`${e}\``);i.originalEvent=t,n(i)})),r},arrayBuffer:__,textureFloat(e){return __(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:{}).then((t=>{if(t.byteLength!==65536*Float32Array.BYTES_PER_ELEMENT)throw new Error(`Invalid float data from URL: \`${e}\``);const n=new Float32Array(t),i=new Po(n,256,256,ue,ee);return i.internalFormat="R32F",i.needsUpdate=!0,i}))},multiple(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const i=[];let r;for(const s in t){if(!this[s])throw new Error(`${s} is not a valid Fetcher method.`);for(const a of t[s])r=`${e}.${a}`,i.push(this[s](r,n).then((e=>({type:a,result:e}))))}return Promise.all(i).then((e=>{const t={};for(const n of e)t[n.type]=n.result;return Promise.resolve(t)}))},get(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";const[t,n]=e.split("/");switch(t){case"application":switch(n){case"geo+json":case"json":return this.json;case"kml":case"gpx":return this.xml;case"x-protobuf;type=mapbox-vector":case"gtx":return this.arrayBuffer;default:return this.text}case"image":return"x-bil;bits=32"===n?this.textureFloat:this.texture;default:return this.texture}}},E_="object"==typeof performance&&performance&&"function"==typeof performance.now?performance:Date,b_=new Set,w_="object"==typeof process&&process?process:{},M_=(e,t,n,i)=>{"function"==typeof w_.emitWarning?w_.emitWarning(e,t,n,i):console.error(`[${n}] ${t}: ${e}`)};let S_=globalThis.AbortController,C_=globalThis.AbortSignal;if(void 0===S_){C_=class{onabort;_onabort=[];reason;aborted=!1;addEventListener(e,t){this._onabort.push(t)}},S_=class{constructor(){t()}signal=new C_;abort(e){if(!this.signal.aborted){this.signal.reason=e,this.signal.aborted=!0;for(const t of this.signal._onabort)t(e);this.signal.onabort?.(e)}}};let e="1"!==w_.env?.LRU_CACHE_IGNORE_AC_WARNING;const t=()=>{e&&(e=!1,M_("AbortController is not defined. If using lru-cache in node 14, load an AbortController polyfill from the `node-abort-controller` package. A minimal polyfill is provided for use by LRUCache.fetch(), but it should not be relied upon in other contexts (eg, passing it to other APIs that use AbortController/AbortSignal might have undesirable effects). You may disable this with LRU_CACHE_IGNORE_AC_WARNING=1 in the env.","NO_ABORT_CONTROLLER","ENOTSUP",t))}}Symbol("type");const T_=e=>e&&e===Math.floor(e)&&e>0&&isFinite(e),I_=e=>T_(e)?e<=Math.pow(2,8)?Uint8Array:e<=Math.pow(2,16)?Uint16Array:e<=Math.pow(2,32)?Uint32Array:e<=Number.MAX_SAFE_INTEGER?R_:null:null;class R_ extends Array{constructor(e){super(e),this.fill(0)}}class B_{heap;length;static#u=!1;static create(e){const t=I_(e);if(!t)return[];B_.#u=!0;const n=new B_(e,t);return B_.#u=!1,n}constructor(e,t){if(!B_.#u)throw new TypeError("instantiate Stack using Stack.create(n)");this.heap=new t(e),this.length=0}push(e){this.heap[this.length++]=e}pop(){return this.heap[--this.length]}}class L_{#d;#p;#f;#m;#g;#A;#y;ttl;ttlResolution;ttlAutopurge;updateAgeOnGet;updateAgeOnHas;allowStale;noDisposeOnSet;noUpdateTTL;maxEntrySize;sizeCalculation;noDeleteOnFetchRejection;noDeleteOnStaleGet;allowStaleOnFetchAbort;allowStaleOnFetchRejection;ignoreFetchAbort;#v;#_;#x;#E;#b;#w;#M;#S;#C;#T;#I;#R;#B;#L;#P;#D;#N;#U;static unsafeExposeInternals(e){return{starts:e.#B,ttls:e.#L,sizes:e.#R,keyMap:e.#x,keyList:e.#E,valList:e.#b,next:e.#w,prev:e.#M,get head(){return e.#S},get tail(){return e.#C},free:e.#T,isBackgroundFetch:t=>e.#O(t),backgroundFetch:(t,n,i,r)=>e.#F(t,n,i,r),moveToTail:t=>e.#k(t),indexes:t=>e.#Q(t),rindexes:t=>e.#z(t),isStale:t=>e.#G(t)}}get max(){return this.#d}get maxSize(){return this.#p}get calculatedSize(){return this.#_}get size(){return this.#v}get fetchMethod(){return this.#A}get memoMethod(){return this.#y}get dispose(){return this.#f}get onInsert(){return this.#m}get disposeAfter(){return this.#g}constructor(e){const{max:t=0,ttl:n,ttlResolution:i=1,ttlAutopurge:r,updateAgeOnGet:s,updateAgeOnHas:a,allowStale:o,dispose:l,onInsert:c,disposeAfter:h,noDisposeOnSet:u,noUpdateTTL:d,maxSize:p=0,maxEntrySize:f=0,sizeCalculation:m,fetchMethod:g,memoMethod:A,noDeleteOnFetchRejection:y,noDeleteOnStaleGet:v,allowStaleOnFetchRejection:_,allowStaleOnFetchAbort:x,ignoreFetchAbort:E}=e;if(0!==t&&!T_(t))throw new TypeError("max option must be a nonnegative integer");const b=t?I_(t):Array;if(!b)throw new Error("invalid max value: "+t);if(this.#d=t,this.#p=p,this.maxEntrySize=f||this.#p,this.sizeCalculation=m,this.sizeCalculation){if(!this.#p&&!this.maxEntrySize)throw new TypeError("cannot set sizeCalculation without setting maxSize or maxEntrySize");if("function"!=typeof this.sizeCalculation)throw new TypeError("sizeCalculation set to non-function")}if(void 0!==A&&"function"!=typeof A)throw new TypeError("memoMethod must be a function if defined");if(this.#y=A,void 0!==g&&"function"!=typeof g)throw new TypeError("fetchMethod must be a function if specified");if(this.#A=g,this.#D=!!g,this.#x=new Map,this.#E=new Array(t).fill(void 0),this.#b=new Array(t).fill(void 0),this.#w=new b(t),this.#M=new b(t),this.#S=0,this.#C=0,this.#T=B_.create(t),this.#v=0,this.#_=0,"function"==typeof l&&(this.#f=l),"function"==typeof c&&(this.#m=c),"function"==typeof h?(this.#g=h,this.#I=[]):(this.#g=void 0,this.#I=void 0),this.#P=!!this.#f,this.#U=!!this.#m,this.#N=!!this.#g,this.noDisposeOnSet=!!u,this.noUpdateTTL=!!d,this.noDeleteOnFetchRejection=!!y,this.allowStaleOnFetchRejection=!!_,this.allowStaleOnFetchAbort=!!x,this.ignoreFetchAbort=!!E,0!==this.maxEntrySize){if(0!==this.#p&&!T_(this.#p))throw new TypeError("maxSize must be a positive integer if specified");if(!T_(this.maxEntrySize))throw new TypeError("maxEntrySize must be a positive integer if specified");this.#H()}if(this.allowStale=!!o,this.noDeleteOnStaleGet=!!v,this.updateAgeOnGet=!!s,this.updateAgeOnHas=!!a,this.ttlResolution=T_(i)||0===i?i:1,this.ttlAutopurge=!!r,this.ttl=n||0,this.ttl){if(!T_(this.ttl))throw new TypeError("ttl must be a positive integer if specified");this.#V()}if(0===this.#d&&0===this.ttl&&0===this.#p)throw new TypeError("At least one of max, maxSize, or ttl is required");if(!this.ttlAutopurge&&!this.#d&&!this.#p){const e="LRU_CACHE_UNBOUNDED";(e=>!b_.has(e))(e)&&(b_.add(e),M_("TTL caching without ttlAutopurge, max, or maxSize can result in unbounded memory consumption.","UnboundedCacheWarning",e,L_))}}getRemainingTTL(e){return this.#x.has(e)?1/0:0}#V(){const e=new R_(this.#d),t=new R_(this.#d);this.#L=e,this.#B=t,this.#j=(n,i,r=E_.now())=>{if(t[n]=0!==i?r:0,e[n]=i,0!==i&&this.ttlAutopurge){const e=setTimeout((()=>{this.#G(n)&&this.#q(this.#E[n],"expire")}),i+1);e.unref&&e.unref()}},this.#W=n=>{t[n]=0!==e[n]?E_.now():0},this.#Y=(r,s)=>{if(e[s]){const a=e[s],o=t[s];if(!a||!o)return;r.ttl=a,r.start=o,r.now=n||i();const l=r.now-o;r.remainingTTL=a-l}};let n=0;const i=()=>{const e=E_.now();if(this.ttlResolution>0){n=e;const t=setTimeout((()=>n=0),this.ttlResolution);t.unref&&t.unref()}return e};this.getRemainingTTL=r=>{const s=this.#x.get(r);if(void 0===s)return 0;const a=e[s],o=t[s];return a&&o?a-((n||i())-o):1/0},this.#G=r=>{const s=t[r],a=e[r];return!!a&&!!s&&(n||i())-s>a}}#W=()=>{};#Y=()=>{};#j=()=>{};#G=()=>!1;#H(){const e=new R_(this.#d);this.#_=0,this.#R=e,this.#X=t=>{this.#_-=e[t],e[t]=0},this.#K=(e,t,n,i)=>{if(this.#O(t))return 0;if(!T_(n)){if(!i)throw new TypeError("invalid size value (must be positive integer). When maxSize or maxEntrySize is used, sizeCalculation or size must be set.");if("function"!=typeof i)throw new TypeError("sizeCalculation must be a function");if(n=i(t,e),!T_(n))throw new TypeError("sizeCalculation return invalid (expect positive integer)")}return n},this.#J=(t,n,i)=>{if(e[t]=n,this.#p){const n=this.#p-e[t];for(;this.#_>n;)this.#$(!0)}this.#_+=e[t],i&&(i.entrySize=n,i.totalCalculatedSize=this.#_)}}#X=e=>{};#J=(e,t,n)=>{};#K=(e,t,n,i)=>{if(n||i)throw new TypeError("cannot set size without setting maxSize or maxEntrySize on cache");return 0};*#Q({allowStale:e=this.allowStale}={}){if(this.#v)for(let t=this.#C;this.#Z(t)&&(!e&&this.#G(t)||(yield t),t!==this.#S);)t=this.#M[t]}*#z({allowStale:e=this.allowStale}={}){if(this.#v)for(let t=this.#S;this.#Z(t)&&(!e&&this.#G(t)||(yield t),t!==this.#C);)t=this.#w[t]}#Z(e){return void 0!==e&&this.#x.get(this.#E[e])===e}*entries(){for(const e of this.#Q())void 0===this.#b[e]||void 0===this.#E[e]||this.#O(this.#b[e])||(yield[this.#E[e],this.#b[e]])}*rentries(){for(const e of this.#z())void 0===this.#b[e]||void 0===this.#E[e]||this.#O(this.#b[e])||(yield[this.#E[e],this.#b[e]])}*keys(){for(const e of this.#Q()){const t=this.#E[e];void 0===t||this.#O(this.#b[e])||(yield t)}}*rkeys(){for(const e of this.#z()){const t=this.#E[e];void 0===t||this.#O(this.#b[e])||(yield t)}}*values(){for(const e of this.#Q())void 0===this.#b[e]||this.#O(this.#b[e])||(yield this.#b[e])}*rvalues(){for(const e of this.#z())void 0===this.#b[e]||this.#O(this.#b[e])||(yield this.#b[e])}[Symbol.iterator](){return this.entries()}[Symbol.toStringTag]="LRUCache";find(e,t={}){for(const n of this.#Q()){const i=this.#b[n],r=this.#O(i)?i.__staleWhileFetching:i;if(void 0!==r&&e(r,this.#E[n],this))return this.get(this.#E[n],t)}}forEach(e,t=this){for(const n of this.#Q()){const i=this.#b[n],r=this.#O(i)?i.__staleWhileFetching:i;void 0!==r&&e.call(t,r,this.#E[n],this)}}rforEach(e,t=this){for(const n of this.#z()){const i=this.#b[n],r=this.#O(i)?i.__staleWhileFetching:i;void 0!==r&&e.call(t,r,this.#E[n],this)}}purgeStale(){let e=!1;for(const t of this.#z({allowStale:!0}))this.#G(t)&&(this.#q(this.#E[t],"expire"),e=!0);return e}info(e){const t=this.#x.get(e);if(void 0===t)return;const n=this.#b[t],i=this.#O(n)?n.__staleWhileFetching:n;if(void 0===i)return;const r={value:i};if(this.#L&&this.#B){const e=this.#L[t],n=this.#B[t];if(e&&n){const t=e-(E_.now()-n);r.ttl=t,r.start=Date.now()}}return this.#R&&(r.size=this.#R[t]),r}dump(){const e=[];for(const t of this.#Q({allowStale:!0})){const n=this.#E[t],i=this.#b[t],r=this.#O(i)?i.__staleWhileFetching:i;if(void 0===r||void 0===n)continue;const s={value:r};if(this.#L&&this.#B){s.ttl=this.#L[t];const e=E_.now()-this.#B[t];s.start=Math.floor(Date.now()-e)}this.#R&&(s.size=this.#R[t]),e.unshift([n,s])}return e}load(e){this.clear();for(const[t,n]of e){if(n.start){const e=Date.now()-n.start;n.start=E_.now()-e}this.set(t,n.value,n)}}set(e,t,n={}){if(void 0===t)return this.delete(e),this;const{ttl:i=this.ttl,start:r,noDisposeOnSet:s=this.noDisposeOnSet,sizeCalculation:a=this.sizeCalculation,status:o}=n;let{noUpdateTTL:l=this.noUpdateTTL}=n;const c=this.#K(e,t,n.size||0,a);if(this.maxEntrySize&&c>this.maxEntrySize)return o&&(o.set="miss",o.maxEntrySizeExceeded=!0),this.#q(e,"set"),this;let h=0===this.#v?void 0:this.#x.get(e);if(void 0===h)h=0===this.#v?this.#C:0!==this.#T.length?this.#T.pop():this.#v===this.#d?this.#$(!1):this.#v,this.#E[h]=e,this.#b[h]=t,this.#x.set(e,h),this.#w[this.#C]=h,this.#M[h]=this.#C,this.#C=h,this.#v++,this.#J(h,c,o),o&&(o.set="add"),l=!1,this.#U&&this.#m?.(t,e,"add");else{this.#k(h);const n=this.#b[h];if(t!==n){if(this.#D&&this.#O(n)){n.__abortController.abort(new Error("replaced"));const{__staleWhileFetching:t}=n;void 0===t||s||(this.#P&&this.#f?.(t,e,"set"),this.#N&&this.#I?.push([t,e,"set"]))}else s||(this.#P&&this.#f?.(n,e,"set"),this.#N&&this.#I?.push([n,e,"set"]));if(this.#X(h),this.#J(h,c,o),this.#b[h]=t,o){o.set="replace";const e=n&&this.#O(n)?n.__staleWhileFetching:n;void 0!==e&&(o.oldValue=e)}}else o&&(o.set="update");this.#U&&this.onInsert?.(t,e,t===n?"update":"replace")}if(0===i||this.#L||this.#V(),this.#L&&(l||this.#j(h,i,r),o&&this.#Y(o,h)),!s&&this.#N&&this.#I){const e=this.#I;let t;for(;t=e?.shift();)this.#g?.(...t)}return this}pop(){try{for(;this.#v;){const e=this.#b[this.#S];if(this.#$(!0),this.#O(e)){if(e.__staleWhileFetching)return e.__staleWhileFetching}else if(void 0!==e)return e}}finally{if(this.#N&&this.#I){const e=this.#I;let t;for(;t=e?.shift();)this.#g?.(...t)}}}#$(e){const t=this.#S,n=this.#E[t],i=this.#b[t];return this.#D&&this.#O(i)?i.__abortController.abort(new Error("evicted")):(this.#P||this.#N)&&(this.#P&&this.#f?.(i,n,"evict"),this.#N&&this.#I?.push([i,n,"evict"])),this.#X(t),e&&(this.#E[t]=void 0,this.#b[t]=void 0,this.#T.push(t)),1===this.#v?(this.#S=this.#C=0,this.#T.length=0):this.#S=this.#w[t],this.#x.delete(n),this.#v--,t}has(e,t={}){const{updateAgeOnHas:n=this.updateAgeOnHas,status:i}=t,r=this.#x.get(e);if(void 0!==r){const e=this.#b[r];if(this.#O(e)&&void 0===e.__staleWhileFetching)return!1;if(!this.#G(r))return n&&this.#W(r),i&&(i.has="hit",this.#Y(i,r)),!0;i&&(i.has="stale",this.#Y(i,r))}else i&&(i.has="miss");return!1}peek(e,t={}){const{allowStale:n=this.allowStale}=t,i=this.#x.get(e);if(void 0===i||!n&&this.#G(i))return;const r=this.#b[i];return this.#O(r)?r.__staleWhileFetching:r}#F(e,t,n,i){const r=void 0===t?void 0:this.#b[t];if(this.#O(r))return r;const s=new S_,{signal:a}=n;a?.addEventListener("abort",(()=>s.abort(a.reason)),{signal:s.signal});const o={signal:s.signal,options:n,context:i},l=(i,r=!1)=>{const{aborted:a}=s.signal,l=n.ignoreFetchAbort&&void 0!==i;if(n.status&&(a&&!r?(n.status.fetchAborted=!0,n.status.fetchError=s.signal.reason,l&&(n.status.fetchAbortIgnored=!0)):n.status.fetchResolved=!0),a&&!l&&!r)return c(s.signal.reason);const u=h;return this.#b[t]===h&&(void 0===i?u.__staleWhileFetching?this.#b[t]=u.__staleWhileFetching:this.#q(e,"fetch"):(n.status&&(n.status.fetchUpdated=!0),this.set(e,i,o.options))),i},c=i=>{const{aborted:r}=s.signal,a=r&&n.allowStaleOnFetchAbort,o=a||n.allowStaleOnFetchRejection,l=o||n.noDeleteOnFetchRejection,c=h;if(this.#b[t]===h&&(l&&void 0!==c.__staleWhileFetching?a||(this.#b[t]=c.__staleWhileFetching):this.#q(e,"fetch")),o)return n.status&&void 0!==c.__staleWhileFetching&&(n.status.returnedStale=!0),c.__staleWhileFetching;if(c.__returned===c)throw i};n.status&&(n.status.fetchDispatched=!0);const h=new Promise(((t,i)=>{const a=this.#A?.(e,r,o);a&&a instanceof Promise&&a.then((e=>t(void 0===e?void 0:e)),i),s.signal.addEventListener("abort",(()=>{n.ignoreFetchAbort&&!n.allowStaleOnFetchAbort||(t(void 0),n.allowStaleOnFetchAbort&&(t=e=>l(e,!0)))}))})).then(l,(e=>(n.status&&(n.status.fetchRejected=!0,n.status.fetchError=e),c(e)))),u=Object.assign(h,{__abortController:s,__staleWhileFetching:r,__returned:void 0});return void 0===t?(this.set(e,u,{...o.options,status:void 0}),t=this.#x.get(e)):this.#b[t]=u,u}#O(e){if(!this.#D)return!1;const t=e;return!!t&&t instanceof Promise&&t.hasOwnProperty("__staleWhileFetching")&&t.__abortController instanceof S_}async fetch(e,t={}){const{allowStale:n=this.allowStale,updateAgeOnGet:i=this.updateAgeOnGet,noDeleteOnStaleGet:r=this.noDeleteOnStaleGet,ttl:s=this.ttl,noDisposeOnSet:a=this.noDisposeOnSet,size:o=0,sizeCalculation:l=this.sizeCalculation,noUpdateTTL:c=this.noUpdateTTL,noDeleteOnFetchRejection:h=this.noDeleteOnFetchRejection,allowStaleOnFetchRejection:u=this.allowStaleOnFetchRejection,ignoreFetchAbort:d=this.ignoreFetchAbort,allowStaleOnFetchAbort:p=this.allowStaleOnFetchAbort,context:f,forceRefresh:m=!1,status:g,signal:A}=t;if(!this.#D)return g&&(g.fetch="get"),this.get(e,{allowStale:n,updateAgeOnGet:i,noDeleteOnStaleGet:r,status:g});const y={allowStale:n,updateAgeOnGet:i,noDeleteOnStaleGet:r,ttl:s,noDisposeOnSet:a,size:o,sizeCalculation:l,noUpdateTTL:c,noDeleteOnFetchRejection:h,allowStaleOnFetchRejection:u,allowStaleOnFetchAbort:p,ignoreFetchAbort:d,status:g,signal:A};let v=this.#x.get(e);if(void 0===v){g&&(g.fetch="miss");const t=this.#F(e,v,y,f);return t.__returned=t}{const t=this.#b[v];if(this.#O(t)){const e=n&&void 0!==t.__staleWhileFetching;return g&&(g.fetch="inflight",e&&(g.returnedStale=!0)),e?t.__staleWhileFetching:t.__returned=t}const r=this.#G(v);if(!m&&!r)return g&&(g.fetch="hit"),this.#k(v),i&&this.#W(v),g&&this.#Y(g,v),t;const s=this.#F(e,v,y,f),a=void 0!==s.__staleWhileFetching&&n;return g&&(g.fetch=r?"stale":"refresh",a&&r&&(g.returnedStale=!0)),a?s.__staleWhileFetching:s.__returned=s}}async forceFetch(e,t={}){const n=await this.fetch(e,t);if(void 0===n)throw new Error("fetch() returned undefined");return n}memo(e,t={}){const n=this.#y;if(!n)throw new Error("no memoMethod provided to constructor");const{context:i,forceRefresh:r,...s}=t,a=this.get(e,s);if(!r&&void 0!==a)return a;const o=n(e,a,{options:s,context:i});return this.set(e,o,s),o}get(e,t={}){const{allowStale:n=this.allowStale,updateAgeOnGet:i=this.updateAgeOnGet,noDeleteOnStaleGet:r=this.noDeleteOnStaleGet,status:s}=t,a=this.#x.get(e);if(void 0!==a){const t=this.#b[a],o=this.#O(t);return s&&this.#Y(s,a),this.#G(a)?(s&&(s.get="stale"),o?(s&&n&&void 0!==t.__staleWhileFetching&&(s.returnedStale=!0),n?t.__staleWhileFetching:void 0):(r||this.#q(e,"expire"),s&&n&&(s.returnedStale=!0),n?t:void 0)):(s&&(s.get="hit"),o?t.__staleWhileFetching:(this.#k(a),i&&this.#W(a),t))}s&&(s.get="miss")}#ee(e,t){this.#M[t]=e,this.#w[e]=t}#k(e){e!==this.#C&&(e===this.#S?this.#S=this.#w[e]:this.#ee(this.#M[e],this.#w[e]),this.#ee(this.#C,e),this.#C=e)}delete(e){return this.#q(e,"delete")}#q(e,t){let n=!1;if(0!==this.#v){const i=this.#x.get(e);if(void 0!==i)if(n=!0,1===this.#v)this.#te(t);else{this.#X(i);const n=this.#b[i];if(this.#O(n)?n.__abortController.abort(new Error("deleted")):(this.#P||this.#N)&&(this.#P&&this.#f?.(n,e,t),this.#N&&this.#I?.push([n,e,t])),this.#x.delete(e),this.#E[i]=void 0,this.#b[i]=void 0,i===this.#C)this.#C=this.#M[i];else if(i===this.#S)this.#S=this.#w[i];else{const e=this.#M[i];this.#w[e]=this.#w[i];const t=this.#w[i];this.#M[t]=this.#M[i]}this.#v--,this.#T.push(i)}}if(this.#N&&this.#I?.length){const e=this.#I;let t;for(;t=e?.shift();)this.#g?.(...t)}return n}clear(){return this.#te("delete")}#te(e){for(const t of this.#z({allowStale:!0})){const n=this.#b[t];if(this.#O(n))n.__abortController.abort(new Error("deleted"));else{const i=this.#E[t];this.#P&&this.#f?.(n,i,e),this.#N&&this.#I?.push([n,i,e])}}if(this.#x.clear(),this.#b.fill(void 0),this.#E.fill(void 0),this.#L&&this.#B&&(this.#L.fill(0),this.#B.fill(0)),this.#R&&this.#R.fill(0),this.#S=0,this.#C=0,this.#T.length=0,this.#_=0,this.#v=0,this.#N&&this.#I){const e=this.#I;let t;for(;t=e?.shift();)this.#g?.(...t)}}}const P_=new Map([["application/geo+json",Py.parse],["application/json",Py.parse],["application/kml",Cv.parse],["application/gpx",Bv.parse],["application/x-protobuf;type=mapbox-vector",A_.parse],["application/gtx",Tv.parse],["application/isg",Lv.parse],["application/gdf",Rv.parse]]),D_={get:()=>{},set:e=>e,clear:()=>{}};let N_=0;const U_=class{constructor(e){if(e.projection&&(console.warn("Source projection parameter is deprecated, use crs instead."),e.crs=e.crs||e.projection),e.crs&&Hd(e.crs),this.crs=e.crs,this.isSource=!0,!e.url)throw new Error("New Source: url is required");this.uid=N_++,this.url=e.url,this.format=e.format,this.fetcher=e.fetcher||x_.get(e.format),this.parser=e.parser||P_.get(e.format)||((e,t)=>(e.extent=t.extent,e)),this.isVectorSource=null!=(e.parser||P_.get(e.format)),this.networkOptions=e.networkOptions||{crossOrigin:"anonymous"},this.attribution=e.attribution,this.whenReady=Promise.resolve(),this._featuresCaches={},e.extent&&!e.extent.isExtent?this.extent=new up(this.crs).setFromExtent(e.extent):this.extent=e.extent}handlingError(e){throw new Error(e)}urlFromExtent(){throw new Error("In extended Source, you have to implement the method urlFromExtent!")}getDataKey(e){return`z${e.zoom}r${e.row}c${e.col}`}loadData(e,t){const n=this._featuresCaches[t.crs],i=this.getDataKey(e);let r=n.get(i);return r||(r=this.fetcher(this.urlFromExtent(e),this.networkOptions).then((n=>this.parser(n,{out:t,in:this,extent:e}))).catch((e=>this.handlingError(e))),n.set(i,r)),r}onLayerAdded(e){this._featuresCaches[e.out.crs]||(this._featuresCaches[e.out.crs]=this.isVectorSource?new L_({max:500}):D_)}onLayerRemoved(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const t=this._featuresCaches[e.unusedCrs];t&&(t.clear(),delete this._featuresCaches[e.unusedCrs])}extentInsideLimit(){throw new Error("In extented Source, you have to implement the method extentInsideLimit!")}};function O_(e){let t,n,i,r=e.r||e[0]/255,s=e.g||e[1]/255,a=e.b||e[2]/255;return r=r>.04045?((r+.055)/1.055)**2.4:r/12.92,s=s>.04045?((s+.055)/1.055)**2.4:s/12.92,a=a>.04045?((a+.055)/1.055)**2.4:a/12.92,t=(.4124*r+.3576*s+.1805*a)/.95047,n=(.2126*r+.7152*s+.0722*a)/1,i=(.0193*r+.1192*s+.9505*a)/1.08883,t=t>.008856?t**(1/3):7.787*t+16/116,n=n>.008856?n**(1/3):7.787*n+16/116,i=i>.008856?i**(1/3):7.787*i+16/116,[116*n-16,500*(t-n),200*(n-i)]}function F_(e,t){const n=O_(e),i=O_(t),r=n[0]-i[0],s=n[1]-i[1],a=n[2]-i[2],o=Math.sqrt(n[1]*n[1]+n[2]*n[2]),l=o-Math.sqrt(i[1]*i[1]+i[2]*i[2]);let c=s*s+a*a-l*l;c=c<0?0:Math.sqrt(c);const h=r/1,u=l/(1+.045*o),d=c/(1+.015*o),p=h*h+u*u+d*d;return p<0?0:Math.sqrt(p)}const k_=new L_({max:500}),Q_=document.createElementNS("http://www.w3.org/2000/svg","svg").createSVGMatrix(),z_=document.createElement("canvas");function G_(e,t){return t?.coordinates?.z||0}function H_(e,t){if(e.expression)return e.expression.evaluate(t);if(e.stops){const n=e.stops;e=e.stops[0][1];for(let i=n.length-1;i>=0;i--){const r=n[i];if(t.zoom>=r[0]){e=r[1];break}}}return"string"==typeof e||e instanceof String?e.replace(/\{(.+?)\}/g,((e,n)=>t.properties[n]||"")).trim():e instanceof Function?e(t.properties,t):e}async function V_(e){const t=e.split("?")[0];let n=k_.get(t);return n||(n=x_.texture(e,{crossOrigin:"anonymous"}),k_.set(t,n)),(await n).image}function j_(e,t){const n=t.x||0,i=t.y||0,r=t.width||e.naturalWidth,s=t.height||e.naturalHeight;z_.width=r,z_.height=s;const a=z_.getContext("2d",{willReadFrequently:!0});return a.drawImage(e,n,i,r,s,0,0,r,s),a.getImageData(0,0,r,s)}const q_={left:[0,-.5],right:[-1,-.5],top:[-.5,0],bottom:[-.5,-1],"top-right":[-1,0],"bottom-left":[0,-1],"bottom-right":[-1,-1],center:[-.5,-.5],"top-left":[0,0]};function W_(e,t,n,i,r){let s;Object.defineProperty(e[t],n,{enumerable:!0,get:()=>{if(null!=s)return s;if(null!=i)return H_(i,e.context);const a=e.context.featureStyle?.[t]?.[n];return null!=a?H_(a,e.context):r instanceof Function?r(e.context.properties,e.context)??r:r},set:e=>{s=e}})}class Y_{#ne=(()=>new Jd("EPSG:4326",0,0,0))();#ie=(()=>new Jd("EPSG:4326",0,0,0))();#re=!0;#se={};#ae={};setZoom(e){this.zoom=e}setFeature(e){this.#se=e}setGeometry(e){this.#ae=e}setCollection(e){this.collection=e,this.#ie.setCrs(e.crs)}setLocalCoordinatesFromArray(e,t){return this.#re=!1,this.#ie.setFromArray(e,t)}get properties(){return this.#ae.properties}get type(){return this.#se.type}get featureStyle(){let e=this.#se.style;return e instanceof Function&&(e=e(this.properties,this)),e}get coordinates(){return this.#re||(this.#re=!0,this.#ne.copy(this.#ie).applyMatrix4(this.collection.matrixWorld),"EPSG:4978"!=this.#ie.crs)?this.#ne:this.#ne.as("EPSG:4326",this.#ne)}}const X_={itowns_stroke_single_before:".itowns-stroke-single:before {\n    display: var(--text_stroke_display);\n    content: attr(data-before);\n    opacity: 1;\n    position: absolute;\n    -webkit-text-stroke-width: var(--text_stroke_width);\n    -webkit-text-stroke-color: var(--text_stroke_color);\n    left: 0;\n    right: 0;\n    bottom: 0;\n    top: 0;\n    z-index: -1;\n    white-space: inherit;\n    overflow-wrap: inherit;\n    letter-spacing: inherit;\n    text-align: inherit;\n    padding: inherit;\n    font-family: inherit;\n    text-transform: inherit;\n    max-width: inherit;\n    font-size: inherit;\n}\n"},K_=document.createElement("style");K_.type="text/css",Object.keys(X_).forEach((e=>{K_.innerHTML+=`${X_[e]}\n\n`})),"undefined"!=typeof document&&document.getElementsByTagName("head")[0].appendChild(K_);const J_=class{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.isStyle=!0,this.context=new Y_,e.zoom=e.zoom||{},e.fill=e.fill||{},e.stroke=e.stroke||{},e.point=e.point||{},e.text=e.text||{},e.icon=e.icon||{},this.zoom={},W_(this,"zoom","min",e.zoom.min),W_(this,"zoom","max",e.zoom.max),this.fill={},W_(this,"fill","color",e.fill.color),W_(this,"fill","opacity",e.fill.opacity,1),W_(this,"fill","pattern",e.fill.pattern),W_(this,"fill","base_altitude",e.fill.base_altitude,G_),e.fill.extrusion_height&&W_(this,"fill","extrusion_height",e.fill.extrusion_height),this.stroke={},W_(this,"stroke","color",e.stroke.color),W_(this,"stroke","opacity",e.stroke.opacity,1),W_(this,"stroke","width",e.stroke.width,1),W_(this,"stroke","dasharray",e.stroke.dasharray,[]),W_(this,"stroke","base_altitude",e.stroke.base_altitude,G_),this.point={},W_(this,"point","color",e.point.color),W_(this,"point","line",e.point.line),W_(this,"point","opacity",e.point.opacity,1),W_(this,"point","radius",e.point.radius,2),W_(this,"point","width",e.point.width,0),W_(this,"point","base_altitude",e.point.base_altitude,G_),e.point.model&&W_(this,"point","model",e.point.model),this.text={},W_(this,"text","field",e.text.field),W_(this,"text","zOrder",e.text.zOrder,"auto"),W_(this,"text","color",e.text.color,"#000000"),W_(this,"text","anchor",e.text.anchor,"center"),W_(this,"text","offset",e.text.offset,[0,0]),W_(this,"text","padding",e.text.padding,2),W_(this,"text","size",e.text.size,16),W_(this,"text","placement",e.text.placement,"point"),W_(this,"text","rotation",e.text.rotation,"auto"),W_(this,"text","wrap",e.text.wrap,10),W_(this,"text","spacing",e.text.spacing,0),W_(this,"text","transform",e.text.transform,"none"),W_(this,"text","justify",e.text.justify,"center"),W_(this,"text","opacity",e.text.opacity,1),W_(this,"text","font",e.text.font,["Open Sans Regular","Arial Unicode MS Regular","sans-serif"]),W_(this,"text","haloColor",e.text.haloColor,"#000000"),W_(this,"text","haloWidth",e.text.haloWidth,0),W_(this,"text","haloBlur",e.text.haloBlur,0),this.icon={},W_(this,"icon","source",e.icon.source),e.icon.key&&(console.warn("'icon.key' is deprecated: use 'icon.id' instead"),e.icon.id=e.icon.key),W_(this,"icon","id",e.icon.id),W_(this,"icon","cropValues",e.icon.cropValues),W_(this,"icon","anchor",e.icon.anchor,"center"),W_(this,"icon","size",e.icon.size,1),W_(this,"icon","color",e.icon.color),W_(this,"icon","opacity",e.icon.opacity,1)}setContext(e){this.context=e}applyToCanvasPolygon(e,t,n,i){this.stroke.width>0&&this._applyStrokeToPolygon(e,n,t),i&&(this.fill.pattern||this.fill.color)&&this._applyFillToPolygon(e,n,t)}_applyStrokeToPolygon(e,t,n){e.strokeStyle!==this.stroke.color&&(e.strokeStyle=this.stroke.color);const i=this.stroke.width*t;e.lineWidth!==i&&(e.lineWidth=i);const r=this.stroke.opacity;r!==e.globalAlpha&&"number"==typeof r&&(e.globalAlpha=r),e.lineCap!==this.stroke.lineCap&&(e.lineCap=this.stroke.lineCap),e.setLineDash(this.stroke.dasharray.map((e=>e*t*2))),e.stroke(n)}async _applyFillToPolygon(e,t,n){if(this.fill.pattern){let n=this.fill.pattern;const i={...this.fill.pattern.cropValues};this.fill.pattern.source&&(n=await V_(this.fill.pattern.source)),j_(n,i),e.fillStyle=e.createPattern(z_,"repeat"),e.fillStyle.setTransform?e.fillStyle.setTransform(Q_.scale(t)):console.warn("Raster pattern isn't completely supported on Ie and edge",e.fillStyle)}else e.fillStyle!==this.fill.color&&(e.fillStyle=this.fill.color);this.fill.opacity!==e.globalAlpha&&(e.globalAlpha=this.fill.opacity),e.fill(n)}async applyToHTML(e){if(arguments.length>1&&console.warn("Deprecated argument sprites. Sprites must be configured in style."),e.style.padding=`${this.text.padding}px`,e.style.maxWidth=`${this.text.wrap}em`,e.style.color=this.text.color,this.text.size>0&&(e.style.fontSize=`${this.text.size}px`),e.style.fontFamily=this.text.font.join(","),e.style.textTransform=this.text.transform,e.style.letterSpacing=`${this.text.spacing}em`,e.style.textAlign=this.text.justify,e.style["white-space"]="pre-line",this.text.haloWidth>0&&(e.style.setProperty("--text_stroke_display","block"),e.style.setProperty("--text_stroke_width",`${this.text.haloWidth}px`),e.style.setProperty("--text_stroke_color",this.text.haloColor),e.setAttribute("data-before",e.textContent)),!this.icon.source)return;const t=document.createElement("img"),n=new Promise(((n,i)=>{const r={size:this.icon.size,color:this.icon.color,opacity:this.icon.opacity,anchor:this.icon.anchor};t.onload=()=>n(function(e,t,n){const i=e.cloneNode();switch(i.setAttribute("class","itowns-icon"),i.width=e.width*n.size,i.height=e.height*n.size,i.style.color=n.color,i.style.opacity=n.opacity,i.style.position="absolute",i.style.top="0",i.style.left="0",n.anchor){case"left":i.style.top=-.5*i.height+"px";break;case"right":i.style.top=-.5*i.height+"px",i.style.left=-i.width+"px";break;case"top":i.style.left=-.5*i.width+"px";break;case"bottom":i.style.top=-i.height+"px",i.style.left=-.5*i.width+"px";break;case"bottom-left":i.style.top=-i.height+"px";break;case"bottom-right":i.style.top=-i.height+"px",i.style.left=-i.width+"px";break;case"top-left":break;case"top-right":i.style.left=-i.width+"px";break;default:i.style.top=-.5*i.height+"px",i.style.left=-.5*i.width+"px"}return i.style["z-index"]=-1,t.appendChild(i),i}(t,e,r)),t.onerror=e=>i(e)}));if(this.icon.cropValues||this.icon.color){const e={...this.icon.cropValues},n=this.icon.color,i=this.icon.id||this.icon.source,r=function(e,t,n){if(!t)return e;const i=k_.get(`${n}_${t}`);if(!i){const i=e.data,r=new Ci(t),s=new Ci("white");for(let e=0,t=i.length;e<t;e+=4){const t=F_(i.slice(e,e+3),s)/100;i[e]=i[e]*t+255*r.r*(1-t),i[e+1]=i[e+1]*t+255*r.g*(1-t),i[e+2]=i[e+2]*t+255*r.b*(1-t)}return k_.set(`${n}_${t}`,e),e}return i}(j_(await V_(this.icon.source),e),n,i);z_.getContext("2d").putImageData(r,0,0),t.src=z_.toDataURL("image/png")}else t.src=this.icon.source;return n}getTextAnchorPosition(){return"string"==typeof this.text.anchor?Object.keys(q_).includes(this.text.anchor)?q_[this.text.anchor]:(console.error(`${this.text.anchor} is not a valid input for Style.text.anchor parameter.`),q_.center):this.text.anchor}},$_=class extends At{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const{source:n,name:i,style:r={},subdivisionThreshold:s=256,addLabelLayer:a=!1,cacheLifeTime:o,options:l={},updateStrategy:c,zoom:h,mergeFeatures:u=!0,crs:d}=t;if(super(),this.isLayer=!0,this.id=e,Object.defineProperty(this,"id",{writable:!1}),this.name=i,void 0===n||!0===n)throw new Error(`Layer ${e} needs Source`);this.source=n||new U_({url:"none"}),this.crs=d,!r||r instanceof J_?this.style=r||new J_:("string"==typeof r.fill?.pattern&&(console.warn("Using style.fill.pattern = { source: Img|url } is adviced"),r.fill.pattern={source:r.fill.pattern}),this.style=new J_(r)),this.subdivisionThreshold=s,this.sizeDiagonalTexture=(this.subdivisionThreshold*this.subdivisionThreshold*2)**.5,this.addLabelLayer=a,this.options=l,this.updateStrategy=c??{type:0,options:{}},this.defineLayerProperty("frozen",!1),this.zoom={min:h?.min??0,max:h?.max??1/0},this.info=new vf(this),this.ready=!1,this._promises=[],this.whenReady=new Promise(((e,t)=>{this._resolve=e,this._reject=t})).then((()=>(this.ready=!0,this.source.onLayerAdded({out:this}),this))),this._promises.push(this.source.whenReady),this.cache=new L_({max:500,...o!==1/0&&{ttl:o}}),this.mergeFeatures=u}addInitializationStep(){let e;return this._promises.push(new Promise((t=>{e=t}))),e}defineLayerProperty(e,t,n){const i=Object.getOwnPropertyDescriptor(this,e);if(!i||!i.set){let i=null==this[e]?t:this[e];Object.defineProperty(this,e,{get:()=>i,set:t=>{if(i!==t){const r={type:`${e}-property-changed`,previous:{},new:{}};r.previous[e]=i,r.new[e]=t,i=t,n&&n(this,e),this.dispatchEvent(r)}}})}}convert(e){return e}getData(e,t){const n=this.source.getDataKey(this.source.isVectorSource?t:e);let i=this.cache.get(n);return i||(i=this.source.loadData(e,this).then((e=>this.convert(e,t)),(e=>{throw e})),this.cache.set(n,i)),i}delete(){console.warn("Function delete doesn't exist for this layer")}},Z_=function(e){const t=Array.from(e);return t.sort(((e,t)=>e.sequence-t.sequence)),t.map((e=>e.id))},ex=new $t;function tx(e,t){let n;for(let i=0;i<=e;i++){const e=i*i;for(let r=-i;r<=i;r++){const s=r*r;for(let a=-i;a<=i;a++){const i=s+a*a;if(!(i>e||i<=n||!1!==t(r,a)))return}}n=e}}function nx(e){return e.layer?e.layer:e.parent?nx(e.parent):void 0}const ix=new bc,rx=new It,sx=new sn,ax=new Jd("EPSG:4978"),ox=new sn,lx=new Jd("EPSG:4978"),cx={pickTilesAt(e,t,n,i){let r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[];const s=function(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;const r=e.mainLoop.gfxEngine.getWindowSize();n=n||new It(Math.floor(r.x/2),Math.floor(r.y/2));const s=t.level0Nodes.map((e=>Jp(e,Kp.ID))),a=e.mainLoop.gfxEngine.renderViewToBuffer({camera:e.camera,scene:t.object3d},{x:n.x-i,y:n.y-i,width:1+2*i,height:1+2*i});s.forEach((e=>e()));const o=[];return tx(i,((e,t)=>{const n=4*(2*t*i+e),r=a.slice(n,n+4||void 0);ex.fromArray(r).divideScalar(255);const s=rf(ex,256**3),l=Math.round(s);o.includes(l)||o.push(l)})),o}(e,i,t,n),a=e=>{s.includes(e.id)&&e.isTileMesh&&r.push({object:e,layer:i})};for(const e of i.level0Nodes)e.traverse(a);return r},pickPointsAt(e,t,n,i){let r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[];if(!i.root)return;i.object3d.traverse((e=>{e.isPoints&&e.baseId&&e.material.enablePicking(!0)}));const s=e.mainLoop.gfxEngine.renderViewToBuffer({camera:e.camera,scene:i.object3d},{x:t.x-n,y:t.y-n,width:1+2*n,height:1+2*n}),a=[];return tx(n,((e,t)=>{const i=4*(2*t*n+e),r=s.slice(i,i+4),o={objId:r[0]<<8|r[1],index:r[2]<<8|r[3]};for(let e=0;e<a.length;e++)if(a[e].objId==o.objId&&a[e].index==o.index)return;a.push(o)})),i.object3d.traverse((t=>{if(t.isPoints&&t.baseId){t.material.enablePicking(!1);for(let n=0;n<a.length;n++)if(a[n].objId==t.baseId){sx.fromBufferAttribute(t.geometry.attributes.position,a[n].index),t.localToWorld(sx),ax.setCrs(e.referenceCrs),ax.setFromVector3(sx),e.camera3D.getWorldPosition(ox),lx.setCrs(e.referenceCrs),lx.setFromVector3(ox);const s=ax.spatialEuclideanDistanceTo(lx);r.push({object:t,point:sx.clone(),index:a[n].index,distance:s,layer:i})}}})),r},pickObjectsAt(e,t,n,i){let r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[];if(e.viewToNormalizedCoords(t,rx),n<0){ix.setFromCamera(rx,e.camera3D);const t=ix.intersectObject(i,!0);for(const e of t)e.layer=nx(e.object),r.push(e);return r}const s={x:t.x-n,y:t.y-n,width:1+2*n,height:1+2*n},a=e.mainLoop.gfxEngine.renderViewToBuffer({scene:i,camera:e.camera},s),o=new Ci;e.mainLoop.gfxEngine.renderer.getClearColor(o);const l=Math.round(255*o.r),c=Math.round(255*o.g),h=Math.round(255*o.b),u=rx.clone();return tx(n,((t,s)=>{const o=4*((s+n)*(2*n+1)+(t+n)),d=a[o],p=a[o+1],f=a[o+2];if(Math.abs(l-d)<=1&&Math.abs(c-p)<=1&&Math.abs(h-f)<=1)return;u.setX(rx.x+t/e.camera.width).setY(rx.y+s/e.camera.height),ix.setFromCamera(u,e.camera3D);const m=ix.intersectObject(i,!0);for(const e of m)e.layer=nx(e.object),r.push(e);return 0==r.length})),r}},hx={INFINITE:1/0,TEXTURE:9e5,GEOMETRY:9e5};function ux(e){e.dispose();for(const t of Object.keys(e)){const n=e[t];n&&n.isTexture&&n.dispose()}}const dx={cleanup(e){if(e.layer=null,e.isScene||"function"!=typeof e.dispose){if(e.geometry&&e.geometry.dispose(),e.material)if(Array.isArray(e.material))for(const t of e.material)ux(t);else ux(e.material);e.dispatchEvent({type:"dispose"})}else e.dispose()},removeChildren(e,t){const n=t.children.filter((t=>(t.layer&&t.layer.id)===e.id));return t.remove(...n),n},removeChildrenAndCleanup(e,t){const n=t.children.filter((t=>(t.layer&&t.layer.id)===e.id));return t.remove(...n),t.layer===e&&this.cleanup(t),n},removeChildrenAndCleanupRecursively(e,t){let n=t.children.filter((t=>t.layer&&t.layer.id===e.id));const i=t.link&&t.link[e.id];i?.children.length&&(n=n.concat(i.children),delete t.link[e.id]);for(const t of n)this.removeChildrenAndCleanupRecursively(e,t);return t.remove(...n),t.layer&&t.layer.id===e.id&&this.cleanup(t),n}},px=class extends $_{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const{cacheLifeTime:i=hx.GEOMETRY,visible:r=!0,opacity:s=1,...a}=n;if(super(e,{...a,cacheLifeTime:i}),this.isGeometryLayer=!0,!t||!t.isObject3D)throw new Error("Missing/Invalid object3d parameter (must be a\n                three.js Object3D instance)");"Group"===t.type&&""===t.name&&(t.name=e),this.object3d=t,Object.defineProperty(this,"object3d",{writable:!1,configurable:!0}),this.opacity=s,this.wireframe=!1,this.attachedLayers=[],this.visible=r,Object.defineProperty(this.zoom,"max",{value:1/0,writable:!1}),this.filteringExtent=!this.source.isFileSource,this.structure="3d"}get visible(){return this.object3d.visible}set visible(e){if(this.object3d.visible!==e){const t={type:"visible-property-changed",previous:{},new:{}};t.previous.visible=this.object3d.visible,t.new.visible=e,this.dispatchEvent(t),this.object3d.visible=e}}getObjectToUpdateForAttachedLayers(e){if(e.parent&&e.material)return{element:e,parent:e.parent}}postUpdate(){}culling(){return!0}attach(e){if(!e.update)throw new Error(`Missing 'update' function -> can't attach layer\n                ${e.id}`);this.attachedLayers.push(e),e.parent=this}detach(e){const t=this.attachedLayers.length;return this.attachedLayers=this.attachedLayers.filter((t=>t.id!=e.id)),e.parent=void 0,this.attachedLayers.length<t}delete(e){e&&this.cache.clear(),this.parent&&dx.removeChildrenAndCleanupRecursively(this,this.parent.object3d),this.object3d.parent&&this.object3d.parent.remove(this.object3d),dx.removeChildrenAndCleanupRecursively(this,this.object3d)}pickObjectsAt(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.options.defaultPickingRadius,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[];return cx.pickObjectsAt(e,t,n,this.object3d,i)}},fx=[1,3,7,60],mx=class{constructor(){this.state=0,this.lastErrorTimestamp=0,this.errorCount=0,this.failureParams={lowestLevelError:1/0}}hasFinished(){return 4==this.state}canTryUpdate(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Date.now();switch(this.state){case 0:return!0;case 3:case 1:case 4:return!1;default:return 1e3*this.secondsUntilNextTry()<=e-this.lastErrorTimestamp}}secondsUntilNextTry(){if(2!==this.state)return 0;const e=Math.max(0,Math.min(this.errorCount,fx.length)-1);return fx[e]}newTry(){this.state=1}success(){this.lastErrorTimestamp=0,this.state=0}noMoreUpdatePossible(){this.state=4}noData(e){this.state=0,this.failureParams.lowestLevelError=Math.min(e.targetLevel,this.failureParams.lowestLevelError)}failure(e,t,n){n&&null!=n.targetLevel&&(this.failureParams.lowestLevelError=Math.min(n.targetLevel,this.failureParams.lowestLevelError)),this.lastErrorTimestamp=e,this.state=t?3:2,this.errorCount++}inError(){return 3==this.state||2==this.state}};function gx(e){return e?.attachedLayers.filter((e=>e.isGeoidLayer))[0]?.visible}const Ax=new It,yx=new It,vx={row:0,col:0,invDiff:0};function _x(e,t){const n=2**(e.zoom-t);return vx.invDiff=1/n,vx.row=(e.row-e.row%n)*vx.invDiff,vx.col=(e.col-e.col%n)*vx.invDiff,vx}const xx=new up("EPSG:4326"),Ex=new up("EPSG:4326"),bx=new Jd("EPSG:4326",0,0);class wx{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;this.isTile=!0,this.crs=e,this.zoom=t,this.row=n,this.col=i}clone(){return new wx(this.crs,this.zoom,this.row,this.col)}toExtent(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new up("EPSG:4326");Hd(e);const{epsg:n,globalExtent:i,globalDimension:r}=c_(this.crs),s=h_(this.crs,this.zoom);return yx.set(1,1).divide(s).multiply(r),t.west=i.west+(r.x-yx.x*(s.x-this.col)),t.east=t.west+yx.x,t.south=i.south+yx.y*(s.y-this.row-1),t.north=t.south+yx.y,t.crs=n,e==n?t:t.as(e,t)}isInside(e){if(this.zoom==e.zoom)return this.row==e.row&&this.col==e.col;if(this.zoom<e.zoom)return!1;{const t=_x(this,e.zoom);return t.row==e.row&&t.col==e.col}}offsetToParent(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new $t;if(this.crs!=e.crs)throw new Error("unsupported mix");const n=_x(this,e.zoom);return t.set(this.col*n.invDiff-n.col,this.row*n.invDiff-n.row,n.invDiff,n.invDiff)}tiledExtentParent(e){if(e&&e<this.zoom){const t=_x(this,e);return new wx(this.crs,e,t.row,t.col)}return this}set(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return this.zoom=e,this.row=t,this.col=n,this}copy(e){return this.crs=e.crs,this.set(e.zoom,e.row,e.col)}toString(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return`${this.zoom}${e}${this.row}${e}${this.col}`}}function Mx(e,t){if("EPSG:4326"==e.crs&&"EPSG:3857"==t){const n=[],i=xx.copy(e).as(t,Ex),{globalExtent:r,globalDimension:s,sTs:a}=c_(t);i.clampByExtent(r),i.planarDimensions(yx);const o=Math.floor(Math.log2(Math.round(s.x/(yx.x*a.x)))),l=h_(t,o),c=i.center(bx);Ax.x=c.x-r.west,Ax.y=r.north-i.north,Ax.divide(s).multiply(l).floor();for(let e=Math.ceil((r.north-i.south)/s.x*l.y)-1;e>=Ax.y;e--)n.push(new wx(t,o,e,Ax.x));return n}{const n=new wx(t,0,0,0),{globalExtent:i,globalDimension:r,sTs:s,isInverted:a}=c_(e.crs),o=e.center(bx);e.planarDimensions(yx);const l=Math.floor(Math.log2(Math.round(r.x/(yx.x*s.x)))),c=h_(t,l);return Ax.x=o.x-i.west,Ax.y=a?i.north-o.y:o.y-i.south,Ax.divide(r).multiply(c).floor(),n.set(l,Ax.y,Ax.x),[n]}}const Sx=wx,Cx=class extends ir{#oe=(()=>new Map)();#le=!0;constructor(e,t,n,i){let r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0;if(super(e,t),!i)throw new Error("extent is mandatory to build a TileMesh");this.layer=n,this.extent=i,this.extent.zoom=r,this.level=r,this.material.objectId=this.id,this.obb=this.geometry.OBB.clone(),this.boundingSphere=new Sn,this.obb.box3D.getBoundingSphere(this.boundingSphere);for(const e of n.tileMatrixSets)this.#oe.set(e,Mx(this.extent,e));this.frustumCulled=!1,this.matrixAutoUpdate=!1,this.rotationAutoUpdate=!1,this.layerUpdateState={},this.isTileMesh=!0,this.geoidHeight=0,this.link={},Object.defineProperty(this,"visible",{get(){return this.#le},set(e){this.#le!=e&&(this.#le=e,this.dispatchEvent({type:e?"shown":"hidden"}))}})}setBBoxZ(e){e.geoidHeight=gx(this.layer)?this.geoidHeight:0,this.obb.updateZ(e),this.horizonCullingPointElevationScaled&&this.horizonCullingPointElevationScaled.setLength(this.obb.z.delta+this.horizonCullingPoint.length()),this.obb.box3D.getBoundingSphere(this.boundingSphere)}getExtentsByProjection(e){return this.#oe.get(e)}findCommonAncestor(e){if(e)return e.level==this.level?e.id==this.id?e:0!=e.level?this.parent.findCommonAncestor(e.parent):void 0:e.level<this.level?this.parent.findCommonAncestor(e):this.findCommonAncestor(e.parent)}onBeforeRender(){this.material.layersNeedUpdate&&this.material.updateLayersUniforms()}};function Tx(e,t){return 3*(e*e*2+(t?0:4*e*2))}function Ix(e,t,n,i){e[2*t+0]=n,e[2*t+1]=i}function Rx(e){return(t,n)=>{t[n]=e}}function Bx(e,t,n){const i=Math.max(2,t.segments),r=i+1,s=r**2,a=s+(t.disableSkirt?0:4*i);if(a>2**32)throw new Error("Tile segments count is too big");const o=function(e,t,n,i,r){const{index:s,skirt:a}=function(e,t,n,i){const r=Tx(t,n.disableSkirt),s=function(e){let t=null;if(e<256)t=Uint8Array;else if(e<65536)t=Uint16Array;else{if(!(e<2**32))throw new Error("Value is too high");t=Uint32Array}return t}(e),a=r,o=4*t;if(void 0!==i)return{index:i,skirt:i.subarray(a,a+o)};const l=new s(new ArrayBuffer((a+(n.disableSkirt?0:o))*s.BYTES_PER_ELEMENT)),c=n.disableSkirt?void 0:l.subarray(a,a+o);return{index:l,skirt:c}}(e,t,i,r?.index);return{index:s,skirt:a,position:new Float32Array(3*e),normal:new Float32Array(3*e),uvs:[r?.uv??new Float32Array(2*e),void 0!==n.computeExtraOffset?new Float32Array(e):void 0]}}(a,i,e,t,n),l=[void 0===n?Ix:()=>{}];t=e.prepare(t);for(let n=0;n<=i;n++){const s=n/i;t.coordinates.y=e.vProject(s,t.extent),void 0!==e.computeExtraOffset&&(l[1]=Rx(e.computeExtraOffset(t)));for(let a=0;a<=i;a++){const c=a/i,h=3*(n*r+a);t.coordinates.x=e.uProject(c,t.extent);const u=e.vertexPosition(t.coordinates),d=e.vertexNormal();if(u.sub(t.center),"quatNormalToZ"in t){const e=t.quatNormalToZ;u.applyQuaternion(e),d.applyQuaternion(e)}u.toArray(o.position,h),d.toArray(o.normal,h);for(const[e,t]of l.entries())void 0!==t&&t(o.uvs[e],n*r+a,c,s)}}if(void 0===n&&!t.disableSkirt){for(let e=0;e<r;e++)o.skirt[e]=e,o.skirt[2*r-2+e]=r**2-(e+1);for(let e=1;e<r-1;e++)o.skirt[r-1+e]=e*r+(r-1),o.skirt[3*r-3+e]=r*(r-1-e)}function c(e,t,n,i){o.index[e+0]=t,o.index[e+1]=n,o.index[e+2]=i}if(void 0===n)for(let e=0;e<i;e++)for(let t=0;t<i;t++){const n=e*r+t,s=(e+1)*r+t,a=(e+1)*r+(t+1),o=6*(e*i+t);c(o,a,n,e*r+(t+1)),c(o+3,a,s,n)}if(!t.disableSkirt){const e=(new sn).fromArray(o.position).distanceTo((new sn).fromArray(o.position,3)),t=void 0===n?{index:(e,t,n,i,r)=>(c(e,t,n,i),c(e+3,t,i,r),e+6),uv:(e,t,n)=>{e[2*t+0]=e[2*n+0],e[2*t+1]=e[2*n+1]}}:{index:()=>{},uv:()=>{}},r=s;for(let n=0;n<o.skirt.length;n++){const s=o.skirt[n],a=3*(r+n),l=3*s;o.position[a+0]=o.position[l+0]-o.normal[l+0]*e,o.position[a+1]=o.position[l+1]-o.normal[l+1]*e,o.position[a+2]=o.position[l+2]-o.normal[l+2]*e,o.normal[a+0]=o.normal[l+0],o.normal[a+1]=o.normal[l+1],o.normal[a+2]=o.normal[l+2],t.uv(o.uvs[0],r+n,s),void 0!==o.uvs[1]&&(o.uvs[1][r+n]=o.uvs[1][s]);const c=(n+1)%o.skirt.length,h=r+n,u=0===c?r:r+n+1,d=o.skirt[c];t.index(6*i**2+6*n,s,h,u,d)}}return{index:o.index,position:o.position,uvs:o.uvs,normal:o.normal}}class Lx extends ji{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(e,t){const n={disableSkirt:!1,hideSkirt:!1,buildIndexAndUv_0:!0,segments:16,coordinates:new Jd(e.crs),center:e.center(t.extent).clone(),...t},i=Bx(e,n);return{index:i.index?new Di(i.index,1):null,uvs:[...i.uvs[0]?[new Di(i.uvs[0],2)]:[],...i.uvs[1]?[new Di(i.uvs[1],1)]:[]],position:new Di(i.position,3),normal:new Di(i.normal,3)}}(e,t);super(),this.extent=t.extent,this.segments=t.segments,this.setIndex(n.index),this.setAttribute("position",n.position),this.setAttribute("normal",n.normal),this.setAttribute("uv",n.uvs[0]);for(let e=1;e<n.uvs.length;e++)this.setAttribute(`uv_${e}`,n.uvs[e]);this.computeBoundingBox(),this.OBB=null,t.hideSkirt&&(this.hideSkirt=t.hideSkirt),this._refCount=null}set hideSkirt(e){this.setDrawRange(0,Tx(this.segments,e))}initRefCount(e,t){null===this._refCount&&(this._refCount={count:0,fn:()=>{this._refCount.count--,this._refCount.count<=0&&(this.index=null,delete this.attributes.uv,e.delete(t),super.dispose())}})}increaseRefCount(){if(null===this._refCount)throw new Error("[TileGeometry::increaseRefCount] Tried to increment an unitialized reference count.");this._refCount.count++}get refCount(){return this._refCount?.count}dispose(){null==this._refCount?super.dispose():this._refCount.fn()}}const Px=Math.PI/4,Dx=1/(2*Math.PI),Nx=new sn(0,0,1),Ux=new sn(0,1,0),Ox=new rn,Fx=new rn,kx=new rn;function Qx(e){return 1-(.5-Math.log(Math.tan(Px+.5*Tt.degToRad(e)))*Dx)}class zx{static _crs="EPSG:4978";static _computeExtraOffset(e){const t=Qx(e.coordinates.latitude)*e.nbRow;return(isFinite(t)?t:0)-e.deltaUV1}get crs(){return zx._crs}constructor(e){this._transform={coords:[new Jd("EPSG:4326",0,0),new Jd("EPSG:4326",0,0)],position:new sn,dimension:new It},e.uvCount>1&&(this.computeExtraOffset=zx._computeExtraOffset)}prepare(e){const t=2**(e.level+1);let n=Qx(e.extent.south);isFinite(n)||(n=0);const i={nbRow:t,deltaUV1:(n-n%(1/t))*t,quatNormalToZ:kx.setFromAxisAngle(Ux,-(.5*Math.PI-Tt.degToRad(e.extent.center().latitude))),coordinates:new Jd(this.crs)};return e.extent.planarDimensions(this._transform.dimension),{...e,...i}}center(e){return e.center(this._transform.coords[0]).as(this.crs,this._transform.coords[1]).toVector3()}vertexPosition(e){return this._transform.coords[0].setFromValues(e.x,e.y).as(this.crs,this._transform.coords[1]).toVector3(this._transform.position)}vertexNormal(){return this._transform.coords[1].geodesicNormal}uProject(e,t){return t.west+e*this._transform.dimension.x}vProject(e,t){return t.south+e*this._transform.dimension.y}computeShareableExtent(e){const t=Math.abs(e.west-e.east)/2,n=new up(e.crs,-t,t,e.south,e.north),i=Tt.degToRad(e.west-n.west),r=Tt.degToRad(90-e.center(this._transform.coords[0]).latitude);return Ox.setFromAxisAngle(Nx,i),Fx.setFromAxisAngle(Ux,r),Ox.multiply(Fx),{shareableExtent:n,quaternion:Ox.clone(),position:this.center(e)}}}const Gx=new zx({uvCount:1}),Hx=new sn,Vx=new It,jx=new sn,qx=new Jd("EPSG:4326",0,0,0);let Wx;class Yx extends li{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new sn(1/0,1/0,1/0),t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new sn(-1/0,-1/0,-1/0);super(),this.box3D=new ln(e.clone(),t.clone()),this.natBox=this.box3D.clone(),this.z={min:0,max:0,scale:1}}clone(){return(new Yx).copy(this)}copy(e){return super.copy(e),this.box3D.copy(e.box3D),this.natBox.copy(e.natBox),this.z.min=e.z.min,this.z.max=e.z.max,this.z.scale=e.z.scale,this}updateZ(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.z.min=e.min??this.z.min,this.z.max=e.max??this.z.max,this.z.scale=e.scale>0?e.scale:this.z.scale,this.z.delta=Math.abs(this.z.max-this.z.min)*this.z.scale;const t=e.geoidHeight||0;this.box3D.min.z=this.natBox.min.z+this.z.min*this.z.scale+t,this.box3D.max.z=this.natBox.max.z+this.z.max*this.z.scale+t}isSphereAboveXYBox(e){const t=this.worldToLocal(e.center),n=Math.max(this.box3D.min.x,Math.min(t.x,this.box3D.max.x)),i=Math.max(this.box3D.min.y,Math.min(t.y,this.box3D.max.y));return Math.sqrt((n-t.x)*(n-t.x)+(i-t.y)*(i-t.y))<e.radius}setFromExtent(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.min||0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.max||0;if("EPSG:4326"==e.crs){const{shareableExtent:i,quaternion:r,position:s}=Gx.computeShareableExtent(e),a=Math.max(Math.floor(i.planarDimensions(Vx).x/90+1),2),o=new Lx(Gx,{extent:i,level:0,segments:a,disableSkirt:!0});Wx.box3D.copy(o.boundingBox),Wx.natBox.copy(o.boundingBox),this.copy(Wx),this.updateZ({min:t,max:n}),this.position.copy(s),this.quaternion.copy(r),this.updateMatrixWorld(!0)}else{if(!zd(e.crs))throw new Error("Unsupported extent crs");e.center(qx).toVector3(this.position),e.planarDimensions(Vx),Hx.set(Vx.x,Vx.y,Math.abs(n-t)),this.box3D.setFromCenterAndSize(jx,Hx),this.updateMatrixWorld(!0)}return this}}Wx=new Yx;const Xx=Yx,Kx=new Map,Jx=new L_({max:500}),$x=function(e,t){if(t&&t.isGeometryLayer){let n=e.transparent;e.layer=t,e.uniforms&&null!=e.uniforms.opacity?Object.defineProperty(e.uniforms.opacity,"value",{get:()=>e.layer.opacity}):null!=e.opacity&&Object.defineProperty(e,"opacity",{get:()=>e.layer.opacity}),e.uniforms&&null!=e.uniforms.mode&&Object.defineProperty(e.uniforms.mode,"value",{get:()=>e.layer.pntsMode}),e.uniforms&&null!=e.uniforms.shape&&Object.defineProperty(e.uniforms.shape,"value",{get:()=>e.layer.pntsShape}),e.uniforms&&null!=e.uniforms.sizeMode&&Object.defineProperty(e.uniforms.sizeMode,"value",{get:()=>e.layer.pntsSizeMode}),e.uniforms&&null!=e.uniforms.minAttenuatedSize&&Object.defineProperty(e.uniforms.minAttenuatedSize,"value",{get:()=>e.layer.pntsMinAttenuatedSize}),e.uniforms&&null!=e.uniforms.maxAttenuatedSize&&Object.defineProperty(e.uniforms.maxAttenuatedSize,"value",{get:()=>e.layer.pntsMaxAttenuatedSize}),e.uniforms&&null!=e.uniforms.scale&&Object.defineProperty(e.uniforms.scale,"value",{get:()=>e.layer.scale}),Object.defineProperty(e,"wireframe",{get:()=>e.layer.wireframe}),Object.defineProperty(e,"transparent",{get:()=>{const t=e.userData.needTransparency?.[e.mode]||e.layer.opacity<1;return n!=t&&(e.needsUpdate=!0,n=t),n}})}return e},Zx=new It,eE={convert(e,t,n){const i=n.builder,r=e,s=void 0!==r?r.level+1:0,a={extent:t,level:s,segments:n.segments||16,disableSkirt:n.disableSkirt,hideSkirt:n.hideSkirt};return function(e,t){const{shareableExtent:n,quaternion:i,position:r}=e.computeShareableExtent(t.extent),s=n.south.toFixed(6),a=`${e.crs}_${t.disableSkirt?0:1}_${t.segments}`,o=`s${s}l${t.level}bK${a}`;let l=Jx.get(o);if(!l){let s;l=new Promise((e=>{s=e})),Jx.set(o,l),t.extent=n,t.center=e.center(t.extent).clone();let c,h=Kx.get(a);try{c=Bx(e,t,void 0!==h?{index:h.index.array,uv:h.uv.array}:void 0)}catch(e){return Promise.reject(e)}h||(h={index:new Di(c.index,1),uv:new Di(c.uvs[0],2)},Kx.set(a,h));const u={index:h.index,uvs:[h.uv,...void 0!==c.uvs[1]?[new Di(c.uvs[1],1)]:[]],position:new Di(c.position,3),normal:new Di(c.normal,3)},d=new Lx(e,t,u);return d.OBB=new Xx(d.boundingBox.min,d.boundingBox.max),d.initRefCount(Jx,o),s(d),Promise.resolve({geometry:d,quaternion:i,position:r})}return l.then((e=>({geometry:e,quaternion:i,position:r})))}(i,a).then((e=>{e.geometry.increaseRefCount();const a=n.tileMatrixSets.length,o=new uf(n.materialOptions,a);$x(o,n);const l=new Cx(e.geometry,o,n,t,s);if(r&&r.isTileMesh){const t=i.computeShareableExtent(r.extent);e.position.sub(t.position).applyQuaternion(t.quaternion.invert()),e.quaternion.premultiply(t.quaternion)}if(l.position.copy(e.position),l.quaternion.copy(e.quaternion),l.visible=!1,l.updateMatrix(),function(e,t){if(t.diffuse&&(e.material.diffuse=t.diffuse),t.isGlobeLayer){e.horizonCullingPoint=e.extent.center().as("EPSG:4978").toVector3(),e.extent.planarDimensions(Zx).multiplyScalar(Tt.DEG2RAD);const t=Zx.length(),n=Math.abs(1/Math.cos(.5*t));e.horizonCullingPoint.setLength(n*e.horizonCullingPoint.length()),e.horizonCullingPointElevationScaled=e.horizonCullingPoint.clone()}}(l,n),r){l.geoidHeight=r.geoidHeight;const e=gx(n)?l.geoidHeight:0;l.setBBoxZ({min:r.obb.z.min,max:r.obb.z.max,geoidHeight:e}),l.material.geoidHeight=e}return l}))}},tE=new sn,nE=new sn;class iE extends px{constructor(e,t,n,i,r){const{sseSubdivisionThreshold:s=1,minSubdivisionLevel:a,maxSubdivisionLevel:o,maxDeltaElevationLevel:l,tileMatrixSets:c,diffuse:h,showOutline:u=!1,segments:d,disableSkirt:p=!1,materialOptions:f,...m}=r;if(super(e,t,{...m,cacheLifeTime:hx.INFINITE,source:!1}),this.isTiledGeometryLayer=!0,this.protocol="tile",this.object3d.geoidHeight=0,this.disableSkirt=p,this._hideSkirt=!!r.hideSkirt,this.sseSubdivisionThreshold=s,this.minSubdivisionLevel=a,this.maxSubdivisionLevel=o,this.maxDeltaElevationLevel=l,this.segments=d,this.schemeTile=n,this.builder=i,this.info=new _f(this),!this.schemeTile)throw new Error(`Cannot init tiled layer without schemeTile for layer ${this.id}`);if(!this.builder)throw new Error(`Cannot init tiled layer without builder for layer ${this.id}`);this.maxScreenSizeNode=this.sseSubdivisionThreshold*(2*this.sizeDiagonalTexture),this.tileMatrixSets=c,this.materialOptions=f,this.showOutline=u,this.diffuse=h,this.level0Nodes=[];const g=[];for(const e of this.schemeTile)g.push(this.convert(void 0,e));this._promises.push(Promise.all(g).then((e=>{this.level0Nodes=e,this.object3d.add(...e),this.object3d.updateMatrixWorld()})))}get hideSkirt(){return this._hideSkirt}set hideSkirt(e){if(this.level0Nodes){this._hideSkirt=e;for(const t of this.level0Nodes)t.traverse((t=>{t.isTileMesh&&(t.geometry.hideSkirt=e)}))}}pickObjectsAt(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.options.defaultPickingRadius,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[];return cx.pickTilesAt(e,t,n,this,i)}preUpdate(e,t){if(t.has(void 0)||0==t.size)return this.level0Nodes;e.colorLayers=e.view.getLayers(((e,t)=>t&&t.id==this.id&&e.isColorLayer)),e.elevationLayers=e.view.getLayers(((e,t)=>t&&t.id==this.id&&e.isElevationLayer)),e.maxElevationLevel=-1;for(const t of e.elevationLayers)e.maxElevationLevel=Math.max(t.source.zoom.max,e.maxElevationLevel);let n;-1==e.maxElevationLevel&&(e.maxElevationLevel=1/0),this.colorLayersOrder=Z_(e.colorLayers);for(const e of t.values()){if(e.isCamera)return this.level0Nodes;if(e.layer===this){if(n){if(n=e.findCommonAncestor(n),!n)return this.level0Nodes}else n=e;null==n.material&&(n=void 0)}}return n?[n]:this.level0Nodes}update(e,t,n){if(!n.parent)return dx.removeChildrenAndCleanup(this,n);if(n.parent.pendingSubdivision)return n.visible=!1,n.material.visible=!1,void this.info.update(n);if(n.visible=!this.culling(n,e.camera),n.visible){let t=!1;return n.material.visible=!0,this.info.update(n),(n.pendingSubdivision||iE.hasEnoughTexturesToSubdivide(e,n)&&this.subdivision(e,this,n))&&(this.subdivideNode(e,n),n.material.visible=n.pendingSubdivision,this.info.update(n),t=!0),n.material.visible&&!t?dx.removeChildren(this,n):t?n.children.filter((e=>e.layer==this)):void 0}return n.material.visible=!1,this.info.update(n),dx.removeChildren(this,n)}convert(e,t){return eE.convert(e,t,this)}countColorLayersTextures(){return arguments.length}culling(e,t){return!t.isBox3Visible(e.obb.box3D,e.matrixWorld)}static hasEnoughTexturesToSubdivide(e,t){const n=t.layerUpdateState||{};let i=t.material.getElevationLayer();for(const r of e.elevationLayers){const e=t.getExtentsByProjection(r.crs)[0].zoom;if(!(e>r.zoom.max||e<r.zoom.min)&&!r.frozen&&r.ready&&r.source.extentInsideLimit(t.extent,e)&&(!i||i.level<0)){if(n[r.id]&&n[r.id].inError())continue;return!1}}for(const r of e.colorLayers){if(r.frozen||!r.visible||!r.ready)continue;const e=t.getExtentsByProjection(r.crs)[0].zoom;if(!(e>r.zoom.max||e<r.zoom.min)&&(!n[r.id]||!n[r.id].inError())&&(i=t.material.getLayer(r.id),r.source.extentInsideLimit(t.extent,e)&&(!i||i.level<0)))return!1}return!0}subdivideNode(e,t){if(!t.pendingSubdivision&&!t.children.some((e=>e.layer==this))){const n=t.extent.subdivision();t.pendingSubdivision=!0;const i={view:e.view,requester:t,layer:this,priority:1e4,extentsSource:n,redraw:!1};return e.scheduler.execute(i).then((n=>{for(const e of n)t.add(e),e.updateMatrixWorld(!0);t.pendingSubdivision=!1,e.view.notifyChange(t,!1)}),(e=>{if(t.pendingSubdivision=!1,!e.isCancelledCommandException)throw new Error(e)}))}}subdivision(e,t,n){if(n.level<this.minSubdivisionLevel)return!0;if(this.maxSubdivisionLevel<=n.level)return!1;tE.setFromMatrixScale(n.matrixWorld),nE.copy(n.boundingSphere.center).applyMatrix4(n.matrixWorld);const i=Math.max(0,e.camera.camera3D.position.distanceTo(nE)-n.boundingSphere.radius*tE.x);if(e.camera.camera3D.isOrthographicCamera){const t=e.camera.camera3D,i=2*e.camera._preSSE*t.zoom/(t.top-t.bottom);n.screenSize=i*n.boundingSphere.radius*tE.x}else n.screenSize=e.camera._preSSE*(2*n.boundingSphere.radius*tE.x)/i;const r=n.screenSize/(2*this.sizeDiagonalTexture);return this.sseSubdivisionThreshold<r}}const rE=iE,sE=new Nn,aE=new sn;let oE=0;const lE=new sn;class cE extends rE{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const{minSubdivisionLevel:i=2,maxSubdivisionLevel:r=19,...s}=n,a=s_.get("EPSG:4326"),o=r_.get("EPSG:4326").subdivisionByScheme(a),l=["EPSG:4326","EPSG:3857"],c=new zx({uvCount:l.length});super(e,t||new oo,o,c,{tileMatrixSets:l,...s}),this.isGlobeLayer=!0,this.options.defaultPickingRadius=5,this.minSubdivisionLevel=i,this.maxSubdivisionLevel=r,this.extent=this.schemeTile[0].clone();for(let e=1;e<this.schemeTile.length;e++)this.extent.union(this.schemeTile[e]);sE.copy(this.object3d.matrixWorld).invert(),sE.premultiply((new Nn).makeScale(1/Dd.x,1/Dd.y,1/Dd.z))}preUpdate(e,t){return aE.copy(e.camera.camera3D.position).applyMatrix4(sE),oE=aE.lengthSq()-1,super.preUpdate(e,t)}countColorLayersTextures(){let e=0;for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];for(const t of n)e+="EPSG:3857"==(t.crs||t.source.crs)?3:1;return e}subdivision(e,t,n){if(5==n.level){const e=n.getExtentsByProjection("EPSG:4326")[0].row;if(31==e||0==e)return!1}return super.subdivision(e,t,n)}culling(e,t){return!!super.culling(e,t)||!(e.level<this.minSubdivisionLevel)&&cE.horizonCulling(e.horizonCullingPointElevationScaled)}static horizonCulling(e){lE.copy(e).applyMatrix4(sE),lE.sub(aE);const t=lE.lengthSq(),n=-lE.dot(aE);return oE<0?n>0:oE<n&&oE<n*n/t}computeTileZoomFromDistanceCamera(e,t){const n=this.sizeDiagonalTexture*(.5*this.sseSubdivisionThreshold)/t._preSSE/Dd.x;let i=e*n,r=Math.log(Math.PI/(2*Math.asin(i)))/Math.log(2);const s=Math.PI/2**r;return i=(e-2*Dd.x*Math.sin(.5*s)*.5)*n,r=Math.log(Math.PI/(2*Math.asin(i)))/Math.log(2),isNaN(r)?0:Math.round(r)}computeDistanceCameraFromTileZoom(e,t){const n=Math.PI/2**e,i=2*Dd.x*Math.sin(.5*n)*.5,r=i/this.sizeDiagonalTexture;return t._preSSE*r/(.5*this.sseSubdivisionThreshold)+i}}const hE=cE;const uE=new Sr;class dE{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:12,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10,n=arguments.length>2?arguments[2]:void 0,i=arguments.length>3?arguments[3]:void 0;this.x=e,this.y=t,this.grid=[],this.visible=[],this.resize(),this.reset(),this.width=n,this.height=i}reset(){for(let e=0;e<this.x;e++)for(let t=0;t<this.y;t++)this.grid[e][t].splice(0,this.grid[e][t].length);this.visible=[]}resize(){for(let e=0;e<this.x;e++){this.grid[e]||(this.grid[e]=[]);for(let t=0;t<this.y;t++)this.grid[e][t]||(this.grid[e][t]=[])}}insert(e){const t=Math.max(0,Math.floor(e.boundaries.left/this.width*this.x)),n=Math.min(this.x-1,Math.floor(e.boundaries.right/this.width*this.x)),i=Math.max(0,Math.floor(e.boundaries.top/this.height*this.y)),r=Math.min(this.y-1,Math.floor(e.boundaries.bottom/this.height*this.y));for(let s=t;s<=n;s++)for(let t=i;t<=r;t++)if(this.grid[s][t].length>0&&this.grid[s][t].some((t=>{return n=t.boundaries,i=e.boundaries,!(n.left>i.right||n.right<i.left||n.top>i.bottom||n.bottom<i.top);var n,i})))return e.visible=!1,!1;for(let s=t;s<=n;s++)for(let t=i;t<=r;t++)this.grid[s][t].push(e);return!0}}const pE=new sn,fE=class{constructor(){this.domElement=document.createElement("div"),this.domElement.style.overflow="hidden",this.domElement.style.position="absolute",this.domElement.style.top="0",this.domElement.style.height="100%",this.domElement.style.width="100%",this.domElement.style.zIndex=1,this.garbage=document.createElement("div"),this.garbage.style.display="none",this.domElement.appendChild(this.garbage),this.halfWidth=0,this.halfHeight=0,this.grid=new dE,this.infoTileLayer=void 0}setSize(e,t){this.domElement.style.width=`${e}`,this.domElement.style.height=`${t}`,this.halfWidth=e/2,this.halfHeight=t/2,this.grid.width=e,this.grid.height=t,this.grid.x=Math.ceil(e/20),this.grid.y=Math.ceil(t/20),this.grid.resize()}registerLayer(e){this.domElement.appendChild(e.domElement.dom)}render(e,t){const n=this.infoTileLayer&&this.infoTileLayer.layer.attachedLayers.filter((e=>e.isLabelLayer&&e.visible));0!=n.length&&(this.grid.reset(),uE.setFromProjectionMatrix(t.projectionMatrix),n.forEach((e=>{e.submittedLabelNodes.forEach((e=>{e.labels.forEach((n=>{e.updatePosition(n),this.culling(n,t)})),e.domElements.labels.show(),e.needsUpdate=!1}))})),this.grid.visible.sort(((e,t)=>{const n=t.order-e.order;return 0==n?!e.visible&&t.visible?1:-1:n})),this.grid.visible.forEach((e=>{this.grid.insert(e)?(e.visible=!0,e.updateCSSPosition()):e.visible=!1})),n.forEach((e=>{e.toHide.children.forEach((e=>e.domElements?.labels.hide())),e.toHide.clear()})))}culling(e,t){e.getWorldPosition(pE),!uE.containsPoint(pE.applyMatrix4(t.matrixWorldInverse))||e.horizonCullingPoint&&hE.horizonCulling(e.horizonCullingPoint)?e.visible=!1:(pE.applyMatrix4(t.projectionMatrix),e.updateProjectedPosition(pE.x*this.halfWidth+this.halfWidth,-pE.y*this.halfHeight+this.halfHeight),this.grid.visible.push(e))}removeLabelDOM(e){this.garbage.appendChild(e.content),this.garbage.innerHTML=""}},mE=class{static isWebGL2Available(){try{const e=document.createElement("canvas");return!(!window.WebGL2RenderingContext||!e.getContext("webgl2"))}catch(e){return!1}}static isColorSpaceAvailable(e){try{const t=document.createElement("canvas"),n=window.WebGL2RenderingContext&&t.getContext("webgl2");return n.drawingBufferColorSpace=e,n.drawingBufferColorSpace===e}catch(e){return!1}}static getWebGL2ErrorMessage(){return this.getErrorMessage(2)}static getErrorMessage(e){const t={1:window.WebGLRenderingContext,2:window.WebGL2RenderingContext};let n='Your $0 does not seem to support <a href="http://khronos.org/webgl/wiki/Getting_a_WebGL_Implementation" style="color:#000">$1</a>';const i=document.createElement("div");return i.id="webglmessage",i.style.fontFamily="monospace",i.style.fontSize="13px",i.style.fontWeight="normal",i.style.textAlign="center",i.style.background="#fff",i.style.color="#000",i.style.padding="1.5em",i.style.width="400px",i.style.margin="5em auto 0",n=t[e]?n.replace("$0","graphics card"):n.replace("$0","browser"),n=n.replace("$1",{1:"WebGL",2:"WebGL 2"}[e]),i.innerHTML=n,i}static isWebGLAvailable(){console.warn("isWebGLAvailable() has been deprecated and will be removed in r178. Use isWebGL2Available() instead.");try{const e=document.createElement("canvas");return!(!window.WebGLRenderingContext||!e.getContext("webgl")&&!e.getContext("experimental-webgl"))}catch(e){return!1}}static getWebGLErrorMessage(){return console.warn("getWebGLErrorMessage() has been deprecated and will be removed in r178. Use getWebGL2ErrorMessage() instead."),this.getErrorMessage(1)}},gE=new $t,AE=class{constructor(e){let t,n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(e=>{!1===e.isWebGL2&&console.error("WebGL1 support ended in 2.43.0. Falling-back to the WebGL2 renderer.")})(i),void 0===i.antialias&&(i.antialias=!0),void 0===i.alpha&&(i.alpha=!0),void 0===i.logarithmicDepthBuffer&&(i.logarithmicDepthBuffer=!0),e.domElement?(t=e,n=t.domElement instanceof HTMLDivElement?t.domElement:t.domElement.parentElement):n=e,this.width=n.clientWidth,this.height=n.clientHeight,this.positionBuffer=null,this._nextThreejsLayer=1,this.fullSizeRenderTarget=new en(this.width,this.height),this.fullSizeRenderTarget.texture.minFilter=W,this.fullSizeRenderTarget.texture.magFilter=V,this.fullSizeRenderTarget.depthBuffer=!0,this.fullSizeRenderTarget.depthTexture=new us,this.fullSizeRenderTarget.depthTexture.type=J,this.renderView=function(e){this.renderer.clear(),this.renderer.render(e.scene,e.camera3D),e.tileLayer&&this.label2dRenderer.render(e.tileLayer.object3d,e.camera3D)}.bind(this),this.onWindowResize=function(e,t){this.width=e,this.height=t,this.fullSizeRenderTarget.setSize(this.width,this.height),this.renderer.setSize(this.width,this.height),this.label2dRenderer.setSize(this.width,this.height)}.bind(this);try{this.label2dRenderer=new fE,this.label2dRenderer.setSize(this.width,this.height),n.appendChild(this.label2dRenderer.domElement),this.renderer=t||new Ao({canvas:document.createElement("canvas"),antialias:i.antialias,alpha:i.alpha,logarithmicDepthBuffer:i.logarithmicDepthBuffer}),this.renderer.domElement.style.position="relative",this.renderer.domElement.style.zIndex=0,this.renderer.domElement.style.top=0}catch(e){throw mE.isWebGL2Available()||n.appendChild(mE.getErrorMessage(2)),e}-1===this.renderer.domElement.tabIndex&&(this.renderer.domElement.tabIndex=-1),jp.updateCapabilities(this.renderer),this.renderer.setClearColor(197896),this.renderer.autoClear=!1,this.renderer.sortObjects=!0,this.renderer.debug.checkShaderErrors=!1,t||(this.renderer.setPixelRatio(n.devicePixelRatio),this.renderer.setSize(n.clientWidth,n.clientHeight),n.appendChild(this.renderer.domElement))}getWindowSize(){return new It(this.width,this.height)}getRenderer(){return this.renderer}renderViewToBuffer(e,t){return t||(t={x:0,y:0,width:this.width,height:this.height}),t.buffer=t.buffer||new Uint8Array(4*t.width*t.height),this.renderViewToRenderTarget(e,this.fullSizeRenderTarget,t),this.renderer.readRenderTargetPixels(this.fullSizeRenderTarget,t.x,this.height-(t.y+t.height),t.width,t.height,t.buffer),t.buffer}renderViewToRenderTarget(e,t,n){t||(t=this.fullSizeRenderTarget);const i=this.renderer.getRenderTarget();return n&&(this.fullSizeRenderTarget.scissor.set(n.x,t.height-(n.y+n.height),n.width,n.height),this.fullSizeRenderTarget.scissorTest=!0),this.renderer.setRenderTarget(t),this.renderer.clear(!0,!0,!1),this.renderer.render(e.scene,e.camera.camera3D),this.renderer.setRenderTarget(i),this.fullSizeRenderTarget.scissorTest=!1,t}bufferToImage(e,t,n){const i=document.createElement("canvas"),r=i.getContext("2d",{willReadFrequently:!0});i.width=t,i.height=n;const s=r.getImageData(0,0,t,n);s.data.set(e),r.putImageData(s,0,0);const a=new Image;return a.src=i.toDataURL(),a}depthBufferRGBAValueToOrthoZ(e,t){if(gE.fromArray(e).divideScalar(255),jp.isLogDepthBufferSupported()&&"PerspectiveCamera"==t.type)return 2**(2*rf(gE)/(2/(Math.log(t.far+1)/Math.LN2)));{let e=rf(gE);return e=2*e-1,e}}};function yE(e,t,n,i,r,s){const a=e.x,o=e.y;for(let e=i+s,l=i;e<i+r;l=e,e+=s){const i=t[e],r=t[e+1],s=t[l],c=t[l+1],h=s-i,u=c-r,d=Math.sqrt(h*h+u*u),p=((a-i)*h+(o-r)*u)/d;if(p>=-n&&p<=d+n&&Math.abs(u*a-h*o+s*r-c*i)/d<=n)return!0}return!1}function vE(e,t,n,i,r,s,a){if(t==dy.LINE&&yE(e,n,i,r,s,a))return!0;if(t==dy.POLYGON&&function(e,t,n,i,r,s){const a=e.x,o=e.y;let l=!1;for(let c=i,h=i+r-s;c<i+r;h=c,c+=s){const i=t[c],r=t[c+1],s=t[h],u=t[h+1];if(yE(e,[i,r,s,u],n,0,4,2))return!0;r>o!=u>o&&a<(s-i)*(o-r)/(u-r)+i&&(l=!l)}return l}(e,n,i,r,s,a))return!0;if(t==dy.POINT){const t=function(e,t,n,i,r,s){const a=e.x,o=e.y;let l,c=n*n;for(let e=i;e<i+r;e+=s){const n=a-t[e],i=o-t[e+1],r=n*n+i*i;r<c&&(l=[t[e],t[e+1]],c=r)}return l}(e,n,i,r,s,a);if(t)return{coordinates:t}}}function _E(e,t,n,i){const r=e.as(t.crs);for(const e of t.geometries)if(null==e.extent||e.extent.isPointInside(r,n)){const s=e.indices[0].offset*t.size,a=e.indices[0].count*t.size,o=vE(r,t.type,t.vertices,n,s,a,t.size);o&&i.push({type:t.type,geometry:e,coordinates:o.coordinates,style:t.style})}}const xE=new Jd("EPSG:4326",0,0,0),EE={filterFeaturesUnderCoordinate(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.1;const i=[];if(e.as(t.crs,xE),xE.applyMatrix4(t.matrixWorldInverse),t.extent.isPointInside(xE,n))if(t.isFeatureCollection){n*=Math.sqrt(t.scale.x**2+t.scale.y**2);for(const e of t.features)e.extent&&!e.extent.isPointInside(xE,n)||_E(xE,e,n,i)}else t.geometries&&_E(xE,t,n,i);return i}};var bE=n(61);const wE={executeCommand(e){const t=e.layer,n=e.extentsSource,i=e.extentsDestination||n,r=n.map(((e,n)=>t.getData(e,i[n])));return e.partialLoading?Promise.allSettled(r).then((e=>e.find((e=>"fulfilled"===e.status))?e.map((e=>e.value?e.value:null)):Promise.reject(new Error("Failed to load any data")))):Promise.all(r)}},ME=class{constructor(e){this.command=e,this.isCancelledCommandException=!0}toString(){return`Cancelled command ${this.command.requester.id}/${this.command.layer.id}`}},SE={executeCommand(e){const t=[],n=e.layer,i=e.requester,r=e.extentsSource;if(i&&!i.material)return Promise.reject(new ME(e));for(const e of r)t.push(n.convert(i,e));return Promise.all(t)}},CE={BYTE:1,UNSIGNED_BYTE:1,SHORT:2,UNSIGNED_SHORT:2,INT:4,UNSIGNED_INT:4,FLOAT:4,DOUBLE:8},TE={BYTE:Int8Array,UNSIGNED_BYTE:Uint8Array,SHORT:Int16Array,UNSIGNED_SHORT:Uint16Array,INT:Int32Array,UNSIGNED_INT:Uint32Array,FLOAT:Float32Array,DOUBLE:Float64Array},IE={SCALAR:1,VEC2:2,VEC3:3,VEC4:4},RE={VEC2:It,VEC3:sn,VEC4:$t},BE=function(e,t,n,i,r){if(!e)throw new Error("Buffer is mandatory to parse binary property.");if(null==t)throw new Error("batchLength is mandatory to parse binary property.");if(null==n)throw new Error("byteOffset is mandatory to parse binary property.");if(!CE[i])throw new Error(`Uknown component type: ${i}. Cannot access binary property.`);if(!IE[r])throw new Error(`Uknown type: ${r}. Cannot access binary property.`);const s=IE[r],a=new TE[i](e,n,t*s);if("SCALAR"===r)return Array.from(a);{const e=[];for(let t=0;t<=a.length-s;t+=s){const n=new RE[r];n.fromArray(a,t),e.push(n)}return e}},LE=new TextDecoder,PE=class{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new ArrayBuffer,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=arguments.length>4?arguments[4]:void 0;4!==arguments.length||"object"!=typeof i||Array.isArray(i)||null===i||console.warn("You most likely used a deprecated constructor of C3DTBatchTable."),t+n!==e.byteLength&&console.error("3DTiles batch table json length and binary length are not consistent with total buffer length. The batch table may be wrong."),this.type="batchtable",this.batchLength=i;const s=e.slice(0,t),a=LE.decode(new Uint8Array(s)),o=""===a?null:JSON.parse(a);if(n>0){const i=e.slice(t,t+n);for(const e in o){if(!Object.prototype.hasOwnProperty.call(o,e))continue;const t=o[e];Array.isArray(t)||(void 0!==t?.byteOffset&&void 0!==t?.componentType&&void 0!==t?.type?o[e]=BE(i,this.batchLength,t.byteOffset,t.componentType,t.type):console.error("Invalid 3D Tiles batch table property that is neither a JSON array nor a valid accessor to a binary body"))}}o&&o.extensions&&(this.extensions=r.parseExtensions(o.extensions,this.type),delete o.extensions),this.content=o}getInfoById(e){if(e<0&&e<this.batchLength)throw new Error(`Batch Id (${e}) must be between 0 and\n            ${this.batchLength} to access feature properties from the batch\n            table.`);const t={batchTable:{}};for(const n in this.content)if(Object.prototype.hasOwnProperty.call(this.content,n)){const i=this.content[n][e];i&&(i.isVector2||i.isVector3||i.isVector4)?t.batchTable[n]=i.toArray():t.batchTable[n]=i}if(this.extensions){t.extensions={};for(const n in this.extensions)Object.prototype.hasOwnProperty.call(this.extensions,n)&&(t.extensions[n]=this.extensions[n].getInfoById(e))}return t}};function DE(e){if(!e)return null;const t=e.replace(/[a-z]+:\/\/[^/]+/i,"").replace(/\?.*$/i,"").replace(/.*\//g,""),n=t.lastIndexOf(".");return-1===n?null:t.substring(n+1)||null}class NE{get unloadPriorityCallback(){return this._unloadPriorityCallback}set unloadPriorityCallback(e){1===e.length?(console.warn('LRUCache: "unloadPriorityCallback" function has been changed to take two arguments.'),this._unloadPriorityCallback=(t,n)=>{const i=e(t),r=e(n);return i<r?-1:i>r?1:0}):this._unloadPriorityCallback=e}constructor(){this.minSize=6e3,this.maxSize=8e3,this.minBytesSize=322122547.2,this.maxBytesSize=429496729.6,this.unloadPercent=.05,this.autoMarkUnused=!0,this.itemSet=new Map,this.itemList=[],this.usedSet=new Set,this.callbacks=new Map,this.unloadingHandle=-1,this.cachedBytes=0,this.bytesMap=new Map,this.loadedSet=new Set,this._unloadPriorityCallback=null,this.computeMemoryUsageCallback=()=>null;const e=this.itemSet;this.defaultPriorityCallback=t=>e.get(t)}isFull(){return this.itemSet.size>=this.maxSize||this.cachedBytes>=this.maxBytesSize}getMemoryUsage(e){return this.bytesMap.get(e)??null}add(e,t){const n=this.itemSet;if(n.has(e))return!1;if(this.isFull())return!1;const i=this.usedSet,r=this.itemList,s=this.callbacks,a=this.bytesMap;r.push(e),i.add(e),n.set(e,Date.now()),s.set(e,t);const o=this.computeMemoryUsageCallback(e);return this.cachedBytes+=o||0,a.set(e,o),!0}has(e){return this.itemSet.has(e)}remove(e){const t=this.usedSet,n=this.itemSet,i=this.itemList,r=this.bytesMap,s=this.callbacks,a=this.loadedSet;if(n.has(e)){this.cachedBytes-=r.get(e)||0,r.delete(e),s.get(e)(e);const o=i.indexOf(e);return i.splice(o,1),t.delete(e),n.delete(e),s.delete(e),a.delete(e),!0}return!1}setLoaded(e,t){const{itemSet:n,loadedSet:i}=this;n.has(e)&&(!0===t?i.add(e):i.delete(e))}updateMemoryUsage(e){const t=this.itemSet,n=this.bytesMap;if(!t.has(e))return;this.cachedBytes-=n.get(e)||0;const i=this.computeMemoryUsageCallback(e);n.set(e,i),this.cachedBytes+=i}markUsed(e){const t=this.itemSet,n=this.usedSet;t.has(e)&&!n.has(e)&&(t.set(e,Date.now()),n.add(e))}markUnused(e){this.usedSet.delete(e)}markAllUnused(){this.usedSet.clear()}unloadUnusedContent(){const{unloadPercent:e,minSize:t,maxSize:n,itemList:i,itemSet:r,usedSet:s,loadedSet:a,callbacks:o,bytesMap:l,minBytesSize:c,maxBytesSize:h}=this,u=i.length-s.size,d=i.length-a.size,p=Math.max(Math.min(i.length-t,u),0),f=this.cachedBytes-c,m=this.unloadPriorityCallback||this.defaultPriorityCallback;let g=!1;const A=p>0&&u>0||d&&i.length>n;if(u&&this.cachedBytes>c||d&&this.cachedBytes>h||A){i.sort(((e,t)=>{const n=s.has(e);if(n===s.has(t)){const n=a.has(e);return n===a.has(t)?-m(e,t):n?1:-1}return n?1:-1}));const d=Math.max(t*e,p*e),A=Math.ceil(Math.min(d,u,p)),y=Math.max(e*f,e*c),v=Math.min(y,f);let _=0,x=0;for(;this.cachedBytes-x>h||i.length-_>n;){const e=i[_],t=l.get(e)||0;if(s.has(e)&&a.has(e)||this.cachedBytes-x-t<h&&i.length-_<=n)break;x+=t,_++}for(;x<v||_<A;){const e=i[_],t=l.get(e)||0;if(s.has(e)||this.cachedBytes-x-t<c&&_>=A)break;x+=t,_++}i.splice(0,_).forEach((e=>{this.cachedBytes-=l.get(e)||0,o.get(e)(e),l.delete(e),r.delete(e),o.delete(e),a.delete(e),s.delete(e)})),g=_<p||x<f&&_<u,g=g&&_>0}g&&(this.unloadingHandle=requestAnimationFrame((()=>this.scheduleUnload())))}scheduleUnload(){cancelAnimationFrame(this.unloadingHandle),this.scheduled||(this.scheduled=!0,queueMicrotask((()=>{this.scheduled=!1,this.unloadUnusedContent()})))}}class UE{constructor(){this.maxJobs=6,this.items=[],this.callbacks=new Map,this.currJobs=0,this.scheduled=!1,this.autoUpdate=!0,this.priorityCallback=()=>{throw new Error("PriorityQueue: PriorityCallback function not defined.")},this.schedulingCallback=e=>{requestAnimationFrame(e)},this._runjobs=()=>{this.tryRunJobs(),this.scheduled=!1}}sort(){const e=this.priorityCallback;this.items.sort(e)}add(e,t){return new Promise(((n,i)=>{const r=this.items,s=this.callbacks;r.push(e),s.set(e,((...e)=>t(...e).then(n).catch(i))),this.autoUpdate&&this.scheduleJobRun()}))}remove(e){const t=this.items,n=this.callbacks,i=t.indexOf(e);-1!==i&&(t.splice(i,1),n.delete(e))}tryRunJobs(){this.sort();const e=this.items,t=this.callbacks,n=this.maxJobs;let i=this.currJobs;for(;n>i&&e.length>0;){i++;const n=e.pop(),r=t.get(n);t.delete(n),r(n).then((()=>{this.currJobs--,this.autoUpdate&&this.scheduleJobRun()})).catch((()=>{this.currJobs--,this.autoUpdate&&this.scheduleJobRun()}))}this.currJobs=i}scheduleJobRun(){this.scheduled||(this.schedulingCallback(this._runjobs),this.scheduled=!0)}}const OE=-1,FE=6378137;function kE(e){return 3===e||e===OE}function QE(e,t){return e.__lastFrameVisited===t&&e.__used}function zE(e,t){e.__lastFrameVisited!==t.frameCount&&(e.__lastFrameVisited=t.frameCount,e.__used=!1,e.__inFrustum=!1,e.__isLeaf=!1,e.__visible=!1,e.__active=!1,e.__error=1/0,e.__distanceFromCamera=1/0,e.__childrenWereVisible=!1,e.__allChildrenLoaded=!1,e.__inFrustum=t.tileInView(e),t.calculateError(e))}function GE(e,t){if(t.ensureChildrenArePreprocessed(e),zE(e,t),VE(e,t),!e.__hasRenderableContent){const n=e.children;for(let e=0,i=n.length;e<i;e++)GE(n[e],t)}}function HE(e,t){if(t.ensureChildrenArePreprocessed(e),QE(e,t.frameCount)){e.__hasContent&&0===e.__loadingState&&!t.lruCache.isFull()&&t.queueTileForDownload(e);const n=e.children;for(let e=0,i=n.length;e<i;e++)HE(n[e],t)}}function VE(e,t){e.__used||(e.__used=!0,t.markTileUsed(e),t.stats.used++,!0===e.__inFrustum&&t.stats.inFrustum++)}function jE(e,t=null,n=null){const i=[];for(i.push(e),i.push(null),i.push(0);i.length>0;){const e=i.pop(),r=i.pop(),s=i.pop();if(t&&t(s,r,e))return void(n&&n(s,r,e));const a=s.children;if(a)for(let t=a.length-1;t>=0;t--)i.push(a[t]),i.push(s),i.push(e+1);n&&n(s,r,e)}}function qE(e,t){if(t.ensureChildrenArePreprocessed(e),zE(e,t),!e.__inFrustum)return;if(!function(e,t){return!(e.__error<=t.errorTarget||t.maxDepth>0&&e.__depth+1>=t.maxDepth)}(e,t))return void VE(e,t);let n=!1,i=!1;const r=e.children;for(let e=0,s=r.length;e<s;e++){const s=r[e];qE(s,t),n=n||QE(s,t.frameCount),i=i||s.__inFrustum}if("REPLACE"!==e.refine||i||0===r.length||e.__hasUnrenderableContent){if(VE(e,t),n&&"REPLACE"===e.refine)for(let e=0,n=r.length;e<n;e++)GE(r[e],t)}else e.__inFrustum=!1}function WE(e,t){const n=t.frameCount;if(!QE(e,n))return;const i=e.children;let r=!1;for(let e=0,t=i.length;e<t;e++){const t=i[e];r=r||QE(t,n)}if(r){let r=!1,s=!0;for(let e=0,a=i.length;e<a;e++){const a=i[e];if(WE(a,t),r=r||a.__wasSetVisible||a.__childrenWereVisible,QE(a,n)){const e=a.__allChildrenLoaded||a.__hasRenderableContent&&kE(a.__loadingState)||!a.__hasContent&&0===a.children.length||a.__hasUnrenderableContent&&a.__loadingState===OE;s=s&&e}}e.__childrenWereVisible=r,e.__allChildrenLoaded=s}else e.__isLeaf=!0}function YE(e,t){const n=t.stats;if(!QE(e,t.frameCount))return;const i=t.lruCache;if(e.__isLeaf)return void(3===e.__loadingState?(e.__inFrustum&&(e.__visible=!0,n.visible++),e.__active=!0,n.active++):!i.isFull()&&e.__hasContent&&t.queueTileForDownload(e));const r=e.children,s=e.__hasContent,a=kE(e.__loadingState)&&s,o=(t.errorTarget+1)*t.errorThreshold,l=e.__error<=o,c=e.__childrenWereVisible,h=e.__allChildrenLoaded;if((l||"ADD"===e.refine)&&!a&&!i.isFull()&&s&&t.queueTileForDownload(e),(l&&!h&&!c&&a||"ADD"===e.refine&&a)&&(e.__inFrustum&&(e.__visible=!0,n.visible++),e.__active=!0,n.active++),"REPLACE"===e.refine&&l&&!h)for(let e=0,n=r.length;e<n;e++){const n=r[e];QE(n,t.frameCount)&&HE(n,t)}else for(let e=0,n=r.length;e<n;e++)YE(r[e],t)}function XE(e,t){const n=QE(e,t.frameCount);if(n||e.__usedLastFrame){let i=!1,r=!1;n?(i=e.__active,r=t.displayActiveTiles&&e.__active||e.__visible):zE(e,t),e.__hasRenderableContent&&3===e.__loadingState&&(e.__wasSetActive!==i&&t.setTileActive(e,i),e.__wasSetVisible!==r&&t.invokeOnePlugin((t=>t.setTileVisible&&t.setTileVisible(e,r)))),e.__wasSetActive=i,e.__wasSetVisible=r,e.__usedLastFrame=n;const s=e.children;for(let e=0,n=s.length;e<n;e++)XE(s[e],t)}}const KE=Symbol("PLUGIN_REGISTERED"),JE=(e,t)=>e.__depthFromRenderedParent!==t.__depthFromRenderedParent?e.__depthFromRenderedParent>t.__depthFromRenderedParent?-1:1:e.__inFrustum!==t.__inFrustum?e.__inFrustum?1:-1:e.__used!==t.__used?e.__used?1:-1:e.__error!==t.__error?e.__error>t.__error?1:-1:e.__distanceFromCamera!==t.__distanceFromCamera?e.__distanceFromCamera>t.__distanceFromCamera?-1:1:0,$E=(e,t)=>e.__depthFromRenderedParent!==t.__depthFromRenderedParent?e.__depthFromRenderedParent>t.__depthFromRenderedParent?1:-1:e.__loadingState!==t.__loadingState?e.__loadingState>t.__loadingState?-1:1:e.__lastFrameVisited!==t.__lastFrameVisited?e.__lastFrameVisited>t.__lastFrameVisited?-1:1:e.__hasUnrenderableContent!==t.__hasUnrenderableContent?e.__hasUnrenderableContent?-1:1:e.__error!==t.__error?e.__error>t.__error?-1:1:0;class ZE{get root(){const e=this.rootTileSet;return e?e.root:null}get loadProgress(){const e=this.stats,t=e.downloading+e.parsing,n=e.inCacheSinceLoad;return 0===n?1:1-t/n}get errorThreshold(){return this._errorThreshold}set errorThreshold(e){console.warn('TilesRenderer: The "errorThreshold" option has been deprecated.'),this._errorThreshold=e}constructor(e=null){this.rootLoadingState=0,this.rootTileSet=null,this.rootURL=e,this.fetchOptions={},this.plugins=[],this.queuedTiles=[],this.cachedSinceLoadComplete=new Set;const t=new NE;t.unloadPriorityCallback=$E;const n=new UE;n.maxJobs=10,n.priorityCallback=JE;const i=new UE;i.maxJobs=1,i.priorityCallback=JE,this.visibleTiles=new Set,this.activeTiles=new Set,this.usedSet=new Set,this.lruCache=t,this.downloadQueue=n,this.parseQueue=i,this.stats={inCacheSinceLoad:0,inCache:0,parsing:0,downloading:0,failed:0,inFrustum:0,used:0,active:0,visible:0},this.frameCount=0,this.errorTarget=6,this._errorThreshold=1/0,this.displayActiveTiles=!1,this.maxDepth=1/0}registerPlugin(e){if(!0===e[KE])throw new Error("TilesRendererBase: A plugin can only be registered to a single tile set");const t=this.plugins,n=e.priority||0;let i=t.length;for(let e=0;e<t.length;e++)if((t[e].priority||0)>n){i=e;break}t.splice(i,0,e),e[KE]=!0,e.init&&e.init(this)}unregisterPlugin(e){const t=this.plugins;if("string"==typeof e&&(e=this.getPluginByName(name)),t.includes(e)){const n=t.indexOf(e);return t.splice(n,1),e.dispose&&e.dispose(),!0}return!1}getPluginByName(e){return this.plugins.find((t=>t.name===e))||null}traverse(e,t,n=!0){this.root&&jE(this.root,((t,...i)=>(n&&this.ensureChildrenArePreprocessed(t),!!e&&e(t,...i))),t)}queueTileForDownload(e){0===e.__loadingState&&this.queuedTiles.push(e)}markTileUsed(e){this.usedSet.add(e),this.lruCache.markUsed(e)}update(){const{lruCache:e,usedSet:t,stats:n,root:i}=this;if(0===this.rootLoadingState&&(this.rootLoadingState=1,this.invokeOnePlugin((e=>e.loadRootTileSet&&e.loadRootTileSet())).then((e=>{this.rootLoadingState=3,this.rootTileSet=e,this.dispatchEvent({type:"load-tile-set",tileSet:e})})).catch((e=>{this.rootLoadingState=OE,console.error(e),this.rootTileSet=null,this.dispatchEvent({type:"load-error",tile:null,error:e})}))),!i)return;n.inFrustum=0,n.used=0,n.active=0,n.visible=0,this.frameCount++,t.forEach((t=>e.markUnused(t))),t.clear(),qE(i,this),WE(i,this),YE(i,this),XE(i,this);const r=this.queuedTiles;r.sort(e.unloadPriorityCallback);for(let t=0,n=r.length;t<n&&!e.isFull();t++)this.requestTileContents(r[t]);r.length=0,e.scheduleUnload()}resetFailedTiles(){this.rootLoadingState===OE&&(this.rootLoadingState=0);const e=this.stats;0!==e.failed&&(this.traverse((e=>{e.__loadingState===OE&&(e.__loadingState=0)}),null,!1),e.failed=0)}dispose(){this.plugins.forEach((e=>{this.unregisterPlugin(e)}));const e=this.lruCache,t=[];this.traverse((e=>(t.push(e),!1)),null,!1);for(let n=0,i=t.length;n<i;n++)e.remove(t[n]);this.stats={parsing:0,downloading:0,failed:0,inFrustum:0,used:0,active:0,visible:0},this.frameCount=0}dispatchEvent(e){}fetchData(e,t){return fetch(e,t)}parseTile(e,t,n){return null}disposeTile(e){e.__visible&&(this.invokeOnePlugin((t=>t.setTileVisible&&t.setTileVisible(e,!1))),e.__visible=!1),e.__active&&(this.setTileActive(e,!1),e.__active=!1)}preprocessNode(e,t,n=null){if(e.content&&(!("uri"in e.content)&&"url"in e.content&&(e.content.uri=e.content.url,delete e.content.url),e.content.boundingVolume&&!("box"in e.content.boundingVolume||"sphere"in e.content.boundingVolume||"region"in e.content.boundingVolume)&&delete e.content.boundingVolume),e.parent=n,e.children=e.children||[],e.content?.uri){const t=DE(e.content.uri);e.__hasContent=!0,e.__hasUnrenderableContent=Boolean(t&&/json$/.test(t)),e.__hasRenderableContent=!e.__hasUnrenderableContent}else e.__hasContent=!1,e.__hasUnrenderableContent=!1,e.__hasRenderableContent=!1;e.__distanceFromCamera=1/0,e.__error=1/0,e.__inFrustum=!1,e.__isLeaf=!1,e.__usedLastFrame=!1,e.__used=!1,e.__wasSetVisible=!1,e.__visible=!1,e.__childrenWereVisible=!1,e.__allChildrenLoaded=!1,e.__wasSetActive=!1,e.__active=!1,e.__loadingState=0,null===n?(e.__depth=0,e.__depthFromRenderedParent=e.__hasRenderableContent?1:0,e.refine=e.refine||"REPLACE"):(e.__depth=n.__depth+1,e.__depthFromRenderedParent=n.__depthFromRenderedParent+(e.__hasRenderableContent?1:0),e.refine=e.refine||n.refine),e.__basePath=t,e.__lastFrameVisited=-1,this.invokeAllPlugins((i=>{i!==this&&i.preprocessNode&&i.preprocessNode(e,t,n)}))}setTileActive(e,t){t?this.activeTiles.add(e):this.activeTiles.delete(e)}setTileVisible(e,t){t?this.visibleTiles.add(e):this.visibleTiles.delete(e)}calculateError(e){return 0}tileInView(e){return!0}ensureChildrenArePreprocessed(e){const t=e.children;for(let n=0,i=t.length;n<i;n++){const i=t[n];if("__depth"in i)break;this.preprocessNode(i,e.__basePath,e)}}preprocessTileSet(e,t,n=null){const i=e.asset.version,[r,s]=i.split(".").map((e=>parseInt(e)));console.assert(r<=1,"TilesRenderer: asset.version is expected to be a 1.x or a compatible version."),1===r&&s>0&&console.warn("TilesRenderer: tiles versions at 1.1 or higher have limited support. Some new extensions and features may not be supported.");let a=t.replace(/\/[^/]*\/?$/,"");a=new URL(a,window.location.href).toString(),this.preprocessNode(e.root,a,n)}loadRootTileSet(){let e=this.rootURL;return this.invokeAllPlugins((t=>e=t.preprocessURL?t.preprocessURL(e,null):e)),this.invokeOnePlugin((t=>t.fetchData&&t.fetchData(e,this.fetchOptions))).then((t=>{if(t.ok)return t.json();throw new Error(`TilesRenderer: Failed to load tileset "${e}" with status ${t.status} : ${t.statusText}`)})).then((t=>(this.preprocessTileSet(t,e),t)))}requestTileContents(e){if(0!==e.__loadingState)return;let t=!1,n=new URL(e.content.uri,e.__basePath+"/").toString();this.invokeAllPlugins((t=>n=t.preprocessURL?t.preprocessURL(n,e):n));const i=this.stats,r=this.lruCache,s=this.downloadQueue,a=this.parseQueue,o=DE(n),l=new AbortController,c=l.signal;return r.add(e,(n=>{l.abort(),t?n.children.length=0:this.invokeAllPlugins((e=>{e.disposeTile&&e.disposeTile(n)})),i.inCache--,this.cachedSinceLoadComplete.has(e)&&(this.cachedSinceLoadComplete.delete(e),i.inCacheSinceLoad--),1===n.__loadingState?i.downloading--:2===n.__loadingState&&i.parsing--,n.__loadingState=0,a.remove(n),s.remove(n)}))?(0===i.parsing&&0===i.downloading&&this.dispatchEvent({type:"tiles-load-start"}),this.cachedSinceLoadComplete.add(e),i.inCacheSinceLoad++,i.inCache++,i.downloading++,e.__loadingState=1,s.add(e,(e=>c.aborted?Promise.resolve():this.invokeOnePlugin((e=>e.fetchData&&e.fetchData(n,{...this.fetchOptions,signal:c}))))).then((e=>{if(!c.aborted){if(e.ok)return"json"===o?e.json():e.arrayBuffer();throw new Error(`Failed to load model with error code ${e.status}`)}})).then((r=>{if(!c.aborted)return i.downloading--,i.parsing++,e.__loadingState=2,a.add(e,(i=>c.aborted?Promise.resolve():"json"===o&&r.root?(this.preprocessTileSet(r,n,e),e.children.push(r.root),t=!0,Promise.resolve()):this.invokeOnePlugin((e=>e.parseTile&&e.parseTile(r,i,o,n,c)))))})).then((()=>{c.aborted||(i.parsing--,e.__loadingState=3,r.setLoaded(e,!0),null===r.getMemoryUsage(e)&&(r.isFull()&&r.computeMemoryUsageCallback(e)>0?r.remove(e):r.updateMemoryUsage(e)),e.cached.scene&&this.dispatchEvent({type:"load-model",scene:e.cached.scene,tile:e}))})).catch((t=>{c.aborted||("AbortError"!==t.name?(a.remove(e),s.remove(e),2===e.__loadingState?i.parsing--:1===e.__loadingState&&i.downloading--,i.failed++,console.error(`TilesRenderer : Failed to load tile at url "${e.content.uri}".`),console.error(t),e.__loadingState=OE,r.setLoaded(e,!0),this.dispatchEvent({type:"load-error",tile:e,error:t,uri:n})):r.remove(e))})).finally((()=>{0===i.parsing&&0===i.downloading&&(this.cachedSinceLoadComplete.clear(),i.inCacheSinceLoad=0,this.dispatchEvent({type:"tiles-load-end"}))}))):void 0}getAttributions(e=[]){return this.invokeAllPlugins((t=>t!==this&&t.getAttributions&&t.getAttributions(e))),e}invokeOnePlugin(e){const t=[...this.plugins,this];for(let n=0;n<t.length;n++){const i=e(t[n]);if(i)return i}return null}invokeAllPlugins(e){const t=[...this.plugins,this],n=[];for(let i=0;i<t.length;i++){const r=e(t[i]);r&&n.push(r)}return 0===n.length?null:Promise.all(n)}}const eb=new TextDecoder;function tb(e){return eb.decode(e)}function nb(e,t,n,i,r,s){let a,o;switch(i){case"SCALAR":a=1;break;case"VEC2":a=2;break;case"VEC3":a=3;break;case"VEC4":a=4;break;default:throw new Error(`FeatureTable : Feature type not provided for "${s}".`)}const l=n*a;switch(r){case"BYTE":o=new Int8Array(e,t,l);break;case"UNSIGNED_BYTE":o=new Uint8Array(e,t,l);break;case"SHORT":o=new Int16Array(e,t,l);break;case"UNSIGNED_SHORT":o=new Uint16Array(e,t,l);break;case"INT":o=new Int32Array(e,t,l);break;case"UNSIGNED_INT":o=new Uint32Array(e,t,l);break;case"FLOAT":o=new Float32Array(e,t,l);break;case"DOUBLE":o=new Float64Array(e,t,l);break;default:throw new Error(`FeatureTable : Feature component type not provided for "${s}".`)}return o}class ib{constructor(e,t,n,i){this.buffer=e,this.binOffset=t+n,this.binLength=i;let r=null;if(0!==n){const i=new Uint8Array(e,t,n);r=JSON.parse(tb(i))}else r={};this.header=r}getKeys(){return Object.keys(this.header)}getData(e,t,n=null,i=null){const r=this.header;if(!(e in r))return null;const s=r[e];if(s instanceof Object){if(Array.isArray(s))return s;{const{buffer:r,binOffset:a,binLength:o}=this,l=s.byteOffset||0,c=s.type||i,h=s.componentType||n;if("type"in s&&i&&s.type!==i)throw new Error("FeatureTable: Specified type does not match expected type.");const u=a+l,d=nb(r,u,t,c,h,e);if(u+d.byteLength>a+o)throw new Error("FeatureTable: Feature data read outside binary body length.");return d}}return s}getBuffer(e,t){const{buffer:n,binOffset:i}=this;return n.slice(i+e,i+e+t)}}class rb{constructor(e){this.batchTable=e;const t=e.header.extensions["3DTILES_batch_table_hierarchy"];this.classes=t.classes;for(const e of this.classes){const t=e.instances;for(const n in t)e.instances[n]=this._parseProperty(t[n],e.length,n)}if(this.instancesLength=t.instancesLength,this.classIds=this._parseProperty(t.classIds,this.instancesLength,"classIds"),t.parentCounts?this.parentCounts=this._parseProperty(t.parentCounts,this.instancesLength,"parentCounts"):this.parentCounts=new Array(this.instancesLength).fill(1),t.parentIds){const e=this.parentCounts.reduce(((e,t)=>e+t),0);this.parentIds=this._parseProperty(t.parentIds,e,"parentIds")}else this.parentIds=null;this.instancesIds=[];const n={};for(const e of this.classIds)n[e]=n[e]??0,this.instancesIds.push(n[e]),n[e]++}_parseProperty(e,t,n){if(Array.isArray(e))return e;{const{buffer:i,binOffset:r}=this.batchTable;return nb(i,r+e.byteOffset,t,"SCALAR",e.componentType||"UNSIGNED_SHORT",n)}}getDataFromId(e,t={}){const n=this.parentCounts[e];if(this.parentIds&&n>0){let i=0;for(let t=0;t<e;t++)i+=this.parentCounts[t];for(let r=0;r<n;r++){const n=this.parentIds[i+r];n!==e&&this.getDataFromId(n,t)}}const i=this.classIds[e],r=this.classes[i].instances,s=this.classes[i].name,a=this.instancesIds[e];for(const e in r)t[s]=t[s]||{},t[s][e]=r[e][a];return t}}class sb extends ib{get batchSize(){return console.warn("BatchTable.batchSize has been deprecated and replaced with BatchTable.count."),this.count}constructor(e,t,n,i,r){super(e,n,i,r),this.count=t,this.extensions={};const s=this.header.extensions;s&&s["3DTILES_batch_table_hierarchy"]&&(this.extensions["3DTILES_batch_table_hierarchy"]=new rb(this))}getData(e,t=null,n=null){return console.warn("BatchTable: BatchTable.getData is deprecated. Use BatchTable.getDataFromId to get allproperties for an id or BatchTable.getPropertyArray for getting an array of value for a property."),super.getData(e,this.count,t,n)}getDataFromId(e,t={}){if(e<0||e>=this.count)throw new Error(`BatchTable: id value "${e}" out of bounds for "${this.count}" features number.`);for(const n of this.getKeys())"extensions"!==n&&(t[n]=super.getData(n,this.count)[e]);for(const n in this.extensions){const i=this.extensions[n];i.getDataFromId instanceof Function&&(t[n]=t[n]||{},i.getDataFromId(e,t[n]))}return t}getPropertyArray(e){return super.getData(e,this.count)}}class ab{constructor(){this.fetchOptions={},this.workingPath=""}load(e){return console.warn('Loader: "load" function has been deprecated in favor of "loadAsync".'),this.loadAsync(e)}loadAsync(e){return fetch(e,this.fetchOptions).then((t=>{if(!t.ok)throw new Error(`Failed to load file "${e}" with status ${t.status} : ${t.statusText}`);return t.arrayBuffer()})).then((t=>(""===this.workingPath&&(this.workingPath=this.workingPathForURL(e)),this.parse(t))))}resolveExternalURL(e){return/^[^\\/]/.test(e)&&!/^http/.test(e)?this.workingPath+"/"+e:e}workingPathForURL(e){const t=e.split(/[\\/]/g);return t.pop(),t.join("/")+"/"}parse(e){throw new Error("LoaderBase: Parse not implemented.")}}function ob(e){let t;if(t=e instanceof DataView?e:new DataView(e),"{"===String.fromCharCode(t.getUint8(0)))return null;let n="";for(let e=0;e<4;e++)n+=String.fromCharCode(t.getUint8(e));return n}class lb extends ab{parse(e){const t=new DataView(e),n=ob(t);console.assert("b3dm"===n);const i=t.getUint32(4,!0);console.assert(1===i);const r=t.getUint32(8,!0);console.assert(r===e.byteLength);const s=t.getUint32(12,!0),a=t.getUint32(16,!0),o=t.getUint32(20,!0),l=t.getUint32(24,!0),c=e.slice(28,28+s+a),h=new ib(c,0,s,a),u=28+s+a,d=e.slice(u,u+o+l),p=new sb(d,h.getData("BATCH_LENGTH"),0,o,l),f=u+o+l;return{version:i,featureTable:h,batchTable:p,glbBytes:new Uint8Array(e,f,r-f)}}}function cb(e,t){if(t===Ke)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),e;if(t===$e||t===Je){let n=e.getIndex();if(null===n){const t=[],i=e.getAttribute("position");if(void 0===i)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(let e=0;e<i.count;e++)t.push(e);e.setIndex(t),n=e.getIndex()}const i=n.count-2,r=[];if(t===$e)for(let e=1;e<=i;e++)r.push(n.getX(0)),r.push(n.getX(e)),r.push(n.getX(e+1));else for(let e=0;e<i;e++)e%2==0?(r.push(n.getX(e)),r.push(n.getX(e+1)),r.push(n.getX(e+2))):(r.push(n.getX(e+2)),r.push(n.getX(e+1)),r.push(n.getX(e)));r.length/3!==i&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const s=e.clone();return s.setIndex(r),s.clearGroups(),s}return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",t),e}class hb extends jl{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register((function(e){return new gb(e)})),this.register((function(e){return new Ab(e)})),this.register((function(e){return new Sb(e)})),this.register((function(e){return new Cb(e)})),this.register((function(e){return new Tb(e)})),this.register((function(e){return new vb(e)})),this.register((function(e){return new _b(e)})),this.register((function(e){return new xb(e)})),this.register((function(e){return new Eb(e)})),this.register((function(e){return new mb(e)})),this.register((function(e){return new bb(e)})),this.register((function(e){return new yb(e)})),this.register((function(e){return new Mb(e)})),this.register((function(e){return new wb(e)})),this.register((function(e){return new pb(e)})),this.register((function(e){return new Ib(e)})),this.register((function(e){return new Rb(e)}))}load(e,t,n,i){const r=this;let s;if(""!==this.resourcePath)s=this.resourcePath;else if(""!==this.path){const t=dc.extractUrlBase(e);s=dc.resolveURL(t,this.path)}else s=dc.extractUrlBase(e);this.manager.itemStart(e);const a=function(t){i?i(t):console.error(t),r.manager.itemError(e),r.manager.itemEnd(e)},o=new Yl(this.manager);o.setPath(this.path),o.setResponseType("arraybuffer"),o.setRequestHeader(this.requestHeader),o.setWithCredentials(this.withCredentials),o.load(e,(function(n){try{r.parse(n,s,(function(n){t(n),r.manager.itemEnd(e)}),a)}catch(e){a(e)}}),n,a)}setDRACOLoader(e){return this.dracoLoader=e,this}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,n,i){let r;const s={},a={},o=new TextDecoder;if("string"==typeof e)r=JSON.parse(e);else if(e instanceof ArrayBuffer)if(o.decode(new Uint8Array(e,0,4))===Bb){try{s[db.KHR_BINARY_GLTF]=new Lb(e)}catch(e){return void(i&&i(e))}r=JSON.parse(s[db.KHR_BINARY_GLTF].content)}else r=JSON.parse(o.decode(e));else r=e;if(void 0===r.asset||r.asset.version[0]<2)return void(i&&i(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.")));const l=new ew(r,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});l.fileLoader.setRequestHeader(this.requestHeader);for(let e=0;e<this.pluginCallbacks.length;e++){const t=this.pluginCallbacks[e](l);t.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),a[t.name]=t,s[t.name]=!0}if(r.extensionsUsed)for(let e=0;e<r.extensionsUsed.length;++e){const t=r.extensionsUsed[e],n=r.extensionsRequired||[];switch(t){case db.KHR_MATERIALS_UNLIT:s[t]=new fb;break;case db.KHR_DRACO_MESH_COMPRESSION:s[t]=new Pb(r,this.dracoLoader);break;case db.KHR_TEXTURE_TRANSFORM:s[t]=new Db;break;case db.KHR_MESH_QUANTIZATION:s[t]=new Nb;break;default:n.indexOf(t)>=0&&void 0===a[t]&&console.warn('THREE.GLTFLoader: Unknown extension "'+t+'".')}}l.setExtensions(s),l.setPlugins(a),l.parse(n,i)}parseAsync(e,t){const n=this;return new Promise((function(i,r){n.parse(e,t,i,r)}))}}function ub(){let e={};return{get:function(t){return e[t]},add:function(t,n){e[t]=n},remove:function(t){delete e[t]},removeAll:function(){e={}}}}const db={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class pb{constructor(e){this.parser=e,this.name=db.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let n=0,i=t.length;n<i;n++){const i=t[n];i.extensions&&i.extensions[this.name]&&void 0!==i.extensions[this.name].light&&e._addNodeRef(this.cache,i.extensions[this.name].light)}}_loadLight(e){const t=this.parser,n="light:"+e;let i=t.cache.get(n);if(i)return i;const r=t.json,s=((r.extensions&&r.extensions[this.name]||{}).lights||[])[e];let a;const o=new Ci(16777215);void 0!==s.color&&o.setRGB(s.color[0],s.color[1],s.color[2],tt);const l=void 0!==s.range?s.range:0;switch(s.type){case"directional":a=new hc(o),a.target.position.set(0,0,-1),a.add(a.target);break;case"point":a=new lc(o),a.distance=l;break;case"spot":a=new ic(o),a.distance=l,s.spot=s.spot||{},s.spot.innerConeAngle=void 0!==s.spot.innerConeAngle?s.spot.innerConeAngle:0,s.spot.outerConeAngle=void 0!==s.spot.outerConeAngle?s.spot.outerConeAngle:Math.PI/4,a.angle=s.spot.outerConeAngle,a.penumbra=1-s.spot.innerConeAngle/s.spot.outerConeAngle,a.target.position.set(0,0,-1),a.add(a.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+s.type)}return a.position.set(0,0,0),a.decay=2,Yb(a,s),void 0!==s.intensity&&(a.intensity=s.intensity),a.name=t.createUniqueName(s.name||"light_"+e),i=Promise.resolve(a),t.cache.add(n,i),i}getDependency(e,t){if("light"===e)return this._loadLight(t)}createNodeAttachment(e){const t=this,n=this.parser,i=n.json.nodes[e],r=(i.extensions&&i.extensions[this.name]||{}).light;return void 0===r?null:this._loadLight(r).then((function(e){return n._getNodeRef(t.cache,r,e)}))}}class fb{constructor(){this.name=db.KHR_MATERIALS_UNLIT}getMaterialType(){return Bi}extendParams(e,t,n){const i=[];e.color=new Ci(1,1,1),e.opacity=1;const r=t.pbrMetallicRoughness;if(r){if(Array.isArray(r.baseColorFactor)){const t=r.baseColorFactor;e.color.setRGB(t[0],t[1],t[2],tt),e.opacity=t[3]}void 0!==r.baseColorTexture&&i.push(n.assignTexture(e,"map",r.baseColorTexture,et))}return Promise.all(i)}}class mb{constructor(e){this.parser=e,this.name=db.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=n.extensions[this.name].emissiveStrength;return void 0!==i&&(t.emissiveIntensity=i),Promise.resolve()}}class gb{constructor(e){this.parser=e,this.name=db.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?xl:null}extendMaterialParams(e,t){const n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],s=i.extensions[this.name];if(void 0!==s.clearcoatFactor&&(t.clearcoat=s.clearcoatFactor),void 0!==s.clearcoatTexture&&r.push(n.assignTexture(t,"clearcoatMap",s.clearcoatTexture)),void 0!==s.clearcoatRoughnessFactor&&(t.clearcoatRoughness=s.clearcoatRoughnessFactor),void 0!==s.clearcoatRoughnessTexture&&r.push(n.assignTexture(t,"clearcoatRoughnessMap",s.clearcoatRoughnessTexture)),void 0!==s.clearcoatNormalTexture&&(r.push(n.assignTexture(t,"clearcoatNormalMap",s.clearcoatNormalTexture)),void 0!==s.clearcoatNormalTexture.scale)){const e=s.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new It(e,e)}return Promise.all(r)}}class Ab{constructor(e){this.parser=e,this.name=db.KHR_MATERIALS_DISPERSION}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?xl:null}extendMaterialParams(e,t){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=n.extensions[this.name];return t.dispersion=void 0!==i.dispersion?i.dispersion:0,Promise.resolve()}}class yb{constructor(e){this.parser=e,this.name=db.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?xl:null}extendMaterialParams(e,t){const n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],s=i.extensions[this.name];return void 0!==s.iridescenceFactor&&(t.iridescence=s.iridescenceFactor),void 0!==s.iridescenceTexture&&r.push(n.assignTexture(t,"iridescenceMap",s.iridescenceTexture)),void 0!==s.iridescenceIor&&(t.iridescenceIOR=s.iridescenceIor),void 0===t.iridescenceThicknessRange&&(t.iridescenceThicknessRange=[100,400]),void 0!==s.iridescenceThicknessMinimum&&(t.iridescenceThicknessRange[0]=s.iridescenceThicknessMinimum),void 0!==s.iridescenceThicknessMaximum&&(t.iridescenceThicknessRange[1]=s.iridescenceThicknessMaximum),void 0!==s.iridescenceThicknessTexture&&r.push(n.assignTexture(t,"iridescenceThicknessMap",s.iridescenceThicknessTexture)),Promise.all(r)}}class vb{constructor(e){this.parser=e,this.name=db.KHR_MATERIALS_SHEEN}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?xl:null}extendMaterialParams(e,t){const n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[];t.sheenColor=new Ci(0,0,0),t.sheenRoughness=0,t.sheen=1;const s=i.extensions[this.name];if(void 0!==s.sheenColorFactor){const e=s.sheenColorFactor;t.sheenColor.setRGB(e[0],e[1],e[2],tt)}return void 0!==s.sheenRoughnessFactor&&(t.sheenRoughness=s.sheenRoughnessFactor),void 0!==s.sheenColorTexture&&r.push(n.assignTexture(t,"sheenColorMap",s.sheenColorTexture,et)),void 0!==s.sheenRoughnessTexture&&r.push(n.assignTexture(t,"sheenRoughnessMap",s.sheenRoughnessTexture)),Promise.all(r)}}class _b{constructor(e){this.parser=e,this.name=db.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?xl:null}extendMaterialParams(e,t){const n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],s=i.extensions[this.name];return void 0!==s.transmissionFactor&&(t.transmission=s.transmissionFactor),void 0!==s.transmissionTexture&&r.push(n.assignTexture(t,"transmissionMap",s.transmissionTexture)),Promise.all(r)}}class xb{constructor(e){this.parser=e,this.name=db.KHR_MATERIALS_VOLUME}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?xl:null}extendMaterialParams(e,t){const n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],s=i.extensions[this.name];t.thickness=void 0!==s.thicknessFactor?s.thicknessFactor:0,void 0!==s.thicknessTexture&&r.push(n.assignTexture(t,"thicknessMap",s.thicknessTexture)),t.attenuationDistance=s.attenuationDistance||1/0;const a=s.attenuationColor||[1,1,1];return t.attenuationColor=(new Ci).setRGB(a[0],a[1],a[2],tt),Promise.all(r)}}class Eb{constructor(e){this.parser=e,this.name=db.KHR_MATERIALS_IOR}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?xl:null}extendMaterialParams(e,t){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=n.extensions[this.name];return t.ior=void 0!==i.ior?i.ior:1.5,Promise.resolve()}}class bb{constructor(e){this.parser=e,this.name=db.KHR_MATERIALS_SPECULAR}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?xl:null}extendMaterialParams(e,t){const n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],s=i.extensions[this.name];t.specularIntensity=void 0!==s.specularFactor?s.specularFactor:1,void 0!==s.specularTexture&&r.push(n.assignTexture(t,"specularIntensityMap",s.specularTexture));const a=s.specularColorFactor||[1,1,1];return t.specularColor=(new Ci).setRGB(a[0],a[1],a[2],tt),void 0!==s.specularColorTexture&&r.push(n.assignTexture(t,"specularColorMap",s.specularColorTexture,et)),Promise.all(r)}}class wb{constructor(e){this.parser=e,this.name=db.EXT_MATERIALS_BUMP}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?xl:null}extendMaterialParams(e,t){const n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],s=i.extensions[this.name];return t.bumpScale=void 0!==s.bumpFactor?s.bumpFactor:1,void 0!==s.bumpTexture&&r.push(n.assignTexture(t,"bumpMap",s.bumpTexture)),Promise.all(r)}}class Mb{constructor(e){this.parser=e,this.name=db.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?xl:null}extendMaterialParams(e,t){const n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],s=i.extensions[this.name];return void 0!==s.anisotropyStrength&&(t.anisotropy=s.anisotropyStrength),void 0!==s.anisotropyRotation&&(t.anisotropyRotation=s.anisotropyRotation),void 0!==s.anisotropyTexture&&r.push(n.assignTexture(t,"anisotropyMap",s.anisotropyTexture)),Promise.all(r)}}class Sb{constructor(e){this.parser=e,this.name=db.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,n=t.json,i=n.textures[e];if(!i.extensions||!i.extensions[this.name])return null;const r=i.extensions[this.name],s=t.options.ktx2Loader;if(!s){if(n.extensionsRequired&&n.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,r.source,s)}}class Cb{constructor(e){this.parser=e,this.name=db.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){const t=this.name,n=this.parser,i=n.json,r=i.textures[e];if(!r.extensions||!r.extensions[t])return null;const s=r.extensions[t],a=i.images[s.source];let o=n.textureLoader;if(a.uri){const e=n.options.manager.getHandler(a.uri);null!==e&&(o=e)}return this.detectSupport().then((function(r){if(r)return n.loadTextureImage(e,s.source,o);if(i.extensionsRequired&&i.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return n.loadTexture(e)}))}detectSupport(){return this.isSupported||(this.isSupported=new Promise((function(e){const t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(1===t.height)}}))),this.isSupported}}class Tb{constructor(e){this.parser=e,this.name=db.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(e){const t=this.name,n=this.parser,i=n.json,r=i.textures[e];if(!r.extensions||!r.extensions[t])return null;const s=r.extensions[t],a=i.images[s.source];let o=n.textureLoader;if(a.uri){const e=n.options.manager.getHandler(a.uri);null!==e&&(o=e)}return this.detectSupport().then((function(r){if(r)return n.loadTextureImage(e,s.source,o);if(i.extensionsRequired&&i.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return n.loadTexture(e)}))}detectSupport(){return this.isSupported||(this.isSupported=new Promise((function(e){const t=new Image;t.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",t.onload=t.onerror=function(){e(1===t.height)}}))),this.isSupported}}class Ib{constructor(e){this.name=db.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,n=t.bufferViews[e];if(n.extensions&&n.extensions[this.name]){const e=n.extensions[this.name],i=this.parser.getDependency("buffer",e.buffer),r=this.parser.options.meshoptDecoder;if(!r||!r.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return i.then((function(t){const n=e.byteOffset||0,i=e.byteLength||0,s=e.count,a=e.byteStride,o=new Uint8Array(t,n,i);return r.decodeGltfBufferAsync?r.decodeGltfBufferAsync(s,a,o,e.mode,e.filter).then((function(e){return e.buffer})):r.ready.then((function(){const t=new ArrayBuffer(s*a);return r.decodeGltfBuffer(new Uint8Array(t),s,a,o,e.mode,e.filter),t}))}))}return null}}class Rb{constructor(e){this.name=db.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const t=this.parser.json,n=t.nodes[e];if(!n.extensions||!n.extensions[this.name]||void 0===n.mesh)return null;const i=t.meshes[n.mesh];for(const e of i.primitives)if(e.mode!==kb.TRIANGLES&&e.mode!==kb.TRIANGLE_STRIP&&e.mode!==kb.TRIANGLE_FAN&&void 0!==e.mode)return null;const r=n.extensions[this.name].attributes,s=[],a={};for(const e in r)s.push(this.parser.getDependency("accessor",r[e]).then((t=>(a[e]=t,a[e]))));return s.length<1?null:(s.push(this.parser.createNodeMesh(e)),Promise.all(s).then((e=>{const t=e.pop(),n=t.isGroup?t.children:[t],i=e[0].count,r=[];for(const e of n){const t=new Nn,n=new sn,s=new rn,o=new sn(1,1,1),l=new jo(e.geometry,e.material,i);for(let e=0;e<i;e++)a.TRANSLATION&&n.fromBufferAttribute(a.TRANSLATION,e),a.ROTATION&&s.fromBufferAttribute(a.ROTATION,e),a.SCALE&&o.fromBufferAttribute(a.SCALE,e),l.setMatrixAt(e,t.compose(n,s,o));for(const t in a)if("_COLOR_0"===t){const e=a[t];l.instanceColor=new Oo(e.array,e.itemSize,e.normalized)}else"TRANSLATION"!==t&&"ROTATION"!==t&&"SCALE"!==t&&e.geometry.setAttribute(t,a[t]);li.prototype.copy.call(l,e),this.parser.assignFinalMaterial(l),r.push(l)}return t.isGroup?(t.clear(),t.add(...r),t):r[0]})))}}const Bb="glTF";class Lb{constructor(e){this.name=db.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,12),n=new TextDecoder;if(this.header={magic:n.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==Bb)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const i=this.header.length-12,r=new DataView(e,12);let s=0;for(;s<i;){const t=r.getUint32(s,!0);s+=4;const i=r.getUint32(s,!0);if(s+=4,1313821514===i){const i=new Uint8Array(e,12+s,t);this.content=n.decode(i)}else if(5130562===i){const n=12+s;this.body=e.slice(n,n+t)}s+=t}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class Pb{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=db.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const n=this.json,i=this.dracoLoader,r=e.extensions[this.name].bufferView,s=e.extensions[this.name].attributes,a={},o={},l={};for(const e in s){const t=Vb[e]||e.toLowerCase();a[t]=s[e]}for(const t in e.attributes){const i=Vb[t]||t.toLowerCase();if(void 0!==s[t]){const r=n.accessors[e.attributes[t]],s=Qb[r.componentType];l[i]=s.name,o[i]=!0===r.normalized}}return t.getDependency("bufferView",r).then((function(e){return new Promise((function(t,n){i.decodeDracoFile(e,(function(e){for(const t in e.attributes){const n=e.attributes[t],i=o[t];void 0!==i&&(n.normalized=i)}t(e)}),a,l,tt,n)}))}))}}class Db{constructor(){this.name=db.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return void 0!==t.texCoord&&t.texCoord!==e.channel||void 0!==t.offset||void 0!==t.rotation||void 0!==t.scale?(e=e.clone(),void 0!==t.texCoord&&(e.channel=t.texCoord),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),e.needsUpdate=!0,e):e}}class Nb{constructor(){this.name=db.KHR_MESH_QUANTIZATION}}class Ub extends Tl{constructor(e,t,n,i){super(e,t,n,i)}copySampleValue_(e){const t=this.resultBuffer,n=this.sampleValues,i=this.valueSize,r=e*i*3+i;for(let e=0;e!==i;e++)t[e]=n[r+e];return t}interpolate_(e,t,n,i){const r=this.resultBuffer,s=this.sampleValues,a=this.valueSize,o=2*a,l=3*a,c=i-t,h=(n-t)/c,u=h*h,d=u*h,p=e*l,f=p-l,m=-2*d+3*u,g=d-u,A=1-m,y=g-u+h;for(let e=0;e!==a;e++){const t=s[f+e+a],n=s[f+e+o]*c,i=s[p+e+a],l=s[p+e]*c;r[e]=A*t+y*n+m*i+g*l}return r}}const Ob=new rn;class Fb extends Ub{interpolate_(e,t,n,i){const r=super.interpolate_(e,t,n,i);return Ob.fromArray(r).normalize().toArray(r),r}}const kb={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123},Qb={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},zb={9728:V,9729:W,9984:j,9985:Y,9986:q,9987:X},Gb={33071:G,33648:H,10497:z},Hb={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},Vb={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},jb={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},qb={CUBICSPLINE:void 0,LINEAR:Ye,STEP:We};function Wb(e,t,n){for(const i in n.extensions)void 0===e[i]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[i]=n.extensions[i])}function Yb(e,t){void 0!==t.extras&&("object"==typeof t.extras?Object.assign(e.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function Xb(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(let n=0,i=t.weights.length;n<i;n++)e.morphTargetInfluences[n]=t.weights[n];if(t.extras&&Array.isArray(t.extras.targetNames)){const n=t.extras.targetNames;if(e.morphTargetInfluences.length===n.length){e.morphTargetDictionary={};for(let t=0,i=n.length;t<i;t++)e.morphTargetDictionary[n[t]]=t}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function Kb(e){let t;const n=e.extensions&&e.extensions[db.KHR_DRACO_MESH_COMPRESSION];if(t=n?"draco:"+n.bufferView+":"+n.indices+":"+Jb(n.attributes):e.indices+":"+Jb(e.attributes)+":"+e.mode,void 0!==e.targets)for(let n=0,i=e.targets.length;n<i;n++)t+=":"+Jb(e.targets[n]);return t}function Jb(e){let t="";const n=Object.keys(e).sort();for(let i=0,r=n.length;i<r;i++)t+=n[i]+":"+e[n[i]]+";";return t}function $b(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}const Zb=new Nn;class ew{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new ub,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let n=!1,i=-1,r=!1,s=-1;if("undefined"!=typeof navigator){const e=navigator.userAgent;n=!0===/^((?!chrome|android).)*safari/i.test(e);const t=e.match(/Version\/(\d+)/);i=n&&t?parseInt(t[1],10):-1,r=e.indexOf("Firefox")>-1,s=r?e.match(/Firefox\/([0-9]+)\./)[1]:-1}"undefined"==typeof createImageBitmap||n&&i<17||r&&s<98?this.textureLoader=new Kl(this.options.manager):this.textureLoader=new pc(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new Yl(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const n=this,i=this.json,r=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll((function(e){return e._markDefs&&e._markDefs()})),Promise.all(this._invokeAll((function(e){return e.beforeRoot&&e.beforeRoot()}))).then((function(){return Promise.all([n.getDependencies("scene"),n.getDependencies("animation"),n.getDependencies("camera")])})).then((function(t){const s={scene:t[0][i.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:i.asset,parser:n,userData:{}};return Wb(r,s,i),Yb(s,i),Promise.all(n._invokeAll((function(e){return e.afterRoot&&e.afterRoot(s)}))).then((function(){for(const e of s.scenes)e.updateMatrixWorld();e(s)}))})).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],n=this.json.meshes||[];for(let n=0,i=t.length;n<i;n++){const i=t[n].joints;for(let t=0,n=i.length;t<n;t++)e[i[t]].isBone=!0}for(let t=0,i=e.length;t<i;t++){const i=e[t];void 0!==i.mesh&&(this._addNodeRef(this.meshCache,i.mesh),void 0!==i.skin&&(n[i.mesh].isSkinnedMesh=!0)),void 0!==i.camera&&this._addNodeRef(this.cameraCache,i.camera)}}_addNodeRef(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,n){if(e.refs[t]<=1)return n;const i=n.clone(),r=(e,t)=>{const n=this.associations.get(e);null!=n&&this.associations.set(t,n);for(const[n,i]of e.children.entries())r(i,t.children[n])};return r(n,i),i.name+="_instance_"+e.uses[t]++,i}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let n=0;n<t.length;n++){const i=e(t[n]);if(i)return i}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const n=[];for(let i=0;i<t.length;i++){const r=e(t[i]);r&&n.push(r)}return n}getDependency(e,t){const n=e+":"+t;let i=this.cache.get(n);if(!i){switch(e){case"scene":i=this.loadScene(t);break;case"node":i=this._invokeOne((function(e){return e.loadNode&&e.loadNode(t)}));break;case"mesh":i=this._invokeOne((function(e){return e.loadMesh&&e.loadMesh(t)}));break;case"accessor":i=this.loadAccessor(t);break;case"bufferView":i=this._invokeOne((function(e){return e.loadBufferView&&e.loadBufferView(t)}));break;case"buffer":i=this.loadBuffer(t);break;case"material":i=this._invokeOne((function(e){return e.loadMaterial&&e.loadMaterial(t)}));break;case"texture":i=this._invokeOne((function(e){return e.loadTexture&&e.loadTexture(t)}));break;case"skin":i=this.loadSkin(t);break;case"animation":i=this._invokeOne((function(e){return e.loadAnimation&&e.loadAnimation(t)}));break;case"camera":i=this.loadCamera(t);break;default:if(i=this._invokeOne((function(n){return n!=this&&n.getDependency&&n.getDependency(e,t)})),!i)throw new Error("Unknown type: "+e)}this.cache.add(n,i)}return i}getDependencies(e){let t=this.cache.get(e);if(!t){const n=this,i=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(i.map((function(t,i){return n.getDependency(e,i)}))),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],n=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[db.KHR_BINARY_GLTF].body);const i=this.options;return new Promise((function(e,r){n.load(dc.resolveURL(t.uri,i.path),e,void 0,(function(){r(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))}))}))}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then((function(e){const n=t.byteLength||0,i=t.byteOffset||0;return e.slice(i,i+n)}))}loadAccessor(e){const t=this,n=this.json,i=this.json.accessors[e];if(void 0===i.bufferView&&void 0===i.sparse){const e=Hb[i.type],t=Qb[i.componentType],n=!0===i.normalized,r=new t(i.count*e);return Promise.resolve(new Di(r,e,n))}const r=[];return void 0!==i.bufferView?r.push(this.getDependency("bufferView",i.bufferView)):r.push(null),void 0!==i.sparse&&(r.push(this.getDependency("bufferView",i.sparse.indices.bufferView)),r.push(this.getDependency("bufferView",i.sparse.values.bufferView))),Promise.all(r).then((function(e){const r=e[0],s=Hb[i.type],a=Qb[i.componentType],o=a.BYTES_PER_ELEMENT,l=o*s,c=i.byteOffset||0,h=void 0!==i.bufferView?n.bufferViews[i.bufferView].byteStride:void 0,u=!0===i.normalized;let d,p;if(h&&h!==l){const e=Math.floor(c/h),n="InterleavedBuffer:"+i.bufferView+":"+i.componentType+":"+e+":"+i.count;let l=t.cache.get(n);l||(d=new a(r,e*h,i.count*h/o),l=new vo(d,h/o),t.cache.add(n,l)),p=new xo(l,s,c%h/o,u)}else d=null===r?new a(i.count*s):new a(r,c,i.count*s),p=new Di(d,s,u);if(void 0!==i.sparse){const t=Hb.SCALAR,n=Qb[i.sparse.indices.componentType],o=i.sparse.indices.byteOffset||0,l=i.sparse.values.byteOffset||0,c=new n(e[1],o,i.sparse.count*t),h=new a(e[2],l,i.sparse.count*s);null!==r&&(p=new Di(p.array.slice(),p.itemSize,p.normalized)),p.normalized=!1;for(let e=0,t=c.length;e<t;e++){const t=c[e];if(p.setX(t,h[e*s]),s>=2&&p.setY(t,h[e*s+1]),s>=3&&p.setZ(t,h[e*s+2]),s>=4&&p.setW(t,h[e*s+3]),s>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}p.normalized=u}return p}))}loadTexture(e){const t=this.json,n=this.options,i=t.textures[e].source,r=t.images[i];let s=this.textureLoader;if(r.uri){const e=n.manager.getHandler(r.uri);null!==e&&(s=e)}return this.loadTextureImage(e,i,s)}loadTextureImage(e,t,n){const i=this,r=this.json,s=r.textures[e],a=r.images[t],o=(a.uri||a.bufferView)+":"+s.sampler;if(this.textureCache[o])return this.textureCache[o];const l=this.loadImageSource(t,n).then((function(t){t.flipY=!1,t.name=s.name||a.name||"",""===t.name&&"string"==typeof a.uri&&!1===a.uri.startsWith("data:image/")&&(t.name=a.uri);const n=(r.samplers||{})[s.sampler]||{};return t.magFilter=zb[n.magFilter]||W,t.minFilter=zb[n.minFilter]||X,t.wrapS=Gb[n.wrapS]||z,t.wrapT=Gb[n.wrapT]||z,t.generateMipmaps=!t.isCompressedTexture&&t.minFilter!==V&&t.minFilter!==W,i.associations.set(t,{textures:e}),t})).catch((function(){return null}));return this.textureCache[o]=l,l}loadImageSource(e,t){const n=this.json,i=this.options;if(void 0!==this.sourceCache[e])return this.sourceCache[e].then((e=>e.clone()));const r=n.images[e],s=self.URL||self.webkitURL;let a=r.uri||"",o=!1;if(void 0!==r.bufferView)a=this.getDependency("bufferView",r.bufferView).then((function(e){o=!0;const t=new Blob([e],{type:r.mimeType});return a=s.createObjectURL(t),a}));else if(void 0===r.uri)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const l=Promise.resolve(a).then((function(e){return new Promise((function(n,r){let s=n;!0===t.isImageBitmapLoader&&(s=function(e){const t=new Jt(e);t.needsUpdate=!0,n(t)}),t.load(dc.resolveURL(e,i.path),s,void 0,r)}))})).then((function(e){var t;return!0===o&&s.revokeObjectURL(a),Yb(e,r),e.userData.mimeType=r.mimeType||((t=r.uri).search(/\.jpe?g($|\?)/i)>0||0===t.search(/^data\:image\/jpeg/)?"image/jpeg":t.search(/\.webp($|\?)/i)>0||0===t.search(/^data\:image\/webp/)?"image/webp":t.search(/\.ktx2($|\?)/i)>0||0===t.search(/^data\:image\/ktx2/)?"image/ktx2":"image/png"),e})).catch((function(e){throw console.error("THREE.GLTFLoader: Couldn't load texture",a),e}));return this.sourceCache[e]=l,l}assignTexture(e,t,n,i){const r=this;return this.getDependency("texture",n.index).then((function(s){if(!s)return null;if(void 0!==n.texCoord&&n.texCoord>0&&((s=s.clone()).channel=n.texCoord),r.extensions[db.KHR_TEXTURE_TRANSFORM]){const e=void 0!==n.extensions?n.extensions[db.KHR_TEXTURE_TRANSFORM]:void 0;if(e){const t=r.associations.get(s);s=r.extensions[db.KHR_TEXTURE_TRANSFORM].extendTexture(s,e),r.associations.set(s,t)}}return void 0!==i&&(s.colorSpace=i),e[t]=s,s}))}assignFinalMaterial(e){const t=e.geometry;let n=e.material;const i=void 0===t.attributes.tangent,r=void 0!==t.attributes.color,s=void 0===t.attributes.normal;if(e.isPoints){const e="PointsMaterial:"+n.uuid;let t=this.cache.get(e);t||(t=new al,Ri.prototype.copy.call(t,n),t.color.copy(n.color),t.map=n.map,t.sizeAttenuation=!1,this.cache.add(e,t)),n=t}else if(e.isLine){const e="LineBasicMaterial:"+n.uuid;let t=this.cache.get(e);t||(t=new qo,Ri.prototype.copy.call(t,n),t.color.copy(n.color),t.map=n.map,this.cache.add(e,t)),n=t}if(i||r||s){let e="ClonedMaterial:"+n.uuid+":";i&&(e+="derivative-tangents:"),r&&(e+="vertex-colors:"),s&&(e+="flat-shading:");let t=this.cache.get(e);t||(t=n.clone(),r&&(t.vertexColors=!0),s&&(t.flatShading=!0),i&&(t.normalScale&&(t.normalScale.y*=-1),t.clearcoatNormalScale&&(t.clearcoatNormalScale.y*=-1)),this.cache.add(e,t),this.associations.set(t,this.associations.get(n))),n=t}e.material=n}getMaterialType(){return _l}loadMaterial(e){const t=this,n=this.json,i=this.extensions,r=n.materials[e];let s;const o={},l=[];if((r.extensions||{})[db.KHR_MATERIALS_UNLIT]){const e=i[db.KHR_MATERIALS_UNLIT];s=e.getMaterialType(),l.push(e.extendParams(o,r,t))}else{const n=r.pbrMetallicRoughness||{};if(o.color=new Ci(1,1,1),o.opacity=1,Array.isArray(n.baseColorFactor)){const e=n.baseColorFactor;o.color.setRGB(e[0],e[1],e[2],tt),o.opacity=e[3]}void 0!==n.baseColorTexture&&l.push(t.assignTexture(o,"map",n.baseColorTexture,et)),o.metalness=void 0!==n.metallicFactor?n.metallicFactor:1,o.roughness=void 0!==n.roughnessFactor?n.roughnessFactor:1,void 0!==n.metallicRoughnessTexture&&(l.push(t.assignTexture(o,"metalnessMap",n.metallicRoughnessTexture)),l.push(t.assignTexture(o,"roughnessMap",n.metallicRoughnessTexture))),s=this._invokeOne((function(t){return t.getMaterialType&&t.getMaterialType(e)})),l.push(Promise.all(this._invokeAll((function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,o)}))))}!0===r.doubleSided&&(o.side=a);const c=r.alphaMode||"OPAQUE";if("BLEND"===c?(o.transparent=!0,o.depthWrite=!1):(o.transparent=!1,"MASK"===c&&(o.alphaTest=void 0!==r.alphaCutoff?r.alphaCutoff:.5)),void 0!==r.normalTexture&&s!==Bi&&(l.push(t.assignTexture(o,"normalMap",r.normalTexture)),o.normalScale=new It(1,1),void 0!==r.normalTexture.scale)){const e=r.normalTexture.scale;o.normalScale.set(e,e)}if(void 0!==r.occlusionTexture&&s!==Bi&&(l.push(t.assignTexture(o,"aoMap",r.occlusionTexture)),void 0!==r.occlusionTexture.strength&&(o.aoMapIntensity=r.occlusionTexture.strength)),void 0!==r.emissiveFactor&&s!==Bi){const e=r.emissiveFactor;o.emissive=(new Ci).setRGB(e[0],e[1],e[2],tt)}return void 0!==r.emissiveTexture&&s!==Bi&&l.push(t.assignTexture(o,"emissiveMap",r.emissiveTexture,et)),Promise.all(l).then((function(){const n=new s(o);return r.name&&(n.name=r.name),Yb(n,r),t.associations.set(n,{materials:e}),r.extensions&&Wb(i,n,r),n}))}createUniqueName(e){const t=_c.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){const t=this,n=this.extensions,i=this.primitiveCache;function r(e){return n[db.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then((function(n){return tw(n,e,t)}))}const s=[];for(let n=0,a=e.length;n<a;n++){const a=e[n],o=Kb(a),l=i[o];if(l)s.push(l.promise);else{let e;e=a.extensions&&a.extensions[db.KHR_DRACO_MESH_COMPRESSION]?r(a):tw(new ji,a,t),i[o]={primitive:a,promise:e},s.push(e)}}return Promise.all(s)}loadMesh(e){const t=this,n=this.json,i=this.extensions,s=n.meshes[e],a=s.primitives,o=[];for(let e=0,t=a.length;e<t;e++){const t=void 0===a[e].material?(void 0===(l=this.cache).DefaultMaterial&&(l.DefaultMaterial=new _l({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:r})),l.DefaultMaterial):this.getDependency("material",a[e].material);o.push(t)}var l;return o.push(t.loadGeometries(a)),Promise.all(o).then((function(n){const r=n.slice(0,n.length-1),o=n[n.length-1],l=[];for(let n=0,c=o.length;n<c;n++){const c=o[n],h=a[n];let u;const d=r[n];if(h.mode===kb.TRIANGLES||h.mode===kb.TRIANGLE_STRIP||h.mode===kb.TRIANGLE_FAN||void 0===h.mode)u=!0===s.isSkinnedMesh?new Bo(c,d):new ir(c,d),!0===u.isSkinnedMesh&&u.normalizeSkinWeights(),h.mode===kb.TRIANGLE_STRIP?u.geometry=cb(u.geometry,Je):h.mode===kb.TRIANGLE_FAN&&(u.geometry=cb(u.geometry,$e));else if(h.mode===kb.LINES)u=new rl(c,d);else if(h.mode===kb.LINE_STRIP)u=new el(c,d);else if(h.mode===kb.LINE_LOOP)u=new sl(c,d);else{if(h.mode!==kb.POINTS)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+h.mode);u=new ul(c,d)}Object.keys(u.geometry.morphAttributes).length>0&&Xb(u,s),u.name=t.createUniqueName(s.name||"mesh_"+e),Yb(u,s),h.extensions&&Wb(i,u,h),t.assignFinalMaterial(u),l.push(u)}for(let n=0,i=l.length;n<i;n++)t.associations.set(l[n],{meshes:e,primitives:n});if(1===l.length)return s.extensions&&Wb(i,l[0],s),l[0];const c=new oo;s.extensions&&Wb(i,c,s),t.associations.set(c,{meshes:e});for(let e=0,t=l.length;e<t;e++)c.add(l[e]);return c}))}loadCamera(e){let t;const n=this.json.cameras[e],i=n[n.type];if(i)return"perspective"===n.type?t=new mr(Tt.radToDeg(i.yfov),i.aspectRatio||1,i.znear||1,i.zfar||2e6):"orthographic"===n.type&&(t=new Gr(-i.xmag,i.xmag,i.ymag,-i.ymag,i.znear,i.zfar)),n.name&&(t.name=this.createUniqueName(n.name)),Yb(t,n),Promise.resolve(t);console.warn("THREE.GLTFLoader: Missing camera parameters.")}loadSkin(e){const t=this.json.skins[e],n=[];for(let e=0,i=t.joints.length;e<i;e++)n.push(this._loadNodeShallow(t.joints[e]));return void 0!==t.inverseBindMatrices?n.push(this.getDependency("accessor",t.inverseBindMatrices)):n.push(null),Promise.all(n).then((function(e){const n=e.pop(),i=e,r=[],s=[];for(let e=0,a=i.length;e<a;e++){const a=i[e];if(a){r.push(a);const t=new Nn;null!==n&&t.fromArray(n.array,16*e),s.push(t)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[e])}return new Uo(r,s)}))}loadAnimation(e){const t=this.json,n=this,i=t.animations[e],r=i.name?i.name:"animation_"+e,s=[],a=[],o=[],l=[],c=[];for(let e=0,t=i.channels.length;e<t;e++){const t=i.channels[e],n=i.samplers[t.sampler],r=t.target,h=r.node,u=void 0!==i.parameters?i.parameters[n.input]:n.input,d=void 0!==i.parameters?i.parameters[n.output]:n.output;void 0!==r.node&&(s.push(this.getDependency("node",h)),a.push(this.getDependency("accessor",u)),o.push(this.getDependency("accessor",d)),l.push(n),c.push(r))}return Promise.all([Promise.all(s),Promise.all(a),Promise.all(o),Promise.all(l),Promise.all(c)]).then((function(e){const t=e[0],i=e[1],s=e[2],a=e[3],o=e[4],l=[];for(let e=0,r=t.length;e<r;e++){const r=t[e],c=i[e],h=s[e],u=a[e],d=o[e];if(void 0===r)continue;r.updateMatrix&&r.updateMatrix();const p=n._createAnimationTracks(r,c,h,u,d);if(p)for(let e=0;e<p.length;e++)l.push(p[e])}return new Ql(r,void 0,l)}))}createNodeMesh(e){const t=this.json,n=this,i=t.nodes[e];return void 0===i.mesh?null:n.getDependency("mesh",i.mesh).then((function(e){const t=n._getNodeRef(n.meshCache,i.mesh,e);return void 0!==i.weights&&t.traverse((function(e){if(e.isMesh)for(let t=0,n=i.weights.length;t<n;t++)e.morphTargetInfluences[t]=i.weights[t]})),t}))}loadNode(e){const t=this,n=this.json.nodes[e],i=t._loadNodeShallow(e),r=[],s=n.children||[];for(let e=0,n=s.length;e<n;e++)r.push(t.getDependency("node",s[e]));const a=void 0===n.skin?Promise.resolve(null):t.getDependency("skin",n.skin);return Promise.all([i,Promise.all(r),a]).then((function(e){const t=e[0],n=e[1],i=e[2];null!==i&&t.traverse((function(e){e.isSkinnedMesh&&e.bind(i,Zb)}));for(let e=0,i=n.length;e<i;e++)t.add(n[e]);return t}))}_loadNodeShallow(e){const t=this.json,n=this.extensions,i=this;if(void 0!==this.nodeCache[e])return this.nodeCache[e];const r=t.nodes[e],s=r.name?i.createUniqueName(r.name):"",a=[],o=i._invokeOne((function(t){return t.createNodeMesh&&t.createNodeMesh(e)}));return o&&a.push(o),void 0!==r.camera&&a.push(i.getDependency("camera",r.camera).then((function(e){return i._getNodeRef(i.cameraCache,r.camera,e)}))),i._invokeAll((function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)})).forEach((function(e){a.push(e)})),this.nodeCache[e]=Promise.all(a).then((function(t){let a;if(a=!0===r.isBone?new Lo:t.length>1?new oo:1===t.length?t[0]:new li,a!==t[0])for(let e=0,n=t.length;e<n;e++)a.add(t[e]);if(r.name&&(a.userData.name=r.name,a.name=s),Yb(a,r),r.extensions&&Wb(n,a,r),void 0!==r.matrix){const e=new Nn;e.fromArray(r.matrix),a.applyMatrix4(e)}else void 0!==r.translation&&a.position.fromArray(r.translation),void 0!==r.rotation&&a.quaternion.fromArray(r.rotation),void 0!==r.scale&&a.scale.fromArray(r.scale);return i.associations.has(a)||i.associations.set(a,{}),i.associations.get(a).nodes=e,a})),this.nodeCache[e]}loadScene(e){const t=this.extensions,n=this.json.scenes[e],i=this,r=new oo;n.name&&(r.name=i.createUniqueName(n.name)),Yb(r,n),n.extensions&&Wb(t,r,n);const s=n.nodes||[],a=[];for(let e=0,t=s.length;e<t;e++)a.push(i.getDependency("node",s[e]));return Promise.all(a).then((function(e){for(let t=0,n=e.length;t<n;t++)r.add(e[t]);return i.associations=(e=>{const t=new Map;for(const[e,n]of i.associations)(e instanceof Ri||e instanceof Jt)&&t.set(e,n);return e.traverse((e=>{const n=i.associations.get(e);null!=n&&t.set(e,n)})),t})(r),r}))}_createAnimationTracks(e,t,n,i,r){const s=[],a=e.name?e.name:e.uuid,o=[];let l;switch(jb[r.path]===jb.weights?e.traverse((function(e){e.morphTargetInfluences&&o.push(e.name?e.name:e.uuid)})):o.push(a),jb[r.path]){case jb.weights:l=Nl;break;case jb.rotation:l=Ol;break;case jb.position:case jb.scale:l=kl;break;default:l=1===n.itemSize?Nl:kl}const c=void 0!==i.interpolation?qb[i.interpolation]:Ye,h=this._getArrayFromAccessor(n);for(let e=0,n=o.length;e<n;e++){const n=new l(o[e]+"."+jb[r.path],t.array,h,c);"CUBICSPLINE"===i.interpolation&&this._createCubicSplineTrackInterpolant(n),s.push(n)}return s}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){const e=$b(t.constructor),n=new Float32Array(t.length);for(let i=0,r=t.length;i<r;i++)n[i]=t[i]*e;t=n}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(e){return new(this instanceof Ol?Fb:Ub)(this.times,this.values,this.getValueSize()/3,e)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function tw(e,t,n){const i=t.attributes,r=[];function s(t,i){return n.getDependency("accessor",t).then((function(t){e.setAttribute(i,t)}))}for(const t in i){const n=Vb[t]||t.toLowerCase();n in e.attributes||r.push(s(i[t],n))}if(void 0!==t.indices&&!e.index){const i=n.getDependency("accessor",t.indices).then((function(t){e.setIndex(t)}));r.push(i)}return Ot.workingColorSpace!==tt&&"COLOR_0"in i&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${Ot.workingColorSpace}" not supported.`),Yb(e,t),function(e,t,n){const i=t.attributes,r=new ln;if(void 0===i.POSITION)return;{const e=n.json.accessors[i.POSITION],t=e.min,s=e.max;if(void 0===t||void 0===s)return void console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");if(r.set(new sn(t[0],t[1],t[2]),new sn(s[0],s[1],s[2])),e.normalized){const t=$b(Qb[e.componentType]);r.min.multiplyScalar(t),r.max.multiplyScalar(t)}}const s=t.targets;if(void 0!==s){const e=new sn,t=new sn;for(let i=0,r=s.length;i<r;i++){const r=s[i];if(void 0!==r.POSITION){const i=n.json.accessors[r.POSITION],s=i.min,a=i.max;if(void 0!==s&&void 0!==a){if(t.setX(Math.max(Math.abs(s[0]),Math.abs(a[0]))),t.setY(Math.max(Math.abs(s[1]),Math.abs(a[1]))),t.setZ(Math.max(Math.abs(s[2]),Math.abs(a[2]))),i.normalized){const e=$b(Qb[i.componentType]);t.multiplyScalar(e)}e.max(t)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}r.expandByVector(e)}e.boundingBox=r;const a=new Sn;r.getCenter(a.center),a.radius=r.min.distanceTo(r.max)/2,e.boundingSphere=a}(e,t,n),Promise.all(r).then((function(){return void 0!==t.targets?function(e,t,n){let i=!1,r=!1,s=!1;for(let e=0,n=t.length;e<n;e++){const n=t[e];if(void 0!==n.POSITION&&(i=!0),void 0!==n.NORMAL&&(r=!0),void 0!==n.COLOR_0&&(s=!0),i&&r&&s)break}if(!i&&!r&&!s)return Promise.resolve(e);const a=[],o=[],l=[];for(let c=0,h=t.length;c<h;c++){const h=t[c];if(i){const t=void 0!==h.POSITION?n.getDependency("accessor",h.POSITION):e.attributes.position;a.push(t)}if(r){const t=void 0!==h.NORMAL?n.getDependency("accessor",h.NORMAL):e.attributes.normal;o.push(t)}if(s){const t=void 0!==h.COLOR_0?n.getDependency("accessor",h.COLOR_0):e.attributes.color;l.push(t)}}return Promise.all([Promise.all(a),Promise.all(o),Promise.all(l)]).then((function(t){const n=t[0],a=t[1],o=t[2];return i&&(e.morphAttributes.position=n),r&&(e.morphAttributes.normal=a),s&&(e.morphAttributes.color=o),e.morphTargetsRelative=!0,e}))}(e,t.targets,n):e}))}class nw extends lb{constructor(e=Vl){super(),this.manager=e,this.adjustmentTransform=new Nn}parse(e){const t=super.parse(e),n=t.glbBytes.slice().buffer;return new Promise(((e,i)=>{const r=this.manager,s=this.fetchOptions,a=r.getHandler("path.gltf")||new hb(r);"include"===s.credentials&&"cors"===s.mode&&a.setCrossOrigin("use-credentials"),"credentials"in s&&a.setWithCredentials("include"===s.credentials),s.headers&&a.setRequestHeader(s.headers);let o=this.workingPath;!/[\\/]$/.test(o)&&o.length&&(o+="/");const l=this.adjustmentTransform;a.parse(n,o,(n=>{const{batchTable:i,featureTable:r}=t,{scene:s}=n,a=r.getData("RTC_CENTER");a&&(s.position.x+=a[0],s.position.y+=a[1],s.position.z+=a[2]),n.scene.updateMatrix(),n.scene.matrix.multiply(l),n.scene.matrix.decompose(n.scene.position,n.scene.quaternion,n.scene.scale),n.batchTable=i,n.featureTable=r,s.batchTable=i,s.featureTable=r,e(n)}),i)}))}}class iw extends ab{parse(e){const t=new DataView(e),n=ob(t);console.assert("pnts"===n);const i=t.getUint32(4,!0);console.assert(1===i);const r=t.getUint32(8,!0);console.assert(r===e.byteLength);const s=t.getUint32(12,!0),a=t.getUint32(16,!0),o=t.getUint32(20,!0),l=t.getUint32(24,!0),c=e.slice(28,28+s+a),h=new ib(c,0,s,a),u=28+s+a,d=e.slice(u,u+o+l),p=new sb(d,h.getData("BATCH_LENGTH")||h.getData("POINTS_LENGTH"),0,o,l);return Promise.resolve({version:i,featureTable:h,batchTable:p})}}function rw(e){const t=e>>11,n=e>>5&63,i=31&e;return[Math.round(t/31*255),Math.round(n/63*255),Math.round(i/31*255)]}const sw=new It;function aw(e,t,n=new sn){sw.set(e,t).divideScalar(256).multiplyScalar(2).subScalar(1),n.set(sw.x,sw.y,1-Math.abs(sw.x)-Math.abs(sw.y));const i=Tt.clamp(-n.z,0,1);return n.x>=0?n.setX(n.x-i):n.setX(n.x+i),n.y>=0?n.setY(n.y-i):n.setY(n.y+i),n.normalize(),n}const ow={RGB:"color",POSITION:"position"};class lw extends iw{constructor(e=Vl){super(),this.manager=e}parse(e){return super.parse(e).then((async e=>{const{featureTable:t,batchTable:n}=e,i=new al,r=t.header.extensions,s=new sn;let a;if(r&&r["3DTILES_draco_point_compression"]){const{byteOffset:e,byteLength:n,properties:s}=r["3DTILES_draco_point_compression"],o=this.manager.getHandler("draco.drc");if(null==o)throw new Error("PNTSLoader: dracoLoader not available.");const l={};for(const e in s)e in ow&&e in s&&(l[ow[e]]=s[e]);const c={attributeIDs:l,attributeTypes:{position:"Float32Array",color:"Uint8Array"},useUniqueIDs:!0},h=t.getBuffer(e,n);a=await o.decodeGeometry(h,c),a.attributes.color&&(i.vertexColors=!0)}else{const e=t.getData("POINTS_LENGTH"),n=t.getData("POSITION",e,"FLOAT","VEC3"),r=t.getData("NORMAL",e,"FLOAT","VEC3"),o=t.getData("NORMAL",e,"UNSIGNED_BYTE","VEC2"),l=t.getData("RGB",e,"UNSIGNED_BYTE","VEC3"),c=t.getData("RGBA",e,"UNSIGNED_BYTE","VEC4"),h=t.getData("RGB565",e,"UNSIGNED_SHORT","SCALAR"),u=t.getData("CONSTANT_RGBA",e,"UNSIGNED_BYTE","VEC4"),d=t.getData("POSITION_QUANTIZED",e,"UNSIGNED_SHORT","VEC3"),p=t.getData("QUANTIZED_VOLUME_SCALE",e,"FLOAT","VEC3"),f=t.getData("QUANTIZED_VOLUME_OFFSET",e,"FLOAT","VEC3");if(a=new ji,d){const t=new Float32Array(3*e);for(let n=0;n<e;n++)for(let e=0;e<3;e++){const i=3*n+e;t[i]=d[i]/65535*p[e]}s.x=f[0],s.y=f[1],s.z=f[2],a.setAttribute("position",new Di(t,3,!1))}else a.setAttribute("position",new Di(n,3,!1));if(null!==r)a.setAttribute("normal",new Di(r,3,!1));else if(null!==o){const t=new Float32Array(3*e),n=new sn;for(let i=0;i<e;i++){const e=aw(o[2*i],o[2*i+1],n);t[3*i]=e.x,t[3*i+1]=e.y,t[3*i+2]=e.z}a.setAttribute("normal",new Di(t,3,!1))}if(null!==c)a.setAttribute("color",new Di(c,4,!0)),i.vertexColors=!0,i.transparent=!0,i.depthWrite=!1;else if(null!==l)a.setAttribute("color",new Di(l,3,!0)),i.vertexColors=!0;else if(null!==h){const t=new Uint8Array(3*e);for(let n=0;n<e;n++){const e=rw(h[n]);for(let i=0;i<3;i++)t[3*n+i]=e[i]}a.setAttribute("color",new Di(t,3,!0)),i.vertexColors=!0}else if(null!==u){const e=new Ci(u[0],u[1],u[2]);i.color=e;const t=u[3]/255;t<1&&(i.opacity=t,i.transparent=!0,i.depthWrite=!1)}}const o=new ul(a,i);o.position.copy(s),e.scene=o,e.scene.featureTable=t,e.scene.batchTable=n;const l=t.getData("RTC_CENTER");return l&&(e.scene.position.x+=l[0],e.scene.position.y+=l[1],e.scene.position.z+=l[2]),e}))}}class cw extends ab{parse(e){const t=new DataView(e),n=ob(t);console.assert("i3dm"===n);const i=t.getUint32(4,!0);console.assert(1===i);const r=t.getUint32(8,!0);console.assert(r===e.byteLength);const s=t.getUint32(12,!0),a=t.getUint32(16,!0),o=t.getUint32(20,!0),l=t.getUint32(24,!0),c=t.getUint32(28,!0),h=e.slice(32,32+s+a),u=new ib(h,0,s,a),d=32+s+a,p=e.slice(d,d+o+l),f=new sb(p,u.getData("INSTANCES_LENGTH"),0,o,l),m=d+o+l,g=new Uint8Array(e,m,r-m);let A=null,y=null,v=null;if(c)A=g,y=Promise.resolve();else{const e=this.resolveExternalURL(tb(g)),t=e.split(/[\\/]/g);t.pop(),v=t.join("/"),y=fetch(e,this.fetchOptions).then((t=>{if(!t.ok)throw new Error(`I3DMLoaderBase : Failed to load file "${e}" with status ${t.status} : ${t.statusText}`);return t.arrayBuffer()})).then((e=>{A=new Uint8Array(e)}))}return y.then((()=>({version:i,featureTable:u,batchTable:f,glbBytes:A,gltfWorkingPath:v})))}}new Sc,new sn;const hw=new Sc,uw=new sn,dw=new sn,pw=new sn,fw=new Nn,mw=new Nn,gw=new Sn,Aw=new jn,yw=new sn,vw=new sn,_w=new sn,xw=new sn,Ew=new Dn;class bw{constructor(e=1,t=1,n=1){this.name="",this.radius=new sn(e,t,n)}intersectRay(e,t){return fw.makeScale(...this.radius).invert(),gw.center.set(0,0,0),gw.radius=1,Ew.copy(e).applyMatrix4(fw),Ew.intersectSphere(gw,t)?(fw.makeScale(...this.radius),t.applyMatrix4(fw),t):null}getEastNorthUpFrame(e,t,n){return this.getEastNorthUpAxes(e,t,yw,vw,_w,xw),n.makeBasis(yw,vw,_w).setPosition(xw)}getEastNorthUpAxes(e,t,n,i,r,s=xw){this.getCartographicToPosition(e,t,0,s),this.getCartographicToNormal(e,t,r),n.set(-s.y,s.x,0).normalize(),i.crossVectors(r,n).normalize()}getAzElRollFromRotationMatrix(e,t,n,i,r=0){return 1===r?(Aw.set(-Math.PI/2,0,0,"XYZ"),mw.makeRotationFromEuler(Aw).premultiply(n)):2===r?(Aw.set(-Math.PI/2,0,Math.PI,"XYZ"),mw.makeRotationFromEuler(Aw).premultiply(n)):mw.copy(n),this.getEastNorthUpFrame(e,t,fw).invert(),mw.premultiply(fw),Aw.setFromRotationMatrix(mw,"ZXY"),i.azimuth=-Aw.z,i.elevation=Aw.x,i.roll=Aw.y,i}getRotationMatrixFromAzElRoll(e,t,n,i,r,s,a=0){return this.getEastNorthUpFrame(e,t,fw),Aw.set(i,r,-n,"ZXY"),s.makeRotationFromEuler(Aw).premultiply(fw).setPosition(0,0,0),1===a?(Aw.set(Math.PI/2,0,0,"XYZ"),mw.makeRotationFromEuler(Aw),s.multiply(mw)):2===a&&(Aw.set(-Math.PI/2,0,Math.PI,"XYZ"),mw.makeRotationFromEuler(Aw),s.multiply(mw)),s}getFrame(e,t,n,i,r,s,a,o=0){return this.getRotationMatrixFromAzElRoll(e,t,n,i,r,a,o),this.getCartographicToPosition(e,t,s,xw),a.setPosition(xw),a}getCartographicToPosition(e,t,n,i){this.getCartographicToNormal(e,t,uw);const r=this.radius;dw.copy(uw),dw.x*=r.x**2,dw.y*=r.y**2,dw.z*=r.z**2;const s=Math.sqrt(uw.dot(dw));return dw.divideScalar(s),i.copy(dw).addScaledVector(uw,n)}getPositionToCartographic(e,t){this.getPositionToSurfacePoint(e,dw),this.getPositionToNormal(e,uw);const n=pw.subVectors(e,dw);return t.lon=Math.atan2(uw.y,uw.x),t.lat=Math.asin(uw.z),t.height=Math.sign(n.dot(e))*n.length(),t}getCartographicToNormal(e,t,n){return hw.set(1,-e+Math.PI/2,t),n.setFromSpherical(hw).normalize(),function(e){const{x:t,y:n,z:i}=e;e.x=i,e.y=t,e.z=n}(n),n}getPositionToNormal(e,t){const n=this.radius;return t.copy(e),t.x/=n.x**2,t.y/=n.y**2,t.z/=n.z**2,t.normalize(),t}getPositionToSurfacePoint(e,t){const n=this.radius,i=1/n.x**2,r=1/n.y**2,s=1/n.z**2,a=e.x*e.x*i,o=e.y*e.y*r,l=e.z*e.z*s,c=a+o+l,h=Math.sqrt(1/c),u=dw.copy(e).multiplyScalar(h);if(c<.1)return isFinite(h)?t.copy(u):null;const d=pw.set(u.x*i*2,u.y*r*2,u.z*s*2);let p,f,m,g,A,y,v,_,x,E,b,w=(1-h)*e.length()/(.5*d.length()),M=0;do{w-=M,m=1/(1+w*i),g=1/(1+w*r),A=1/(1+w*s),y=m*m,v=g*g,_=A*A,x=y*m,E=v*g,b=_*A,p=a*y+o*v+l*_-1,f=a*x*i+o*E*r+l*b*s,M=p/(-2*f)}while(Math.abs(p)>1e-12);return t.set(e.x*m,e.y*g,e.z*A)}calculateHorizonDistance(e,t){const n=this.calculateEffectiveRadius(e);return Math.sqrt(2*n*t+t**2)}calculateEffectiveRadius(e){const t=this.radius.x,n=1-this.radius.z**2/t**2,i=e*Tt.DEG2RAD,r=Math.sin(i)**2;return t/Math.sqrt(1-n*r)}getPositionElevation(e){this.getPositionToSurfacePoint(e,dw);const t=pw.subVectors(e,dw);return Math.sign(t.dot(e))*t.length()}copy(e){return this.radius.copy(e.radius),this}clone(){return(new this.constructor).copy(this)}}const ww=new bw(FE,FE,6356752.314245179);ww.name="WGS84 Earth";const Mw=new sn,Sw=new sn,Cw=new sn,Tw=new sn,Iw=new rn,Rw=new sn,Bw=new Nn,Lw=new Nn,Pw=new sn,Dw=new Nn,Nw=new rn,Uw={};class Ow extends cw{constructor(e=Vl){super(),this.manager=e,this.adjustmentTransform=new Nn,this.ellipsoid=ww.clone()}resolveExternalURL(e){return this.manager.resolveURL(super.resolveExternalURL(e))}parse(e){return super.parse(e).then((e=>{const{featureTable:t,batchTable:n}=e,i=e.glbBytes.slice().buffer;return new Promise(((r,s)=>{const a=this.fetchOptions,o=this.manager,l=o.getHandler("path.gltf")||new hb(o);"include"===a.credentials&&"cors"===a.mode&&l.setCrossOrigin("use-credentials"),"credentials"in a&&l.setWithCredentials("include"===a.credentials),a.headers&&l.setRequestHeader(a.headers);let c=e.gltfWorkingPath??this.workingPath;/[\\/]$/.test(c)||(c+="/");const h=this.adjustmentTransform;l.parse(i,c,(e=>{const i=t.getData("INSTANCES_LENGTH"),s=t.getData("POSITION",i,"FLOAT","VEC3"),a=t.getData("NORMAL_UP",i,"FLOAT","VEC3"),o=t.getData("NORMAL_RIGHT",i,"FLOAT","VEC3"),l=t.getData("SCALE_NON_UNIFORM",i,"FLOAT","VEC3"),c=t.getData("SCALE",i,"FLOAT","SCALAR"),u=t.getData("RTC_CENTER"),d=t.getData("EAST_NORTH_UP");["QUANTIZED_VOLUME_OFFSET","QUANTIZED_VOLUME_SCALE","POSITION_QUANTIZED","NORMAL_UP_OCT32P","NORMAL_RIGHT_OCT32P"].forEach((e=>{e in t.header&&console.warn(`I3DMLoader: Unsupported FeatureTable feature "${e}" detected.`)}));const p=new sn;for(let e=0;e<i;e++)p.x+=s[3*e+0]/i,p.y+=s[3*e+1]/i,p.z+=s[3*e+2]/i;const f=[],m=[];e.scene.updateMatrixWorld(),e.scene.traverse((e=>{if(e.isMesh){m.push(e);const{geometry:t,material:n}=e,r=new jo(t,n,i);r.position.copy(p),u&&(r.position.x+=u[0],r.position.y+=u[1],r.position.z+=u[2]),f.push(r)}}));for(let e=0;e<i;e++){Tw.set(s[3*e+0]-p.x,s[3*e+1]-p.y,s[3*e+2]-p.z),Iw.identity(),a&&(Sw.set(a[3*e+0],a[3*e+1],a[3*e+2]),Cw.set(o[3*e+0],o[3*e+1],o[3*e+2]),Mw.crossVectors(Cw,Sw).normalize(),Bw.makeBasis(Cw,Sw,Mw),Iw.setFromRotationMatrix(Bw)),Rw.set(1,1,1),l&&Rw.set(l[3*e+0],l[3*e+1],l[3*e+2]),c&&Rw.multiplyScalar(c[e]);for(let t=0,n=f.length;t<n;t++){const n=f[t];Nw.copy(Iw),d&&(n.updateMatrixWorld(),Pw.copy(Tw).applyMatrix4(n.matrixWorld),this.ellipsoid.getPositionToCartographic(Pw,Uw),this.ellipsoid.getEastNorthUpFrame(Uw.lat,Uw.lon,Dw),Nw.setFromRotationMatrix(Dw)),Bw.compose(Tw,Nw,Rw).multiply(h);const i=m[t];Lw.multiplyMatrices(Bw,i.matrixWorld),n.setMatrixAt(e,Lw)}}e.scene.clear(),e.scene.add(...f),e.batchTable=n,e.featureTable=t,e.scene.batchTable=n,e.scene.featureTable=t,r(e)}),s)}))}))}}class Fw extends ab{parse(e){const t=new DataView(e),n=ob(t);console.assert("cmpt"===n,'CMPTLoader: The magic bytes equal "cmpt".');const i=t.getUint32(4,!0);console.assert(1===i,'CMPTLoader: The version listed in the header is "1".');const r=t.getUint32(8,!0);console.assert(r===e.byteLength,"CMPTLoader: The contents buffer length listed in the header matches the file.");const s=t.getUint32(12,!0),a=[];let o=16;for(let t=0;t<s;t++){const t=new DataView(e,o,12),n=ob(t),i=t.getUint32(4,!0),r=t.getUint32(8,!0),s=new Uint8Array(e,o,r);a.push({type:n,buffer:s,version:i}),o+=r}return{version:i,tiles:a}}}class kw extends Fw{constructor(e=Vl){super(),this.manager=e,this.adjustmentTransform=new Nn,this.ellipsoid=ww.clone()}parse(e){const t=super.parse(e),{manager:n,ellipsoid:i,adjustmentTransform:r}=this,s=[];for(const e in t.tiles){const{type:a,buffer:o}=t.tiles[e];switch(a){case"b3dm":{const e=o.slice(),t=new nw(n);t.workingPath=this.workingPath,t.fetchOptions=this.fetchOptions,t.adjustmentTransform.copy(r);const i=t.parse(e.buffer);s.push(i);break}case"pnts":{const e=o.slice(),t=new lw(n);t.workingPath=this.workingPath,t.fetchOptions=this.fetchOptions;const i=t.parse(e.buffer);s.push(i);break}case"i3dm":{const e=o.slice(),t=new Ow(n);t.workingPath=this.workingPath,t.fetchOptions=this.fetchOptions,t.ellipsoid.copy(i),t.adjustmentTransform.copy(r);const a=t.parse(e.buffer);s.push(a);break}}}return Promise.all(s).then((e=>{const t=new oo;return e.forEach((e=>{t.add(e.scene)})),{tiles:e,scene:t}}))}}const Qw=new Nn;class zw extends oo{constructor(e){super(),this.isTilesGroup=!0,this.name="TilesRenderer.TilesGroup",this.tilesRenderer=e,this.matrixWorldInverse=new Nn}raycast(e,t){return!this.tilesRenderer.optimizeRaycast||(this.tilesRenderer.raycast(e,t),!1)}updateMatrixWorld(e){if(this.matrixAutoUpdate&&this.updateMatrix(),this.matrixWorldNeedsUpdate||e){null===this.parent?Qw.copy(this.matrix):Qw.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1;const e=Qw.elements,t=this.matrixWorld.elements;let n=!1;for(let i=0;i<16;i++){const r=e[i],s=t[i];if(Math.abs(r-s)>Number.EPSILON){n=!0;break}}if(n){this.matrixWorld.copy(Qw),this.matrixWorldInverse.copy(Qw).invert();const e=this.children;for(let t=0,n=e.length;t<n;t++)e[t].updateMatrixWorld()}}}}const Gw=new Dn,Hw=new sn,Vw=[];function jw(e,t){return e.distance-t.distance}function qw(e,t,n,i){const{scene:r}=e.cached;n.invokeOnePlugin((n=>n.raycastTile&&n.raycastTile(e,r,t,i)))||t.intersectObject(r,!0,i)}function Ww(e,t,n,i=null){const{group:r,activeTiles:s}=e;e.ensureChildrenArePreprocessed(t),null===i&&(i=Gw).copy(n.ray).applyMatrix4(r.matrixWorldInverse);const a=[],o=t.children;for(let e=0,t=o.length;e<t;e++){const t=o[e];t.__used&&(null!==t.cached.boundingVolume.intersectRay(i,Hw)&&(Hw.applyMatrix4(r.matrixWorld),a.push({distance:Hw.distanceToSquared(n.ray.origin),tile:t})))}a.sort(jw);let l=null,c=1/0;if(s.has(t)){const i=function(e,t,n){qw(e,t,n,Vw),Vw.sort(jw);const i=Vw[0]||null;return Vw.length=0,i}(t,n,e);i&&(l=i,c=i.distance*i.distance)}for(let t=0,r=a.length;t<r;t++){const r=a[t],s=r.distance,o=r.tile;if(s>c)break;const h=Ww(e,o,n,i);if(h){const e=h.distance*h.distance;e<c&&(l=h,c=e)}}return l}function Yw(e,t,n,i,r=null){const{group:s,activeTiles:a}=e,{boundingVolume:o}=t.cached;if(e.ensureChildrenArePreprocessed(t),null===r&&(r=Gw).copy(n.ray).applyMatrix4(s.matrixWorldInverse),!t.__used||!o.intersectsRay(r))return;a.has(t)&&qw(t,n,e,i);const l=t.children;for(let t=0,s=l.length;t<s;t++)Yw(e,l[t],n,i,r)}const Xw=new Rt;class Kw extends Sr{constructor(){super(),this.points=Array(8).fill().map((()=>new sn))}setFromProjectionMatrix(e,t){return super.setFromProjectionMatrix(e,t),this.calculateFrustumPoints(),this}calculateFrustumPoints(){const{planes:e,points:t}=this;[[e[0],e[3],e[4]],[e[1],e[3],e[4]],[e[0],e[2],e[4]],[e[1],e[2],e[4]],[e[0],e[3],e[5]],[e[1],e[3],e[5]],[e[0],e[2],e[5]],[e[1],e[2],e[5]]].forEach(((e,n)=>{!function(e,t,n,i){const r=Xw.set(e.normal.x,e.normal.y,e.normal.z,t.normal.x,t.normal.y,t.normal.z,n.normal.x,n.normal.y,n.normal.z);i.set(-e.constant,-t.constant,-n.constant),i.applyMatrix3(r.invert())}(e[0],e[1],e[2],t[n])}))}}const Jw=new sn,$w=new sn,Zw=new sn,eM=new Dn,tM=new Kw;class nM{constructor(e=new ln,t=new Nn){this.box=e.clone(),this.transform=t.clone(),this.inverseTransform=new Nn,this.points=new Array(8).fill().map((()=>new sn)),this.planes=new Array(6).fill().map((()=>new br))}copy(e){return this.box.copy(e.box),this.transform.copy(e.transform),this.update(),this}clone(){return(new this.constructor).copy(this)}clampPoint(e,t){return t.copy(e).applyMatrix4(this.inverseTransform).clamp(this.box.min,this.box.max).applyMatrix4(this.transform)}distanceToPoint(e){return this.clampPoint(e,Zw).distanceTo(e)}containsPoint(e){return Zw.copy(e).applyMatrix4(this.inverseTransform),this.box.containsPoint(Zw)}intersectsRay(e){return eM.copy(e).applyMatrix4(this.inverseTransform),eM.intersectsBox(this.box)}intersectRay(e,t){return eM.copy(e).applyMatrix4(this.inverseTransform),eM.intersectBox(this.box,t)?(t.applyMatrix4(this.transform),t):null}update(){const{points:e,inverseTransform:t,transform:n,box:i}=this;t.copy(n).invert();const{min:r,max:s}=i;let a=0;for(let t=-1;t<=1;t+=2)for(let i=-1;i<=1;i+=2)for(let o=-1;o<=1;o+=2)e[a].set(t<0?r.x:s.x,i<0?r.y:s.y,o<0?r.z:s.z).applyMatrix4(n),a++;this.updatePlanes()}updatePlanes(){Jw.copy(this.box.min).applyMatrix4(this.transform),$w.copy(this.box.max).applyMatrix4(this.transform),Zw.set(0,0,1).transformDirection(this.transform),this.planes[0].setFromNormalAndCoplanarPoint(Zw,Jw),this.planes[1].setFromNormalAndCoplanarPoint(Zw,$w).negate(),Zw.set(0,1,0).transformDirection(this.transform),this.planes[2].setFromNormalAndCoplanarPoint(Zw,Jw),this.planes[3].setFromNormalAndCoplanarPoint(Zw,$w).negate(),Zw.set(1,0,0).transformDirection(this.transform),this.planes[4].setFromNormalAndCoplanarPoint(Zw,Jw),this.planes[5].setFromNormalAndCoplanarPoint(Zw,$w).negate()}intersectsFrustum(e){const{points:t}=this,{planes:n}=e;for(let e=0;e<6;e++){const i=n[e];let r=-1/0;for(let e=0;e<8;e++){const n=t[e],s=i.distanceToPoint(n);r=r<s?s:r}if(r<0)return!1}for(let t=0;t<6;t++){const n=this.planes[t];let i=-1/0;for(let t=0;t<8;t++){const r=e.points[t],s=n.distanceToPoint(r);i=i<s?s:i}if(i<0)return!1}return!0}intersectsSphere(e){return this.clampPoint(e.center,Zw),Zw.distanceToSquared(e.center)<=e.radius*e.radius}intersectsOBB(e){return tM.set(...e.planes),tM.calculateFrustumPoints(),this.intersectsFrustum(tM)}}const iM=Math.PI,rM=iM/2,sM=new sn,aM=new sn,oM=new sn,lM=new Nn;let cM=0;const hM=[];function uM(e=!1){return e?(hM[cM]||(hM[cM]=new sn),cM++,hM[cM-1]):new sn}function dM(){cM=0}class pM extends bw{constructor(e,t,n,i=-rM,r=rM,s=0,a=2*iM,o=0,l=0){super(e,t,n),this.latStart=i,this.latEnd=r,this.lonStart=s,this.lonEnd=a,this.heightStart=o,this.heightEnd=l}_getPoints(e=!1){const{latStart:t,latEnd:n,lonStart:i,lonEnd:r,heightStart:s,heightEnd:a}=this,o=Tt.mapLinear(.5,0,1,t,n),l=Tt.mapLinear(.5,0,1,i,r),c=Math.floor(i/rM)*rM,h=[[-iM/2,0],[iM/2,0],[0,c],[0,c+iM/2],[0,c+iM],[0,c+3*iM/2],[t,r],[n,r],[t,i],[n,i],[0,i],[0,r],[o,l],[t,l],[n,l],[o,i],[o,r]],u=[],d=h.length;for(let o=0;o<=1;o++){const l=Tt.mapLinear(o,0,1,s,a);for(let s=0,a=d;s<a;s++){const[a,o]=h[s];if(a>=t&&a<=n&&o>=i&&o<=r){const t=uM(e);u.push(t),this.getCartographicToPosition(a,o,l,t)}}}return u}getBoundingBox(e,t){dM();const{latStart:n,latEnd:i,lonStart:r,lonEnd:s}=this;if(i-n<iM/2){const e=Tt.mapLinear(.5,0,1,n,i),a=Tt.mapLinear(.5,0,1,r,s);this.getCartographicToNormal(e,a,oM),aM.set(0,0,1),sM.crossVectors(aM,oM),aM.crossVectors(sM,oM),t.makeBasis(sM,aM,oM)}else sM.set(1,0,0),aM.set(0,1,0),oM.set(0,0,1),t.makeBasis(sM,aM,oM);lM.copy(t).invert();const a=this._getPoints(!0);for(let e=0,t=a.length;e<t;e++)a[e].applyMatrix4(lM);e.makeEmpty(),e.setFromPoints(a)}getBoundingSphere(e,t){dM();const n=this._getPoints(!0);e.makeEmpty(),e.setFromPoints(n,t)}}const fM=new sn,mM=new sn,gM=new sn,AM=new sn,yM=new sn;class vM{constructor(){this.sphere=null,this.obb=null,this.region=null,this.regionObb=null}intersectsRay(e){const t=this.sphere,n=this.obb||this.regionObb;return!(t&&!e.intersectsSphere(t)||n&&!n.intersectsRay(e))}intersectRay(e,t=null){const n=this.sphere,i=this.obb||this.regionObb;let r=-1/0,s=-1/0;n&&e.intersectSphere(n,AM)&&(r=n.containsPoint(e.origin)?0:e.origin.distanceToSquared(AM)),i&&i.intersectRay(e,yM)&&(s=i.containsPoint(e.origin)?0:e.origin.distanceToSquared(yM));const a=Math.max(r,s);return a===-1/0?null:(e.at(Math.sqrt(a),t),t)}distanceToPoint(e){const t=this.sphere,n=this.obb||this.regionObb;let i=-1/0,r=-1/0;return t&&(i=Math.max(t.distanceToPoint(e),0)),n&&(r=n.distanceToPoint(e)),i>r?i:r}intersectsFrustum(e){const t=this.obb||this.regionObb,n=this.sphere;return!(n&&!e.intersectsSphere(n))&&!(t&&!t.intersectsFrustum(e))&&Boolean(n||t)}intersectsSphere(e){const t=this.obb||this.regionObb,n=this.sphere;return!(n&&!n.intersectsSphere(e))&&!(t&&!t.intersectsSphere(e))&&Boolean(n||t)}intersectsOBB(e){const t=this.obb||this.regionObb,n=this.sphere;return!(n&&!e.intersectsSphere(n))&&!(t&&!t.intersectsOBB(e))&&Boolean(n||t)}getOBB(e,t){const n=this.obb||this.regionObb;n?(e.copy(n.box),t.copy(n.transform)):(this.getAABB(e),t.identity())}getAABB(e){if(this.sphere)this.sphere.getBoundingBox(e);else{const t=this.obb||this.regionObb;e.copy(t.box).applyMatrix4(t.transform)}}getSphere(e){if(this.sphere)e.copy(this.sphere);else if(this.region)this.region.getBoundingSphere(e);else{const t=this.obb||this.regionObb;t.box.getBoundingSphere(e),e.applyMatrix4(t.transform)}}setObbData(e,t){const n=new nM;fM.set(e[3],e[4],e[5]),mM.set(e[6],e[7],e[8]),gM.set(e[9],e[10],e[11]);const i=fM.length(),r=mM.length(),s=gM.length();fM.normalize(),mM.normalize(),gM.normalize(),0===i&&fM.crossVectors(mM,gM),0===r&&mM.crossVectors(fM,gM),0===s&&gM.crossVectors(fM,mM),n.transform.set(fM.x,mM.x,gM.x,e[0],fM.y,mM.y,gM.y,e[1],fM.z,mM.z,gM.z,e[2],0,0,0,1).premultiply(t),n.box.min.set(-i,-r,-s),n.box.max.set(i,r,s),n.update(),this.obb=n}setSphereData(e,t,n,i,r){const s=new Sn;s.center.set(e,t,n),s.radius=i,s.applyMatrix4(r),this.sphere=s}setRegionData(e,t,n,i,r,s,a){const o=new pM(...e.radius,n,r,t,i,s,a),l=new nM;o.getBoundingBox(l.box,l.transform),l.update(),this.region=o,this.regionObb=l}}const _M=new Nn,xM=new jn,EM=Symbol("INITIAL_FRUSTUM_CULLED"),bM=new Nn,wM=new sn,MM=new It,SM=new sn(1,0,0),CM=new sn(0,1,0);function TM(e,t){e.traverse((e=>{e.frustumCulled=e[EM]&&t}))}class IM extends ZE{get autoDisableRendererCulling(){return this._autoDisableRendererCulling}set autoDisableRendererCulling(e){this._autoDisableRendererCulling!==e&&(super._autoDisableRendererCulling=e,this.forEachLoadedModel((t=>{TM(t,!e)})))}get optimizeRaycast(){return this._optimizeRaycast}set optimizeRaycast(e){console.warn('TilesRenderer: The "optimizeRaycast" option has been deprecated.'),this._optimizeRaycast=e}constructor(...e){super(...e),this.group=new zw(this),this.ellipsoid=ww.clone(),this.cameras=[],this.cameraMap=new Map,this.cameraInfo=[],this._optimizeRaycast=!0,this._upRotationMatrix=new Nn,this.lruCache.computeMemoryUsageCallback=e=>e.cached.bytesUsed??null,this._autoDisableRendererCulling=!0;const t=new Hl;t.setURLModifier((e=>this.preprocessURL?this.preprocessURL(e):e)),this.manager=t,this._listeners={}}addEventListener(...e){At.prototype.addEventListener.call(this,...e)}hasEventListener(...e){At.prototype.hasEventListener.call(this,...e)}removeEventListener(...e){At.prototype.removeEventListener.call(this,...e)}dispatchEvent(...e){At.prototype.dispatchEvent.call(this,...e)}getBoundingBox(e){if(!this.root)return!1;const t=this.root.cached.boundingVolume;return!!t&&(t.getAABB(e),!0)}getOrientedBoundingBox(e,t){if(!this.root)return!1;const n=this.root.cached.boundingVolume;return!!n&&(n.getOBB(e,t),!0)}getBoundingSphere(e){if(!this.root)return!1;const t=this.root.cached.boundingVolume;return!!t&&(t.getSphere(e),!0)}forEachLoadedModel(e){this.traverse((t=>{const n=t.cached&&t.cached.scene;n&&e(n,t)}),null,!1)}raycast(e,t){if(this.root)if(e.firstHitOnly){const n=Ww(this,this.root,e);n&&t.push(n)}else Yw(this,this.root,e,t)}hasCamera(e){return this.cameraMap.has(e)}setCamera(e){const t=this.cameras,n=this.cameraMap;return!n.has(e)&&(n.set(e,new It),t.push(e),this.dispatchEvent({type:"add-camera",camera:e}),!0)}setResolution(e,t,n){const i=this.cameraMap;if(!i.has(e))return!1;const r=t.isVector2?t.x:t,s=t.isVector2?t.y:n,a=i.get(e);return a.width===r&&a.height===s||(a.set(r,s),this.dispatchEvent({type:"camera-resolution-change"})),!0}setResolutionFromRenderer(e,t){return t.getSize(MM).multiplyScalar(t.getPixelRatio()),this.setResolution(e,MM.x,MM.y)}deleteCamera(e){const t=this.cameras,n=this.cameraMap;if(n.has(e)){const i=t.indexOf(e);return t.splice(i,1),n.delete(e),this.dispatchEvent({type:"delete-camera",camera:e}),!0}return!1}loadRootTileSet(...e){return super.loadRootTileSet(...e).then((e=>{const{asset:t,extensions:n={}}=e;switch((t&&t.gltfUpAxis||"y").toLowerCase()){case"x":this._upRotationMatrix.makeRotationAxis(CM,-Math.PI/2);break;case"y":this._upRotationMatrix.makeRotationAxis(SM,Math.PI/2)}if("3DTILES_ellipsoid"in n){const e=n["3DTILES_ellipsoid"],{ellipsoid:t}=this;t.name=e.body,e.radii?t.radius.set(...e.radii):t.radius.set(1,1,1)}return this.dispatchEvent({type:"load-content"}),e}))}update(){let e=null;if(this.invokeAllPlugins((t=>{if(t.doTilesNeedUpdate){const n=t.doTilesNeedUpdate();e=null===e?n:e||n}})),!1===e)return this.dispatchEvent({type:"update-before"}),void this.dispatchEvent({type:"update-after"});this.dispatchEvent({type:"update-before"});const t=this.group,n=this.cameras,i=this.cameraMap,r=this.cameraInfo;if(0!==n.length){for(;r.length>n.length;)r.pop();for(;r.length<n.length;)r.push({frustum:new Kw,isOrthographic:!1,sseDenominator:-1,position:new sn,invScale:-1,pixelSize:0});wM.setFromMatrixScale(t.matrixWorldInverse),Math.abs(Math.max(wM.x-wM.y,wM.x-wM.z))>1e-6&&console.warn("ThreeTilesRenderer : Non uniform scale used for tile which may cause issues when calculating screen space error.");for(let e=0,s=r.length;e<s;e++){const s=n[e],a=r[e],o=a.frustum,l=a.position,c=i.get(s);0!==c.width&&0!==c.height||console.warn("TilesRenderer: resolution for camera error calculation is not set.");const h=s.projectionMatrix.elements;if(a.isOrthographic=1===h[15],a.isOrthographic){const e=2/h[0],t=2/h[5];a.pixelSize=Math.max(t/c.height,e/c.width)}else a.sseDenominator=2/h[5]/c.height;bM.copy(t.matrixWorld),bM.premultiply(s.matrixWorldInverse),bM.premultiply(s.projectionMatrix),o.setFromProjectionMatrix(bM),l.set(0,0,0),l.applyMatrix4(s.matrixWorld),l.applyMatrix4(t.matrixWorldInverse)}super.update(),this.dispatchEvent({type:"update-after"})}else console.warn("TilesRenderer: no cameras defined. Cannot update 3d tiles.")}preprocessNode(e,t,n=null){super.preprocessNode(e,t,n);const i=new Nn;if(e.transform){const t=e.transform;for(let e=0;e<16;e++)i.elements[e]=t[e]}n&&i.premultiply(n.cached.transform);const r=(new Nn).copy(i).invert(),s=new vM;"sphere"in e.boundingVolume&&s.setSphereData(...e.boundingVolume.sphere,i),"box"in e.boundingVolume&&s.setObbData(e.boundingVolume.box,i),"region"in e.boundingVolume&&s.setRegionData(this.ellipsoid,...e.boundingVolume.region),e.cached={transform:i,transformInverse:r,active:!1,boundingVolume:s,metadata:null,scene:null,geometry:null,materials:null,textures:null}}async requestTileContents(...e){await super.requestTileContents(...e),this.dispatchEvent({type:"load-content"})}async parseTile(t,n,i,r,s){const a=n.cached,o=r.split(/[\\/]/g);o.pop();const l=o.join("/"),c=this.fetchOptions,h=this.manager;let u=null;const d=a.transform,p=this._upRotationMatrix,f=(ob(t)||i).toLowerCase();switch(f){case"b3dm":{const e=new nw(h);e.workingPath=l,e.fetchOptions=c,e.adjustmentTransform.copy(p),u=e.parse(t);break}case"pnts":{const e=new lw(h);e.workingPath=l,e.fetchOptions=c,u=e.parse(t);break}case"i3dm":{const e=new Ow(h);e.workingPath=l,e.fetchOptions=c,e.adjustmentTransform.copy(p),e.ellipsoid.copy(this.ellipsoid),u=e.parse(t);break}case"cmpt":{const e=new kw(h);e.workingPath=l,e.fetchOptions=c,e.adjustmentTransform.copy(p),e.ellipsoid.copy(this.ellipsoid),u=e.parse(t).then((e=>e.scene));break}case"gltf":case"glb":{const e=h.getHandler("path.gltf")||h.getHandler("path.glb")||new hb(h);e.setWithCredentials("include"===c.credentials),e.setRequestHeader(c.headers||{}),"include"===c.credentials&&"cors"===c.mode&&e.setCrossOrigin("use-credentials");let n=e.resourcePath||e.path||l;!/[\\/]$/.test(n)&&n.length&&(n+="/"),u=e.parseAsync(t,n).then((e=>{const{scene:t}=e;return t.updateMatrix(),t.matrix.multiply(p).decompose(t.position,t.quaternion,t.scale),e}));break}default:u=this.invokeOnePlugin((e=>e.parseToMesh&&e.parseToMesh(t,n,i,r,s)))}const m=await u;if(null===m)throw new Error(`TilesRenderer: Content type "${f}" not supported.`);let g,A;m.isObject3D?(g=m,A=null):(g=m.scene,A=m),await this.invokeAllPlugins((e=>e.processTileModel&&e.processTileModel(g,n))),g.updateMatrix(),g.matrix.premultiply(d),g.matrix.decompose(g.position,g.quaternion,g.scale),g.traverse((e=>{e[EM]=e.frustumCulled})),TM(g,!this.autoDisableRendererCulling);const y=[],v=[],_=[];if(g.traverse((e=>{if(e.geometry&&v.push(e.geometry),e.material){const t=e.material;y.push(e.material);for(const e in t){const n=t[e];n&&n.isTexture&&_.push(n)}}})),s.aborted)for(let e=0,t=_.length;e<t;e++){const t=_[e];t.image instanceof ImageBitmap&&t.image.close(),t.dispose()}else a.materials=y,a.geometry=v,a.textures=_,a.scene=g,a.metadata=A,a.bytesUsed=function(t){const{Vwu:n}=e;if(!n)return 0;const i=new Set;let r=0;return t.traverse((e=>{if(e.geometry&&!i.has(e.geometry)&&(r+=function(e){let t=0;for(const n in e.attributes){const i=e.getAttribute(n);t+=i.count*i.itemSize*i.array.BYTES_PER_ELEMENT}const n=e.getIndex();return t+=n?n.count*n.itemSize*n.array.BYTES_PER_ELEMENT:0,t}(e.geometry),i.add(e.geometry)),e.material){const t=e.material;for(const e in t){const s=t[e];if(s&&s.isTexture&&!i.has(s)){const{format:e,type:t,image:a}=s,{width:o,height:l}=a,c=n.getByteLength(o,l,e,t);r+=s.generateMipmaps?4*c/3:c,i.add(s)}}}})),r}(g)}disposeTile(e){super.disposeTile(e);const t=e.cached;if(t.scene){const n=t.materials,i=t.geometry,r=t.textures,s=t.scene.parent;t.scene.traverse((e=>{e.userData.meshFeatures&&e.userData.meshFeatures.dispose(),e.userData.structuralMetadata&&e.userData.structuralMetadata.dispose()}));for(let e=0,t=i.length;e<t;e++)i[e].dispose();for(let e=0,t=n.length;e<t;e++)n[e].dispose();for(let e=0,t=r.length;e<t;e++){const t=r[e];t.image instanceof ImageBitmap&&t.image.close(),t.dispose()}s&&s.remove(t.scene),this.dispatchEvent({type:"dispose-model",scene:t.scene,tile:e}),t.scene=null,t.materials=null,t.textures=null,t.geometry=null,t.metadata=null}}setTileVisible(e,t){const n=e.cached.scene,i=this.group;t?n&&(i.add(n),n.updateMatrixWorld(!0)):n&&i.remove(n),super.setTileVisible(e,t),this.dispatchEvent({type:"tile-visibility-change",scene:n,tile:e,visible:t})}calculateError(e){const t=e.cached,n=this.cameras,i=this.cameraInfo,r=t.boundingVolume;let s=-1/0,a=1/0;for(let t=0,o=n.length;t<o;t++){const n=i[t];let o;if(n.isOrthographic){const t=n.pixelSize;o=e.geometricError/t}else{const t=r.distanceToPoint(n.position),i=n.sseDenominator;o=e.geometricError/(t*i),a=Math.min(a,t)}s=Math.max(s,o)}this.invokeAllPlugins((t=>{t!==this&&t.calculateError&&(s=Math.max(s,t.calculateError(e)||0))})),e.__distanceFromCamera=a,e.__error=s}tileInView(e){let t=!1;if(this.invokeAllPlugins((n=>{t=t||n!==this&&n.tileInView&&n.tileInView(e)})),t)return!0;const n=e.cached.boundingVolume,i=this.cameraInfo;for(let e=0,t=i.length;e<t;e++){const t=i[e].frustum;if(n.intersectsFrustum(t))return!0}return!1}setLatLonToYUp(e,t){console.warn("TilesRenderer: setLatLonToYUp is deprecated. Use the ReorientationPlugin, instead.");const{ellipsoid:n,group:i}=this;xM.set(Math.PI/2,Math.PI/2,0),_M.makeRotationFromEuler(xM),n.getEastNorthUpFrame(e,t,i.matrix).multiply(_M).invert().decompose(i.position,i.quaternion,i.scale),i.updateMatrixWorld(!0)}dispose(){super.dispose(),this.group.removeFromParent()}}const RM=new Gr(-1,1,1,-1,0,1),BM=new class extends ji{constructor(){super(),this.setAttribute("position",new Oi([-1,3,0,-1,-1,0,3,-1,0],3)),this.setAttribute("uv",new Oi([0,2,0,0,2,0],2))}};class LM{constructor(e){this._mesh=new ir(BM,e)}dispose(){this._mesh.geometry.dispose()}render(e){e.render(this._mesh,RM)}get material(){return this._mesh.material}set material(e){this._mesh.material=e}}const PM=new Ic;class DM{constructor(){this._renderer=new Ao,this._target=new en(1,1),this._texTarget=new en,this._quad=new LM(new hr({blending:h,blendDst:f,blendSrc:m,uniforms:{map:{value:null},pixel:{value:new It}},vertexShader:"\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t\t\t}\n\t\t\t",fragmentShader:"\n\t\t\t\tuniform sampler2D map;\n\t\t\t\tuniform ivec2 pixel;\n\n\t\t\t\tvoid main() {\n\n\t\t\t\t\tgl_FragColor = texelFetch( map, pixel, 0 );\n\n\t\t\t\t}\n\t\t\t"}))}increaseSizeTo(e){this._target.setSize(Math.max(this._target.width,e),1)}readDataAsync(e){const{_renderer:t,_target:n}=this;return t.readRenderTargetPixelsAsync(n,0,0,e.length/4,1,e)}readData(e){const{_renderer:t,_target:n}=this;t.readRenderTargetPixels(n,0,0,e.length/4,1,e)}renderPixelToTarget(e,t,n){const{_renderer:i,_target:r}=this;PM.min.copy(t),PM.max.copy(t),PM.max.x+=1,PM.max.y+=1,i.initRenderTarget(r),i.copyTextureToTexture(e,r.texture,PM,n,0)}}const NM=new class{constructor(){let e=null;Object.getOwnPropertyNames(DM.prototype).forEach((t=>{"constructor"!==t&&(this[t]=(...n)=>(e=e||new DM,e[t](...n)))}))}},UM=new It,OM=new It,FM=new It;function kM(e,t,n=new Array(3)){let i=3*t,r=3*t+1,s=3*t+2;return e.index&&(i=e.index.getX(i),r=e.index.getX(r),s=e.index.getX(s)),n[0]=i,n[1]=r,n[2]=s,n}function QM(e,t,n,i,r){const[s,a,o]=i,l=function(e,t){return 0===t?e.getAttribute("uv"):e.getAttribute(`uv${t}`)}(e,t);UM.fromBufferAttribute(l,s),OM.fromBufferAttribute(l,a),FM.fromBufferAttribute(l,o),r.set(0,0,0).addScaledVector(UM,n.x).addScaledVector(OM,n.y).addScaledVector(FM,n.z)}function zM(e,t,n,i){const r=e.x-Math.floor(e.x),s=e.y-Math.floor(e.y),a=Math.floor(r*t%t),o=Math.floor(s*n%n);return i.set(a,o),i}const GM=new It,HM=new It,VM=new It;class jM{constructor(e,t,n){this.geometry=e,this.textures=t,this.data=n,this._asyncRead=!1,this.featureIds=n.featureIds.map((e=>{const{texture:t,...n}=e,i={label:null,propertyTable:null,nullFeatureId:null,...n};return t&&(i.texture={texCoord:0,channels:[0],...t}),i}))}getTextures(){return this.textures}getFeatureInfo(){return this.featureIds}getFeaturesAsync(...e){this._asyncRead=!0;const t=this.getFeatures(...e);return this._asyncRead=!1,t}getFeatures(e,t){const{geometry:n,textures:i,featureIds:r}=this,s=new Array(r.length).fill(null),a=r.length;NM.increaseSizeTo(a);const o=kM(n,e),l=o[function(e){return e.x>e.y&&e.x>e.z?0:e.y>e.z?1:2}(t)];for(let e=0,a=r.length;e<a;e++){const a=r[e],c="nullFeatureId"in a?a.nullFeatureId:null;if("texture"in a){const r=i[a.texture.index];QM(n,a.texture.texCoord,t,o,GM),zM(GM,r.image.width,r.image.height,HM),VM.set(e,0),NM.renderPixelToTarget(i[a.texture.index],HM,VM)}else if("attribute"in a){const t=n.getAttribute(`_feature_id_${a.attribute}`).getX(l);t!==c&&(s[e]=t)}else{const t=l;t!==c&&(s[e]=t)}}const c=new Uint8Array(4*a);return this._asyncRead?NM.readDataAsync(c).then((()=>(h(),s))):(NM.readData(c),h(),s);function h(){const e=new Uint32Array(1);for(let t=0,n=r.length;t<n;t++){const n=r[t],i="nullFeatureId"in n?n.nullFeatureId:null;if("texture"in n){const{channels:r}=n.texture,a=r.map((e=>c[4*t+e]));new Uint8Array(e.buffer).set(a);const o=e[0];o!==i&&(s[t]=o)}}}}dispose(){this.textures.forEach((e=>{e&&(e.dispose(),e.image instanceof ImageBitmap&&e.image.close())}))}}const qM="EXT_mesh_features";function WM(e,t,n){e.traverse((e=>{if(t.associations.has(e)){const{meshes:i,primitives:r}=t.associations.get(e),s=t.json.meshes[i].primitives[r];s&&s.extensions&&s.extensions[qM]&&n(e,s.extensions[qM])}}))}class YM{constructor(e){this.parser=e,this.name=qM}async afterRoot({scene:e,parser:t}){const n=t.json.extensionsUsed;if(!n||!n.includes(qM))return;const i=t.json.textures?.length||0,r=new Array(i).fill(null);WM(e,t,((e,{featureIds:n})=>{n.forEach((e=>{if(e.texture&&null===r[e.texture.index]){const n=e.texture.index;r[n]=t.loadTexture(n)}}))}));const s=await Promise.all(r);WM(e,t,((e,t)=>{e.userData.meshFeatures=new jM(e.geometry,s,t)}))}}function XM(e,t,n){return e&&t in e?e[t]:n}function KM(e){return"BOOLEAN"!==e&&"STRING"!==e&&"ENUM"!==e}function JM(e){return/^VEC/.test(e)}function $M(e){return/^MAT/.test(e)}function ZM(e,t,n,i=null){return $M(n)||JM(n)?i.fromArray(e,t):e[t]}function eS(e){const{type:t,componentType:n}=e;switch(t){case"SCALAR":return"INT64"===n?0n:0;case"VEC2":return new It;case"VEC3":return new sn;case"VEC4":return new $t;case"MAT2":return new Cc;case"MAT3":return new Rt;case"MAT4":return new Nn;case"BOOLEAN":return!1;case"STRING":return"";case"ENUM":return 0}}function tS(e,t){if(null==t)return!1;switch(e){case"SCALAR":case"ENUM":return"number"==typeof t||"bigint"==typeof t;case"VEC2":return t.isVector2;case"VEC3":return t.isVector3;case"VEC4":return t.isVector4;case"MAT2":return t.isMatrix2;case"MAT3":return t.isMatrix3;case"MAT4":return t.isMatrix4;case"BOOLEAN":return"boolean"==typeof t;case"STRING":return"string"==typeof t}throw new Error("ClassProperty: invalid type.")}function nS(e,t=null){switch(e){case"INT8":return Int8Array;case"INT16":return Int16Array;case"INT32":return Int32Array;case"INT64":return BigInt64Array;case"UINT8":return Uint8Array;case"UINT16":return Uint16Array;case"UINT32":return Uint32Array;case"UINT64":return BigUint64Array;case"FLOAT32":return Float32Array;case"FLOAT64":return Float64Array}switch(t){case"BOOLEAN":case"STRING":return Uint8Array}throw new Error("ClassProperty: invalid type.")}function iS(e,t=null){const n=e.default,i=e.type;if(t=t||eS(e),null===n){switch(i){case"SCALAR":return 0;case"VEC2":return t.set(0,0);case"VEC3":return t.set(0,0,0);case"VEC4":return t.set(0,0,0,0);case"MAT2":case"MAT3":case"MAT4":return t.identity();case"BOOLEAN":return!1;case"STRING":case"ENUM":return""}throw new Error("ClassProperty: invalid type.")}if($M(i))t.fromArray(n);else{if(!JM(i))return n;t.fromArray(n)}}function rS(e,t,n=null){if(e.array){Array.isArray(t)||(t=new Array(e.count||0)),t.length=null!==n?n:e.count;for(let n=0,i=t.length;n<i;n++)tS(e.type,t[n])||(t[n]=eS(e))}else tS(e.type,t)||(t=eS(e));return t}function sS(e,t){for(const n in t)n in e||delete t[n];for(const n in e){const i=e[n];t[n]=rS(i,t[n])}}class aS{constructor(e,t,n=null){this.name=t.name||null,this.description=t.description||null,this.type=t.type,this.componentType=t.componentType||null,this.enumType=t.enumType||null,this.array=t.array||!1,this.count=t.count||0,this.normalized=t.normalized||!1,this.offset=t.offset||0,this.scale=XM(t,"scale",1),this.max=XM(t,"max",1/0),this.min=XM(t,"min",-1/0),this.required=t.required||!1,this.noData=XM(t,"noData",null),this.default=XM(t,"default",null),this.semantic=XM(t,"semantic",null),this.enumSet=null,this.accessorProperty=n,n&&(this.offset=XM(n,"offset",this.offset),this.scale=XM(n,"scale",this.scale),this.max=XM(n,"max",this.max),this.min=XM(n,"min",this.min)),"ENUM"===t.type&&(this.enumSet=e[this.enumType],null===this.componentType&&(this.componentType=XM(this.enumSet,"valueType","UINT16")))}shapeToProperty(e,t=null){return rS(this,e,t)}resolveDefaultElement(e){return iS(this,e)}resolveDefault(e){return function(e,t=null){if(e.array){(t=t&&Array.isArray(t)?t:[]).length=e.count;for(let n=0,i=t.length;n<i;n++)t[n]=iS(e,t[n])}else t=iS(e,t);return t}(this,e)}resolveNoData(e){return function(e,t){if(null===e.noData)return t;const n=e.noData,i=e.type;if(Array.isArray(t))for(let e=0,n=t.length;e<n;e++)t[e]=r(t[e]);else t=r(t);return t;function r(t){return function(e){if($M(i)){const t=e.elements;for(let e=0,i=n.length;e<i;e++)if(n[e]!==t[e])return!1;return!0}if(JM(i)){for(let t=0,i=n.length;t<i;t++)if(n[t]!==e.getComponent(t))return!1;return!0}return n===e}(t)&&(t=iS(e,t)),t}}(this,e)}resolveEnumsToStrings(e){const t=this.enumSet;if("ENUM"===this.type)if(Array.isArray(e))for(let t=0,i=e.length;t<i;t++)e[t]=n(e[t]);else e=n(e);return e;function n(e){const n=t.values.find((t=>t.value===e));return null===n?"":n.name}}adjustValueScaleOffset(e){return KM(this.type)?function(e,t){const{type:n,componentType:i,scale:r,offset:s,normalized:a}=e;if(Array.isArray(t))for(let e=0,n=t.length;e<n;e++)t[e]=o(t[e]);else t=o(t);return t;function o(e){return $M(n)?function(e){const t=e.elements;for(let e=0,n=t.length;e<n;e++)t[e]=l(t[e]);return e}(e):JM(n)?function(e){return e.x=l(e.x),e.y=l(e.y),"z"in e&&(e.z=l(e.z)),"w"in e&&(e.w=l(e.w)),e}(e):l(e)}function l(e){return a&&(e=function(e,t){switch(e){case"INT8":return Math.max(t/127,-1);case"INT16":return Math.max(t,32767,-1);case"INT32":return Math.max(t/2147483647,-1);case"INT64":return Math.max(Number(t)/0x8000000000000000,-1);case"UINT8":return t/255;case"UINT16":return t/65535;case"UINT32":return t/4294967295;case"UINT64":return Number(t)/0x10000000000000000}}(i,e)),(a||function(e){return/^FLOAT/.test(e)}(i))&&(e=e*r+s),e}}(this,e):e}}class oS{constructor(e,t={},n={},i=null){this.definition=e,this.class=t[e.class],this.className=e.class,this.enums=n,this.data=i,this.name="name"in e?e.name:null,this.properties=null}getPropertyNames(){return Object.keys(this.class.properties)}includesData(e){return Boolean(this.definition.properties[e])}dispose(){}_initProperties(e=aS){const t={};for(const n in this.class.properties)t[n]=new e(this.enums,this.class.properties[n],this.definition.properties[n]);this.properties=t}}class lS extends aS{constructor(e,t,n=null){super(e,t,n),this.attribute=n.attribute}}class cS extends oS{constructor(...e){super(...e),this.isPropertyAttributeAccessor=!0,this._initProperties(lS)}getData(e,t,n={}){const i=this.properties;sS(i,n);for(const r in i)n[r]=this.getPropertyValue(r,e,t,n[r]);return n}getPropertyValue(e,t,n,i=null){if(t>=this.count)throw new Error("PropertyAttributeAccessor: Requested index is outside the range of the buffer.");const r=this.properties[e],s=r.type;if(!r)throw new Error("PropertyAttributeAccessor: Requested class property does not exist.");if(!this.definition.properties[e])return r.resolveDefault(i);i=r.shapeToProperty(i);const a=n.getAttribute(r.attribute.toLowerCase());if($M(s)){const e=i.elements;for(let n=0,i=e.length;n<i;n<i)e[n]=a.getComponent(t,n)}else if(JM(s))i.fromBufferAttribute(a,t);else{if("SCALAR"!==s&&"ENUM"!==s)throw new Error("StructuredMetadata.PropertyAttributeAccessor: BOOLEAN and STRING types are not supported by property attributes.");i=a.getX(t)}return i=r.adjustValueScaleOffset(i),i=r.resolveEnumsToStrings(i),r.resolveNoData(i)}}class hS extends aS{constructor(e,t,n=null){super(e,t,n),this.values=n.values,this.valueLength=function(e){switch(e){case"ENUM":case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16;default:return-1}}(this.type),this.arrayOffsets=XM(n,"arrayOffsets",null),this.stringOffsets=XM(n,"stringOffsets",null),this.arrayOffsetType=XM(n,"arrayOffsetType","UINT32"),this.stringOffsetType=XM(n,"stringOffsetType","UINT32")}getArrayLengthFromId(e,t){let n=this.count;if(null!==this.arrayOffsets){const{arrayOffsets:i,arrayOffsetType:r}=this,s=new(nS(r))(e[i]);n=s[t+1]-s[t]}return n}getIndexOffsetFromId(e,t){let n=t;if(this.arrayOffsets){const{arrayOffsets:t,arrayOffsetType:i}=this;n=new(nS(i))(e[t])[n]}else this.array&&(n*=this.count);return n}}class uS extends oS{constructor(...e){super(...e),this.isPropertyTableAccessor=!0,this.count=this.definition.count,this._initProperties(hS)}getData(e,t={}){const n=this.properties;sS(n,t);for(const i in n)t[i]=this.getPropertyValue(i,e,t[i]);return t}_readValueAtIndex(e,t,n,i=null){const r=this.properties[e],{componentType:s,type:a}=r,o=this.data,l=o[r.values],c=new(nS(s,a))(l),h=r.getIndexOffsetFromId(o,t);if(KM(a)||"ENUM"===a)return ZM(c,(h+n)*r.valueLength,a,i);if("STRING"===a){let e=h+n,t=0;if(null!==r.stringOffsets){const{stringOffsets:n,stringOffsetType:i}=r,s=new(nS(i))(o[n]);t=s[e+1]-s[e],e=s[e]}const s=new Uint8Array(c.buffer,e,t);i=(new TextDecoder).decode(s)}else if("BOOLEAN"===a){const e=h+n,t=e%8;i=1==(c[Math.floor(e/8)]>>t&1)}return i}getPropertyValue(e,t,n=null){if(t>=this.count)throw new Error("PropertyTableAccessor: Requested index is outside the range of the table.");const i=this.properties[e];if(!i)throw new Error("PropertyTableAccessor: Requested property does not exist.");if(!this.definition.properties[e])return i.resolveDefault(n);const r=i.array,s=this.data,a=i.getArrayLengthFromId(s,t);if(n=i.shapeToProperty(n,a),r)for(let i=0,r=n.length;i<r;i++)n[i]=this._readValueAtIndex(e,t,i,n[i]);else n=this._readValueAtIndex(e,t,0,n);return n=i.adjustValueScaleOffset(n),n=i.resolveEnumsToStrings(n),i.resolveNoData(n)}}const dS=new It,pS=new It,fS=new It;class mS extends aS{constructor(e,t,n=null){super(e,t,n),this.channels=XM(n,"channels",[0]),this.index=XM(n,"index",null),this.texCoord=XM(n,"texCoord",null),this.valueLength=parseInt(this.type.replace(/[^0-9]/g,""))||1}readDataFromBuffer(e,t,n=null){const i=this.type;if("BOOLEAN"===i||"STRING"===i)throw new Error("PropertyTextureAccessor: BOOLEAN and STRING types not supported.");return ZM(e,t*this.valueLength,i,n)}}class gS extends oS{constructor(...e){super(...e),this.isPropertyTextureAccessor=!0,this._asyncRead=!1,this._initProperties(mS)}getData(e,t,n,i={}){const r=this.properties;sS(r,i);const s=Object.keys(r),a=s.map((e=>i[e]));return this.getPropertyValuesAtTexel(s,e,t,n,a),s.forEach(((e,t)=>i[e]=a[t])),i}async getDataAsync(e,t,n,i={}){const r=this.properties;sS(r,i);const s=Object.keys(r),a=s.map((e=>i[e]));return await this.getPropertyValuesAtTexelAsync(s,e,t,n,a),s.forEach(((e,t)=>i[e]=a[t])),i}getPropertyValuesAtTexelAsync(...e){this._asyncRead=!0;const t=this.getPropertyValuesAtTexel(...e);return this._asyncRead=!1,t}getPropertyValuesAtTexel(e,t,n,i,r=[]){for(;r.length<e.length;)r.push(null);r.length=e.length,NM.increaseSizeTo(r.length);const s=this.data,a=this.definition.properties,o=this.properties,l=kM(i,t);for(let t=0,r=e.length;t<r;t++){const r=e[t];if(!a[r])continue;const c=o[r],h=s[c.index];QM(i,c.texCoord,n,l,dS),zM(dS,h.image.width,h.image.height,pS),fS.set(t,0),NM.renderPixelToTarget(h,pS,fS)}const c=new Uint8Array(4*e.length);return this._asyncRead?NM.readDataAsync(c).then((()=>(h.call(this),r))):(NM.readData(c),h.call(this),r);function h(){for(let t=0,n=e.length;t<n;t++){const n=e[t],i=o[n],s=i.type;if(r[t]=rS(i,r[t]),!i)throw new Error("PropertyTextureAccessor: Requested property does not exist.");if(!a[n]){r[t]=i.resolveDefault(r);continue}const l=i.valueLength*(i.count||1),h=i.channels.map((e=>c[4*t+e])),u=new(nS(i.componentType,s))(l);if(new Uint8Array(u.buffer).set(h),i.array){const e=r[t];for(let t=0,n=e.length;t<n;t++)e[t]=i.readDataFromBuffer(u,t,e[t])}else r[t]=i.readDataFromBuffer(u,0,r[t]);r[t]=i.adjustValueScaleOffset(r[t]),r[t]=i.resolveEnumsToStrings(r[t]),r[t]=i.resolveNoData(r[t])}}}dispose(){this.data.forEach((e=>{e&&(e.dispose(),e.image instanceof ImageBitmap&&e.image.close())}))}}class AS{constructor(e,t,n,i=null,r=null){const{schema:s,propertyTables:a=[],propertyTextures:o=[],propertyAttributes:l=[]}=e,{enums:c,classes:h}=s,u=a.map((e=>new uS(e,h,c,n)));let d=[],p=[];i&&(i.propertyTextures&&(d=i.propertyTextures.map((e=>new gS(o[e],h,c,t)))),i.propertyAttributes&&(p=i.propertyAttributes.map((e=>new cS(l[e],h,c))))),this.schema=s,this.tableAccessors=u,this.textureAccessors=d,this.attributeAccessors=p,this.object=r,this.textures=t,this.nodeMetadata=i}getPropertyTableData(e,t,n=null){if(Array.isArray(e)&&Array.isArray(t)){n=n||[];const i=Math.min(e.length,t.length);n.length=i;for(let r=0;r<i;r++){const i=this.tableAccessors[e[r]];n[r]=i.getData(t[r],n[r])}}else n=n||{},n=this.tableAccessors[e].getData(t,n);return n}getPropertyTableInfo(e=null){if(null===e&&(e=this.tableAccessors.map(((e,t)=>t))),Array.isArray(e))return e.map((e=>{const t=this.tableAccessors[e];return{name:t.name,className:t.definition.class}}));{const t=this.tableAccessors[e];return{name:t.name,className:t.definition.class}}}getPropertyTextureData(e,t,n=[]){const i=this.textureAccessors;n.length=i.length;for(let r=0;r<i.length;r++){const s=i[r];n[r]=s.getData(e,t,this.object.geometry,n[r])}return n}async getPropertyTextureDataAsync(e,t,n=[]){const i=this.textureAccessors;n.length=i.length;const r=[];for(let s=0;s<i.length;s++){const a=i[s].getDataAsync(e,t,this.object.geometry,n[s]).then((e=>{n[s]=e}));r.push(a)}return await Promise.all(r),n}getPropertyTextureInfo(){return this.textureAccessors}getPropertyAttributeData(e,t=[]){const n=this.attributeAccessors;t.length=n.length;for(let i=0;i<n.length;i++){const r=n[i];t[i]=r.getData(e,this.object.geometry,t[i])}return t}getPropertyAttributeInfo(){return this.attributeAccessors.map((e=>({name:e.name,className:e.definition.class})))}dispose(){this.textureAccessors.forEach((e=>e.dispose())),this.tableAccessors.forEach((e=>e.dispose())),this.attributeAccessors.forEach((e=>e.dispose()))}}const yS="EXT_structural_metadata";function vS(e,t=[]){const n=e.json.textures?.length||0,i=new Array(n).fill(null);return t.forEach((({properties:t})=>{for(const n in t){const{index:r}=t[n];null===i[r]&&(i[r]=e.loadTexture(r))}})),Promise.all(i)}function _S(e,t=[]){const n=e.json.bufferViews?.length||0,i=new Array(n).fill(null);return t.forEach((({properties:t})=>{for(const n in t){const{values:r,arrayOffsets:s,stringOffsets:a}=t[n];null===i[r]&&(i[r]=e.loadBufferView(r)),null===i[s]&&(i[s]=e.loadBufferView(s)),null===i[a]&&(i[a]=e.loadBufferView(a))}})),Promise.all(i)}class xS{constructor(e){this.parser=e,this.name=yS}async afterRoot({scene:e,parser:t}){const n=t.json.extensionsUsed;if(!n||!n.includes(yS))return;let i=null,r=t.json.extensions[yS];if(r.schemaUri){const{manager:e,path:n,requestHeader:s,crossOrigin:a}=t.options,o=new URL(r.schemaUri,n).toString(),l=new Yl(e);l.setCrossOrigin(a),l.setResponseType("json"),l.setRequestHeader(s),i=l.loadAsync(o).then((e=>{r={...r,schema:e}}))}const[s,a]=await Promise.all([vS(t,r.propertyTextures),_S(t,r.propertyTables),i]),o=new AS(r,s,a);e.userData.structuralMetadata=o,e.traverse((e=>{if(t.associations.has(e)){const{meshes:n,primitives:i}=t.associations.get(e),l=t.json.meshes[n].primitives[i];if(l&&l.extensions&&l.extensions[yS]){const t=l.extensions[yS];e.userData.structuralMetadata=new AS(r,s,a,t,e)}else e.userData.structuralMetadata=o}}))}}class ES{constructor(){this.name="CESIUM_RTC"}afterRoot(e){if(e.parser.json.extensions&&e.parser.json.extensions.CESIUM_RTC){const{center:t}=e.parser.json.extensions.CESIUM_RTC;t&&(e.scene.position.x+=t[0],e.scene.position.y+=t[1],e.scene.position.z+=t[2])}}}class bS{constructor(){this.creditsCount={}}_adjustAttributions(e,t){const n=this.creditsCount,i=e.split(/;/g);for(let e=0,r=i.length;e<r;e++){const r=i[e];r in n||(n[r]=0),n[r]+=t?1:-1,n[r]<=0&&delete n[r]}}addAttributions(e){this._adjustAttributions(e,!0)}removeAttributions(e){this._adjustAttributions(e,!1)}toString(){return Object.entries(this.creditsCount).sort(((e,t)=>{const n=e[1];return t[1]-n})).map((e=>e[0])).join("; ")}}function wS(e){let t=null;return jE(e,(e=>{if(e.content&&e.content.uri){const[,n]=e.content.uri.split("?");return t=new URLSearchParams(n).get("session"),!0}return!1})),t}class MS{constructor({apiToken:e,autoRefreshToken:t=!1,logoUrl:n=null,useRecommendedSettings:i=!0}){this.name="GOOGLE_CLOUD_AUTH_PLUGIN",this.priority=-1/0,this.apiToken=e,this.autoRefreshToken=t,this.useRecommendedSettings=i,this.logoUrl=n,this.sessionToken=null,this.tiles=null,this._onLoadCallback=null,this._visibilityChangeCallback=null,this._tokenRefreshPromise=null,this._attributionsManager=new bS,this._logoAttribution={value:"",type:"image",collapsible:!1},this._attribution={value:"",type:"string",collapsible:!0}}init(e){null!=e&&(e.resetFailedTiles(),null==e.rootURL&&(e.rootURL="https://tile.googleapis.com/v1/3dtiles/root.json"),this.useRecommendedSettings&&(e.parseQueue.maxJobs=10,e.downloadQueue.maxJobs=30,e.errorTarget=40),this.tiles=e,this._onLoadCallback=({tileSet:t})=>{this.sessionToken=wS(t.root),e.removeEventListener("load-tile-set",this._onLoadCallback)},this._visibilityChangeCallback=({tile:e,visible:t})=>{const n=e.cached.metadata.asset.copyright||"";t?this._attributionsManager.addAttributions(n):this._attributionsManager.removeAttributions(n)},e.addEventListener("load-tile-set",this._onLoadCallback),e.addEventListener("tile-visibility-change",this._visibilityChangeCallback))}getAttributions(e){this.tiles.visibleTiles.size>0&&(this.logoUrl&&(this._logoAttribution.value=this.logoUrl,e.push(this._logoAttribution)),this._attribution.value=this._attributionsManager.toString(),e.push(this._attribution))}preprocessURL(e){return e=new URL(e),/^http/.test(e.protocol)&&(e.searchParams.append("key",this.apiToken),null!==this.sessionToken&&e.searchParams.append("session",this.sessionToken)),e.toString()}dispose(){const{tiles:e}=this;e.removeEventListener("load-tile-set",this._onLoadCallback),e.removeEventListener("tile-visibility-change",this._visibilityChangeCallback)}async fetchData(e,t){null!==this._tokenRefreshPromise&&(await this._tokenRefreshPromise,e=this.preprocessURL(e));const n=await fetch(e,t);return n.status>=400&&n.status<=499&&this.autoRefreshToken?(await this._refreshToken(t),fetch(this.preprocessURL(e),t)):n}_refreshToken(e){if(null===this._tokenRefreshPromise){const t=new URL(this.tiles.rootURL);t.searchParams.append("key",this.apiToken),this._tokenRefreshPromise=fetch(t,e).then((e=>e.json())).then((e=>{this.sessionToken=wS(e.root),this._tokenRefreshPromise=null})),this._tokenRefreshPromise.catch((e=>{this.tiles.dispatchEvent({type:"load-error",tile:null,error:e,rootURL:t})}))}return this._tokenRefreshPromise}}class SS{constructor({apiToken:e,assetId:t=null,autoRefreshToken:n=!1}){this.name="CESIUM_ION_AUTH_PLUGIN",this.priority=-1/0,this.apiToken=e,this.assetId=t,this.autoRefreshToken=n,this.tiles=null,this.endpointURL=null,this._bearerToken=null,this._tileSetVersion=-1,this._tokenRefreshPromise=null,this._attributions=[],this._disposed=!1}init(e){null!==this.assetId&&(e.rootURL=`https://api.cesium.com/v1/assets/${this.assetId}/endpoint`),this.tiles=e,this.endpointURL=e.rootURL,e.resetFailedTiles()}loadRootTileSet(){return this._refreshToken().then((()=>this.tiles.invokeOnePlugin((e=>e!==this&&e.loadRootTileSet&&e.loadRootTileSet()))))}preprocessURL(e){return e=new URL(e),/^http/.test(e.protocol)&&-1!=this._tileSetVersion&&e.searchParams.append("v",this._tileSetVersion),e.toString()}fetchData(e,t){return null!==this.tiles.getPluginByName("GOOGLE_CLOUD_AUTH_PLUGIN")?null:Promise.resolve().then((async()=>{null!==this._tokenRefreshPromise&&(await this._tokenRefreshPromise,e=this.preprocessURL(e));const n=await fetch(e,t);return n.status>=400&&n.status<=499&&this.autoRefreshToken?(await this._refreshToken(t),fetch(this.preprocessURL(e),t)):n}))}getAttributions(e){this.tiles.visibleTiles.size>0&&e.push(...this._attributions)}_refreshToken(e){if(null===this._tokenRefreshPromise){const t=new URL(this.endpointURL);t.searchParams.append("access_token",this.apiToken),this._tokenRefreshPromise=fetch(t,e).then((e=>{if(this._disposed)return null;if(!e.ok)throw new Error(`CesiumIonAuthPlugin: Failed to load data with error code ${e.status}`);return e.json()})).then((e=>{if(this._disposed)return null;const n=this.tiles;if("externalType"in e){const t=new URL(e.options.url);n.rootURL=e.options.url,n.registerPlugin(new MS({apiToken:t.searchParams.get("key")}))}else{if(n.rootURL=e.url,n.fetchOptions.headers=n.fetchOptions.headers||{},n.fetchOptions.headers.Authorization=`Bearer ${e.accessToken}`,t.searchParams.has("v")&&-1===this._tileSetVersion){const t=new URL(e.url);this._tileSetVersion=t.searchParams.get("v")}this._bearerToken=e.accessToken,e.attributions&&(this._attributions=e.attributions.map((e=>({value:e.html,type:"html",collapsible:e.collapsible}))))}return this._tokenRefreshPromise=null,e})),this._tokenRefreshPromise.catch((e=>{this.tiles.dispatchEvent({type:"load-error",tile:null,error:e,url:t})}))}return this._tokenRefreshPromise}dispose(){this._disposed=!0}}function CS(e){return"OCTREE"===e.__implicitRoot.implicitTiling.subdivisionScheme}function TS(e){return CS(e)?8:4}class IS{constructor(e,t){this.parent=e,this.children=[],this.__level=e.__level+1,this.__implicitRoot=e.__implicitRoot,this.__subtreeIdx=t,[this.__x,this.__y,this.__z]=function(e,t){return t?[2*t.__x+e.__subtreeIdx%2,2*t.__y+Math.floor(e.__subtreeIdx/2)%2,CS(e)?2*t.__z+Math.floor(e.__subtreeIdx/4)%2:0]:[0,0,0]}(this,e)}static copy(e){const t={children:[]};return t.__level=e.__level,t.__implicitRoot=e.__implicitRoot,t.__subtreeIdx=e.__subtreeIdx,[t.__x,t.__y,t.__z]=[e.__x,e.__y,e.__z],t.boundingVolume=e.boundingVolume,t.geometricError=e.geometricError,t}}class RS extends ab{constructor(e){super(),this.tile=e,this.rootTile=e.__implicitRoot}parseBuffer(e){const t=new DataView(e);let n=0;const i=ob(t);console.assert("subt"===i,'SUBTREELoader: The magic bytes equal "subt".'),n+=4;const r=t.getUint32(n,!0);console.assert(1===r,'SUBTREELoader: The version listed in the header is "1".'),n+=4;const s=t.getUint32(n,!0);n+=8;const a=t.getUint32(n,!0);n+=8;const o=JSON.parse(tb(new Uint8Array(e,n,s)));return n+=s,{version:r,subtreeJson:o,subtreeByte:e.slice(n,n+a)}}parse(e){const t=this.parseBuffer(e),n=t.subtreeJson;n.contentAvailabilityHeaders=[].concat(n.contentAvailability);const i=this.preprocessBuffers(n.buffers),r=this.preprocessBufferViews(n.bufferViews,i);this.markActiveBufferViews(n,r);const s=this.requestActiveBuffers(i,t.subtreeByte),a=this.parseActiveBufferViews(r,s);this.parseAvailability(t,n,a),this.expandSubtree(this.tile,t)}markActiveBufferViews(e,t){let n;const i=e.tileAvailability;isNaN(i.bitstream)?isNaN(i.bufferView)||(n=t[i.bufferView]):n=t[i.bitstream],n&&(n.isActive=!0,n.bufferHeader.isActive=!0);const r=e.contentAvailabilityHeaders;for(let e=0;e<r.length;e++)n=void 0,isNaN(r[e].bitstream)?isNaN(r[e].bufferView)||(n=t[r[e].bufferView]):n=t[r[e].bitstream],n&&(n.isActive=!0,n.bufferHeader.isActive=!0);n=void 0;const s=e.childSubtreeAvailability;isNaN(s.bitstream)?isNaN(s.bufferView)||(n=t[s.bufferView]):n=t[s.bitstream],n&&(n.isActive=!0,n.bufferHeader.isActive=!0)}requestActiveBuffers(e,t){const n=[];for(let i=0;i<e.length;i++)e[i].isActive?n.push(t):n.push(void 0);const i={};for(let e=0;e<n.length;e++){const t=n[e];t&&(i[e]=t)}return i}parseActiveBufferViews(e,t){const n={};for(let i=0;i<e.length;i++){const r=e[i];if(!r.isActive)continue;const s=r.byteOffset,a=s+r.byteLength,o=t[r.buffer];n[i]=o.slice(s,a)}return n}preprocessBuffers(e=[]){for(let t=0;t<e.length;t++)e[t].isActive=!1;return e}preprocessBufferViews(e=[],t){for(let n=0;n<e.length;n++){const i=e[n];i.bufferHeader=t[i.buffer],i.isActive=!1}return e}parseAvailability(e,t,n){const i=TS(this.rootTile),r=this.rootTile.implicitTiling.subtreeLevels,s=(Math.pow(i,r)-1)/(i-1),a=Math.pow(i,r);e._tileAvailability=this.parseAvailabilityBitstream(t.tileAvailability,n,s),e._contentAvailabilityBitstreams=[];for(let i=0;i<t.contentAvailabilityHeaders.length;i++){const r=this.parseAvailabilityBitstream(t.contentAvailabilityHeaders[i],n,s);e._contentAvailabilityBitstreams.push(r)}e._childSubtreeAvailability=this.parseAvailabilityBitstream(t.childSubtreeAvailability,n,a)}parseAvailabilityBitstream(e,t,n){if(!isNaN(e.constant))return{constant:Boolean(e.constant),lengthBits:n};let i;return isNaN(e.bitstream)?isNaN(e.bufferView)||(i=t[e.bufferView]):i=t[e.bitstream],{bitstream:i,lengthBits:n}}expandSubtree(e,t){const n=IS.copy(e);for(let i=0;t&&i<t._contentAvailabilityBitstreams.length;i++)if(t&&this.getBit(t._contentAvailabilityBitstreams[i],0)){n.content={uri:this.parseImplicitURI(e,this.rootTile.content.uri)};break}e.children.push(n);const i=this.transcodeSubtreeTiles(n,t),r=this.listChildSubtrees(t,i);for(let e=0;e<r.length;e++){const t=r[e],n=t.tile,i=this.deriveChildTile(null,n,null,t.childMortonIndex);i.content={uri:this.parseImplicitURI(i,this.rootTile.implicitTiling.subtrees.uri)},n.children.push(i)}}transcodeSubtreeTiles(e,t){let n=[e],i=[];for(let e=1;e<this.rootTile.implicitTiling.subtreeLevels;e++){const r=TS(this.rootTile),s=(Math.pow(r,e)-1)/(r-1),a=r*n.length;for(let e=0;e<a;e++){const a=s+e,o=n[e>>Math.log2(r)];if(!this.getBit(t._tileAvailability,a)){i.push(void 0);continue}const l=this.deriveChildTile(t,o,a,e);o.children.push(l),i.push(l)}n=i,i=[]}return n}deriveChildTile(e,t,n,i){const r=new IS(t,i);r.boundingVolume=this.getTileBoundingVolume(r),r.geometricError=this.getGeometricError(r);for(let t=0;e&&t<e._contentAvailabilityBitstreams.length;t++)if(e&&this.getBit(e._contentAvailabilityBitstreams[t],n)){r.content={uri:this.parseImplicitURI(r,this.rootTile.content.uri)};break}return r}getBit(e,t){if(t<0||t>=e.lengthBits)throw new Error("Bit index out of bounds.");if(void 0!==e.constant)return e.constant;const n=t>>3,i=t%8;return 1==(new Uint8Array(e.bitstream)[n]>>i&1)}getTileBoundingVolume(e){const t={};if(this.rootTile.boundingVolume.region){const n=[...this.rootTile.boundingVolume.region],i=n[0],r=n[2],s=n[1],a=n[3],o=(r-i)/Math.pow(2,e.__level),l=(a-s)/Math.pow(2,e.__level);n[0]=i+o*e.__x,n[2]=i+o*(e.__x+1),n[1]=s+l*e.__y,n[3]=s+l*(e.__y+1);for(let e=0;e<4;e++){const t=n[e];t<-Math.PI?n[e]+=2*Math.PI:t>Math.PI&&(n[e]-=2*Math.PI)}if(CS(e)){const t=n[4],i=(n[5]-t)/Math.pow(2,e.__level);n[4]=t+i*e.__z,n[5]=t+i*(e.__z+1)}t.region=n}if(this.rootTile.boundingVolume.box){const n=[...this.rootTile.boundingVolume.box],i=2**e.__level-1,r=Math.pow(2,-e.__level),s=CS(e)?3:2;for(let t=0;t<s;t++){n[3+3*t+0]*=r,n[3+3*t+1]*=r,n[3+3*t+2]*=r;const s=n[3+3*t+0],a=n[3+3*t+1],o=n[3+3*t+2],l=0===t?e.__x:1===t?e.__y:e.__z;n[0]+=2*s*(-.5*i+l),n[1]+=2*a*(-.5*i+l),n[2]+=2*o*(-.5*i+l)}t.box=n}return t}getGeometricError(e){return this.rootTile.geometricError/Math.pow(2,e.__level)}listChildSubtrees(e,t){const n=[],i=TS(this.rootTile);for(let r=0;r<t.length;r++){const s=t[r];if(void 0!==s)for(let t=0;t<i;t++){const a=r*i+t;this.getBit(e._childSubtreeAvailability,a)&&n.push({tile:s,childMortonIndex:a})}}return n}parseImplicitURI(e,t){return(t=(t=(t=t.replace("{level}",e.__level)).replace("{x}",e.__x)).replace("{y}",e.__y)).replace("{z}",e.__z)}}class BS{constructor(){this.name="IMPLICIT_TILING_PLUGIN"}init(e){this.tiles=e}preprocessNode(e,t,n){e.implicitTiling?(e.__hasUnrenderableContent=!0,e.__hasRenderableContent=!1,e.__subtreeIdx=0,e.__implicitRoot=e,e.__x=0,e.__y=0,e.__z=0,e.__level=0):/.subtree$/i.test(e.content?.uri)&&(e.__hasUnrenderableContent=!0,e.__hasRenderableContent=!1)}parseTile(e,t,n){if(/^subtree$/i.test(n))return new RS(t).parse(e),Promise.resolve()}preprocessURL(e,t){if(t&&t.implicitTiling){const e=t.implicitTiling.subtrees.uri.replace("{level}",t.__level).replace("{x}",t.__x).replace("{y}",t.__y).replace("{z}",t.__z);return new URL(e,t.__basePath+"/").toString()}return e}disposeTile(e){/.subtree$/i.test(e.content?.uri)&&(e.children.length=0)}}const LS={};LS.LegacyGLTFLoader=function(){class e extends jl{constructor(e){super(e)}load(e,t,n,i){var r,s=this;r=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:dc.extractUrlBase(e);var a=new Yl(s.manager);a.setPath(this.path),a.setResponseType("arraybuffer"),a.load(e,(function(e){s.parse(e,r,t)}),n,i)}parse(e,t,n){var r,s={};dc.decodeText(new Uint8Array(e,0,4))===c.magic?(s[i.KHR_BINARY_GLTF]=new S(e),r=s[i.KHR_BINARY_GLTF].content):r=dc.decodeText(new Uint8Array(e));var a=JSON.parse(r);a.extensionsUsed&&a.extensionsUsed.indexOf(i.KHR_MATERIALS_COMMON)>=0&&(s[i.KHR_MATERIALS_COMMON]=new l(a)),a.extensionsUsed&&a.extensionsUsed.indexOf(i.CESIUM_RTC)>=0&&(s[i.CESIUM_RTC]=new C(a)),new me(a,s,{crossOrigin:this.crossOrigin,manager:this.manager,path:t||this.resourcePath||""}).parse((function(e,t,i,r){n({scene:e,scenes:t,cameras:i,animations:r})}))}}function t(){var e={};return{get:function(t){return e[t]},add:function(t,n){e[t]=n},remove:function(t){delete e[t]},removeAll:function(){e={}},update:function(t,n){for(var i in e){var r=e[i];r.update&&r.update(t,n)}}}}function n(e,t){var n={},i=e.material.uniforms;for(var r in i){var s=i[r];if(s.semantic){var a=s.node,o=e;a&&(o=t[a]),n[r]={semantic:s.semantic,sourceNode:o,targetNode:e,uniform:s}}}this.boundUniforms=n,this._m4=new Nn}e.Shaders={update:function(){console.warn("threeExamples.LegacyGLTFLoader.Shaders has been deprecated, and now updates automatically.")}},n.prototype.update=function(e,t){var n=this.boundUniforms;for(var i in n){var r=n[i];switch(r.semantic){case"MODELVIEW":r.uniform.value.multiplyMatrices(t.matrixWorldInverse,r.sourceNode.matrixWorld);break;case"MODELVIEWINVERSETRANSPOSE":var s=r.uniform.value;this._m4.multiplyMatrices(t.matrixWorldInverse,r.sourceNode.matrixWorld),s.getNormalMatrix(this._m4);break;case"PROJECTION":r.uniform.value.copy(t.projectionMatrix);break;case"JOINTMATRIX":for(var a=r.uniform.value,o=0;o<a.length;o++)a[o].getInverse(r.sourceNode.matrixWorld).multiply(r.targetNode.skeleton.bones[o].matrixWorld).multiply(r.targetNode.skeleton.boneInverses[o]).multiply(r.targetNode.bindMatrix);break;default:console.warn("Unhandled shader semantic: "+r.semantic)}}},e.Animations={update:function(){console.warn("threeExamples.LegacyGLTFLoader.Animation has been deprecated. Use THREE.AnimationMixer instead.")}};var i={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_MATERIALS_COMMON:"KHR_materials_common",CESIUM_RTC:"CESIUM_RTC"};function l(e){this.name=i.KHR_MATERIALS_COMMON,this.lights={};var t=(e.extensions&&e.extensions[i.KHR_MATERIALS_COMMON]||{}).lights||{};for(var n in t){var r,s=t[n],a=s[s.type],o=(new Ci).fromArray(a.color);switch(s.type){case"directional":(r=new hc(o)).position.set(0,0,1);break;case"point":r=new lc(o);break;case"spot":(r=new ic(o)).position.set(0,0,1);break;case"ambient":r=new uc(o)}r&&(this.lights[n]=r)}}var c={magic:"glTF",version:1,contentFormat:0},M=20;function S(e){this.name=i.KHR_BINARY_GLTF;var t=new DataView(e,0,M),n={magic:dc.decodeText(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0),contentLength:t.getUint32(12,!0),contentFormat:t.getUint32(16,!0)};for(var r in c){var s=c[r];if(n[r]!==s)throw new Error('Unsupported glTF-Binary header: Expected "%s" to be "%s".',r,s)}var a=new Uint8Array(e,M,n.contentLength);this.header=n,this.content=dc.decodeText(a),this.body=e.slice(M+n.contentLength,n.length)}function C(e){this.name=i.CESIUM_RTC,this.center=[0,0,0],e.extensions&&e.extensions[i.CESIUM_RTC]&&e.extensions[i.CESIUM_RTC].center&&3===e.extensions[i.CESIUM_RTC].center.length&&(this.center=e.extensions[i.CESIUM_RTC].center)}S.prototype.loadShader=function(e,t){var n=t[e.extensions[i.KHR_BINARY_GLTF].bufferView],r=new Uint8Array(n);return dc.decodeText(r)};var T={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,TRIANGLES:4,LINES:1,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123,VERTEX_SHADER:35633,FRAGMENT_SHADER:35632},N={5126:Number,35675:Rt,35676:Nn,35664:It,35665:sn,35666:$t,35678:Jt},O={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},F={9728:V,9729:W,9984:j,9985:Y,9986:q,9987:X},k={33071:G,33648:H,10497:z},Q={6406:se,6407:ae,6408:ae,6409:oe,6410:le},J={5121:K,32819:ne,32820:ie,33635:ie},$={1028:s,1029:r},Z={512:I,513:B,514:P,515:L,516:D,517:U,518:D,519:R},ee={32774:u,32778:d,32779:p},te={0:f,1:m,768:g,769:A,770:y,771:v,772:_,773:x,774:E,775:b,776:w},re={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},ce={scale:"scale",translation:"position",rotation:"quaternion"},he={LINEAR:Ye,STEP:We},ue={2884:"CULL_FACE",2929:"DEPTH_TEST",3042:"BLEND",3089:"SCISSOR_TEST",32823:"POLYGON_OFFSET_FILL",32926:"SAMPLE_ALPHA_TO_COVERAGE"};function de(e,t,n){if(!e)return Promise.resolve();var i,r=[];if("[object Array]"===Object.prototype.toString.call(e)){i=[];for(var s=e.length,a=0;a<s;a++)(l=t.call(n||this,e[a],a))&&(r.push(l),l instanceof Promise?l.then(function(e,t){i[e]=t}.bind(this,a)):i[a]=l)}else for(var o in i={},e){var l;e.hasOwnProperty(o)&&(l=t.call(n||this,e[o],o))&&(r.push(l),l instanceof Promise?l.then(function(e,t){i[e]=t}.bind(this,o)):i[o]=l)}return Promise.all(r).then((function(){return i}))}function pe(e,t){return"string"!=typeof e||""===e?"":/^(https?:)?\/\//i.test(e)||/^data:.*,.*$/i.test(e)||/^blob:.*$/i.test(e)?e:(t||"")+e}function fe(e){this.isDeferredShaderMaterial=!0,this.params=e}function me(e,n,i){this.json=e||{},this.extensions=n||{},this.options=i||{},this.cache=new t}return fe.prototype.create=function(){var e=cr.clone(this.params.uniforms);for(var t in this.params.uniforms){var n=this.params.uniforms[t];n.value instanceof Jt&&(e[t].value=n.value,e[t].value.needsUpdate=!0),e[t].semantic=n.semantic,e[t].node=n.node}return this.params.uniforms=e,new vl(this.params)},me.prototype._withDependencies=function(e){for(var t={},n=0;n<e.length;n++){var i=e[n],r="load"+i.charAt(0).toUpperCase()+i.slice(1),s=this.cache.get(i);if(void 0!==s)t[i]=s;else if(this[r]){var a=this[r]();this.cache.add(i,a),t[i]=a}}return de(t,(function(e){return e}))},me.prototype.parse=function(e){var t=this.json;this.cache.removeAll(),this._withDependencies(["scenes","cameras","animations"]).then((function(n){var i=[];for(var r in n.scenes)i.push(n.scenes[r]);var s=void 0!==t.scene?n.scenes[t.scene]:i[0],a=[];for(var r in n.cameras){var o=n.cameras[r];a.push(o)}var l=[];for(var r in n.animations)l.push(n.animations[r]);e(s,i,a,l)}))},me.prototype.loadShaders=function(){var e=this.json,t=this.extensions,n=this.options;return this._withDependencies(["bufferViews"]).then((function(r){return de(e.shaders,(function(e){return e.extensions&&e.extensions[i.KHR_BINARY_GLTF]?t[i.KHR_BINARY_GLTF].loadShader(e,r.bufferViews):new Promise((function(t){var i=new Yl(n.manager);i.setResponseType("text"),i.load(pe(e.uri,n.path),(function(e){t(e)}))}))}))}))},me.prototype.loadBuffers=function(){var e=this.json,t=this.extensions,n=this.options;return de(e.buffers,(function(e,r){return"binary_glTF"===r||r===i.KHR_BINARY_GLTF?t[i.KHR_BINARY_GLTF].body:"arraybuffer"===e.type||void 0===e.type?new Promise((function(t){var i=new Yl(n.manager);i.setResponseType("arraybuffer"),i.load(pe(e.uri,n.path),(function(e){t(e)}))})):void console.warn("threeExamples.LegacyGLTFLoader: "+e.type+" buffer type is not supported")}))},me.prototype.loadBufferViews=function(){var e=this.json;return this._withDependencies(["buffers"]).then((function(t){return de(e.bufferViews,(function(e){var n=t.buffers[e.buffer],i=void 0!==e.byteLength?e.byteLength:0;return n.slice(e.byteOffset,e.byteOffset+i)}))}))},me.prototype.loadAccessors=function(){var e=this.json;return this._withDependencies(["bufferViews"]).then((function(t){return de(e.accessors,(function(e){var n=t.bufferViews[e.bufferView],i=re[e.type],r=O[e.componentType],s=r.BYTES_PER_ELEMENT;if(e.byteStride&&e.byteStride!==s*i){var a=new r(n),o=new vo(a,e.byteStride/s);return new xo(o,i,e.byteOffset/s)}return a=new r(n,e.byteOffset,e.count*i),new Di(a,i)}))}))},me.prototype.loadTextures=function(){var e=this.json,t=this.options;return this._withDependencies(["bufferViews"]).then((function(n){return de(e.textures,(function(r){if(r.source)return new Promise((function(s){var a=e.images[r.source],o=a.uri,l=!1;if(a.extensions&&a.extensions[i.KHR_BINARY_GLTF]){var c=a.extensions[i.KHR_BINARY_GLTF],h=n.bufferViews[c.bufferView],u=new Blob([h],{type:c.mimeType});o=URL.createObjectURL(u),l=!0}var d=t.manager.getHandler(o);null===d&&(d=new Kl(t.manager)),d.setCrossOrigin(t.crossOrigin),d.load(pe(o,t.path),(function(t){if(l&&URL.revokeObjectURL(o),t.flipY=!1,void 0!==r.name&&(t.name=r.name),t.format=void 0!==r.format?Q[r.format]:ae,void 0!==r.internalFormat&&t.format!==Q[r.internalFormat]&&console.warn("threeExamples.LegacyGLTFLoader: Three.js doesn't support texture internalFormat which is different from texture format. internalFormat will be forced to be the same value as format."),t.type=void 0!==r.type?J[r.type]:K,r.sampler){var n=e.samplers[r.sampler];t.magFilter=F[n.magFilter]||W,t.minFilter=F[n.minFilter]||q,t.wrapS=k[n.wrapS]||z,t.wrapT=k[n.wrapT]||z}s(t)}),void 0,(function(){l&&URL.revokeObjectURL(o),s()}))}))}))}))},me.prototype.loadMaterials=function(){var e=this.json;return this._withDependencies(["shaders","textures"]).then((function(t){return de(e.materials,(function(n){var s,l,c={},d={};if(n.extensions&&n.extensions[i.KHR_MATERIALS_COMMON]&&(l=n.extensions[i.KHR_MATERIALS_COMMON]),l){var p=["ambient","emission","transparent","transparency","doubleSided"];switch(l.technique){case"BLINN":case"PHONG":s=El,p.push("diffuse","specular","shininess");break;case"LAMBERT":s=bl,p.push("diffuse");break;default:s=Bi}p.forEach((function(e){void 0!==l.values[e]&&(c[e]=l.values[e])})),(l.doubleSided||c.doubleSided)&&(d.side=a),(l.transparent||c.transparent)&&(d.transparent=!0,d.opacity=void 0!==c.transparency?c.transparency:1)}else if(void 0===n.technique)s=El,Object.assign(c,n.values);else{const i=e.techniques[n.technique];if(function(e){for(const t in e)if(e[t].includes("czm_"))return!0;return!1}(t.shaders)){s=Bi;let e=null;const r=i.uniforms;for(const s in r){const a=r[s],o=i.parameters[a];if(o.type===T.SAMPLER_2D){let i;void 0!==n.values&&(i=n.values[a]),void 0!==i?e=t.textures[i]:void 0!==o.value&&(e=t.textures[o.value])}}e&&(d.map=e)}else{s=fe,d.uniforms={};var g=e.programs[i.program];if(g){d.fragmentShader=t.shaders[g.fragmentShader],d.fragmentShader||(console.warn("ERROR: Missing fragment shader definition:",g.fragmentShader),s=El);var A=t.shaders[g.vertexShader];A||(console.warn("ERROR: Missing vertex shader definition:",g.vertexShader),s=El),d.vertexShader=function(e,t){var n={};for(var i in t.attributes){var r=t.attributes[i],s=(u=t.parameters[r]).type,a=u.semantic;n[i]={type:s,semantic:a}}var o=t.parameters,l=t.attributes,c={};for(var i in n){var h=o[r=l[i]];(a=h.semantic)&&(c[i]=h)}for(var r in c){a=(u=c[r]).semantic;var u,d=new RegExp("\\b"+r+"\\b","g");switch(a){case"POSITION":e=e.replace(d,"position");break;case"NORMAL":e=e.replace(d,"normal");break;case"TEXCOORD_0":case"TEXCOORD0":case"TEXCOORD":e=e.replace(d,"uv");break;case"TEXCOORD_1":e=e.replace(d,"uv2");break;case"COLOR_0":case"COLOR0":case"COLOR":e=e.replace(d,"color");break;case"WEIGHT":e=e.replace(d,"skinWeight");break;case"JOINT":e=e.replace(d,"skinIndex")}}return e}(A,i);const e=i.uniforms;for(const r in e){const s=e[r],a=i.parameters[s],o=a.type;if(!N[o])throw new Error("Unknown shader uniform param type: "+o);{const e=a.count;let i;void 0!==n.values&&(i=n.values[s]);var y=new N[o],v=a.semantic,_=a.node;switch(o){case T.FLOAT:y=a.value,"transparency"==s&&(d.transparent=!0),void 0!==i&&(y=i);break;case T.FLOAT_VEC2:case T.FLOAT_VEC3:case T.FLOAT_VEC4:case T.FLOAT_MAT3:a&&a.value&&y.fromArray(a.value),i&&y.fromArray(i);break;case T.FLOAT_MAT2:console.warn("FLOAT_MAT2 is not a supported uniform type");break;case T.FLOAT_MAT4:if(e){y=new Array(e);for(var x=0;x<e;x++)y[x]=new N[o];if(a&&a.value){var E=a.value;y.fromArray(E)}i&&y.fromArray(i)}else{if(a&&a.value){var b=a.value;y.fromArray(b)}i&&y.fromArray(i)}break;case T.SAMPLER_2D:y=void 0!==i?t.textures[i]:void 0!==a.value?t.textures[a.value]:null}d.uniforms[r]={value:y,semantic:v,node:_}}}for(var w=i.states||{},M=w.enable||[],S=w.functions||{},C=!1,I=!1,R=!1,L=0,P=M.length;L<P;L++){var D=M[L];switch(ue[D]){case"CULL_FACE":C=!0;break;case"DEPTH_TEST":I=!0;break;case"BLEND":R=!0;break;case"SCISSOR_TEST":case"POLYGON_OFFSET_FILL":case"SAMPLE_ALPHA_TO_COVERAGE":break;default:throw new Error("Unknown technique.states.enable: "+D)}}d.side=C?void 0!==S.cullFace?$[S.cullFace]:r:a,d.depthTest=I,d.depthFunc=void 0!==S.depthFunc?Z[S.depthFunc]:B,d.depthWrite=void 0===S.depthMask||S.depthMask[0],d.blending=R?h:o,d.transparent=R;var U=S.blendEquationSeparate;void 0!==U?(d.blendEquation=ee[U[0]],d.blendEquationAlpha=ee[U[1]]):(d.blendEquation=u,d.blendEquationAlpha=u);var O=S.blendFuncSeparate;void 0!==O?(d.blendSrc=te[O[0]],d.blendDst=te[O[1]],d.blendSrcAlpha=te[O[2]],d.blendDstAlpha=te[O[3]]):(d.blendSrc=m,d.blendDst=f,d.blendSrcAlpha=m,d.blendDstAlpha=f)}}}Array.isArray(c.diffuse)?d.color=(new Ci).fromArray(c.diffuse):"string"==typeof c.diffuse&&(d.map=t.textures[c.diffuse]),delete d.diffuse,"string"==typeof c.reflective&&(d.envMap=t.textures[c.reflective]),"string"==typeof c.bump&&(d.bumpMap=t.textures[c.bump]),Array.isArray(c.emission)?s===Bi?d.color=(new Ci).fromArray(c.emission):d.emissive=(new Ci).fromArray(c.emission):"string"==typeof c.emission&&(s===Bi?d.map=t.textures[c.emission]:d.emissiveMap=t.textures[c.emission]),Array.isArray(c.specular)?d.specular=(new Ci).fromArray(c.specular):"string"==typeof c.specular&&(d.specularMap=t.textures[c.specular]),void 0!==c.shininess&&(d.shininess=c.shininess);var F=new s(d);return void 0!==n.name&&(F.name=n.name),F}))}))},me.prototype.loadMeshes=function(){var e=this.json;return this._withDependencies(["accessors","materials"]).then((function(t){return de(e.meshes,(function(n){var i=new oo;void 0!==n.name&&(i.name=n.name),n.extras&&(i.userData=n.extras);var s=n.primitives||[];for(var a in s){var o=s[a];if(o.mode===T.TRIANGLES||void 0===o.mode){var l=new ji,c=o.attributes;for(var h in c){if(!(m=c[h]))return;var u=t.accessors[m];switch(h){case"POSITION":l.setAttribute("position",u);break;case"NORMAL":l.setAttribute("normal",u);break;case"TEXCOORD_0":case"TEXCOORD0":case"TEXCOORD":l.setAttribute("uv",u);break;case"TEXCOORD_1":l.setAttribute("uv2",u);break;case"COLOR_0":case"COLOR0":case"COLOR":l.setAttribute("color",u);break;case"WEIGHT":l.setAttribute("skinWeight",u);break;case"JOINT":l.setAttribute("skinIndex",u);break;default:if(!o.material)break;if(!(f=e.materials[o.material]).technique)break;var d=e.techniques[f.technique].parameters||{};for(var p in d)d[p].semantic===h&&l.setAttribute(p,u)}}o.indices&&l.setIndex(t.accessors[o.indices]);var f=void 0!==t.materials?t.materials[o.material]:new El({color:0,emissive:8947848,specular:0,shininess:0,transparent:!1,depthTest:!0,side:r});(g=new ir(l,f)).castShadow=!0,g.name="0"===a?i.name:i.name+a,o.extras&&(g.userData=o.extras),i.add(g)}else if(o.mode===T.LINES){for(var h in l=new ji,c=o.attributes){var m;if(!(m=c[h]))return;switch(u=t.accessors[m],h){case"POSITION":l.setAttribute("position",u);break;case"COLOR_0":case"COLOR0":case"COLOR":l.setAttribute("color",u)}}var g;f=t.materials[o.material],o.indices?(l.setIndex(t.accessors[o.indices]),g=new rl(l,f)):g=new el(l,f),g.name="0"===a?i.name:i.name+a,o.extras&&(g.userData=o.extras),i.add(g)}else console.warn("Only triangular and line primitives are supported")}return i}))}))},me.prototype.loadCameras=function(){return de(this.json.cameras,(function(e){if("perspective"==e.type&&e.perspective){var t=e.perspective.yfov,n=void 0!==e.perspective.aspectRatio?e.perspective.aspectRatio:1,i=new mr(Tt.radToDeg(t*n),n,e.perspective.znear||1,e.perspective.zfar||2e6);return void 0!==e.name&&(i.name=e.name),e.extras&&(i.userData=e.extras),i}if("orthographic"==e.type&&e.orthographic)return i=new Gr(window.innerWidth/-2,window.innerWidth/2,window.innerHeight/2,window.innerHeight/-2,e.orthographic.znear,e.orthographic.zfar),void 0!==e.name&&(i.name=e.name),e.extras&&(i.userData=e.extras),i}))},me.prototype.loadSkins=function(){var e=this.json;return this._withDependencies(["accessors"]).then((function(t){return de(e.skins,(function(e){var n=new Nn;return void 0!==e.bindShapeMatrix&&n.fromArray(e.bindShapeMatrix),{bindShapeMatrix:n,jointNames:e.jointNames,inverseBindMatrices:t.accessors[e.inverseBindMatrices]}}))}))},me.prototype.loadAnimations=function(){var e=this.json;return this._withDependencies(["accessors","nodes"]).then((function(t){return de(e.animations,(function(e,n){var i=[];for(var r in e.channels){var s=e.channels[r],a=e.samplers[s.sampler];if(a){var o=s.target,l=o.id,c=void 0!==e.parameters?e.parameters[a.input]:a.input,h=void 0!==e.parameters?e.parameters[a.output]:a.output,u=t.accessors[c],d=t.accessors[h],p=t.nodes[l];if(p){p.updateMatrix(),p.matrixAutoUpdate=!0;var f=ce[o.path]===ce.rotation?Ol:kl,m=p.name?p.name:p.uuid,g=void 0!==a.interpolation?he[a.interpolation]:Ye;i.push(new f(m+"."+ce[o.path],u.array.slice(),d.array.slice(),g))}}}return l=void 0!==e.name?e.name:"animation_"+n,new Ql(l,void 0,i)}))}))},me.prototype.loadNodes=function(){var e=this.json,t=this.extensions,n=this;return de(e.nodes,(function(e){var t,n=new Nn;return e.jointName?((t=new Lo).name=void 0!==e.name?e.name:e.jointName,t.jointName=e.jointName):(t=new li,void 0!==e.name&&(t.name=e.name)),e.extras&&(t.userData=e.extras),void 0!==e.matrix?(n.fromArray(e.matrix),t.applyMatrix4(n)):(void 0!==e.translation&&t.position.fromArray(e.translation),void 0!==e.rotation&&t.quaternion.fromArray(e.rotation),void 0!==e.scale&&t.scale.fromArray(e.scale)),t})).then((function(r){return n._withDependencies(["meshes","skins","cameras"]).then((function(n){return de(r,(function(s,a){var o=e.nodes[a];if(void 0!==o.meshes)for(var l in o.meshes){var c=o.meshes[l],h=n.meshes[c];if(void 0!==h)for(var u in h.children){var d,p=h.children[u],f=p.material,m=p.geometry,g=p.userData,A=p.name;switch(f.isDeferredShaderMaterial?f=y=f.create():y=f,p.type){case"LineSegments":p=new rl(m,y);break;case"LineLoop":p=new sl(m,y);break;case"Line":p=new el(m,y);break;default:p=new ir(m,y)}if(p.castShadow=!0,p.userData=g,p.name=A,o.skin&&(d=n.skins[o.skin]),d){var y,v=function(e){for(var t=Object.keys(r),n=0,i=t.length;n<i;n++){var s=r[t[n]];if(s.jointName===e)return s}return null},_=m;(y=f).skinning=!0,(p=new Bo(_,y)).castShadow=!0,p.userData=g,p.name=A;for(var x=[],E=[],b=0,w=d.jointNames.length;b<w;b++){var M=d.jointNames[b],S=v(M);if(S){x.push(S);var C=d.inverseBindMatrices.array,T=(new Nn).fromArray(C,16*b);E.push(T)}else console.warn("WARNING: joint: '"+M+"' could not be found")}p.bind(new Uo(x,E),d.bindShapeMatrix);var I=function(t,n,i){var s=t[i];if(void 0!==s)for(var a=0,o=s.length;a<o;a++){var l=s[a],c=r[l],h=e.nodes[l];void 0!==c&&!0===c.isBone&&void 0!==h&&(n.add(c),I(h,c,"children"))}};I(o,p,"skeletons")}s.add(p)}else console.warn("LegacyGLTFLoader: Couldn't find node \""+c+'".')}if(void 0!==o.camera){var R=n.cameras[o.camera];s.add(R)}if(o.extensions&&o.extensions[i.KHR_MATERIALS_COMMON]&&o.extensions[i.KHR_MATERIALS_COMMON].light){var B=t[i.KHR_MATERIALS_COMMON].lights[o.extensions[i.KHR_MATERIALS_COMMON].light];s.add(B)}return s}))}))}))},me.prototype.loadScenes=function(){var e=this.json,t=this.extensions;function r(t,n,i){var s=i[t];n.add(s);var a=e.nodes[t];if(a.children)for(var o=a.children,l=0,c=o.length;l<c;l++)r(o[l],s,i)}return this._withDependencies(["nodes"]).then((function(s){return de(e.scenes,(function(e){var a=new yo;void 0!==e.name&&(a.name=e.name),e.extras&&(a.userData=e.extras);for(var o=e.nodes||[],l=0,c=o.length;l<c;l++)r(o[l],a,s.nodes);return a.traverse((function(e){e.material&&e.material.isRawShaderMaterial&&(e.gltfShader=new n(e,s.nodes),e.onBeforeRender=function(e,t,n){this.gltfShader.update(t,n)})})),t[i.CESIUM_RTC]&&a.position.fromArray(t[i.CESIUM_RTC].center),a}))}))},e}();const PS=LS.LegacyGLTFLoader;function DS(e,t){if(t===Ke)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),e;if(t===$e||t===Je){let n=e.getIndex();if(null===n){const t=[],i=e.getAttribute("position");if(void 0===i)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(let e=0;e<i.count;e++)t.push(e);e.setIndex(t),n=e.getIndex()}const i=n.count-2,r=[];if(t===$e)for(let e=1;e<=i;e++)r.push(n.getX(0)),r.push(n.getX(e)),r.push(n.getX(e+1));else for(let e=0;e<i;e++)e%2==0?(r.push(n.getX(e)),r.push(n.getX(e+1)),r.push(n.getX(e+2))):(r.push(n.getX(e+2)),r.push(n.getX(e+1)),r.push(n.getX(e)));r.length/3!==i&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const s=e.clone();return s.setIndex(r),s.clearGroups(),s}return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",t),e}class NS extends jl{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register((function(e){return new zS(e)})),this.register((function(e){return new GS(e)})),this.register((function(e){return new JS(e)})),this.register((function(e){return new $S(e)})),this.register((function(e){return new ZS(e)})),this.register((function(e){return new VS(e)})),this.register((function(e){return new jS(e)})),this.register((function(e){return new qS(e)})),this.register((function(e){return new WS(e)})),this.register((function(e){return new QS(e)})),this.register((function(e){return new YS(e)})),this.register((function(e){return new HS(e)})),this.register((function(e){return new KS(e)})),this.register((function(e){return new XS(e)})),this.register((function(e){return new FS(e)})),this.register((function(e){return new eC(e)})),this.register((function(e){return new tC(e)}))}load(e,t,n,i){const r=this;let s;if(""!==this.resourcePath)s=this.resourcePath;else if(""!==this.path){const t=dc.extractUrlBase(e);s=dc.resolveURL(t,this.path)}else s=dc.extractUrlBase(e);this.manager.itemStart(e);const a=function(t){i?i(t):console.error(t),r.manager.itemError(e),r.manager.itemEnd(e)},o=new Yl(this.manager);o.setPath(this.path),o.setResponseType("arraybuffer"),o.setRequestHeader(this.requestHeader),o.setWithCredentials(this.withCredentials),o.load(e,(function(n){try{r.parse(n,s,(function(n){t(n),r.manager.itemEnd(e)}),a)}catch(e){a(e)}}),n,a)}setDRACOLoader(e){return this.dracoLoader=e,this}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,n,i){let r;const s={},a={},o=new TextDecoder;if("string"==typeof e)r=JSON.parse(e);else if(e instanceof ArrayBuffer)if(o.decode(new Uint8Array(e,0,4))===nC){try{s[OS.KHR_BINARY_GLTF]=new iC(e)}catch(e){return void(i&&i(e))}r=JSON.parse(s[OS.KHR_BINARY_GLTF].content)}else r=JSON.parse(o.decode(e));else r=e;if(void 0===r.asset||r.asset.version[0]<2)return void(i&&i(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.")));const l=new MC(r,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});l.fileLoader.setRequestHeader(this.requestHeader);for(let e=0;e<this.pluginCallbacks.length;e++){const t=this.pluginCallbacks[e](l);t.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),a[t.name]=t,s[t.name]=!0}if(r.extensionsUsed)for(let e=0;e<r.extensionsUsed.length;++e){const t=r.extensionsUsed[e],n=r.extensionsRequired||[];switch(t){case OS.KHR_MATERIALS_UNLIT:s[t]=new kS;break;case OS.KHR_DRACO_MESH_COMPRESSION:s[t]=new rC(r,this.dracoLoader);break;case OS.KHR_TEXTURE_TRANSFORM:s[t]=new sC;break;case OS.KHR_MESH_QUANTIZATION:s[t]=new aC;break;default:n.indexOf(t)>=0&&void 0===a[t]&&console.warn('THREE.GLTFLoader: Unknown extension "'+t+'".')}}l.setExtensions(s),l.setPlugins(a),l.parse(n,i)}parseAsync(e,t){const n=this;return new Promise((function(i,r){n.parse(e,t,i,r)}))}}function US(){let e={};return{get:function(t){return e[t]},add:function(t,n){e[t]=n},remove:function(t){delete e[t]},removeAll:function(){e={}}}}const OS={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class FS{constructor(e){this.parser=e,this.name=OS.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let n=0,i=t.length;n<i;n++){const i=t[n];i.extensions&&i.extensions[this.name]&&void 0!==i.extensions[this.name].light&&e._addNodeRef(this.cache,i.extensions[this.name].light)}}_loadLight(e){const t=this.parser,n="light:"+e;let i=t.cache.get(n);if(i)return i;const r=t.json,s=((r.extensions&&r.extensions[this.name]||{}).lights||[])[e];let a;const o=new Ci(16777215);void 0!==s.color&&o.setRGB(s.color[0],s.color[1],s.color[2],tt);const l=void 0!==s.range?s.range:0;switch(s.type){case"directional":a=new hc(o),a.target.position.set(0,0,-1),a.add(a.target);break;case"point":a=new lc(o),a.distance=l;break;case"spot":a=new ic(o),a.distance=l,s.spot=s.spot||{},s.spot.innerConeAngle=void 0!==s.spot.innerConeAngle?s.spot.innerConeAngle:0,s.spot.outerConeAngle=void 0!==s.spot.outerConeAngle?s.spot.outerConeAngle:Math.PI/4,a.angle=s.spot.outerConeAngle,a.penumbra=1-s.spot.innerConeAngle/s.spot.outerConeAngle,a.target.position.set(0,0,-1),a.add(a.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+s.type)}return a.position.set(0,0,0),a.decay=2,vC(a,s),void 0!==s.intensity&&(a.intensity=s.intensity),a.name=t.createUniqueName(s.name||"light_"+e),i=Promise.resolve(a),t.cache.add(n,i),i}getDependency(e,t){if("light"===e)return this._loadLight(t)}createNodeAttachment(e){const t=this,n=this.parser,i=n.json.nodes[e],r=(i.extensions&&i.extensions[this.name]||{}).light;return void 0===r?null:this._loadLight(r).then((function(e){return n._getNodeRef(t.cache,r,e)}))}}class kS{constructor(){this.name=OS.KHR_MATERIALS_UNLIT}getMaterialType(){return Bi}extendParams(e,t,n){const i=[];e.color=new Ci(1,1,1),e.opacity=1;const r=t.pbrMetallicRoughness;if(r){if(Array.isArray(r.baseColorFactor)){const t=r.baseColorFactor;e.color.setRGB(t[0],t[1],t[2],tt),e.opacity=t[3]}void 0!==r.baseColorTexture&&i.push(n.assignTexture(e,"map",r.baseColorTexture,et))}return Promise.all(i)}}class QS{constructor(e){this.parser=e,this.name=OS.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=n.extensions[this.name].emissiveStrength;return void 0!==i&&(t.emissiveIntensity=i),Promise.resolve()}}class zS{constructor(e){this.parser=e,this.name=OS.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?xl:null}extendMaterialParams(e,t){const n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],s=i.extensions[this.name];if(void 0!==s.clearcoatFactor&&(t.clearcoat=s.clearcoatFactor),void 0!==s.clearcoatTexture&&r.push(n.assignTexture(t,"clearcoatMap",s.clearcoatTexture)),void 0!==s.clearcoatRoughnessFactor&&(t.clearcoatRoughness=s.clearcoatRoughnessFactor),void 0!==s.clearcoatRoughnessTexture&&r.push(n.assignTexture(t,"clearcoatRoughnessMap",s.clearcoatRoughnessTexture)),void 0!==s.clearcoatNormalTexture&&(r.push(n.assignTexture(t,"clearcoatNormalMap",s.clearcoatNormalTexture)),void 0!==s.clearcoatNormalTexture.scale)){const e=s.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new It(e,e)}return Promise.all(r)}}class GS{constructor(e){this.parser=e,this.name=OS.KHR_MATERIALS_DISPERSION}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?xl:null}extendMaterialParams(e,t){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=n.extensions[this.name];return t.dispersion=void 0!==i.dispersion?i.dispersion:0,Promise.resolve()}}class HS{constructor(e){this.parser=e,this.name=OS.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?xl:null}extendMaterialParams(e,t){const n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],s=i.extensions[this.name];return void 0!==s.iridescenceFactor&&(t.iridescence=s.iridescenceFactor),void 0!==s.iridescenceTexture&&r.push(n.assignTexture(t,"iridescenceMap",s.iridescenceTexture)),void 0!==s.iridescenceIor&&(t.iridescenceIOR=s.iridescenceIor),void 0===t.iridescenceThicknessRange&&(t.iridescenceThicknessRange=[100,400]),void 0!==s.iridescenceThicknessMinimum&&(t.iridescenceThicknessRange[0]=s.iridescenceThicknessMinimum),void 0!==s.iridescenceThicknessMaximum&&(t.iridescenceThicknessRange[1]=s.iridescenceThicknessMaximum),void 0!==s.iridescenceThicknessTexture&&r.push(n.assignTexture(t,"iridescenceThicknessMap",s.iridescenceThicknessTexture)),Promise.all(r)}}class VS{constructor(e){this.parser=e,this.name=OS.KHR_MATERIALS_SHEEN}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?xl:null}extendMaterialParams(e,t){const n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[];t.sheenColor=new Ci(0,0,0),t.sheenRoughness=0,t.sheen=1;const s=i.extensions[this.name];if(void 0!==s.sheenColorFactor){const e=s.sheenColorFactor;t.sheenColor.setRGB(e[0],e[1],e[2],tt)}return void 0!==s.sheenRoughnessFactor&&(t.sheenRoughness=s.sheenRoughnessFactor),void 0!==s.sheenColorTexture&&r.push(n.assignTexture(t,"sheenColorMap",s.sheenColorTexture,et)),void 0!==s.sheenRoughnessTexture&&r.push(n.assignTexture(t,"sheenRoughnessMap",s.sheenRoughnessTexture)),Promise.all(r)}}class jS{constructor(e){this.parser=e,this.name=OS.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?xl:null}extendMaterialParams(e,t){const n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],s=i.extensions[this.name];return void 0!==s.transmissionFactor&&(t.transmission=s.transmissionFactor),void 0!==s.transmissionTexture&&r.push(n.assignTexture(t,"transmissionMap",s.transmissionTexture)),Promise.all(r)}}class qS{constructor(e){this.parser=e,this.name=OS.KHR_MATERIALS_VOLUME}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?xl:null}extendMaterialParams(e,t){const n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],s=i.extensions[this.name];t.thickness=void 0!==s.thicknessFactor?s.thicknessFactor:0,void 0!==s.thicknessTexture&&r.push(n.assignTexture(t,"thicknessMap",s.thicknessTexture)),t.attenuationDistance=s.attenuationDistance||1/0;const a=s.attenuationColor||[1,1,1];return t.attenuationColor=(new Ci).setRGB(a[0],a[1],a[2],tt),Promise.all(r)}}class WS{constructor(e){this.parser=e,this.name=OS.KHR_MATERIALS_IOR}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?xl:null}extendMaterialParams(e,t){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=n.extensions[this.name];return t.ior=void 0!==i.ior?i.ior:1.5,Promise.resolve()}}class YS{constructor(e){this.parser=e,this.name=OS.KHR_MATERIALS_SPECULAR}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?xl:null}extendMaterialParams(e,t){const n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],s=i.extensions[this.name];t.specularIntensity=void 0!==s.specularFactor?s.specularFactor:1,void 0!==s.specularTexture&&r.push(n.assignTexture(t,"specularIntensityMap",s.specularTexture));const a=s.specularColorFactor||[1,1,1];return t.specularColor=(new Ci).setRGB(a[0],a[1],a[2],tt),void 0!==s.specularColorTexture&&r.push(n.assignTexture(t,"specularColorMap",s.specularColorTexture,et)),Promise.all(r)}}class XS{constructor(e){this.parser=e,this.name=OS.EXT_MATERIALS_BUMP}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?xl:null}extendMaterialParams(e,t){const n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],s=i.extensions[this.name];return t.bumpScale=void 0!==s.bumpFactor?s.bumpFactor:1,void 0!==s.bumpTexture&&r.push(n.assignTexture(t,"bumpMap",s.bumpTexture)),Promise.all(r)}}class KS{constructor(e){this.parser=e,this.name=OS.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?xl:null}extendMaterialParams(e,t){const n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],s=i.extensions[this.name];return void 0!==s.anisotropyStrength&&(t.anisotropy=s.anisotropyStrength),void 0!==s.anisotropyRotation&&(t.anisotropyRotation=s.anisotropyRotation),void 0!==s.anisotropyTexture&&r.push(n.assignTexture(t,"anisotropyMap",s.anisotropyTexture)),Promise.all(r)}}class JS{constructor(e){this.parser=e,this.name=OS.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,n=t.json,i=n.textures[e];if(!i.extensions||!i.extensions[this.name])return null;const r=i.extensions[this.name],s=t.options.ktx2Loader;if(!s){if(n.extensionsRequired&&n.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,r.source,s)}}class $S{constructor(e){this.parser=e,this.name=OS.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){const t=this.name,n=this.parser,i=n.json,r=i.textures[e];if(!r.extensions||!r.extensions[t])return null;const s=r.extensions[t],a=i.images[s.source];let o=n.textureLoader;if(a.uri){const e=n.options.manager.getHandler(a.uri);null!==e&&(o=e)}return this.detectSupport().then((function(r){if(r)return n.loadTextureImage(e,s.source,o);if(i.extensionsRequired&&i.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return n.loadTexture(e)}))}detectSupport(){return this.isSupported||(this.isSupported=new Promise((function(e){const t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(1===t.height)}}))),this.isSupported}}class ZS{constructor(e){this.parser=e,this.name=OS.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(e){const t=this.name,n=this.parser,i=n.json,r=i.textures[e];if(!r.extensions||!r.extensions[t])return null;const s=r.extensions[t],a=i.images[s.source];let o=n.textureLoader;if(a.uri){const e=n.options.manager.getHandler(a.uri);null!==e&&(o=e)}return this.detectSupport().then((function(r){if(r)return n.loadTextureImage(e,s.source,o);if(i.extensionsRequired&&i.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return n.loadTexture(e)}))}detectSupport(){return this.isSupported||(this.isSupported=new Promise((function(e){const t=new Image;t.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",t.onload=t.onerror=function(){e(1===t.height)}}))),this.isSupported}}class eC{constructor(e){this.name=OS.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,n=t.bufferViews[e];if(n.extensions&&n.extensions[this.name]){const e=n.extensions[this.name],i=this.parser.getDependency("buffer",e.buffer),r=this.parser.options.meshoptDecoder;if(!r||!r.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return i.then((function(t){const n=e.byteOffset||0,i=e.byteLength||0,s=e.count,a=e.byteStride,o=new Uint8Array(t,n,i);return r.decodeGltfBufferAsync?r.decodeGltfBufferAsync(s,a,o,e.mode,e.filter).then((function(e){return e.buffer})):r.ready.then((function(){const t=new ArrayBuffer(s*a);return r.decodeGltfBuffer(new Uint8Array(t),s,a,o,e.mode,e.filter),t}))}))}return null}}class tC{constructor(e){this.name=OS.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const t=this.parser.json,n=t.nodes[e];if(!n.extensions||!n.extensions[this.name]||void 0===n.mesh)return null;const i=t.meshes[n.mesh];for(const e of i.primitives)if(e.mode!==hC.TRIANGLES&&e.mode!==hC.TRIANGLE_STRIP&&e.mode!==hC.TRIANGLE_FAN&&void 0!==e.mode)return null;const r=n.extensions[this.name].attributes,s=[],a={};for(const e in r)s.push(this.parser.getDependency("accessor",r[e]).then((t=>(a[e]=t,a[e]))));return s.length<1?null:(s.push(this.parser.createNodeMesh(e)),Promise.all(s).then((e=>{const t=e.pop(),n=t.isGroup?t.children:[t],i=e[0].count,r=[];for(const e of n){const t=new Nn,n=new sn,s=new rn,o=new sn(1,1,1),l=new jo(e.geometry,e.material,i);for(let e=0;e<i;e++)a.TRANSLATION&&n.fromBufferAttribute(a.TRANSLATION,e),a.ROTATION&&s.fromBufferAttribute(a.ROTATION,e),a.SCALE&&o.fromBufferAttribute(a.SCALE,e),l.setMatrixAt(e,t.compose(n,s,o));for(const t in a)if("_COLOR_0"===t){const e=a[t];l.instanceColor=new Oo(e.array,e.itemSize,e.normalized)}else"TRANSLATION"!==t&&"ROTATION"!==t&&"SCALE"!==t&&e.geometry.setAttribute(t,a[t]);li.prototype.copy.call(l,e),this.parser.assignFinalMaterial(l),r.push(l)}return t.isGroup?(t.clear(),t.add(...r),t):r[0]})))}}const nC="glTF";class iC{constructor(e){this.name=OS.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,12),n=new TextDecoder;if(this.header={magic:n.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==nC)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const i=this.header.length-12,r=new DataView(e,12);let s=0;for(;s<i;){const t=r.getUint32(s,!0);s+=4;const i=r.getUint32(s,!0);if(s+=4,1313821514===i){const i=new Uint8Array(e,12+s,t);this.content=n.decode(i)}else if(5130562===i){const n=12+s;this.body=e.slice(n,n+t)}s+=t}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class rC{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=OS.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const n=this.json,i=this.dracoLoader,r=e.extensions[this.name].bufferView,s=e.extensions[this.name].attributes,a={},o={},l={};for(const e in s){const t=mC[e]||e.toLowerCase();a[t]=s[e]}for(const t in e.attributes){const i=mC[t]||t.toLowerCase();if(void 0!==s[t]){const r=n.accessors[e.attributes[t]],s=uC[r.componentType];l[i]=s.name,o[i]=!0===r.normalized}}return t.getDependency("bufferView",r).then((function(e){return new Promise((function(t,n){i.decodeDracoFile(e,(function(e){for(const t in e.attributes){const n=e.attributes[t],i=o[t];void 0!==i&&(n.normalized=i)}t(e)}),a,l,tt,n)}))}))}}class sC{constructor(){this.name=OS.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return void 0!==t.texCoord&&t.texCoord!==e.channel||void 0!==t.offset||void 0!==t.rotation||void 0!==t.scale?(e=e.clone(),void 0!==t.texCoord&&(e.channel=t.texCoord),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),e.needsUpdate=!0,e):e}}class aC{constructor(){this.name=OS.KHR_MESH_QUANTIZATION}}class oC extends Tl{constructor(e,t,n,i){super(e,t,n,i)}copySampleValue_(e){const t=this.resultBuffer,n=this.sampleValues,i=this.valueSize;for(let r=0;r!==i;r++)t[r]=n[e*i*3+i+r];return t}interpolate_(e,t,n,i){const r=this.resultBuffer,s=this.sampleValues,a=this.valueSize,o=3*a,l=i-t,c=(n-t)/l,h=c*c,u=h*c,d=e*o,p=d-o,f=-2*u+3*h,m=u-h;for(let e=0;e!==a;e++){const t=s[p+e+a],n=s[p+e+2*a]*l,i=s[d+e+a],o=s[d+e]*l;r[e]=(1-f)*t+(m-h+c)*n+f*i+m*o}return r}}const lC=new rn;class cC extends oC{interpolate_(e,t,n,i){const r=super.interpolate_(e,t,n,i);return lC.fromArray(r).normalize().toArray(r),r}}const hC={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123},uC={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},dC={9728:V,9729:W,9984:j,9985:Y,9986:q,9987:X},pC={33071:G,33648:H,10497:z},fC={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},mC={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex",_BATCHID:"_BATCHID"},gC={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},AC={CUBICSPLINE:void 0,LINEAR:Ye,STEP:We};function yC(e,t,n){for(const i in n.extensions)void 0===e[i]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[i]=n.extensions[i])}function vC(e,t){void 0!==t.extras&&("object"==typeof t.extras?Object.assign(e.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function _C(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(let n=0,i=t.weights.length;n<i;n++)e.morphTargetInfluences[n]=t.weights[n];if(t.extras&&Array.isArray(t.extras.targetNames)){const n=t.extras.targetNames;if(e.morphTargetInfluences.length===n.length){e.morphTargetDictionary={};for(let t=0,i=n.length;t<i;t++)e.morphTargetDictionary[n[t]]=t}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function xC(e){let t;const n=e.extensions&&e.extensions[OS.KHR_DRACO_MESH_COMPRESSION];if(t=n?"draco:"+n.bufferView+":"+n.indices+":"+EC(n.attributes):e.indices+":"+EC(e.attributes)+":"+e.mode,void 0!==e.targets)for(let n=0,i=e.targets.length;n<i;n++)t+=":"+EC(e.targets[n]);return t}function EC(e){let t="";const n=Object.keys(e).sort();for(let i=0,r=n.length;i<r;i++)t+=n[i]+":"+e[n[i]]+";";return t}function bC(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}const wC=new Nn;class MC{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new US,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let n=!1,i=-1,r=!1,s=-1;if("undefined"!=typeof navigator){const e=navigator.userAgent;n=!0===/^((?!chrome|android).)*safari/i.test(e);const t=e.match(/Version\/(\d+)/);i=n&&t?parseInt(t[1],10):-1,r=e.indexOf("Firefox")>-1,s=r?e.match(/Firefox\/([0-9]+)\./)[1]:-1}"undefined"==typeof createImageBitmap||n&&i<17||r&&s<98?this.textureLoader=new Kl(this.options.manager):this.textureLoader=new pc(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new Yl(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const n=this,i=this.json,r=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll((function(e){return e._markDefs&&e._markDefs()})),Promise.all(this._invokeAll((function(e){return e.beforeRoot&&e.beforeRoot()}))).then((function(){return Promise.all([n.getDependencies("scene"),n.getDependencies("animation"),n.getDependencies("camera")])})).then((function(t){const s={scene:t[0][i.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:i.asset,parser:n,userData:{}};return yC(r,s,i),vC(s,i),Promise.all(n._invokeAll((function(e){return e.afterRoot&&e.afterRoot(s)}))).then((function(){for(const e of s.scenes)e.updateMatrixWorld();e(s)}))})).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],n=this.json.meshes||[];for(let n=0,i=t.length;n<i;n++){const i=t[n].joints;for(let t=0,n=i.length;t<n;t++)e[i[t]].isBone=!0}for(let t=0,i=e.length;t<i;t++){const i=e[t];void 0!==i.mesh&&(this._addNodeRef(this.meshCache,i.mesh),void 0!==i.skin&&(n[i.mesh].isSkinnedMesh=!0)),void 0!==i.camera&&this._addNodeRef(this.cameraCache,i.camera)}}_addNodeRef(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,n){if(e.refs[t]<=1)return n;const i=n.clone(),r=(e,t)=>{const n=this.associations.get(e);null!=n&&this.associations.set(t,n);for(const[n,i]of e.children.entries())r(i,t.children[n])};return r(n,i),i.name+="_instance_"+e.uses[t]++,i}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let n=0;n<t.length;n++){const i=e(t[n]);if(i)return i}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const n=[];for(let i=0;i<t.length;i++){const r=e(t[i]);r&&n.push(r)}return n}getDependency(e,t){const n=e+":"+t;let i=this.cache.get(n);if(!i){switch(e){case"scene":i=this.loadScene(t);break;case"node":i=this._invokeOne((function(e){return e.loadNode&&e.loadNode(t)}));break;case"mesh":i=this._invokeOne((function(e){return e.loadMesh&&e.loadMesh(t)}));break;case"accessor":i=this.loadAccessor(t);break;case"bufferView":i=this._invokeOne((function(e){return e.loadBufferView&&e.loadBufferView(t)}));break;case"buffer":i=this.loadBuffer(t);break;case"material":i=this._invokeOne((function(e){return e.loadMaterial&&e.loadMaterial(t)}));break;case"texture":i=this._invokeOne((function(e){return e.loadTexture&&e.loadTexture(t)}));break;case"skin":i=this.loadSkin(t);break;case"animation":i=this._invokeOne((function(e){return e.loadAnimation&&e.loadAnimation(t)}));break;case"camera":i=this.loadCamera(t);break;default:if(i=this._invokeOne((function(n){return n!=this&&n.getDependency&&n.getDependency(e,t)})),!i)throw new Error("Unknown type: "+e)}this.cache.add(n,i)}return i}getDependencies(e){let t=this.cache.get(e);if(!t){const n=this,i=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(i.map((function(t,i){return n.getDependency(e,i)}))),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],n=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[OS.KHR_BINARY_GLTF].body);const i=this.options;return new Promise((function(e,r){n.load(dc.resolveURL(t.uri,i.path),e,void 0,(function(){r(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))}))}))}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then((function(e){const n=t.byteLength||0,i=t.byteOffset||0;return e.slice(i,i+n)}))}loadAccessor(e){const t=this,n=this.json,i=this.json.accessors[e];if(void 0===i.bufferView&&void 0===i.sparse){const e=fC[i.type],t=uC[i.componentType],n=!0===i.normalized,r=new t(i.count*e);return Promise.resolve(new Di(r,e,n))}const r=[];return void 0!==i.bufferView?r.push(this.getDependency("bufferView",i.bufferView)):r.push(null),void 0!==i.sparse&&(r.push(this.getDependency("bufferView",i.sparse.indices.bufferView)),r.push(this.getDependency("bufferView",i.sparse.values.bufferView))),Promise.all(r).then((function(e){const r=e[0],s=fC[i.type],a=uC[i.componentType],o=a.BYTES_PER_ELEMENT,l=i.byteOffset||0,c=void 0!==i.bufferView?n.bufferViews[i.bufferView].byteStride:void 0,h=!0===i.normalized;let u,d;if(c&&c!==o*s){const e=Math.floor(l/c),n="InterleavedBuffer:"+i.bufferView+":"+i.componentType+":"+e+":"+i.count;let p=t.cache.get(n);p||(u=new a(r,e*c,i.count*c/o),p=new vo(u,c/o),t.cache.add(n,p)),d=new xo(p,s,l%c/o,h)}else u=null===r?new a(i.count*s):new a(r,l,i.count*s),d=new Di(u,s,h);if(void 0!==i.sparse){const t=fC.SCALAR,n=uC[i.sparse.indices.componentType],o=i.sparse.indices.byteOffset||0,l=i.sparse.values.byteOffset||0,c=new n(e[1],o,i.sparse.count*t),u=new a(e[2],l,i.sparse.count*s);null!==r&&(d=new Di(d.array.slice(),d.itemSize,d.normalized)),d.normalized=!1;for(let e=0,t=c.length;e<t;e++){const t=c[e];if(d.setX(t,u[e*s]),s>=2&&d.setY(t,u[e*s+1]),s>=3&&d.setZ(t,u[e*s+2]),s>=4&&d.setW(t,u[e*s+3]),s>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}d.normalized=h}return d}))}loadTexture(e){const t=this.json,n=this.options,i=t.textures[e].source,r=t.images[i];let s=this.textureLoader;if(r.uri){const e=n.manager.getHandler(r.uri);null!==e&&(s=e)}return this.loadTextureImage(e,i,s)}loadTextureImage(e,t,n){const i=this,r=this.json,s=r.textures[e],a=r.images[t],o=(a.uri||a.bufferView)+":"+s.sampler;if(this.textureCache[o])return this.textureCache[o];const l=this.loadImageSource(t,n).then((function(t){t.flipY=!1,t.name=s.name||a.name||"",""===t.name&&"string"==typeof a.uri&&!1===a.uri.startsWith("data:image/")&&(t.name=a.uri);const n=(r.samplers||{})[s.sampler]||{};return t.magFilter=dC[n.magFilter]||W,t.minFilter=dC[n.minFilter]||X,t.wrapS=pC[n.wrapS]||z,t.wrapT=pC[n.wrapT]||z,t.generateMipmaps=!t.isCompressedTexture&&t.minFilter!==V&&t.minFilter!==W,i.associations.set(t,{textures:e}),t})).catch((function(){return null}));return this.textureCache[o]=l,l}loadImageSource(e,t){const n=this.json,i=this.options;if(void 0!==this.sourceCache[e])return this.sourceCache[e].then((e=>e.clone()));const r=n.images[e],s=self.URL||self.webkitURL;let a=r.uri||"",o=!1;if(void 0!==r.bufferView)a=this.getDependency("bufferView",r.bufferView).then((function(e){o=!0;const t=new Blob([e],{type:r.mimeType});return a=s.createObjectURL(t),a}));else if(void 0===r.uri)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const l=Promise.resolve(a).then((function(e){return new Promise((function(n,r){let s=n;!0===t.isImageBitmapLoader&&(s=function(e){const t=new Jt(e);t.needsUpdate=!0,n(t)}),t.load(dc.resolveURL(e,i.path),s,void 0,r)}))})).then((function(e){var t;return!0===o&&s.revokeObjectURL(a),vC(e,r),e.userData.mimeType=r.mimeType||((t=r.uri).search(/\.jpe?g($|\?)/i)>0||0===t.search(/^data\:image\/jpeg/)?"image/jpeg":t.search(/\.webp($|\?)/i)>0||0===t.search(/^data\:image\/webp/)?"image/webp":t.search(/\.ktx2($|\?)/i)>0||0===t.search(/^data\:image\/ktx2/)?"image/ktx2":"image/png"),e})).catch((function(e){throw console.error("THREE.GLTFLoader: Couldn't load texture",a),e}));return this.sourceCache[e]=l,l}assignTexture(e,t,n,i){const r=this;return this.getDependency("texture",n.index).then((function(s){if(!s)return null;if(void 0!==n.texCoord&&n.texCoord>0&&((s=s.clone()).channel=n.texCoord),r.extensions[OS.KHR_TEXTURE_TRANSFORM]){const e=void 0!==n.extensions?n.extensions[OS.KHR_TEXTURE_TRANSFORM]:void 0;if(e){const t=r.associations.get(s);s=r.extensions[OS.KHR_TEXTURE_TRANSFORM].extendTexture(s,e),r.associations.set(s,t)}}return void 0!==i&&(s.colorSpace=i),e[t]=s,s}))}assignFinalMaterial(e){const t=e.geometry;let n=e.material;const i=void 0===t.attributes.tangent,r=void 0!==t.attributes.color,s=void 0===t.attributes.normal;if(e.isPoints){const e="PointsMaterial:"+n.uuid;let t=this.cache.get(e);t||(t=new al,Ri.prototype.copy.call(t,n),t.color.copy(n.color),t.map=n.map,t.sizeAttenuation=!1,this.cache.add(e,t)),n=t}else if(e.isLine){const e="LineBasicMaterial:"+n.uuid;let t=this.cache.get(e);t||(t=new qo,Ri.prototype.copy.call(t,n),t.color.copy(n.color),t.map=n.map,this.cache.add(e,t)),n=t}if(i||r||s){let e="ClonedMaterial:"+n.uuid+":";i&&(e+="derivative-tangents:"),r&&(e+="vertex-colors:"),s&&(e+="flat-shading:");let t=this.cache.get(e);t||(t=n.clone(),r&&(t.vertexColors=!0),s&&(t.flatShading=!0),i&&(t.normalScale&&(t.normalScale.y*=-1),t.clearcoatNormalScale&&(t.clearcoatNormalScale.y*=-1)),this.cache.add(e,t),this.associations.set(t,this.associations.get(n))),n=t}e.material=n}getMaterialType(){return _l}loadMaterial(e){const t=this,n=this.json,i=this.extensions,r=n.materials[e];let s;const o={},l=[];if((r.extensions||{})[OS.KHR_MATERIALS_UNLIT]){const e=i[OS.KHR_MATERIALS_UNLIT];s=e.getMaterialType(),l.push(e.extendParams(o,r,t))}else{const n=r.pbrMetallicRoughness||{};if(o.color=new Ci(1,1,1),o.opacity=1,Array.isArray(n.baseColorFactor)){const e=n.baseColorFactor;o.color.setRGB(e[0],e[1],e[2],tt),o.opacity=e[3]}void 0!==n.baseColorTexture&&l.push(t.assignTexture(o,"map",n.baseColorTexture,et)),o.metalness=void 0!==n.metallicFactor?n.metallicFactor:1,o.roughness=void 0!==n.roughnessFactor?n.roughnessFactor:1,void 0!==n.metallicRoughnessTexture&&(l.push(t.assignTexture(o,"metalnessMap",n.metallicRoughnessTexture)),l.push(t.assignTexture(o,"roughnessMap",n.metallicRoughnessTexture))),s=this._invokeOne((function(t){return t.getMaterialType&&t.getMaterialType(e)})),l.push(Promise.all(this._invokeAll((function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,o)}))))}!0===r.doubleSided&&(o.side=a);const c=r.alphaMode||"OPAQUE";if("BLEND"===c?(o.transparent=!0,o.depthWrite=!1):(o.transparent=!1,"MASK"===c&&(o.alphaTest=void 0!==r.alphaCutoff?r.alphaCutoff:.5)),void 0!==r.normalTexture&&s!==Bi&&(l.push(t.assignTexture(o,"normalMap",r.normalTexture)),o.normalScale=new It(1,1),void 0!==r.normalTexture.scale)){const e=r.normalTexture.scale;o.normalScale.set(e,e)}if(void 0!==r.occlusionTexture&&s!==Bi&&(l.push(t.assignTexture(o,"aoMap",r.occlusionTexture)),void 0!==r.occlusionTexture.strength&&(o.aoMapIntensity=r.occlusionTexture.strength)),void 0!==r.emissiveFactor&&s!==Bi){const e=r.emissiveFactor;o.emissive=(new Ci).setRGB(e[0],e[1],e[2],tt)}return void 0!==r.emissiveTexture&&s!==Bi&&l.push(t.assignTexture(o,"emissiveMap",r.emissiveTexture,et)),Promise.all(l).then((function(){const n=new s(o);return r.name&&(n.name=r.name),vC(n,r),t.associations.set(n,{materials:e}),r.extensions&&yC(i,n,r),n}))}createUniqueName(e){const t=_c.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){const t=this,n=this.extensions,i=this.primitiveCache;function r(e){return n[OS.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then((function(n){return SC(n,e,t)}))}const s=[];for(let n=0,a=e.length;n<a;n++){const a=e[n],o=xC(a),l=i[o];if(l)s.push(l.promise);else{let e;e=a.extensions&&a.extensions[OS.KHR_DRACO_MESH_COMPRESSION]?r(a):SC(new ji,a,t),i[o]={primitive:a,promise:e},s.push(e)}}return Promise.all(s)}loadMesh(e){const t=this,n=this.json,i=this.extensions,s=n.meshes[e],a=s.primitives,o=[];for(let e=0,t=a.length;e<t;e++){const t=void 0===a[e].material?(void 0===(l=this.cache).DefaultMaterial&&(l.DefaultMaterial=new _l({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:r})),l.DefaultMaterial):this.getDependency("material",a[e].material);o.push(t)}var l;return o.push(t.loadGeometries(a)),Promise.all(o).then((function(n){const r=n.slice(0,n.length-1),o=n[n.length-1],l=[];for(let n=0,c=o.length;n<c;n++){const c=o[n],h=a[n];let u;const d=r[n];if(h.mode===hC.TRIANGLES||h.mode===hC.TRIANGLE_STRIP||h.mode===hC.TRIANGLE_FAN||void 0===h.mode)u=!0===s.isSkinnedMesh?new Bo(c,d):new ir(c,d),!0===u.isSkinnedMesh&&u.normalizeSkinWeights(),h.mode===hC.TRIANGLE_STRIP?u.geometry=DS(u.geometry,Je):h.mode===hC.TRIANGLE_FAN&&(u.geometry=DS(u.geometry,$e));else if(h.mode===hC.LINES)u=new rl(c,d);else if(h.mode===hC.LINE_STRIP)u=new el(c,d);else if(h.mode===hC.LINE_LOOP)u=new sl(c,d);else{if(h.mode!==hC.POINTS)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+h.mode);u=new ul(c,d)}Object.keys(u.geometry.morphAttributes).length>0&&_C(u,s),u.name=t.createUniqueName(s.name||"mesh_"+e),vC(u,s),h.extensions&&yC(i,u,h),t.assignFinalMaterial(u),l.push(u)}for(let n=0,i=l.length;n<i;n++)t.associations.set(l[n],{meshes:e,primitives:n});if(1===l.length)return s.extensions&&yC(i,l[0],s),l[0];const c=new oo;s.extensions&&yC(i,c,s),t.associations.set(c,{meshes:e});for(let e=0,t=l.length;e<t;e++)c.add(l[e]);return c}))}loadCamera(e){let t;const n=this.json.cameras[e],i=n[n.type];if(i)return"perspective"===n.type?t=new mr(Tt.radToDeg(i.yfov),i.aspectRatio||1,i.znear||1,i.zfar||2e6):"orthographic"===n.type&&(t=new Gr(-i.xmag,i.xmag,i.ymag,-i.ymag,i.znear,i.zfar)),n.name&&(t.name=this.createUniqueName(n.name)),vC(t,n),Promise.resolve(t);console.warn("THREE.GLTFLoader: Missing camera parameters.")}loadSkin(e){const t=this.json.skins[e],n=[];for(let e=0,i=t.joints.length;e<i;e++)n.push(this._loadNodeShallow(t.joints[e]));return void 0!==t.inverseBindMatrices?n.push(this.getDependency("accessor",t.inverseBindMatrices)):n.push(null),Promise.all(n).then((function(e){const n=e.pop(),i=e,r=[],s=[];for(let e=0,a=i.length;e<a;e++){const a=i[e];if(a){r.push(a);const t=new Nn;null!==n&&t.fromArray(n.array,16*e),s.push(t)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[e])}return new Uo(r,s)}))}loadAnimation(e){const t=this.json,n=this,i=t.animations[e],r=i.name?i.name:"animation_"+e,s=[],a=[],o=[],l=[],c=[];for(let e=0,t=i.channels.length;e<t;e++){const t=i.channels[e],n=i.samplers[t.sampler],r=t.target,h=r.node,u=void 0!==i.parameters?i.parameters[n.input]:n.input,d=void 0!==i.parameters?i.parameters[n.output]:n.output;void 0!==r.node&&(s.push(this.getDependency("node",h)),a.push(this.getDependency("accessor",u)),o.push(this.getDependency("accessor",d)),l.push(n),c.push(r))}return Promise.all([Promise.all(s),Promise.all(a),Promise.all(o),Promise.all(l),Promise.all(c)]).then((function(e){const t=e[0],i=e[1],s=e[2],a=e[3],o=e[4],l=[];for(let e=0,r=t.length;e<r;e++){const r=t[e],c=i[e],h=s[e],u=a[e],d=o[e];if(void 0===r)continue;r.updateMatrix&&r.updateMatrix();const p=n._createAnimationTracks(r,c,h,u,d);if(p)for(let e=0;e<p.length;e++)l.push(p[e])}return new Ql(r,void 0,l)}))}createNodeMesh(e){const t=this.json,n=this,i=t.nodes[e];return void 0===i.mesh?null:n.getDependency("mesh",i.mesh).then((function(e){const t=n._getNodeRef(n.meshCache,i.mesh,e);return void 0!==i.weights&&t.traverse((function(e){if(e.isMesh)for(let t=0,n=i.weights.length;t<n;t++)e.morphTargetInfluences[t]=i.weights[t]})),t}))}loadNode(e){const t=this,n=this.json.nodes[e],i=t._loadNodeShallow(e),r=[],s=n.children||[];for(let e=0,n=s.length;e<n;e++)r.push(t.getDependency("node",s[e]));const a=void 0===n.skin?Promise.resolve(null):t.getDependency("skin",n.skin);return Promise.all([i,Promise.all(r),a]).then((function(e){const t=e[0],n=e[1],i=e[2];null!==i&&t.traverse((function(e){e.isSkinnedMesh&&e.bind(i,wC)}));for(let e=0,i=n.length;e<i;e++)t.add(n[e]);return t}))}_loadNodeShallow(e){const t=this.json,n=this.extensions,i=this;if(void 0!==this.nodeCache[e])return this.nodeCache[e];const r=t.nodes[e],s=r.name?i.createUniqueName(r.name):"",a=[],o=i._invokeOne((function(t){return t.createNodeMesh&&t.createNodeMesh(e)}));return o&&a.push(o),void 0!==r.camera&&a.push(i.getDependency("camera",r.camera).then((function(e){return i._getNodeRef(i.cameraCache,r.camera,e)}))),i._invokeAll((function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)})).forEach((function(e){a.push(e)})),this.nodeCache[e]=Promise.all(a).then((function(t){let a;if(a=!0===r.isBone?new Lo:t.length>1?new oo:1===t.length?t[0]:new li,a!==t[0])for(let e=0,n=t.length;e<n;e++)a.add(t[e]);if(r.name&&(a.userData.name=r.name,a.name=s),vC(a,r),r.extensions&&yC(n,a,r),void 0!==r.matrix){const e=new Nn;e.fromArray(r.matrix),a.applyMatrix4(e)}else void 0!==r.translation&&a.position.fromArray(r.translation),void 0!==r.rotation&&a.quaternion.fromArray(r.rotation),void 0!==r.scale&&a.scale.fromArray(r.scale);return i.associations.has(a)||i.associations.set(a,{}),i.associations.get(a).nodes=e,a})),this.nodeCache[e]}loadScene(e){const t=this.extensions,n=this.json.scenes[e],i=this,r=new oo;n.name&&(r.name=i.createUniqueName(n.name)),vC(r,n),n.extensions&&yC(t,r,n);const s=n.nodes||[],a=[];for(let e=0,t=s.length;e<t;e++)a.push(i.getDependency("node",s[e]));return Promise.all(a).then((function(e){for(let t=0,n=e.length;t<n;t++)r.add(e[t]);return i.associations=(e=>{const t=new Map;for(const[e,n]of i.associations)(e instanceof Ri||e instanceof Jt)&&t.set(e,n);return e.traverse((e=>{const n=i.associations.get(e);null!=n&&t.set(e,n)})),t})(r),r}))}_createAnimationTracks(e,t,n,i,r){const s=[],a=e.name?e.name:e.uuid,o=[];let l;switch(gC[r.path]===gC.weights?e.traverse((function(e){e.morphTargetInfluences&&o.push(e.name?e.name:e.uuid)})):o.push(a),gC[r.path]){case gC.weights:l=Nl;break;case gC.rotation:l=Ol;break;case gC.position:case gC.scale:l=kl;break;default:l=1===n.itemSize?Nl:kl}const c=void 0!==i.interpolation?AC[i.interpolation]:Ye,h=this._getArrayFromAccessor(n);for(let e=0,n=o.length;e<n;e++){const n=new l(o[e]+"."+gC[r.path],t.array,h,c);"CUBICSPLINE"===i.interpolation&&this._createCubicSplineTrackInterpolant(n),s.push(n)}return s}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){const e=bC(t.constructor),n=new Float32Array(t.length);for(let i=0,r=t.length;i<r;i++)n[i]=t[i]*e;t=n}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(e){return new(this instanceof Ol?cC:oC)(this.times,this.values,this.getValueSize()/3,e)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function SC(e,t,n){const i=t.attributes,r=[];function s(t,i){return n.getDependency("accessor",t).then((function(t){e.setAttribute(i,t)}))}for(const t in i){const n=mC[t]||t.toLowerCase();n in e.attributes||r.push(s(i[t],n))}if(void 0!==t.indices&&!e.index){const i=n.getDependency("accessor",t.indices).then((function(t){e.setIndex(t)}));r.push(i)}return Ot.workingColorSpace!==tt&&"COLOR_0"in i&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${Ot.workingColorSpace}" not supported.`),vC(e,t),function(e,t,n){const i=t.attributes,r=new ln;if(void 0===i.POSITION)return;{const e=n.json.accessors[i.POSITION],t=e.min,s=e.max;if(void 0===t||void 0===s)return void console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");if(r.set(new sn(t[0],t[1],t[2]),new sn(s[0],s[1],s[2])),e.normalized){const t=bC(uC[e.componentType]);r.min.multiplyScalar(t),r.max.multiplyScalar(t)}}const s=t.targets;if(void 0!==s){const e=new sn,t=new sn;for(let i=0,r=s.length;i<r;i++){const r=s[i];if(void 0!==r.POSITION){const i=n.json.accessors[r.POSITION],s=i.min,a=i.max;if(void 0!==s&&void 0!==a){if(t.setX(Math.max(Math.abs(s[0]),Math.abs(a[0]))),t.setY(Math.max(Math.abs(s[1]),Math.abs(a[1]))),t.setZ(Math.max(Math.abs(s[2]),Math.abs(a[2]))),i.normalized){const e=bC(uC[i.componentType]);t.multiplyScalar(e)}e.max(t)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}r.expandByVector(e)}e.boundingBox=r;const a=new Sn;r.getCenter(a.center),a.radius=r.min.distanceTo(r.max)/2,e.boundingSphere=a}(e,t,n),Promise.all(r).then((function(){return void 0!==t.targets?function(e,t,n){let i=!1,r=!1,s=!1;for(let e=0,n=t.length;e<n;e++){const n=t[e];if(void 0!==n.POSITION&&(i=!0),void 0!==n.NORMAL&&(r=!0),void 0!==n.COLOR_0&&(s=!0),i&&r&&s)break}if(!i&&!r&&!s)return Promise.resolve(e);const a=[],o=[],l=[];for(let c=0,h=t.length;c<h;c++){const h=t[c];if(i){const t=void 0!==h.POSITION?n.getDependency("accessor",h.POSITION):e.attributes.position;a.push(t)}if(r){const t=void 0!==h.NORMAL?n.getDependency("accessor",h.NORMAL):e.attributes.normal;o.push(t)}if(s){const t=void 0!==h.COLOR_0?n.getDependency("accessor",h.COLOR_0):e.attributes.color;l.push(t)}}return Promise.all([Promise.all(a),Promise.all(o),Promise.all(l)]).then((function(t){const n=t[0],a=t[1],o=t[2];return i&&(e.morphAttributes.position=n),r&&(e.morphAttributes.normal=a),s&&(e.morphAttributes.color=o),e.morphTargetsRelative=!0,e}))}(e,t.targets,n):e}))}const CC=new WeakMap;class TC extends jl{constructor(e){super(e),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}}setDecoderPath(e){return this.decoderPath=e,this}setDecoderConfig(e){return this.decoderConfig=e,this}setWorkerLimit(e){return this.workerLimit=e,this}load(e,t,n,i){const r=new Yl(this.manager);r.setPath(this.path),r.setResponseType("arraybuffer"),r.setRequestHeader(this.requestHeader),r.setWithCredentials(this.withCredentials),r.load(e,(e=>{this.parse(e,t,i)}),n,i)}parse(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:()=>{};this.decodeDracoFile(e,t,null,null,et,n).catch(n)}decodeDracoFile(e,t,n,i){let r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:tt,s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:()=>{};const a={attributeIDs:n||this.defaultAttributeIDs,attributeTypes:i||this.defaultAttributeTypes,useUniqueIDs:!!n,vertexColorSpace:r};return this.decodeGeometry(e,a).then(t).catch(s)}decodeGeometry(e,t){const n=JSON.stringify(t);if(CC.has(e)){const t=CC.get(e);if(t.key===n)return t.promise;if(0===e.byteLength)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let i;const r=this.workerNextTaskID++,s=e.byteLength,a=this._getWorker(r,s).then((n=>(i=n,new Promise(((n,s)=>{i._callbacks[r]={resolve:n,reject:s},i.postMessage({type:"decode",id:r,taskConfig:t,buffer:e},[e])}))))).then((e=>this._createGeometry(e.geometry)));return a.catch((()=>!0)).then((()=>{i&&r&&this._releaseTask(i,r)})),CC.set(e,{key:n,promise:a}),a}_createGeometry(e){const t=new ji;e.index&&t.setIndex(new Di(e.index.array,1));for(let n=0;n<e.attributes.length;n++){const i=e.attributes[n],r=i.name,s=i.array,a=i.itemSize,o=new Di(s,a);"color"===r&&(this._assignVertexColorSpace(o,i.vertexColorSpace),o.normalized=s instanceof Float32Array==0),t.setAttribute(r,o)}return t}_assignVertexColorSpace(e,t){if(t!==et)return;const n=new Ci;for(let t=0,i=e.count;t<i;t++)n.fromBufferAttribute(e,t),Ot.toWorkingColorSpace(n,et),e.setXYZ(t,n.r,n.g,n.b)}_loadLibrary(e,t){const n=new Yl(this.manager);return n.setPath(this.decoderPath),n.setResponseType(t),n.setWithCredentials(this.withCredentials),new Promise(((t,i)=>{n.load(e,t,void 0,i)}))}preload(){return this._initDecoder(),this}_initDecoder(){if(this.decoderPending)return this.decoderPending;const e="object"!=typeof WebAssembly||"js"===this.decoderConfig.type,t=[];return e?t.push(this._loadLibrary("draco_decoder.js","text")):(t.push(this._loadLibrary("draco_wasm_wrapper.js","text")),t.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(t).then((t=>{const n=t[0];e||(this.decoderConfig.wasmBinary=t[1]);const i=IC.toString(),r=["/* draco decoder */",n,"","/* worker */",i.substring(i.indexOf("{")+1,i.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([r]))})),this.decoderPending}_getWorker(e,t){return this._initDecoder().then((()=>{if(this.workerPool.length<this.workerLimit){const e=new Worker(this.workerSourceURL);e._callbacks={},e._taskCosts={},e._taskLoad=0,e.postMessage({type:"init",decoderConfig:this.decoderConfig}),e.onmessage=function(t){const n=t.data;switch(n.type){case"decode":e._callbacks[n.id].resolve(n);break;case"error":e._callbacks[n.id].reject(n);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+n.type+'"')}},this.workerPool.push(e)}else this.workerPool.sort((function(e,t){return e._taskLoad>t._taskLoad?-1:1}));const n=this.workerPool[this.workerPool.length-1];return n._taskCosts[e]=t,n._taskLoad+=t,n}))}_releaseTask(e,t){e._taskLoad-=e._taskCosts[t],delete e._callbacks[t],delete e._taskCosts[t]}debug(){console.log("Task load: ",this.workerPool.map((e=>e._taskLoad)))}dispose(){for(let e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,""!==this.workerSourceURL&&URL.revokeObjectURL(this.workerSourceURL),this}}function IC(){let e,t;function n(e,t,n,i,r,s){const a=s.num_components(),o=n.num_points()*a,l=o*r.BYTES_PER_ELEMENT,c=function(e,t){switch(t){case Float32Array:return e.DT_FLOAT32;case Int8Array:return e.DT_INT8;case Int16Array:return e.DT_INT16;case Int32Array:return e.DT_INT32;case Uint8Array:return e.DT_UINT8;case Uint16Array:return e.DT_UINT16;case Uint32Array:return e.DT_UINT32}}(e,r),h=e._malloc(l);t.GetAttributeDataArrayForAllPoints(n,s,c,l,h);const u=new r(e.HEAPF32.buffer,h,o).slice();return e._free(h),{name:i,array:u,itemSize:a}}onmessage=function(i){const r=i.data;switch(r.type){case"init":e=r.decoderConfig,t=new Promise((function(t){e.onModuleLoaded=function(e){t({draco:e})},DracoDecoderModule(e)}));break;case"decode":const i=r.buffer,s=r.taskConfig;t.then((e=>{const t=e.draco,a=new t.Decoder;try{const e=function(e,t,i,r){const s=r.attributeIDs,a=r.attributeTypes;let o,l;const c=t.GetEncodedGeometryType(i);if(c===e.TRIANGULAR_MESH)o=new e.Mesh,l=t.DecodeArrayToMesh(i,i.byteLength,o);else{if(c!==e.POINT_CLOUD)throw new Error("THREE.DRACOLoader: Unexpected geometry type.");o=new e.PointCloud,l=t.DecodeArrayToPointCloud(i,i.byteLength,o)}if(!l.ok()||0===o.ptr)throw new Error("THREE.DRACOLoader: Decoding failed: "+l.error_msg());const h={index:null,attributes:[]};for(const i in s){const l=self[a[i]];let c,u;if(r.useUniqueIDs)u=s[i],c=t.GetAttributeByUniqueId(o,u);else{if(u=t.GetAttributeId(o,e[s[i]]),-1===u)continue;c=t.GetAttribute(o,u)}const d=n(e,t,o,i,l,c);"color"===i&&(d.vertexColorSpace=r.vertexColorSpace),h.attributes.push(d)}return c===e.TRIANGULAR_MESH&&(h.index=function(e,t,n){const i=3*n.num_faces(),r=4*i,s=e._malloc(r);t.GetTrianglesUInt32Array(n,r,s);const a=new Uint32Array(e.HEAPF32.buffer,s,i).slice();return e._free(s),{array:a,itemSize:1}}(e,t,o)),e.destroy(o),h}(t,a,new Int8Array(i),s),o=e.attributes.map((e=>e.array.buffer));e.index&&o.push(e.index.array.buffer),self.postMessage({type:"decode",id:r.id,geometry:e},o)}catch(e){console.error(e),self.postMessage({type:"error",id:r.id,error:e.message})}finally{t.destroy(a)}}))}}}class RC{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:4;this.pool=e,this.queue=[],this.workers=[],this.workersResolve=[],this.workerStatus=0}_initWorker(e){if(!this.workers[e]){const t=this.workerCreator();t.addEventListener("message",this._onMessage.bind(this,e)),this.workers[e]=t}}_getIdleWorker(){for(let e=0;e<this.pool;e++)if(!(this.workerStatus&1<<e))return e;return-1}_onMessage(e,t){const n=this.workersResolve[e];if(n&&n(t),this.queue.length){const{resolve:t,msg:n,transfer:i}=this.queue.shift();this.workersResolve[e]=t,this.workers[e].postMessage(n,i)}else this.workerStatus^=1<<e}setWorkerCreator(e){this.workerCreator=e}setWorkerLimit(e){this.pool=e}postMessage(e,t){return new Promise((n=>{const i=this._getIdleWorker();-1!==i?(this._initWorker(i),this.workerStatus|=1<<i,this.workersResolve[i]=n,this.workers[i].postMessage(e,t)):this.queue.push({resolve:n,msg:e,transfer:t})}))}dispose(){this.workers.forEach((e=>e.terminate())),this.workersResolve.length=0,this.workers.length=0,this.queue.length=0,this.workerStatus=0}}const BC=9,LC=15,PC=16,DC=22,NC=37,UC=43,OC=76,FC=83,kC=97,QC=100,zC=103,GC=109,HC=165,VC=166,jC=1000066e3;class qC{constructor(){this.vkFormat=0,this.typeSize=1,this.pixelWidth=0,this.pixelHeight=0,this.pixelDepth=0,this.layerCount=0,this.faceCount=1,this.supercompressionScheme=0,this.levels=[],this.dataFormatDescriptor=[{vendorId:0,descriptorType:0,descriptorBlockSize:0,versionNumber:2,colorModel:0,colorPrimaries:1,transferFunction:2,flags:0,texelBlockDimension:[0,0,0,0],bytesPlane:[0,0,0,0,0,0,0,0],samples:[]}],this.keyValue={},this.globalData=null}}class WC{constructor(e,t,n,i){this._dataView=void 0,this._littleEndian=void 0,this._offset=void 0,this._dataView=new DataView(e.buffer,e.byteOffset+t,n),this._littleEndian=i,this._offset=0}_nextUint8(){const e=this._dataView.getUint8(this._offset);return this._offset+=1,e}_nextUint16(){const e=this._dataView.getUint16(this._offset,this._littleEndian);return this._offset+=2,e}_nextUint32(){const e=this._dataView.getUint32(this._offset,this._littleEndian);return this._offset+=4,e}_nextUint64(){const e=this._dataView.getUint32(this._offset,this._littleEndian)+2**32*this._dataView.getUint32(this._offset+4,this._littleEndian);return this._offset+=8,e}_nextInt32(){const e=this._dataView.getInt32(this._offset,this._littleEndian);return this._offset+=4,e}_nextUint8Array(e){const t=new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+this._offset,e);return this._offset+=e,t}_skip(e){return this._offset+=e,this}_scan(e,t){void 0===t&&(t=0);const n=this._offset;let i=0;for(;this._dataView.getUint8(this._offset)!==t&&i<e;)i++,this._offset++;return i<e&&this._offset++,new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+n,i)}}new Uint8Array([0]);const YC=[171,75,84,88,32,50,48,187,13,10,26,10];function XC(e){return(new TextDecoder).decode(e)}let KC,JC,$C;const ZC={env:{emscripten_notify_memory_growth:function(){$C=new Uint8Array(JC.exports.memory.buffer)}}};class eT{init(){return KC||(KC="undefined"!=typeof fetch?fetch("data:application/wasm;base64,"+tT).then((e=>e.arrayBuffer())).then((e=>WebAssembly.instantiate(e,ZC))).then(this._init):WebAssembly.instantiate(Buffer.from(tT,"base64"),ZC).then(this._init),KC)}_init(e){JC=e.instance,ZC.env.emscripten_notify_memory_growth(0)}decode(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(!JC)throw new Error("ZSTDDecoder: Await .init() before decoding.");const n=e.byteLength,i=JC.exports.malloc(n);$C.set(e,i),t=t||Number(JC.exports.ZSTD_findDecompressedSize(i,n));const r=JC.exports.malloc(t),s=JC.exports.ZSTD_decompress(r,t,i,n),a=$C.slice(r,r+s);return JC.exports.free(i),JC.exports.free(r),a}}const tT="AGFzbQEAAAABpQEVYAF/AX9gAn9/AGADf39/AX9gBX9/f39/AX9gAX8AYAJ/fwF/YAR/f39/AX9gA39/fwBgBn9/f39/fwF/YAd/f39/f39/AX9gAn9/AX5gAn5+AX5gAABgBX9/f39/AGAGf39/f39/AGAIf39/f39/f38AYAl/f39/f39/f38AYAABf2AIf39/f39/f38Bf2ANf39/f39/f39/f39/fwF/YAF/AX4CJwEDZW52H2Vtc2NyaXB0ZW5fbm90aWZ5X21lbW9yeV9ncm93dGgABANpaAEFAAAFAgEFCwACAQABAgIFBQcAAwABDgsBAQcAEhMHAAUBDAQEAAANBwQCAgYCBAgDAwMDBgEACQkHBgICAAYGAgQUBwYGAwIGAAMCAQgBBwUGCgoEEQAEBAEIAwgDBQgDEA8IAAcABAUBcAECAgUEAQCAAgYJAX8BQaCgwAILB2AHBm1lbW9yeQIABm1hbGxvYwAoBGZyZWUAJgxaU1REX2lzRXJyb3IAaBlaU1REX2ZpbmREZWNvbXByZXNzZWRTaXplAFQPWlNURF9kZWNvbXByZXNzAEoGX3N0YXJ0ACQJBwEAQQELASQKussBaA8AIAAgACgCBCABajYCBAsZACAAKAIAIAAoAgRBH3F0QQAgAWtBH3F2CwgAIABBiH9LC34BBH9BAyEBIAAoAgQiA0EgTQRAIAAoAggiASAAKAIQTwRAIAAQDQ8LIAAoAgwiAiABRgRAQQFBAiADQSBJGw8LIAAgASABIAJrIANBA3YiBCABIARrIAJJIgEbIgJrIgQ2AgggACADIAJBA3RrNgIEIAAgBCgAADYCAAsgAQsUAQF/IAAgARACIQIgACABEAEgAgv3AQECfyACRQRAIABCADcCACAAQQA2AhAgAEIANwIIQbh/DwsgACABNgIMIAAgAUEEajYCECACQQRPBEAgACABIAJqIgFBfGoiAzYCCCAAIAMoAAA2AgAgAUF/ai0AACIBBEAgAEEIIAEQFGs2AgQgAg8LIABBADYCBEF/DwsgACABNgIIIAAgAS0AACIDNgIAIAJBfmoiBEEBTQRAIARBAWtFBEAgACABLQACQRB0IANyIgM2AgALIAAgAS0AAUEIdCADajYCAAsgASACakF/ai0AACIBRQRAIABBADYCBEFsDwsgAEEoIAEQFCACQQN0ams2AgQgAgsWACAAIAEpAAA3AAAgACABKQAINwAICy8BAX8gAUECdEGgHWooAgAgACgCAEEgIAEgACgCBGprQR9xdnEhAiAAIAEQASACCyEAIAFCz9bTvtLHq9lCfiAAfEIfiUKHla+vmLbem55/fgsdAQF/IAAoAgggACgCDEYEfyAAKAIEQSBGBUEACwuCBAEDfyACQYDAAE8EQCAAIAEgAhBnIAAPCyAAIAJqIQMCQCAAIAFzQQNxRQRAAkAgAkEBSARAIAAhAgwBCyAAQQNxRQRAIAAhAgwBCyAAIQIDQCACIAEtAAA6AAAgAUEBaiEBIAJBAWoiAiADTw0BIAJBA3ENAAsLAkAgA0F8cSIEQcAASQ0AIAIgBEFAaiIFSw0AA0AgAiABKAIANgIAIAIgASgCBDYCBCACIAEoAgg2AgggAiABKAIMNgIMIAIgASgCEDYCECACIAEoAhQ2AhQgAiABKAIYNgIYIAIgASgCHDYCHCACIAEoAiA2AiAgAiABKAIkNgIkIAIgASgCKDYCKCACIAEoAiw2AiwgAiABKAIwNgIwIAIgASgCNDYCNCACIAEoAjg2AjggAiABKAI8NgI8IAFBQGshASACQUBrIgIgBU0NAAsLIAIgBE8NAQNAIAIgASgCADYCACABQQRqIQEgAkEEaiICIARJDQALDAELIANBBEkEQCAAIQIMAQsgA0F8aiIEIABJBEAgACECDAELIAAhAgNAIAIgAS0AADoAACACIAEtAAE6AAEgAiABLQACOgACIAIgAS0AAzoAAyABQQRqIQEgAkEEaiICIARNDQALCyACIANJBEADQCACIAEtAAA6AAAgAUEBaiEBIAJBAWoiAiADRw0ACwsgAAsMACAAIAEpAAA3AAALQQECfyAAKAIIIgEgACgCEEkEQEEDDwsgACAAKAIEIgJBB3E2AgQgACABIAJBA3ZrIgE2AgggACABKAAANgIAQQALDAAgACABKAIANgAAC/cCAQJ/AkAgACABRg0AAkAgASACaiAASwRAIAAgAmoiBCABSw0BCyAAIAEgAhALDwsgACABc0EDcSEDAkACQCAAIAFJBEAgAwRAIAAhAwwDCyAAQQNxRQRAIAAhAwwCCyAAIQMDQCACRQ0EIAMgAS0AADoAACABQQFqIQEgAkF/aiECIANBAWoiA0EDcQ0ACwwBCwJAIAMNACAEQQNxBEADQCACRQ0FIAAgAkF/aiICaiIDIAEgAmotAAA6AAAgA0EDcQ0ACwsgAkEDTQ0AA0AgACACQXxqIgJqIAEgAmooAgA2AgAgAkEDSw0ACwsgAkUNAgNAIAAgAkF/aiICaiABIAJqLQAAOgAAIAINAAsMAgsgAkEDTQ0AIAIhBANAIAMgASgCADYCACABQQRqIQEgA0EEaiEDIARBfGoiBEEDSw0ACyACQQNxIQILIAJFDQADQCADIAEtAAA6AAAgA0EBaiEDIAFBAWohASACQX9qIgINAAsLIAAL8wICAn8BfgJAIAJFDQAgACACaiIDQX9qIAE6AAAgACABOgAAIAJBA0kNACADQX5qIAE6AAAgACABOgABIANBfWogAToAACAAIAE6AAIgAkEHSQ0AIANBfGogAToAACAAIAE6AAMgAkEJSQ0AIABBACAAa0EDcSIEaiIDIAFB/wFxQYGChAhsIgE2AgAgAyACIARrQXxxIgRqIgJBfGogATYCACAEQQlJDQAgAyABNgIIIAMgATYCBCACQXhqIAE2AgAgAkF0aiABNgIAIARBGUkNACADIAE2AhggAyABNgIUIAMgATYCECADIAE2AgwgAkFwaiABNgIAIAJBbGogATYCACACQWhqIAE2AgAgAkFkaiABNgIAIAQgA0EEcUEYciIEayICQSBJDQAgAa0iBUIghiAFhCEFIAMgBGohAQNAIAEgBTcDGCABIAU3AxAgASAFNwMIIAEgBTcDACABQSBqIQEgAkFgaiICQR9LDQALCyAACy8BAn8gACgCBCAAKAIAQQJ0aiICLQACIQMgACACLwEAIAEgAi0AAxAIajYCACADCy8BAn8gACgCBCAAKAIAQQJ0aiICLQACIQMgACACLwEAIAEgAi0AAxAFajYCACADCx8AIAAgASACKAIEEAg2AgAgARAEGiAAIAJBCGo2AgQLCAAgAGdBH3MLugUBDX8jAEEQayIKJAACfyAEQQNNBEAgCkEANgIMIApBDGogAyAEEAsaIAAgASACIApBDGpBBBAVIgBBbCAAEAMbIAAgACAESxsMAQsgAEEAIAEoAgBBAXRBAmoQECENQVQgAygAACIGQQ9xIgBBCksNABogAiAAQQVqNgIAIAMgBGoiAkF8aiEMIAJBeWohDiACQXtqIRAgAEEGaiELQQQhBSAGQQR2IQRBICAAdCIAQQFyIQkgASgCACEPQQAhAiADIQYCQANAIAlBAkggAiAPS3JFBEAgAiEHAkAgCARAA0AgBEH//wNxQf//A0YEQCAHQRhqIQcgBiAQSQR/IAZBAmoiBigAACAFdgUgBUEQaiEFIARBEHYLIQQMAQsLA0AgBEEDcSIIQQNGBEAgBUECaiEFIARBAnYhBCAHQQNqIQcMAQsLIAcgCGoiByAPSw0EIAVBAmohBQNAIAIgB0kEQCANIAJBAXRqQQA7AQAgAkEBaiECDAELCyAGIA5LQQAgBiAFQQN1aiIHIAxLG0UEQCAHKAAAIAVBB3EiBXYhBAwCCyAEQQJ2IQQLIAYhBwsCfyALQX9qIAQgAEF/anEiBiAAQQF0QX9qIgggCWsiEUkNABogBCAIcSIEQQAgESAEIABIG2shBiALCyEIIA0gAkEBdGogBkF/aiIEOwEAIAlBASAGayAEIAZBAUgbayEJA0AgCSAASARAIABBAXUhACALQX9qIQsMAQsLAn8gByAOS0EAIAcgBSAIaiIFQQN1aiIGIAxLG0UEQCAFQQdxDAELIAUgDCIGIAdrQQN0awshBSACQQFqIQIgBEUhCCAGKAAAIAVBH3F2IQQMAQsLQWwgCUEBRyAFQSBKcg0BGiABIAJBf2o2AgAgBiAFQQdqQQN1aiADawwBC0FQCyEAIApBEGokACAACwkAQQFBBSAAGwsMACAAIAEoAAA2AAALqgMBCn8jAEHwAGsiCiQAIAJBAWohDiAAQQhqIQtBgIAEIAVBf2p0QRB1IQxBACECQQEhBkEBIAV0IglBf2oiDyEIA0AgAiAORkUEQAJAIAEgAkEBdCINai8BACIHQf//A0YEQCALIAhBA3RqIAI2AgQgCEF/aiEIQQEhBwwBCyAGQQAgDCAHQRB0QRB1ShshBgsgCiANaiAHOwEAIAJBAWohAgwBCwsgACAFNgIEIAAgBjYCACAJQQN2IAlBAXZqQQNqIQxBACEAQQAhBkEAIQIDQCAGIA5GBEADQAJAIAAgCUYNACAKIAsgAEEDdGoiASgCBCIGQQF0aiICIAIvAQAiAkEBajsBACABIAUgAhAUayIIOgADIAEgAiAIQf8BcXQgCWs7AQAgASAEIAZBAnQiAmooAgA6AAIgASACIANqKAIANgIEIABBAWohAAwBCwsFIAEgBkEBdGouAQAhDUEAIQcDQCAHIA1ORQRAIAsgAkEDdGogBjYCBANAIAIgDGogD3EiAiAISw0ACyAHQQFqIQcMAQsLIAZBAWohBgwBCwsgCkHwAGokAAsjAEIAIAEQCSAAhUKHla+vmLbem55/fkLj3MqV/M7y9YV/fAsQACAAQn43AwggACABNgIACyQBAX8gAARAIAEoAgQiAgRAIAEoAgggACACEQEADwsgABAmCwsfACAAIAEgAi8BABAINgIAIAEQBBogACACQQRqNgIEC0oBAX9BoCAoAgAiASAAaiIAQX9MBEBBiCBBMDYCAEF/DwsCQCAAPwBBEHRNDQAgABBmDQBBiCBBMDYCAEF/DwtBoCAgADYCACABC9cBAQh/Qbp/IQoCQCACKAIEIgggAigCACIJaiIOIAEgAGtLDQBBbCEKIAkgBCADKAIAIgtrSw0AIAAgCWoiBCACKAIIIgxrIQ0gACABQWBqIg8gCyAJQQAQKSADIAkgC2o2AgACQAJAIAwgBCAFa00EQCANIQUMAQsgDCAEIAZrSw0CIAcgDSAFayIAaiIBIAhqIAdNBEAgBCABIAgQDxoMAgsgBCABQQAgAGsQDyEBIAIgACAIaiIINgIEIAEgAGshBAsgBCAPIAUgCEEBECkLIA4hCgsgCgubAgEBfyMAQYABayINJAAgDSADNgJ8AkAgAkEDSwRAQX8hCQwBCwJAAkACQAJAIAJBAWsOAwADAgELIAZFBEBBuH8hCQwEC0FsIQkgBS0AACICIANLDQMgACAHIAJBAnQiAmooAgAgAiAIaigCABA7IAEgADYCAEEBIQkMAwsgASAJNgIAQQAhCQwCCyAKRQRAQWwhCQwCC0EAIQkgC0UgDEEZSHINAUEIIAR0QQhqIQBBACECA0AgAiAATw0CIAJBQGshAgwAAAsAC0FsIQkgDSANQfwAaiANQfgAaiAFIAYQFSICEAMNACANKAJ4IgMgBEsNACAAIA0gDSgCfCAHIAggAxAYIAEgADYCACACIQkLIA1BgAFqJAAgCQsLACAAIAEgAhALGgsQACAALwAAIAAtAAJBEHRyCy8AAn9BuH8gAUEISQ0AGkFyIAAoAAQiAEF3Sw0AGkG4fyAAQQhqIgAgACABSxsLCwkAIAAgATsAAAsDAAELigYBBX8gACAAKAIAIgVBfnE2AgBBACAAIAVBAXZqQYQgKAIAIgQgAEYbIQECQAJAIAAoAgQiAkUNACACKAIAIgNBAXENACACQQhqIgUgA0EBdkF4aiIDQQggA0EISxtnQR9zQQJ0QYAfaiIDKAIARgRAIAMgAigCDDYCAAsgAigCCCIDBEAgAyACKAIMNgIECyACKAIMIgMEQCADIAIoAgg2AgALIAIgAigCACAAKAIAQX5xajYCAEGEICEAAkACQCABRQ0AIAEgAjYCBCABKAIAIgNBAXENASADQQF2QXhqIgNBCCADQQhLG2dBH3NBAnRBgB9qIgMoAgAgAUEIakYEQCADIAEoAgw2AgALIAEoAggiAwRAIAMgASgCDDYCBAsgASgCDCIDBEAgAyABKAIINgIAQYQgKAIAIQQLIAIgAigCACABKAIAQX5xajYCACABIARGDQAgASABKAIAQQF2akEEaiEACyAAIAI2AgALIAIoAgBBAXZBeGoiAEEIIABBCEsbZ0Efc0ECdEGAH2oiASgCACEAIAEgBTYCACACIAA2AgwgAkEANgIIIABFDQEgACAFNgIADwsCQCABRQ0AIAEoAgAiAkEBcQ0AIAJBAXZBeGoiAkEIIAJBCEsbZ0Efc0ECdEGAH2oiAigCACABQQhqRgRAIAIgASgCDDYCAAsgASgCCCICBEAgAiABKAIMNgIECyABKAIMIgIEQCACIAEoAgg2AgBBhCAoAgAhBAsgACAAKAIAIAEoAgBBfnFqIgI2AgACQCABIARHBEAgASABKAIAQQF2aiAANgIEIAAoAgAhAgwBC0GEICAANgIACyACQQF2QXhqIgFBCCABQQhLG2dBH3NBAnRBgB9qIgIoAgAhASACIABBCGoiAjYCACAAIAE2AgwgAEEANgIIIAFFDQEgASACNgIADwsgBUEBdkF4aiIBQQggAUEISxtnQR9zQQJ0QYAfaiICKAIAIQEgAiAAQQhqIgI2AgAgACABNgIMIABBADYCCCABRQ0AIAEgAjYCAAsLDgAgAARAIABBeGoQJQsLgAIBA38CQCAAQQ9qQXhxQYQgKAIAKAIAQQF2ayICEB1Bf0YNAAJAQYQgKAIAIgAoAgAiAUEBcQ0AIAFBAXZBeGoiAUEIIAFBCEsbZ0Efc0ECdEGAH2oiASgCACAAQQhqRgRAIAEgACgCDDYCAAsgACgCCCIBBEAgASAAKAIMNgIECyAAKAIMIgFFDQAgASAAKAIINgIAC0EBIQEgACAAKAIAIAJBAXRqIgI2AgAgAkEBcQ0AIAJBAXZBeGoiAkEIIAJBCEsbZ0Efc0ECdEGAH2oiAygCACECIAMgAEEIaiIDNgIAIAAgAjYCDCAAQQA2AgggAkUNACACIAM2AgALIAELtwIBA38CQAJAIABBASAAGyICEDgiAA0AAkACQEGEICgCACIARQ0AIAAoAgAiA0EBcQ0AIAAgA0EBcjYCACADQQF2QXhqIgFBCCABQQhLG2dBH3NBAnRBgB9qIgEoAgAgAEEIakYEQCABIAAoAgw2AgALIAAoAggiAQRAIAEgACgCDDYCBAsgACgCDCIBBEAgASAAKAIINgIACyACECchAkEAIQFBhCAoAgAhACACDQEgACAAKAIAQX5xNgIAQQAPCyACQQ9qQXhxIgMQHSICQX9GDQIgAkEHakF4cSIAIAJHBEAgACACaxAdQX9GDQMLAkBBhCAoAgAiAUUEQEGAICAANgIADAELIAAgATYCBAtBhCAgADYCACAAIANBAXRBAXI2AgAMAQsgAEUNAQsgAEEIaiEBCyABC7kDAQJ/IAAgA2ohBQJAIANBB0wEQANAIAAgBU8NAiAAIAItAAA6AAAgAEEBaiEAIAJBAWohAgwAAAsACyAEQQFGBEACQCAAIAJrIgZBB00EQCAAIAItAAA6AAAgACACLQABOgABIAAgAi0AAjoAAiAAIAItAAM6AAMgAEEEaiACIAZBAnQiBkHAHmooAgBqIgIQFyACIAZB4B5qKAIAayECDAELIAAgAhAMCyACQQhqIQIgAEEIaiEACwJAAkACQAJAIAUgAU0EQCAAIANqIQEgBEEBRyAAIAJrQQ9Kcg0BA0AgACACEAwgAkEIaiECIABBCGoiACABSQ0ACwwFCyAAIAFLBEAgACEBDAQLIARBAUcgACACa0EPSnINASAAIQMgAiEEA0AgAyAEEAwgBEEIaiEEIANBCGoiAyABSQ0ACwwCCwNAIAAgAhAHIAJBEGohAiAAQRBqIgAgAUkNAAsMAwsgACEDIAIhBANAIAMgBBAHIARBEGohBCADQRBqIgMgAUkNAAsLIAIgASAAa2ohAgsDQCABIAVPDQEgASACLQAAOgAAIAFBAWohASACQQFqIQIMAAALAAsLQQECfyAAIAAoArjgASIDNgLE4AEgACgCvOABIQQgACABNgK84AEgACABIAJqNgK44AEgACABIAQgA2tqNgLA4AELpgEBAX8gACAAKALs4QEQFjYCyOABIABCADcD+OABIABCADcDuOABIABBwOABakIANwMAIABBqNAAaiIBQYyAgOAANgIAIABBADYCmOIBIABCADcDiOEBIABCAzcDgOEBIABBrNABakHgEikCADcCACAAQbTQAWpB6BIoAgA2AgAgACABNgIMIAAgAEGYIGo2AgggACAAQaAwajYCBCAAIABBEGo2AgALYQEBf0G4fyEDAkAgAUEDSQ0AIAIgABAhIgFBA3YiADYCCCACIAFBAXE2AgQgAiABQQF2QQNxIgM2AgACQCADQX9qIgFBAksNAAJAIAFBAWsOAgEAAgtBbA8LIAAhAwsgAwsMACAAIAEgAkEAEC4LiAQCA38CfiADEBYhBCAAQQBBKBAQIQAgBCACSwRAIAQPCyABRQRAQX8PCwJAAkAgA0EBRg0AIAEoAAAiBkGo6r5pRg0AQXYhAyAGQXBxQdDUtMIBRw0BQQghAyACQQhJDQEgAEEAQSgQECEAIAEoAAQhASAAQQE2AhQgACABrTcDAEEADwsgASACIAMQLyIDIAJLDQAgACADNgIYQXIhAyABIARqIgVBf2otAAAiAkEIcQ0AIAJBIHEiBkUEQEFwIQMgBS0AACIFQacBSw0BIAVBB3GtQgEgBUEDdkEKaq2GIgdCA4h+IAd8IQggBEEBaiEECyACQQZ2IQMgAkECdiEFAkAgAkEDcUF/aiICQQJLBEBBACECDAELAkACQAJAIAJBAWsOAgECAAsgASAEai0AACECIARBAWohBAwCCyABIARqLwAAIQIgBEECaiEEDAELIAEgBGooAAAhAiAEQQRqIQQLIAVBAXEhBQJ+AkACQAJAIANBf2oiA0ECTQRAIANBAWsOAgIDAQtCfyAGRQ0DGiABIARqMQAADAMLIAEgBGovAACtQoACfAwCCyABIARqKAAArQwBCyABIARqKQAACyEHIAAgBTYCICAAIAI2AhwgACAHNwMAQQAhAyAAQQA2AhQgACAHIAggBhsiBzcDCCAAIAdCgIAIIAdCgIAIVBs+AhALIAMLWwEBf0G4fyEDIAIQFiICIAFNBH8gACACakF/ai0AACIAQQNxQQJ0QaAeaigCACACaiAAQQZ2IgFBAnRBsB5qKAIAaiAAQSBxIgBFaiABRSAAQQV2cWoFQbh/CwsdACAAKAKQ4gEQWiAAQQA2AqDiASAAQgA3A5DiAQu1AwEFfyMAQZACayIKJABBuH8hBgJAIAVFDQAgBCwAACIIQf8BcSEHAkAgCEF/TARAIAdBgn9qQQF2IgggBU8NAkFsIQYgB0GBf2oiBUGAAk8NAiAEQQFqIQdBACEGA0AgBiAFTwRAIAUhBiAIIQcMAwUgACAGaiAHIAZBAXZqIgQtAABBBHY6AAAgACAGQQFyaiAELQAAQQ9xOgAAIAZBAmohBgwBCwAACwALIAcgBU8NASAAIARBAWogByAKEFMiBhADDQELIAYhBEEAIQYgAUEAQTQQECEJQQAhBQNAIAQgBkcEQCAAIAZqIggtAAAiAUELSwRAQWwhBgwDBSAJIAFBAnRqIgEgASgCAEEBajYCACAGQQFqIQZBASAILQAAdEEBdSAFaiEFDAILAAsLQWwhBiAFRQ0AIAUQFEEBaiIBQQxLDQAgAyABNgIAQQFBASABdCAFayIDEBQiAXQgA0cNACAAIARqIAFBAWoiADoAACAJIABBAnRqIgAgACgCAEEBajYCACAJKAIEIgBBAkkgAEEBcXINACACIARBAWo2AgAgB0EBaiEGCyAKQZACaiQAIAYLxhEBDH8jAEHwAGsiBSQAQWwhCwJAIANBCkkNACACLwAAIQogAi8AAiEJIAIvAAQhByAFQQhqIAQQDgJAIAMgByAJIApqakEGaiIMSQ0AIAUtAAohCCAFQdgAaiACQQZqIgIgChAGIgsQAw0BIAVBQGsgAiAKaiICIAkQBiILEAMNASAFQShqIAIgCWoiAiAHEAYiCxADDQEgBUEQaiACIAdqIAMgDGsQBiILEAMNASAAIAFqIg9BfWohECAEQQRqIQZBASELIAAgAUEDakECdiIDaiIMIANqIgIgA2oiDiEDIAIhBCAMIQcDQCALIAMgEElxBEAgACAGIAVB2ABqIAgQAkECdGoiCS8BADsAACAFQdgAaiAJLQACEAEgCS0AAyELIAcgBiAFQUBrIAgQAkECdGoiCS8BADsAACAFQUBrIAktAAIQASAJLQADIQogBCAGIAVBKGogCBACQQJ0aiIJLwEAOwAAIAVBKGogCS0AAhABIAktAAMhCSADIAYgBUEQaiAIEAJBAnRqIg0vAQA7AAAgBUEQaiANLQACEAEgDS0AAyENIAAgC2oiCyAGIAVB2ABqIAgQAkECdGoiAC8BADsAACAFQdgAaiAALQACEAEgAC0AAyEAIAcgCmoiCiAGIAVBQGsgCBACQQJ0aiIHLwEAOwAAIAVBQGsgBy0AAhABIActAAMhByAEIAlqIgkgBiAFQShqIAgQAkECdGoiBC8BADsAACAFQShqIAQtAAIQASAELQADIQQgAyANaiIDIAYgBUEQaiAIEAJBAnRqIg0vAQA7AAAgBUEQaiANLQACEAEgACALaiEAIAcgCmohByAEIAlqIQQgAyANLQADaiEDIAVB2ABqEA0gBUFAaxANciAFQShqEA1yIAVBEGoQDXJFIQsMAQsLIAQgDksgByACS3INAEFsIQsgACAMSw0BIAxBfWohCQNAQQAgACAJSSAFQdgAahAEGwRAIAAgBiAFQdgAaiAIEAJBAnRqIgovAQA7AAAgBUHYAGogCi0AAhABIAAgCi0AA2oiACAGIAVB2ABqIAgQAkECdGoiCi8BADsAACAFQdgAaiAKLQACEAEgACAKLQADaiEADAEFIAxBfmohCgNAIAVB2ABqEAQgACAKS3JFBEAgACAGIAVB2ABqIAgQAkECdGoiCS8BADsAACAFQdgAaiAJLQACEAEgACAJLQADaiEADAELCwNAIAAgCk0EQCAAIAYgBUHYAGogCBACQQJ0aiIJLwEAOwAAIAVB2ABqIAktAAIQASAAIAktAANqIQAMAQsLAkAgACAMTw0AIAAgBiAFQdgAaiAIEAIiAEECdGoiDC0AADoAACAMLQADQQFGBEAgBUHYAGogDC0AAhABDAELIAUoAlxBH0sNACAFQdgAaiAGIABBAnRqLQACEAEgBSgCXEEhSQ0AIAVBIDYCXAsgAkF9aiEMA0BBACAHIAxJIAVBQGsQBBsEQCAHIAYgBUFAayAIEAJBAnRqIgAvAQA7AAAgBUFAayAALQACEAEgByAALQADaiIAIAYgBUFAayAIEAJBAnRqIgcvAQA7AAAgBUFAayAHLQACEAEgACAHLQADaiEHDAEFIAJBfmohDANAIAVBQGsQBCAHIAxLckUEQCAHIAYgBUFAayAIEAJBAnRqIgAvAQA7AAAgBUFAayAALQACEAEgByAALQADaiEHDAELCwNAIAcgDE0EQCAHIAYgBUFAayAIEAJBAnRqIgAvAQA7AAAgBUFAayAALQACEAEgByAALQADaiEHDAELCwJAIAcgAk8NACAHIAYgBUFAayAIEAIiAEECdGoiAi0AADoAACACLQADQQFGBEAgBUFAayACLQACEAEMAQsgBSgCREEfSw0AIAVBQGsgBiAAQQJ0ai0AAhABIAUoAkRBIUkNACAFQSA2AkQLIA5BfWohAgNAQQAgBCACSSAFQShqEAQbBEAgBCAGIAVBKGogCBACQQJ0aiIALwEAOwAAIAVBKGogAC0AAhABIAQgAC0AA2oiACAGIAVBKGogCBACQQJ0aiIELwEAOwAAIAVBKGogBC0AAhABIAAgBC0AA2ohBAwBBSAOQX5qIQIDQCAFQShqEAQgBCACS3JFBEAgBCAGIAVBKGogCBACQQJ0aiIALwEAOwAAIAVBKGogAC0AAhABIAQgAC0AA2ohBAwBCwsDQCAEIAJNBEAgBCAGIAVBKGogCBACQQJ0aiIALwEAOwAAIAVBKGogAC0AAhABIAQgAC0AA2ohBAwBCwsCQCAEIA5PDQAgBCAGIAVBKGogCBACIgBBAnRqIgItAAA6AAAgAi0AA0EBRgRAIAVBKGogAi0AAhABDAELIAUoAixBH0sNACAFQShqIAYgAEECdGotAAIQASAFKAIsQSFJDQAgBUEgNgIsCwNAQQAgAyAQSSAFQRBqEAQbBEAgAyAGIAVBEGogCBACQQJ0aiIALwEAOwAAIAVBEGogAC0AAhABIAMgAC0AA2oiACAGIAVBEGogCBACQQJ0aiICLwEAOwAAIAVBEGogAi0AAhABIAAgAi0AA2ohAwwBBSAPQX5qIQIDQCAFQRBqEAQgAyACS3JFBEAgAyAGIAVBEGogCBACQQJ0aiIALwEAOwAAIAVBEGogAC0AAhABIAMgAC0AA2ohAwwBCwsDQCADIAJNBEAgAyAGIAVBEGogCBACQQJ0aiIALwEAOwAAIAVBEGogAC0AAhABIAMgAC0AA2ohAwwBCwsCQCADIA9PDQAgAyAGIAVBEGogCBACIgBBAnRqIgItAAA6AAAgAi0AA0EBRgRAIAVBEGogAi0AAhABDAELIAUoAhRBH0sNACAFQRBqIAYgAEECdGotAAIQASAFKAIUQSFJDQAgBUEgNgIUCyABQWwgBUHYAGoQCiAFQUBrEApxIAVBKGoQCnEgBUEQahAKcRshCwwJCwAACwALAAALAAsAAAsACwAACwALQWwhCwsgBUHwAGokACALC7UEAQ5/IwBBEGsiBiQAIAZBBGogABAOQVQhBQJAIARB3AtJDQAgBi0ABCEHIANB8ARqQQBB7AAQECEIIAdBDEsNACADQdwJaiIJIAggBkEIaiAGQQxqIAEgAhAxIhAQA0UEQCAGKAIMIgQgB0sNASADQdwFaiEPIANBpAVqIREgAEEEaiESIANBqAVqIQEgBCEFA0AgBSICQX9qIQUgCCACQQJ0aigCAEUNAAsgAkEBaiEOQQEhBQNAIAUgDk9FBEAgCCAFQQJ0IgtqKAIAIQwgASALaiAKNgIAIAVBAWohBSAKIAxqIQoMAQsLIAEgCjYCAEEAIQUgBigCCCELA0AgBSALRkUEQCABIAUgCWotAAAiDEECdGoiDSANKAIAIg1BAWo2AgAgDyANQQF0aiINIAw6AAEgDSAFOgAAIAVBAWohBQwBCwtBACEBIANBADYCqAUgBEF/cyAHaiEJQQEhBQNAIAUgDk9FBEAgCCAFQQJ0IgtqKAIAIQwgAyALaiABNgIAIAwgBSAJanQgAWohASAFQQFqIQUMAQsLIAcgBEEBaiIBIAJrIgRrQQFqIQgDQEEBIQUgBCAIT0UEQANAIAUgDk9FBEAgBUECdCIJIAMgBEE0bGpqIAMgCWooAgAgBHY2AgAgBUEBaiEFDAELCyAEQQFqIQQMAQsLIBIgByAPIAogESADIAIgARBkIAZBAToABSAGIAc6AAYgACAGKAIENgIACyAQIQULIAZBEGokACAFC8ENAQt/IwBB8ABrIgUkAEFsIQkCQCADQQpJDQAgAi8AACEKIAIvAAIhDCACLwAEIQYgBUEIaiAEEA4CQCADIAYgCiAMampBBmoiDUkNACAFLQAKIQcgBUHYAGogAkEGaiICIAoQBiIJEAMNASAFQUBrIAIgCmoiAiAMEAYiCRADDQEgBUEoaiACIAxqIgIgBhAGIgkQAw0BIAVBEGogAiAGaiADIA1rEAYiCRADDQEgACABaiIOQX1qIQ8gBEEEaiEGQQEhCSAAIAFBA2pBAnYiAmoiCiACaiIMIAJqIg0hAyAMIQQgCiECA0AgCSADIA9JcQRAIAYgBUHYAGogBxACQQF0aiIILQAAIQsgBUHYAGogCC0AARABIAAgCzoAACAGIAVBQGsgBxACQQF0aiIILQAAIQsgBUFAayAILQABEAEgAiALOgAAIAYgBUEoaiAHEAJBAXRqIggtAAAhCyAFQShqIAgtAAEQASAEIAs6AAAgBiAFQRBqIAcQAkEBdGoiCC0AACELIAVBEGogCC0AARABIAMgCzoAACAGIAVB2ABqIAcQAkEBdGoiCC0AACELIAVB2ABqIAgtAAEQASAAIAs6AAEgBiAFQUBrIAcQAkEBdGoiCC0AACELIAVBQGsgCC0AARABIAIgCzoAASAGIAVBKGogBxACQQF0aiIILQAAIQsgBUEoaiAILQABEAEgBCALOgABIAYgBUEQaiAHEAJBAXRqIggtAAAhCyAFQRBqIAgtAAEQASADIAs6AAEgA0ECaiEDIARBAmohBCACQQJqIQIgAEECaiEAIAkgBUHYAGoQDUVxIAVBQGsQDUVxIAVBKGoQDUVxIAVBEGoQDUVxIQkMAQsLIAQgDUsgAiAMS3INAEFsIQkgACAKSw0BIApBfWohCQNAIAVB2ABqEAQgACAJT3JFBEAgBiAFQdgAaiAHEAJBAXRqIggtAAAhCyAFQdgAaiAILQABEAEgACALOgAAIAYgBUHYAGogBxACQQF0aiIILQAAIQsgBUHYAGogCC0AARABIAAgCzoAASAAQQJqIQAMAQsLA0AgBUHYAGoQBCAAIApPckUEQCAGIAVB2ABqIAcQAkEBdGoiCS0AACEIIAVB2ABqIAktAAEQASAAIAg6AAAgAEEBaiEADAELCwNAIAAgCkkEQCAGIAVB2ABqIAcQAkEBdGoiCS0AACEIIAVB2ABqIAktAAEQASAAIAg6AAAgAEEBaiEADAELCyAMQX1qIQADQCAFQUBrEAQgAiAAT3JFBEAgBiAFQUBrIAcQAkEBdGoiCi0AACEJIAVBQGsgCi0AARABIAIgCToAACAGIAVBQGsgBxACQQF0aiIKLQAAIQkgBUFAayAKLQABEAEgAiAJOgABIAJBAmohAgwBCwsDQCAFQUBrEAQgAiAMT3JFBEAgBiAFQUBrIAcQAkEBdGoiAC0AACEKIAVBQGsgAC0AARABIAIgCjoAACACQQFqIQIMAQsLA0AgAiAMSQRAIAYgBUFAayAHEAJBAXRqIgAtAAAhCiAFQUBrIAAtAAEQASACIAo6AAAgAkEBaiECDAELCyANQX1qIQADQCAFQShqEAQgBCAAT3JFBEAgBiAFQShqIAcQAkEBdGoiAi0AACEKIAVBKGogAi0AARABIAQgCjoAACAGIAVBKGogBxACQQF0aiICLQAAIQogBUEoaiACLQABEAEgBCAKOgABIARBAmohBAwBCwsDQCAFQShqEAQgBCANT3JFBEAgBiAFQShqIAcQAkEBdGoiAC0AACECIAVBKGogAC0AARABIAQgAjoAACAEQQFqIQQMAQsLA0AgBCANSQRAIAYgBUEoaiAHEAJBAXRqIgAtAAAhAiAFQShqIAAtAAEQASAEIAI6AAAgBEEBaiEEDAELCwNAIAVBEGoQBCADIA9PckUEQCAGIAVBEGogBxACQQF0aiIALQAAIQIgBUEQaiAALQABEAEgAyACOgAAIAYgBUEQaiAHEAJBAXRqIgAtAAAhAiAFQRBqIAAtAAEQASADIAI6AAEgA0ECaiEDDAELCwNAIAVBEGoQBCADIA5PckUEQCAGIAVBEGogBxACQQF0aiIALQAAIQIgBUEQaiAALQABEAEgAyACOgAAIANBAWohAwwBCwsDQCADIA5JBEAgBiAFQRBqIAcQAkEBdGoiAC0AACECIAVBEGogAC0AARABIAMgAjoAACADQQFqIQMMAQsLIAFBbCAFQdgAahAKIAVBQGsQCnEgBUEoahAKcSAFQRBqEApxGyEJDAELQWwhCQsgBUHwAGokACAJC8oCAQR/IwBBIGsiBSQAIAUgBBAOIAUtAAIhByAFQQhqIAIgAxAGIgIQA0UEQCAEQQRqIQIgACABaiIDQX1qIQQDQCAFQQhqEAQgACAET3JFBEAgAiAFQQhqIAcQAkEBdGoiBi0AACEIIAVBCGogBi0AARABIAAgCDoAACACIAVBCGogBxACQQF0aiIGLQAAIQggBUEIaiAGLQABEAEgACAIOgABIABBAmohAAwBCwsDQCAFQQhqEAQgACADT3JFBEAgAiAFQQhqIAcQAkEBdGoiBC0AACEGIAVBCGogBC0AARABIAAgBjoAACAAQQFqIQAMAQsLA0AgACADT0UEQCACIAVBCGogBxACQQF0aiIELQAAIQYgBUEIaiAELQABEAEgACAGOgAAIABBAWohAAwBCwsgAUFsIAVBCGoQChshAgsgBUEgaiQAIAILtgMBCX8jAEEQayIGJAAgBkEANgIMIAZBADYCCEFUIQQCQAJAIANBQGsiDCADIAZBCGogBkEMaiABIAIQMSICEAMNACAGQQRqIAAQDiAGKAIMIgcgBi0ABEEBaksNASAAQQRqIQogBkEAOgAFIAYgBzoABiAAIAYoAgQ2AgAgB0EBaiEJQQEhBANAIAQgCUkEQCADIARBAnRqIgEoAgAhACABIAU2AgAgACAEQX9qdCAFaiEFIARBAWohBAwBCwsgB0EBaiEHQQAhBSAGKAIIIQkDQCAFIAlGDQEgAyAFIAxqLQAAIgRBAnRqIgBBASAEdEEBdSILIAAoAgAiAWoiADYCACAHIARrIQhBACEEAkAgC0EDTQRAA0AgBCALRg0CIAogASAEakEBdGoiACAIOgABIAAgBToAACAEQQFqIQQMAAALAAsDQCABIABPDQEgCiABQQF0aiIEIAg6AAEgBCAFOgAAIAQgCDoAAyAEIAU6AAIgBCAIOgAFIAQgBToABCAEIAg6AAcgBCAFOgAGIAFBBGohAQwAAAsACyAFQQFqIQUMAAALAAsgAiEECyAGQRBqJAAgBAutAQECfwJAQYQgKAIAIABHIAAoAgBBAXYiAyABa0F4aiICQXhxQQhHcgR/IAIFIAMQJ0UNASACQQhqC0EQSQ0AIAAgACgCACICQQFxIAAgAWpBD2pBeHEiASAAa0EBdHI2AgAgASAANgIEIAEgASgCAEEBcSAAIAJBAXZqIAFrIgJBAXRyNgIAQYQgIAEgAkH/////B3FqQQRqQYQgKAIAIABGGyABNgIAIAEQJQsLygIBBX8CQAJAAkAgAEEIIABBCEsbZ0EfcyAAaUEBR2oiAUEESSAAIAF2cg0AIAFBAnRB/B5qKAIAIgJFDQADQCACQXhqIgMoAgBBAXZBeGoiBSAATwRAIAIgBUEIIAVBCEsbZ0Efc0ECdEGAH2oiASgCAEYEQCABIAIoAgQ2AgALDAMLIARBHksNASAEQQFqIQQgAigCBCICDQALC0EAIQMgAUEgTw0BA0AgAUECdEGAH2ooAgAiAkUEQCABQR5LIQIgAUEBaiEBIAJFDQEMAwsLIAIgAkF4aiIDKAIAQQF2QXhqIgFBCCABQQhLG2dBH3NBAnRBgB9qIgEoAgBGBEAgASACKAIENgIACwsgAigCACIBBEAgASACKAIENgIECyACKAIEIgEEQCABIAIoAgA2AgALIAMgAygCAEEBcjYCACADIAAQNwsgAwvhCwINfwV+IwBB8ABrIgckACAHIAAoAvDhASIINgJcIAEgAmohDSAIIAAoAoDiAWohDwJAAkAgBUUEQCABIQQMAQsgACgCxOABIRAgACgCwOABIREgACgCvOABIQ4gAEEBNgKM4QFBACEIA0AgCEEDRwRAIAcgCEECdCICaiAAIAJqQazQAWooAgA2AkQgCEEBaiEIDAELC0FsIQwgB0EYaiADIAQQBhADDQEgB0EsaiAHQRhqIAAoAgAQEyAHQTRqIAdBGGogACgCCBATIAdBPGogB0EYaiAAKAIEEBMgDUFgaiESIAEhBEEAIQwDQCAHKAIwIAcoAixBA3RqKQIAIhRCEIinQf8BcSEIIAcoAkAgBygCPEEDdGopAgAiFUIQiKdB/wFxIQsgBygCOCAHKAI0QQN0aikCACIWQiCIpyEJIBVCIIghFyAUQiCIpyECAkAgFkIQiKdB/wFxIgNBAk8EQAJAIAZFIANBGUlyRQRAIAkgB0EYaiADQSAgBygCHGsiCiAKIANLGyIKEAUgAyAKayIDdGohCSAHQRhqEAQaIANFDQEgB0EYaiADEAUgCWohCQwBCyAHQRhqIAMQBSAJaiEJIAdBGGoQBBoLIAcpAkQhGCAHIAk2AkQgByAYNwNIDAELAkAgA0UEQCACBEAgBygCRCEJDAMLIAcoAkghCQwBCwJAAkAgB0EYakEBEAUgCSACRWpqIgNBA0YEQCAHKAJEQX9qIgMgA0VqIQkMAQsgA0ECdCAHaigCRCIJIAlFaiEJIANBAUYNAQsgByAHKAJINgJMCwsgByAHKAJENgJIIAcgCTYCRAsgF6chAyALBEAgB0EYaiALEAUgA2ohAwsgCCALakEUTwRAIAdBGGoQBBoLIAgEQCAHQRhqIAgQBSACaiECCyAHQRhqEAQaIAcgB0EYaiAUQhiIp0H/AXEQCCAUp0H//wNxajYCLCAHIAdBGGogFUIYiKdB/wFxEAggFadB//8DcWo2AjwgB0EYahAEGiAHIAdBGGogFkIYiKdB/wFxEAggFqdB//8DcWo2AjQgByACNgJgIAcoAlwhCiAHIAk2AmggByADNgJkAkACQAJAIAQgAiADaiILaiASSw0AIAIgCmoiEyAPSw0AIA0gBGsgC0Egak8NAQsgByAHKQNoNwMQIAcgBykDYDcDCCAEIA0gB0EIaiAHQdwAaiAPIA4gESAQEB4hCwwBCyACIARqIQggBCAKEAcgAkERTwRAIARBEGohAgNAIAIgCkEQaiIKEAcgAkEQaiICIAhJDQALCyAIIAlrIQIgByATNgJcIAkgCCAOa0sEQCAJIAggEWtLBEBBbCELDAILIBAgAiAOayICaiIKIANqIBBNBEAgCCAKIAMQDxoMAgsgCCAKQQAgAmsQDyEIIAcgAiADaiIDNgJkIAggAmshCCAOIQILIAlBEE8EQCADIAhqIQMDQCAIIAIQByACQRBqIQIgCEEQaiIIIANJDQALDAELAkAgCUEHTQRAIAggAi0AADoAACAIIAItAAE6AAEgCCACLQACOgACIAggAi0AAzoAAyAIQQRqIAIgCUECdCIDQcAeaigCAGoiAhAXIAIgA0HgHmooAgBrIQIgBygCZCEDDAELIAggAhAMCyADQQlJDQAgAyAIaiEDIAhBCGoiCCACQQhqIgJrQQ9MBEADQCAIIAIQDCACQQhqIQIgCEEIaiIIIANJDQAMAgALAAsDQCAIIAIQByACQRBqIQIgCEEQaiIIIANJDQALCyAHQRhqEAQaIAsgDCALEAMiAhshDCAEIAQgC2ogAhshBCAFQX9qIgUNAAsgDBADDQFBbCEMIAdBGGoQBEECSQ0BQQAhCANAIAhBA0cEQCAAIAhBAnQiAmpBrNABaiACIAdqKAJENgIAIAhBAWohCAwBCwsgBygCXCEIC0G6fyEMIA8gCGsiACANIARrSw0AIAQEfyAEIAggABALIABqBUEACyABayEMCyAHQfAAaiQAIAwLkRcCFn8FfiMAQdABayIHJAAgByAAKALw4QEiCDYCvAEgASACaiESIAggACgCgOIBaiETAkACQCAFRQRAIAEhAwwBCyAAKALE4AEhESAAKALA4AEhFSAAKAK84AEhDyAAQQE2AozhAUEAIQgDQCAIQQNHBEAgByAIQQJ0IgJqIAAgAmpBrNABaigCADYCVCAIQQFqIQgMAQsLIAcgETYCZCAHIA82AmAgByABIA9rNgJoQWwhECAHQShqIAMgBBAGEAMNASAFQQQgBUEESBshFyAHQTxqIAdBKGogACgCABATIAdBxABqIAdBKGogACgCCBATIAdBzABqIAdBKGogACgCBBATQQAhBCAHQeAAaiEMIAdB5ABqIQoDQCAHQShqEARBAksgBCAXTnJFBEAgBygCQCAHKAI8QQN0aikCACIdQhCIp0H/AXEhCyAHKAJQIAcoAkxBA3RqKQIAIh5CEIinQf8BcSEJIAcoAkggBygCREEDdGopAgAiH0IgiKchCCAeQiCIISAgHUIgiKchAgJAIB9CEIinQf8BcSIDQQJPBEACQCAGRSADQRlJckUEQCAIIAdBKGogA0EgIAcoAixrIg0gDSADSxsiDRAFIAMgDWsiA3RqIQggB0EoahAEGiADRQ0BIAdBKGogAxAFIAhqIQgMAQsgB0EoaiADEAUgCGohCCAHQShqEAQaCyAHKQJUISEgByAINgJUIAcgITcDWAwBCwJAIANFBEAgAgRAIAcoAlQhCAwDCyAHKAJYIQgMAQsCQAJAIAdBKGpBARAFIAggAkVqaiIDQQNGBEAgBygCVEF/aiIDIANFaiEIDAELIANBAnQgB2ooAlQiCCAIRWohCCADQQFGDQELIAcgBygCWDYCXAsLIAcgBygCVDYCWCAHIAg2AlQLICCnIQMgCQRAIAdBKGogCRAFIANqIQMLIAkgC2pBFE8EQCAHQShqEAQaCyALBEAgB0EoaiALEAUgAmohAgsgB0EoahAEGiAHIAcoAmggAmoiCSADajYCaCAKIAwgCCAJSxsoAgAhDSAHIAdBKGogHUIYiKdB/wFxEAggHadB//8DcWo2AjwgByAHQShqIB5CGIinQf8BcRAIIB6nQf//A3FqNgJMIAdBKGoQBBogB0EoaiAfQhiIp0H/AXEQCCEOIAdB8ABqIARBBHRqIgsgCSANaiAIazYCDCALIAg2AgggCyADNgIEIAsgAjYCACAHIA4gH6dB//8DcWo2AkQgBEEBaiEEDAELCyAEIBdIDQEgEkFgaiEYIAdB4ABqIRogB0HkAGohGyABIQMDQCAHQShqEARBAksgBCAFTnJFBEAgBygCQCAHKAI8QQN0aikCACIdQhCIp0H/AXEhCyAHKAJQIAcoAkxBA3RqKQIAIh5CEIinQf8BcSEIIAcoAkggBygCREEDdGopAgAiH0IgiKchCSAeQiCIISAgHUIgiKchDAJAIB9CEIinQf8BcSICQQJPBEACQCAGRSACQRlJckUEQCAJIAdBKGogAkEgIAcoAixrIgogCiACSxsiChAFIAIgCmsiAnRqIQkgB0EoahAEGiACRQ0BIAdBKGogAhAFIAlqIQkMAQsgB0EoaiACEAUgCWohCSAHQShqEAQaCyAHKQJUISEgByAJNgJUIAcgITcDWAwBCwJAIAJFBEAgDARAIAcoAlQhCQwDCyAHKAJYIQkMAQsCQAJAIAdBKGpBARAFIAkgDEVqaiICQQNGBEAgBygCVEF/aiICIAJFaiEJDAELIAJBAnQgB2ooAlQiCSAJRWohCSACQQFGDQELIAcgBygCWDYCXAsLIAcgBygCVDYCWCAHIAk2AlQLICCnIRQgCARAIAdBKGogCBAFIBRqIRQLIAggC2pBFE8EQCAHQShqEAQaCyALBEAgB0EoaiALEAUgDGohDAsgB0EoahAEGiAHIAcoAmggDGoiGSAUajYCaCAbIBogCSAZSxsoAgAhHCAHIAdBKGogHUIYiKdB/wFxEAggHadB//8DcWo2AjwgByAHQShqIB5CGIinQf8BcRAIIB6nQf//A3FqNgJMIAdBKGoQBBogByAHQShqIB9CGIinQf8BcRAIIB+nQf//A3FqNgJEIAcgB0HwAGogBEEDcUEEdGoiDSkDCCIdNwPIASAHIA0pAwAiHjcDwAECQAJAAkAgBygCvAEiDiAepyICaiIWIBNLDQAgAyAHKALEASIKIAJqIgtqIBhLDQAgEiADayALQSBqTw0BCyAHIAcpA8gBNwMQIAcgBykDwAE3AwggAyASIAdBCGogB0G8AWogEyAPIBUgERAeIQsMAQsgAiADaiEIIAMgDhAHIAJBEU8EQCADQRBqIQIDQCACIA5BEGoiDhAHIAJBEGoiAiAISQ0ACwsgCCAdpyIOayECIAcgFjYCvAEgDiAIIA9rSwRAIA4gCCAVa0sEQEFsIQsMAgsgESACIA9rIgJqIhYgCmogEU0EQCAIIBYgChAPGgwCCyAIIBZBACACaxAPIQggByACIApqIgo2AsQBIAggAmshCCAPIQILIA5BEE8EQCAIIApqIQoDQCAIIAIQByACQRBqIQIgCEEQaiIIIApJDQALDAELAkAgDkEHTQRAIAggAi0AADoAACAIIAItAAE6AAEgCCACLQACOgACIAggAi0AAzoAAyAIQQRqIAIgDkECdCIKQcAeaigCAGoiAhAXIAIgCkHgHmooAgBrIQIgBygCxAEhCgwBCyAIIAIQDAsgCkEJSQ0AIAggCmohCiAIQQhqIgggAkEIaiICa0EPTARAA0AgCCACEAwgAkEIaiECIAhBCGoiCCAKSQ0ADAIACwALA0AgCCACEAcgAkEQaiECIAhBEGoiCCAKSQ0ACwsgCxADBEAgCyEQDAQFIA0gDDYCACANIBkgHGogCWs2AgwgDSAJNgIIIA0gFDYCBCAEQQFqIQQgAyALaiEDDAILAAsLIAQgBUgNASAEIBdrIQtBACEEA0AgCyAFSARAIAcgB0HwAGogC0EDcUEEdGoiAikDCCIdNwPIASAHIAIpAwAiHjcDwAECQAJAAkAgBygCvAEiDCAepyICaiIKIBNLDQAgAyAHKALEASIJIAJqIhBqIBhLDQAgEiADayAQQSBqTw0BCyAHIAcpA8gBNwMgIAcgBykDwAE3AxggAyASIAdBGGogB0G8AWogEyAPIBUgERAeIRAMAQsgAiADaiEIIAMgDBAHIAJBEU8EQCADQRBqIQIDQCACIAxBEGoiDBAHIAJBEGoiAiAISQ0ACwsgCCAdpyIGayECIAcgCjYCvAEgBiAIIA9rSwRAIAYgCCAVa0sEQEFsIRAMAgsgESACIA9rIgJqIgwgCWogEU0EQCAIIAwgCRAPGgwCCyAIIAxBACACaxAPIQggByACIAlqIgk2AsQBIAggAmshCCAPIQILIAZBEE8EQCAIIAlqIQYDQCAIIAIQByACQRBqIQIgCEEQaiIIIAZJDQALDAELAkAgBkEHTQRAIAggAi0AADoAACAIIAItAAE6AAEgCCACLQACOgACIAggAi0AAzoAAyAIQQRqIAIgBkECdCIGQcAeaigCAGoiAhAXIAIgBkHgHmooAgBrIQIgBygCxAEhCQwBCyAIIAIQDAsgCUEJSQ0AIAggCWohBiAIQQhqIgggAkEIaiICa0EPTARAA0AgCCACEAwgAkEIaiECIAhBCGoiCCAGSQ0ADAIACwALA0AgCCACEAcgAkEQaiECIAhBEGoiCCAGSQ0ACwsgEBADDQMgC0EBaiELIAMgEGohAwwBCwsDQCAEQQNHBEAgACAEQQJ0IgJqQazQAWogAiAHaigCVDYCACAEQQFqIQQMAQsLIAcoArwBIQgLQbp/IRAgEyAIayIAIBIgA2tLDQAgAwR/IAMgCCAAEAsgAGoFQQALIAFrIRALIAdB0AFqJAAgEAslACAAQgA3AgAgAEEAOwEIIABBADoACyAAIAE2AgwgACACOgAKC7QFAQN/IwBBMGsiBCQAIABB/wFqIgVBfWohBgJAIAMvAQIEQCAEQRhqIAEgAhAGIgIQAw0BIARBEGogBEEYaiADEBwgBEEIaiAEQRhqIAMQHCAAIQMDQAJAIARBGGoQBCADIAZPckUEQCADIARBEGogBEEYahASOgAAIAMgBEEIaiAEQRhqEBI6AAEgBEEYahAERQ0BIANBAmohAwsgBUF+aiEFAn8DQEG6fyECIAMiASAFSw0FIAEgBEEQaiAEQRhqEBI6AAAgAUEBaiEDIARBGGoQBEEDRgRAQQIhAiAEQQhqDAILIAMgBUsNBSABIARBCGogBEEYahASOgABIAFBAmohA0EDIQIgBEEYahAEQQNHDQALIARBEGoLIQUgAyAFIARBGGoQEjoAACABIAJqIABrIQIMAwsgAyAEQRBqIARBGGoQEjoAAiADIARBCGogBEEYahASOgADIANBBGohAwwAAAsACyAEQRhqIAEgAhAGIgIQAw0AIARBEGogBEEYaiADEBwgBEEIaiAEQRhqIAMQHCAAIQMDQAJAIARBGGoQBCADIAZPckUEQCADIARBEGogBEEYahAROgAAIAMgBEEIaiAEQRhqEBE6AAEgBEEYahAERQ0BIANBAmohAwsgBUF+aiEFAn8DQEG6fyECIAMiASAFSw0EIAEgBEEQaiAEQRhqEBE6AAAgAUEBaiEDIARBGGoQBEEDRgRAQQIhAiAEQQhqDAILIAMgBUsNBCABIARBCGogBEEYahAROgABIAFBAmohA0EDIQIgBEEYahAEQQNHDQALIARBEGoLIQUgAyAFIARBGGoQEToAACABIAJqIABrIQIMAgsgAyAEQRBqIARBGGoQEToAAiADIARBCGogBEEYahAROgADIANBBGohAwwAAAsACyAEQTBqJAAgAgtpAQF/An8CQAJAIAJBB00NACABKAAAQbfIwuF+Rw0AIAAgASgABDYCmOIBQWIgAEEQaiABIAIQPiIDEAMNAhogAEKBgICAEDcDiOEBIAAgASADaiACIANrECoMAQsgACABIAIQKgtBAAsLrQMBBn8jAEGAAWsiAyQAQWIhCAJAIAJBCUkNACAAQZjQAGogAUEIaiIEIAJBeGogAEGY0AAQMyIFEAMiBg0AIANBHzYCfCADIANB/ABqIANB+ABqIAQgBCAFaiAGGyIEIAEgAmoiAiAEaxAVIgUQAw0AIAMoAnwiBkEfSw0AIAMoAngiB0EJTw0AIABBiCBqIAMgBkGAC0GADCAHEBggA0E0NgJ8IAMgA0H8AGogA0H4AGogBCAFaiIEIAIgBGsQFSIFEAMNACADKAJ8IgZBNEsNACADKAJ4IgdBCk8NACAAQZAwaiADIAZBgA1B4A4gBxAYIANBIzYCfCADIANB/ABqIANB+ABqIAQgBWoiBCACIARrEBUiBRADDQAgAygCfCIGQSNLDQAgAygCeCIHQQpPDQAgACADIAZBwBBB0BEgBxAYIAQgBWoiBEEMaiIFIAJLDQAgAiAFayEFQQAhAgNAIAJBA0cEQCAEKAAAIgZBf2ogBU8NAiAAIAJBAnRqQZzQAWogBjYCACACQQFqIQIgBEEEaiEEDAELCyAEIAFrIQgLIANBgAFqJAAgCAtGAQN/IABBCGohAyAAKAIEIQJBACEAA0AgACACdkUEQCABIAMgAEEDdGotAAJBFktqIQEgAEEBaiEADAELCyABQQggAmt0C4YDAQV/Qbh/IQcCQCADRQ0AIAItAAAiBEUEQCABQQA2AgBBAUG4fyADQQFGGw8LAn8gAkEBaiIFIARBGHRBGHUiBkF/Sg0AGiAGQX9GBEAgA0EDSA0CIAUvAABBgP4BaiEEIAJBA2oMAQsgA0ECSA0BIAItAAEgBEEIdHJBgIB+aiEEIAJBAmoLIQUgASAENgIAIAVBAWoiASACIANqIgNLDQBBbCEHIABBEGogACAFLQAAIgVBBnZBI0EJIAEgAyABa0HAEEHQEUHwEiAAKAKM4QEgACgCnOIBIAQQHyIGEAMiCA0AIABBmCBqIABBCGogBUEEdkEDcUEfQQggASABIAZqIAgbIgEgAyABa0GAC0GADEGAFyAAKAKM4QEgACgCnOIBIAQQHyIGEAMiCA0AIABBoDBqIABBBGogBUECdkEDcUE0QQkgASABIAZqIAgbIgEgAyABa0GADUHgDkGQGSAAKAKM4QEgACgCnOIBIAQQHyIAEAMNACAAIAFqIAJrIQcLIAcLrQMBCn8jAEGABGsiCCQAAn9BUiACQf8BSw0AGkFUIANBDEsNABogAkEBaiELIABBBGohCUGAgAQgA0F/anRBEHUhCkEAIQJBASEEQQEgA3QiB0F/aiIMIQUDQCACIAtGRQRAAkAgASACQQF0Ig1qLwEAIgZB//8DRgRAIAkgBUECdGogAjoAAiAFQX9qIQVBASEGDAELIARBACAKIAZBEHRBEHVKGyEECyAIIA1qIAY7AQAgAkEBaiECDAELCyAAIAQ7AQIgACADOwEAIAdBA3YgB0EBdmpBA2ohBkEAIQRBACECA0AgBCALRkUEQCABIARBAXRqLgEAIQpBACEAA0AgACAKTkUEQCAJIAJBAnRqIAQ6AAIDQCACIAZqIAxxIgIgBUsNAAsgAEEBaiEADAELCyAEQQFqIQQMAQsLQX8gAg0AGkEAIQIDfyACIAdGBH9BAAUgCCAJIAJBAnRqIgAtAAJBAXRqIgEgAS8BACIBQQFqOwEAIAAgAyABEBRrIgU6AAMgACABIAVB/wFxdCAHazsBACACQQFqIQIMAQsLCyEFIAhBgARqJAAgBQvjBgEIf0FsIQcCQCACQQNJDQACQAJAAkACQCABLQAAIgNBA3EiCUEBaw4DAwEAAgsgACgCiOEBDQBBYg8LIAJBBUkNAkEDIQYgASgAACEFAn8CQAJAIANBAnZBA3EiCEF+aiIEQQFNBEAgBEEBaw0BDAILIAVBDnZB/wdxIQQgBUEEdkH/B3EhAyAIRQwCCyAFQRJ2IQRBBCEGIAVBBHZB//8AcSEDQQAMAQsgBUEEdkH//w9xIgNBgIAISw0DIAEtAARBCnQgBUEWdnIhBEEFIQZBAAshBSAEIAZqIgogAksNAgJAIANBgQZJDQAgACgCnOIBRQ0AQQAhAgNAIAJBg4ABSw0BIAJBQGshAgwAAAsACwJ/IAlBA0YEQCABIAZqIQEgAEHw4gFqIQIgACgCDCEGIAUEQCACIAMgASAEIAYQXwwCCyACIAMgASAEIAYQXQwBCyAAQbjQAWohAiABIAZqIQEgAEHw4gFqIQYgAEGo0ABqIQggBQRAIAggBiADIAEgBCACEF4MAQsgCCAGIAMgASAEIAIQXAsQAw0CIAAgAzYCgOIBIABBATYCiOEBIAAgAEHw4gFqNgLw4QEgCUECRgRAIAAgAEGo0ABqNgIMCyAAIANqIgBBiOMBakIANwAAIABBgOMBakIANwAAIABB+OIBakIANwAAIABB8OIBakIANwAAIAoPCwJ/AkACQAJAIANBAnZBA3FBf2oiBEECSw0AIARBAWsOAgACAQtBASEEIANBA3YMAgtBAiEEIAEvAABBBHYMAQtBAyEEIAEQIUEEdgsiAyAEaiIFQSBqIAJLBEAgBSACSw0CIABB8OIBaiABIARqIAMQCyEBIAAgAzYCgOIBIAAgATYC8OEBIAEgA2oiAEIANwAYIABCADcAECAAQgA3AAggAEIANwAAIAUPCyAAIAM2AoDiASAAIAEgBGo2AvDhASAFDwsCfwJAAkACQCADQQJ2QQNxQX9qIgRBAksNACAEQQFrDgIAAgELQQEhByADQQN2DAILQQIhByABLwAAQQR2DAELIAJBBEkgARAhIgJBj4CAAUtyDQFBAyEHIAJBBHYLIQIgAEHw4gFqIAEgB2otAAAgAkEgahAQIQEgACACNgKA4gEgACABNgLw4QEgB0EBaiEHCyAHC0sAIABC+erQ0OfJoeThADcDICAAQgA3AxggAELP1tO+0ser2UI3AxAgAELW64Lu6v2J9eAANwMIIABCADcDACAAQShqQQBBKBAQGgviAgICfwV+IABBKGoiASAAKAJIaiECAn4gACkDACIDQiBaBEAgACkDECIEQgeJIAApAwgiBUIBiXwgACkDGCIGQgyJfCAAKQMgIgdCEol8IAUQGSAEEBkgBhAZIAcQGQwBCyAAKQMYQsXP2bLx5brqJ3wLIAN8IQMDQCABQQhqIgAgAk0EQEIAIAEpAAAQCSADhUIbiUKHla+vmLbem55/fkLj3MqV/M7y9YV/fCEDIAAhAQwBCwsCQCABQQRqIgAgAksEQCABIQAMAQsgASgAAK1Ch5Wvr5i23puef34gA4VCF4lCz9bTvtLHq9lCfkL5893xmfaZqxZ8IQMLA0AgACACSQRAIAAxAABCxc/ZsvHluuonfiADhUILiUKHla+vmLbem55/fiEDIABBAWohAAwBCwsgA0IhiCADhULP1tO+0ser2UJ+IgNCHYggA4VC+fPd8Zn2masWfiIDQiCIIAOFC+8CAgJ/BH4gACAAKQMAIAKtfDcDAAJAAkAgACgCSCIDIAJqIgRBH00EQCABRQ0BIAAgA2pBKGogASACECAgACgCSCACaiEEDAELIAEgAmohAgJ/IAMEQCAAQShqIgQgA2ogAUEgIANrECAgACAAKQMIIAQpAAAQCTcDCCAAIAApAxAgACkAMBAJNwMQIAAgACkDGCAAKQA4EAk3AxggACAAKQMgIABBQGspAAAQCTcDICAAKAJIIQMgAEEANgJIIAEgA2tBIGohAQsgAUEgaiACTQsEQCACQWBqIQMgACkDICEFIAApAxghBiAAKQMQIQcgACkDCCEIA0AgCCABKQAAEAkhCCAHIAEpAAgQCSEHIAYgASkAEBAJIQYgBSABKQAYEAkhBSABQSBqIgEgA00NAAsgACAFNwMgIAAgBjcDGCAAIAc3AxAgACAINwMICyABIAJPDQEgAEEoaiABIAIgAWsiBBAgCyAAIAQ2AkgLCy8BAX8gAEUEQEG2f0EAIAMbDwtBun8hBCADIAFNBH8gACACIAMQEBogAwVBun8LCy8BAX8gAEUEQEG2f0EAIAMbDwtBun8hBCADIAFNBH8gACACIAMQCxogAwVBun8LC6gCAQZ/IwBBEGsiByQAIABB2OABaikDAEKAgIAQViEIQbh/IQUCQCAEQf//B0sNACAAIAMgBBBCIgUQAyIGDQAgACgCnOIBIQkgACAHQQxqIAMgAyAFaiAGGyIKIARBACAFIAYbayIGEEAiAxADBEAgAyEFDAELIAcoAgwhBCABRQRAQbp/IQUgBEEASg0BCyAGIANrIQUgAyAKaiEDAkAgCQRAIABBADYCnOIBDAELAkACQAJAIARBBUgNACAAQdjgAWopAwBCgICACFgNAAwBCyAAQQA2ApziAQwBCyAAKAIIED8hBiAAQQA2ApziASAGQRRPDQELIAAgASACIAMgBSAEIAgQOSEFDAELIAAgASACIAMgBSAEIAgQOiEFCyAHQRBqJAAgBQtnACAAQdDgAWogASACIAAoAuzhARAuIgEQAwRAIAEPC0G4fyECAkAgAQ0AIABB7OABaigCACIBBEBBYCECIAAoApjiASABRw0BC0EAIQIgAEHw4AFqKAIARQ0AIABBkOEBahBDCyACCycBAX8QVyIERQRAQUAPCyAEIAAgASACIAMgBBBLEE8hACAEEFYgAAs/AQF/AkACQAJAIAAoAqDiAUEBaiIBQQJLDQAgAUEBaw4CAAECCyAAEDBBAA8LIABBADYCoOIBCyAAKAKU4gELvAMCB38BfiMAQRBrIgkkAEG4fyEGAkAgBCgCACIIQQVBCSAAKALs4QEiBRtJDQAgAygCACIHQQFBBSAFGyAFEC8iBRADBEAgBSEGDAELIAggBUEDakkNACAAIAcgBRBJIgYQAw0AIAEgAmohCiAAQZDhAWohCyAIIAVrIQIgBSAHaiEHIAEhBQNAIAcgAiAJECwiBhADDQEgAkF9aiICIAZJBEBBuH8hBgwCCyAJKAIAIghBAksEQEFsIQYMAgsgB0EDaiEHAn8CQAJAAkAgCEEBaw4CAgABCyAAIAUgCiAFayAHIAYQSAwCCyAFIAogBWsgByAGEEcMAQsgBSAKIAVrIActAAAgCSgCCBBGCyIIEAMEQCAIIQYMAgsgACgC8OABBEAgCyAFIAgQRQsgAiAGayECIAYgB2ohByAFIAhqIQUgCSgCBEUNAAsgACkD0OABIgxCf1IEQEFsIQYgDCAFIAFrrFINAQsgACgC8OABBEBBaiEGIAJBBEkNASALEEQhDCAHKAAAIAynRw0BIAdBBGohByACQXxqIQILIAMgBzYCACAEIAI2AgAgBSABayEGCyAJQRBqJAAgBgsuACAAECsCf0EAQQAQAw0AGiABRSACRXJFBEBBYiAAIAEgAhA9EAMNARoLQQALCzcAIAEEQCAAIAAoAsTgASABKAIEIAEoAghqRzYCnOIBCyAAECtBABADIAFFckUEQCAAIAEQWwsL0QIBB38jAEEQayIGJAAgBiAENgIIIAYgAzYCDCAFBEAgBSgCBCEKIAUoAgghCQsgASEIAkACQANAIAAoAuzhARAWIQsCQANAIAQgC0kNASADKAAAQXBxQdDUtMIBRgRAIAMgBBAiIgcQAw0EIAQgB2shBCADIAdqIQMMAQsLIAYgAzYCDCAGIAQ2AggCQCAFBEAgACAFEE5BACEHQQAQA0UNAQwFCyAAIAogCRBNIgcQAw0ECyAAIAgQUCAMQQFHQQAgACAIIAIgBkEMaiAGQQhqEEwiByIDa0EAIAMQAxtBCkdyRQRAQbh/IQcMBAsgBxADDQMgAiAHayECIAcgCGohCEEBIQwgBigCDCEDIAYoAgghBAwBCwsgBiADNgIMIAYgBDYCCEG4fyEHIAQNASAIIAFrIQcMAQsgBiADNgIMIAYgBDYCCAsgBkEQaiQAIAcLRgECfyABIAAoArjgASICRwRAIAAgAjYCxOABIAAgATYCuOABIAAoArzgASEDIAAgATYCvOABIAAgASADIAJrajYCwOABCwutAgIEfwF+IwBBQGoiBCQAAkACQCACQQhJDQAgASgAAEFwcUHQ1LTCAUcNACABIAIQIiEBIABCADcDCCAAQQA2AgQgACABNgIADAELIARBGGogASACEC0iAxADBEAgACADEBoMAQsgAwRAIABBuH8QGgwBCyACIAQoAjAiA2shAiABIANqIQMDQAJAIAAgAyACIARBCGoQLCIFEAMEfyAFBSACIAVBA2oiBU8NAUG4fwsQGgwCCyAGQQFqIQYgAiAFayECIAMgBWohAyAEKAIMRQ0ACyAEKAI4BEAgAkEDTQRAIABBuH8QGgwCCyADQQRqIQMLIAQoAighAiAEKQMYIQcgAEEANgIEIAAgAyABazYCACAAIAIgBmytIAcgB0J/URs3AwgLIARBQGskAAslAQF/IwBBEGsiAiQAIAIgACABEFEgAigCACEAIAJBEGokACAAC30BBH8jAEGQBGsiBCQAIARB/wE2AggCQCAEQRBqIARBCGogBEEMaiABIAIQFSIGEAMEQCAGIQUMAQtBVCEFIAQoAgwiB0EGSw0AIAMgBEEQaiAEKAIIIAcQQSIFEAMNACAAIAEgBmogAiAGayADEDwhBQsgBEGQBGokACAFC4cBAgJ/An5BABAWIQMCQANAIAEgA08EQAJAIAAoAABBcHFB0NS0wgFGBEAgACABECIiAhADRQ0BQn4PCyAAIAEQVSIEQn1WDQMgBCAFfCIFIARUIQJCfiEEIAINAyAAIAEQUiICEAMNAwsgASACayEBIAAgAmohAAwBCwtCfiAFIAEbIQQLIAQLPwIBfwF+IwBBMGsiAiQAAn5CfiACQQhqIAAgARAtDQAaQgAgAigCHEEBRg0AGiACKQMICyEDIAJBMGokACADC40BAQJ/IwBBMGsiASQAAkAgAEUNACAAKAKI4gENACABIABB/OEBaigCADYCKCABIAApAvThATcDICAAEDAgACgCqOIBIQIgASABKAIoNgIYIAEgASkDIDcDECACIAFBEGoQGyAAQQA2AqjiASABIAEoAig2AgggASABKQMgNwMAIAAgARAbCyABQTBqJAALKgECfyMAQRBrIgAkACAAQQA2AgggAEIANwMAIAAQWCEBIABBEGokACABC4cBAQN/IwBBEGsiAiQAAkAgACgCAEUgACgCBEVzDQAgAiAAKAIINgIIIAIgACkCADcDAAJ/IAIoAgAiAQRAIAIoAghBqOMJIAERBQAMAQtBqOMJECgLIgFFDQAgASAAKQIANwL04QEgAUH84QFqIAAoAgg2AgAgARBZIAEhAwsgAkEQaiQAIAMLywEBAn8jAEEgayIBJAAgAEGBgIDAADYCtOIBIABBADYCiOIBIABBADYC7OEBIABCADcDkOIBIABBADYCpOMJIABBADYC3OIBIABCADcCzOIBIABBADYCvOIBIABBADYCxOABIABCADcCnOIBIABBpOIBakIANwIAIABBrOIBakEANgIAIAFCADcCECABQgA3AhggASABKQMYNwMIIAEgASkDEDcDACABKAIIQQh2QQFxIQIgAEEANgLg4gEgACACNgKM4gEgAUEgaiQAC3YBA38jAEEwayIBJAAgAARAIAEgAEHE0AFqIgIoAgA2AiggASAAKQK80AE3AyAgACgCACEDIAEgAigCADYCGCABIAApArzQATcDECADIAFBEGoQGyABIAEoAig2AgggASABKQMgNwMAIAAgARAbCyABQTBqJAALzAEBAX8gACABKAK00AE2ApjiASAAIAEoAgQiAjYCwOABIAAgAjYCvOABIAAgAiABKAIIaiICNgK44AEgACACNgLE4AEgASgCuNABBEAgAEKBgICAEDcDiOEBIAAgAUGk0ABqNgIMIAAgAUGUIGo2AgggACABQZwwajYCBCAAIAFBDGo2AgAgAEGs0AFqIAFBqNABaigCADYCACAAQbDQAWogAUGs0AFqKAIANgIAIABBtNABaiABQbDQAWooAgA2AgAPCyAAQgA3A4jhAQs7ACACRQRAQbp/DwsgBEUEQEFsDwsgAiAEEGAEQCAAIAEgAiADIAQgBRBhDwsgACABIAIgAyAEIAUQZQtGAQF/IwBBEGsiBSQAIAVBCGogBBAOAn8gBS0ACQRAIAAgASACIAMgBBAyDAELIAAgASACIAMgBBA0CyEAIAVBEGokACAACzQAIAAgAyAEIAUQNiIFEAMEQCAFDwsgBSAESQR/IAEgAiADIAVqIAQgBWsgABA1BUG4fwsLRgEBfyMAQRBrIgUkACAFQQhqIAQQDgJ/IAUtAAkEQCAAIAEgAiADIAQQYgwBCyAAIAEgAiADIAQQNQshACAFQRBqJAAgAAtZAQF/QQ8hAiABIABJBEAgAUEEdCAAbiECCyAAQQh2IgEgAkEYbCIAQYwIaigCAGwgAEGICGooAgBqIgJBA3YgAmogAEGACGooAgAgAEGECGooAgAgAWxqSQs3ACAAIAMgBCAFQYAQEDMiBRADBEAgBQ8LIAUgBEkEfyABIAIgAyAFaiAEIAVrIAAQMgVBuH8LC78DAQN/IwBBIGsiBSQAIAVBCGogAiADEAYiAhADRQRAIAAgAWoiB0F9aiEGIAUgBBAOIARBBGohAiAFLQACIQMDQEEAIAAgBkkgBUEIahAEGwRAIAAgAiAFQQhqIAMQAkECdGoiBC8BADsAACAFQQhqIAQtAAIQASAAIAQtAANqIgQgAiAFQQhqIAMQAkECdGoiAC8BADsAACAFQQhqIAAtAAIQASAEIAAtAANqIQAMAQUgB0F+aiEEA0AgBUEIahAEIAAgBEtyRQRAIAAgAiAFQQhqIAMQAkECdGoiBi8BADsAACAFQQhqIAYtAAIQASAAIAYtAANqIQAMAQsLA0AgACAES0UEQCAAIAIgBUEIaiADEAJBAnRqIgYvAQA7AAAgBUEIaiAGLQACEAEgACAGLQADaiEADAELCwJAIAAgB08NACAAIAIgBUEIaiADEAIiA0ECdGoiAC0AADoAACAALQADQQFGBEAgBUEIaiAALQACEAEMAQsgBSgCDEEfSw0AIAVBCGogAiADQQJ0ai0AAhABIAUoAgxBIUkNACAFQSA2AgwLIAFBbCAFQQhqEAobIQILCwsgBUEgaiQAIAILkgIBBH8jAEFAaiIJJAAgCSADQTQQCyEDAkAgBEECSA0AIAMgBEECdGooAgAhCSADQTxqIAgQIyADQQE6AD8gAyACOgA+QQAhBCADKAI8IQoDQCAEIAlGDQEgACAEQQJ0aiAKNgEAIARBAWohBAwAAAsAC0EAIQkDQCAGIAlGRQRAIAMgBSAJQQF0aiIKLQABIgtBAnRqIgwoAgAhBCADQTxqIAotAABBCHQgCGpB//8DcRAjIANBAjoAPyADIAcgC2siCiACajoAPiAEQQEgASAKa3RqIQogAygCPCELA0AgACAEQQJ0aiALNgEAIARBAWoiBCAKSQ0ACyAMIAo2AgAgCUEBaiEJDAELCyADQUBrJAALowIBCX8jAEHQAGsiCSQAIAlBEGogBUE0EAsaIAcgBmshDyAHIAFrIRADQAJAIAMgCkcEQEEBIAEgByACIApBAXRqIgYtAAEiDGsiCGsiC3QhDSAGLQAAIQ4gCUEQaiAMQQJ0aiIMKAIAIQYgCyAPTwRAIAAgBkECdGogCyAIIAUgCEE0bGogCCAQaiIIQQEgCEEBShsiCCACIAQgCEECdGooAgAiCEEBdGogAyAIayAHIA4QYyAGIA1qIQgMAgsgCUEMaiAOECMgCUEBOgAPIAkgCDoADiAGIA1qIQggCSgCDCELA0AgBiAITw0CIAAgBkECdGogCzYBACAGQQFqIQYMAAALAAsgCUHQAGokAA8LIAwgCDYCACAKQQFqIQoMAAALAAs0ACAAIAMgBCAFEDYiBRADBEAgBQ8LIAUgBEkEfyABIAIgAyAFaiAEIAVrIAAQNAVBuH8LCyMAIAA/AEEQdGtB//8DakEQdkAAQX9GBEBBAA8LQQAQAEEBCzsBAX8gAgRAA0AgACABIAJBgCAgAkGAIEkbIgMQCyEAIAFBgCBqIQEgAEGAIGohACACIANrIgINAAsLCwYAIAAQAwsLqBUJAEGICAsNAQAAAAEAAAACAAAAAgBBoAgLswYBAAAAAQAAAAIAAAACAAAAJgAAAIIAAAAhBQAASgAAAGcIAAAmAAAAwAEAAIAAAABJBQAASgAAAL4IAAApAAAALAIAAIAAAABJBQAASgAAAL4IAAAvAAAAygIAAIAAAACKBQAASgAAAIQJAAA1AAAAcwMAAIAAAACdBQAASgAAAKAJAAA9AAAAgQMAAIAAAADrBQAASwAAAD4KAABEAAAAngMAAIAAAABNBgAASwAAAKoKAABLAAAAswMAAIAAAADBBgAATQAAAB8NAABNAAAAUwQAAIAAAAAjCAAAUQAAAKYPAABUAAAAmQQAAIAAAABLCQAAVwAAALESAABYAAAA2gQAAIAAAABvCQAAXQAAACMUAABUAAAARQUAAIAAAABUCgAAagAAAIwUAABqAAAArwUAAIAAAAB2CQAAfAAAAE4QAAB8AAAA0gIAAIAAAABjBwAAkQAAAJAHAACSAAAAAAAAAAEAAAABAAAABQAAAA0AAAAdAAAAPQAAAH0AAAD9AAAA/QEAAP0DAAD9BwAA/Q8AAP0fAAD9PwAA/X8AAP3/AAD9/wEA/f8DAP3/BwD9/w8A/f8fAP3/PwD9/38A/f//AP3//wH9//8D/f//B/3//w/9//8f/f//P/3//38AAAAAAQAAAAIAAAADAAAABAAAAAUAAAAGAAAABwAAAAgAAAAJAAAACgAAAAsAAAAMAAAADQAAAA4AAAAPAAAAEAAAABEAAAASAAAAEwAAABQAAAAVAAAAFgAAABcAAAAYAAAAGQAAABoAAAAbAAAAHAAAAB0AAAAeAAAAHwAAAAMAAAAEAAAABQAAAAYAAAAHAAAACAAAAAkAAAAKAAAACwAAAAwAAAANAAAADgAAAA8AAAAQAAAAEQAAABIAAAATAAAAFAAAABUAAAAWAAAAFwAAABgAAAAZAAAAGgAAABsAAAAcAAAAHQAAAB4AAAAfAAAAIAAAACEAAAAiAAAAIwAAACUAAAAnAAAAKQAAACsAAAAvAAAAMwAAADsAAABDAAAAUwAAAGMAAACDAAAAAwEAAAMCAAADBAAAAwgAAAMQAAADIAAAA0AAAAOAAAADAAEAQeAPC1EBAAAAAQAAAAEAAAABAAAAAgAAAAIAAAADAAAAAwAAAAQAAAAEAAAABQAAAAcAAAAIAAAACQAAAAoAAAALAAAADAAAAA0AAAAOAAAADwAAABAAQcQQC4sBAQAAAAIAAAADAAAABAAAAAUAAAAGAAAABwAAAAgAAAAJAAAACgAAAAsAAAAMAAAADQAAAA4AAAAPAAAAEAAAABIAAAAUAAAAFgAAABgAAAAcAAAAIAAAACgAAAAwAAAAQAAAAIAAAAAAAQAAAAIAAAAEAAAACAAAABAAAAAgAAAAQAAAAIAAAAAAAQBBkBIL5gQBAAAAAQAAAAEAAAABAAAAAgAAAAIAAAADAAAAAwAAAAQAAAAGAAAABwAAAAgAAAAJAAAACgAAAAsAAAAMAAAADQAAAA4AAAAPAAAAEAAAAAEAAAAEAAAACAAAAAAAAAABAAEBBgAAAAAAAAQAAAAAEAAABAAAAAAgAAAFAQAAAAAAAAUDAAAAAAAABQQAAAAAAAAFBgAAAAAAAAUHAAAAAAAABQkAAAAAAAAFCgAAAAAAAAUMAAAAAAAABg4AAAAAAAEFEAAAAAAAAQUUAAAAAAABBRYAAAAAAAIFHAAAAAAAAwUgAAAAAAAEBTAAAAAgAAYFQAAAAAAABwWAAAAAAAAIBgABAAAAAAoGAAQAAAAADAYAEAAAIAAABAAAAAAAAAAEAQAAAAAAAAUCAAAAIAAABQQAAAAAAAAFBQAAACAAAAUHAAAAAAAABQgAAAAgAAAFCgAAAAAAAAULAAAAAAAABg0AAAAgAAEFEAAAAAAAAQUSAAAAIAABBRYAAAAAAAIFGAAAACAAAwUgAAAAAAADBSgAAAAAAAYEQAAAABAABgRAAAAAIAAHBYAAAAAAAAkGAAIAAAAACwYACAAAMAAABAAAAAAQAAAEAQAAACAAAAUCAAAAIAAABQMAAAAgAAAFBQAAACAAAAUGAAAAIAAABQgAAAAgAAAFCQAAACAAAAULAAAAIAAABQwAAAAAAAAGDwAAACAAAQUSAAAAIAABBRQAAAAgAAIFGAAAACAAAgUcAAAAIAADBSgAAAAgAAQFMAAAAAAAEAYAAAEAAAAPBgCAAAAAAA4GAEAAAAAADQYAIABBgBcLhwIBAAEBBQAAAAAAAAUAAAAAAAAGBD0AAAAAAAkF/QEAAAAADwX9fwAAAAAVBf3/HwAAAAMFBQAAAAAABwR9AAAAAAAMBf0PAAAAABIF/f8DAAAAFwX9/38AAAAFBR0AAAAAAAgE/QAAAAAADgX9PwAAAAAUBf3/DwAAAAIFAQAAABAABwR9AAAAAAALBf0HAAAAABEF/f8BAAAAFgX9/z8AAAAEBQ0AAAAQAAgE/QAAAAAADQX9HwAAAAATBf3/BwAAAAEFAQAAABAABgQ9AAAAAAAKBf0DAAAAABAF/f8AAAAAHAX9//8PAAAbBf3//wcAABoF/f//AwAAGQX9//8BAAAYBf3//wBBkBkLhgQBAAEBBgAAAAAAAAYDAAAAAAAABAQAAAAgAAAFBQAAAAAAAAUGAAAAAAAABQgAAAAAAAAFCQAAAAAAAAULAAAAAAAABg0AAAAAAAAGEAAAAAAAAAYTAAAAAAAABhYAAAAAAAAGGQAAAAAAAAYcAAAAAAAABh8AAAAAAAAGIgAAAAAAAQYlAAAAAAABBikAAAAAAAIGLwAAAAAAAwY7AAAAAAAEBlMAAAAAAAcGgwAAAAAACQYDAgAAEAAABAQAAAAAAAAEBQAAACAAAAUGAAAAAAAABQcAAAAgAAAFCQAAAAAAAAUKAAAAAAAABgwAAAAAAAAGDwAAAAAAAAYSAAAAAAAABhUAAAAAAAAGGAAAAAAAAAYbAAAAAAAABh4AAAAAAAAGIQAAAAAAAQYjAAAAAAABBicAAAAAAAIGKwAAAAAAAwYzAAAAAAAEBkMAAAAAAAUGYwAAAAAACAYDAQAAIAAABAQAAAAwAAAEBAAAABAAAAQFAAAAIAAABQcAAAAgAAAFCAAAACAAAAUKAAAAIAAABQsAAAAAAAAGDgAAAAAAAAYRAAAAAAAABhQAAAAAAAAGFwAAAAAAAAYaAAAAAAAABh0AAAAAAAAGIAAAAAAAEAYDAAEAAAAPBgOAAAAAAA4GA0AAAAAADQYDIAAAAAAMBgMQAAAAAAsGAwgAAAAACgYDBABBpB0L2QEBAAAAAwAAAAcAAAAPAAAAHwAAAD8AAAB/AAAA/wAAAP8BAAD/AwAA/wcAAP8PAAD/HwAA/z8AAP9/AAD//wAA//8BAP//AwD//wcA//8PAP//HwD//z8A//9/AP///wD///8B////A////wf///8P////H////z////9/AAAAAAEAAAACAAAABAAAAAAAAAACAAAABAAAAAgAAAAAAAAAAQAAAAIAAAABAAAABAAAAAQAAAAEAAAABAAAAAgAAAAIAAAACAAAAAcAAAAIAAAACQAAAAoAAAALAEGgIAsDwBBQ",nT=new WeakMap;let iT,rT=0;class sT extends jl{constructor(e){super(e),this.transcoderPath="",this.transcoderBinary=null,this.transcoderPending=null,this.workerPool=new RC,this.workerSourceURL="",this.workerConfig=null,"undefined"!=typeof MSC_TRANSCODER&&console.warn('THREE.KTX2Loader: Please update to latest "basis_transcoder". "msc_basis_transcoder" is no longer supported in three.js r125+.')}setTranscoderPath(e){return this.transcoderPath=e,this}setWorkerLimit(e){return this.workerPool.setWorkerLimit(e),this}async detectSupportAsync(e){return this.workerConfig={astcSupported:await e.hasFeatureAsync("texture-compression-astc"),astcHDRSupported:!1,etc1Supported:await e.hasFeatureAsync("texture-compression-etc1"),etc2Supported:await e.hasFeatureAsync("texture-compression-etc2"),dxtSupported:await e.hasFeatureAsync("texture-compression-bc"),bptcSupported:await e.hasFeatureAsync("texture-compression-bptc"),pvrtcSupported:await e.hasFeatureAsync("texture-compression-pvrtc")},this}detectSupport(e){return!0===e.isWebGPURenderer?this.workerConfig={astcSupported:e.hasFeature("texture-compression-astc"),astcHDRSupported:!1,etc1Supported:e.hasFeature("texture-compression-etc1"),etc2Supported:e.hasFeature("texture-compression-etc2"),dxtSupported:e.hasFeature("texture-compression-bc"),bptcSupported:e.hasFeature("texture-compression-bptc"),pvrtcSupported:e.hasFeature("texture-compression-pvrtc")}:this.workerConfig={astcSupported:e.extensions.has("WEBGL_compressed_texture_astc"),astcHDRSupported:e.extensions.has("WEBGL_compressed_texture_astc")&&e.extensions.get("WEBGL_compressed_texture_astc").getSupportedProfiles().includes("hdr"),etc1Supported:e.extensions.has("WEBGL_compressed_texture_etc1"),etc2Supported:e.extensions.has("WEBGL_compressed_texture_etc"),dxtSupported:e.extensions.has("WEBGL_compressed_texture_s3tc"),bptcSupported:e.extensions.has("EXT_texture_compression_bptc"),pvrtcSupported:e.extensions.has("WEBGL_compressed_texture_pvrtc")||e.extensions.has("WEBKIT_WEBGL_compressed_texture_pvrtc")},this}init(){if(!this.transcoderPending){const e=new Yl(this.manager);e.setPath(this.transcoderPath),e.setWithCredentials(this.withCredentials);const t=e.loadAsync("basis_transcoder.js"),n=new Yl(this.manager);n.setPath(this.transcoderPath),n.setResponseType("arraybuffer"),n.setWithCredentials(this.withCredentials);const i=n.loadAsync("basis_transcoder.wasm");this.transcoderPending=Promise.all([t,i]).then((e=>{let[t,n]=e;const i=sT.BasisWorker.toString(),r=["/* constants */","let _EngineFormat = "+JSON.stringify(sT.EngineFormat),"let _EngineType = "+JSON.stringify(sT.EngineType),"let _TranscoderFormat = "+JSON.stringify(sT.TranscoderFormat),"let _BasisFormat = "+JSON.stringify(sT.BasisFormat),"/* basis_transcoder.js */",t,"/* worker */",i.substring(i.indexOf("{")+1,i.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([r])),this.transcoderBinary=n,this.workerPool.setWorkerCreator((()=>{const e=new Worker(this.workerSourceURL),t=this.transcoderBinary.slice(0);return e.postMessage({type:"init",config:this.workerConfig,transcoderBinary:t},[t]),e}))})),rT>0&&console.warn("THREE.KTX2Loader: Multiple active KTX2 loaders may cause performance issues. Use a single KTX2Loader instance, or call .dispose() on old instances."),rT++}return this.transcoderPending}load(e,t,n,i){if(null===this.workerConfig)throw new Error("THREE.KTX2Loader: Missing initialization with `.detectSupport( renderer )`.");const r=new Yl(this.manager);r.setResponseType("arraybuffer"),r.setWithCredentials(this.withCredentials),r.load(e,(e=>{this.parse(e,t,i)}),n,i)}parse(e,t,n){if(null===this.workerConfig)throw new Error("THREE.KTX2Loader: Missing initialization with `.detectSupport( renderer )`.");if(nT.has(e))return nT.get(e).promise.then(t).catch(n);this._createTexture(e).then((e=>t?t(e):null)).catch(n)}_createTextureFrom(e,t){const{type:n,error:i,data:{faces:r,width:s,height:a,format:o,type:l,dfdFlags:c}}=e;if("error"===n)return Promise.reject(i);let h;if(6===t.faceCount)h=new ml(r,o,l);else{const e=r[0].mipmaps;h=t.layerCount>1?new fl(e,s,a,t.layerCount,o,l):new pl(e,s,a,o,l)}return h.minFilter=1===r[0].mipmaps.length?W:X,h.magFilter=W,h.generateMipmaps=!1,h.needsUpdate=!0,h.colorSpace=cT(t),h.premultiplyAlpha=!!(1&c),h}async _createTexture(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const n=function(e){const t=new Uint8Array(e.buffer,e.byteOffset,YC.length);if(t[0]!==YC[0]||t[1]!==YC[1]||t[2]!==YC[2]||t[3]!==YC[3]||t[4]!==YC[4]||t[5]!==YC[5]||t[6]!==YC[6]||t[7]!==YC[7]||t[8]!==YC[8]||t[9]!==YC[9]||t[10]!==YC[10]||t[11]!==YC[11])throw new Error("Missing KTX 2.0 identifier.");const n=new qC,i=17*Uint32Array.BYTES_PER_ELEMENT,r=new WC(e,YC.length,i,!0);n.vkFormat=r._nextUint32(),n.typeSize=r._nextUint32(),n.pixelWidth=r._nextUint32(),n.pixelHeight=r._nextUint32(),n.pixelDepth=r._nextUint32(),n.layerCount=r._nextUint32(),n.faceCount=r._nextUint32();const s=r._nextUint32();n.supercompressionScheme=r._nextUint32();const a=r._nextUint32(),o=r._nextUint32(),l=r._nextUint32(),c=r._nextUint32(),h=r._nextUint64(),u=r._nextUint64(),d=new WC(e,YC.length+i,3*s*8,!0);for(let t=0;t<s;t++)n.levels.push({levelData:new Uint8Array(e.buffer,e.byteOffset+d._nextUint64(),d._nextUint64()),uncompressedByteLength:d._nextUint64()});const p=new WC(e,a,o,!0),f={vendorId:p._skip(4)._nextUint16(),descriptorType:p._nextUint16(),versionNumber:p._nextUint16(),descriptorBlockSize:p._nextUint16(),colorModel:p._nextUint8(),colorPrimaries:p._nextUint8(),transferFunction:p._nextUint8(),flags:p._nextUint8(),texelBlockDimension:[p._nextUint8(),p._nextUint8(),p._nextUint8(),p._nextUint8()],bytesPlane:[p._nextUint8(),p._nextUint8(),p._nextUint8(),p._nextUint8(),p._nextUint8(),p._nextUint8(),p._nextUint8(),p._nextUint8()],samples:[]},m=(f.descriptorBlockSize/4-6)/4;for(let e=0;e<m;e++){const t={bitOffset:p._nextUint16(),bitLength:p._nextUint8(),channelType:p._nextUint8(),samplePosition:[p._nextUint8(),p._nextUint8(),p._nextUint8(),p._nextUint8()],sampleLower:-1/0,sampleUpper:1/0};64&t.channelType?(t.sampleLower=p._nextInt32(),t.sampleUpper=p._nextInt32()):(t.sampleLower=p._nextUint32(),t.sampleUpper=p._nextUint32()),f.samples[e]=t}n.dataFormatDescriptor.length=0,n.dataFormatDescriptor.push(f);const g=new WC(e,l,c,!0);for(;g._offset<c;){const e=g._nextUint32(),t=g._scan(e),i=XC(t);if(n.keyValue[i]=g._nextUint8Array(e-t.byteLength-1),i.match(/^ktx/i)){const e=XC(n.keyValue[i]);n.keyValue[i]=e.substring(0,e.lastIndexOf("\0"))}g._skip(e%4?4-e%4:0)}if(u<=0)return n;const A=new WC(e,h,u,!0),y=A._nextUint16(),v=A._nextUint16(),_=A._nextUint32(),x=A._nextUint32(),E=A._nextUint32(),b=A._nextUint32(),w=[];for(let e=0;e<s;e++)w.push({imageFlags:A._nextUint32(),rgbSliceByteOffset:A._nextUint32(),rgbSliceByteLength:A._nextUint32(),alphaSliceByteOffset:A._nextUint32(),alphaSliceByteLength:A._nextUint32()});const M=h+A._offset,S=M+_,C=S+x,T=new Uint8Array(e.buffer,e.byteOffset+M,_),I=new Uint8Array(e.buffer,e.byteOffset+S,x),R=new Uint8Array(e.buffer,e.byteOffset+C,E),B=new Uint8Array(e.buffer,e.byteOffset+(C+E),b);return n.globalData={endpointCount:y,selectorCount:v,imageDescs:w,endpointsData:T,selectorsData:I,tablesData:R,extendedData:B},n}(new Uint8Array(e)),i=n.vkFormat===jC&&167===n.dataFormatDescriptor[0].colorModel;if(0!==n.vkFormat&&(!i||this.workerConfig.astcHDRSupported))return async function(e){const{vkFormat:t}=e;if(void 0===oT[t])throw new Error("THREE.KTX2Loader: Unsupported vkFormat.");let n;2===e.supercompressionScheme&&(iT||(iT=new Promise((async e=>{const t=new eT;await t.init(),e(t)}))),n=await iT);const i=[];for(let r=0;r<e.levels.length;r++){const s=Math.max(1,e.pixelWidth>>r),a=Math.max(1,e.pixelHeight>>r),o=e.pixelDepth?Math.max(1,e.pixelDepth>>r):0,l=e.levels[r];let c,h;if(0===e.supercompressionScheme)c=l.levelData;else{if(2!==e.supercompressionScheme)throw new Error("THREE.KTX2Loader: Unsupported supercompressionScheme.");c=n.decode(l.levelData,l.uncompressedByteLength)}h=lT[t]===ee?new Float32Array(c.buffer,c.byteOffset,c.byteLength/Float32Array.BYTES_PER_ELEMENT):lT[t]===te?new Uint16Array(c.buffer,c.byteOffset,c.byteLength/Uint16Array.BYTES_PER_ELEMENT):c,i.push({data:h,width:s,height:a,depth:o})}let r;if(aT.has(oT[t]))r=0===e.pixelDepth?new Po(i[0].data,e.pixelWidth,e.pixelHeight):new nn(i[0].data,e.pixelWidth,e.pixelHeight,e.pixelDepth);else{if(e.pixelDepth>0)throw new Error("THREE.KTX2Loader: Unsupported pixelDepth.");r=new pl(i,e.pixelWidth,e.pixelHeight)}return r.mipmaps=i,r.type=lT[t],r.format=oT[t],r.colorSpace=cT(e),r.needsUpdate=!0,Promise.resolve(r)}(n);const r=this.init().then((()=>this.workerPool.postMessage({type:"transcode",buffer:e,taskConfig:t},[e]))).then((e=>this._createTextureFrom(e.data,n)));return nT.set(e,{promise:r}),r}dispose(){return this.workerPool.dispose(),this.workerSourceURL&&URL.revokeObjectURL(this.workerSourceURL),rT--,this}}sT.BasisFormat={ETC1S:0,UASTC:1,UASTC_HDR:2},sT.TranscoderFormat={ETC1:0,ETC2:1,BC1:2,BC3:3,BC4:4,BC5:5,BC7_M6_OPAQUE_ONLY:6,BC7_M5:7,PVRTC1_4_RGB:8,PVRTC1_4_RGBA:9,ASTC_4x4:10,ATC_RGB:11,ATC_RGBA_INTERPOLATED_ALPHA:12,RGBA32:13,RGB565:14,BGR565:15,RGBA4444:16,BC6H:22,RGB_HALF:24,RGBA_HALF:25},sT.EngineFormat={RGBAFormat:ae,RGBA_ASTC_4x4_Format:Ce,RGB_BPTC_UNSIGNED_Format:He,RGBA_BPTC_Format:ze,RGBA_ETC2_EAC_Format:Se,RGBA_PVRTC_4BPPV1_Format:Ee,RGBA_S3TC_DXT5_Format:ve,RGB_ETC1_Format:we,RGB_ETC2_Format:Me,RGB_PVRTC_4BPPV1_Format:_e,RGBA_S3TC_DXT1_Format:Ae},sT.EngineType={UnsignedByteType:K,HalfFloatType:te,FloatType:ee},sT.BasisWorker=function(){let e,t,n;const i=_EngineFormat,r=_EngineType,s=_TranscoderFormat,a=_BasisFormat;self.addEventListener("message",(function(i){const s=i.data;switch(s.type){case"init":e=s.config,o=s.transcoderBinary,t=new Promise((e=>{n={wasmBinary:o,onRuntimeInitialized:e},BASIS(n)})).then((()=>{n.initializeBasis(),void 0===n.KTX2File&&console.warn("THREE.KTX2Loader: Please update Basis Universal transcoder.")}));break;case"transcode":t.then((()=>{try{const{faces:t,buffers:i,width:o,height:u,hasAlpha:d,format:p,type:f,dfdFlags:m}=function(t){const i=new n.KTX2File(new Uint8Array(t));function s(){i.close(),i.delete()}if(!i.isValid())throw s(),new Error("THREE.KTX2Loader:\tInvalid or unsupported .ktx2 file");let o;if(i.isUASTC())o=a.UASTC;else if(i.isETC1S())o=a.ETC1S;else{if(!i.isHDR())throw new Error("THREE.KTX2Loader: Unknown Basis encoding");o=a.UASTC_HDR}const u=i.getWidth(),d=i.getHeight(),p=i.getLayers()||1,f=i.getLevels(),m=i.getFaces(),g=i.getHasAlpha(),A=i.getDFDFlags(),{transcoderFormat:y,engineFormat:v,engineType:_}=function(t,n,i,r){const s=l[t];for(let a=0;a<s.length;a++){const o=s[a];if((!o.if||e[o.if])&&(o.basisFormat.includes(t)&&!(r&&o.transcoderFormat.length<2)&&(!o.needsPowerOfTwo||c(n)&&c(i))))return{transcoderFormat:o.transcoderFormat[r?1:0],engineFormat:o.engineFormat[r?1:0],engineType:o.engineType[0]}}throw new Error("THREE.KTX2Loader: Failed to identify transcoding target.")}(o,u,d,g);if(!u||!d||!f)throw s(),new Error("THREE.KTX2Loader:\tInvalid texture");if(!i.startTranscoding())throw s(),new Error("THREE.KTX2Loader: .startTranscoding failed");const x=[],E=[];for(let e=0;e<m;e++){const t=[];for(let n=0;n<f;n++){const a=[];let o,l;for(let t=0;t<p;t++){const c=i.getImageLevelInfo(n,t,e);0!==e||0!==n||0!==t||c.origWidth%4==0&&c.origHeight%4==0||console.warn("THREE.KTX2Loader: ETC1S and UASTC textures should use multiple-of-four dimensions."),f>1?(o=c.origWidth,l=c.origHeight):(o=c.width,l=c.height);let h=new Uint8Array(i.getImageTranscodedSizeInBytes(n,t,0,y));const u=i.transcodeImage(h,n,t,e,y,0,-1,-1);if(_===r.HalfFloatType&&(h=new Uint16Array(h.buffer,h.byteOffset,h.byteLength/Uint16Array.BYTES_PER_ELEMENT)),!u)throw s(),new Error("THREE.KTX2Loader: .transcodeImage failed.");a.push(h)}const c=h(a);t.push({data:c,width:o,height:l}),E.push(c.buffer)}x.push({mipmaps:t,width:u,height:d,format:v,type:_})}return s(),{faces:x,buffers:E,width:u,height:d,hasAlpha:g,dfdFlags:A,format:v,type:_}}(s.buffer);self.postMessage({type:"transcode",id:s.id,data:{faces:t,width:o,height:u,hasAlpha:d,format:p,type:f,dfdFlags:m}},i)}catch(e){console.error(e),self.postMessage({type:"error",id:s.id,error:e.message})}}))}var o}));const o=[{if:"astcSupported",basisFormat:[a.UASTC],transcoderFormat:[s.ASTC_4x4,s.ASTC_4x4],engineFormat:[i.RGBA_ASTC_4x4_Format,i.RGBA_ASTC_4x4_Format],engineType:[r.UnsignedByteType],priorityETC1S:1/0,priorityUASTC:1,needsPowerOfTwo:!1},{if:"bptcSupported",basisFormat:[a.ETC1S,a.UASTC],transcoderFormat:[s.BC7_M5,s.BC7_M5],engineFormat:[i.RGBA_BPTC_Format,i.RGBA_BPTC_Format],engineType:[r.UnsignedByteType],priorityETC1S:3,priorityUASTC:2,needsPowerOfTwo:!1},{if:"dxtSupported",basisFormat:[a.ETC1S,a.UASTC],transcoderFormat:[s.BC1,s.BC3],engineFormat:[i.RGBA_S3TC_DXT1_Format,i.RGBA_S3TC_DXT5_Format],engineType:[r.UnsignedByteType],priorityETC1S:4,priorityUASTC:5,needsPowerOfTwo:!1},{if:"etc2Supported",basisFormat:[a.ETC1S,a.UASTC],transcoderFormat:[s.ETC1,s.ETC2],engineFormat:[i.RGB_ETC2_Format,i.RGBA_ETC2_EAC_Format],engineType:[r.UnsignedByteType],priorityETC1S:1,priorityUASTC:3,needsPowerOfTwo:!1},{if:"etc1Supported",basisFormat:[a.ETC1S,a.UASTC],transcoderFormat:[s.ETC1],engineFormat:[i.RGB_ETC1_Format],engineType:[r.UnsignedByteType],priorityETC1S:2,priorityUASTC:4,needsPowerOfTwo:!1},{if:"pvrtcSupported",basisFormat:[a.ETC1S,a.UASTC],transcoderFormat:[s.PVRTC1_4_RGB,s.PVRTC1_4_RGBA],engineFormat:[i.RGB_PVRTC_4BPPV1_Format,i.RGBA_PVRTC_4BPPV1_Format],engineType:[r.UnsignedByteType],priorityETC1S:5,priorityUASTC:6,needsPowerOfTwo:!0},{if:"bptcSupported",basisFormat:[a.UASTC_HDR],transcoderFormat:[s.BC6H],engineFormat:[i.RGB_BPTC_UNSIGNED_Format],engineType:[r.HalfFloatType],priorityHDR:1,needsPowerOfTwo:!1},{basisFormat:[a.ETC1S,a.UASTC],transcoderFormat:[s.RGBA32,s.RGBA32],engineFormat:[i.RGBAFormat,i.RGBAFormat],engineType:[r.UnsignedByteType,r.UnsignedByteType],priorityETC1S:100,priorityUASTC:100,needsPowerOfTwo:!1},{basisFormat:[a.UASTC_HDR],transcoderFormat:[s.RGBA_HALF],engineFormat:[i.RGBAFormat],engineType:[r.HalfFloatType],priorityHDR:100,needsPowerOfTwo:!1}],l={[a.ETC1S]:o.filter((e=>e.basisFormat.includes(a.ETC1S))).sort(((e,t)=>e.priorityUASTC-t.priorityUASTC)),[a.UASTC]:o.filter((e=>e.basisFormat.includes(a.UASTC))).sort(((e,t)=>e.priorityUASTC-t.priorityUASTC)),[a.UASTC_HDR]:o.filter((e=>e.basisFormat.includes(a.UASTC_HDR))).sort(((e,t)=>e.priorityHDR-t.priorityHDR))};function c(e){return e<=2||!(e&e-1)&&0!==e}function h(e){if(1===e.length)return e[0];let t=0;for(let n=0;n<e.length;n++)t+=e[n].byteLength;const n=new Uint8Array(t);let i=0;for(let t=0;t<e.length;t++){const r=e[t];n.set(r,i),i+=r.byteLength}return n}};const aT=new Set([ae,pe,ue]),oT={[GC]:ae,[kC]:ae,[NC]:ae,[UC]:ae,[zC]:pe,[FC]:pe,[PC]:pe,[DC]:pe,[QC]:ue,[OC]:ue,[LC]:ue,[BC]:ue,[jC]:Ce,[VC]:Be,[HC]:Be},lT={[GC]:ee,[kC]:te,[NC]:K,[UC]:K,[zC]:ee,[FC]:te,[PC]:K,[DC]:K,[QC]:ee,[OC]:te,[LC]:K,[BC]:K,[jC]:te,[VC]:K,[HC]:K};function cT(e){const t=e.dataFormatDescriptor[0];return 1===t.colorPrimaries?2===t.transferFunction?et:tt:10===t.colorPrimaries?2===t.transferFunction?"display-p3":"display-p3-linear":(0===t.colorPrimaries||console.warn(`THREE.KTX2Loader: Unsupported color primaries, "${t.colorPrimaries}"`),Ze)}const hT={SPECTRAL:[[0,new Ci(.3686,.3098,.6353)],[.1,new Ci(.1961,.5333,.7412)],[.2,new Ci(.4,.7608,.6471)],[.3,new Ci(.6706,.8667,.6431)],[.4,new Ci(.902,.9608,.5961)],[.5,new Ci(1,1,.749)],[.6,new Ci(.9961,.8784,.5451)],[.7,new Ci(.9922,.6824,.3804)],[.8,new Ci(.9569,.4275,.2627)],[.9,new Ci(.8353,.2431,.3098)],[1,new Ci(.6196,.0039,.2588)]],PLASMA:[[0,new Ci(.241,.015,.61)],[.1,new Ci(.387,.001,.654)],[.2,new Ci(.524,.025,.653)],[.3,new Ci(.651,.125,.596)],[.4,new Ci(.752,.227,.513)],[.5,new Ci(.837,.329,.431)],[.6,new Ci(.907,.435,.353)],[.7,new Ci(.963,.554,.272)],[.8,new Ci(.992,.681,.195)],[.9,new Ci(.987,.822,.144)],[1,new Ci(.94,.975,.131)]],YELLOW_GREEN:[[0,new Ci(.1647,.2824,.3451)],[.1,new Ci(.1338,.3555,.4227)],[.2,new Ci(.061,.4319,.4864)],[.3,new Ci(0,.5099,.5319)],[.4,new Ci(0,.5881,.5569)],[.5,new Ci(.137,.665,.5614)],[.6,new Ci(.2906,.7395,.5477)],[.7,new Ci(.4453,.8099,.5201)],[.8,new Ci(.6102,.8748,.485)],[.9,new Ci(.7883,.9323,.4514)],[1,new Ci(.9804,.9804,.4314)]],VIRIDIS:[[0,new Ci(.267,.005,.329)],[.1,new Ci(.283,.141,.458)],[.2,new Ci(.254,.265,.53)],[.3,new Ci(.207,.372,.553)],[.4,new Ci(.164,.471,.558)],[.5,new Ci(.128,.567,.551)],[.6,new Ci(.135,.659,.518)],[.7,new Ci(.267,.749,.441)],[.8,new Ci(.478,.821,.318)],[.9,new Ci(.741,.873,.15)],[1,new Ci(.993,.906,.144)]],INFERNO:[[0,new Ci(.077,.042,.206)],[.1,new Ci(.225,.036,.388)],[.2,new Ci(.373,.074,.432)],[.3,new Ci(.522,.128,.42)],[.4,new Ci(.665,.182,.37)],[.5,new Ci(.797,.255,.287)],[.6,new Ci(.902,.364,.184)],[.7,new Ci(.969,.516,.063)],[.8,new Ci(.988,.683,.072)],[.9,new Ci(.961,.859,.298)],[1,new Ci(.988,.998,.645)]],GRAYSCALE:[[0,new Ci(0,0,0)],[1,new Ci(1,1,1)]],TURBO:[[0,new Ci(.18995,.07176,.23217)],[.07,new Ci(.25107,.25237,.63374)],[.13,new Ci(.27628,.42118,.89123)],[.2,new Ci(.25862,.57958,.99876)],[.27,new Ci(.15844,.73551,.92305)],[.33,new Ci(.09267,.86554,.7623)],[.4,new Ci(.19659,.94901,.59466)],[.47,new Ci(.42778,.99419,.38575)],[.53,new Ci(.64362,.98999,.23356)],[.6,new Ci(.80473,.92452,.20459)],[.67,new Ci(.93301,.81236,.22667)],[.73,new Ci(.99314,.67408,.20348)],[.8,new Ci(.9836,.49291,.12849)],[.87,new Ci(.92105,.31489,.05475)],[.93,new Ci(.81608,.18462,.01809)],[1,new Ci(.66449,.08436,.00424)]],RAINBOW:[[0,new Ci(.278,0,.714)],[1/6,new Ci(0,0,1)],[2/6,new Ci(0,1,1)],[.5,new Ci(0,1,0)],[4/6,new Ci(1,1,0)],[5/6,new Ci(1,.64,0)],[1,new Ci(1,0,0)]],CONTOUR:[[0,new Ci(0,0,0)],[.03,new Ci(0,0,0)],[.04,new Ci(1,1,1)],[1,new Ci(1,1,1)]]},uT={COLOR:0,INTENSITY:1,CLASSIFICATION:2,ELEVATION:3,RETURN_NUMBER:4,RETURN_TYPE:5,RETURN_COUNT:6,POINT_SOURCE_ID:7,SCAN_ANGLE:8,NORMAL:9},dT={CIRCLE:0,SQUARE:1},pT={VALUE:0,ATTENUATED:1},fT=new Ci(1,1,1),mT={DEFAULT:{0:{visible:!0,name:"never classified",color:new Ci(.5,.5,.5),opacity:1},1:{visible:!0,name:"unclassified",color:new Ci(.5,.5,.5),opacity:1},2:{visible:!0,name:"ground",color:new Ci(.63,.32,.18),opacity:1},3:{visible:!0,name:"low vegetation",color:new Ci(0,1,0),opacity:1},4:{visible:!0,name:"medium vegetation",color:new Ci(0,.8,0),opacity:1},5:{visible:!0,name:"high vegetation",color:new Ci(0,.6,0),opacity:1},6:{visible:!0,name:"building",color:new Ci(1,.66,0),opacity:1},7:{visible:!0,name:"low point(noise)",color:new Ci(1,0,1),opacity:1},8:{visible:!0,name:"key-point",color:new Ci(1,0,0),opacity:1},9:{visible:!0,name:"water",color:new Ci(0,0,1),opacity:1},10:{visible:!0,name:"rail",color:new Ci(.8,.8,1),opacity:1},11:{visible:!0,name:"road Surface",color:new Ci(.4,.4,.7),opacity:1},12:{visible:!0,name:"overlap",color:new Ci(1,1,0),opacity:1},DEFAULT:{visible:!0,name:"default",color:new Ci(.3,.6,.6),opacity:1}}},gT={DEFAULT:{0:{visible:!0,name:"0",color:new Ci("rgb(67, 99, 216)"),opacity:1},1:{visible:!0,name:"1",color:new Ci("rgb(60, 180, 75);"),opacity:1},2:{visible:!0,name:"2",color:new Ci("rgb(255, 255, 25)"),opacity:1},3:{visible:!0,name:"3",color:new Ci("rgb(145, 30, 180)"),opacity:1},4:{visible:!0,name:"4",color:new Ci("rgb(245, 130, 49)"),opacity:1},5:{visible:!0,name:"5",color:new Ci("rgb(230, 25, 75)"),opacity:1},6:{visible:!0,name:"6",color:new Ci("rgb(66, 212, 244)"),opacity:1},7:{visible:!0,name:"7",color:new Ci("rgb(240, 50, 230)"),opacity:1},DEFAULT:{visible:!0,name:"default",color:fT,opacity:1}}};function AT(e,t,n){let i;const r=t.image.data,s=t.image.width;n||(n=Object.keys(e).length);for(let t=0;t<s;t++){let s,a,o=!0;e[t]?(s=e[t].color,o=e[t].visible,a=e[t].opacity):e[t%n]?(s=e[t%n].color,o=e[t%n].visible,a=e[t%n].opacity):e.DEFAULT?(s=e.DEFAULT.color,o=e.DEFAULT.visible,a=e.DEFAULT.opacity):(s=fT,a=1);const l=4*t;r[l+0]=parseInt(255*s.r,10),r[l+1]=parseInt(255*s.g,10),r[l+2]=parseInt(255*s.b,10),r[l+3]=o?parseInt(255*a,10):0,i=i||a<1||!o}return t.needsUpdate=!0,i}const yT=class extends hr{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const t={...e.gradient,...hT};e.gradient=Object.values(t)[0];const{intensityRange:n=new It(1,65536),elevationRange:i=new It(0,1e3),angleRange:r=new It(-90,90),classificationScheme:s=mT.DEFAULT,discreteScheme:a=gT.DEFAULT,size:o=1,mode:l=uT.COLOR,shape:c=dT.CIRCLE,sizeMode:h=pT.ATTENUATED,minAttenuatedSize:u=3,maxAttenuatedSize:d=10,gradient:p,scale:f=.025/Math.tan(.5),...m}=e;super({...m,fog:!0,precision:"highp",vertexColors:!0}),this.uniforms=cr.merge([Br.points,Br.fog]),this.vertexShader="#include <common>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvarying vec4 vColor; // color_pars_vertex\n\n#ifdef USE_POINTS_UV\n    varying vec2 vUv;\n    uniform mat3 uvTransform;\n#endif\n\n#define NB_CLASS 8.\n\nuniform float size;\nuniform float scale;\n\nuniform bool picking;\nuniform int mode;\n\nuniform vec2 elevationRange;\nuniform vec2 intensityRange;\nuniform vec2 angleRange;\n\nuniform sampler2D classificationTexture;\nuniform sampler2D discreteTexture;\nuniform sampler2D gradientTexture;\nuniform int sizeMode;\nuniform float minAttenuatedSize;\nuniform float maxAttenuatedSize;\n\nattribute vec4 unique_id;\nattribute float intensity;\nattribute float classification;\nattribute float pointSourceID;\n\nattribute float returnNumber;\nattribute float numberOfReturns;\nattribute float scanAngle;\n\nvoid main() {\n    vColor = vec4(1.0);\n    if (picking) {\n        vColor = unique_id;\n    } else {\n        if (mode == PNTS_MODE_CLASSIFICATION) {\n            vec2 uv = vec2(classification/255., 0.5);\n            vColor = texture2D(classificationTexture, uv);\n        } else if (mode == PNTS_MODE_NORMAL) {\n            vColor.rgb = abs(normal);\n        } else if (mode == PNTS_MODE_COLOR) {\n#if defined(USE_COLOR)\n            vColor.rgb = color.rgb;\n#elif defined(USE_COLOR_ALPHA)\n            vColor = color;\n#endif\n        } else if (mode == PNTS_MODE_RETURN_NUMBER) {\n            vec2 uv = vec2(returnNumber/255., 0.5);\n            vColor = texture2D(discreteTexture, uv);\n        } else if (mode == PNTS_MODE_RETURN_TYPE) {\n            float returnType;\n            if (returnNumber > numberOfReturns) {\n                returnType = 4.;\n            } else if (returnNumber == 1.) {\n                if (numberOfReturns == 1.) {\n                    // single\n                    returnType = 0.;\n                } else {\n                    // first\n                    returnType = 1.;\n                }\n            } else {\n                if (returnNumber == numberOfReturns) {\n                    // last\n                    returnType = 3.;\n                } else {\n                    // intermediate\n                    returnType = 2.;\n                }\n            }\n            vec2 uv = vec2(returnType/255., 0.5);\n            vColor = texture2D(discreteTexture, uv);\n        } else if (mode == PNTS_MODE_RETURN_COUNT) {\n            vec2 uv = vec2(numberOfReturns/255., 0.5);\n            vColor = texture2D(discreteTexture, uv);\n        } else if (mode == PNTS_MODE_POINT_SOURCE_ID) {\n            vec2 uv = vec2(mod(pointSourceID, NB_CLASS)/255., 0.5);\n            vColor = texture2D(discreteTexture, uv);\n        } else if (mode == PNTS_MODE_SCAN_ANGLE) {\n            float i = (scanAngle - angleRange.x) / (angleRange.y - angleRange.x);\n            vec2 uv = vec2(i, (1. - i));\n            vColor = texture2D(gradientTexture, uv);\n        } else if (mode == PNTS_MODE_INTENSITY) {\n            float i = (intensity - intensityRange.x) / (intensityRange.y - intensityRange.x);\n            vec2 uv = vec2(i, (1. - i));\n            vColor = texture2D(gradientTexture, uv);\n        } else if (mode == PNTS_MODE_ELEVATION) {\n            float z = (modelMatrix * vec4(position, 1.0)).z;\n            float i = (z - elevationRange.x) / (elevationRange.y - elevationRange.x);\n            vec2 uv = vec2(i, (1. - i));\n            vColor = texture2D(gradientTexture, uv);\n        }\n    }\n\n#define USE_COLOR_ALPHA\n#include <morphcolor_vertex>\n#include <begin_vertex>\n#include <morphtarget_vertex>\n#include <project_vertex>\n\n    gl_PointSize = size;\n\n    if (sizeMode == PNTS_SIZE_MODE_ATTENUATED) {\n        bool isPerspective = isPerspectiveMatrix(projectionMatrix);\n\n        if (isPerspective) {\n            gl_PointSize *= scale / -mvPosition.z;\n            gl_PointSize = clamp(gl_PointSize, minAttenuatedSize, maxAttenuatedSize);\n        }\n    }\n\n#include <logdepthbuf_vertex>\n#include <clipping_planes_vertex>\n#include <worldpos_vertex>\n#include <fog_vertex>\n}\n",this.fragmentShader="#define USE_COLOR_ALPHA\n\n#include <color_pars_fragment>\n#include <map_particle_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <alphahash_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n\nuniform vec3 diffuse;\nuniform float opacity;\n\nuniform bool picking;\nuniform int shape;\n\nvoid main() {\n\n// Early discard (clipping planes and shape)\n#include <clipping_planes_fragment>\n    if (shape == PNTS_SHAPE_CIRCLE) {\n        //circular rendering in glsl\n        if ((length(gl_PointCoord - 0.5) > 0.5)) {\n            discard;\n        }\n    }\n\n#include <logdepthbuf_fragment>\n\n    vec4 diffuseColor = vec4(diffuse, opacity);\n#include <map_particle_fragment>\n#include <color_fragment>\n\n#include <alphatest_fragment>\n#include <alphahash_fragment>\n\n    vec3 outgoingLight = diffuseColor.rgb;\n#include <opaque_fragment> // gl_FragColor\n#include <tonemapping_fragment>\n#include <fog_fragment>\n#include <premultiplied_alpha_fragment>\n\n}\n",this.userData.needTransparency={},this.gradients=t,this.gradientTexture=new gl,$p.setDefineMapping(this,"PNTS_MODE",uT),$p.setDefineMapping(this,"PNTS_SHAPE",dT),$p.setDefineMapping(this,"PNTS_SIZE_MODE",pT),this.size=o,$p.setUniformProperty(this,"mode",l),$p.setUniformProperty(this,"shape",c),$p.setUniformProperty(this,"picking",!1),$p.setUniformProperty(this,"opacity",this.opacity),$p.setUniformProperty(this,"intensityRange",n),$p.setUniformProperty(this,"elevationRange",i),$p.setUniformProperty(this,"angleRange",r),$p.setUniformProperty(this,"sizeMode",h),$p.setUniformProperty(this,"scale",f),$p.setUniformProperty(this,"minAttenuatedSize",u),$p.setUniformProperty(this,"maxAttenuatedSize",d);const g=new Uint8Array(1024),A=new Po(g,256,1,ae);A.needsUpdate=!0,A.magFilter=V,$p.setUniformProperty(this,"classificationTexture",A);const y=new Uint8Array(1024),v=new Po(y,256,1,ae);v.needsUpdate=!0,v.magFilter=V,$p.setUniformProperty(this,"discreteTexture",v),this.classificationScheme=s,this.discreteScheme=a,this.recomputeClassification(),this.recomputeDiscreteTexture(),this.gradient=p,$p.setUniformProperty(this,"gradientTexture",this.gradientTexture)}copy(e){const t=void 0!==e.userData.needTransparency?e.userData.needTransparency:this.userData.needTransparency;return e.isShaderMaterial?super.copy(e):Ri.prototype.copy.call(this,e),this.color.copy(e.color),this.map=e.map,this.alphaMap=e.alphaMap,this.size=e.size,this.sizeAttenuation=e.sizeAttenuation,this.fog=e.fog,this.userData.needTransparency=t,this}get color(){return this.uniforms.diffuse.value}set color(e){this.uniforms.diffuse.value.copy(e)}get map(){return this.uniforms.map.value}set map(e){this.uniforms.map.value=e,e&&(e.matrixAutoUpdate&&e.updateMatrix(),this.uniforms.uvTransform.value.copy(e.matrix))}get alphaMap(){return this.uniforms.alphaMap.value}set alphaMap(e){this.uniforms.alphaMap.value=e,e&&(e.matrixAutoUpdate&&e.updateMatrix(),this.uniforms.alphaMapTransform.value.copy(e.matrix))}get size(){return this.uniforms.size.value}set size(e){this.uniforms.size.value=e}get sizeAttenuation(){return this.sizeMode!==pT.VALUE}set sizeAttenuation(e){this.sizeMode=e?pT.ATTENUATED:pT.VALUE}recomputeClassification(){const e=AT(this.classificationScheme,this.classificationTexture,256);this.userData.needTransparency[uT.CLASSIFICATION]=e,this.dispatchEvent({type:"material_property_changed",target:this.uniforms})}recomputeDiscreteTexture(){const e=AT(this.discreteScheme,this.discreteTexture);this.userData.needTransparency[uT.RETURN_NUMBER]=e,this.userData.needTransparency[uT.RETURN_TYPE]=e,this.userData.needTransparency[uT.RETURN_COUNT]=e,this.userData.needTransparency[uT.POINT_SOURCE_ID]=e,this.dispatchEvent({type:"material_property_changed",target:this.uniforms})}enablePicking(e){this.picking=e,this.blending=e?o:l}set gradient(e){this.gradientTexture=function(e){const t=64,n=document.createElement("canvas");n.width=t,n.height=t;const i=n.getContext("2d");i.rect(0,0,t,t);const r=i.createLinearGradient(0,0,t,t);for(let t=0;t<e.length;t++){const n=e[t];r.addColorStop(n[0],`#${n[1].getHexString()}`)}i.fillStyle=r,i.fill();const s=new gl(n);return s.needsUpdate=!0,s.minFilter=W,s.wrap=z,s.repeat=2,s}(e)}},vT=new bc,_T={},xT=new class extends jl{constructor(e){super(e),this.legacyGLTFLoader=new PS,this.glTFLoader=new NS}load(e,t,n,i){const r=this;let s;if(""!==this.resourcePath)s=this.resourcePath;else if(""!==this.path){const t=dc.extractUrlBase(e);s=dc.resolveURL(t,this.path)}else s=dc.extractUrlBase(e);this.manager.itemStart(e);const a=t=>{i?i(t):console.error(t),r.manager.itemError(e),r.manager.itemEnd(e)},o=new Yl(this.manager);o.setPath(this.path),o.setResponseType("arraybuffer"),o.setRequestHeader(this.requestHeader),o.setWithCredentials(this.withCredentials),o.load(e,(n=>{try{r.parse(n,s,(n=>{t(n),r.manager.itemEnd(e)}),a)}catch(e){a(e)}}),n,a)}setDRACOLoader(e){this.glTFLoader.setDRACOLoader(e)}setKTX2Loader(e){this.glTFLoader.setKTX2Loader(e)}setMeshoptDecoder(e){this.glTFLoader.setMeshoptDecoder(e)}register(e){this.glTFLoader.register(e)}unregister(e){this.glTFLoader.unregister(e)}parse(e,t,n,i){e&&t?1===new DataView(e,0,20).getUint32(4,!0)?this.legacyGLTFLoader.parse(e,t,n,i):this.glTFLoader.parse(e,t,n,i):i("[iGLTFLoader]: Buffer and path are mandatory to parse a glTF.")}parseAsync(e,t){const n=this;return new Promise(((i,r)=>{n.parse(e,t,i,r)}))}};xT.register((()=>new YM)),xT.register((()=>new xS)),xT.register((()=>new ES));const ET={LOAD_TILE_SET:"load-tile-set",LOAD_MODEL:"load-model",DISPOSE_MODEL:"dispose-model",TILE_VISIBILITY_CHANGE:"tile-visibility-change",TILES_LOAD_START:"tiles-load-start",TILES_LOAD_END:"tiles-load-end"},bT=class extends px{constructor(e,t){const{pntsMode:n=uT.COLOR,pntsShape:i=dT.CIRCLE,classification:r=mT.DEFAULT,pntsSizeMode:s=pT.VALUE,pntsMinAttenuatedSize:a=3,pntsMaxAttenuatedSize:o=10,...l}=t;super(e,new oo,l),this.isOGC3DTilesLayer=!0,this.pntsMode=n,this.pntsShape=i,this.classification=r,this.pntsSizeMode=s,this.pntsMinAttenuatedSize=a,this.pntsMaxAttenuatedSize=o,this.tilesRenderer=new IM(this.source.url),t.source.isOGC3DTilesIonSource?this.tilesRenderer.registerPlugin(new SS({apiToken:t.source.accessToken,assetId:t.source.assetId,autoRefreshToken:!0})):t.source.isOGC3DTilesGoogleSource&&this.tilesRenderer.registerPlugin(new MS({apiToken:t.source.key,autoRefreshToken:!0})),this.tilesRenderer.registerPlugin(new BS),this.tilesRenderer.manager.addHandler(/\.gltf$/,xT),this.object3d.add(this.tilesRenderer.group),this._res=this.addInitializationStep(),this.sseThreshold=this.tilesRenderer.errorTarget,Object.defineProperty(this,"sseThreshold",{get(){return this.tilesRenderer.errorTarget},set(e){this.tilesRenderer.errorTarget=e}}),t.sseThreshold&&(this.sseThreshold=t.sseThreshold)}_setupCacheAndQueues(e){const t=e.id;_T[t]?(this.tilesRenderer.lruCache=_T[t].lruCache,this.tilesRenderer.downloadQueue=_T[t].downloadQueue,this.tilesRenderer.parseQueue=_T[t].parseQueue):(_T[t]={lruCache:this.tilesRenderer.lruCache,downloadQueue:this.tilesRenderer.downloadQueue,parseQueue:this.tilesRenderer.parseQueue},e.addEventListener(iI.DISPOSED,(e=>{delete _T[e.target.id]})))}_setupEvents(){for(const e of Object.values(ET))this.tilesRenderer.addEventListener(e,(e=>{this.dispatchEvent(e)}))}_setup(e){this.tilesRenderer.setCamera(e.camera3D),this.tilesRenderer.setResolutionFromRenderer(e.camera3D,e.renderer);let t=!1;this.tilesRenderer.addEventListener("load-tile-set",(()=>{e.notifyChange(this),t||(t=!0,this._res())})),this.tilesRenderer.addEventListener("load-model",(t=>{const{scene:n}=t;n.traverse((e=>{this._assignFinalMaterial(e),this._assignFinalAttributes(e)})),e.notifyChange(this)})),this._setupCacheAndQueues(e),this._setupEvents(),this.tilesRenderer.update()}_assignFinalMaterial(e){let t=e.material;if(e.isPoints){const e=new yT({mode:this.pntsMode,shape:this.pntsShape,classificationScheme:this.classification,sizeMode:this.pntsSizeMode,minAttenuatedSize:this.pntsMinAttenuatedSize,maxAttenuatedSize:this.pntsMaxAttenuatedSize});e.copy(t),t=e}t&&$x(t,this),e.material=t}_assignFinalAttributes(e){const t=e.geometry,n=e.batchTable;if(e.isPoints){const e=n?.getPropertyArray("Classification");e&&t.setAttribute("classification",new Di(e,1))}}preUpdate(e){return this.scale=e.camera._preSSE,this.tilesRenderer.update(),null}update(){}delete(){this.tilesRenderer.dispose()}async getMetadataFromIntersections(e){if(!e.length)return null;const t=await async function(e){const{point:t,object:n,face:i,faceIndex:r}=e,{meshFeatures:s,structuralMetadata:a}=n.userData,o=new sn;if(i){const e=n.geometry.getAttribute("position"),r=(new Ei).setFromAttributeAndIndices(e,i.a,i.b,i.c);r.a.applyMatrix4(n.matrixWorld),r.b.applyMatrix4(n.matrixWorld),r.c.applyMatrix4(n.matrixWorld),r.getBarycoord(t,o)}else o.set(0,0,0);const{features:l,featureIds:c}=s?await async function(e,t){const{faceIndex:n,barycoord:i}=t;return{features:await e.getFeaturesAsync(n,i),featureIds:e.getFeatureInfo()}}(s,{faceIndex:r,barycoord:o}):{},h=c?.map((e=>e.propertyTable)),u=a?function(e,t){const{index:n,faceIndex:i,barycoord:r,tableIndices:s,features:a}=t,o=[];void 0!==s&&void 0!==a&&e.getPropertyTableData(s,a,o);const l=[];void 0!==n&&e.getPropertyAttributeData(n,l);const c=[];return void 0!==i&&e.getPropertyTextureData(i,r,c),[...o,...c,...l]}(a,{...e,barycoord:o,tableIndices:h,features:l}):[];return u}(e[0]);return t}getC3DTileFeatureFromIntersectsArray(e){if(!e.length)return null;const{face:t,index:n,object:i,instanceId:r}=e[0];let s;if(i.isPoints&&n?s=i.geometry.getAttribute("_BATCHID")?.getX(n)??n:i.isMesh&&t&&(s=i.geometry.getAttribute("_BATCHID")?.getX(t.a)??r),void 0===s)return null;let a=i;for(;!a.batchTable;)a=a.parent;return a.batchTable.getDataFromId(s)}pickObjectsAt(e,t){let n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[];const i=e.camera.camera3D;vT.setFromCamera(e.viewToNormalizedCoords(t),i),vT.near=i.near,vT.far=i.far,vT.firstHitOnly=!0;const r=vT.intersectObject(this.tilesRenderer.group,!0);return r.forEach((e=>{e.layer=this})),n.push(...r),n}attach(){console.warn("[OGC3DTilesLayer]: Attaching / detaching layers is not yet implemented for OGC3DTilesLayer.")}detach(){return console.warn("[OGC3DTilesLayer]: Attaching / detaching layers is not yet implemented for OGC3DTilesLayer."),!0}getObjectToUpdateForAttachedLayers(){return null}forEachTile(e){this.tilesRenderer.traverse((t=>{e(t,t.cached.scene)}))}},wT=(new Nn).makeRotationX(Math.PI/2),MT=(new Nn).makeRotationZ(-Math.PI/2),ST=new TextDecoder;function CT(e){const t=["MODELVIEW","MODELVIEWINVERSETRANSPOSE","PROJECTION","JOINTMATRIX"];if(e.gltfShader){const n=[];for(const t in e.gltfShader.boundUniforms)n.push(t);for(const i of n){const n=e.gltfShader.boundUniforms[i].semantic;t.includes(n)||delete e.gltfShader.boundUniforms[i]}}}const TT={parse(e,t){const n=!0===t.frustumCulled;if(!e)throw new Error("No array buffer provided.");const i=new DataView(e,4);let r=0;const s={};if(s.magic=ST.decode(new Uint8Array(e,0,4)),s.magic){s.version=i.getUint32(r,!0),r+=Uint32Array.BYTES_PER_ELEMENT,s.byteLength=i.getUint32(r,!0),r+=Uint32Array.BYTES_PER_ELEMENT,s.FTJSONLength=i.getUint32(r,!0),r+=Uint32Array.BYTES_PER_ELEMENT,s.FTBinaryLength=i.getUint32(r,!0),r+=Uint32Array.BYTES_PER_ELEMENT,s.BTJSONLength=i.getUint32(r,!0),r+=Uint32Array.BYTES_PER_ELEMENT,s.BTBinaryLength=i.getUint32(r,!0),r+=Uint32Array.BYTES_PER_ELEMENT;const a=r+4,o=[];let l={};const c=new sn;if(s.FTJSONLength>0){const t=a,n=e.slice(t,s.FTJSONLength+t),i=ST.decode(new Uint8Array(n));l=JSON.parse(i),l.RTC_CENTER?c.fromArray(l.RTC_CENTER):c.set(0,0,0)}if(s.FTBinaryLength>0&&console.warn("3D Tiles feature table binary not supported yet."),s.BTJSONLength>0){const n=a+s.FTJSONLength+s.FTBinaryLength,i=e.slice(n,n+s.BTJSONLength+s.BTBinaryLength);o.push(Promise.resolve(new PE(i,s.BTJSONLength,s.BTBinaryLength,l.BATCH_LENGTH,t.registeredExtensions)))}else o.push(Promise.resolve(new PE));const h=a+s.FTJSONLength+s.FTBinaryLength+s.BTJSONLength+s.BTBinaryLength,u=e.slice(h),d=function(e){if(e.frustumCulled=n,e.material){if(t.overrideMaterials){const n=e.material;"object"==typeof t.overrideMaterials&&t.overrideMaterials.isMaterial?e.material=t.overrideMaterials:e.material=new Bi,function(e){const t=function(e){const t=[];return e.alphaMap&&t.push(e.map),e.aoMap&&t.push(e.map),e.bumpMap&&t.push(e.bumpMap),e.displacementMap&&t.push(e.bumpMap),e.emissiveMap&&t.push(e.emissiveMap),e.envMap&&t.push(e.envMap),e.lightMap&&t.push(e.envMap),e.map&&t.push(e.map),e.metalnessMap&&t.push(e.map),e.normalMap&&t.push(e.map),e.roughnessMap&&t.push(e.map),e.specularMap&&t.push(e.specularMap),t}(e);if(Array.isArray(e))for(const t of e)t.dispose();else e.dispose();for(let e=0;e<t.length;e++)t[e].dispose()}(n)}else jp.isLogDepthBufferSupported()&&e.material.isRawShaderMaterial&&!t.doNotPatchMaterial&&(Yp.patchMaterialForLogDepthSupport(e.material),console.warn("glTF shader has been patched to add log depth buffer support"));$x(e.material,t.layer)}};return o.push(xT.parseAsync(u,t).then((e=>{for(const t of e.scenes)t.traverse(CT);var n,i;n=e.scene,(i=t.gltfUpAxis)&&"Y"!==i?"X"===i&&n.applyMatrix4(MT):n.applyMatrix4(wT);const r=jp.isLogDepthBufferSupported()&&!t.doNotPatchMaterial;return(!1===t.frustumCulling||t.overrideMaterials||r||t.layer)&&e.scene.traverse(d),e.scene.position.copy(c),e})).catch((e=>{throw new Error(e)}))),Promise.all(o).then((e=>({gltf:e[1],batchTable:e[0]}))).catch((e=>{throw new Error(e)}))}throw new Error("Invalid b3dm file.")}},IT=new TextDecoder,RT=new TextDecoder;function BT(e,t,n){const i=dc.extractUrlBase(n),r={gltfUpAxis:t.tileset.asset.gltfUpAxis,urlBase:i,overrideMaterials:t.overrideMaterials,doNotPatchMaterial:t.doNotPatchMaterial,registeredExtensions:t.registeredExtensions,layer:t};return TT.parse(e,r).then((e=>({batchTable:e.batchTable,object3d:e.gltf.scene})))}function LT(e,t,n){const i=dc.extractUrlBase(n);return xT.parseAsync(e,i).then((e=>({object3d:e.scene})))}function PT(e,t){return function(e,t){if(!e)throw new Error("No array buffer provided.");const n=new DataView(e);let i=0;const r={};let s={},a={};if(r.magic=IT.decode(new Uint8Array(e,i,4)),i+=4,r.magic){r.version=n.getUint32(i,!0),i+=Uint32Array.BYTES_PER_ELEMENT,r.byteLength=n.getUint32(i,!0),i+=Uint32Array.BYTES_PER_ELEMENT,r.FTJSONLength=n.getUint32(i,!0),i+=Uint32Array.BYTES_PER_ELEMENT,r.FTBinaryLength=n.getUint32(i,!0),i+=Uint32Array.BYTES_PER_ELEMENT,r.BTJSONLength=n.getUint32(i,!0),i+=Uint32Array.BYTES_PER_ELEMENT,r.BTBinaryLength=n.getUint32(i,!0),i+=Uint32Array.BYTES_PER_ELEMENT;let o={};if(r.FTJSONLength>0){const t=i,n=e.slice(t,r.FTJSONLength+t),s=IT.decode(new Uint8Array(n));o=JSON.parse(s)}if(r.FTBinaryLength>0&&(a=function(e,t,n){const i=new ji,r=IT.decode(new Uint8Array(e,t,n)),s=JSON.parse(r);let a;if(s.POINTS_LENGTH&&(a=s.POINTS_LENGTH),s.POSITION){const n=s.POSITION.byteOffset+r.length+t,o=new Float32Array(e,n,3*a);i.setAttribute("position",new Di(o,3))}if(s.RGB){const n=s.RGB.byteOffset+r.length+t,o=new Uint8Array(e,n,3*a);i.setAttribute("color",new Di(o,3,!0))}if(s.POSITION_QUANTIZED)throw new Error("For pnts loader, POSITION_QUANTIZED: not yet managed");if(s.RGBA)throw new Error("For pnts loader, RGBA: not yet managed");if(s.RGB565)throw new Error("For pnts loader, RGB565: not yet managed");if(s.NORMAL)throw new Error("For pnts loader, NORMAL: not yet managed");if(s.NORMAL_OCT16P)throw new Error("For pnts loader, NORMAL_OCT16P: not yet managed");if(s.BATCH_ID)throw new Error("For pnts loader, BATCH_ID: not yet managed");return{geometry:i,offset:s.RTC_CENTER?(new sn).fromArray(s.RTC_CENTER):void 0}}(e,i,r.FTJSONLength)),r.BTJSONLength>0){const n=i+r.FTJSONLength+r.FTBinaryLength,l=e.slice(n,r.BTJSONLength+r.BTBinaryLength+n);s=new PE(l,r.BTJSONLength,r.BTBinaryLength,o.BATCH_ID&&o.BATCH_LENGTH?o.BATCH_LENGTH:o.POINTS_LENGTH,t),a=function(e,t){if(e.geometry)return t.content&&t.content.Classification&&e.geometry.setAttribute("classification",new Di(new Uint8Array(t.content.Classification),1)),e}(a,s)}const l={point:a,batchTable:s};return Promise.resolve(l)}throw new Error("Invalid pnts file.")}(e,t.registeredExtensions).then((e=>{const n=t.material?t.material.clone():new yT({size:1,mode:t.pntsMode,shape:t.pntsShape,classificationScheme:t.classification,sizeMode:t.pntsSizeMode,minAttenuatedSize:t.pntsMinAttenuatedSize,maxAttenuatedSize:t.pntsMaxAttenuatedSize});$x(n,t);const i=new ul(e.point.geometry,n);return e.point.offset&&i.position.copy(e.point.offset),{object3d:i,batchTable:e.batchTable}}))}const DT={executeCommand:function(e){const t=e.layer,n=e.metadata,i=new li;!function(e,t,n,i){e.frustumCulled=!1,e.layer=t,n.transform&&e.applyMatrix4(n.transform),e.geometricError=n.geometricError,e.tileId=n.tileId,n.refine?e.additiveRefinement="ADD"===n.refine.toUpperCase():e.additiveRefinement=!!i&&i.additiveRefinement,e.viewerRequestVolume=n.viewerRequestVolume,e.boundingVolume=n.boundingVolume,e.updateMatrixWorld()}(i,t,n,e.requester);const r=n.content&&(n.content.url||n.content.uri),s=e=>{e.userData.metadata=n,e.layer=t};if(r){let e=r.startsWith("http")?r:n.baseURL+r;t.source.isC3DTilesGoogleSource&&(e=t.source.getTileUrl(e));const a={b3dm:BT,pnts:PT,gltf:LT};return x_.arrayBuffer(e,t.source.networkOptions).then((r=>{if(void 0!==r){let o;const l=RT.decode(new Uint8Array(r,0,4));if("{"===l[0]){r=JSON.parse(RT.decode(new Uint8Array(r)));const i=t.source.isC3DTilesGoogleSource?t.source.baseUrl:e.slice(0,e.lastIndexOf("/")+1);t.tileset.extendTileset(r,n.tileId,i,t.registeredExtensions)}else if("b3dm"==l)o=a.b3dm;else if("pnts"==l)t.hasPnts=!0,o=a.pnts;else{if("glTF"!=l)return Promise.reject(`Unsupported magic code ${l}`);o=a.gltf}if(o)return o(r,t,e).then((e=>(i.content=e.object3d,e.batchTable&&(i.batchTable=e.batchTable),i.add(e.object3d),i.traverse(s),i)))}return i.traverse(s),i}))}return i.traverse(s),Promise.resolve(i)}};let NT=1;const UT={executeCommand(e){const t=e.layer,n=e.requester;return n.load().then((i=>{const r=new ul(i,t.material);return function(e){const t=e.geometry.attributes.position.count,n=new Uint8Array(4*t),i=NT++;if(t>65535||i>65535)return console.warn("Currently picking is limited to Points with less than 65535 elements and less than 65535 Points instances"),e;for(let e=0;e<t;e++){const t=i<<16|e;n[4*e+0]=(4278190080&t)>>24,n[4*e+1]=(16711680&t)>>16,n[4*e+2]=(65280&t)>>8,n[4*e+3]=255&t}e.baseId=i,e.geometry.setAttribute("unique_id",new Di(n,4,!0))}(r),r.frustumCulled=!1,r.matrixAutoUpdate=!1,r.position.copy(i.userData.origin||n.bbox.min),r.scale.copy(t.scale),r.updateMatrix(),r.tightbbox=i.boundingBox.applyMatrix4(r.matrix),r.layer=t,r.extent=up.fromBox3(e.view.referenceCrs,n.bbox),r.userData.node=n,r}))}};let OT=0;function FT(e){const t=/\$\{u:([\w-_.|]+)\}/.exec(e);if(!t)return e;const n=t[1].split("|");return e.replace(t[0],n[OT++%n.length])}const kT={subDomains:FT,xyz:function(e,t){return FT(t.url.replace(/(\$\{z\}|%TILEMATRIX)/,t.tileMatrixCallback(e.zoom)).replace(/(\$\{y\}|%ROW)/,e.row).replace(/(\$\{x\}|%COL)/,e.col))},bbox:function(e,t){let n="EPSG:4326"==t.crs?9:2;void 0!==t.bboxDigits&&(n=t.bboxDigits);const i=e.west.toFixed(n),r=e.south.toFixed(n),s=e.east.toFixed(n),a=e.north.toFixed(n);let o=t.axisOrder||"wsen";return o=o.replace("w",`${i},`).replace("s",`${r},`).replace("e",`${s},`).replace("n",`${a},`).slice(0,-1),FT(t.url.replace("%bbox",o))}};function QT(e,t){const n=t.priority-e.priority;return 0===n?t.timestamp-e.timestamp:n}function zT(){return{queue(e){const t=e.layer;let n=this.storages.get(t.id);n||(n={q:new bE({comparator:QT}),priority:1,accumulator:0},this.storages.set(t.id,n)),n.priority=t.priority||1,n.q.queue(e),this.counters.pending++},storages:new Map,counters:{executing:0,executed:0,failed:0,cancelled:0,pending:0},execute(e,t){return this.counters.pending--,this.counters.executing++,t.executeCommand(e).then((t=>{this.counters.executing--,e.resolve(t),this.counters.executed++}),(t=>{this.counters.executing--,e.reject(t),this.counters.failed++}))}}}function GT(){this.defaultQueue=zT(),this.hostQueues=new Map,this.providers={},this.maxCommandsPerHost=6,this.initDefaultProviders()}GT.prototype.constructor=GT,GT.prototype.initDefaultProviders=function(){this.addProtocolProvider("tile",SE),this.addProtocolProvider("3d-tiles",DT),this.addProtocolProvider("pointcloud",UT)},GT.prototype.runCommand=function(e,t,n){const i=this.getProtocolProvider(e.layer.protocol);if(!i)throw new Error(`No known provider for layer ${e.layer.id}`);t.execute(e,i,n).then((()=>{if(e.view.notifyChange(e.requester,e.redraw),t.counters.executing<this.maxCommandsPerHost){const e=this.deQueue(t);e&&this.runCommand(e,t)}}))},GT.prototype.execute=function(e){const t=e.layer,n=t.source&&t.source.url&&"none"!==t.source.url?new URL(kT.subDomains(t.source.url),document.location).host:void 0;e.promise=new Promise(((t,n)=>{e.resolve=t,e.reject=n})),n&&!this.hostQueues.has(n)&&this.hostQueues.set(n,zT());const i=n?this.hostQueues.get(n):this.defaultQueue;return e.timestamp=Date.now(),i.queue(e),i.counters.executing<this.maxCommandsPerHost&&Promise.resolve().then((()=>{if(i.counters.executing<this.maxCommandsPerHost){const e=this.deQueue(i);e&&this.runCommand(e,i)}})),e.promise},GT.prototype.addProtocolProvider=function(e,t){if("function"!=typeof t.executeCommand)throw new Error(`Can't add provider for ${e}: missing a executeCommand function.`);this.providers[e]=t},GT.prototype.getProtocolProvider=function(e){return this.providers[e]||wE},GT.prototype.commandsWaitingExecutionCount=function(){let e=this.defaultQueue.counters.pending+this.defaultQueue.counters.executing;for(const t of this.hostQueues)e+=t[1].counters.pending+t[1].counters.executing;return e},GT.prototype.commandsRunningCount=function(){let e=this.defaultQueue.counters.executing;for(const t of this.hostQueues)e+=t[1].counters.executing;return e},GT.prototype.resetCommandsCount=function(e){let t=this.defaultQueue.counters[e];this.defaultQueue.counters[e]=0;for(const n of this.hostQueues)t+=n[1].counters[e],n[1].counters[e]=0;return t},GT.prototype.deQueue=function(e){const t=function(e){let t,n,i=0;for(const r of e){const e=r[1];e.q.length>0&&(i+=e.priority,e.accumulator+=e.priority,(!t||e.accumulator>n)&&(t=e,n=e.accumulator))}if(t)return t.accumulator-=i,t.q}(e.storages);for(;t&&t.length>0;){const n=t.dequeue();if(!n.earlyDropFunction||!n.earlyDropFunction(n))return n;e.counters.pending--,e.counters.cancelled++,n.reject(new ME(n))}};const HT=GT,VT=new Jd("EPSG:4326");let jT,qT="";qT=void 0!==document.documentElement.style.transform?"transform":void 0!==document.documentElement.style.webkitTransform?"webkitTransform":void 0!==document.documentElement.style.mozTransform?"mozTransform":void 0!==document.documentElement.style.oTransform?"oTransform":"transform";const WT=class extends li{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",t=arguments.length>1?arguments[1]:void 0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(null==t)throw new Error("coordinates are mandatory to add a Label");arguments.length>3&&console.warn("Deprecated argument sprites in Label constructor. Sprites must be configured in style argument."),super();let i=this.visible;Object.defineProperty(this,"visible",{set(e){e!=i&&(i=e,this.content.style.display=e?"block":"none")},get:()=>i}),this.isLabel=!0,this.coordinates=t,this.projectedPosition={x:0,y:0},this.boundaries={left:0,right:0,top:0,bottom:0},"string"==typeof e?(this.content=document.createElement("div"),this.content.textContent=n.text.field):this.content=e.cloneNode(!0),this.content.classList.add("itowns-label"),this.content.style.userSelect="none",this.content.style.position="absolute",n.isStyle?(this.anchor=n.getTextAnchorPosition(),this.styleOffset=n.text.offset,"string"==typeof e&&(n.text.haloWidth>0&&this.content.classList.add("itowns-stroke-single"),n.applyToHTML(this.content).then((e=>{e&&(this.icon=e)})))):(this.anchor=[0,0],this.styleOffset=[0,0]),this.iconOffset={left:0,right:0,top:0,bottom:0},this.zoom={min:n.zoom&&null!=n.zoom.min?n.zoom.min:2,max:n.zoom&&null!=n.zoom.max?n.zoom.max:24},this.order=n.order||0,this.padding=2}updateProjectedPosition(e,t){const n=Math.round(e),i=Math.round(t);n==this.projectedPosition.x&&i==this.projectedPosition.y||(this.projectedPosition.x=n,this.projectedPosition.y=i,this.boundaries.left=e+this.offset.left-this.padding,this.boundaries.right=e+this.offset.right+this.padding,this.boundaries.top=t+this.offset.top-this.padding,this.boundaries.bottom=t+this.offset.bottom+this.padding,0===this.iconOffset.left&&0===this.iconOffset.right&&0===this.iconOffset.top&&0===this.iconOffset.bottom||(this.boundaries.left=Math.min(this.boundaries.left,e+this.iconOffset.left),this.boundaries.right=Math.max(this.boundaries.right,e+this.iconOffset.right),this.boundaries.top=Math.min(this.boundaries.top,t+this.iconOffset.top),this.boundaries.bottom=Math.max(this.boundaries.bottom,t+this.iconOffset.bottom)))}updateCSSPosition(){this.content.style[qT]=`translate(${this.projectedPosition.x+this.offset.left}px, ${this.projectedPosition.y+this.offset.top}px)`,this.icon&&(this.icon.style[qT]=`translate(${-this.offset.left}px, ${-this.offset.top}px)`)}initDimensions(){if(!this.offset){jT=this.content.getBoundingClientRect();const e=Math.round(jT.width),t=Math.round(jT.height);this.offset={left:e*this.anchor[0]+this.styleOffset[0],top:t*this.anchor[1]+this.styleOffset[1]},this.offset.right=this.offset.left+e,this.offset.bottom=this.offset.top+t,this.icon&&(jT=this.icon.getBoundingClientRect(),this.iconOffset={left:Math.floor(jT.x),top:Math.floor(jT.y),right:Math.ceil(jT.x+jT.width),bottom:Math.ceil(jT.y+jT.height)})}}update3dPosition(e){this.coordinates.as(e,VT).toVector3(this.position),this.updateMatrixWorld()}updateElevationFromLayer(e,t){if(0==e.attachedLayers.filter((e=>e.isElevationLayer)).length)return;let n=Math.max(0,vp.getElevationValueAt(e,this.coordinates,vp.FAST_READ_Z,t));isNaN(n)&&(n=Math.max(0,vp.getElevationValueAt(e,this.coordinates,vp.FAST_READ_Z))),isNaN(n)||n==this.coordinates.z||(this.coordinates.z=n)}updateHorizonCullingPoint(){this.horizonCullingPoint&&this.getWorldPosition(this.horizonCullingPoint)}},YT=new Y_,XT=new Jd("EPSG:4326",0,0,0),KT=new up("EPSG:4326",0,0,0,0),JT=new It,$T=new It,ZT=new It;class eI{#ce=!1;constructor(){this.dom=document.createElement("div"),this.dom.style.display="none",this.visible=!0}get visible(){return this.#ce}set visible(e){e!==this.#ce&&(this.#ce=e,this.dom.style.display=e?"block":"none")}hide(){this.visible=!1}show(){this.visible=!0}add(e){this.dom.append(e.dom)}}class tI extends oo{constructor(e){super(),this.nodeParent=e,this.needsUpdate=!0}initializeDom(){this.domElements=new eI,this.domElements.labels=new eI,this.domElements.add(this.domElements.labels),this.domElements.labels.dom.style.opacity="0"}addLabel(e){this.add(e),this.domElements.labels.dom.append(e.content),e.initDimensions(),this.nodeParent.layer.isGlobeLayer&&this.nodeParent.level<4&&(e.horizonCullingPoint=new sn)}removeLabel(e){this.remove(e),this.domElements.labels.dom.removeChild(e.content)}updatePosition(e){this.needsUpdate&&(this.needsAltitude&&e.updateElevationFromLayer(this.nodeParent.layer,[this.nodeParent]),e.update3dPosition(this.nodeParent.layer.crs),e.updateHorizonCullingPoint())}count(){return this.children.length}get labels(){return this.children}}const nI=class extends px{#he=(()=>new dE)();constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const{domElement:n,performance:i=!0,forceClampToTerrain:r=!1,margin:s,...a}=t;super(e,t.object3d||new oo,a),this.isLabelLayer=!0,this.domElement=new eI,this.domElement.show(),this.domElement.dom.id=`itowns-label-${this.id}`,this.buildExtent=!0,this.crs=t.source.crs,this.performance=i,this.forceClampToTerrain=r,this.margin=s,this.toHide=new oo,this.labelDomelement=n,this.margin=t.margin}get visible(){return super.visible}set visible(e){super.visible=e,e?this.domElement?.show():this.domElement?.hide()}get submittedLabelNodes(){return this.object3d.children}convert(e,t){const n=[];return t.isExtent?t.as(e.crs,KT):t.toExtent(e.crs,KT),XT.crs=e.crs,YT.setZoom(t.zoom),e.features.forEach((t=>{if(t.style.text&&0===Object.keys(t.style.text).length)return;YT.setFeature(t);const i=t.style?.text?.field,r=t.style?.point?.base_altitude,s=r instanceof Function&&"baseAltitudeDefault"==r.name;n.needsAltitude=n.needsAltitude||!0===this.forceClampToTerrain||s&&!t.hasRawElevationData,t.geometries.forEach((r=>{YT.setGeometry(r),this.style.setContext(YT);const s=this.style.text&&this.style.text.field,a=r.properties.style&&r.properties.style.text&&r.properties.style.text.field;let o;if(this.labelDomelement)o=H_(this.labelDomelement,YT);else if(!(a||i||s||r.properties.style&&(r.properties.style.icon.source||r.properties.style.icon.key)||t.style&&t.style.icon&&(t.style.icon.source||t.style.icon.key)||this.style.icon&&(this.style.icon.source||this.style.icon.key)))return;this.style.zoom.min>this.style.context.zoom||this.style.zoom.max<=this.style.context.zoom||r.indices.forEach((i=>{if(XT.setFromArray(t.vertices,r.size*i.offset),XT.applyMatrix4(e.matrixWorld),!KT.isPointInside(XT))return;const s=new WT(o,XT.clone(),this.style);s.layerId=this.id,s.order=t.order,s.padding=this.margin||s.padding,n.push(s)}))}))})),n}preUpdate(e,t){t.has(this.parent)&&(this.object3d.clear(),this.#he.width=.5*this.parent.maxScreenSizeNode,this.#he.height=.5*this.parent.maxScreenSizeNode,this.#he.resize())}#ue(e){this.object3d.add(e)}#de(e){this.toHide.add(e)}#pe(e){return e.parent?.isTileMesh?e.parent.link[this.id]?.domElements||this.#pe(e.parent):this.domElement}#fe(e){return e.children.every((e=>e.layerUpdateState&&e.layerUpdateState[this.id]?.hasFinished()))}#me(e){const t=e.children.slice();this.#he.reset(),t.sort(((e,t)=>t.order-e.order)),t.forEach((t=>{e.nodeParent.extent.planarDimensions(JT),XT.crs=e.nodeParent.extent.crs,XT.setFromValues(e.nodeParent.extent.west,e.nodeParent.extent.north,0).toVector3($T),XT.copy(t.coordinates).as(e.nodeParent.extent.crs,XT).toVector3(ZT),ZT.sub($T),ZT.y+=JT.y,ZT.divide(JT).multiplyScalar(this.#he.width),t.updateProjectedPosition(ZT.x,ZT.y),this.#he.insert(t)||e.removeLabel(t)}))}update(e,t,n,i){if(!i&&n.link[t.id])return void dx.removeChildrenAndCleanupRecursively(this,n);const r=n.link[t.id]||new tI(n);if(n.link[t.id]=r,this.frozen||!n.visible||!this.visible)return;if(!n.material.visible&&this.#fe(n))return this.#de(r);const s=n.getExtentsByProjection(this.source.crs)||[n.extent],a=s[0].zoom;if(a<t.zoom.min||a>t.zoom.max)return this.#de(r);if(void 0===n.layerUpdateState[this.id]&&(n.layerUpdateState[this.id]=new mx),!this.source.extentInsideLimit(n.extent,a))return void n.layerUpdateState[this.id].noMoreUpdatePossible();if(this.#fe(n.parent))return n.material.visible||(r.needsUpdate=!0),void this.#ue(r);if(!n.layerUpdateState[this.id].canTryUpdate())return;n.layerUpdateState[this.id].newTry();const o={layer:this,extentsSource:s,view:e.view,requester:n};return e.scheduler.execute(o).then((t=>{if(!t)return;const i=e.view.mainLoop.gfxEngine.label2dRenderer;r.initializeDom(),this.#pe(n).add(r.domElements),t.forEach((e=>{n.parent?(r.needsAltitude=r.needsAltitude||e.needsAltitude,e.forEach((e=>{n.extent.isPointInside(e.coordinates)&&r.addLabel(e)}))):e.forEach((e=>{dx.removeChildrenAndCleanupRecursively(this,e),i.removeLabelDOM(e)}))})),r.count()&&(r.domElements.labels.hide(),r.domElements.labels.dom.style.opacity="1.0",n.addEventListener("show",(()=>r.domElements.labels.show())),n.addEventListener("hidden",(()=>this.#de(r))),n.addEventListener("removed",(()=>this.removeNodeDomElement(n))),r.needsAltitude&&n.material.getElevationLayer()&&n.material.getElevationLayer().addEventListener("rasterElevationLevelChanged",(()=>{r.needsUpdate=!0})),this.performance&&this.#me(r)),n.layerUpdateState[this.id].noMoreUpdatePossible()}))}removeLabelsFromNodeRecursive(e){e.children.forEach((e=>{e.link[this.id]&&delete e.link[this.id],this.removeLabelsFromNodeRecursive(e)})),this.removeNodeDomElement(e)}removeNodeDomElement(e){if(e.link[this.id]?.domElements){const t=e.link[this.id].domElements.dom;t.parentElement.removeChild(t),delete e.link[this.id].domElements}}delete(e){e&&this.cache.clear(),this.domElement.dom.parentElement.removeChild(this.domElement.dom),this.parent.level0Nodes.forEach((e=>this.removeLabelsFromNodeRecursive(e)))}},iI={LAYERS_INITIALIZED:"layers-initialized",LAYER_REMOVED:"layer-removed",LAYER_ADDED:"layer-added",INITIALIZED:"initialized",COLOR_LAYERS_ORDER_CHANGED:"layers-order-changed",CAMERA_MOVED:"camera-moved",DISPOSED:"disposed"},rI=new It,sI=new Nn,aI=new It,oI=new Dn,lI=new sn,cI=new sn,hI=new Jd("EPSG:4326"),uI=[];let dI,pI=0;const fI=class extends At{#ge=[];#Ae=(()=>new Uint8Array(4))();#ye;constructor(e,t){let n,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(!t)throw new Error("Invalid viewerDiv parameter (must non be null/undefined)");super(),this.domElement=t,this.id=pI++,this.referenceCrs=e,n=i.renderer&&i.renderer.domElement?new AE(i.renderer):new AE(t,i.renderer),this.mainLoop=i.mainLoop||new kp(new HT,n),this.scene=i.scene3D||new yo,i.scene3D||(this.scene.matrixWorldAutoUpdate=!1),this.camera=new Dp(this.referenceCrs,this.mainLoop.gfxEngine.getWindowSize().x,this.mainLoop.gfxEngine.getWindowSize().y,i.camera),this._frameRequesters={},this._resizeListener=()=>this.resize(),window.addEventListener("resize",this._resizeListener,!1),this._changeSources=new Set,this._delayedFrameRequesterRemoval=[],this._allLayersAreReadyCallback=()=>{this.getLayers().every((e=>e.ready))&&0==this.mainLoop.scheduler.commandsWaitingExecutionCount()&&0==this.mainLoop.renderingState&&(this.dispatchEvent({type:iI.LAYERS_INITIALIZED}),this.removeFrameRequester(Up,this._allLayersAreReadyCallback))},this.camera.resize(this.domElement.clientWidth,this.domElement.clientHeight);const r=()=>{this.removeEventListener(iI.LAYERS_INITIALIZED,r),this.dispatchEvent({type:iI.INITIALIZED})};let s;this.addEventListener(iI.LAYERS_INITIALIZED,r),this.#ye=new Uint8Array(4*this.camera.width*this.camera.height),this.domElement.tabIndex=-1,i.disableFocusOnStart||this.domElement.focus(),this.domElement.addEventListener("mouseup",(e=>{2===e.button&&(s&&e.timeStamp-s<500&&this.domElement.dispatchEvent(new MouseEvent("dblclick-right",e)),s=e.timeStamp)})),uI.push(this),i.webXR&&((e,t)=>{const n=t.scale||1,i=e.mainLoop.gfxEngine.renderer.xr;i.addEventListener("sessionstart",(()=>{const t=e.camera.camera3D,r=s=>{"Escape"===s.key&&(document.removeEventListener("keydown",r),i.enabled=!1,e.camera.camera3D=t,e.scene.scale.multiplyScalar(1/n),e.scene.updateMatrixWorld(),async function(e){e&&await e.end()}(i.getSession()),e.notifyChange(e.camera.camera3D,!0))};e.scene.scale.multiplyScalar(n),e.scene.updateMatrixWorld(),i.enabled=!0,i.getReferenceSpace("local");const s=e.camera.position(),a=(new rn).setFromUnitVectors(new sn(0,0,1),s.geodesicNormal).invert(),o=new rn(-1,0,0,1).normalize().multiply(a),l=t.position.clone().multiplyScalar(-n).applyQuaternion(o),c=new XRRigidTransform(l,o),h=i.getReferenceSpace().getOffsetReferenceSpace(c);i.setReferenceSpace(h),e.camera.camera3D=i.getCamera(),e.camera.resize(e.camera.width,e.camera.height),document.addEventListener("keydown",r,!1),i.setAnimationLoop((t=>{i.isPresenting&&e.camera.camera3D.cameras[0]&&(e.camera.camera3D.updateMatrix(),e.camera.camera3D.updateMatrixWorld(!0),e.notifyChange(e.camera.camera3D,!0)),e.mainLoop.step(e,t)}))}))})(this,i.webXR)}get renderer(){return this.mainLoop?.gfxEngine?.getRenderer()}get camera3D(){return this.camera?.camera3D}dispose(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const t=uI.indexOf(this);if(-1==t)return void console.warn("View already disposed");window.removeEventListener("resize",this._resizeListener),this.controls&&("function"==typeof this.controls.dispose&&this.controls.dispose(),delete this.controls),this.removeAllFrameRequesters();const n=this.getLayers((e=>!e.isTiledGeometryLayer&&!e.isAtmosphere));for(const t of n)this.removeLayer(t.id,e);const i=this.getLayers((e=>e.isAtmosphere));for(const t of i)this.removeLayer(t.id,e);const r=this.getLayers((e=>e.isTiledGeometryLayer));for(const t of r)this.removeLayer(t.id,e);uI.splice(t,1),this.scene.traverse(dx.cleanup),this.dispatchEvent({type:iI.DISPOSED}),this.removeAllEvents()}addLayer(e,t){if(!e||!e.isLayer)return Promise.reject(new Error("Add Layer type object"));if(this.getLayerById(e.id))return e._reject(new Error(`Invalid id '${e.id}': id already used`));if(e=function(e,t,n){const i=t.source;if(n&&!t.extent&&(t.extent=n.extent,i&&!i.extent&&(i.extent=n.extent)),t.isGeometryLayer&&!t.isLabelLayer?t.crs=e.referenceCrs:t.crs||(n&&n.tileMatrixSets&&n.tileMatrixSets.includes(i.crs)?t.crs=i.crs:t.crs=n&&n.extent.crs),t.isLabelLayer)e.mainLoop.gfxEngine.label2dRenderer.registerLayer(t);else if(t.labelEnabled||t.addLabelLayer){t.labelEnabled&&console.info("layer.labelEnabled is deprecated use addLabelLayer, instead of"),t.buildExtent=!0,t.structure="3d";const n=new nI(`${t.id}-label`,{source:i,style:t.style,zoom:t.zoom,performance:t.addLabelLayer.performance,crs:i.crs,visible:t.visible,margin:15,forceClampToTerrain:t.addLabelLayer.forceClampToTerrain});t.addEventListener("visible-property-changed",(()=>{n.visible=t.visible}));const r=i=>{i.layerId===t.id&&e.removeLayer(n.id),e.removeEventListener(iI.LAYER_REMOVED,r)};e.addEventListener(iI.LAYER_REMOVED,r),t.whenReady=t.whenReady.then((()=>(e.addLayer(n),t)))}return t.isOGC3DTilesLayer&&t._setup(e),t}(this,e,t),t)if(e.isColorLayer){const n=this.getLayers((e=>e.isColorLayer));if(e.sequence=n.length,!(t.countColorLayersTextures(...n,e)<=sf()))return e._reject(new Error(`Cant add color layer ${e.id}: the maximum layer is reached`));t.attach(e)}else t.attach(e);else{if("function"!=typeof e.update)return e._reject(new Error("Cant add GeometryLayer: missing a update function"));if("function"!=typeof e.preUpdate)return e._reject(new Error("Cant add GeometryLayer: missing a preUpdate function"));this.#ge.push(e)}return e.object3d&&!e.object3d.parent&&e.object3d!==this.scene&&this.scene.add(e.object3d),Promise.all(e._promises).then((()=>{e._resolve(),this.notifyChange(t||e,!1),this._frameRequesters[Up]&&this._frameRequesters[Up].includes(this._allLayersAreReadyCallback)||this.addFrameRequester(Up,this._allLayersAreReadyCallback),this.dispatchEvent({type:iI.LAYER_ADDED,layerId:e.id})}),e._reject),e.whenReady}removeLayer(e,t){const n=this.getLayerById(e);if(n){const i=n.parent;if(n.delete(t),i&&!i.detach(n))throw new Error(`Error to detach ${e} from ${i.id}`);if(null==i&&this.#ge.splice(this.#ge.findIndex((t=>t.id==e)),1),n.isColorLayer){const e=this.getLayers((e=>e.isColorLayer));for(const t of e)t.sequence>n.sequence&&t.sequence--}let r=0;for(const e of uI)r+=e.getLayers((e=>e.source.uid==n.source.uid&&e.crs==n.crs)).length;return n.source.onLayerRemoved({unusedCrs:0==r?n.crs:void 0}),this.notifyChange(this.camera),this.dispatchEvent({type:iI.LAYER_REMOVED,layerId:e}),!0}throw new Error(`${e} doesn't exist`)}notifyChange(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:void 0,t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];e&&(this._changeSources.add(e),this.mainLoop.gfxEngine.renderer.xr.isPresenting||!e.isTileMesh&&!e.isCamera||(this.#ye.needsUpdate=!0)),this.mainLoop.scheduleViewUpdate(this,t)}getLayers(e){const t=[];for(const n of this.#ge)if(e&&!e(n)||t.push(n),n.attachedLayers)for(const i of n.attachedLayers)e&&!e(i,n)||t.push(i);return t}getLayerById(e){return this.getLayers((t=>t.id===e))[0]}addFrameRequester(e,t){if("function"!=typeof t)throw new Error("frameRequester must be a function");this._frameRequesters[e]?this._frameRequesters[e].push(t):this._frameRequesters[e]=[t]}removeFrameRequester(e,t){this._frameRequesters[e].includes(t)?this._delayedFrameRequesterRemoval.push({when:e,frameRequester:t}):console.error("Invalid call to removeFrameRequester: frameRequester isn't registered")}removeAllFrameRequesters(){for(const e in this._frameRequesters)if(Object.prototype.hasOwnProperty.call(this._frameRequesters,e)){const t=this._frameRequesters[e];for(const n of t)this.removeFrameRequester(e,n)}this._executeFrameRequestersRemovals()}removeAllEvents(){if(void 0!==this._listeners){for(const e in this._listeners)Object.prototype.hasOwnProperty.call(this._listeners,e)&&delete this._listeners[e];this._listeners=void 0}}_executeFrameRequestersRemovals(){for(const e of this._delayedFrameRequesterRemoval){const t=this._frameRequesters[e.when].indexOf(e.frameRequester);t>=0?this._frameRequesters[e.when].splice(t,1):console.warn("FrameReq has already been removed")}this._delayedFrameRequesterRemoval.length=0}execFrameRequesters(e,t,n){if(this._frameRequesters[e]){this._delayedFrameRequesterRemoval.length>0&&this._executeFrameRequestersRemovals();for(var i=arguments.length,r=new Array(i>3?i-3:0),s=3;s<i;s++)r[s-3]=arguments[s];for(const i of this._frameRequesters[e])i.update?i.update(t,n,r):i(t,n,r)}}eventToViewCoords(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:rI,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;const i=this.domElement.getBoundingClientRect();if(e.touches&&e.touches.length)return t.set(e.touches[n].clientX-i.x,e.touches[n].clientY-i.y);if(void 0!==e.offsetX&&void 0!==e.offsetY){const n=e.target.getBoundingClientRect();return t.set(n.x+e.offsetX-i.x,n.y+e.offsetY-i.y)}}eventToNormalizedCoords(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return this.viewToNormalizedCoords(this.eventToViewCoords(e,rI,t))}viewToNormalizedCoords(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:rI;return t.x=e.x/this.camera.width*2-1,t.y=e.y/this.camera.height*-2+1,t}normalizedToViewCoords(e){return rI.x=.5*(e.x+1)*this.camera.width,rI.y=-.5*(e.y-1)*this.camera.height,rI}pickObjectsAt(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2?arguments[2]:void 0;const i=[];if(n&&0!==n.length||(n=this.getLayers((e=>e.isGeometryLayer))),Array.isArray(n)||(n=[n]),n.forEach((e=>{"string"==typeof e&&(e=this.getLayerById(e)),e&&(e.isGeometryLayer||e.isObject3D)&&i.push(e)})),0==i.length)return[];const r=[],s=e instanceof Event?this.eventToViewCoords(e):e;for(const e of i)if(!e.isAtmosphere)if(e.isGeometryLayer){if(!e.ready){console.warn("view.pickObjectAt : layer is not ready : ",e);continue}e.pickObjectsAt(this,s,t,r)}else cx.pickObjectsAt(this,s,t,e,r);return r}getScale(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.28;return this.camera3D.isOrthographicCamera?.001*e/this.getPixelsToMeters():this.getScaleFromDistance(e,this.getDistanceFromCamera())}getScaleFromDistance(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:.28,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;e/=1e3;const n=Tt.degToRad(this.camera3D.fov);return e*(this.camera.height/(2*t*Math.tan(.5*n)))}getDistanceFromCamera(e){return this.getPickingPositionFromDepth(e,cI),this.camera3D.position.distanceTo(cI)}getPixelsToMeters(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1?arguments[1]:void 0;return this.camera3D.isOrthographicCamera?(dI=(this.camera3D.right-this.camera3D.left)/this.camera3D.zoom,e*dI/this.camera.width):this.getPixelsToMetersFromDistance(e,this.getDistanceFromCamera(t))}getPixelsToMetersFromDistance(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:1)*(arguments.length>1&&void 0!==arguments[1]?arguments[1]:1)/this.camera._preSSE}getMetersToPixels(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1?arguments[1]:void 0;return this.camera3D.isOrthographicCamera?(dI=(this.camera3D.right-this.camera3D.left)/this.camera3D.zoom,e*this.camera.width/dI):this.getMetersToPixelsFromDistance(e,this.getDistanceFromCamera(t))}getMetersToPixelsFromDistance(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return this.camera._preSSE*e/t}pickFeaturesAt(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3;for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];Array.isArray(i[0])&&(console.warn("Deprecated: the ...where argument of View#pickFeaturesAt should not be an array anymore, but a list: use the spread operator if needed."),i=i[0]);const s=[],a={};(i=0==i.length?this.getLayers((e=>e.isColorLayer||e.isGeometryLayer)):i).forEach((e=>{"string"==typeof e&&(e=this.getLayerById(e)),e&&e.isLayer&&(a[e.id]=[],e.isColorLayer&&s.push(e.id))}));const o=e instanceof Event?this.eventToViewCoords(e,rI):e,l=this.pickObjectsAt(o,t,...i);if(l.length>0&&l.forEach((e=>a[e.layer.id].push(e))),0==s.length)return a;let c;this.getPickingPositionFromDepth(o,cI),hI.crs=this.referenceCrs,hI.setFromVector3(cI);const h={M:this.getPixelsToMeters(t,o),D:.001*t};this.isPlanarView?h.D=h.M:this.getPixelsToDegrees&&(h.D=this.getMetersToDegrees(h.M));const u=cx.pickTilesAt(this,o,t,this.tileLayer);for(const e of u)if(e.object.material)for(const t of e.object.material.getLayers(s))for(const e of t.textures)e.features&&(c=zd(e.features.crs)?h.M:h.D,EE.filterFeaturesUnderCoordinate(hI,e.features,c).forEach((e=>{a[t.id].find((t=>t.geometry===e.geometry))||a[t.id].push(e)})));return a}readDepthBuffer(e,t,n,i,r){const s=this.mainLoop.gfxEngine,a=this.tileLayer.wireframe,o=this.tileLayer.opacity,l=this.tileLayer.visible;a&&(this.tileLayer.wireframe=!1),o<1&&(this.tileLayer.opacity=1),l||(this.tileLayer.visible=!0);const c=this.tileLayer.level0Nodes.map((e=>Jp(e,Kp.DEPTH)));return r=s.renderViewToBuffer({camera:this.camera,scene:this.tileLayer.object3d},{x:e,y:t,width:n,height:i,buffer:r}),c.forEach((e=>e())),this.tileLayer.wireframe!==a&&(this.tileLayer.wireframe=a),this.tileLayer.opacity!==o&&(this.tileLayer.opacity=o),this.tileLayer.visible!==l&&(this.tileLayer.visible=l),r}getPickingPositionFromDepth(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new sn;if(!this.tileLayer||0==this.tileLayer.level0Nodes.length||!this.tileLayer.level0Nodes[0])return void(t=void 0);const n=this.mainLoop,i=0==n.scheduler.commandsWaitingExecutionCount()&&0==n.renderingState,r=n.gfxEngine,s=r.getWindowSize();let a;if((e=e||s.clone().multiplyScalar(.5)).x=Math.floor(e.x),e.y=Math.floor(e.y),i){this.#ye.needsUpdate&&(this.readDepthBuffer(0,0,s.x,s.y,this.#ye),this.#ye.needsUpdate=!1);const t=4*((s.y-e.y-1)*s.x+e.x);a=this.#ye.slice(t,t+4)}else a=this.readDepthBuffer(e.x,e.y,1,1,this.#Ae);if(aI.x=e.x/s.x*2-1,aI.y=-e.y/s.y*2+1,jp.isLogDepthBufferSupported()&&"PerspectiveCamera"==this.camera3D.type){oI.origin.copy(this.camera3D.position),oI.direction.set(aI.x,aI.y,.5),sI.multiplyMatrices(this.camera3D.matrixWorld,sI.copy(this.camera3D.projectionMatrix).invert()),oI.direction.applyMatrix4(sI),oI.direction.sub(oI.origin),lI.set(0,0,1),lI.applyMatrix4(sI),lI.sub(oI.origin);const e=lI.angleTo(oI.direction),n=r.depthBufferRGBAValueToOrthoZ(a,this.camera3D)/Math.cos(e);t.addVectors(this.camera3D.position,oI.direction.setLength(n))}else{const e=r.depthBufferRGBAValueToOrthoZ(a,this.camera3D);t.set(aI.x,aI.y,e),t.unproject(this.camera3D)}return t.length()>1e7?void 0:t}pickTerrainCoordinates(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Jd(this.referenceCrs);return e instanceof Event?this.eventToViewCoords(e):e&&void 0!==e.x&&void 0!==e.y?rI.copy(e):rI.set(this.mainLoop.gfxEngine.width/2,this.mainLoop.gfxEngine.height/2),this.getPickingPositionFromDepth(rI,cI),hI.crs=this.referenceCrs,hI.setFromVector3(cI),hI.as(t.crs,t),t}pickCoordinates(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Jd(this.referenceCrs);return console.warn("Deprecated, use View#pickTerrainCoordinates instead."),this.pickTerrainCoordinates(e,t)}resize(e,t){e<0||t<0?console.warn(`Trying to resize the View with negative height (${t}) or width (${e}). Skipping resize.`):(null==e&&(e=this.domElement.clientWidth),null==t&&(t=this.domElement.clientHeight),this.#ye=new Uint8Array(4*e*t),this.mainLoop.gfxEngine.onWindowResize(e,t),0!==e&&0!==t&&(this.camera.resize(e,t),this.notifyChange(this.camera3D)))}},mI=1e3/60,gI=function(e){e.id&&(clearInterval(e.id),e.id=void 0),e.waitTimer&&(clearInterval(e.waitTimer),e.waitTimer=void 0),e.keyframe=0},AI=function(e){gI(e),e.isEnded()&&e.dispatchEvent({type:"animation-ended"}),e.dispatchEvent({type:"animation-stopped"}),e.duration=0},yI=class extends At{constructor(){super(),this.id=null,this.keyframe=0,this.duration=0,this.state=0,this.waitTimer=null,this.callback=()=>{}}isPlaying(){return 1===this.state}isStopped(){return 0===this.state}isEnded(){return 2===this.state}setCallback(e){this.callback=e}play(e){this.duration=e,this.dispatchEvent({type:"animation-started"}),this.state=1,gI(this),this.id=setInterval(this.frame.bind(this),mI)}playLater(e,t){const n=Math.floor(mI*t);window.clearInterval(this.waitTimer);const i=this;this.waitTimer=window.setTimeout((()=>{i.play(e)}),n)}stop(){this.state=0,AI(this)}frame(){this.keyframe<this.duration?(this.keyframe++,this.dispatchEvent({type:"animation-frame"}),this.callback()):(this.state=2,AI(this))}};var vI,_I=Object.freeze({Linear:Object.freeze({None:function(e){return e},In:function(e){return e},Out:function(e){return e},InOut:function(e){return e}}),Quadratic:Object.freeze({In:function(e){return e*e},Out:function(e){return e*(2-e)},InOut:function(e){return(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1)}}),Cubic:Object.freeze({In:function(e){return e*e*e},Out:function(e){return--e*e*e+1},InOut:function(e){return(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2)}}),Quartic:Object.freeze({In:function(e){return e*e*e*e},Out:function(e){return 1- --e*e*e*e},InOut:function(e){return(e*=2)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)}}),Quintic:Object.freeze({In:function(e){return e*e*e*e*e},Out:function(e){return--e*e*e*e*e+1},InOut:function(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)}}),Sinusoidal:Object.freeze({In:function(e){return 1-Math.sin((1-e)*Math.PI/2)},Out:function(e){return Math.sin(e*Math.PI/2)},InOut:function(e){return.5*(1-Math.sin(Math.PI*(.5-e)))}}),Exponential:Object.freeze({In:function(e){return 0===e?0:Math.pow(1024,e-1)},Out:function(e){return 1===e?1:1-Math.pow(2,-10*e)},InOut:function(e){return 0===e?0:1===e?1:(e*=2)<1?.5*Math.pow(1024,e-1):.5*(2-Math.pow(2,-10*(e-1)))}}),Circular:Object.freeze({In:function(e){return 1-Math.sqrt(1-e*e)},Out:function(e){return Math.sqrt(1- --e*e)},InOut:function(e){return(e*=2)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)}}),Elastic:Object.freeze({In:function(e){return 0===e?0:1===e?1:-Math.pow(2,10*(e-1))*Math.sin(5*(e-1.1)*Math.PI)},Out:function(e){return 0===e?0:1===e?1:Math.pow(2,-10*e)*Math.sin(5*(e-.1)*Math.PI)+1},InOut:function(e){return 0===e?0:1===e?1:(e*=2)<1?-.5*Math.pow(2,10*(e-1))*Math.sin(5*(e-1.1)*Math.PI):.5*Math.pow(2,-10*(e-1))*Math.sin(5*(e-1.1)*Math.PI)+1}}),Back:Object.freeze({In:function(e){var t=1.70158;return 1===e?1:e*e*((t+1)*e-t)},Out:function(e){var t=1.70158;return 0===e?0:--e*e*((t+1)*e+t)+1},InOut:function(e){var t=2.5949095;return(e*=2)<1?e*e*((t+1)*e-t)*.5:.5*((e-=2)*e*((t+1)*e+t)+2)}}),Bounce:Object.freeze({In:function(e){return 1-_I.Bounce.Out(1-e)},Out:function(e){return e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375},InOut:function(e){return e<.5?.5*_I.Bounce.In(2*e):.5*_I.Bounce.Out(2*e-1)+.5}}),generatePow:function(e){return void 0===e&&(e=4),e=(e=e<Number.EPSILON?Number.EPSILON:e)>1e4?1e4:e,{In:function(t){return Math.pow(t,e)},Out:function(t){return 1-Math.pow(1-t,e)},InOut:function(t){return t<.5?Math.pow(2*t,e)/2:(1-Math.pow(2-2*t,e))/2+.5}}}}),xI=function(){return performance.now()},EI=function(){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];this._tweens={},this._tweensAddedDuringUpdate={},this.add.apply(this,e)}return e.prototype.getAll=function(){var e=this;return Object.keys(this._tweens).map((function(t){return e._tweens[t]}))},e.prototype.removeAll=function(){this._tweens={}},e.prototype.add=function(){for(var e,t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];for(var i=0,r=t;i<r.length;i++){var s=r[i];null===(e=s._group)||void 0===e||e.remove(s),s._group=this,this._tweens[s.getId()]=s,this._tweensAddedDuringUpdate[s.getId()]=s}},e.prototype.remove=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];for(var n=0,i=e;n<i.length;n++){var r=i[n];r._group=void 0,delete this._tweens[r.getId()],delete this._tweensAddedDuringUpdate[r.getId()]}},e.prototype.allStopped=function(){return this.getAll().every((function(e){return!e.isPlaying()}))},e.prototype.update=function(e,t){void 0===e&&(e=xI()),void 0===t&&(t=!0);var n=Object.keys(this._tweens);if(0!==n.length)for(;n.length>0;){this._tweensAddedDuringUpdate={};for(var i=0;i<n.length;i++){var r=this._tweens[n[i]],s=!t;r&&!1===r.update(e,s)&&!t&&this.remove(r)}n=Object.keys(this._tweensAddedDuringUpdate)}},e}(),bI={Linear:function(e,t){var n=e.length-1,i=n*t,r=Math.floor(i),s=bI.Utils.Linear;return t<0?s(e[0],e[1],i):t>1?s(e[n],e[n-1],n-i):s(e[r],e[r+1>n?n:r+1],i-r)},Bezier:function(e,t){for(var n=0,i=e.length-1,r=Math.pow,s=bI.Utils.Bernstein,a=0;a<=i;a++)n+=r(1-t,i-a)*r(t,a)*e[a]*s(i,a);return n},CatmullRom:function(e,t){var n=e.length-1,i=n*t,r=Math.floor(i),s=bI.Utils.CatmullRom;return e[0]===e[n]?(t<0&&(r=Math.floor(i=n*(1+t))),s(e[(r-1+n)%n],e[r],e[(r+1)%n],e[(r+2)%n],i-r)):t<0?e[0]-(s(e[0],e[0],e[1],e[1],-i)-e[0]):t>1?e[n]-(s(e[n],e[n],e[n-1],e[n-1],i-n)-e[n]):s(e[r?r-1:0],e[r],e[n<r+1?n:r+1],e[n<r+2?n:r+2],i-r)},Utils:{Linear:function(e,t,n){return(t-e)*n+e},Bernstein:function(e,t){var n=bI.Utils.Factorial;return n(e)/n(t)/n(e-t)},Factorial:(vI=[1],function(e){var t=1;if(vI[e])return vI[e];for(var n=e;n>1;n--)t*=n;return vI[e]=t,t}),CatmullRom:function(e,t,n,i,r){var s=.5*(n-e),a=.5*(i-t),o=r*r;return(2*t-2*n+s+a)*(r*o)+(-3*t+3*n-2*s-a)*o+s*r+t}}},wI=function(){function e(){}return e.nextId=function(){return e._nextId++},e._nextId=0,e}(),MI=new EI,SI=function(){function e(e,t){this._isPaused=!1,this._pauseStart=0,this._valuesStart={},this._valuesEnd={},this._valuesStartRepeat={},this._duration=1e3,this._isDynamic=!1,this._initialRepeat=0,this._repeat=0,this._yoyo=!1,this._isPlaying=!1,this._reversed=!1,this._delayTime=0,this._startTime=0,this._easingFunction=_I.Linear.None,this._interpolationFunction=bI.Linear,this._chainedTweens=[],this._onStartCallbackFired=!1,this._onEveryStartCallbackFired=!1,this._id=wI.nextId(),this._isChainStopped=!1,this._propertiesAreSetUp=!1,this._goToEnd=!1,this._object=e,"object"==typeof t?(this._group=t,t.add(this)):!0===t&&(this._group=MI,MI.add(this))}return e.prototype.getId=function(){return this._id},e.prototype.isPlaying=function(){return this._isPlaying},e.prototype.isPaused=function(){return this._isPaused},e.prototype.getDuration=function(){return this._duration},e.prototype.to=function(e,t){if(void 0===t&&(t=1e3),this._isPlaying)throw new Error("Can not call Tween.to() while Tween is already started or paused. Stop the Tween first.");return this._valuesEnd=e,this._propertiesAreSetUp=!1,this._duration=t<0?0:t,this},e.prototype.duration=function(e){return void 0===e&&(e=1e3),this._duration=e<0?0:e,this},e.prototype.dynamic=function(e){return void 0===e&&(e=!1),this._isDynamic=e,this},e.prototype.start=function(e,t){if(void 0===e&&(e=xI()),void 0===t&&(t=!1),this._isPlaying)return this;if(this._repeat=this._initialRepeat,this._reversed)for(var n in this._reversed=!1,this._valuesStartRepeat)this._swapEndStartRepeatValues(n),this._valuesStart[n]=this._valuesStartRepeat[n];if(this._isPlaying=!0,this._isPaused=!1,this._onStartCallbackFired=!1,this._onEveryStartCallbackFired=!1,this._isChainStopped=!1,this._startTime=e,this._startTime+=this._delayTime,!this._propertiesAreSetUp||t){if(this._propertiesAreSetUp=!0,!this._isDynamic){var i={};for(var r in this._valuesEnd)i[r]=this._valuesEnd[r];this._valuesEnd=i}this._setupProperties(this._object,this._valuesStart,this._valuesEnd,this._valuesStartRepeat,t)}return this},e.prototype.startFromCurrentValues=function(e){return this.start(e,!0)},e.prototype._setupProperties=function(e,t,n,i,r){for(var s in n){var a=e[s],o=Array.isArray(a),l=o?"array":typeof a,c=!o&&Array.isArray(n[s]);if("undefined"!==l&&"function"!==l){if(c){if(0===(g=n[s]).length)continue;for(var h=[a],u=0,d=g.length;u<d;u+=1){var p=this._handleRelativeValue(a,g[u]);if(isNaN(p)){c=!1,console.warn("Found invalid interpolation list. Skipping.");break}h.push(p)}c&&(n[s]=h)}if("object"!==l&&!o||!a||c)(void 0===t[s]||r)&&(t[s]=a),o||(t[s]*=1),i[s]=c?n[s].slice().reverse():t[s]||0;else{t[s]=o?[]:{};var f=a;for(var m in f)t[s][m]=f[m];i[s]=o?[]:{};var g=n[s];if(!this._isDynamic){var A={};for(var m in g)A[m]=g[m];n[s]=g=A}this._setupProperties(f,t[s],g,i[s],r)}}}},e.prototype.stop=function(){return this._isChainStopped||(this._isChainStopped=!0,this.stopChainedTweens()),this._isPlaying?(this._isPlaying=!1,this._isPaused=!1,this._onStopCallback&&this._onStopCallback(this._object),this):this},e.prototype.end=function(){return this._goToEnd=!0,this.update(this._startTime+this._duration),this},e.prototype.pause=function(e){return void 0===e&&(e=xI()),this._isPaused||!this._isPlaying||(this._isPaused=!0,this._pauseStart=e),this},e.prototype.resume=function(e){return void 0===e&&(e=xI()),this._isPaused&&this._isPlaying?(this._isPaused=!1,this._startTime+=e-this._pauseStart,this._pauseStart=0,this):this},e.prototype.stopChainedTweens=function(){for(var e=0,t=this._chainedTweens.length;e<t;e++)this._chainedTweens[e].stop();return this},e.prototype.group=function(e){return e?(e.add(this),this):(console.warn("tween.group() without args has been removed, use group.add(tween) instead."),this)},e.prototype.remove=function(){var e;return null===(e=this._group)||void 0===e||e.remove(this),this},e.prototype.delay=function(e){return void 0===e&&(e=0),this._delayTime=e,this},e.prototype.repeat=function(e){return void 0===e&&(e=0),this._initialRepeat=e,this._repeat=e,this},e.prototype.repeatDelay=function(e){return this._repeatDelayTime=e,this},e.prototype.yoyo=function(e){return void 0===e&&(e=!1),this._yoyo=e,this},e.prototype.easing=function(e){return void 0===e&&(e=_I.Linear.None),this._easingFunction=e,this},e.prototype.interpolation=function(e){return void 0===e&&(e=bI.Linear),this._interpolationFunction=e,this},e.prototype.chain=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return this._chainedTweens=e,this},e.prototype.onStart=function(e){return this._onStartCallback=e,this},e.prototype.onEveryStart=function(e){return this._onEveryStartCallback=e,this},e.prototype.onUpdate=function(e){return this._onUpdateCallback=e,this},e.prototype.onRepeat=function(e){return this._onRepeatCallback=e,this},e.prototype.onComplete=function(e){return this._onCompleteCallback=e,this},e.prototype.onStop=function(e){return this._onStopCallback=e,this},e.prototype.update=function(t,n){var i,r,s=this;if(void 0===t&&(t=xI()),void 0===n&&(n=e.autoStartOnUpdate),this._isPaused)return!0;if(!this._goToEnd&&!this._isPlaying){if(!n)return!1;this.start(t,!0)}if(this._goToEnd=!1,t<this._startTime)return!0;!1===this._onStartCallbackFired&&(this._onStartCallback&&this._onStartCallback(this._object),this._onStartCallbackFired=!0),!1===this._onEveryStartCallbackFired&&(this._onEveryStartCallback&&this._onEveryStartCallback(this._object),this._onEveryStartCallbackFired=!0);var a=t-this._startTime,o=this._duration+(null!==(i=this._repeatDelayTime)&&void 0!==i?i:this._delayTime),l=this._duration+this._repeat*o,c=function(){if(0===s._duration)return 1;if(a>l)return 1;var e=Math.trunc(a/o),t=a-e*o,n=Math.min(t/s._duration,1);return 0===n&&a===s._duration?1:n}(),h=this._easingFunction(c);if(this._updateProperties(this._object,this._valuesStart,this._valuesEnd,h),this._onUpdateCallback&&this._onUpdateCallback(this._object,c),0===this._duration||a>=this._duration){if(this._repeat>0){var u=Math.min(Math.trunc((a-this._duration)/o)+1,this._repeat);for(r in isFinite(this._repeat)&&(this._repeat-=u),this._valuesStartRepeat)this._yoyo||"string"!=typeof this._valuesEnd[r]||(this._valuesStartRepeat[r]=this._valuesStartRepeat[r]+parseFloat(this._valuesEnd[r])),this._yoyo&&this._swapEndStartRepeatValues(r),this._valuesStart[r]=this._valuesStartRepeat[r];return this._yoyo&&(this._reversed=!this._reversed),this._startTime+=o*u,this._onRepeatCallback&&this._onRepeatCallback(this._object),this._onEveryStartCallbackFired=!1,!0}this._onCompleteCallback&&this._onCompleteCallback(this._object);for(var d=0,p=this._chainedTweens.length;d<p;d++)this._chainedTweens[d].start(this._startTime+this._duration,!1);return this._isPlaying=!1,!1}return!0},e.prototype._updateProperties=function(e,t,n,i){for(var r in n)if(void 0!==t[r]){var s=t[r]||0,a=n[r],o=Array.isArray(e[r]),l=Array.isArray(a);!o&&l?e[r]=this._interpolationFunction(a,i):"object"==typeof a&&a?this._updateProperties(e[r],s,a,i):"number"==typeof(a=this._handleRelativeValue(s,a))&&(e[r]=s+(a-s)*i)}},e.prototype._handleRelativeValue=function(e,t){return"string"!=typeof t?t:"+"===t.charAt(0)||"-"===t.charAt(0)?e+parseFloat(t):parseFloat(t)},e.prototype._swapEndStartRepeatValues=function(e){var t=this._valuesStartRepeat[e],n=this._valuesEnd[e];this._valuesStartRepeat[e]="string"==typeof n?this._valuesStartRepeat[e]+parseFloat(n):this._valuesEnd[e],this._valuesEnd[e]=t},e.autoStartOnUpdate=!1,e}(),CI=wI.nextId,TI=MI,II=TI.getAll.bind(TI),RI=TI.removeAll.bind(TI),BI=TI.add.bind(TI),LI=TI.remove.bind(TI),PI=TI.update.bind(TI),DI={Easing:_I,Group:EI,Interpolation:bI,now:xI,Sequence:wI,nextId:CI,Tween:SI,VERSION:"25.0.0",getAll:II,removeAll:RI,add:BI,remove:LI,update:PI};li.DEFAULT_UP.set(0,0,1);const NI=new sn,UI=new Jd("EPSG:4326",0,0,0),OI=new Ud,FI=[],kI=new Xx,QI=new sn;function zI(e){return e-360*Math.floor((e+180)/360)}function GI(e){return e.getLayers((e=>e.isTiledGeometryLayer))[0]}class HI extends li{constructor(){super(),this.seaLevel=new li,this.target=new li,this.target.rotation.order="ZXY",this.camera=new ur,this.add(this.seaLevel),this.seaLevel.add(this.target),this.target.add(this.camera),this.coord=new Jd("EPSG:4978",0,0),this.targetWorldPosition=new sn,this.removeAll=()=>{},this._onChangeCallback=null}applyTransformToCamera(e,t){this.proxy?(t.quaternion._onChange(this._onChangeCallback),this.camera.matrixWorld.decompose(this.proxy.position,t.quaternion,t.scale),t.quaternion._onChange((()=>this.removeProxy(e,t)))):this.camera.matrixWorld.decompose(t.position,t.quaternion,t.scale),e.dispatchEvent({type:iI.CAMERA_MOVED,coord:this.coord,range:this.range,heading:this.heading,tilt:this.tilt})}setProxy(e,t){!this.proxy&&e&&t&&(this.proxy={position:new sn},Object.keys(t.position).forEach((n=>function(e,t,n,i){n.proxy.position[i]=t.position[i],Object.defineProperty(t.position,i,{get:()=>n.proxy.position[i],set:r=>{n.removeProxy(e,t),t.position[i]=r}})}(e,t,this,n))),this._onChangeCallback=t.quaternion._onChangeCallback,t.quaternion._onChange((()=>this.removeProxy(e,t))))}removeProxy(e,t){this.stop(e),this.proxy&&e&&t&&(Object.keys(t.position).forEach((e=>Object.defineProperty(t.position,e,{value:this.proxy.position[e],writable:!0}))),t.quaternion._onChange(this._onChangeCallback),this.proxy=null)}setTargetFromCoordinate(e,t){t.as(GI(e).extent.crs,this.coord);const n=Math.max(0,vp.getElevationValueAt(GI(e),this.coord,vp.PRECISE_READ_Z)||this.coord.z);this.coord.z=n,this.coord.as(e.referenceCrs).toVector3(NI),"EPSG:4978"==e.referenceCrs?(this.lookAt(NI),this.seaLevel.position.set(0,0,NI.length()-n)):(this.position.set(NI.x,NI.y,0),this.seaLevel.position.set(0,0,0)),this.target.position.set(0,0,n)}setFromPositions(e,t){this.setTargetFromCoordinate(e,new Jd(e.referenceCrs).setFromVector3(NI)),this.target.rotation.set(0,0,0),this.updateMatrixWorld(!0),this.camera.position.copy(t),this.target.worldToLocal(this.camera.position);const n=this.camera.position.length();this.target.rotation.x=Math.asin(this.camera.position.z/n);const i=Tt.clamp(this.camera.position.y/(Math.cos(this.target.rotation.x)*n),-1,1);this.target.rotation.z=Math.sign(-this.camera.position.x||1)*Math.acos(i),this.camera.position.set(0,n,0)}applyParams(e,t){t.coord&&this.setTargetFromCoordinate(e,t.coord),null!=t.tilt&&(this.target.rotation.x=Tt.degToRad(t.tilt)),null!=t.heading&&(this.target.rotation.z=Tt.degToRad(-zI(t.heading+180))),t.range&&this.camera.position.set(0,t.range,0),this.camera.rotation.set(.5*-Math.PI,0,Math.PI),this.updateMatrixWorld(!0),this.targetWorldPosition.setFromMatrixPosition(this.seaLevel.matrixWorld)}getParams(){return{coord:this.coord.clone(),tilt:this.tilt,heading:this.heading,range:this.range,targetWorldPosition:this.targetWorldPosition}}setfromCamera(e,t,n){t.updateMatrixWorld(!0),null==n&&(n=e.getPickingPositionFromDepth()||function(e,t){const n=new sn(0,0,.5);if(n.unproject(t),n.sub(t.position).normalize(),"EPSG:4978"==e.referenceCrs)return OI.intersection({direction:n,origin:t.position});{const e=t.position.z/n.z;return n.multiplyScalar(e).add(t.position)}}(e,t));const i=n&&!isNaN(n.x)?t.position.distanceTo(n):100;t.localToWorld(NI.set(0,0,-i)),this.setFromPositions(e,t.position)}copyObject3D(e){return this.copy(e,!1),this.seaLevel.copy(e.seaLevel,!1),this.target.copy(e.target,!1),this.camera.copy(e.camera),this}animateCameraToLookAtTarget(e,t,n){n.easing=n.easing||DI.Easing.Quartic.InOut,this.setfromCamera(e,t);const i=new DI.Group;this.start=(this.start||new HI).copyObject3D(this),this.end=(this.end||new HI).copyObject3D(this);const r=n.time||2500,s={t:0},a=[],o=(()=>{let e,t;return{promise:new Promise(((n,i)=>{e=n,t=i})),resolve:e,reject:t}})();this.addPlaceTargetOnGround(e,t,n.coord,s),this.end.applyParams(e,n);const l=this.end.target.rotation.z-this.start.target.rotation.z;return Math.abs(l)>Math.PI&&(this.end.target.rotation.z=this.start.target.rotation.z+l-2*Math.sign(l)*Math.PI),a.push(new DI.Tween(s).to({t:1},r).easing(n.easing).onUpdate((t=>{"EPSG:4978"==e.referenceCrs&&this.quaternion.slerpQuaternions(this.start.quaternion,this.end.quaternion,t.t),this.camera.quaternion.slerpQuaternions(this.start.camera.quaternion,this.end.camera.quaternion,t.t),this.target.rotation.set(0,0,0),this.target.rotateZ(Tt.lerp(this.start.target.rotation.z,this.end.target.rotation.z,t.t)),this.target.rotateX(Tt.lerp(this.start.target.rotation.x,this.end.target.rotation.x,t.t))}))),"EPSG:4978"!=e.referenceCrs&&a.push(new DI.Tween(this.position).to(this.end.position,r).easing(n.easing)),a.push(new DI.Tween(this.seaLevel.position).to(this.end.seaLevel.position,r).easing(n.easing)),a.push(new DI.Tween(this.camera.position).to(this.end.camera.position,r).easing(n.easing)),i.add(...a),this.animationFrameRequester=()=>{i.update(),this.updateMatrixWorld(!0),this.applyTransformToCamera(e,t),this.targetWorldPosition.setFromMatrixPosition(this.seaLevel.matrixWorld),n.callback&&n.callback(this),UI.crs=e.referenceCrs,UI.setFromVector3(this.targetWorldPosition).as(GI(e).extent.crs,this.coord),e.notifyChange(t)},this.removeAll=function(t){this.removeAll=()=>{},i.removeAll(),this.animationFrameRequester&&e.removeFrameRequester(Np,this.animationFrameRequester),o.resolve(void 0!==t),this.animationFrameRequester=null},a[a.length-1].onComplete(this.removeAll),a.forEach((e=>e.start())),e.addFrameRequester(Np,this.animationFrameRequester),e.notifyChange(t),o}stop(e){this.removePlaceTargetOnGround(e),this.removeAll()}addPlaceTargetOnGround(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{t:1};if(this.removePlaceTargetOnGround(e),e&&t){const r=this.target.position.z;this.placeTargetOnGround=()=>{const s=Math.max(0,vp.getElevationValueAt(GI(e),n||this.coord,vp.PRECISE_READ_Z)||0);this.target.position.z=r*(1-i.t)+s*i.t,this.target.updateMatrixWorld(!0),this.applyTransformToCamera(e,t)},this.placeTargetOnGround(),e.addFrameRequester(Np,this.placeTargetOnGround)}}removePlaceTargetOnGround(e){e&&this.placeTargetOnGround&&(e.removeFrameRequester(Np,this.placeTargetOnGround),this.placeTargetOnGround=null)}get tilt(){return Tt.radToDeg(this.target.rotation.x)}get heading(){return-zI(Tt.radToDeg(this.target.rotation.z)+180)}get range(){return this.camera.position.y}}function VI(e){return FI[e.uuid]=FI[e.uuid]||new HI,FI[e.uuid]}const jI={defaultStopPlaceOnGroundAtEnd:!1,Easing:DI.Easing,stop(e,t){VI(t).stop(e)},getTransformCameraLookingAtTarget(e,t,n){const i=VI(t);return i.setfromCamera(e,t,n),i.getParams()},transformCameraToLookAtTarget(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};n.isExtent&&(n=this.getCameraTransformOptionsFromExtent(e,t,n)),n.proxy=void 0===n.proxy||n.proxy;const i=VI(t);return i.stop(e),i.setfromCamera(e,t),n.proxy&&i.setProxy(e,t),i.applyParams(e,n),i.addPlaceTargetOnGround(e,t,n.coord),i.applyTransformToCamera(e,t),e.notifyChange(t),Promise.resolve(i.getParams())},getCameraTransformOptionsFromExtent(e,t,n){const i={coord:new Jd(n.crs,0,0,0),heading:0,tilt:e.isPlanarView?90:89.9};let r;if(e.isGlobeView?(n=n.as("EPSG:4326"),kI.setFromExtent(n),kI.box3D.getSize(QI),r={x:QI.y,y:QI.x}):r=(n=n.as(e.referenceCrs)).planarDimensions(),n.center(i.coord),t.isOrthographicCamera)r.x/r.y>t.aspect?t.zoom=(t.right-t.left)/r.x:t.zoom=(t.top-t.bottom)/r.y,t.updateProjectionMatrix(),i.range=1e3;else if(t.isPerspectiveCamera){const n=Tt.degToRad(t.fov);if(r.x/r.y>t.aspect){const t=.5*e.domElement.clientHeight/Math.tan(.5*n),s=2*Math.atan(.5*e.domElement.clientWidth/t);i.range=r.x/(2*Math.tan(.5*s))}else i.range=r.y/(2*Math.tan(.5*n))}return i},animateCameraToLookAtTarget(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};n.proxy=void 0===n.proxy||n.proxy;const i=VI(t);return i.stop(e),n.proxy&&i.setProxy(e,t),i.animateCameraToLookAtTarget(e,t,n).promise.then((t=>{const r=void 0===n.stopPlaceOnGroundAtEnd?this.defaultStopPlaceOnGroundAtEnd:n.stopPlaceOnGroundAtEnd,s=i.getParams();return r&&i.stop(e),s.finished=t,s}))},sequenceAnimationsToLookAtTarget(e,t){return(arguments.length>2&&void 0!==arguments[2]?arguments[2]:[{}]).map((n=>()=>this.animateCameraToLookAtTarget(e,t,n))).reduce(((e,t)=>e.then((e=>!e.length||e[e.length-1].finished?t().then(Array.prototype.concat.bind(e)):Promise.resolve([{finished:!1}])))),Promise.resolve([]))},getDiffParams(e,t){if(!e||!t)return;let n;return Math.abs(e.range-t.range)/e.range>.001&&(n=n||{},n.range={previous:e.range,new:t.range}),Math.abs(e.tilt-t.tilt)>.1&&(n=n||{},n.tilt={previous:e.tilt,new:t.tilt}),Math.abs(e.heading-t.heading)>.1&&(n=n||{},n.heading={previous:e.heading,new:t.heading}),(Math.abs(e.coord.x-t.coord.x)>1e-6||Math.abs(e.coord.y-t.coord.y)>1e-6)&&(n=n||{},n.coord={previous:e.coord,new:t.coord}),n}},qI={ORBIT:{enable:!0,mouseButton:i.LEFT,double:!1,keyboard:17,finger:2,_event:"rotate"},MOVE_GLOBE:{enable:!0,mouseButton:i.LEFT,double:!1,finger:1,_event:"drag"},DOLLY:{enable:!0,mouseButton:i.MIDDLE,double:!1,finger:2,_event:"dolly"},PAN:{enable:!0,mouseButton:i.RIGHT,double:!1,finger:3,_event:"pan"},PANORAMIC:{enable:!0,mouseButton:i.LEFT,double:!1,keyboard:16,_event:"panoramic"},TRAVEL_IN:{enable:!0,mouseButton:i.LEFT,double:!0,_event:"travel_in",_trigger:!0,_direction:"in"},TRAVEL_OUT:{enable:!1,double:!1,_event:"travel_out",_trigger:!0,_direction:"out"},ZOOM:{enable:!0,_event:"zoom",_trigger:!0},PAN_UP:{enable:!0,keyboard:38,double:!1,_event:"pan",_trigger:!0,_direction:"up"},PAN_BOTTOM:{enable:!0,keyboard:40,double:!1,_event:"pan",_trigger:!0,_direction:"bottom"},PAN_LEFT:{enable:!0,keyboard:37,double:!1,_event:"pan",_trigger:!0,_direction:"left"},PAN_RIGHT:{enable:!0,keyboard:39,double:!1,_event:"pan",_trigger:!0,_direction:"right"}},WI=new It,YI=class extends At{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};super(),this._view=e,this._domElement=e.domElement;let n=!0;Object.defineProperty(this,"enabled",{get:()=>n,set:e=>{e||(this.onKeyUp(),this.onPointerUp()),n=e}});let i=!0;Object.defineProperty(this,"enableKeys",{get:()=>i,set:e=>{e||this.onKeyUp(),i=e}}),this.NONE={};let r=this.NONE;Object.defineProperty(this,"currentState",{get:()=>r,set:e=>{if(r!==e){const t=r;r=e,this.dispatchEvent({type:"state-changed",viewCoords:WI,previous:t})}}}),this._clickTimeStamp=0,this._lastMousePressed={viewCoords:new It},this._currentMousePressed=void 0,this._currentKeyPressed=void 0,this._onPointerDown=this.onPointerDown.bind(this),this._onPointerMove=this.onPointerMove.bind(this),this._onPointerUp=this.onPointerUp.bind(this),this._onMouseWheel=this.onMouseWheel.bind(this),this._onKeyDown=this.onKeyDown.bind(this),this._onKeyUp=this.onKeyUp.bind(this),this._onBlur=this.onBlur.bind(this),this._onContextMenu=this.onContextMenu.bind(this),this._domElement.addEventListener("pointerdown",this._onPointerDown,!1),this._domElement.addEventListener("wheel",this._onMouseWheel,!1),this._domElement.addEventListener("keydown",this._onKeyDown,!1),this._domElement.addEventListener("keyup",this._onKeyUp,!1),this._domElement.addEventListener("blur",this._onBlur),this._domElement.addEventListener("contextmenu",this._onContextMenu,!1),this.setFromOptions(t)}inputToState(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];for(const i of Object.keys(qI)){const r=this[i];if(r.enable&&r.mouseButton===e&&r.keyboard===t&&r.double===n){if(!r._trigger)return r;this.dispatchEvent({type:r._event,viewCoords:void 0!==e&&WI,direction:r._direction})}}return this.NONE}touchToState(e){for(const t of Object.keys(qI)){const n=this[t];if(n.enable&&e===n.finger)return n}return this.NONE}setFromOptions(e){for(const t in qI)if({}.hasOwnProperty.call(qI,t)){let n={};n=e[t]||this[t]||Object.assign(n,qI[t]),e[t]&&void 0===e[t].enable&&(n.enable=this[t].enable),n.double=!!n.double,n._event=qI[t]._event,n._trigger=qI[t]._trigger,n._direction=qI[t]._direction,this[t]=n}}onPointerDown(e){this.enabled&&(WI.copy(this._view.eventToViewCoords(e)),"mouse"===e.pointerType&&(this._currentMousePressed=e.button,void 0===this._currentKeyPressed&&(e.ctrlKey?this._currentKeyPressed=17:e.shiftKey?this._currentKeyPressed=16:e.metaKey&&(this._currentKeyPressed=91)),this.currentState=this.inputToState(this._currentMousePressed,this._currentKeyPressed,e.timeStamp-this._clickTimeStamp<500&&this._lastMousePressed.button===this._currentMousePressed&&this._lastMousePressed.viewCoords.distanceTo(WI)<5),this._clickTimeStamp=e.timeStamp,this._lastMousePressed.button=this._currentMousePressed,this._lastMousePressed.viewCoords.copy(WI)),this._domElement.addEventListener("pointermove",this._onPointerMove,!1),this._domElement.addEventListener("pointerup",this._onPointerUp,!1),this._domElement.addEventListener("mouseleave",this._onPointerUp,!1))}onPointerMove(e){e.preventDefault(),this.enabled&&(WI.copy(this._view.eventToViewCoords(e)),"mouse"===e.pointerType)&&this.dispatchEvent({type:this.currentState._event,viewCoords:WI})}onPointerUp(){this.enabled&&(this._currentMousePressed=void 0,this._domElement.removeEventListener("pointermove",this._onPointerMove,!1),this._domElement.removeEventListener("pointerup",this._onPointerUp,!1),this._domElement.removeEventListener("mouseleave",this._onPointerUp,!1),this.currentState=this.NONE)}onMouseWheel(e){e.preventDefault(),this.enabled&&this.ZOOM.enable&&(WI.copy(this._view.eventToViewCoords(e)),this.currentState=this.ZOOM,this.dispatchEvent({type:this.ZOOM._event,delta:e.deltaY,viewCoords:WI}))}onKeyDown(e){this.enabled&&this.enableKeys&&(this._currentKeyPressed=e.keyCode,this.inputToState(this._currentMousePressed,this._currentKeyPressed))}onKeyUp(){this.enabled&&this.enableKeys&&(this._currentKeyPressed=void 0,void 0===this._currentMousePressed&&(this.currentState=this.NONE))}onBlur(){this.onKeyUp(),this.onPointerUp()}onContextMenu(e){e.preventDefault()}dispose(){this._clickTimeStamp=0,this._lastMousePressed=void 0,this._currentKeyPressed=void 0,this._domElement.removeEventListener("pointerdown",this._onPointerDown,!1),this._domElement.removeEventListener("pointermove",this._onPointerMove,!1),this._domElement.removeEventListener("pointerup",this._onPointerUp,!1),this._domElement.removeEventListener("wheel",this._onMouseWheel,!1),this._domElement.removeEventListener("keydown",this._onKeyDown,!1),this._domElement.removeEventListener("keyup",this._onKeyUp,!1),this._domElement.removeEventListener("blur",this._onBlur),this._domElement.removeEventListener("contextmenu",this._onContextMenu,!1)}},XI=1e-6,KI={up:new It(0,1),bottom:new It(0,-1),left:new It(1,0),right:new It(-1,0)},JI=new It,$I=new It,ZI=new It,eR=new Sc(1,.01,0),tR=new Sc(1,0,0);let nR=1;const iR=new It,rR=new It,sR=new It,aR=new sn,oR=new It,lR=new It,cR=new It;let hR;const uR=new rn,dR=new li,pR=new Jd("EPSG:4978");dR.matrixWorldInverse=new Nn;const fR=new Jd("EPSG:4978",0,0,0),mR=new Jd("EPSG:4326",0,0,0);function gR(e,t){fR.setFromVector3(e).as("EPSG:4326",mR),t.position.copy(e),t.lookAt(mR.geodesicNormal.add(e)),t.rotateX(.5*Math.PI),t.updateMatrixWorld(!0)}let AR=0,yR=!0;const vR=new rn(0,0,0,1),_R=new sn,xR=new sn,ER=new rn,bR=new Sn,wR=new sn,MR=new sn,SR={},CR=new rn,TR=new rn,IR=new sn(1,0,0);let RR=1/0;const BR=new sn,LR=new sn,PR=new bc,DR=new sn,NR=new sn,UR=new Sn;let OR;const FR=class extends At{constructor(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};super(),this.player=new yI,this.view=e,this.camera=e.camera3D,this.states=new YI(this.view,n.stateControl),Object.defineProperty(this,"enabled",{get:()=>this.states.enabled,set:e=>{console.warn("GlobeControls.enabled property is deprecated. Use StateControl.enabled instead - which you can access with GlobeControls.states.enabled."),this.states.enabled=e}}),n.zoomSpeed&&(console.warn("Controls zoomSpeed parameter is deprecated. Use zoomFactor instead."),n.zoomFactor=n.zoomFactor||n.zoomSpeed),this.zoomFactor=n.zoomFactor||1.1,this.minDistance=n.minDistance||250,this.maxDistance=n.maxDistance||8*Dd.x,this.minZoom=n.minZoom||0,this.maxZoom=n.maxZoom||1/0,this.rotateSpeed=n.rotateSpeed||.25,this.keyPanSpeed=n.keyPanSpeed||7,this.minPolarAngle=Tt.degToRad(n.minPolarAngle??.5),this.maxPolarAngle=Tt.degToRad(n.minPolarAngle??86),this.minAzimuthAngle=n.minAzimuthAngle?Tt.degToRad(n.minAzimuthAngle):-1/0,this.maxAzimuthAngle=n.maxAzimuthAngle?Tt.degToRad(n.maxAzimuthAngle):1/0,this.handleCollision=void 0===n.handleCollision||n.handleCollision,this.minDistanceCollision=60,Object.defineProperty(this,"enableKeys",{get:()=>this.states.enableKeys,set:e=>{console.warn("GlobeControls.enableKeys property is deprecated. Use StateControl.enableKeys instead - which you can access with GlobeControls.states.enableKeys."),this.states.enableKeys=e}}),this.enableDamping=!1!==n.enableDamping,this.dampingMoveFactor=null!=n.dampingMoveFactor?n.dampingMoveFactor:.25,this.startEvent={type:"start"},this.endEvent={type:"end"},this.updateHelper=function(){},this._onEndingMove=null,this._onTravel=this.travel.bind(this),this._onTouchStart=this.onTouchStart.bind(this),this._onTouchEnd=this.onTouchEnd.bind(this),this._onTouchMove=this.onTouchMove.bind(this),this._onStateChange=this.onStateChange.bind(this),this._onRotation=this.handleRotation.bind(this),this._onDrag=this.handleDrag.bind(this),this._onDolly=this.handleDolly.bind(this),this._onPan=this.handlePan.bind(this),this._onPanoramic=this.handlePanoramic.bind(this),this._onZoom=this.handleZoom.bind(this),this.states.addEventListener("state-changed",this._onStateChange,!1),this.states.addEventListener(this.states.ORBIT._event,this._onRotation,!1),this.states.addEventListener(this.states.MOVE_GLOBE._event,this._onDrag,!1),this.states.addEventListener(this.states.DOLLY._event,this._onDolly,!1),this.states.addEventListener(this.states.PAN._event,this._onPan,!1),this.states.addEventListener(this.states.PANORAMIC._event,this._onPanoramic,!1),this.states.addEventListener("zoom",this._onZoom,!1),this.view.domElement.addEventListener("touchstart",this._onTouchStart,!1),this.view.domElement.addEventListener("touchend",this._onTouchEnd,!1),this.view.domElement.addEventListener("touchmove",this._onTouchMove,!1),this.states.addEventListener(this.states.TRAVEL_IN._event,this._onTravel,!1),this.states.addEventListener(this.states.TRAVEL_OUT._event,this._onTravel,!1),e.scene.add(dR),t.isExtent?t.center().as("EPSG:4978",fR):(t.coord.as("EPSG:4978",fR),t.tilt=t.tilt||89.5,t.heading=t.heading||0),gR(fR,dR),this.lookAtCoordinate(t,!1),pR.crs=this.view.referenceCrs}get zoomInScale(){return this.zoomFactor}get zoomOutScale(){return 1/this.zoomFactor}get isPaused(){return this.states.currentState===this.states.NONE&&!this.player.isPlaying()}onEndingMove(e){this._onEndingMove&&(this.player.removeEventListener("animation-stopped",this._onEndingMove),this._onEndingMove=null),this.handlingEvent(e)}rotateLeft(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;tR.theta-=e}rotateUp(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;tR.phi-=e}panLeft(e){const t=this.camera.matrix.elements;aR.fromArray(t),aR.multiplyScalar(-e),_R.add(aR)}panUp(e){const t=this.camera.matrix.elements;aR.fromArray(t,4),aR.multiplyScalar(e),_R.add(aR)}mouseToPan(e,t){const n=this.view.mainLoop.gfxEngine;if(this.camera.isPerspectiveCamera){let i=this.camera.position.distanceTo(this.getCameraTargetPosition());i*=2*Math.tan(Tt.degToRad(.5*this.camera.fov)),this.panLeft(e*i/n.width*this.camera.aspect),this.panUp(t*i/n.height)}else this.camera.isOrthographicCamera&&(this.panLeft(e*(this.camera.right-this.camera.left)/n.width),this.panUp(t*(this.camera.top-this.camera.bottom)/n.height))}dolly(e){0!==e&&(hR=e>0?this.zoomInScale:this.zoomOutScale,this.camera.isPerspectiveCamera?nR/=hR:this.camera.isOrthographicCamera&&(this.camera.zoom=Tt.clamp(this.camera.zoom*hR,this.minZoom,this.maxZoom),this.camera.updateProjectionMatrix(),this.view.notifyChange(this.camera)))}getMinDistanceCameraBoundingSphereObbsUp(e){if(e.level>10&&1==e.children.length&&e.geometry){const t=e.obb;UR.center.copy(this.camera.position),UR.radius=this.minDistanceCollision,t.isSphereAboveXYBox(UR)&&(RR=Math.min(UR.center.z-t.box3D.max.z,RR))}}update(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.states.currentState;if(RR=1/0,this.handleCollision&&this.view.tileLayer)for(const e of this.view.tileLayer.level0Nodes)e.traverse(this.getMinDistanceCameraBoundingSphereObbsUp.bind(this));switch(e){case this.states.MOVE_GLOBE:if(RR<0)dR.translateY(-RR),this.camera.position.setLength(this.camera.position.length()-RR);else if(RR<this.minDistanceCollision){const e=this.minDistanceCollision*(1-RR/this.minDistanceCollision);dR.translateY(e),this.camera.position.setLength(this.camera.position.length()+e)}BR.copy(LR).applyQuaternion(uR),dR.position.applyQuaternion(uR),this.camera.position.applyQuaternion(uR);break;case this.states.PAN:this.camera.position.add(_R),dR.position.add(_R);break;case this.states.PANORAMIC:{this.camera.worldToLocal(dR.position);const e=this.camera.position.clone().normalize().applyQuaternion(this.camera.quaternion.clone().invert());CR.setFromAxisAngle(e,tR.theta).multiply(TR.setFromAxisAngle(IR,tR.phi)),dR.position.applyQuaternion(CR),this.camera.localToWorld(dR.position);break}default:{this.camera.position.applyMatrix4(dR.matrixWorldInverse),(tR.theta||tR.phi)&&eR.setFromVector3(this.camera.position);const e=eR.radius*Math.sin(this.minPolarAngle),t=8*e,n=2*e,i=-.01;if(this.handleCollision)if(RR<t&&RR>n&&tR.phi>0){const e=t-n,i=1-(e-(RR-n))/e;tR.phi*=i*i}else if(RR<n&&RR>-n&&tR.phi>i){let e=-Math.asin(.25*(n-RR)/eR.radius);e=Tt.clamp(e,i,0);const t=1-(n-RR)/(2*n);tR.phi=Tt.lerp(tR.phi,e,t),RR-=Math.sin(tR.phi)*eR.radius}eR.theta+=tR.theta,eR.phi+=tR.phi,eR.theta=Math.max(this.minAzimuthAngle,Math.min(this.maxAzimuthAngle,eR.theta)),eR.phi=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,eR.phi)),eR.radius=this.camera.position.length()*nR,eR.makeSafe(),eR.radius=Math.max(this.minDistance,Math.min(this.maxDistance,eR.radius)),this.camera.position.setFromSpherical(eR),RR<0&&(this.camera.position.y-=RR,eR.setFromVector3(this.camera.position),tR.phi=0),dR.localToWorld(this.camera.position)}}this.camera.up.copy(dR.position).normalize(),this.camera.lookAt(dR.position),this.enableDamping?(tR.theta*=.75,tR.phi*=.75,uR.slerp(vR,.2*this.dampingMoveFactor)):(tR.theta=0,tR.phi=0,uR.set(0,0,0,1)),nR=1,_R.set(0,0,0),(xR.distanceToSquared(this.camera.position)>XI||8*(1-ER.dot(this.camera.quaternion))>XI)&&(this.view.notifyChange(this.camera),xR.copy(this.camera.position),ER.copy(this.camera.quaternion)),this.enableDamping&&e===this.states.ORBIT&&this.player.isStopped()&&(tR.theta>XI||tR.phi>XI)&&(this.player.setCallback((()=>{this.update(this.states.ORBIT)})),this.player.playLater(60,2)),this.view.dispatchEvent({type:iI.CAMERA_MOVED,coord:pR.setFromVector3(dR.position),range:eR.radius,heading:-Tt.radToDeg(eR.theta),tilt:90-Tt.radToDeg(eR.phi)})}onStateChange(e){this.states.currentState!==this.states.NONE?(jI.stop(this.view,this.camera),this.onEndingMove(),this.player.stop(),this.updateTarget(),OR=jI.getTransformCameraLookingAtTarget(this.view,this.camera,NR),JI.copy(e.viewCoords),this.view.getPickingPositionFromDepth(e.viewCoords,wR)&&(bR.radius=wR.length(),BR.copy(wR).normalize(),this.updateHelper(wR,SR.picking)),oR.copy(e.viewCoords),this.view.getPickingPositionFromDepth(e.viewCoords,NR),iR.copy(e.viewCoords)):this.handleEndMovement(e)}handleRotation(e){this.player.stop(),this.handlePanoramic(e)}handleDrag(e){const t=this.view.viewToNormalizedCoords(e.viewCoords);this.camera.updateMatrixWorld(),PR.setFromCamera(t,this.camera),PR.ray.intersectSphere(bR,MR)?(LR.copy(MR).normalize(),uR.setFromUnitVectors(LR,BR),AR=Date.now(),this.update()):this.states.onPointerUp()}handleDolly(e){lR.copy(e.viewCoords),cR.subVectors(lR,oR),oR.copy(lR),e.delta=cR.y,0!=e.delta&&this.handleZoom(e)}handlePan(e){e.viewCoords?(rR.copy(e.viewCoords),sR.subVectors(rR,iR),iR.copy(rR)):e.direction&&sR.copy(KI[e.direction]).multiplyScalar(this.keyPanSpeed),this.mouseToPan(sR.x,sR.y),this.update(this.states.PAN)}handlePanoramic(e){$I.copy(e.viewCoords),ZI.subVectors($I,JI);const t=this.view.mainLoop.gfxEngine;tR.theta-=2*Math.PI*ZI.x/t.width*this.rotateSpeed,tR.phi-=2*Math.PI*ZI.y/t.height*this.rotateSpeed,JI.copy($I),this.update()}handleEndMovement(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.dispatchEvent(this.endEvent),this.player.stop(),this.enableDamping?e.previous===this.states.ORBIT&&(tR.theta>XI||tR.phi>XI)?(this.player.setCallback((()=>{this.update(this.states.ORBIT)})),this.player.play(60),this._onEndingMove=()=>this.onEndingMove(),this.player.addEventListener("animation-stopped",this._onEndingMove)):e.previous===this.states.MOVE_GLOBE&&Date.now()-AR<50?(this.player.setCallback((()=>{this.update(this.states.MOVE_GLOBE)})),this.player.play(120),this._onEndingMove=()=>this.onEndingMove(),this.player.addEventListener("animation-stopped",this._onEndingMove)):this.onEndingMove():this.onEndingMove()}updateTarget(){if(this.view.getPickingPositionFromDepth(null,NR)){const e=isNaN(NR.x)?100:this.camera.position.distanceTo(NR);DR.set(0,0,-e),this.camera.localToWorld(DR),gR(DR,dR),dR.matrixWorldInverse.copy(dR.matrixWorld).invert(),DR.copy(this.camera.position),DR.applyMatrix4(dR.matrixWorldInverse),eR.setFromVector3(DR)}}handlingEvent(e){e=e||jI.getTransformCameraLookingAtTarget(this.view,this.camera);const t=jI.getDiffParams(OR,e);if(t&&(t.range&&this.dispatchEvent({type:"range-changed",previous:t.range.previous,new:t.range.new}),t.coord&&this.dispatchEvent({type:"camera-target-changed",previous:t.coord.previous,new:t.coord.new}),t.tilt||t.heading)){const e={type:"orientation-changed"};t.tilt&&(e.previous={tilt:t.tilt.previous},e.new={tilt:t.tilt.new}),t.heading&&(e.previous=e.previous||{},e.new=e.new||{},e.new.heading=t.heading.new,e.previous.heading=t.heading.previous),this.dispatchEvent(e)}}travel(e){this.player.stop();const t=this.view.getPickingPositionFromDepth(e.viewCoords),n=this.getRange(t);if(t&&n>this.minDistance)return this.lookAtCoordinate({coord:new Jd("EPSG:4978").setFromVector3(t),range:n*("out"===e.direction?1/.6:.6),time:1500})}handleZoom(e){this.player.stop(),jI.stop(this.view,this.camera);const t=e.delta>0?this.zoomInScale:this.zoomOutScale;let n="dolly"===e.type?NR:this.view.getPickingPositionFromDepth(e.viewCoords),i=this.getRange();if(i*=t,n&&i>this.minDistance&&i<this.maxDistance){const e=fR.setFromVector3(dR.position).as("EPSG:4326",mR).toVector3();return n=fR.setFromVector3(n).as("EPSG:4326",mR).toVector3(),e.x*n.x<0&&(e.x-n.x>180?n.x+=360:n.x-e.x>180&&(e.x+=360)),n.lerp(e,t),n=mR.setFromVector3(n).as("EPSG:4978",fR),this.lookAtCoordinate({coord:n,range:i},!1)}}onTouchStart(e){if(this.player.stop(),!1!==this.states.enabled&&(this.state=this.states.touchToState(e.touches.length),this.updateTarget(),this.state!==this.states.NONE)){switch(this.state){case this.states.MOVE_GLOBE:{const t=this.view.eventToViewCoords(e);this.view.getPickingPositionFromDepth(t,wR)?(bR.radius=wR.length(),BR.copy(wR).normalize(),this.updateHelper(wR,SR.picking)):this.state=this.states.NONE;break}case this.states.ORBIT:case this.states.DOLLY:{const t=e.touches[0].pageX,n=e.touches[0].pageY,i=t-e.touches[1].pageX,r=n-e.touches[1].pageY,s=Math.sqrt(i*i+r*r);oR.set(0,s),JI.set(t,n);break}case this.states.PAN:iR.set(e.touches[0].pageX,e.touches[0].pageY)}this.dispatchEvent(this.startEvent)}}onTouchMove(e){if(this.player.isPlaying()&&this.player.stop(),!1!==this.states.enabled){switch(e.preventDefault(),e.stopPropagation(),e.touches.length){case this.states.MOVE_GLOBE.finger:{const t=this.view.eventToViewCoords(e),n=this.view.viewToNormalizedCoords(t);this.camera.updateMatrixWorld(),PR.setFromCamera(n,this.camera),PR.ray.intersectSphere(bR,MR)?(LR.copy(MR).normalize(),uR.setFromUnitVectors(LR,BR),AR=Date.now()):this.onTouchEnd();break}case this.states.ORBIT.finger:case this.states.DOLLY.finger:{const t=this.view.mainLoop.gfxEngine;$I.set(e.touches[0].pageX,e.touches[0].pageY),ZI.subVectors($I,JI),this.rotateLeft(2*Math.PI*ZI.x/t.width*this.rotateSpeed),this.rotateUp(2*Math.PI*ZI.y/t.height*this.rotateSpeed),JI.copy($I);const n=e.touches[0].pageX-e.touches[1].pageX,i=e.touches[0].pageY-e.touches[1].pageY,r=Math.sqrt(n*n+i*i);lR.set(0,r),cR.subVectors(lR,oR),this.dolly(cR.y),oR.copy(lR);break}case this.states.PAN.finger:rR.set(e.touches[0].pageX,e.touches[0].pageY),sR.subVectors(rR,iR),this.mouseToPan(sR.x,sR.y),iR.copy(rR);break;default:this.state=this.states.NONE}this.state!==this.states.NONE&&this.update(this.state)}}onTouchEnd(){this.handleEndMovement({previous:this.state}),this.state=this.states.NONE}dispose(){this.view.domElement.removeEventListener("touchstart",this._onTouchStart,!1),this.view.domElement.removeEventListener("touchend",this._onTouchEnd,!1),this.view.domElement.removeEventListener("touchmove",this._onTouchMove,!1),this.states.dispose(),this.states.removeEventListener("state-changed",this._onStateChange,!1),this.states.removeEventListener(this.states.ORBIT._event,this._onRotation,!1),this.states.removeEventListener(this.states.MOVE_GLOBE._event,this._onDrag,!1),this.states.removeEventListener(this.states.DOLLY._event,this._onDolly,!1),this.states.removeEventListener(this.states.PAN._event,this._onPan,!1),this.states.removeEventListener(this.states.PANORAMIC._event,this._onPanoramic,!1),this.states.removeEventListener("zoom",this._onZoom,!1),this.states.removeEventListener(this.states.TRAVEL_IN._event,this._onTravel,!1),this.states.removeEventListener(this.states.TRAVEL_OUT._event,this._onTravel,!1),this.dispatchEvent({type:"dispose"})}setTilt(e,t){return this.lookAtCoordinate({tilt:e},t)}setHeading(e,t){return this.lookAtCoordinate({heading:e},t)}setRange(e,t){return this.lookAtCoordinate({range:e},t)}getCameraTargetPosition(){return dR.position}getRange(e){return jI.getTransformCameraLookingAtTarget(this.view,this.camera,e).range}getTilt(e){return jI.getTransformCameraLookingAtTarget(this.view,this.camera,e).tilt}getHeading(e){return jI.getTransformCameraLookingAtTarget(this.view,this.camera,e).heading}pan(e){return this.mouseToPan(e.x,e.y),this.update(this.states.PAN),Promise.resolve()}getCameraOrientation(){return this.view.getPickingPositionFromDepth(null,NR),[this.getTilt(NR),this.getHeading(NR)]}getCameraCoordinate(){return new Jd("EPSG:4978").setFromVector3(this.camera.position).as("EPSG:4326")}getLookAtCoordinate(){return jI.getTransformCameraLookingAtTarget(this.view,this.camera).coord}setAnimationEnabled(e){yR=e}isAnimationEnabled(){return yR}getZoom(){return this.view.tileLayer.computeTileZoomFromDistanceCamera(this.getRange(),this.view.camera)}setZoom(e,t){return this.lookAtCoordinate({zoom:e},t)}getScale(e){return console.warn("Deprecated, use View#getScale instead."),this.view.getScale(e)}pixelsToMeters(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.28;return console.warn("Deprecated use View#getPixelsToMeters instead."),e*t/this.getScale(t)/1e3}pixelsToDegrees(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.28;console.warn("Deprecated, use View#getPixelsToMeters and GlobeControls#getMetersToDegrees instead.");const n=this.pixelsToMeters(e,t);return Tt.radToDeg(2*Math.asin(n/(2*Dd.x)))}metersToPixels(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.28;console.warn("Deprecated, use View#getMetersToPixels instead.");const n=this.getScale(t);return t/=1e3,e*n/t}setScale(e,t,n){return this.lookAtCoordinate({scale:e,pitch:t},n)}lookAtCoordinate(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.isAnimationEnabled();if(this.player.stop(),!e.isExtent&&(e.zoom?e.range=this.view.tileLayer.computeDistanceCameraFromTileZoom(e.zoom,this.view.camera):e.scale&&(e.range=this.view.getScaleFromDistance(e.pitch,e.scale),(e.range<this.minDistance||e.range>this.maxDistance)&&(console.warn(`This scale ${e.scale} can not be reached`),e.range=Tt.clamp(e.range,this.minDistance,this.maxDistance))),void 0!==e.tilt)){const t=90-Tt.radToDeg(this.maxPolarAngle),n=90-Tt.radToDeg(this.minPolarAngle);(e.tilt<t||e.tilt>n)&&(e.tilt=Tt.clamp(e.tilt,t,n),console.warn("Tilt was clamped to ",e.tilt,` the interval is between ${t} and ${n} degree`))}return OR=jI.getTransformCameraLookingAtTarget(this.view,this.camera),t?(e.callback=e=>dR.position.copy(e.targetWorldPosition),this.dispatchEvent({type:"animation-started"}),jI.animateCameraToLookAtTarget(this.view,this.camera,e).then((e=>(this.dispatchEvent({type:"animation-ended"}),this.handlingEvent(e),e)))):jI.transformCameraToLookAtTarget(this.view,this.camera,e).then((e=>(dR.position.copy(e.targetWorldPosition),this.handlingEvent(e),e)))}pickGeoPosition(e){const t=this.view.getPickingPositionFromDepth(e);if(t)return new Jd("EPSG:4978").setFromVector3(t).as("EPSG:4326")}},kR={uniforms:{luminance:{type:"f",value:1},turbidity:{type:"f",value:2},reileigh:{type:"f",value:1},mieCoefficient:{type:"f",value:.005},mieDirectionalG:{type:"f",value:.8},v3LightPosition:{type:"v3",value:new sn},up:{type:"v3",value:new sn(0,1,0)}},vertexShader:["varying vec3 vWorldPosition;","void main() {","vec4 worldPosition = modelMatrix *  vec4( cameraPosition + position, 1.0 );","vWorldPosition = worldPosition.xyz;","gl_Position = projectionMatrix * modelViewMatrix * vec4( cameraPosition + position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D skySampler;","uniform vec3 v3LightPosition;","uniform vec3 up;","varying vec3 vWorldPosition;","// uniform sampler2D sDiffuse;","// const float turbidity = 10.0; //","// const float reileigh = 2.; //","// const float luminance = 1.0; //","// const float mieCoefficient = 0.005;","// const float mieDirectionalG = 0.8;","uniform float luminance;","uniform float turbidity;","uniform float reileigh;","uniform float mieCoefficient;","uniform float mieDirectionalG;","// constants for atmospheric scattering","const float e = 2.71828182845904523536028747135266249775724709369995957;","const float pi = 3.141592653589793238462643383279502884197169;","const float n = 1.0003; // refractive index of air","const float N = 2.545E25; // number of molecules per unit volume for air at","// 288.15K and 1013mb (sea level -45 celsius)","const float pn = 0.035; // depolatization factor for standard air","// wavelength of used primaries, according to preetham","const vec3 lambda = vec3(680E-9, 550E-9, 450E-9);","// mie stuff","// K coefficient for the primaries","const vec3 K = vec3(0.686, 0.678, 0.666);","const float v = 4.0;","// optical length at zenith for molecules","const float rayleighZenithLength = 8.4E3;","const float mieZenithLength = 1.25E3;","const float EE = 1000.0;","const float sunAngularDiameterCos = 0.999956676946448443553574619906976478926848692873900859324;","// 66 arc seconds -> degrees, and the cosine of that","// earth shadow hack","const float cutoffAngle = pi/1.95;","const float steepness = 1.5;","vec3 totalRayleigh(vec3 lambda)","{","return (8.0 * pow(pi, 3.0) * pow(pow(n, 2.0) - 1.0, 2.0) * (6.0 + 3.0 * pn)) / (3.0 * N * pow(lambda, vec3(4.0)) * (6.0 - 7.0 * pn));","}","// A simplied version of the total Reayleigh scattering to works on browsers that use ANGLE","vec3 simplifiedRayleigh()","{","return 0.0005 / vec3(94, 40, 18);","}","float rayleighPhase(float cosTheta)","{ ","return (3.0 / (16.0*pi)) * (1.0 + pow(cosTheta, 2.0));","// return (1.0 / (3.0*pi)) * (1.0 + pow(cosTheta, 2.0));","// return (3.0 / 4.0) * (1.0 + pow(cosTheta, 2.0));","}","vec3 totalMie(vec3 lambda, vec3 K, float T)","{","float c = (0.2 * T ) * 10E-18;","return 0.434 * c * pi * pow((2.0 * pi) / lambda, vec3(v - 2.0)) * K;","}","float hgPhase(float cosTheta, float g)","{","return (1.0 / (4.0*pi)) * ((1.0 - pow(g, 2.0)) / pow(1.0 - 2.0*g*cosTheta + pow(g, 2.0), 1.5));","}","float sunIntensity(float zenithAngleCos)","{","return EE * max(0.0, 1.0 - exp(-((cutoffAngle - acos(zenithAngleCos))/steepness)));","}","// float logLuminance(vec3 c)","// {","//     return log(c.r * 0.2126 + c.g * 0.7152 + c.b * 0.0722);","// }","// Filmic ToneMapping http://filmicgames.com/archives/75","float A = 0.15;","float B = 0.50;","float C = 0.10;","float D = 0.20;","float E = 0.02;","float F = 0.30;","float W = 1000.0;","vec3 Uncharted2Tonemap(vec3 x)","{","return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;","}","void main() ","{","vec3 up2 = normalize(cameraPosition.xyz);","float sunfade = 1.0-clamp(1.0-exp((v3LightPosition.y/450000.0)),0.0,1.0);","float reileighCoefficient = reileigh - (1.0* (1.0-sunfade));","vec3 sunDirection = normalize(v3LightPosition);","float sunE = sunIntensity(dot(sunDirection, up2));","// extinction (absorbtion + out scattering) ","// rayleigh coefficients","vec3 betaR = simplifiedRayleigh() * reileighCoefficient;","// mie coefficients","vec3 betaM = totalMie(lambda, K, turbidity) * mieCoefficient;","// optical length","// cutoff angle at 90 to avoid singularity in next formula.","float zenithAngle = acos(max(0.0, dot(up2, normalize(vWorldPosition - cameraPosition))));","float sR = rayleighZenithLength / (cos(zenithAngle) + 0.15 * pow(93.885 - ((zenithAngle * 180.0) / pi), -1.253));","float sM = mieZenithLength / (cos(zenithAngle) + 0.15 * pow(93.885 - ((zenithAngle * 180.0) / pi), -1.253));","// combined extinction factor","vec3 Fex = exp(-(betaR * sR + betaM * sM));","// in scattering","float cosTheta = dot(normalize(vWorldPosition - cameraPosition), sunDirection);","float rPhase = rayleighPhase(cosTheta*0.5+0.5);","vec3 betaRTheta = betaR * rPhase;","float mPhase = hgPhase(cosTheta, mieDirectionalG);","vec3 betaMTheta = betaM * mPhase;","vec3 Lin = pow(sunE * ((betaRTheta + betaMTheta) / (betaR + betaM)) * (1.0 - Fex),vec3(1.5));","Lin *= mix(vec3(1.0),pow(sunE * ((betaRTheta + betaMTheta) / (betaR + betaM)) * Fex,vec3(1.0/2.0)),clamp(pow(1.0-dot(up2, sunDirection),5.0),0.0,1.0));","//nightsky","vec3 direction = normalize(vWorldPosition - cameraPosition);","float theta = acos(direction.y); // elevation --\x3e y-axis, [-pi/2, pi/2]","float phi = atan(direction.z, direction.x); // azimuth --\x3e x-axis [-pi/2, pi/2]","vec2 uv = vec2(phi, theta) / vec2(2.0*pi, pi) + vec2(0.5, 0.0);","// vec3 L0 = texture2D(skySampler, uv).rgb+0.1 * Fex;","vec3 L0 = vec3(0.1) * Fex;","// composition + solar disc","//if (cosTheta > sunAngularDiameterCos)","float sundisk = smoothstep(sunAngularDiameterCos,sunAngularDiameterCos+0.00002,cosTheta);","// if (normalize(vWorldPosition - cameraPosition).y>0.0)","L0 += (sunE * 19000.0 * Fex)*sundisk;","vec3 whiteScale = 1.0/Uncharted2Tonemap(vec3(W));","vec3 texColor = (Lin+L0);   ","texColor *= 0.04 ;","texColor += vec3(0.0,0.001,0.0025)*0.3;","float g_fMaxLuminance = 1.0;","float fLumScaled = 0.1 / luminance;     ","float fLumCompressed = (fLumScaled * (1.0 + (fLumScaled / (g_fMaxLuminance * g_fMaxLuminance)))) / (1.0 + fLumScaled); ","float ExposureBias = fLumCompressed;","vec3 curr = Uncharted2Tonemap((log2(2.0/pow(luminance,4.0)))*texColor);","vec3 color = curr*whiteScale;","vec3 retColor = pow(color,vec3(1.0/(1.2+(1.2*sunfade))));","gl_FragColor.rgb = retColor;","gl_FragColor.a = 1. - ( (length(cameraPosition) - 6400000.) / 1000.);","}"].join("\n")},QR=class extends ir{constructor(){const e=cr.clone(kR.uniforms),t=new hr({fragmentShader:kR.fragmentShader,vertexShader:kR.vertexShader,uniforms:e,side:s,transparent:!0,depthWrite:!1});super(new yl(4e4,32,15),t)}},zR="#include <logdepthbuf_pars_fragment>\n\nuniform int atmoIN;\nvarying float intensity;\n\nvec4 glowColor = vec4(0.45, 0.74, 1. ,1.0);\n\nvoid main() {\n    #include <logdepthbuf_fragment>\n    gl_FragColor = glowColor * intensity;\n}\n\n",GR="#include <common>\n#include <logdepthbuf_pars_vertex>\n\nuniform int atmoIN;\nvarying float intensity;\n\nvoid main()\n{\n    vec3 normalES    = normalize( normalMatrix * normal );\n    vec3 normalCAMES = normalize( normalMatrix * cameraPosition );\n\n    if(atmoIN == 0) {\n        intensity = pow(0.666 - dot(normalES, normalCAMES), 4. );\n    } else {\n        intensity = pow( 1.  - dot(normalES, normalCAMES), 0.8 );\n    }\n\n    gl_Position = projectionMatrix * modelViewMatrix * vec4( position,  1.0 );\n\n    #include <logdepthbuf_vertex>\n}\n\n\n",HR=new sn(1,0,0),VR=new sn,jR=new Jd("EPSG:4326"),qR=new Jd("EPSG:4326"),WR=new Ci(9688568),YR=new Ci,XR=new Ci(197896),KR=6e5,JR=160*Dd.x,$R=class extends px{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"atmosphere",t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};t.source=!1,super(e,new li,t),this.isAtmosphere=!0;const n=new hr({uniforms:{atmoIN:{type:"i",value:0},screenSize:{type:"v2",value:new It(window.innerWidth,window.innerHeight)}},vertexShader:GR,fragmentShader:zR,side:s,blending:c,transparent:!0,wireframe:!1}),i=new yl(1,64,64),a=new ir(i,n);a.scale.copy(Dd).multiplyScalar(1.14),this.basicAtmosphere=new li,this.realisticAtmosphere=new li,this.realisticAtmosphere.visible=!1,this.object3d.add(this.basicAtmosphere),this.object3d.add(this.realisticAtmosphere),this.basicAtmosphere.add(a);const o=new hr({uniforms:{atmoIN:{type:"i",value:1},screenSize:{type:"v2",value:new It(window.innerWidth,window.innerHeight)}},vertexShader:GR,fragmentShader:zR,side:r,blending:c,transparent:!0,depthWrite:!1}),l=new ir(i,o);l.scale.copy(Dd).multiplyScalar(1.002),this.basicAtmosphere.add(l),this.realisticLightingPosition={x:-.5,y:0,z:1},this.fog={enable:!0,distance:JR},this.realisticAtmosphereInitParams=t.Kr?t:{Kr:.0025,Km:.0015,ESun:20,g:-.95,innerRadius:64e5,outerRadius:67e5,wavelength:[.65,.57,.475],scaleDepth:.25},this.object3d.updateMatrixWorld()}update(e,t,n){n.material.fogDistance=this.fog.distance,n.material.lightingEnabled=this.realisticAtmosphere.visible,n.material.lightPosition=this.realisticLightingPosition}preUpdate(e){const t=e.view.camera3D.position;if(this.fog.enable){VR.setFromMatrixPosition(e.view.tileLayer.object3d.matrixWorld);const n=VR.distanceTo(t);this.fog.distance=JR*(.25*(n-.99*Dd.x)/Dd.x)**1.5}else this.fog.distance=1e11;const n=e.view.mainLoop.gfxEngine.renderer;jR.crs=e.view.referenceCrs,jR.setFromVector3(t).as("EPSG:4326",qR);const i=qR.altitude;i<KR?(YR.copy(XR).lerp(WR,(KR-i)/KR),n.setClearColor(YR,n.getClearAlpha())):n.setClearColor(XR,n.getClearAlpha())}_initRealisticLighning(){const e=this.realisticAtmosphereInitParams,t={v3LightPosition:{value:HR.clone().normalize()},v3InvWavelength:{value:new sn(1/e.wavelength[0]**4,1/e.wavelength[1]**4,1/e.wavelength[2]**4)},fCameraHeight:{value:0},fCameraHeight2:{value:0},fInnerRadius:{value:e.innerRadius},fInnerRadius2:{value:e.innerRadius*e.innerRadius},fOuterRadius:{value:e.outerRadius},fOuterRadius2:{value:e.outerRadius*e.outerRadius},fKrESun:{value:e.Kr*e.ESun},fKmESun:{value:e.Km*e.ESun},fKr4PI:{value:4*e.Kr*Math.PI},fKm4PI:{value:4*e.Km*Math.PI},fScale:{value:1/(e.outerRadius-e.innerRadius)},fScaleDepth:{value:e.scaleDepth},fScaleOverScaleDepth:{value:1/(e.outerRadius-e.innerRadius)/e.scaleDepth},g:{value:e.g},g2:{value:e.g*e.g},nSamples:{value:3},fSamples:{value:3},tDisplacement:{value:new Jt},tSkyboxDiffuse:{value:new Jt},fNightScale:{value:1}},n=new yl(e.innerRadius,50,50),i=new hr({uniforms:t,vertexShader:"uniform vec3 v3LightPosition;   // The direction vector to the light source\nuniform vec3 v3InvWavelength;   // 1 / pow(wavelength, 4) for the red, green, and blue channels\nuniform float fCameraHeight;    // The camera's current height\nuniform float fCameraHeight2;   // fCameraHeight^2\nuniform float fOuterRadius;     // The outer (atmosphere) radius\nuniform float fOuterRadius2;    // fOuterRadius^2\nuniform float fInnerRadius;     // The inner (planetary) radius\nuniform float fInnerRadius2;    // fInnerRadius^2\nuniform float fKrESun;          // Kr * ESun\nuniform float fKmESun;          // Km * ESun\nuniform float fKr4PI;           // Kr * 4 * PI\nuniform float fKm4PI;           // Km * 4 * PI\nuniform float fScale;           // 1 / (fOuterRadius - fInnerRadius)\nuniform float fScaleDepth;      // The scale depth (i.e. the altitude at which the atmosphere's average density is found)\nuniform float fScaleOverScaleDepth; // fScale / fScaleDepth\n\nvarying vec3 c0;\nvarying vec3 c1;\n\nconst int nSamples = 3;\nconst float fSamples = 3.0;\n\nfloat scale(float fCos)\n{\n    float x = 1.0 - fCos;\n    return fScaleDepth * exp(-0.00287 + x*(0.459 + x*(3.83 + x*(-6.80 + x*5.25))));\n}\n\nvoid main(void) {\n\n     float cameraHeight2 = length(cameraPosition) * length(cameraPosition);\n\n    // Get the ray from the camera to the vertex and its length (which is the far point of the ray passing through the atmosphere)\n    vec3 v3Ray = position - cameraPosition;\n    float fFar = length(v3Ray);\n    v3Ray /= fFar;\n\n    // Calculate the closest intersection of the ray with the outer atmosphere (which is the near point of the ray passing through the atmosphere)\n    float B = 2.0 * dot(cameraPosition, v3Ray);\n    float C = cameraHeight2 - fOuterRadius2;\n    float fDet = max(0.0, B*B - 4.0 * C);\n    float fNear = 0.5 * (-B - sqrt(fDet));\n\n    // Calculate the ray's starting position, then calculate its scattering offset\n    vec3 v3Start = cameraPosition + v3Ray * fNear;\n    fFar -= fNear;\n    float fDepth = exp((fInnerRadius - fOuterRadius) / fScaleDepth);\n    float fCameraAngle = dot(-v3Ray, position) / length(position);\n    float fLightAngle = dot(v3LightPosition, position) / length(position);\n    float fCameraScale = scale(fCameraAngle);\n    float fLightScale = scale(fLightAngle);\n    float fCameraOffset = fDepth*fCameraScale;\n    float fTemp = (fLightScale + fCameraScale);\n\n    // Initialize the scattering loop variables\n    float fSampleLength = fFar / fSamples;\n    float fScaledLength = fSampleLength * fScale;\n    vec3 v3SampleRay = v3Ray * fSampleLength;\n    vec3 v3SamplePoint = v3Start + v3SampleRay * 0.5;\n\n    // Now loop through the sample rays\n    vec3 v3FrontColor = vec3(0.0, 0.0, 0.0);\n    vec3 v3Attenuate = vec3(0.0, 0.0, 0.0);\n    for(int i=0; i<nSamples; i++)\n    {\n        float fHeight = length(v3SamplePoint);\n        float fDepth = exp(fScaleOverScaleDepth * (fInnerRadius - fHeight));\n        float fScatter = fDepth*fTemp - fCameraOffset;\n        v3Attenuate = exp(-fScatter * (v3InvWavelength * fKr4PI + fKm4PI));\n        v3FrontColor += v3Attenuate * (fDepth * fScaledLength);\n        v3SamplePoint += v3SampleRay;\n    }\n\n    // Calculate the attenuation factor for the ground\n    c0 = v3Attenuate;\n    c1 = v3FrontColor * (v3InvWavelength * fKrESun + fKmESun);\n\n    gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",fragmentShader:"varying vec3 c0;\nvarying vec3 c1;\n\nvoid main (void) {\n\tgl_FragColor = vec4(c1, 1.0 - c0/4.);\n}",blending:c,transparent:!0,depthTest:!1,depthWrite:!1}),r=new ir(n,i),a=new yl(e.outerRadius,196,196),o=new hr({uniforms:t,vertexShader:"uniform vec3 v3LightPosition;   // The direction vector to the light source\nuniform vec3 v3InvWavelength;   // 1 / pow(wavelength, 4) for the red, green, and blue channels\nuniform float fCameraHeight;    // The camera's current height\nuniform float fCameraHeight2;   // fCameraHeight^2\nuniform float fOuterRadius;     // The outer (atmosphere) radius\nuniform float fOuterRadius2;    // fOuterRadius^2\nuniform float fInnerRadius;     // The inner (planetary) radius\nuniform float fInnerRadius2;    // fInnerRadius^2\nuniform float fKrESun;          // Kr * ESun\nuniform float fKmESun;          // Km * ESun\nuniform float fKr4PI;           // Kr * 4 * PI\nuniform float fKm4PI;           // Km * 4 * PI\nuniform float fScale;           // 1 / (fOuterRadius - fInnerRadius)\nuniform float fScaleDepth;      // The scale depth (i.e. the altitude at which the atmosphere's average density is found)\nuniform float fScaleOverScaleDepth; // fScale / fScaleDepth\n\nconst int nSamples = 3;\nconst float fSamples = 3.0;\n\nvarying vec3 v3Direction;\nvarying vec3 c0;\nvarying vec3 c1;\n\nfloat scale(float fCos) {\n    float x = 1.0 - fCos;\n    return fScaleDepth * exp(-0.00287 + x*(0.459 + x*(3.83 + x*(-6.80 + x*5.25))));\n}\n\nvoid main(void) {\n    float lengthCamera = length(cameraPosition);\n    float cameraHeight2 = lengthCamera * lengthCamera;\n\n    // Get the ray from the camera to the vertex and its length (which is the far point of the ray passing through the atmosphere)\n    vec3 v3Ray = position - cameraPosition;\n    float fFar = length(v3Ray);\n    v3Ray /= fFar;\n\n    // Calculate the closest intersection of the ray with the outer atmosphere (which is the near point of the ray passing through the atmosphere)\n    float B = 2.0 * dot(cameraPosition, v3Ray);\n    float C = cameraHeight2 - fOuterRadius2;\n    float fDet = max(0.0, B*B - 4.0 * C);\n    float fNear = 0.5 * (-B - sqrt(fDet));\n\n    // Calculate the ray's starting position, then calculate its scattering offset\n    vec3 v3Start = cameraPosition + v3Ray * fNear;\n    fFar -= fNear;\n    float fStartAngle = dot(v3Ray, v3Start) / fOuterRadius;\n    float fStartDepth = exp(-1.0 / fScaleDepth);\n    float fStartOffset = fStartDepth * scale(fStartAngle);\n\n    // Initialize the scattering loop variables\n    float fSampleLength = fFar / fSamples;\n    float fScaledLength = fSampleLength * fScale;\n    vec3 v3SampleRay = v3Ray * fSampleLength;\n    vec3 v3SamplePoint = v3Start + v3SampleRay * 0.5;\n\n    // Now loop through the sample rays\n    vec3 v3FrontColor = vec3(0.0, 0.0, 0.0);\n    for(int i=0; i<nSamples; i++)\n    {\n        float fHeight = length(v3SamplePoint);\n        float fDepth = exp(fScaleOverScaleDepth * (fInnerRadius - fHeight));\n        float fLightAngle = dot(v3LightPosition, v3SamplePoint) / fHeight;\n        float fCameraAngle = dot(v3Ray, v3SamplePoint) / fHeight;\n        float fScatter = (fStartOffset + fDepth * (scale(fLightAngle) - scale(fCameraAngle)));\n        vec3 v3Attenuate = exp(-fScatter * (v3InvWavelength * fKr4PI + fKm4PI));\n\n        v3FrontColor += v3Attenuate * (fDepth * fScaledLength);\n        v3SamplePoint += v3SampleRay;\n    }\n\n    // Finally, scale the Mie and Rayleigh colors and set up the varying variables for the pixel shader\n    gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n    c0 = v3FrontColor * (v3InvWavelength * fKrESun);\n    c1 = v3FrontColor * fKmESun;\n    v3Direction = cameraPosition - position;\n}",fragmentShader:"uniform vec3 v3LightPos;\nuniform float g;\nuniform float g2;\n\nvarying vec3 v3Direction;\nvarying vec3 c0;\nvarying vec3 c1;\n\n// Calculates the Mie phase function\nfloat getMiePhase(float fCos, float fCos2, float g, float g2) {\n    return 1.5 * ((1.0 - g2) / (2.0 + g2)) * (1.0 + fCos2) / pow(1.0 + g2 - 2.0 * g * fCos, 1.5);\n}\n\n// Calculates the Rayleigh phase function\nfloat getRayleighPhase(float fCos2) {\n    return 0.75 + 0.75 * fCos2;\n}\n\nvoid main (void) {\n    float fCos = dot(v3LightPos, v3Direction) / length(v3Direction);\n    float fCos2 = fCos * fCos;\n\n    vec3 color = getRayleighPhase(fCos2) * c0 + getMiePhase(fCos, fCos2, g, g2) * c1;\n\n    gl_FragColor = vec4(color, 1.0);\n    gl_FragColor.a = gl_FragColor.b;\n}",transparent:!0,side:s}),l=new ir(a,o),h=new QR;h.frustumCulled=!1,this.realisticAtmosphere.add(r),this.realisticAtmosphere.add(l),this.realisticAtmosphere.add(h);h.material.uniforms.turbidity.value=10,h.material.uniforms.reileigh.value=2,h.material.uniforms.luminance.value=1,h.material.uniforms.mieCoefficient.value=.005,h.material.uniforms.mieDirectionalG.value=.8,h.material.uniforms.up.value=new sn}setRealisticOn(e){e&&(this.realisticAtmosphere.children.length||this._initRealisticLighning(),this.realisticLightingPosition=pp.getSunPositionInScene((new Date).getTime(),48.85,2.35).normalize(),this.realisticAtmosphere.children.forEach((e=>e.material.uniforms.v3LightPosition.value.copy(this.realisticLightingPosition)))),this.basicAtmosphere.visible=!e,this.realisticAtmosphere.visible=e}};iI.INITIALIZED,iI.LAYER_ADDED,iI.LAYER_REMOVED,iI.COLOR_LAYERS_ORDER_CHANGED;function ZR(e,t,n,i,r){if(t.layerUpdateState[n.id])if(e.isCancelledCommandException)t.layerUpdateState[n.id].success();else if(e instanceof SyntaxError)t.layerUpdateState[n.id].failure(0,!0);else{const e=t.layerUpdateState[n.id].errorCount>4;t.layerUpdateState[n.id].failure(Date.now(),e,{targetLevel:i}),e||window.setTimeout((()=>{r.notifyChange(t,!1)}),1e3*t.layerUpdateState[n.id].secondsUntilNextTry())}}function eB(e){return!(e.requester.parent&&e.requester.material&&!(e.layer.isElevationLayer&&e.requester.material.getElevationLayer()&&e.targetLevel<=e.requester.material.getElevationLayer().level)&&e.requester.layerUpdateState[e.layer.id]&&e.layer.source._featuresCaches[e.layer.crs]&&e.requester.material.visible)}function tB(e,t,n,i,r){return{view:e,layer:t,extentsSource:n,extentsDestination:i,requester:r,priority:(s=r.material,s.visible?100:10),earlyDropFunction:eB,partialLoading:!0};var s}function nB(e,t){return t.map(((t,n)=>t.offsetToParent(e[n].extent)))}function iB(e){return function(t){t.material?.removeLayer&&(t.material.elevationLayerIds.indexOf(e)>-1&&t.setBBoxZ({min:0,max:0}),t.material.removeLayer(e)),t.layerUpdateState&&t.layerUpdateState[e]&&delete t.layerUpdateState[e]}}i.LEFT,i.MIDDLE,i.RIGHT,new sn,new rn,new sn,new sn,new It,new It,new It(0,0),new sn,new sn,new sn,new sn(0,0,0),new sn,new rn,new It,new sn,new sn,new rn,new rn,new bc,new br(new sn(0,0,-1)),new rn,new sn,new Jd("EPSG:4326",0,0,0),new sn,new sn(0,1,0),new sn,new rn,new jn(0,0,0,"YXZ"),new Bi({color:16777215,depthTest:!1,transparent:!0,opacity:.5}),new sn,new sn,new Rt,new sn,new rn,new Jd("EPSG:4326",0,0,0),new Y_,new J_,new It,new It,new sn,new sn,new sn,new sn,new up("EPSG:4326",0,0,0,0),new Ci;const rB={color_layers_pars_fragment:"struct Layer {\n    int textureOffset;\n    int crs;\n    int effect_type;\n    float effect_parameter;\n    float opacity;\n    bool transparent;\n};\n\n#include <itowns/custom_header_colorLayer>\n\nuniform sampler2D   colorTextures[NUM_FS_TEXTURES];\nuniform vec4        colorOffsetScales[NUM_FS_TEXTURES];\nuniform Layer       colorLayers[NUM_FS_TEXTURES];\nuniform int         colorTextureCount;\n\nvec3 uvs[NUM_CRS];\n\nfloat getBorderDistance(vec2 uv) {\n    vec2 p2 = min(uv, 1. -uv);\n    return min(p2.x, p2.y);\n}\n\nfloat tolerance = 0.99;\n\nvec4 applyWhiteToInvisibleEffect(vec4 color) {\n    float a = dot(color.rgb, vec3(0.333333333));\n    if (a >= tolerance) {\n        color.a = 0.0;\n    }\n    return color;\n}\n\nvec4 applyLightColorToInvisibleEffect(vec4 color, float intensity) {\n    float a = max(0.05,1. - length(color.xyz - 1.));\n    color.a *= 1.0 - pow(abs(a), intensity);\n    color.rgb *= color.rgb * color.rgb;\n    return color;\n}\n\n#if defined(DEBUG)\nuniform bool showOutline;\nuniform vec3 outlineColors[NUM_CRS];\nuniform float outlineWidth;\n\nvec4 getOutlineColor(vec3 outlineColor, vec2 uv) {\n    float alpha = 1. - clamp(getBorderDistance(uv) / outlineWidth, 0., 1.);\n    return vec4(outlineColor, alpha);\n}\n#endif\n\nuniform float minBorderDistance;\nvec4 getLayerColor(int textureOffset, sampler2D tex, vec4 offsetScale, Layer layer) {\n    if ( textureOffset >= colorTextureCount ) return vec4(0);\n\n    vec3 uv;\n    // #pragma unroll_loop\n    for ( int i = 0; i < NUM_CRS; i ++ ) {\n        if ( i == layer.crs ) uv = uvs[ i ];\n    }\n\n    float borderDistance = getBorderDistance(uv.xy);\n    if (textureOffset != layer.textureOffset + int(uv.z) || borderDistance < minBorderDistance ) return vec4(0);\n    vec4 color = texture2D(tex, pitUV(uv.xy, offsetScale));\n    if (layer.effect_type == 3) {\n        #include <itowns/custom_body_colorLayer>\n    } else {\n        if (layer.transparent && color.a != 0.0) {\n            color.rgb /= color.a;\n        }\n\n        if (layer.effect_type == 1) {\n            color = applyLightColorToInvisibleEffect(color, layer.effect_parameter);\n        } else if (layer.effect_type == 2) {\n            color = applyWhiteToInvisibleEffect(color);\n        }\n    }\n    color.a *= layer.opacity;\n    return color;\n}\n",custom_body_colorLayer:"// no custom body",custom_header_colorLayer:"// no custom header",elevation_pars_vertex:"#if NUM_VS_TEXTURES > 0\n    struct Layer {\n        float scale;\n        float bias;\n        int mode;\n        float zmin;\n        float zmax;\n    };\n\n    uniform Layer       elevationLayers[NUM_VS_TEXTURES];\n    uniform sampler2D   elevationTextures[NUM_VS_TEXTURES];\n    uniform vec4        elevationOffsetScales[NUM_VS_TEXTURES];\n    uniform int         elevationTextureCount;\n    uniform float       geoidHeight;\n\n    highp float decode32(highp vec4 rgba) {\n        highp float Sign = 1.0 - step(128.0,rgba[0])*2.0;\n        highp float Exponent = 2.0 * mod(rgba[0],128.0) + step(128.0,rgba[1]) - 127.0;\n        highp float Mantissa = mod(rgba[1],128.0)*65536.0 + rgba[2]*256.0 +rgba[3] + float(0x800000);\n        highp float Result =  Sign * exp2(Exponent) * (Mantissa * exp2(-23.0 ));\n        return Result;\n    }\n\n    float getElevationMode(vec2 uv, sampler2D tex, int mode) {\n        if (mode == ELEVATION_RGBA)\n            return decode32(texture2D( tex, uv ).abgr * 255.0);\n        if (mode == ELEVATION_DATA || mode == ELEVATION_COLOR)\n            return texture2D( tex, uv ).r;\n        return 0.;\n    }\n\n    float getElevation(vec2 uv, sampler2D tex, vec4 offsetScale, Layer layer) {\n        // Elevation textures are inverted along the y-axis\n        uv = vec2(uv.x, 1.0 - uv.y);\n        uv = uv * offsetScale.zw + offsetScale.xy;\n        float d = clamp(getElevationMode(uv, tex, layer.mode), layer.zmin, layer.zmax);\n        return d * layer.scale + layer.bias;\n    }\n#endif\n",elevation_vertex:"#if NUM_VS_TEXTURES > 0\n    if(elevationTextureCount > 0) {\n        float elevation = getElevation(uv, elevationTextures[0], elevationOffsetScales[0], elevationLayers[0]);\n        transformed += elevation * normal;\n    }\n#endif\n",geoid_vertex:"transformed += geoidHeight * normal;\n",fog_fragment:"#if defined(USE_FOG)\n    float fogFactor = 1. - min( exp(-vFogDepth / fogDistance), 1.);\n    gl_FragColor.rgb = mix(gl_FragColor.rgb, fogColor, fogFactor);\n#endif\n",fog_pars_fragment:"#if defined(USE_FOG)\nuniform vec3  fogColor;\nuniform float fogDistance;\nvarying float vFogDepth;\n#endif\n",lighting_fragment:"if (lightingEnabled) {\n    float light = min(2. * dot(vNormal, lightPosition), 1.);\n    gl_FragColor.rgb *= light;\n}\n",lighting_pars_fragment:"uniform bool lightingEnabled;\nuniform vec3 lightPosition;\nvarying vec3 vNormal;\n",mode_depth_fragment:"#if defined(USE_LOGDEPTHBUF)\ngl_FragColor = packDepthToRGBA(gl_FragDepthEXT);\n#else\nfloat fragCoordZ = 0.5 * vHighPrecisionZW[0] / vHighPrecisionZW[1] + 0.5;\ngl_FragColor = packDepthToRGBA(fragCoordZ);\n#endif\n",mode_id_fragment:"// 16777216.0 == 256.0 * 256.0 * 256.0\ngl_FragColor = packDepthToRGBA(float(objectId) / 16777216.0);\n",mode_pars_fragment:"#if MODE == MODE_ID || MODE == MODE_DEPTH\n#include <packing>\n#endif\n\n#if MODE == MODE_ID\nuniform int objectId;\n#endif\n",overlay_fragment:"gl_FragColor.rgb = mix(gl_FragColor.rgb, overlayColor, overlayAlpha);\n",overlay_pars_fragment:"uniform vec3  overlayColor;\nuniform float overlayAlpha;\n",pitUV:"vec2 pitUV(vec2 uv, vec4 pit)\n{\n    return uv * pit.zw + vec2(pit.x, 1.0 - pit.w - pit.y);\n}\n\n",precision_qualifier:"precision highp float;\nprecision highp int;\n",projective_texturing_vertex:"for(int i = 0; i < ORIENTED_IMAGES_COUNT; ++i)\n    projectiveTextureCoords[i] = projectiveTextureMatrix[i] * mvPosition;\n",projective_texturing_pars_vertex:"uniform mat4 projectiveTextureMatrix[ORIENTED_IMAGES_COUNT];\nvarying vec4 projectiveTextureCoords[ORIENTED_IMAGES_COUNT];\n",projective_texturing_pars_fragment:"uniform sampler2D projectiveTexture[ORIENTED_IMAGES_COUNT];\nuniform sampler2D mask[ORIENTED_IMAGES_COUNT];\nvarying vec4      projectiveTextureCoords[ORIENTED_IMAGES_COUNT];\nuniform float     projectiveTextureAlphaBorder;\nuniform float     opacity;\nuniform bool      boostLight;\n\nstruct Distortion {\n    vec2 size;\n#if USE_DISTORTION\n    vec2 pps;\n    vec4 polynom;\n    vec3 l1l2;\n#endif\n};\n\nuniform Distortion projectiveTextureDistortion[ORIENTED_IMAGES_COUNT];\n\nfloat getAlphaBorder(vec2 p)\n{\n    vec2 d = clamp(projectiveTextureAlphaBorder * min(p, 1. - p), 0., 1.);\n    return min(d.x, d.y);\n}\n\n#if USE_DISTORTION\nvoid distort(inout vec2 p, vec4 polynom, vec2 pps)\n{\n    vec2 v = p - pps;\n    float v2 = dot(v, v);\n    if (v2 > polynom.w) {\n        p = vec2(-1.);\n    }\n    else {\n        p += (v2 * (polynom.x + v2 * (polynom.y + v2 * polynom.z) ) ) * v;\n    }\n}\n\nvoid distort(inout vec2 p, vec4 polynom, vec3 l1l2, vec2 pps)\n{\n    if ((l1l2.x == 0.) && (l1l2.y == 0.)) {\n        distort(p, polynom, pps);\n    } else {\n        vec2 AB = (p - pps) / l1l2.z;\n        float R = length(AB);\n        float lambda = atan(R) / R;\n        vec2 ab = lambda * AB;\n        float rho2 = dot(ab, ab);\n        float r357 = 1. + rho2* (polynom.x + rho2* (polynom.y + rho2 * polynom.z));\n        p = pps + l1l2.z * (r357 * ab + vec2(dot(l1l2.xy, ab), l1l2.y * ab.x));\n    }\n}\n#endif\n\nvec4 mixBaseColor(vec4 aColor, vec4 baseColor) {\n    #ifdef USE_BASE_MATERIAL\n        baseColor.rgb = aColor.a == 1.0 ? aColor.rgb : mix(baseColor, aColor, aColor.a).rgb;\n        baseColor.a = min(1.0, aColor.a + baseColor.a);\n    #else\n        baseColor.rgb += aColor.rgb * aColor.a;\n        baseColor.a += aColor.a;\n    #endif\n    return baseColor;\n}\n\nvec4 projectiveTextureColor(vec4 coords, Distortion distortion, sampler2D tex, sampler2D mask, vec4 baseColor) {\n    vec3 p = coords.xyz / coords.w;\n    if(p.z * p.z < 1.) {\n#if USE_DISTORTION\n        p.xy *= distortion.size;\n        distort(p.xy, distortion.polynom, distortion.l1l2, distortion.pps);\n        p.xy /= distortion.size;\n#endif\n\n        float d = getAlphaBorder(p.xy) * texture2D(mask, p.xy).r;\n\n        if(d > 0.) {\n\n#if DEBUG_ALPHA_BORDER\n        vec3 r = texture2D(tex, p.xy).rgb;\n        return mixBaseColor(vec4( r.r * d, r.g, r.b, 1.0), baseColor);\n#else\n        vec4 color = texture2D(tex, p.xy);\n        color.a *= d;\n        if (boostLight) {\n            return mixBaseColor(vec4(sqrt(color.rgb), color.a), baseColor);\n        } else {\n            return mixBaseColor(color, baseColor);\n        }\n#endif\n\n        }\n    }\n    return mixBaseColor(vec4(0.), baseColor);\n}\n"};new class{constructor(e,t){this.path=t,this.target=e,this.install()}customHeaderColorLayer(e){rB.custom_header_colorLayer=e,this.target[`${this.path}custom_header_colorLayer`]=e}customBodyColorLayer(e){rB.custom_body_colorLayer=e,this.target[`${this.path}custom_body_colorLayer`]=e}install(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.target,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:rB,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.path;return Object.keys(t).forEach((i=>{Object.defineProperty(this,i,{get:()=>t[i]}),e[n+i]=t[i]})),e}}(Rr,"itowns/");const sB=new J_,aB=new Y_;let oB;function lB(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[{offset:0,count:1}],i=arguments.length>3?arguments[3]:void 0,r=arguments.length>4?arguments[4]:void 0,s=arguments.length>5?arguments[5]:void 0,a=arguments.length>6?arguments[6]:void 0;if(0===t.length)return;const o=new Path2D;for(const e of n)if(e.extent&&up.intersectsExtent(e.extent,r)){const n=e.offset*i,r=n+e.count*i;o.moveTo(t[n],t[n+1]);for(let e=n+i;e<r;e+=i)o.lineTo(t[e],t[e+1])}oB.applyToCanvasPolygon(e,o,s,a)}function cB(e,t,n,i){e.beginPath();const r=null==oB.point.opacity?1:oB.point.opacity;r!==e.globalAlpha&&(e.globalAlpha=r),e.arc(t,n,(oB.point.radius||3)*i,0,2*Math.PI,!1),oB.point.color&&(e.fillStyle=oB.point.color,e.fill()),oB.point.line&&(e.lineWidth=(oB.point.width||1)*i,e.strokeStyle=oB.point.line,e.stroke())}const hB=new Jd("EPSG:4326",0,0,0);function uB(e,t,n,i){const r=n.planarDimensions().x/e.canvas.width;for(const s of t.geometries)if(up.intersectsExtent(s.extent,n)){if(aB.setGeometry(s),oB.zoom.min>oB.context.zoom||oB.zoom.max<=oB.context.zoom)return;if(t.type===dy.POINT&&oB.point){const a=(Math.round(oB.point.radius*i)||3*i)*r;for(const r of s.indices){const s=r.offset*t.size,o=s+r.count*t.size;for(let r=s;r<o;r+=t.size)hB.setFromArray(t.vertices,r),n.isPointInside(hB,a)&&cB(e,t.vertices[r],t.vertices[r+1],i)}}else lB(e,t.vertices,s.indices,t.size,n,i,t.type==dy.POLYGON)}}const dB=new sn,pB=new sn(0,0,1),fB=new sn,mB=new rn,gB=new Nn,AB=new Nn,yB=new sn,vB=new up("EPSG:4326",0,0,0,0),_B={createTextureFromFeature(e,t,n,i,r){let s;if(oB=i||sB,oB.setContext(aB),e){t.planarDimensions(pB);const a=document.createElement("canvas");hB.crs=t.crs,a.width=n,a.height=n;const o=a.getContext("2d",{willReadFrequently:!0});r&&(o.fillStyle=r.getStyle(),o.fillRect(0,0,n,n)),o.globalCompositeOperation=i.globalCompositeOperation||"source-over",o.imageSmoothingEnabled=!1,o.lineJoin="round",t.as(e.crs,vB),vB.applyMatrix4(e.matrixWorldInverse),e.isInverted?(yB.set(t.west,t.north,0),fB.set(o.canvas.width,-o.canvas.height,1).divide(pB)):(yB.set(t.west,t.south,0),fB.set(o.canvas.width,o.canvas.height,1).divide(pB)),gB.compose(yB.multiply(fB).negate(),mB,fB),AB.multiplyMatrices(gB,e.matrixWorld),AB.decompose(dB,mB,fB),o.setTransform(fB.x,0,0,fB.y,dB.x,dB.y);const l=Math.abs(1/fB.x);aB.setZoom(t.zoom);for(const t of e.features)aB.setFeature(t),uB(o,t,vB,l);s=new gl(a),s.flipY=e.isInverted}else if(r){const e=new Uint8Array(3);e[0]=255*r.r,e[1]=255*r.g,e[2]=255*r.b,s=new Po(e,1,1,ae)}else s=new Jt;return s}},xB=new up("EPSG:4326"),EB=(e,t)=>(e.generateMipmaps=!1,e.magFilter=t.magFilter||W,e.minFilter=t.minFilter||W,e),bB={convert(e,t,n){let i;if(e.isFeatureCollection){const r=n.source.backgroundLayer,s=r&&r.paint?new Ci(r.paint["background-color"]):void 0;t.toExtent(n.crs,xB),i=_B.createTextureFromFeature(e,xB,n.subdivisionThreshold,n.style,s),i.features=e,i.extent=t}else{if(!e.isTexture)throw new Error("Data type is not supported to convert into texture");i=e}return n.isColorLayer?function(e,t){return e.anisotropy=16,e.premultiplyAlpha=t.transparent,EB(e,t)}(i,n):n.isElevationLayer?(i.flipY&&(i.flipY=!1),EB(i,n)):void 0}},wB=class extends $_{constructor(e,t){const{cacheLifeTime:n=hx.TEXTURE,minFilter:i,magFilter:r,...s}=t;super(e,{...s,cacheLifeTime:n}),this.minFilter=i,this.magFilter=r}convert(e,t){return bB.convert(e,t,this)}delete(e){e&&this.cache.clear();for(const e of this.parent.level0Nodes)e.traverse(iB(this.id))}},MB=class extends wB{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};var n;(n=t).fx&&(console.warn("ColorLayer fx is deprecated, use ColorLayer.effect_type and ColorLayer.effect_parameter instead."),n.fx>2?(n.effect_parameter=n.fx,n.effect_type=1):n.fx>0&&(n.effect_parameter=n.fx,n.effect_type=2));const{effect_type:i=0,effect_parameter:r=1,transparent:s,...a}=t;super(e,a),this.isColorLayer=!0,this.visible=!0,this.defineLayerProperty("visible",this.visible),this.opacity=1,this.defineLayerProperty("opacity",this.opacity),this.sequence=0,this.defineLayerProperty("sequence",this.sequence),this.transparent=s||this.opacity<1,this.noTextureParentOutsideLimit=!!t.source&&t.source.isFileSource,this.effect_type=i,this.effect_parameter=r,this.buildExtent=!0,this.structure="2d"}setupRasterNode(e){const t=new ff(e.material,this);return e.material.addLayer(t),e.material.setSequence(this.parent.colorLayersOrder),t}update(e,t,n,i){return function(e,t,n,i){const r=n.material;if(!i||!r)return;const s=n.getExtentsByProjection(t.crs),a=s[0].zoom;if(a>t.zoom.max||a<t.zoom.min)return;let o=r.getLayer(t.id);if(void 0===n.layerUpdateState[t.id]){if(n.layerUpdateState[t.id]=new mx,!t.source.extentInsideLimit(n.extent,a)&&(t.noTextureParentOutsideLimit||!i.material||!i.material.getLayer||!i.material.getLayer(t.id)))return void n.layerUpdateState[t.id].noMoreUpdatePossible();if(!o){o=t.setupRasterNode(n);const e=i.material?.getLayer(t.id);o.initFromParent(e,s)}if(o.level>=t.source.zoom.min)return void e.view.notifyChange(n,!1)}if(!r.visible)return;if(!t.visible||!n.layerUpdateState[t.id].canTryUpdate())return;if(o.level>=s[0].zoom)return void n.layerUpdateState[t.id].noMoreUpdatePossible();if(t.frozen)return;const l=n.layerUpdateState[t.id].failureParams,c=s[0].zoom||n.level,h=yf(t.updateStrategy.type,n,c,o.level,t,l);if(!t.source.isVectorSource&&h<=o.level||h>c)return void(l.lowestLevelError!=1/0&&n.layerUpdateState[t.id].noMoreUpdatePossible());if(!t.source.extentInsideLimit(n.extent,h))return n.layerUpdateState[t.id].noData({targetLevel:h}),void e.view.notifyChange(n,!1);const u=s.map((e=>e.tiledExtentParent(h)));n.layerUpdateState[t.id].newTry();const d=tB(e.view,t,u,s,n);return e.scheduler.execute(d).then((e=>{if(!n.layerUpdateState[t.id])return;const i=e.map(((e,t)=>null!=e?e:{isTexture:!1,extent:s[t]})),r=nB(i,s);o.setTextures(i,r),n.layerUpdateState[t.id].success()}),(i=>ZR(i,n,t,h,e.view)))}(e,this,n,i)}},SB=class extends wB{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const{scale:n=1,noDataValue:i,clampValues:r,useRgbaTextureElevation:s,useColorTextureElevation:a,colorTextureElevationMinZ:o,colorTextureElevationMaxZ:l,bias:c,mode:h,...u}=t;super(e,u),this.isElevationLayer=!0,this.noDataValue=i,(t.zmin||t.zmax)&&console.warn("Config using zmin and zmax are deprecated, use {clampValues: {min, max}} structure."),this.zmin=r?.min??t.zmin,this.zmax=r?.max??t.zmax,this.defineLayerProperty("scale",n),this.useRgbaTextureElevation=s,this.useColorTextureElevation=a,this.colorTextureElevationMinZ=o,this.colorTextureElevationMaxZ=l,this.bias=c,this.mode=h}setupRasterNode(e){const t=new mf(e.material,this);e.material.addLayer(t),e.material.setSequenceElevation(this.id);const n=()=>e.setBBoxZ({min:t.min,max:t.max,scale:this.scale});return n(),t.addEventListener("rasterElevationLevelChanged",n),this.addEventListener("scale-property-changed",n),e.addEventListener("dispose",(()=>{this.removeEventListener("scale-property-changed",n)})),t}update(e,t,n,i){return function(e,t,n,i){const r=n.material;if(!i||!r)return;const s=n.getExtentsByProjection(t.crs),a=s[0].zoom;if(a>t.zoom.max||a<t.zoom.min)return;let o=r.getElevationLayer();if(o||(o=t.setupRasterNode(n)),void 0===n.layerUpdateState[t.id]){n.layerUpdateState[t.id]=new mx;const r=i.material?.getLayer(t.id);if(o.initFromParent(r,s),o.level>=t.source.zoom.min)return void e.view.notifyChange(n,!1)}if(t.frozen||!r.visible||!n.layerUpdateState[t.id].canTryUpdate())return;const l=n.layerUpdateState[t.id].failureParams,c=yf(t.updateStrategy.type,n,s[0].zoom,o.level,t,l);if(c<=o.level||c>s[0].zoom)return void n.layerUpdateState[t.id].noMoreUpdatePossible();if(!t.source.extentInsideLimit(n.extent,c))return n.layerUpdateState[t.id].noData({targetLevel:c}),void e.view.notifyChange(n,!1);const h=s.map((e=>e.tiledExtentParent(c)));n.layerUpdateState[t.id].newTry();const u=tB(e.view,t,h,s,n);return e.scheduler.execute(u).then((e=>{if(!n.layerUpdateState[t.id])return;if(c<=o.level)return void n.layerUpdateState[t.id].noMoreUpdatePossible();const i=nB(e,s);o.setTextures(e,i),n.layerUpdateState[t.id].success()}),(i=>ZR(i,n,t,c,e.view)))}(e,this,n,i)}};new sn;const CB=new ir,TB=new ln;CB.geometry.boundingBox=TB,new sn;const IB=new ir,RB=new ln;IB.geometry.boundingBox=RB,new sn;const BB={DATA_TYPE_DOUBLE:{name:"double",size:8},DATA_TYPE_FLOAT:{name:"float",size:4},DATA_TYPE_INT8:{name:"int8",size:1},DATA_TYPE_UINT8:{name:"uint8",size:1},DATA_TYPE_INT16:{name:"int16",size:2},DATA_TYPE_UINT16:{name:"uint16",size:2},DATA_TYPE_INT32:{name:"int32",size:4},DATA_TYPE_UINT32:{name:"uint32",size:4},DATA_TYPE_INT64:{name:"int64",size:8},DATA_TYPE_UINT64:{name:"uint64",size:8}};Object.keys(BB).forEach(((e,t)=>{BB[t]=BB[e]}));class LB{constructor(e,t,n){this.name=e,this.type=t,this.numElements=n,this.byteSize=this.numElements*this.type.size,this.description="",this.range=[1/0,-1/0]}}LB.POSITION_CARTESIAN=new LB("POSITION_CARTESIAN",BB.DATA_TYPE_FLOAT,3),LB.RGBA_PACKED=new LB("COLOR_PACKED",BB.DATA_TYPE_INT8,4),LB.COLOR_PACKED=LB.RGBA_PACKED,LB.RGB_PACKED=new LB("COLOR_PACKED",BB.DATA_TYPE_INT8,3),LB.NORMAL_FLOATS=new LB("NORMAL_FLOATS",BB.DATA_TYPE_FLOAT,3),LB.INTENSITY=new LB("INTENSITY",BB.DATA_TYPE_UINT16,1),LB.CLASSIFICATION=new LB("CLASSIFICATION",BB.DATA_TYPE_UINT8,1),LB.NORMAL_SPHEREMAPPED=new LB("NORMAL_SPHEREMAPPED",BB.DATA_TYPE_UINT8,2),LB.NORMAL_OCT16=new LB("NORMAL_OCT16",BB.DATA_TYPE_UINT8,2),LB.NORMAL=new LB("NORMAL",BB.DATA_TYPE_FLOAT,3),LB.RETURN_NUMBER=new LB("RETURN_NUMBER",BB.DATA_TYPE_UINT8,1),LB.NUMBER_OF_RETURNS=new LB("NUMBER_OF_RETURNS",BB.DATA_TYPE_UINT8,1),LB.SOURCE_ID=new LB("SOURCE_ID",BB.DATA_TYPE_UINT16,1),LB.INDICES=new LB("INDICES",BB.DATA_TYPE_UINT32,1),LB.SPACING=new LB("SPACING",BB.DATA_TYPE_FLOAT,1),LB.GPS_TIME=new LB("GPS_TIME",BB.DATA_TYPE_DOUBLE,1);const PB=new ir,DB=new ln;PB.geometry.boundingBox=DB,BB.DATA_TYPE_DOUBLE,BB.DATA_TYPE_FLOAT,BB.DATA_TYPE_INT8,BB.DATA_TYPE_UINT8,BB.DATA_TYPE_INT16,BB.DATA_TYPE_UINT16,BB.DATA_TYPE_INT32,BB.DATA_TYPE_UINT32,BB.DATA_TYPE_INT64,BB.DATA_TYPE_UINT64;new Nn;new ln,new Sn;new Ud,new sn,new sn,new Jd("EPSG:4326"),new sn,new Jd("EPSG:4326"),new sn,new sn,new sn,new Nn;new Nn(1,0,0,1,0,1,0,1,0,0,2,0,0,0,0,2);new Po(new Uint8Array([255,255,255,255]),1,1,ae,K).needsUpdate=!0,new Jt,new hr,new Kl,new Rt,new Jd("EPSG:4978",0,0,0),new sn,new sn,new sn;const NB=new ir,UB=new ln;NB.geometry.boundingBox=UB,n(5234),new sn,new sn,new sn;const OB=new Sx("EPSG:4326",0,0,0),FB=class extends U_{constructor(e){if(e.format=e.format||"image/png",super(e),!e.crs)throw new Error("New TMSSource/WMTSSource: crs is required");if(this.isTMSSource=!0,e.extent||(this.extent=r_.get(e.crs)),this.zoom=e.zoom,this.isInverted=e.isInverted||!1,this.crs=e.crs,this.tileMatrixSetLimits=e.tileMatrixSetLimits,this.extentSetlimits={},this.tileMatrixCallback=e.tileMatrixCallback||(e=>e),!this.zoom)if(this.tileMatrixSetLimits){const e=Object.keys(this.tileMatrixSetLimits),t=e.length,n=Number(e[t-1]);this.zoom={min:n-t+1,max:n}}else this.zoom={min:0,max:1/0}}urlFromExtent(e){return kT.xyz(e,this)}onLayerAdded(e){super.onLayerAdded(e);const t=e.out.parent,n=t?t.extent.crs:e.out.crs;if(this.tileMatrixSetLimits&&!this.extentSetlimits[n]){this.extentSetlimits[n]={},OB.crs=this.crs;for(let e=this.zoom.max;e>=this.zoom.min;e--){const t=this.tileMatrixSetLimits[e],{west:i,north:r}=OB.set(e,t.minTileRow,t.minTileCol).toExtent(n),{east:s,south:a}=OB.set(e,t.maxTileRow,t.maxTileCol).toExtent(n);this.extentSetlimits[n][e]=new up(n,i,s,a,r)}}}extentInsideLimit(e,t){return t>=this.zoom.min&&t<=this.zoom.max&&(null==this.extentSetlimits[e.crs]||this.extentSetlimits[e.crs][t].intersectsExtent(e))}};new up("EPSG:4326"),new up("EPSG:4326");const kB=class extends FB{constructor(e){if(!e.name)throw new Error("New WMTSSource: name is required");super(e),this.isWMTSSource=!0;const t=new URL(this.url);t.searchParams.set("LAYER",e.name),t.searchParams.set("FORMAT",this.format),t.searchParams.set("SERVICE","WMTS"),t.searchParams.set("VERSION",e.version||"1.0.0"),t.searchParams.set("REQUEST","GetTile"),t.searchParams.set("STYLE",e.style||"normal"),t.searchParams.set("TILEMATRIXSET",e.tileMatrixSet),t.searchParams.set("TILEMATRIX","%TILEMATRIX"),t.searchParams.set("TILEROW","%ROW"),t.searchParams.set("TILECOL","%COL"),this.vendorSpecific=e.vendorSpecific;for(const e in this.vendorSpecific)Object.prototype.hasOwnProperty.call(this.vendorSpecific,e)&&t.searchParams.set(e,this.vendorSpecific[e]);this.url=decodeURIComponent(t.toString())}},QB={POSITION_CARTESIAN:{numElements:3,arrayType:Float32Array,attributeName:"position"},COLOR_PACKED:{numElements:4,arrayType:Uint8Array,attributeName:"color",normalized:!0},INTENSITY:{numElements:1,numByte:2,arrayType:Uint16Array,attributeName:"intensity",normalized:!0},CLASSIFICATION:{numElements:1,arrayType:Uint8Array,attributeName:"classification",normalized:!0},NORMAL_SPHEREMAPPED:{numElements:2,arrayType:Uint8Array,attributeName:"sphereMappedNormal"},NORMAL_OCT16:{numElements:2,arrayType:Uint8Array,attributeName:"oct16Normal"},NORMAL:{numElements:3,arrayType:Float32Array,attributeName:"normal"}};for(const e of Object.keys(QB)){const t=QB[e];t.potreeName=e,t.numByte=t.numByte||t.arrayType.BYTES_PER_ELEMENT,t.byteSize=t.numElements*t.numByte,t.normalized=t.normalized||!1;const n="getUint"+8*t.numByte;t.getValue=1===t.numByte?function(e,t){return e[n](t)}:function(e,t){return e[n](t,!0)}}var zB=n(447);zB.registerSerializer,zB.spawn,zB.BlobWorker,zB.DefaultSerializer,zB.Pool,zB.Thread,zB.Transfer,zB.Worker;const GB=class extends U_{constructor(e){super(e),this.isOGC3DTilesSource=!0}};var HB=self.DecompressionStream;try{new HB("deflate-raw")}catch{}function VB(e){let t=0,n=1;const i=e.length;let r,s;const a=[e[0][0],e[0][1],e[0][0],e[0][1]];for(;n<i;)r=s||e[0],s=e[n],t+=(s[0]-r[0])*(s[1]+r[1]),n++,s[0]<a[0]&&(a[0]=s[0]),s[1]<a[1]&&(a[1]=s[1]),s[0]>a[2]&&(a[2]=s[0]),s[1]>a[3]&&(a[3]=s[1]);return{ring:e,clockWise:t>0,bbox:a,children:[]}}function jB(e,t){return!(e.bbox[0]>t.bbox[0]||e.bbox[1]>t.bbox[1]||e.bbox[2]<t.bbox[2]||e.bbox[3]<t.bbox[3])}new TextDecoder,globalThis.URL,WB.prototype.parsePoint=function(e){return{type:"Point",coordinates:this.parseCoord(e,0)}},WB.prototype.parseZPoint=function(e){const t=this.parsePoint(e);return t.coordinates.push(e.getFloat64(16,!0)),t},WB.prototype.parsePointArray=function(e,t,n){const i=[];let r=0;for(;r<n;)i.push(this.parseCoord(e,t)),t+=16,r++;return i},WB.prototype.parseZPointArray=function(e,t,n,i){let r=0;for(;r<n;)i[r].push(e.getFloat64(t,!0)),r++,t+=8;return i},WB.prototype.parseArrayGroup=function(e,t,n,i,r){const s=[];let a,o,l=0,c=0;for(;l<i;)l++,n+=4,a=c,c=l===i?r:e.getInt32(n,!0),o=c-a,o&&(s.push(this.parsePointArray(e,t,o)),t+=o<<4);return s},WB.prototype.parseZArrayGroup=function(e,t,n,i){let r=0;for(;r<n;)i[r]=this.parseZPointArray(e,t,i[r].length,i[r]),t+=i[r].length<<3,r++;return i},WB.prototype.parseMultiPoint=function(e){const t={},n=e.getInt32(32,!0);if(!n)return null;const i=this.parseCoord(e,0),r=this.parseCoord(e,16);return t.bbox=[i[0],i[1],r[0],r[1]],1===n?(t.type="Point",t.coordinates=this.parseCoord(e,36)):(t.type="MultiPoint",t.coordinates=this.parsePointArray(e,36,n)),t},WB.prototype.parseZMultiPoint=function(e){const t=this.parseMultiPoint(e);if(!t)return null;let n;if("Point"===t.type)return t.coordinates.push(e.getFloat64(72,!0)),t;n=t.coordinates.length;const i=52+(n<<4);return t.coordinates=this.parseZPointArray(e,i,n,t.coordinates),t},WB.prototype.parsePolyline=function(e){const t={},n=e.getInt32(32,!0);if(!n)return null;const i=this.parseCoord(e,0),r=this.parseCoord(e,16);t.bbox=[i[0],i[1],r[0],r[1]];const s=e.getInt32(36,!0);let a,o;return 1===n?(t.type="LineString",a=44,t.coordinates=this.parsePointArray(e,a,s)):(t.type="MultiLineString",a=40+(n<<2),o=40,t.coordinates=this.parseArrayGroup(e,a,40,n,s)),t},WB.prototype.parseZPolyline=function(e){const t=this.parsePolyline(e);if(!t)return null;const n=t.coordinates.length;let i;if("LineString"===t.type)return i=60+(n<<4),t.coordinates=this.parseZPointArray(e,i,n,t.coordinates),t;{const r=t.coordinates.reduce((function(e,t){return e+t.length}),0);return i=56+(r<<4)+(n<<2),t.coordinates=this.parseZArrayGroup(e,i,n,t.coordinates),t}},WB.prototype.polyFuncs=function(e){return e?"LineString"===e.type?(e.type="Polygon",e.coordinates=[e.coordinates],e):(e.coordinates=function(e){const t=[],n=[];for(const i of e){const e=VB(i);e.clockWise?t.push(e):n.push(e)}for(const e of n)for(const n of t)if(jB(n,e)){n.children.push(e.ring);break}const i=[];for(const e of t)i.push([e.ring].concat(e.children));return i}(e.coordinates),1===e.coordinates.length?(e.type="Polygon",e.coordinates=e.coordinates[0],e):(e.type="MultiPolygon",e)):e},WB.prototype.parsePolygon=function(e){return this.polyFuncs(this.parsePolyline(e))},WB.prototype.parseZPolygon=function(e){return this.polyFuncs(this.parseZPolyline(e))};const qB={1:"parsePoint",3:"parsePolyline",5:"parsePolygon",8:"parseMultiPoint",11:"parseZPoint",13:"parseZPolyline",15:"parseZPolygon",18:"parseZMultiPoint"};function WB(e,t){if(!(this instanceof WB))return new WB(e,t);this.buffer=e,this.headers=this.parseHeader(),this.shpFuncs(t),this.rows=this.getRows()}function YB(e,t,n){const i=t.cached.transform,r=(new sn).fromArray(n).applyMatrix4(i),s=n[3]*i.getMaxScaleOnAxis(),a=e.camera3D.fov*Tt.DEG2RAD,o=s*Math.tan(2*a);return{coord:new Jd("EPSG:4978").setFromVector3(r),range:o+s}}WB.prototype.shpFuncs=function(e){let t=this.headers.shpCode;if(t>20&&(t-=20),!(t in qB))throw new Error(`I don't know shp type "${t}"`);var n;this.parseFunc=this[qB[t]],this.parseCoord=(n=e)?function(e,t){const i=[e.getFloat64(t,!0),e.getFloat64(t+8,!0)];return n.inverse(i)}:function(e,t){return[e.getFloat64(t,!0),e.getFloat64(t+8,!0)]}},WB.prototype.getShpCode=function(){return this.parseHeader().shpCode},WB.prototype.parseHeader=function(){const e=this.buffer;return{length:e.getInt32(24)<<1,version:e.getInt32(28,!0),shpCode:e.getInt32(32,!0),bbox:[e.getFloat64(36,!0),e.getFloat64(44,!0),e.getFloat64(52,!0),e.getFloat64(60,!0)]}},WB.prototype.getRows=function(){let e=100;const t=this.buffer.byteLength-8,n=[];let i;for(;e<=t&&(i=this.getRow(e),i);)e+=8,e+=i.len,i.type?n.push(this.parseFunc(i.data)):n.push(null);return n},WB.prototype.getRow=function(e){const t=this.buffer.getInt32(e),n=this.buffer.getInt32(e+4)<<1;return 0===n?{id:t,len:n,type:0}:e+n+8>this.buffer.byteLength?void 0:{id:t,len:n,data:new DataView(this.buffer.buffer,this.buffer.byteOffset+e+12,n-4),type:this.buffer.getInt32(e+8,!0)}},globalThis.URL,new TextDecoder;const XB={coord:new Jd("EPSG:4326",2.351323,48.856712),range:25e6},KB=new class extends fI{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};li.DEFAULT_UP.set(0,0,1),super("EPSG:4978",e,n),this.isGlobeView=!0,this.camera3D.near=Math.max(15,2352e-9*Dd.x),this.camera3D.far=10*Dd.x;const i=new hE("globe",n.object3d,n);this.mainLoop.gfxEngine.label2dRenderer.infoTileLayer=i.info,this.addLayer(i),this.tileLayer=i,t.isExtent||(t.coord=t.coord||new Jd("EPSG:4326",0,0),t.tilt=t.tilt||89.5,t.heading=t.heading||0,t.range=t.range||2*Dd.x),n.noControls?jI.transformCameraToLookAtTarget(this,this.camera3D,t):(this.controls=new FR(this,t,n.controls),this.controls.handleCollision=void 0===n.handleCollision||n.handleCollision),this.addLayer(new $R("atmosphere",n.atmosphere)),this.camera.resize(e.clientWidth,e.clientHeight)}addLayer(e){if(!e||!e.isLayer)return Promise.reject(new Error("Add Layer type object"));if(e.isColorLayer){if(!this.tileLayer.tileMatrixSets.includes(e.source.crs))return e._reject(`Only ${this.tileLayer.tileMatrixSets} tileMatrixSet are currently supported for color layers`)}else if(e.isElevationLayer&&e.source.crs!==this.tileLayer.tileMatrixSets[0])return e._reject(`Only ${this.tileLayer.tileMatrixSets[0]} tileMatrixSet is currently supported for elevation layers`);return super.addLayer(e,this.tileLayer)}getPixelsToDegrees(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1?arguments[1]:void 0;return this.getMetersToDegrees(this.getPixelsToMeters(e,t))}getPixelsToDegreesFromDistance(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return this.getMetersToDegrees(this.getPixelsToMetersFromDistance(e,t))}getMetersToDegrees(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;return Tt.radToDeg(2*Math.asin(e/(2*Dd.x)))}}(document.getElementById("view-container"),XB);function JB(e){const t=new GB({url:e}),n=new bT("3d-tiles",{source:t});KB.addLayer(n).then((e=>{!function(e,t){!function(e,t){const{region:n,box:i,sphere:r}=t.boundingVolume;let s;s=n?function(e,t){const n=new up("EPSG:4326",t[0]*Tt.RAD2DEG,t[2]*Tt.RAD2DEG,t[1]*Tt.RAD2DEG,t[3]*Tt.RAD2DEG);return jI.getCameraTransformOptionsFromExtent(e,e.camera3D,n)}(e,n):i?function(e,t,n){const i=Math.max((new sn).fromArray(n,3).length(),(new sn).fromArray(n,6).length(),(new sn).fromArray(n,9).length());return YB(e,t,[n[0],n[1],n[2],i])}(e,t,i):YB(e,t,r),e.controls.lookAtCoordinate({coord:s.coord,range:s.range,tilt:60})}(e,t.tilesRenderer.root)}(KB,e)}))}x_.json("../resources/layers/OPENSM.json").then((function(e){e.source=new FB(e.source);const t=new MB("Map",e);KB.addLayer(t)})),x_.json("../resources/layers/WORLD_DTM.json").then((e=>{e.source=new kB(e.source);const t=new SB(e.id,e);KB.addLayer(t)})),function(e){const t=new TC;t.setDecoderPath(e),xT.setDRACOLoader(t)}("../resources/libs/draco/"),function(e,t){if(!t)throw new Error("Path to ktx2 folder and renderer are mandatory");const n=new sT;n.setTranscoderPath(e),n.detectSupport(t),xT.setKTX2Loader(n)}("../resources/lib/basis/",KB.renderer);const $B=document.getElementById("source-widget");$B.addEventListener("submit",(e=>{e.preventDefault();const t=new FormData($B).get("source-url");JB(t),document.getElementById("source-information").classList.remove("hidden");const n=document.createElement("li");n.innerHTML=`${t}`,document.getElementById("source-list").appendChild(n)}))})()})();
//# sourceMappingURL=3d-tiles-context.js.map